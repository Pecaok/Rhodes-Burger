<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Men√∫</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --primary-700:#27ae60; --danger:#e74c3c;
      --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    /* Marca de agua */
    body::before{content:"";position:fixed;inset:0;background:url("images/logo.png") center 120px/320px no-repeat;opacity:.06;pointer-events:none;z-index:0;filter:grayscale(100%)}
    /* Topbar */
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1000px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{width:40px;height:40px;border-radius:10px;object-fit:contain;background:#fff}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:10px;border:2px solid var(--primary);padding:10px 16px;border-radius:999px;color:var(--primary);background:#fff;font-weight:700;text-decoration:none;transition:.15s transform,.15s box-shadow}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(46,204,113,.25)}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e5e5e5;color:#333}
    .btn.danger{border-color:var(--danger); color:var(--danger)}
    .cart-badge{min-width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;background:#fff;color:var(--primary);border-radius:999px;padding:0 8px;font-weight:800}
    /* Layout */
    main{position:relative;z-index:1}
    .container{max-width:1000px;margin:24px auto;padding:0 12px}
    h1{font-size:42px;margin:14px 4px 24px}
    h2{font-size:32px;margin:28px 4px 16px}
    h3{font-size:20px;margin:10px 0 6px}
    p{margin:6px 0;color:var(--muted)}
    /* Grid y cards */
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(230px,1fr))}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .card img{width:100%;height:160px;object-fit:cover;background:#f0f0f0}
    .card .content{padding:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .price{font-weight:800}
    .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    /* Caja papas */
    .box{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin:8px 0 16px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #e7e7e7;border-radius:999px;padding:8px 12px;margin-right:8px}
    .help{color:var(--muted);font-size:15px}
    /* Drawer Carrito */
    .drawer{position:fixed;top:0;right:-460px;width:460px;max-width:92vw;height:100vh;background:#fff;box-shadow:-8px 0 30px rgba(0,0,0,.18);transition:right .25s ease;z-index:30;display:flex;flex-direction:column}
    .drawer.open{right:0}
    .drawer header{padding:14px 16px;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .drawer .body{padding:14px 16px;overflow:auto;flex:1}
    .divider{height:1px;background:#eee;margin:12px 0}
    .item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0}
    .total{display:flex;align-items:center;justify-content:space-between;font-size:18px;font-weight:800}
    .muted{color:var(--muted);font-size:14px}
    .close{position:absolute;top:10px;right:10px;width:38px;height:38px;border-radius:999px;border:1px solid #eee;background:#fff;font-weight:900}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field input{padding:10px 12px;border-radius:12px;border:1px solid #e7e7e7}
    .inline{display:flex;gap:12px;flex-wrap:wrap}
    .hid{display:none}
    /* Modal Personalizar */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:40}
    .overlay.open{display:flex}
    .modal{background:#fff;border-radius:20px;box-shadow:var(--shadow);width:520px;max-width:92vw;padding:18px}
    .modal h3{margin-top:0}
    .modal .row{margin-top:12px}
    .qtybox{display:inline-flex;align-items:center;gap:10px;border:1px solid #e7e7e7;border-radius:999px;padding:6px 10px}
    .qtybox button{width:28px;height:28px;border:1px solid #e5e5e5;background:#fff;border-radius:999px;font-weight:900}
    textarea{width:100%;min-height:70px;padding:10px;border:1px solid #e7e7e7;border-radius:12px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="#" class="brand"><img src="images/logo.png" alt="Rhodes Burgers"></a>
      <div class="spacer"></div>
      <a class="btn" id="btnContacto">üìû Contacto</a>
      <a class="btn primary" id="btnCarrito">üõí Carrito <span class="cart-badge" id="cartCount">0</span></a>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Men√∫</h1>

      <h2>Hamburguesas</h2>
      <div id="burgersGrid" class="grid"></div>

      <h2>Papas fritas <span class="muted">(obligatorio)</span></h2>
      <div class="box">
        <label class="pill"><input type="radio" name="papas" value="con_sazon"> Con saz√≥n <span class="muted">(sin costo)</span></label>
        <label class="pill"><input type="radio" name="papas" value="sin_sazon"> Sin sazonar <span class="muted">(sin costo)</span></label>
        <p class="help">Eleg√≠ una opci√≥n. La agregamos a tu pedido sin costo.</p>
      </div>

      <h2>Bebidas</h2>
      <div id="drinksGrid" class="grid"></div>
    </div>
  </main>

  <!-- Drawer Carrito -->
  <aside class="drawer" id="drawer">
    <header>
      <strong>Tu pedido</strong>
      <button class="close" id="closeDrawer">‚úï</button>
    </header>
    <div class="body">
      <div id="cartItems"></div>

      <div class="divider"></div>
      <div class="item"><span>Papas (obligatorio)</span><span id="papasSummary" class="muted">Sin elegir</span></div>

      <div class="divider"></div>
      <div class="field">
        <label>Nombre y apellido</label>
        <input id="inpNombre" placeholder="Ej: Juan P√©rez" autocomplete="name" />
      </div>
      <div class="inline">
        <label class="pill"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
        <label class="pill"><input type="radio" name="pago" value="efectivo"> Efectivo</label>
      </div>
      <div class="inline" style="margin-top:8px">
        <label class="pill"><input type="radio" name="entrega" value="delivery"> Delivery</label>
        <label class="pill"><input type="radio" name="entrega" value="take_away"> Take Away</label>
      </div>
      <div class="field hid" id="dirWrap">
        <label>Direcci√≥n (solo si es Delivery)</label>
        <input id="inpDireccion" placeholder="Calle, n√∫mero, piso" autocomplete="address-line1" />
      </div>

      <div class="divider"></div>
      <div class="total"><span>Total</span><span id="cartTotal">$0</span></div>

      <div style="margin-top:16px; display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn danger" id="btnVaciar">Vaciar</button>
        <button class="btn primary" id="btnFinalizar">Finalizar pedido</button>
      </div>

      <p class="muted" style="margin-top:10px">Los datos (nombre, pago y entrega) se piden ac√° en ‚ÄúVer pedido‚Äù.</p>
    </div>
  </aside>

  <!-- Modal Personalizar -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="modTitle">Personalizar</h3>
      <div class="row">
        <span>Cantidad</span>
        <div class="qtybox" style="margin-left:10px">
          <button id="modDec">-</button>
          <span id="modQty">1</span>
          <button id="modInc">+</button>
        </div>
      </div>
      <div class="row">
        <label style="width:100%;margin-top:10px">Notas (opcional)
          <textarea id="modNotes" placeholder="Sin cebolla, extra cheddar, etc."></textarea>
        </label>
      </div>
      <div class="row" style="justify-content:flex-end; gap:10px; margin-top:14px">
        <button class="btn ghost" id="modCancel">Cancelar</button>
        <button class="btn primary" id="modAdd">Agregar al carrito</button>
      </div>
    </div>
  </div>

  <!-- Firebase (SIEMPRE requerido) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /*************** 0) CONFIGURACI√ìN FIREBASE (OBLIGATORIA) ***************/
    // ‚ö†Ô∏è Reemplaz√° estas credenciales por las reales:
    const firebaseConfig = {
      // EJEMPLO:
      // apiKey: "TU_API_KEY",
      // authDomain: "TU_DOMINIO.firebaseapp.com",
      // projectId: "TU_PROJECT_ID",
      // storageBucket: "TU_PROJECT_ID.appspot.com",
      // messagingSenderId: "XXX",
      // appId: "1:XXX:web:XXX"
    };

    // Validaci√≥n: si no hay config, no seguimos
    if (!firebaseConfig || !Object.keys(firebaseConfig).length) {
      alert("Error: Firebase no est√° configurado. Agreg√° tu firebaseConfig en index.html");
      throw new Error("Falta firebaseConfig");
    }
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /*************** 1) DATOS DEL MEN√ö ***************/
    const BURGERS = [
      { id:"bigjohn_simple",  name:"Big John Simple",     price:7800, img:"images/Big John Simple.jpg",   desc:"Simple medall√≥n, cheddar, pepinos" },
      { id:"bigjohn_doble",   name:"Big John Doble",      price:9500, img:"images/Big John Doble.jpg",    desc:"Doble medall√≥n, cheddar, pepinos" },
      { id:"burguesa_simple", name:"Burguesa Simple",     price:6900, img:"images/Burguesa Simple.jpg",   desc:"Carne, cheddar" },
      { id:"burguesa_doble",  name:"Burguesa Doble",      price:8700, img:"images/Burguesa Doble.jpg",    desc:"Doble carne, cheddar" },
      { id:"cheesebacon_spl", name:"CheeseBacon Simple",  price:7900, img:"images/CheeseBacon Simple.jpg",desc:"Carne, cheddar y bacon" },
      { id:"cheesebacon_dbl", name:"CheeseBacon Doble",   price:9300, img:"images/CheeseBacon Doble.jpg", desc:"Doble carne, cheddar y bacon" },
      { id:"cheese_simple",   name:"Cheeseburger Simple", price:7200, img:"images/cheeseburger simple.jpg",desc:"Carne con cheddar" },
      { id:"cheese_doble",    name:"Cheeseburger Doble",  price:8900, img:"images/cheeseburger doble.jpg",desc:"Doble carne con doble cheddar" },
      { id:"rhodes_simple",   name:"Rhodes Simple",       price:7600, img:"images/Rhodes Simple.jpg",     desc:"Carne, cheddar, cebolla" },
      { id:"rhodes_doble",    name:"Rhodes Doble",        price:9200, img:"images/Rhodes Doble.jpg",      desc:"Doble carne, cheddar, cebolla" },
      { id:"morgan_simple",   name:"Morgan Simple",       price:0,    img:"images/Morgan Simple.jpg",     desc:"TODO desc" },  /* completar precio/desc */
      { id:"morgan_doble",    name:"Morgan Doble",        price:0,    img:"images/Morgan Doble.jpg",      desc:"TODO desc" },
      { id:"pollo_crispy",    name:"Pollo Crispy",        price:0,    img:"images/Pollo crispy.jpg",      desc:"TODO desc" }
    ];
    const DRINKS = [
      { id:"coca_org",  name:"Coca-Cola Original 500ml", price:0, img:"images/coca cola original.jpg" },
      { id:"coca_zero", name:"Coca-Cola Zero 500ml",     price:0, img:"images/coca cola zero.jpg" },
      { id:"sprite",    name:"Sprite 500ml",             price:0, img:"images/sprite.jpg" },
      { id:"aqu_pear",  name:"Aquarius Limonada 500ml",  price:0, img:"images/aquarius pera.jpg" },
      { id:"aqu_pome",  name:"Aquarius Pomelo 500ml",    price:0, img:"images/aquarius pomelo.jpg" }
    ];
    const FALLBACK_IMG = "images/logo.png";

    /*************** 2) UTILIDADES ***************/
    const $ = s => document.querySelector(s);
    const money = n => n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)); }
    function getSessionId(){
      let id = localStorage.getItem("rhodes_session_id");
      if(!id){ id = uuid(); localStorage.setItem("rhodes_session_id", id); }
      return id;
    }
    const sessionId = getSessionId();

    /*************** 3) ESTADO / REFERENCIAS UI ***************/
    const gridBurgers = $("#burgersGrid");
    const gridDrinks  = $("#drinksGrid");
    const cartCountEl = $("#cartCount");
    const drawer      = $("#drawer");
    const cartItemsEl = $("#cartItems");
    const cartTotalEl = $("#cartTotal");
    const papasSummaryEl = $("#papasSummary");
    const dirWrap = $("#dirWrap"), inpDireccion=$("#inpDireccion");
    const inpNombre = $("#inpNombre");

    // Modal
    const overlay = $("#overlay");
    const modTitle = $("#modTitle");
    const modQty = $("#modQty");
    const modInc = $("#modInc");
    const modDec = $("#modDec");
    const modNotes = $("#modNotes");
    const modAdd = $("#modAdd");
    const modCancel = $("#modCancel");
    let currentCustomize = null; // {type,id,price,name}

    // Carrito en memoria (refleja Firestore)
    let cart = { burger:{}, drink:{}, fries:null }; // {type: {id: {qty, item, notes?}} }

    /*************** 4) FIRESTORE: CART (persistente) ***************/
    const cartRef = db.collection("carts").doc(sessionId);

    async function loadCartFromFirestore(){
      const snap = await cartRef.get();
      if(snap.exists){
        cart = snap.data();
      }else{
        cart = { burger:{}, drink:{}, fries:null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
        await cartRef.set(cart);
      }
      sync();
    }

    // Suscripci√≥n en tiempo real (si abr√≠s 2 pesta√±as, se sincronizan)
    cartRef.onSnapshot((snap)=>{
      if(snap.exists){
        const data = snap.data();
        // Evitamos pisar cambios locales simult√°neos: asumimos doc es fuente de verdad.
        cart = { burger: data.burger || {}, drink: data.drink || {}, fries: data.fries || null };
        sync(true); // true => viene de Firestore
      }
    });

    async function saveCartToFirestore(){
      await cartRef.set({...cart, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
    }

    /*************** 5) RENDER MEN√ö ***************/
    function renderCard(item,type){
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <img src="${encodeURI(item.img)}" alt="${item.name}" onerror="this.onerror=null;this.src='${FALLBACK_IMG}'">
        <div class="content">
          <h3>${item.name}</h3>
          ${item.desc?`<p>${item.desc}</p>`:""}
          <div class="row">
            <span class="price">${money(item.price)}</span>
            <div class="actions">
              <button class="btn ghost" data-personalizar>Personalizar</button>
            </div>
          </div>
        </div>`;
      card.querySelector("[data-personalizar]").onclick = ()=> openCustomize(type,item);
      return card;
    }

    function mount(){
      gridBurgers.innerHTML=""; BURGERS.forEach(b=>gridBurgers.appendChild(renderCard(b,"burger")));
      gridDrinks.innerHTML="";  DRINKS.forEach(d=>gridDrinks.appendChild(renderCard(d,"drink")));
      sync();
    }

    /*************** 6) PERSONALIZAR ***************/
    function openCustomize(type,item){
      currentCustomize = { type, id: item.id, name: item.name, price: item.price };
      modTitle.textContent = `Personalizar: ${item.name}`;
      modQty.textContent = "1";
      modNotes.value = "";
      overlay.classList.add("open");
    }
    function closeCustomize(){ overlay.classList.remove("open"); }

    modInc.onclick = ()=> modQty.textContent = String(Math.min(99, (+modQty.textContent||1)+1));
    modDec.onclick = ()=> modQty.textContent = String(Math.max(1, (+modQty.textContent||1)-1));
    modCancel.onclick = closeCustomize;

    modAdd.onclick = async ()=>{
      const qty = +modQty.textContent || 1;
      const notes = modNotes.value.trim();
      const t = currentCustomize.type, id = currentCustomize.id;
      const item = (t==="burger" ? BURGERS : DRINKS).find(x=>x.id===id);
      if(!item){ alert("No se encontr√≥ el producto."); return; }

      // Actualizamos carrito en memoria
      const bucket = cart[t] || (cart[t] = {});
      const prev = bucket[id]?.qty || 0;
      bucket[id] = { qty: prev + qty, item, ...(notes?{notes}:{} ) };

      await saveCartToFirestore();
      closeCustomize();
      sync();
      openDrawer();
    };

    /*************** 7) CARRITO ***************/
    function getQty(type,id){ return cart[type]?.[id]?.qty || 0; }
    function findItem(type,id){ const list = type==="burger"?BURGERS:DRINKS; return list.find(x=>x.id===id); }
    function cartCount(){
      let n=0; for(const b of Object.values(cart.burger)) n+=b.qty; for(const d of Object.values(cart.drink)) n+=d.qty; return n;
    }
    function calcTotal(){
      let t=0; for(const b of Object.values(cart.burger)) t+= (b.item?.price||0) * b.qty; for(const d of Object.values(cart.drink)) t+= (d.item?.price||0) * d.qty; return t;
    }

    async function addToCart(type,id,delta){
      const bucket = cart[type] || (cart[type]={});
      const current = bucket[id]?.qty || 0;
      const next = Math.max(0, current + delta);
      if(next===0) delete bucket[id];
      else{
        bucket[id] = { qty: next, ...(bucket[id]||{}), item: bucket[id]?.item || findItem(type,id) };
      }
      await saveCartToFirestore();
      sync();
    }

    function rowItem(type,obj){
      return `
        <div class="item">
          <div>
            <div><strong>${obj.item.name}</strong>${obj.notes?`<div class="muted">Notas: ${obj.notes}</div>`:""}</div>
            <div class="muted">${money(obj.item.price)} x ${obj.qty}</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn ghost" onclick="addToCart('${type}','${obj.item.id}',-1)">-</button>
            <span>${obj.qty}</span>
            <button class="btn ghost" onclick="addToCart('${type}','${obj.item.id}',1)">+</button>
          </div>
        </div>`;
    }

    function sync(fromFirestore=false){
      // badge
      cartCountEl.textContent = cartCount();

      // items en drawer
      const rows=[];
      for(const obj of Object.values(cart.burger)) rows.push(rowItem("burger",obj));
      for(const obj of Object.values(cart.drink))  rows.push(rowItem("drink",obj));
      cartItemsEl.innerHTML = rows.join("") || `<p class="muted">Tu carrito est√° vac√≠o.</p>`;

      // total
      cartTotalEl.textContent = money(calcTotal());

      // papas resumen
      const map={con_sazon:"Con saz√≥n",sin_sazon:"Sin sazonar"};
      papasSummaryEl.textContent = cart.fries ? map[cart.fries] : "Sin elegir";

      // toggle direcci√≥n
      const entregaVal = getRadio("entrega");
      dirWrap.classList.toggle("hid", entregaVal!=="delivery");

      // No re-renderizo grillas completas ac√° para no perder listeners
      // (las grillas est√°n est√°ticas; el qty se maneja desde el drawer)
    }

    /*************** 8) FORM + FINALIZAR ***************/
    function getRadio(name){
      const el=document.querySelector(`input[name="${name}"]:checked`);
      return el?el.value:null;
    }

    // Papas (obligatorio): actualiza Firestore
    document.querySelectorAll('input[name="papas"]').forEach(r=>{
      r.addEventListener("change", async ()=>{
        cart.fries = r.value;
        await saveCartToFirestore();
        sync();
      });
    });
    document.querySelectorAll('input[name="entrega"]').forEach(r=>r.addEventListener("change",()=>sync()));

    // Abrir/cerrar drawer
    const openDrawer = ()=>drawer.classList.add("open");
    const closeDrawer= ()=>drawer.classList.remove("open");
    $("#btnCarrito").onclick=openDrawer;
    $("#closeDrawer").onclick=closeDrawer;

    // Vaciar carrito (Firestore)
    $("#btnVaciar").onclick= async ()=>{
      if(!confirm("¬øVaciar el carrito?")) return;
      cart = { burger:{}, drink:{}, fries:null };
      await saveCartToFirestore();
      sync();
    };

    // Finalizar pedido -> orders
    $("#btnFinalizar").onclick= async ()=>{
      if(!cart.fries){ alert("Eleg√≠ una opci√≥n de papas (obligatorio)."); return; }
      if(cartCount()===0){ alert("Agreg√° al menos un producto."); return; }
      const nombre = inpNombre.value.trim();
      if(!nombre){ alert("Ingres√° tu nombre y apellido."); return; }
      const pago = getRadio("pago");
      if(!pago){ alert("Eleg√≠ un m√©todo de pago."); return; }
      const entrega = getRadio("entrega");
      if(!entrega){ alert("Eleg√≠ si es Delivery o Take Away."); return; }
      const direccion = entrega==="delivery" ? inpDireccion.value.trim() : "";
      if(entrega==="delivery" && !direccion){ alert("Ingres√° la direcci√≥n para Delivery."); return; }

      const items=[];
      for(const o of Object.values(cart.burger)) items.push({type:"burger", id:o.item.id, name:o.item.name, qty:o.qty, price:o.item.price, ...(o.notes?{notes:o.notes}:{})});
      for(const o of Object.values(cart.drink))  items.push({type:"drink",  id:o.item.id, name:o.item.name, qty:o.qty, price:o.item.price});

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        sessionId,
        nombre, pago, entrega, direccion,
        fries: cart.fries,
        items,
        total: calcTotal(),
        status: "pending"
      };

      try{
        await db.collection("orders").add(order);
        // limpiamos carrito
        cart = { burger:{}, drink:{}, fries:null };
        await cartRef.set({...cart, updatedAt: firebase.firestore.FieldValue.serverTimestamp()});
        sync();
        closeDrawer();
        alert("¬°Pedido enviado! ‚úÖ");
      }catch(err){
        console.error(err);
        alert("No pudimos guardar el pedido. Revis√° la conexi√≥n a Firestore.");
      }
    };

    /*************** 9) NAV ***************/
    // Contacto ‚Üí contacto.html
    $("#btnContacto").onclick = ()=> window.location.href = "contacto.html";

    /*************** 10) INICIO ***************/
    (async function init(){
      try{
        await loadCartFromFirestore();
        mount();
      }catch(e){
        console.error(e);
        alert("Error cargando Firestore. Verific√° tu configuraci√≥n y reglas.");
      }
    })();
  </script>
</body>
</html>
