<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <!-- ================= SESI√ìN COMPARTIDA (igual que pedido_local) ================= -->
  <script>
    const TTL_HOURS = 20;
    const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

    function sessionValid(){
      const ok = localStorage.getItem('rb_admin_ok') === 'true';
      const ts = Number(localStorage.getItem('rb_admin_t') || 0);
      return ok && (Date.now() - ts) < TTL_MS;
    }
    function bumpSession(){
      if(sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
    }
    function logout(){
      localStorage.removeItem('rb_admin_ok');
      localStorage.removeItem('rb_admin_t');
      localStorage.removeItem('rb_auth_v2');
      sessionStorage.removeItem('rb_auth_v2');
      location.replace('login.html');
    }

    (function requireSession(){
      if(!sessionValid()){
        const next = encodeURIComponent(
          (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
          (location.search || '') + (location.hash || '')
        );
        location.replace('login.html?next=' + next);
      } else bumpSession();
    })();

    ['click','keydown','focus','mousemove','touchstart','scroll']
      .forEach(evt => window.addEventListener(evt, bumpSession, {passive:true}));
  </script>

  <!-- ====================== ESTILOS COMPLETOS MOSTRADOR ======================== -->
  <style>
    :root{
      --primary:#645E52;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#eaeaea;
      --shadow:0 12px 34px rgba(0,0,0,.10);
      --radius:18px;

      --price-cheddar:300;
      --price-patty:2500;
    }

    *{ box-sizing:border-box; }

    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    /* ===== TOPBAR ===== */
    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }

    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
    }
    .brand img{
      width:36px;
      height:36px;
      border-radius:10px;
      background:#fff;
      object-fit:contain;
      margin-right:8px;
    }

    .spacer{ flex:1; }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ring);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      color:inherit;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }
    .btn.disabled,
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    /* ===== LAYOUT ===== */
    .container{
      max-width:1200px;
      margin:20px auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 380px;
      gap:18px;
    }
    @media (max-width:980px){
      .container{ grid-template-columns:1fr; }
    }

    h1{ font-size:26px; margin:8px 0 12px; }
    h2{ font-size:20px; margin:18px 4px 10px; }

    /* ===== MEN√ö (grillas) ===== */
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(220px,1fr));
      gap:16px;
    }
    @media (max-width:720px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .card .imgwrap{ position:relative; }
    .card img{
      width:100%;
      height:200px;
      object-fit:cover;
      background:#eee;
    }
    .content{ padding:12px; }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
    }
    .price{ font-weight:800; }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }

    /* ===== SIDEBAR (carrito) ===== */
    .side{
      background:var(--card);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:14px;
      position:sticky;
      top:82px;
      height:fit-content;
    }
    .side h3{ margin:0 0 8px; }
    .total{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:800;
      font-size:18px;
      margin:8px 0 10px;
    }
    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid #efefef;
    }
    .muted{ color:var(--muted); font-size:13px; }

    .qtybtn{
      border:1px solid var(--ring);
      background:#fff;
      border-radius:10px;
      padding:4px 8px;
      font-weight:800;
      cursor:pointer;
    }

    .field{ margin-top:8px; }
    .field input,
    .field select,
    .field textarea{
      width:100%;
      padding:10px;
      border:1px solid var(--ring);
      border-radius:12px;
    }

    textarea{
      min-height:84px;
      border-radius:12px;
      resize:vertical;
    }

    /* ===== MODALES ===== */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.32);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .overlay.open{ display:flex; }

    .modal{
      background:#fff;
      border-radius:20px;
      box-shadow:var(--shadow);
      width:520px;
      max-width:92vw;
      padding:16px;
    }

    .rowx{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:12px 0;
    }
    .qtybox{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ring);
      border-radius:999px;
      padding:6px 10px;
    }
    .qtybox button{
      width:28px;
      height:28px;
      border:1px solid var(--ring);
      background:#fff;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
    }

    .pills{ display:flex; flex-direction:column; gap:8px; }
    .pill{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--ring);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
    }
    .pill input{ accent-color:var(--primary); }
    .pill.disabled{ opacity:.55; pointer-events:none; }

    .micro{ font-size:12px; color:var(--muted); }

    /* ===== DISPONIBILIDAD ===== */
    .card[data-soldout="1"]{ opacity:.55; }
    .soldout-badge{
      position:absolute;
      top:10px;
      left:10px;
      z-index:2;
      background:#222;
      color:#fff;
      font-weight:800;
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      letter-spacing:.3px;
    }

    /* ===== NOTAS (mejoradas) ===== */
    .textarea{
      width:100%;
      min-height:56px;
      max-height:200px;
      padding:12px 14px;
      border:1px solid var(--ring);
      border-radius:14px;
      background:#faf9f7;
      resize:none;
      font-size:15px;
      line-height:1.35;
      transition:border-color .15s, box-shadow .15s, background .15s;
    }
    .textarea:focus{
      outline:0;
      background:#fff;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(98,90,69,.18);
    }

    .field-foot{
      display:flex;
      justify-content:flex-end;
      margin-top:6px;
      font-size:12px;
      color:#8a8a8a;
    }

    /* ===== PICKUP SELECTOR ===== */
    .pickup-row{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:10px;
    }
    .pickup-arrow,
    .pickup-mini{
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:#fff;
      border:1px solid var(--ring);
      font-weight:800;
    }
    .pickup-arrow{
      width:42px;
      height:42px;
      border-radius:10px;
    }
    .pickup-mini{
      width:36px;
      height:36px;
      border-radius:8px;
    }
    .pickup-arrow.disabled{ opacity:.5; cursor:not-allowed; }

    .pickup-time{
      min-width:120px;
      height:42px;
      border-radius:12px;
      border:1px solid var(--ring);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      background:#fff;
    }

    .pickup-desc{ font-size:12px; color:var(--muted); margin-top:6px; }

    .slots-list{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .slot-quick{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--ring);
      cursor:pointer;
    }
    .slot-quick.disabled{
      opacity:.5;
      pointer-events:none;
    }

    .badge-warn{
      display:inline-block;
      background:#ffe9a8;
      border:1px solid #e2c460;
      color:#7a5b00;
      border-radius:999px;
      padding:2px 8px;
      font-weight:800;
      font-size:11px;
      margin-left:6px;
    }
  </style>
</head>
<body>

  <!-- ===================== HEADER / TOPBAR ===================== -->
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Rhodes Burgers</a>
      <div class="spacer"></div>

      <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
      <a class="btn" href="finanzas.html">üìà Finanzas</a>
      <a class="btn" href="admin.html">‚öôÔ∏è Admin</a>

      <strong style="margin-left:8px">Mostrador</strong>
    </div>
  </header>

  <!-- ===================== CONTENIDO ===================== -->
  <main class="container">

    <!-- ===== MEN√ö ===== -->
    <section>
      <h1>Men√∫</h1>

      <h2>Hamburguesas</h2>
      <div id="burgersGrid" class="grid"></div>

      <h2 style="margin-top:20px">Bebidas</h2>
      <div id="drinksGrid" class="grid"></div>
    </section>

    <!-- ===== CARRITO / LADO DERECHO ===== -->
    <aside class="side">
      <h3>Carrito</h3>

      <div class="total">
        <span>Total</span>
        <span id="cartTotal">$0</span>
      </div>

      <div id="cartItems" class="muted" style="margin-bottom:8px">Sin √≠tems.</div>

      <!-- Nombre -->
      <div class="field">
        <input id="inpNombre" type="text" placeholder="Nombre (requerido)">
      </div>

      <!-- Tel√©fono -->
      <div class="field">
        <input id="inpTel" type="tel" placeholder="Tel√©fono (opcional)">
      </div>

      <!-- Pago -->
      <div class="field">
        <select id="selPago">
          <option value=""></option>
          <option value="efectivo">Efectivo</option>
          <option value="mercado_pago">Mercado Pago</option>
          <option value="debito">D√©bito</option>
          <option value="transferencia">Transferencia</option>
        </select>
      </div>

      <!-- HORARIO DE RETIRO -->
      <div style="margin-top:10px">
        <div style="font-weight:700">Horario de retiro (solo hoy)</div>

        <div class="pickup-row" id="pickupControls">
          <div id="btnPrev" class="pickup-arrow">‚óÄ</div>
          <div id="pickupTime" class="pickup-time">Cargando...</div>
          <div id="btnNext" class="pickup-arrow">‚ñ∂</div>
          <div id="btnQuick" class="pickup-mini">‚ñ¶</div>
          <div id="pickupCupos" class="pickup-cap muted" style="display:none">‚Äî cupos</div>
        </div>

        <div id="pickupDesc" class="pickup-desc">Cargando turnos...</div>
      </div>

      <!-- Comentario -->
      <div class="field">
        <textarea id="inpComentario" placeholder="Comentario"></textarea>
      </div>

      <!-- Bot√≥n FINAL -->
      <button id="btnPrintAndLoad" class="btn primary" style="width:100%;margin-top:10px">
        Imprimir y cargar
      </button>
    </aside>
  </main>

  <!-- ===================== MODAL: Lista r√°pida de horarios ===================== -->
  <div class="overlay" id="slotsOverlay">
    <div class="modal" style="width:520px;max-width:92vw">
      <h3>Elegir horario</h3>

      <div id="slotsQuickList" class="slots-list" style="margin-top:8px"></div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="closeSlots">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- ===================== MODAL: Personalizar hamburguesa ===================== -->
  <div class="overlay" id="overlay">
    <div class="modal">

      <h3 id="modTitle">Personalizar</h3>

      <!-- PAPAS -->
      <div class="rowx" style="align-items:flex-start;flex-direction:column">
        <div class="muted" style="font-weight:600">Papas (pod√©s elegir ahora o al final)</div>

        <div class="pills" id="friesOptions">
          <label class="pill"><span>Sazonadas</span> <input type="radio" name="fries" value="con_sazon"></label>
          <label class="pill"><span>Con sal</span>  <input type="radio" name="fries" value="con_sal"></label>
          <label class="pill"><span>Sin sal</span>  <input type="radio" name="fries" value="sin_sal"></label>
        </div>

        <div id="friesStateNote" class="micro"></div>
        <div class="micro">Si no eleg√≠s, te lo pedimos antes de cargar el pedido.</div>
      </div>

      <!-- Medallones extra -->
      <div class="rowx" id="rowPatties" style="display:none">
        <div>Medallones extra</div>
        <div class="qtybox">
          <button id="patDec">-</button>
          <span id="patVal">0</span>
          <button id="patInc">+</button>
        </div>
      </div>

      <!-- Cheddar extra -->
      <div class="rowx" id="rowCheddar" style="display:none">
        <div>Fetas de cheddar extra</div>
        <div class="qtybox">
          <button id="cheDec">-</button>
          <span id="cheVal">0</span>
          <button id="cheInc">+</button>
        </div>
      </div>

      <!-- Subtotal preview -->
      <div class="rowx" id="rowPreview" style="justify-content:flex-end">
        <span class="muted">Subtotal unitario:</span>
        <span class="preview" id="unitPreview">$0</span>
      </div>

      <!-- Notas -->
      <div class="rowx" style="align-items:flex-start;flex-direction:column">
        <label style="font-weight:600">Notas (opcional)</label>

        <textarea id="notes" class="textarea" maxlength="200"
          placeholder="Sin cebolla, extra salsa, etc."
          oninput="autoGrow(this); updateCount(this)">
        </textarea>

        <div class="field-foot"><span id="notesCount">0/200</span></div>
      </div>

      <!-- Botones modal -->
      <div class="rowx" style="justify-content:flex-end">
        <button class="btn ghost" id="btnCancel">Cancelar</button>
        <button class="btn primary" id="btnAdd">Guardar</button>
      </div>

    </div>
  </div>
  <!-- ===================== FIREBASE ===================== -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  /* ============================
       INICIALIZAR FIREBASE
  ============================ */
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };

  try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  } catch(e){ console.warn(e); }

  const db = firebase.firestore();

  /* ============================
         HELPERS
  ============================ */
  const $ = s => document.querySelector(s);
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  const FALLBACK_IMG = "images/logo.png";

  const EXTRA_PRICE_PATTY   = 2500;
  const EXTRA_PRICE_CHEDDAR = 300;

  let PRODUCTS = {
    burgers: [],
    drinks: []
  };

  /* ============================
       SIDES (papas)
  ============================ */

  let SIDES_STATE = {
    con_sazon: true,
    con_sal: true,
    sin_sal: true
  };

  function applySidesToUI(){
    document.querySelectorAll('#friesOptions .pill').forEach(label=>{
      const input = label.querySelector('input[name="fries"]');
      const val = input.value;
      const enabled = SIDES_STATE[val] !== false;

      input.disabled = !enabled;
      label.classList.toggle('disabled', !enabled);
    });

    const noteEl = $("#friesStateNote");
    const disabled = Object.entries(SIDES_STATE)
      .filter(([k,v])=>v===false)
      .map(([k])=>k);

    if(disabled.length){
      const txt = disabled
        .map(k=> k==="con_sazon"?"Sazonadas":k==="con_sal"?"Con sal":"Sin sal")
        .join(", ");
      noteEl.textContent = "Variantes deshabilitadas: " + txt;
      noteEl.classList.add("side-disabled-note");
    } else {
      noteEl.textContent = "";
      noteEl.classList.remove("side-disabled-note");
    }
  }

  // üî• Firestore ‚Äî lados en vivo
  db.collection("config").doc("sides").onSnapshot(snap=>{
    const data = snap.data() || {};
    SIDES_STATE = {
      con_sazon: data.con_sazon !== false,
      con_sal:   data.con_sal   !== false,
      sin_sal:   data.sin_sal   !== false
    };
    applySidesToUI();
  });

  /* ============================
      DISPONIBILIDAD PRODUCTS
  ============================ */

  let availability = new Map();
  const isAvailable = id => availability.get(id) !== false;

  // Escucha Firestore
  db.collection("products").onSnapshot(snap=>{
    availability.clear();
    snap.forEach(doc=>{
      const d = doc.data();
      availability.set(doc.id, d.available !== false);
    });
    refreshAvailabilityUI();
  });

  /* ==============================
      RENDER DEL MEN√ö (FULL FIRESTORE)
  =============================== */

  const elBurgersGrid = $("#burgersGrid");
  const elDrinksGrid  = $("#drinksGrid");

  function renderCard(item){
    const ok = isAvailable(item.id);

    const card = document.createElement("div");
    card.className = "card";
    card.dataset.id = item.id;
    card.dataset.soldout = ok ? "0" : "1";

    card.innerHTML = `
      <div class="imgwrap">
        <img src="${item.img}" alt="${item.name}" 
             onerror="this.onerror=null;this.src='${FALLBACK_IMG}'">
        ${ok ? "" : `<div class="soldout-badge">SIN STOCK</div>`}
      </div>

      <div class="content">
        <h3 style="margin:4px 0 6px">${item.name}</h3>
        ${item.description ? `<div class="muted">${item.description}</div>` : ""}

        <div class="row">
          <span class="price">${money(item.price)}</span>

          <div class="actions">
            <button class="btn addBtn" ${ok?"":"disabled"}>
              Agregar
            </button>
          </div>
        </div>
      </div>
    `;

    // CLICK de agregar
    const btn = card.querySelector(".addBtn");
    if(item.category === "drink"){
      btn.onclick = ()=>{
        if(!isAvailable(item.id)) return;

        if(!cart.drink[item.id]) cart.drink[item.id] = { qty: 0, item };
        cart.drink[item.id].qty++;
        renderCart();
      };
    } else {
      btn.onclick = ()=>{
        if(!isAvailable(item.id)) return;
        openCustomize(item, null, "add");
      };
    }

    return card;
  }

  // üî• Firestore ‚Äî escuchar productos
  db.collection("products").onSnapshot(snap=>{
    PRODUCTS = { burgers: [], drinks: [] };

    snap.forEach(doc=>{
      const d = doc.data();
      if(!d || !d.category) return;

      const item = {
        id: doc.id,
        name: d.name || "",
        price: d.price || 0,
        img: d.img || FALLBACK_IMG,
        description: d.description || "",
        category: d.category,
        kind: d.kind || "simple"
      };

      if(d.category === "burger") PRODUCTS.burgers.push(item);
      if(d.category === "drink")  PRODUCTS.drinks.push(item);
    });

    mountMenu();
  });

  function mountMenu(){
    elBurgersGrid.innerHTML = "";
    elDrinksGrid.innerHTML = "";

    PRODUCTS.burgers.forEach(b=> elBurgersGrid.appendChild(renderCard(b)));
    PRODUCTS.drinks.forEach(d=> elDrinksGrid.appendChild(renderCard(d)));

    refreshAvailabilityUI();
  }

  /* ============================
      DISPONIBILIDAD EN EL UI
  ============================ */

  function refreshAvailabilityUI(){
    document.querySelectorAll('.card[data-id]').forEach(card=>{
      const id = card.dataset.id;
      const ok = isAvailable(id);

      card.dataset.soldout = ok ? "0" : "1";

      const btn = card.querySelector(".addBtn");
      if(btn){
        if(ok){
          btn.disabled = false;
          btn.classList.remove("disabled");
        } else {
          btn.disabled = true;
          btn.classList.add("disabled");
        }
      }

      // badge
      let badge = card.querySelector(".soldout-badge");
      if(!ok){
        if(!badge){
          badge = document.createElement("div");
          badge.className = "soldout-badge";
          badge.textContent = "SIN STOCK";
          card.querySelector(".imgwrap").appendChild(badge);
        }
      } else {
        if(badge) badge.remove();
      }
    });
  }

  /* ============================
      CARRITO (se completa en PARTE 4)
  ============================ */

  let cart = { burger:{}, drink:{} };
  const cartItems = $("#cartItems");
  const cartTotal = $("#cartTotal");

 function renderCart(){
    // ESTA FUNCI√ìN SE COMPLETA EN PARTE 4
  }
</script>

<script>
/* ============================================================
      ===  CARRITO COMPLETO  ===
============================================================ */

function calcTotal(){
  let t = 0;

  for(const b of Object.values(cart.burger)){
    const base  = b.item.price;
    const patty = (b.extras?.patty||0) * EXTRA_PRICE_PATTY;
    const che   = (b.extras?.cheddar||0) * EXTRA_PRICE_CHEDDAR;
    t += (base + patty + che) * b.qty;
  }

  for(const d of Object.values(cart.drink)){
    t += d.item.price * d.qty;
  }

  return t;
}

function friesName(v){
  if(!v) return "‚Äî";
  if(v === "con_sazon") return "Sazonadas";
  if(v === "con_sal")   return "Con sal";
  if(v === "sin_sal")   return "Sin sal";
  return v;
}

function renderCart(){
  const out = [];

  // Burgers
  for(const [key,o] of Object.entries(cart.burger)){
    const unit = o.item.price
               + (o.extras?.patty||0)*EXTRA_PRICE_PATTY
               + (o.extras?.cheddar||0)*EXTRA_PRICE_CHEDDAR;

    out.push(`
      <div class="item">
        <div>
          <strong>${o.item.name}</strong>
          <div class="muted">Papas: ${friesName(o.fries)}${!o.fries?'<span class="badge-warn">Elegir</span>':''}</div>
          ${o.extras?.patty?`<div class="muted">+${o.extras.patty} medall√≥n</div>`:''}
          ${o.extras?.cheddar?`<div class="muted">+${o.extras.cheddar} cheddar</div>`:''}
          ${o.notes?`<div class="muted">Nota: ${o.notes}</div>`:''}
          <button class="btn" style="margin-top:6px" onclick="editItem('burger','${encodeURIComponent(key)}')">‚úèÔ∏è Editar</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn" onclick="changeQty('burger','${encodeURIComponent(key)}',-1)">-</button>
          <span>${o.qty}</span>
          <button class="qtybtn" onclick="changeQty('burger','${encodeURIComponent(key)}',1)">+</button>
          <span>${money(unit * o.qty)}</span>
        </div>
      </div>
    `);
  }

  // Drinks
  for(const [key,o] of Object.entries(cart.drink)){
    out.push(`
      <div class="item">
        <div><strong>${o.item.name}</strong></div>

        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn" onclick="changeQty('drink','${encodeURIComponent(key)}',-1)">-</button>
          <span>${o.qty}</span>
          <button class="qtybtn" onclick="changeQty('drink','${encodeURIComponent(key)}',1)">+</button>
          <span>${money(o.item.price * o.qty)}</span>
        </div>
      </div>
    `);
  }

  cartItems.innerHTML = out.length ? out.join("") : "Sin √≠tems.";
  cartTotal.textContent = money(calcTotal());

  refreshSlotsUI();  // recalcula cada vez que cambia el carrito
}

window.changeQty = function(type, encKey, delta){
  const key = decodeURIComponent(encKey);
  const bucket = cart[type];

  if(!bucket[key]) return;

  bucket[key].qty += delta;

  if(bucket[key].qty <= 0) delete bucket[key];

  renderCart();
};


/* ============================================================
      ===  MODAL PERSONALIZAR  ===
============================================================ */

const overlay    = $("#overlay");
const modTitle   = $("#modTitle");

const rowPatties = $("#rowPatties");
const rowCheddar = $("#rowCheddar");

const patVal     = $("#patVal");
const patInc     = $("#patInc");
const patDec     = $("#patDec");

const cheVal     = $("#cheVal");
const cheInc     = $("#cheInc");
const cheDec     = $("#cheDec");

const notes      = $("#notes");
const unitPreview= $("#unitPreview");

let currentItem  = null;
let CUSTOMIZE_MODE = "add";
let editingKey   = null;
let resolveCheckoutStep = null;

function autoGrow(el){
  el.style.height = "auto";
  el.style.height = el.scrollHeight + "px";
}
function updateCount(el){
  $("#notesCount").textContent = `${el.value.length}/200`;
}

function resetFries(){
  document.querySelectorAll("input[name='fries']").forEach(r=> r.checked=false);
}
function setFries(val){
  const r = document.querySelector(`input[name='fries'][value='${val}']`);
  if(r && !r.disabled) r.checked=true;
}
function getSelectedFries(){
  const r = document.querySelector("input[name='fries']:checked");
  return r ? r.value : null;
}

function unitPricePreview(base){
  const pat = (+patVal.textContent||0)*EXTRA_PRICE_PATTY;
  const che = (+cheVal.textContent||0)*EXTRA_PRICE_CHEDDAR;
  unitPreview.textContent = money(base + pat + che);
}

if(patInc) patInc.onclick = ()=>{ const v=+patVal.textContent||0; if(v<2) patVal.textContent=v+1; unitPricePreview(currentItem.price); };
if(patDec) patDec.onclick = ()=>{ const v=+patVal.textContent||0; if(v>0) patVal.textContent=v-1; unitPricePreview(currentItem.price); };
if(cheInc) cheInc.onclick = ()=>{ const v=+cheVal.textContent||0; if(v<3) cheVal.textContent=v+1; unitPricePreview(currentItem.price); };
if(cheDec) cheDec.onclick = ()=>{ const v=+cheVal.textContent||0; if(v>0) cheVal.textContent=v-1; unitPricePreview(currentItem.price); };

function buildKey(id, fries, extras, note){
  return [
    id,
    fries||"",
    extras.patty||0,
    extras.cheddar||0,
    (note||"").substr(0,20).replace(/\|/g,"/")
  ].join("|");
}

function openCustomize(item, keyForEdit, mode="add"){
  if(!isAvailable(item.id)) return;

  currentItem    = item;
  CUSTOMIZE_MODE = mode;
  editingKey     = keyForEdit;

  modTitle.textContent = (mode==="edit"?"Editar: ":"Personalizar: ") + item.name;

  notes.value="";
  resetFries();

  let pat = 0, che=0, note="", fries=null;

  if(mode!=="add" && keyForEdit){
    const prev = cart.burger[keyForEdit];
    if(prev){
      fries = prev.fries || null;
      pat   = prev.extras?.patty||0;
      che   = prev.extras?.cheddar||0;
      note  = prev.notes||"";
    }
  }

  if(fries) setFries(fries);
  patVal.textContent = pat;
  cheVal.textContent = che;
  notes.value        = note;

  autoGrow(notes);
  updateCount(notes);

  // reglas segun tipo
  if(item.kind==="double"){
    rowPatties.style.display = "flex";
    rowCheddar.style.display = "flex";
  } else if(item.kind==="chicken"){
    rowPatties.style.display = "none";
    rowCheddar.style.display = "flex";
  } else {
    rowPatties.style.display = "none";
    rowCheddar.style.display = "none";
  }

  unitPricePreview(item.price);
  applySidesToUI();

  overlay.classList.add("open");
}

$("#btnCancel").onclick = ()=>{
  overlay.classList.remove("open");

  if(CUSTOMIZE_MODE==="checkout" && typeof resolveCheckoutStep==="function"){
    resolveCheckoutStep(false);
  }
};

$("#btnAdd").onclick = ()=>{
  if(!currentItem) return;

  const fries = getSelectedFries();

  const isDouble  = currentItem.kind === "double";
  const isChicken = currentItem.kind === "chicken";

  const pat = isDouble  ? Math.min(2, +patVal.textContent||0) : 0;
  const che = (isDouble||isChicken) ? Math.min(3, +cheVal.textContent||0) : 0;

  const extras = { patty:pat, cheddar:che };
  const note   = notes.value.trim();

  if(CUSTOMIZE_MODE==="add"){
    const k = buildKey(currentItem.id, fries, extras, note) + "|" + Date.now();

    cart.burger[k] = {
      qty:1, item:currentItem, fries, extras, notes:note
    };

  } else if(CUSTOMIZE_MODE==="edit" || CUSTOMIZE_MODE==="checkout") {

    const prev = cart.burger[editingKey];
    if(prev){
      const newBase = buildKey(prev.item.id, fries??prev.fries, extras, note);

      let fusionKey = Object.keys(cart.burger).find(k=>{
        if(k===editingKey) return false;
        const o = cart.burger[k];
        const baseO = buildKey(o.item.id, o.fries, o.extras||{}, o.notes||"");
        return baseO === newBase;
      });

      if(!fusionKey){
        fusionKey = editingKey;
      } else {
        cart.burger[fusionKey].qty += prev.qty;
        delete cart.burger[editingKey];
      }

      cart.burger[fusionKey] = {
        ...(cart.burger[fusionKey] || prev),
        item:prev.item,
        qty:(cart.burger[fusionKey]?.qty ?? prev.qty),
        fries: fries ?? prev.fries ?? null,
        extras,
        notes: note
      };
    }
  }

  overlay.classList.remove("open");
  renderCart();

  if(CUSTOMIZE_MODE==="checkout" && typeof resolveCheckoutStep==="function"){
    resolveCheckoutStep(true);
  }
};

window.editItem = function(type, encKey){
  if(type!=="burger") return;
  const key = decodeURIComponent(encKey);
  const o = cart.burger[key];
  if(!o) return;
  openCustomize(o.item, key, "edit");
};


/* ============================================================
      ===  SLOTS (19:10 / 19:20 AUTO)  ===
============================================================ */

const MINUTES_AHEAD = 5;

const START_10 = "19:10";
const START_20 = "19:20";

const OPEN_TIME = "12:00";
const LAST_PICKUP = "02:00";

function parseHHMM(s){
  const [h,m]=s.split(":").map(Number);
  return {h,m};
}
function pad(n){ return String(n).padStart(2,"0"); }

function dateTodayAt(hhmm, add=0){
  const {h,m} = parseHHMM(hhmm);
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate()+add, h, m, 0,0);
}

function slotPretty(d){
  return d.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
}

function nextValidStart(interval){
  const now = new Date();
  now.setSeconds(0);
  now.setMilliseconds(0);

  const minStart = new Date(now.getTime() + MINUTES_AHEAD*60000);
  const rem = minStart.getMinutes() % interval;
  if(rem!==0){
    minStart.setMinutes(minStart.getMinutes() + (interval-rem));
  }
  return minStart;
}

function genSlots(startAt, interval){
  const open = dateTodayAt(OPEN_TIME);
  const start = startAt > open ? startAt : open;

  let last = dateTodayAt(LAST_PICKUP);
  if(last <= start) last = dateTodayAt(LAST_PICKUP,1);

  const out = [];
  let cur = new Date(start);
  while(cur <= last){
    out.push(new Date(cur));
    cur = new Date(cur.getTime() + interval*60000);
  }
  return out;
}

function totalBurgersInCart(){
  return Object.values(cart.burger).reduce((n,o)=>n+(o.qty||0),0);
}

let allSlots = [];
let visibleSlots = [];
let currentVisibleIndex = 0;

async function subscribeAndRenderSlots(){
  const burgers = totalBurgersInCart();
  const interval = burgers <= 2 ? 10 : 20;

  const baseStart = interval===10 ? START_10 : START_20;
  const baseDate  = dateTodayAt(baseStart);
  const now = new Date();

  let startAt;
  if(now <= baseDate) startAt = baseDate;
  else startAt = nextValidStart(interval);

  const slots = genSlots(startAt, interval);

  allSlots = slots.map(d=>({
    date:d,
    key:String(d.getFullYear())
       +pad(d.getMonth()+1)
       +pad(d.getDate())
       +"_"
       +pad(d.getHours())
       +pad(d.getMinutes()),
    count:0,
    unsub:null
  }));

  $("#pickupTime").textContent = "Cargando...";
  $("#pickupDesc").textContent = `Turnos cada ${interval} minutos ‚Äî cupos ilimitados`;
  $("#pickupCupos").style.display = "none";

  allSlots.forEach(s=>{
    const ref = db.collection("slots").doc(s.key);
    s.unsub = ref.onSnapshot(snap=>{
      s.count = snap.exists ? Number(snap.data().count||0) : 0;
      rebuildVisibleSlotsAndKeepSelection();
    });
  });

  rebuildVisibleSlotsAndKeepSelection();
}

function rebuildVisibleSlotsAndKeepSelection(){
  const prevKey = window._selectedSlot?.key || null;

  visibleSlots = allSlots.slice();

  let idx = visibleSlots.findIndex(s=>s.key===prevKey);
  if(idx<0) idx = 0;

  currentVisibleIndex = idx;
  updatePickupUI();
}

function updatePickupUI(){
  const s = visibleSlots[currentVisibleIndex];
  if(!s){
    $("#pickupTime").textContent = "Sin horarios";
    return;
  }

  $("#pickupTime").textContent  = slotPretty(s.date);
  $("#pickupCupos").textContent = "sin l√≠mite";
  $("#pickupCupos").style.display = "inline";

  $("#btnPrev").classList.toggle("disabled", currentVisibleIndex===0);
  $("#btnNext").classList.toggle("disabled", currentVisibleIndex===visibleSlots.length-1);

  window._selectedSlot = {
    key:s.key,
    iso:s.date.toISOString(),
    pretty:slotPretty(s.date)
  };

  renderQuickList();
}

function renderQuickList(){
  const UL = $("#slotsQuickList");
  UL.innerHTML = "";
  visibleSlots.forEach((s,i)=>{
    const div = document.createElement("div");
    div.className = "slot-quick";
    div.textContent = `${slotPretty(s.date)} ¬∑ sin l√≠mite`;
    div.onclick = ()=>{
      currentVisibleIndex = i;
      updatePickupUI();
      $("#slotsOverlay").classList.remove("open");
    };
    UL.appendChild(div);
  });
}

async function refreshSlotsUI(){
  try{ await subscribeAndRenderSlots(); }catch(e){}
}


/* ============================================================
      ===  CONFIRMAR PAPAS  ===
============================================================ */

async function ensureFriesForAll(){
  while(true){
    const missing = Object.entries(cart.burger).find(([k,o])=>!o.fries);
    if(!missing) return true;

    const [key,obj] = missing;

    await new Promise(res=>{
      resolveCheckoutStep = res;
      openCustomize(obj.item, key, "checkout");
    });

    if(!cart.burger[key] || !cart.burger[key].fries){
      const cont = confirm("Falta elegir papas. ¬øSeguir editando?");
      if(!cont) return false;
    }
  }
}


/* ============================================================
      ===  N√öMERO DE PEDIDO AUTOINCREMENTAL  ===
============================================================ */

function getNextOrderNumber(){
  let lastKnown = 0;
  return db.collection("orders")
    .orderBy("orderNumber","desc")
    .limit(1)
    .get()
    .then(q=>{
      if(!q.empty) lastKnown = Number(q.docs[0].data().orderNumber||0);
    })
    .then(()=>{
      return db.runTransaction(async tx=>{
        const ref = db.collection("config").doc("counters");
        const snap = await tx.get(ref);
        const cur  = snap.exists ? Number(snap.data().orderNumber||0) : 0;
        const base = Math.max(cur,lastKnown);
        const nxt  = base+1;

        tx.set(ref,{
          orderNumber:nxt,
          updatedAt:firebase.firestore.FieldValue.serverTimestamp()
        },{merge:true});

        return nxt;
      });
    });
}


/* ============================================================
      ===  IMPRESI√ìN DEL TICKET  ===
============================================================ */
// Usamos tu buildTicketHTML completo de tu versi√≥n final.
// Para simplificar ac√° solo llamo a tu funci√≥n.

function printInIframe(docSnap){
  const html = buildTicketHTML(docSnap); // ya definida en tu mostrador original
  const iframe = document.createElement("iframe");

  iframe.style.position="fixed";
  iframe.style.right="0";
  iframe.style.bottom="0";
  iframe.style.width="0";
  iframe.style.height="0";
  iframe.style.border="0";
  iframe.setAttribute("aria-hidden","true");

  document.body.appendChild(iframe);

  const doc = iframe.contentWindow.document;
  doc.open();
  doc.write(html);
  doc.close();

  iframe.contentWindow.onafterprint = ()=> setTimeout(()=>iframe.remove(),150);
  setTimeout(()=>iframe.remove(),15000);
}


/* ============================================================
      ===  IMPRIMIR & CARGAR PEDIDO  ===
============================================================ */

const btnPrintAndLoad = $("#btnPrintAndLoad");
let inFlight = false;

btnPrintAndLoad.onclick = async ()=>{

  if(inFlight) return;
  inFlight = true;

  btnPrintAndLoad.disabled = true;
  btnPrintAndLoad.classList.add("disabled");

  try{
    // Validar carrito
    const hasItems = Object.keys(cart.burger).length || Object.keys(cart.drink).length;
    if(!hasItems){
      alert("Agreg√° alg√∫n producto.");
      throw new Error("empty");
    }

    // Confirmar papas
    const okFries = await ensureFriesForAll();
    if(!okFries) throw new Error("cancel-fries");

    // Datos principales
    const nombreRaw = ($("#inpNombre").value||"").trim();
    if(!nombreRaw){
      alert("Ingres√° el nombre.");
      throw new Error("no-name");
    }
    const nombre   = nombreRaw + " (mostrador)";
    const telefono = ($("#inpTel").value||"").trim();
    const pago     = $("#selPago").value;
    const comentario = ($("#inpComentario").value||"").trim();

    // Slot
    const selected = window._selectedSlot || null;

    // N√∫mero de pedido
    const orderNumber = await getNextOrderNumber();

    // Armar lista items
    const items = [];

    for(const o of Object.values(cart.burger)){
      items.push({
        id:o.item.id,
        name:o.item.name,
        price:o.item.price,
        qty:o.qty,
        fries:o.fries||"",
        notes:o.notes||"",
        extras:{
          patty:o.extras?.patty||0,
          cheddar:o.extras?.cheddar||0,
          EXTRA_PRICE_PATTY,
          EXTRA_PRICE_CHEDDAR
        }
      });
    }

    for(const o of Object.values(cart.drink)){
      items.push({
        id:o.item.id,
        name:o.item.name,
        price:o.item.price,
        qty:o.qty,
        fries:"",
        notes:"",
        extras:{}
      });
    }

    const total = calcTotal();

    const payload = {
      orderNumber,
      number:orderNumber,
      nombre,
      telefono,
      pago,
      comment:comentario,
      items,
      total,
      status:(pago==="mercado_pago"?"pending_payment":"accepted"),
      payment_status:(pago==="mercado_pago"?"pending_payment":"paid"),
      source:"mostrador",

      pickup_slot: selected ? selected.key : null,
      pickup_time: selected ? selected.iso : null,
      pickup_time_pretty: selected ? selected.pretty : null,
      pickup_asap: !selected,

      printedAt:null,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    };

    // Guardar pedido
    const ref = await db.collection("orders").add(payload);

    // order_public
    const pubId = ref.id.slice(0,22);
    await db.collection("order_public").doc(pubId).set({
      orderId:ref.id,
      orderNumber,
      status:(payload.status==="pending_payment"?"pending_payment":"accepted"),
      entrega:"retira",
      pago,
      nombre,
      pickup_slot: payload.pickup_slot,
      pickup_time: payload.pickup_time,
      pickup_time_pretty: payload.pickup_time_pretty,
      pickup_asap: payload.pickup_asap,
      createdAt:firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt:firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});

    // imprimir
    let savedDoc;
    try {
      savedDoc = await ref.get();
    } catch(e){
      savedDoc = {
        id:ref.id,
        data:()=>({...payload, createdAt:new Date()})
      };
    }

    printInIframe(savedDoc);

    // limpiar UI
    cart = {burger:{},drink:{}};
    renderCart();

    $("#inpNombre").value="";
    $("#inpTel").value="";
    $("#inpComentario").value="";

    alert(`Pedido #${orderNumber} cargado`);

  } catch(e){
    console.error(e);
    if(!["empty","no-name","cancel-fries"].includes(e.message)){
      alert("Error al cargar pedido.");
    }

  } finally {
    setTimeout(()=>{
      inFlight=false;
      btnPrintAndLoad.disabled=false;
      btnPrintAndLoad.classList.remove("disabled");
    },700);
  }
};


/* ============================================================
      ===  INICIO  ===
============================================================ */

document.addEventListener("DOMContentLoaded", ()=>{
  mountMenu();  
  refreshSlotsUI();

  // navegaci√≥n slots
  $("#btnPrev").onclick = ()=>{
    if(currentVisibleIndex>0){
      currentVisibleIndex--;
      updatePickupUI();
    }
  };
  $("#btnNext").onclick = ()=>{
    if(currentVisibleIndex < visibleSlots.length-1){
      currentVisibleIndex++;
      updatePickupUI();
    }
  };

  $("#btnQuick").onclick = ()=>{
    renderQuickList();
    $("#slotsOverlay").classList.add("open");
  };

  $("#closeSlots").onclick = ()=>{
    $("#slotsOverlay").classList.remove("open");
  };

  $("#slotsOverlay").onclick = e=>{
    if(e.target === $("#slotsOverlay")){
      $("#slotsOverlay").classList.remove("open");
    }
  };
});
</script>
</body>
</html>
