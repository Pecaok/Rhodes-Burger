<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#645E52;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#eaeaea;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:18px;

      --price-cheddar:300;
      --price-patty:2500;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
    }
    .brand img{
      width:36px;
      height:36px;
      border-radius:10px;
      background:#fff;
      object-fit:contain;
      margin-right:8px;
    }
    .spacer{ flex:1; }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ring);
      background:#fff;
      padding:10px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      color:inherit;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    .container{
      max-width:1200px;
      margin:20px auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 420px;
      gap:18px;
    }
    @media(max-width:980px){
      .container{ grid-template-columns:1fr; }
    }

    h1{ font-size:26px; margin:10px 0 12px; }
    h2{ font-size:20px; margin:18px 0 10px; }

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(220px,1fr));
      gap:16px;
    }
    @media(max-width:720px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .card img{
      width:100%;
      height:200px;
      object-fit:cover;
    }

    .content{ padding:12px; }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
    }
    .price{ font-weight:800; }

    aside.side{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      position:sticky;
      top:80px;
      display:flex;
      flex-direction:column;
      height: calc(100vh - 100px);
      overflow:hidden;
    }

    #cartScrollArea{
      flex:1;
      overflow-y:auto;
      margin-bottom:16px;
      padding-right:6px;
    }

    .field input,
    .field select {
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--ring);
      font-size:15px;
      box-sizing:border-box;
    }

    .field label{
      display:block;
      font-weight:600;
      margin-bottom:4px;
    }

    #cartItems{
      flex:1;
      overflow-y:auto;
      padding-right:8px;
      margin-bottom:12px;
    }

    .muted{ color:var(--muted); font-size:13px; }

    .qtybtn{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--ring);
      font-weight:700;
      cursor:pointer;
      background:#fff;
    }

    .carousel{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:14px;
    }
    .arrow{
      width:44px;
      height:44px;
      display:inline-grid;
      place-items:center;
      background:#fff;
      cursor:pointer;
      border-radius:10px;
      border:1px solid var(--ring);
      font-size:22px;
      font-weight:700;
      user-select:none;
    }
    .arrow.disabled{ opacity:.4; cursor:not-allowed; }

    .slot-display{
      min-width:160px;
      padding:12px 16px;
      background:#fff;
      border-radius:12px;
      border:1px solid var(--ring);
      text-align:center;
      font-weight:800;
      font-size:18px;
    }

    #miniSlotSub{ margin-top:8px; font-size:14px; color:#666; }

    .overlay{
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
    }
    .modal{
      width:480px;
      max-width:90%;
      background:white;
      border-radius:22px;
      padding:28px;
      box-shadow:0 15px 40px rgba(0,0,0,.25);
    }

    textarea{
      width:100%;
      min-height:90px;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid #dfd9d0;
      background:#fcfaf7;
      font-size:15px;
      color:#3e3a33;
      resize:none;
    }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png" alt="">Rhodes Burgers</a>
    <div class="spacer"></div>

    <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
    <a class="btn" href="finanzas.html">üìà Finanzas</a>
    <a class="btn" href="admin.html">‚öôÔ∏è Admin</a>

    <strong style="margin-left:8px">Mostrador</strong>
  </div>
</header>

<main class="container">

  <!-- LISTA DE PRODUCTOS -->
  <section>
    <h1>Men√∫</h1>

    <h2>Hamburguesas</h2>
    <div id="burgersGrid" class="grid"></div>

    <h2 style="margin-top:20px">Bebidas</h2>
    <div id="drinksGrid" class="grid"></div>

    <h2 style="margin-top:20px">Guarniciones</h2>
    <div id="sidesGrid" class="grid"></div>
  </section>

  <!-- CARRITO -->
  <aside class="side">
    <h2 style="margin-top:0">Carrito</h2>

    <div class="total">
      <span>Total</span>
      <span id="cartTotal">$0</span>
    </div>

    <div id="cartScrollArea">
      <div id="cartItems" class="muted">Sin √≠tems.</div>
    </div>

    <div class="field">
      <label>Nombre (requerido)</label>
      <input id="inpNombre" type="text">
    </div>

    <div class="field">
      <label>Tel√©fono (opcional)</label>
      <input id="inpTel" type="tel">
    </div>

    <div class="field">
      <label>M√©todo de pago</label>
      <select id="selPago">
        <option value=""></option>
        <option value="efectivo">Efectivo</option>
        <option value="mercado_pago">Mercado Pago</option>
        <option value="debito">D√©bito</option>
        <option value="transferencia">Transferencia</option>
      </select>
    </div>

    <h3 style="margin-top:24px">Horario de retiro</h3>

    <div class="carousel">
      <div class="arrow" id="slotPrev">‚óÄ</div>
      <div class="slot-display" id="slotLabel">--:--</div>
      <div class="arrow" id="slotNext">‚ñ∂</div>
    </div>

    <div style="margin-top:10px">
      <label style="font-weight:600;font-size:14px">Horario personalizado</label>
      <input 
        id="manualTime" 
        type="time"
        style="margin-top:6px;padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:15px;width:160px"
      >
    </div>

    <div id="miniSlotSub" class="muted">Seleccionado: ‚Äî</div>

    <button id="btnCargarPedido" class="btn primary" style="width:100%;margin-top:18px">
      Cargar pedido
    </button>

  </aside>
</main>

<!-- MODAL PERSONALIZAR -->
<div class="overlay" id="overlayCustomize">
  <div class="modal">
    <h3 id="modTitle">Personalizar</h3>

    <div class="field">
      <label>Papas (obligatorio)</label>
      <div style="display:flex;gap:12px;margin-top:6px">
        <label class="chip"><input type="radio" name="fries" value="con_sazon"> Sazonadas</label>
        <label class="chip"><input type="radio" name="fries" value="con_sal"> Con sal</label>
        <label class="chip"><input type="radio" name="fries" value="sin_sal"> Sin sal</label>
      </div>
    </div>

    <div id="rowPatties" class="row" style="display:none;margin-top:22px;">
      <div>Medallones extra</div>
      <div>
        <button id="patDec" class="qtybtn">-</button>
        <span id="patVal">0</span>
        <button id="patInc" class="qtybtn">+</button>
      </div>
    </div>

    <div id="rowCheddar" class="row" style="display:none;margin-top:18px;">
      <div>Cheddar extra</div>
      <div>
        <button id="cheDec" class="qtybtn">-</button>
        <span id="cheVal">0</span>
        <button id="cheInc" class="qtybtn">+</button>
      </div>
    </div>

    <div class="row" style="margin-top:24px;justify-content:flex-end">
      <span class="muted">Subtotal:</span>
      <span id="unitPreview" style="font-weight:800;font-size:20px"></span>
    </div>

    <div class="field" style="margin-top:22px">
      <label>Notas (opcional)</label>
      <textarea id="notes" maxlength="200"></textarea>
      <div id="notesCount" class="muted">0/200</div>
    </div>

    <div class="row" style="margin-top:26px;justify-content:flex-end;gap:10px">
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn primary" id="btnAdd">Agregar</button>
    </div>
  </div>
</div>


<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ============= FIREBASE ============= */
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const $ = s => document.querySelector(s);
const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
const FALLBACK_IMG = "images/logo.png";

const EXTRA_PRICE_PATTY   = 2500;
const EXTRA_PRICE_CHEDDAR = 300;

/* ============= MEN√ö ============= */
let PRODUCTS = { burgers: [], drinks: [], sides: [] };
let MENU_ORDER = {};
let availability = new Map();

db.collection("config").doc("menuOrder").onSnapshot(snap=>{
  MENU_ORDER = snap.exists ? snap.data() : {};
  mountMenu();
});

const isAvailable = id => availability.get(id) !== false;

db.collection("products").onSnapshot(snap=>{
  availability.clear();
  PRODUCTS = { burgers: [], drinks: [], sides: [] };

  snap.forEach(doc=>{
    const d = doc.data();
    const item = {
      id: doc.id,
      name: d.name,
      price: d.price,
      img: d.img || FALLBACK_IMG,
      description: d.description || "",
      category: d.category,
      kind: d.kind || ""
    };

    if(d.available === false) availability.set(doc.id, false);

    if(["burger","hamburguesas","hamburger"].includes(d.category))
      PRODUCTS.burgers.push(item);

    if(["drink","drinks","bebidas"].includes(d.category))
      PRODUCTS.drinks.push(item);

    if(["side","sides","guarniciones"].includes(d.category))
      PRODUCTS.sides.push(item);
  });

  mountMenu();
});

function orderedList(category, arr){
  const order = MENU_ORDER[category] || [];
  const map = new Map(order.map((id,i)=>[id,i]));
  return [...arr].sort((a,b)=>{
    const A = map.has(a.id) ? map.get(a.id) : 9999;
    const B = map.has(b.id) ? map.get(b.id) : 9999;
    return A - B;
  });
}

const elBurgersGrid = $("#burgersGrid");
const elDrinksGrid  = $("#drinksGrid");
const elSidesGrid   = $("#sidesGrid");

function renderCard(item){
  const ok = isAvailable(item.id);
  const card = document.createElement("div");
  card.className = "card";

  if (!ok) card.style.opacity = ".45";

  card.innerHTML = `
    <img src="${item.img}" onerror="this.src='${FALLBACK_IMG}'">
    <div class="content">
      <h3>${item.name}</h3>
      ${item.description ? `<div class="muted">${item.description}</div>` : ""}
      <div class="row">
        <span class="price">${money(item.price)}</span>
        <button class="btn addBtn" ${ok?"":"disabled"}>Agregar</button>
      </div>
    </div>
  `;

  const btn = card.querySelector(".addBtn");

  if(item.category === "bebidas"){
    btn.onclick = ()=>{
      if(!cart.drink[item.id]) cart.drink[item.id]={qty:0,item};
      cart.drink[item.id].qty++;
      renderCart();
    };
  }
  else if(item.category === "guarniciones"){
    btn.onclick = ()=>{
      if(!cart.side[item.id]) cart.side[item.id]={qty:0,item};
      cart.side[item.id].qty++;
      renderCart();
    };
  }
  else{
    btn.onclick = ()=> openCustomize(item);
  }

  return card;
}

function mountMenu(){
  elBurgersGrid.innerHTML = "";
  elDrinksGrid.innerHTML  = "";
  elSidesGrid.innerHTML   = "";

  orderedList("hamburguesas", PRODUCTS.burgers)
    .forEach(x=> elBurgersGrid.appendChild(renderCard(x)));

  orderedList("bebidas", PRODUCTS.drinks)
    .forEach(x=> elDrinksGrid.appendChild(renderCard(x)));

  orderedList("guarniciones", PRODUCTS.sides)
    .forEach(x=> elSidesGrid.appendChild(renderCard(x)));
}

/* ============= CARRITO ============= */
let cart = { burger:{}, drink:{}, side:{} };

function renderCart(){
  let html="";
  let total=0;

  const wrap = $("#cartItems");
  const totalEl=$("#cartTotal");

  for(const id in cart.burger){
    const b = cart.burger[id];

    const unit = b.item.price +
      b.extras.patty * EXTRA_PRICE_PATTY +
      b.extras.cheddar * EXTRA_PRICE_CHEDDAR;

    total += unit * b.qty;

    const extras=[];
    if(b.fries) extras.push("Papas: "+b.fries);
    if(b.extras.patty) extras.push("+"+b.extras.patty+" med");
    if(b.extras.cheddar) extras.push("+"+b.extras.cheddar+" cheddar");
    if(b.notes) extras.push("Nota: "+b.notes);

    html += `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
        <div style="max-width:260px">
          <strong>${b.qty}√ó ${b.item.name}</strong><br>
          <span class="muted">${extras.join(" ¬∑ ")}</span>
        </div>
        <span>${money(unit*b.qty)}</span>
      </div>
    `;
  }

  for(const id in cart.drink){
    const d = cart.drink[id];
    total += d.item.price * d.qty;
    html += `
      <div style="display:flex;justify-content:space-between;margin-bottom:12px">
        <strong>${d.qty}√ó ${d.item.name}</strong>
        <span>${money(d.item.price*d.qty)}</span>
      </div>
    `;
  }

  for(const id in cart.side){
    const s = cart.side[id];
    total += s.item.price * s.qty;
    html += `
      <div style="display:flex;justify-content:space-between;margin-bottom:12px">
        <strong>${s.qty}√ó ${s.item.name}</strong>
        <span>${money(s.item.price*s.qty)}</span>
      </div>
    `;
  }

  wrap.innerHTML = html || `<span class="muted">Sin √≠tems.</span>`;
  totalEl.textContent = money(total);
}

/* ============= CUSTOMIZE ============= */
let currentItem=null;

function openCustomize(item){
  currentItem=item;
  $("#patVal").textContent="0";
  $("#cheVal").textContent="0";
  $("#notes").value="";
  $("#notesCount").textContent="0/200";
  document.querySelectorAll("input[name='fries']").forEach(x=> x.checked=false);

  const name=item.name.toLowerCase();
  $("#rowPatties").style.display = name.includes("doble") ? "flex":"none";
  $("#rowCheddar").style.display = (name.includes("doble")||name.includes("pollo")) ? "flex":"none";

  updatePreview();

  $("#overlayCustomize").style.display="flex";
}

function updatePreview(){
  const base=currentItem.price;
  const patt=Number($("#patVal").textContent);
  const che=Number($("#cheVal").textContent);
  $("#unitPreview").textContent = money(base + patt*EXTRA_PRICE_PATTY + che*EXTRA_PRICE_CHEDDAR);
}

$("#patInc").onclick=()=>{ let v=+$("#patVal").textContent; if(v<2){ $("#patVal").textContent=v+1; updatePreview(); } }
$("#patDec").onclick=()=>{ let v=+$("#patVal").textContent; if(v>0){ $("#patVal").textContent=v-1; updatePreview(); } }
$("#cheInc").onclick=()=>{ let v=+$("#cheVal").textContent; if(v<3){ $("#cheVal").textContent=v+1; updatePreview(); } }
$("#cheDec").onclick=()=>{ let v=+$("#cheVal").textContent; if(v>0){ $("#cheVal").textContent=v-1; updatePreview(); } }

$("#notes").oninput=()=> $("#notesCount").textContent = $("#notes").value.length+"/200";

$("#btnCancel").onclick=()=> $("#overlayCustomize").style.display="none";

$("#btnAdd").onclick=()=>{
  const fries = document.querySelector("input[name='fries']:checked");
  const friesRaw = fries ? fries.value : "";
  const friesName =
      friesRaw==="con_sazon" ? "Sazonadas" :
      friesRaw==="con_sal"   ? "Con sal" :
      friesRaw==="sin_sal"   ? "Sin sal" :
      "Sin papas";

  const entry={
    item:currentItem,
    qty:1,
    fries:friesName,
    friesRaw:friesRaw,
    extras:{
      patty:+$("#patVal").textContent,
      cheddar:+$("#cheVal").textContent
    },
    notes:$("#notes").value.trim()
  };

  const newId=currentItem.id+"_"+Date.now();
  cart.burger[newId]=entry;

  $("#overlayCustomize").style.display="none";
  renderCart();
};

/* ============================================================
   üî• SLOTS MOSTRADOR  ‚Äî  CAPACIDAD REAL PERO SIN BLOQUEAR
============================================================ */

const SLOT_START = "19:15";
const SLOT_END   = "23:45";
const SLOT_INTERVAL_MIN = 15;

const GRAMOS_POR_BLOQUE = 1500;
const G_POR_BURGER = 200;
const G_POR_SIDE   = 700;

function gramosDelPedido(){
  let g=0;
  for(const id in cart.burger) g += cart.burger[id].qty * G_POR_BURGER;
  for(const id in cart.side)   g += cart.side[id].qty * G_POR_SIDE;
  return g;
}

function parseHHMM(str){
  const [h,m]=str.split(":").map(Number);
  const now=new Date();
  return new Date(now.getFullYear(),now.getMonth(),now.getDate(),h,m,0);
}

function formatHHMM(date){
  return date.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
}

function slotKey(date){
  const y=date.getFullYear();
  const M=String(date.getMonth()+1).padStart(2,"0");
  const d=String(date.getDate()).padStart(2,"0");
  const H=String(date.getHours()).padStart(2,"0");
  const m=String(date.getMinutes()).padStart(2,"0");
  return `${y}${M}${d}_${H}${m}`;
}

function generateDailySlots(){
  const start=parseHHMM(SLOT_START);
  const end=parseHHMM(SLOT_END);
  const arr=[];
  let cur=new Date(start);
  while(cur<=end){
    arr.push(new Date(cur));
    cur=new Date(cur.getTime()+SLOT_INTERVAL_MIN*60000);
  }
  return arr;
}

let slotObjects = [];
let currentSlotIndex = 0;
let slot_unsubs = [];

/* üî• FUNCI√ìN PARA IR AL PRIMER SLOT DISPONIBLE */
function goToFirstAvailableSlot(){
  const idx = slotObjects.findIndex(s => !s.full);
  if (idx === -1){
    currentSlotIndex = 0;   // si todos est√°n llenos ‚Üí primer horario
  } else {
    currentSlotIndex = idx; // primer horario no lleno
  }
}

function clearSlotSubs(){
  slot_unsubs.forEach(u=>{ try{u();}catch{} });
  slot_unsubs=[];
}

function loadSlotsMostrador(){
  clearSlotSubs();

  const slots = generateDailySlots();
  slotObjects = slots.map(date => ({
    date,
    key: slotKey(date),
    gramsUsed: 0,
    full: false
  }));

  $("#slotLabel").textContent = "Cargando‚Ä¶";
  $("#miniSlotSub").textContent = "Seleccionado: ‚Äî";

  slotObjects.forEach(s => {
    const ref = db.collection("slots_grams").doc(s.key);

    const unsub = ref.onSnapshot(doc => {
      if(!doc.exists){
        ref.set({gramsUsed:0},{merge:true});
      }

      const d = doc.data() || {};
      s.gramsUsed = Number(d.gramsUsed || 0);
      s.full = s.gramsUsed >= GRAMOS_POR_BLOQUE;

      // vuelvo a renderizar
      renderSlotMostrador();
    });

    slot_unsubs.push(unsub);
  });

  // üî• Despu√©s de cargar todo ‚Üí moverse al primer disponible
  goToFirstAvailableSlot();
  renderSlotMostrador();
}

function renderSlotMostrador(){

  // si no hay slots todav√≠a
  if(slotObjects.length === 0){
    $("#slotLabel").textContent = "Sin horarios";
    window.selectedSlot = null;
    return;
  }

  // asegurar que quede dentro del rango
  if(currentSlotIndex < 0) currentSlotIndex = 0;
  if(currentSlotIndex >= slotObjects.length) 
      currentSlotIndex = slotObjects.length - 1;

  const s = slotObjects[currentSlotIndex];
  const pretty = formatHHMM(s.date);

  // mostrar el horario
  $("#slotLabel").textContent = pretty;

  // marcar en rojo si est√° lleno
  if(s.full){
    $("#slotLabel").style.background = "#ffeaea";
    $("#slotLabel").style.borderColor = "#ffb5b5";
  } else {
    $("#slotLabel").style.background = "#fff";
    $("#slotLabel").style.borderColor = "var(--ring)";
  }

  window.selectedSlot = {
    key: s.key,
    pretty,
    iso: s.date.toISOString(),
    full: s.full
  };

  $("#miniSlotSub").textContent = "Seleccionado: " + pretty;

  // habilitar / deshabilitar flechas
  $("#slotPrev").classList.toggle("disabled", currentSlotIndex === 0);
  $("#slotNext").classList.toggle("disabled", currentSlotIndex === slotObjects.length - 1);
}

$("#slotPrev").onclick=()=>{ if(currentSlotIndex>0){currentSlotIndex--; renderSlotMostrador();} };
$("#slotNext").onclick=()=>{ if(currentSlotIndex < slotObjects.length-1){currentSlotIndex++; renderSlotMostrador();} };

window.addEventListener("DOMContentLoaded",()=>{
  loadSlotsMostrador();
});

/* ============= ENVIAR PEDIDO A FIRESTORE ============= */
async function sendToFirestore(){
  const nombre=$("#inpNombre").value.trim();
  if(!nombre){ alert("Ingres√° el nombre"); return; }

  const pago=$("#selPago").value.trim() || "sin_especificar";

  let slot = window.selectedSlot;

  const manual=$("#manualTime").value;
  if(manual){
    const now=new Date();
    slot={
      pretty:manual,
      iso:new Date(now.getFullYear(),now.getMonth(),now.getDate(),manual.split(":")[0],manual.split(":")[1]).toISOString()
    };
  }

  if(!slot){ alert("Eleg√≠ un horario"); return; }

  for(const id in cart.burger){
    if(!cart.burger[id].friesRaw){
      alert(`La hamburguesa "${cart.burger[id].item.name}" no tiene papas seleccionadas.`);
      return;
    }
  }

  const tel=$("#inpTel").value.trim();

  const items=[];
  let rawTotal=0;

  for(const id in cart.burger){
    const b=cart.burger[id];
    const unit = b.item.price +
      b.extras.patty*EXTRA_PRICE_PATTY +
      b.extras.cheddar*EXTRA_PRICE_CHEDDAR;

    rawTotal += unit*b.qty;

    items.push({
      type:"burger",
      id:b.item.id,
      name:b.item.name,
      qty:b.qty,
      price:b.item.price,
      fries:b.fries,
      extras:b.extras,
      notes:b.notes||""
    });
  }

  for(const id in cart.drink){
    const d=cart.drink[id];
    rawTotal += d.item.price*d.qty;
    items.push({
      type:"drink",
      id:d.item.id,
      name:d.item.name,
      qty:d.qty,
      price:d.item.price
    });
  }

  for(const id in cart.side){
    const s=cart.side[id];
    rawTotal += s.item.price*s.qty;
    items.push({
      type:"side",
      id:s.item.id,
      name:s.item.name,
      qty:s.qty,
      price:s.item.price
    });
  }

  async function getNextOrderNumber(){
    const ref=db.collection("config").doc("counters");
    const next=await db.runTransaction(async tx=>{
      const snap=await tx.get(ref);
      const cur=snap.exists?Number(snap.data().orderNumber||0):0;
      const nxt=cur+1;
      tx.set(ref,{orderNumber:nxt},{merge:true});
      return nxt;
    });
    return next;
  }

  const orderNumber=await getNextOrderNumber();

  const order={
    orderNumber,
    number:orderNumber,
    nombre,
    telefono:tel,
    entrega:"take_away",
    pago,
    notes:"",
    pickup_slot:slot.pretty,
    pickup_time:slot.iso,
    status: pago==="mercado_pago" ? "pending_payment" : "accepted",
    payment_status: pago==="mercado_pago" ? "pending_payment" : "paid",
    items,
    total:rawTotal,
    rawTotal,
    source:"mostrador",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("orders").doc().set(order);

  alert(`Pedido cargado ‚úîÔ∏è\nN√∫mero de pedido: #${orderNumber}`);

  cart = { burger:{}, drink:{}, side:{} };
  renderCart();

  $("#inpNombre").value="";
  $("#inpTel").value="";
  $("#selPago").value="";

  $("#manualTime").value="";
  $("#slotLabel").textContent="--:--";
  $("#miniSlotSub").textContent="Seleccionado: ‚Äî";
}

$("#btnCargarPedido").onclick = sendToFirestore;
</script>

</body>
</html>
