<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#645E52;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#eaeaea;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:18px;

      --price-cheddar:300;
      --price-patty:2500;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
    }
    .brand img{
      width:36px;
      height:36px;
      border-radius:10px;
      background:#fff;
      object-fit:contain;
      margin-right:8px;
    }
    .spacer{ flex:1; }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ring);
      background:#fff;
      padding:10px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      color:inherit;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    .container{
      max-width:1200px;
      margin:20px auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 420px;
      gap:18px;
    }
    @media(max-width:980px){
      .container{ grid-template-columns:1fr; }
    }

    h1{ font-size:26px; margin:10px 0 12px; }
    h2{ font-size:20px; margin:18px 0 10px; }

    /* PRODUCT GRID */
    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(220px,1fr));
      gap:16px;
    }
    @media(max-width:720px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .card img{
      width:100%;
      height:200px;
      object-fit:cover;
    }

    .content{ padding:12px; }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
    }
    .price{ font-weight:800; }

    /* SIDEBAR */
    aside.side{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      position:sticky;
      top:80px;
      height:fit-content;
    }

    .field{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .field label{
      font-weight:600;
      font-size:14px;
    }
    .field input,
    .field select{
      padding:12px;
      border-radius:12px;
      border:1px solid var(--ring);
      font-size:15px;
    }

    .total{
      font-size:22px;
      font-weight:800;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
    }

    /* CARRUSEL DE HORARIOS */
    .carousel{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:10px;
    }
    .arrow{
      width:44px;
      height:44px;
      display:inline-grid;
      place-items:center;
      background:#fff;
      cursor:pointer;
      border-radius:10px;
      border:1px solid var(--ring);
      font-size:22px;
      font-weight:700;
    }
    .arrow.disabled{
      opacity:.4;
      cursor:not-allowed;
    }
    .slot-display{
      min-width:160px;
      padding:12px 16px;
      background:#fff;
      border-radius:12px;
      border:1px solid var(--ring);
      text-align:center;
      font-weight:800;
      font-size:18px;
    }
    .slot-sub{
      font-size:13px;
      color:var(--muted);
      margin-top:6px;
    }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png" alt="">Rhodes Burgers</a>
    <div class="spacer"></div>
    <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
    <a class="btn" href="finanzas.html">üìà Finanzas</a>
    <a class="btn" href="admin.html">‚öôÔ∏è Admin</a>
    <strong style="margin-left:8px">Mostrador</strong>
  </div>
</header>

<main class="container">

  <!-- ======================== LISTA DE PRODUCTOS ========================== -->
  <section>
    <h1>Men√∫</h1>

    <h2>Hamburguesas</h2>
    <div id="burgersGrid" class="grid"></div>

    <h2 style="margin-top:20px">Bebidas</h2>
    <div id="drinksGrid" class="grid"></div>

    <h2 style="margin-top:20px">Guarniciones</h2>
    <div id="sidesGrid" class="grid"></div>
  </section>

  <!-- ============================= CARRITO ================================ -->
  <aside class="side">
    <h2 style="margin-top:0">Carrito</h2>

    <div class="total">
      <span>Total</span>
      <span id="cartTotal">$0</span>
    </div>

    <div id="cartItems" class="muted">Sin √≠tems.</div>

    <!-- Nombre -->
    <div class="field">
      <label>Nombre (requerido)</label>
      <input id="inpNombre" type="text" placeholder="Ej: Juan" />
    </div>

    <!-- Tel -->
    <div class="field">
      <label>Tel√©fono (opcional)</label>
      <input id="inpTel" type="tel" placeholder="Ej: 1123456789" />
    </div>

    <!-- Pago -->
    <div class="field">
      <label>M√©todo de pago</label>
      <select id="selPago">
        <option value=""></option>
        <option value="efectivo">Efectivo</option>
        <option value="mercado_pago">Mercado Pago</option>
        <option value="debito">D√©bito</option>
        <option value="transferencia">Transferencia</option>
      </select>
    </div>

    <!-- BOT√ìN PARA ABRIR CARRUSEL -->
    <button id="btnSelectHora" class="btn primary" style="width:100%;margin-top:18px">
      Seleccionar horario
    </button>

    <!-- BOT√ìN CARGAR PEDIDO -->
    <button id="btnCargarPedido" class="btn primary" style="width:100%;margin-top:14px">
      Cargar pedido
    </button>

    <!-- Vista mini del horario elegido -->
    <h3 style="margin-top:24px">Horario de retiro</h3>

    <div id="miniSlot" class="slot-display" style="margin-top:10px;font-size:17px">
      Elegir horario
    </div>

    <div id="miniSlotSub" class="slot-sub">Seleccionado: ‚Äî</div>

    <button id="btnCargarPedido2" class="btn primary" style="width:100%;margin-top:18px">
      Cargar pedido
    </button>

  </aside>
</main>
<!-- ====================== CONTENEDOR DEL SLOT ELEGIDO ====================== -->
<!-- Necesario para guardar el horario seleccionado -->
<div id="slotsCarousel" style="display:none"></div>

<!-- ====================== MODAL CARRUSEL DE HORARIOS ====================== -->
<div class="overlay" id="overlaySlots" style="
  display:none;
  align-items:center;
  justify-content:center;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  z-index:2000;
">
  <div class="modal" style="
    width:500px;
    max-width:92vw;
    padding:20px;
    background:#fff;
    border-radius:18px;
  ">
    <h2>Elegir horario</h2>

    <div class="carousel" style="margin-top:16px">
      <div class="arrow" id="slotPrev">‚óÄ</div>
      <div class="slot-display" id="slotLabel">---</div>
      <div class="arrow" id="slotNext">‚ñ∂</div>
    </div>

    <div id="slotSub" class="slot-sub" style="margin-top:12px"></div>

    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn" id="closeSlots">Cancelar</button>
      <button class="btn primary" id="applySlot">Elegir</button>
    </div>
  </div>
</div>


<!-- ====================== MODAL DE PERSONALIZAR ====================== -->
<div class="overlay" id="overlayCustomize" style="
  display:none;
  align-items:center;
  justify-content:center;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  z-index:2000;
">
  <div class="modal" style="width:520px;max-width:92vw;background:#fff;border-radius:18px;padding:20px">

    <h3 id="modTitle">Personalizar</h3>

    <!-- PAPAS -->
    <div class="field" style="margin-top:18px">
      <label>Papas (obligatorio)</label>
      <div class="chips" style="display:flex;gap:12px;flex-wrap:wrap">
        <label class="chip">
          <input type="radio" name="fries" value="con_sazon"> Sazonadas
        </label>
        <label class="chip">
          <input type="radio" name="fries" value="con_sal"> Con sal
        </label>
        <label class="chip">
          <input type="radio" name="fries" value="sin_sal"> Sin sal
        </label>
      </div>
    </div>

    <!-- EXTRAS -->
    <div class="row" id="rowPatties" style="display:none;margin-top:15px">
      <div>Medallones extra</div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="patDec" class="qtybtn">-</button>
        <span id="patVal">0</span>
        <button id="patInc" class="qtybtn">+</button>
      </div>
    </div>

    <div class="row" id="rowCheddar" style="display:none;margin-top:15px">
      <div>Fetas de cheddar extra</div>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="cheDec" class="qtybtn">-</button>
        <span id="cheVal">0</span>
        <button id="cheInc" class="qtybtn">+</button>
      </div>
    </div>

    <!-- SUBTOTAL -->
    <div class="row" style="margin-top:20px;justify-content:flex-end">
      <span class="muted">Subtotal unitario:</span>
      <span id="unitPreview" style="font-weight:800;font-size:18px">$0</span>
    </div>

    <!-- NOTES -->
    <div class="field" style="margin-top:20px">
      <label>Notas (opcional)</label>
      <textarea id="notes" maxlength="200" placeholder="Sin cebolla, extra salsa..." style="height:80px"></textarea>
      <div class="muted" id="notesCount" style="margin-top:4px">0/200</div>
    </div>

    <div class="row" style="margin-top:20px;justify-content:flex-end">
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn primary" id="btnAdd">Agregar</button>
    </div>

  </div>
</div>
<!-- ===================== FIREBASE ===================== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ============================================================
      üî• FIREBASE INIT
============================================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};

try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); }
catch(e){ console.warn(e); }

const db = firebase.firestore();

/* ============================================================
      üî• HELPERS
============================================================ */
const $ = s => document.querySelector(s);
const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
const FALLBACK_IMG = "images/logo.png";

const EXTRA_PRICE_PATTY   = 2500;
const EXTRA_PRICE_CHEDDAR = 300;

/* ============================================================
      üî• VARIABLES GLOBALES
============================================================ */
let PRODUCTS = { burgers: [], drinks: [], sides: [] };
let MENU_ORDER = {};  
let availability = new Map();

/* ============================================================
      üî• ORDEN VISUAL DEL MEN√ö (config/menuOrder)
============================================================ */
db.collection("config").doc("menuOrder").onSnapshot(snap=>{
  MENU_ORDER = snap.exists ? snap.data() : {};
  mountMenu();
});

function orderedList(category, arr){
  const order = MENU_ORDER[category] || [];
  const map   = new Map(order.map((id,i)=>[id,i]));

  return [...arr].sort((a,b)=>{
    const A = map.has(a.id) ? map.get(a.id) : 9999;
    const B = map.has(b.id) ? map.get(b.id) : 9999;
    return A - B;
  });
}

/* ============================================================
      üî• DISPONIBILIDAD (products.available)
============================================================ */
const isAvailable = id => availability.get(id) !== false;

db.collection("products").onSnapshot(snap=>{
  availability.clear();
  snap.forEach(doc=>{
    const d = doc.data();
    availability.set(doc.id, d.available !== false);
  });
  refreshAvailabilityUI();
});

/* ============================================================
      üî• RENDER DE TARJETAS DEL MEN√ö
============================================================ */
const elBurgersGrid = $("#burgersGrid");
const elDrinksGrid  = $("#drinksGrid");
const elSidesGrid   = $("#sidesGrid");

function renderCard(item){
  const ok = isAvailable(item.id);

  const card = document.createElement("div");
  card.className = "card";
  card.dataset.id = item.id;
  card.dataset.soldout = ok ? "0" : "1";

  card.innerHTML = `
    <div class="imgwrap">
      <img src="${item.img}" onerror="this.src='${FALLBACK_IMG}'">
      ${ok ? "" : `<div class="soldout-badge">SIN STOCK</div>`}
    </div>

    <div class="content">
      <h3 style="margin:4px 0 6px">${item.name}</h3>
      ${item.description ? `<div class="muted">${item.description}</div>` : ""}

      <div class="row">
        <span class="price">${money(item.price)}</span>
        <button class="btn addBtn" ${ok?"":"disabled"}>Agregar</button>
      </div>
    </div>
  `;

  const btn = card.querySelector(".addBtn");

  // === DRINKS ===
  if(item.category === "drink"){
    btn.onclick = ()=>{
      if(!isAvailable(item.id)) return;
      if(!cart.drink[item.id]) cart.drink[item.id] = { qty: 0, item };
      cart.drink[item.id].qty++;
      renderCart();
    };
  }

  // === SIDES ===
  else if(item.category === "guarniciones" || item.category === "side"){
    btn.onclick = ()=>{
      if(!isAvailable(item.id)) return;
      if(!cart.side[item.id]) cart.side[item.id] = { qty: 0, item };
      cart.side[item.id].qty++;
      renderCart();
    };
  }

  // === BURGERS ===
  else {
    btn.onclick = ()=> openCustomize(item, null, "add");
  }

  return card;
}

/* ============================================================
      üî• FIRESTORE ‚Üí CARGAR PRODUCTOS Y MONTAR MEN√ö
============================================================ */
db.collection("products").onSnapshot(snap=>{
  PRODUCTS = { burgers: [], drinks: [], sides: [] };

  snap.forEach(doc=>{
    const d = doc.data();
    if(!d.category) return;

    const item = {
      id: doc.id,
      name: d.name || "",
      price: d.price || 0,
      img: d.img || FALLBACK_IMG,
      description: d.description || "",
      category: d.category,
      kind: d.kind || "simple"
    };

    if(d.category === "burger" || d.category === "hamburguesas")
      PRODUCTS.burgers.push(item);

    if(d.category === "drink" || d.category === "bebidas")
      PRODUCTS.drinks.push(item);

    if(d.category === "guarniciones" || d.category === "side")
      PRODUCTS.sides.push(item);
  });

  mountMenu();
});

/* ============================================================
      üî• ORDENAR + RENDER COMPLETO
============================================================ */
function mountMenu(){
  elBurgersGrid.innerHTML = "";
  elDrinksGrid.innerHTML  = "";
  elSidesGrid.innerHTML   = "";

  const B = orderedList("hamburguesas", PRODUCTS.burgers);
  const D = orderedList("bebidas", PRODUCTS.drinks);
  const S = orderedList("guarniciones", PRODUCTS.sides);

  B.forEach(x=> elBurgersGrid.appendChild(renderCard(x)));
  D.forEach(x=> elDrinksGrid.appendChild(renderCard(x)));
  S.forEach(x=> elSidesGrid.appendChild(renderCard(x)));

  refreshAvailabilityUI();
}

/* ============================================================
      üî• REFRESCAR DISPONIBILIDAD
============================================================ */
function refreshAvailabilityUI(){
  document.querySelectorAll('.card[data-id]').forEach(card=>{
    const id = card.dataset.id;
    const ok = isAvailable(id);

    card.dataset.soldout = ok ? "0" : "1";

    const btn = card.querySelector(".addBtn");
    if(btn){
      btn.disabled = !ok;
      btn.classList.toggle("disabled", !ok);
    }

    let badge = card.querySelector(".soldout-badge");

    if(!ok){
      if(!badge){
        badge = document.createElement("div");
        badge.className = "soldout-badge";
        badge.textContent = "SIN STOCK";
        card.querySelector(".imgwrap").appendChild(badge);
      }
    } else {
      if(badge) badge.remove();
    }
  });
}

/* ============================================================
      üî• CARRITO
============================================================ */
let cart = { burger:{}, drink:{}, side:{} };

function saveCart(){
  try { localStorage.setItem("rb_cart_mostrador", JSON.stringify(cart)); }
  catch(e){}
}

function loadCart(){
  try {
    const x = JSON.parse(localStorage.getItem("rb_cart_mostrador"));
    if(x) cart = x;
  } catch(e){}
}
loadCart();

/* ============================================================
      üî• RENDER DEL CARRITO
============================================================ */
function renderCart(){
  saveCart();

  const wrap = $("#cartItems");
  const totalEl = $("#cartTotal");

  let html = "";
  let total = 0;

  const addLine = (name, qty, unit, extrasTxt="")=>{
    const line = qty * unit;
    total += line;

    html += `
      <div class="row" style="justify-content:space-between;align-items:flex-start;margin-bottom:10px">
        <div>
          <strong>${qty}√ó ${name}</strong><br>
          ${extrasTxt ? `<span class="muted" style="font-size:13px">${extrasTxt}</span>` : ""}
        </div>
        <div>${money(line)}</div>
      </div>
    `;
  };

  /* === BURGERS === */
  for(const id in cart.burger){
    const b = cart.burger[id];
    const item = b.item;
    if(!item) continue;

    let unit = item.price +
      (b.extras?.patty||0)*EXTRA_PRICE_PATTY +
      (b.extras?.cheddar||0)*EXTRA_PRICE_CHEDDAR;

    const extras = [];
    if(b.fries) extras.push("Papas: "+b.friesName);
    if(b.extras?.patty) extras.push(`+${b.extras.patty} med`);
    if(b.extras?.cheddar) extras.push(`+${b.extras.cheddar} cheddar`);
    if(b.notes) extras.push("Nota: "+b.notes);

    addLine(item.name, b.qty, unit, extras.join(" ¬∑ "));
  }

  /* === DRINKS === */
  for(const id in cart.drink){
    const d = cart.drink[id];
    if(!d.item) continue;
    addLine(d.item.name, d.qty, d.item.price);
  }

  /* === SIDES === */
  for(const id in cart.side){
    const s = cart.side[id];
    if(!s.item) continue;
    addLine(s.item.name, s.qty, s.item.price);
  }

  wrap.innerHTML = html || "<span class='muted'>Sin √≠tems.</span>";
  totalEl.textContent = money(total);
}
</script>
<script>
/* ============================================================
   üî• CONFIG HORARIOS MOSTRADOR (ILIMITADOS)
============================================================ */
const OPEN_TIME_MOSTRADOR  = "12:00"; // apertura
const CLOSE_TIME_MOSTRADOR = "02:00"; // cierre siguiente d√≠a
const INTERVAL_MIN = 10;              // intervalos de 10 min
const MINUTES_AHEAD = 2;              // evita horarios pasados

let visibleSlots = [];
let currentSlotIndex = 0;

/* ============================
      Helpers de tiempo
============================ */
function parseHHMM(s){
  const [h,m] = s.split(":").map(Number);
  return {h,m};
}

function dateTodayAt(hhmm){
  const {h,m} = parseHHMM(hhmm);
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0, 0);
}

function dateTomorrowAt(hhmm){
  const {h,m} = parseHHMM(hhmm);
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, h, m, 0, 0);
}

function slotPretty(d){
  return d.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
}

/* ============================================================
   üî• GENERAR SLOTS (ILIMITADOS)
============================================================ */
function generateAllSlots(){

  const now = new Date();

  const open = dateTodayAt(OPEN_TIME_MOSTRADOR);
  const close = CLOSE_TIME_MOSTRADOR.startsWith("0")
                ? dateTomorrowAt(CLOSE_TIME_MOSTRADOR)
                : dateTodayAt(CLOSE_TIME_MOSTRADOR);

  let cur = new Date(open.getTime());
  const slots = [];

  while(cur.getTime() <= close.getTime()){
    if(cur.getTime() >= now.getTime() + MINUTES_AHEAD*60000){
      slots.push(new Date(cur.getTime()));
    }
    cur = new Date(cur.getTime() + INTERVAL_MIN*60000);
  }

  return slots;
}

/* ============================================================
   üî• RENDERIZAR CARRUSEL
============================================================ */
function refreshSlotsUI(){
  visibleSlots = generateAllSlots();

  if(visibleSlots.length === 0){
    $("#slotLabel").textContent = "Sin horarios";
    $("#slotPrev").classList.add("disabled");
    $("#slotNext").classList.add("disabled");
    return;
  }

  if(currentSlotIndex >= visibleSlots.length) currentSlotIndex = visibleSlots.length - 1;
  if(currentSlotIndex < 0) currentSlotIndex = 0;

  renderSlot();
}

function renderSlot(){
  if(visibleSlots.length === 0){
    $("#slotLabel").textContent = "Sin horarios";
    return;
  }

  const d = visibleSlots[currentSlotIndex];
  $("#slotLabel").textContent = slotPretty(d);

  // flechas
  if(currentSlotIndex === 0) $("#slotPrev").classList.add("disabled");
  else $("#slotPrev").classList.remove("disabled");

  if(currentSlotIndex === visibleSlots.length - 1) $("#slotNext").classList.add("disabled");
  else $("#slotNext").classList.remove("disabled");

  // guardar selecci√≥n (para applySlot)
  window.selectedSlot = {
    iso: d.toISOString(),
    pretty: slotPretty(d)
  };
}

/* ============================================================
   üî• FLECHAS
============================================================ */
$("#slotPrev").onclick = ()=>{
  if(currentSlotIndex > 0){
    currentSlotIndex--;
    renderSlot();
  }
};

$("#slotNext").onclick = ()=>{
  if(currentSlotIndex < visibleSlots.length - 1){
    currentSlotIndex++;
    renderSlot();
  }
};

/* ============================================================
   üî• ACTUALIZAR AUTOM√ÅTICO CADA 30s
============================================================ */
setInterval(()=> refreshSlotsUI(), 30000);

/* ============================================================
   üî• ABRIR / CERRAR MODAL
============================================================ */
$("#btnSelectHora").onclick = ()=>{
  refreshSlotsUI();
  $("#overlaySlots").style.display = "flex";
};

$("#closeSlots").onclick = ()=>{
  $("#overlaySlots").style.display = "none";
};

/* ============================================================
   üî• ELEGIR HORARIO (bot√≥n aplicar)
============================================================ */
$("#applySlot").onclick = ()=>{
  if(!window.selectedSlot){
    alert("Eleg√≠ un horario");
    return;
  }

  // actualizar mini slot del carrito
  $("#miniSlot").textContent = window.selectedSlot.pretty;
  $("#miniSlotSub").textContent = "Seleccionado: " + window.selectedSlot.pretty;

  $("#overlaySlots").style.display = "none";
};

/* ============================================================
   üî• INICIALIZACI√ìN
============================================================ */
window.addEventListener("DOMContentLoaded", ()=>{
  refreshSlotsUI();
});
</script>
