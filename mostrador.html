<!doctype html>
<html lang="es">
  <script>
  /* ======== SESI√ìN COMPARTIDA (igual que en tu app) ======== */
  const TTL_HOURS = 20;
  const TTL_MS    = TTL_HOURS * 60 * 60 * 1000;
  function sessionValid(){ const ok = localStorage.getItem('rb_admin_ok') === 'true'; const ts = Number(localStorage.getItem('rb_admin_t') || 0); return ok && (Date.now() - ts) < TTL_MS; }
  function bumpSession(){ if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now())); }
  function logout(){ localStorage.removeItem('rb_admin_ok'); localStorage.removeItem('rb_admin_t'); localStorage.removeItem('rb_auth_v2'); sessionStorage.removeItem('rb_auth_v2'); location.replace('login.html'); }
  (function requireSession(){ if (!sessionValid()){ const next = encodeURIComponent((location.pathname.replace(/^\//,'') || 'pedido_local.html') + (location.search || '') + (location.hash || '')); location.replace('login.html?next=' + next); } else { bumpSession(); } })();
  ['click','keydown','focus','mousemove','touchstart','scroll'].forEach(evt=>{ window.addEventListener(evt, bumpSession, {passive:true}); });
  </script>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    /* tu CSS (deja el tuyo completo) */
    :root{ --primary:#645E52; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10); --radius:18px; }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .side-pill.off{opacity:.5}
    /* ... resto de tus estilos ... */
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn" href="pedido_local.html" title="Ver pedidos">üì¶ Pedidos</a>
      <a class="btn" href="finanzas.html" title="Ver finanzas">üìà Finanzas</a>
      <a class="btn" href="admin.html" title="Panel admin">‚öôÔ∏è Admin</a>
      <strong>Mostrador</strong>
    </div>
  </header>

  <main class="container">
    <section>
      <h1>Men√∫</h1>
      <h2>Hamburguesas</h2>
      <div id="burgersGrid" class="grid"></div>
      <h2 style="margin-top:20px">Bebidas</h2>
      <div id="drinksGrid" class="grid"></div>
    </section>

    <aside class="side">
      <h3>Carrito</h3>
      <div class="total"><span>Total</span><span id="cartTotal">$0</span></div>
      <div id="cartItems" class="muted" style="margin-bottom:8px">Sin √≠tems.</div>

      <div class="field"><input id="inpNombre" type="text" placeholder="Nombre (requerido)"></div>
      <div class="field"><input id="inpTel" type="tel" placeholder="Tel√©fono (opcional)"></div>
      <div class="field">
        <select id="selPago">
          <option value="efectivo">Efectivo</option>
          <option value="mercado_pago">Mercado Pago</option>
          <option value="debito">D√©bito</option>
          <option value="transferencia">Transferencia</option>
        </select>
      </div>
      <div class="field"><textarea id="inpComentario" placeholder="Comentario"></textarea></div>

      <button id="btnPagar" class="btn primary" style="width:100%;margin-top:10px">Pagar</button>
    </aside>
  </main>

  <!-- Modal Personalizar -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="modTitle">Personalizar</h3>

      <div class="rowx" style="align-items:flex-start;flex-direction:column">
        <div class="muted" style="font-weight:600">Papas (obligatorio)</div>
        <div class="pills" id="friesOptions">
          <label class="pill"><input type="radio" name="fries" value="con_sazon"> Con saz√≥n</label>
          <label class="pill"><input type="radio" name="fries" value="con_sal"> Con sal</label>
          <label class="pill"><input type="radio" name="fries" value="sin_sal"> Sin sal</label>
        </div>
        <div id="friesStateNote" class="micro"></div>
      </div>

      <div class="rowx" id="rowPatties" style="display:none">
        <div>Medallones extra</div>
        <div class="qtybox">
          <button id="patDec">-</button>
          <span id="patVal">0</span>
          <button id="patInc">+</button>
        </div>
      </div>

      <div class="rowx" id="rowCheddar" style="display:none">
        <div>Fetas de cheddar extra</div>
        <div class="qtybox">
          <button id="cheDec">-</button>
          <span id="cheVal">0</span>
          <button id="cheInc">+</button>
        </div>
      </div>

      <div class="rowx" id="rowPreview" style="justify-content:flex-end">
        <span class="muted">Subtotal unitario:</span>
        <span class="preview" id="unitPreview">$0</span>
      </div>

      <div class="rowx" style="align-items:flex-start;flex-direction:column">
        <label style="font-weight:600">Notas (opcional)</label>
        <textarea id="notes" class="textarea" maxlength="200" placeholder="Sin cebolla, extra salsa, etc." oninput="autoGrow(this); updateCount(this)"></textarea>
        <div class="field-foot"><span id="notesCount">0/200</span></div>
      </div>

      <div class="rowx" style="justify-content:flex-end">
        <button class="btn ghost" id="btnCancel">Cancelar</button>
        <button class="btn primary" id="btnAdd">Agregar al carrito</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  const db = firebase.firestore();

  const $=s=>document.querySelector(s);
  const money = n=>(Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  const FALLBACK_IMG="images/logo.png";

  const EXTRA_PRICE_PATTY=2400, EXTRA_PRICE_CHEDDAR=300;
  const BURGERS=[ /* copia tus burgers aqu√≠ igual que en index */ 
    { id:"cheese_simple", name:"Cheeseburger Simple", price:10100,  img:"images/cheeseburger simple.jpg", kind:"simple", desc:"Medall√≥n con doble cheddar. Incluye papas." },
    { id:"cheese_doble",  name:"Cheeseburger Doble",  price:12500, img:"images/cheeseburger doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar. Incluye papas." },
    { id:"cheesebacon_simple", name:"CheeseBacon Simple", price:10600, img:"images/CheeseBacon Simple.jpg", kind:"simple", desc:"Medall√≥n con doble cheddar y bacon. Incluye papas." },
    { id:"cheesebacon_doble",  name:"CheeseBacon Doble",  price:13100, img:"images/CheeseBacon Doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar y bacon. Incluye papas." },
    { id:"morgan_simple", name:"Morgan Simple", price:11500, img:"images/Morgan Simple.jpg", kind:"simple", desc:"Doble cheddar, bacon, barbacoa y crispy onion. Incluye papas." },
    { id:"morgan_doble",  name:"Morgan Doble",  price:14200, img:"images/Morgan Doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar, bacon, barbacoa y crispy onion. Incluye papas." },
    { id:"bigjohn_simple", name:"Big John Simple", price:11500, img:"images/Big John Simple.jpg", kind:"simple", desc:"Medall√≥n con cheddar, lechuga, pepinillos y salsa Big Mac. Incluye papas." },
    { id:"bigjohn_doble",  name:"Big John Doble",  price:13800, img:"images/Big John Doble.jpg",  kind:"double", desc:"Doble medall√≥n con cheddar, lechuga, pepinillos y salsa Big Mac. Incluye papas." },
    { id:"rhodes_simple", name:"Rhodes Simple", price:11900, img:"images/Rhodes Simple.jpg", kind:"simple", desc:"Doble cheddar, bacon, morrones, cebolla y salsa spicy. Incluye papas." },
    { id:"rhodes_doble",  name:"Rhodes Doble",  price:14500, img:"images/Rhodes Doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar, bacon, morrones, cebolla y salsa spicy. Incluye papas." },
    { id:"burguesa_simple", name:"Burguesa Simple", price:11900, img:"images/Burguesa Simple.jpg", kind:"simple", desc:"Medall√≥n con doble cheddar, mostaza y miel, cebolla caramelizada. Incluye papas." },
    { id:"burguesa_doble",  name:"Burguesa Doble",  price:14500, img:"images/Burguesa Doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar, mostaza y miel, cebolla caramelizada. Incluye papas." },
    { id:"pollo_crispy", name:"Pollo Crispy", price:9100, img:"images/Pollo crispy.jpg", kind:"chicken", desc:"Pechuga crispy con lechuga y mayo. Incluye papas." }
  ];
  const DRINKS=[ /* copia tus drinks */ ];

  /* ===== Disponibilidad (prod) ===== (igual que antes) */
  const availability = new Map();
  const isAvailable = id => availability.has(id) ? !!availability.get(id) : true;
  function refreshAvailabilityUI(){ /*...*/ }
  try{
    db.collection('products').onSnapshot(snap=>{
      availability.clear();
      snap.forEach(doc=>{ const d=doc.data()||{}; availability.set(doc.id, d.available !== false); });
      refreshAvailabilityUI();
    });
  }catch(e){ console.warn(e); }

  /* ===== Carrito & UI ===== */
  const gridBurgers=$("#burgersGrid"), gridDrinks=$("#drinksGrid");
  const cartItems=$("#cartItems"), cartTotal=$("#cartTotal");
  let cart = { burger:{}, drink:{} };

  function calcTotal(){ /* mismo c√°lculo que ten√≠as */ 
    let t=0;
    for(const b of Object.values(cart.burger)){
      const base=(b.item?.price||0),
            ep=(b.extras?.patty||0)*EXTRA_PRICE_PATTY,
            ec=(b.extras?.cheddar||0)*EXTRA_PRICE_CHEDDAR;
      t+=(base+ep+ec)*(b.qty||0);
    }
    for(const d of Object.values(cart.drink)){ t+=(d.item?.price||0)*(d.qty||0); }
    return t;
  }

  function renderCard(item,type){
    const ok = isAvailable(item.id);
    const card=document.createElement("div"); card.className="card"; card.setAttribute('data-id', item.id); card.setAttribute('data-soldout', ok ? '0' : '1');
    card.innerHTML=`
      <div class="imgwrap">
        <img src="${encodeURI(item.img)}" alt="${item.name}" onerror="this.onerror=null;this.src='${FALLBACK_IMG}'">
        ${ok? '' : '<div class="soldout-badge">SIN STOCK</div>'}
      </div>
      <div class="content">
        <h3 style="margin:4px 0 6px">${item.name}</h3>
        ${item.desc?`<div class="muted">${item.desc}</div>`:""}
        <div class="row">
          <span class="price">${money(item.price)}</span>
          <div class="actions">
            <button class="btn" data-add ${ok?'':'disabled'}>Agregar</button>
          </div>
        </div>
      </div>`;
    const addBtn = card.querySelector("[data-add]");
    if(type==="drink"){
      addBtn.onclick=()=>{ if(!isAvailable(item.id)) return; const b=cart.drink; if(!b[item.id]) b[item.id]={qty:0,item}; b[item.id].qty+=1; renderCart(); };
    }else{
      addBtn.onclick=()=>{ if(!isAvailable(item.id)) return; openCustomize(item); };
    }
    return card;
  }

  function mount(){
    burgersGrid.innerHTML=""; BURGERS.forEach(b=>burgersGrid.appendChild(renderCard(b,"burger")));
    drinksGrid.innerHTML="";  DRINKS.forEach(d=>drinksGrid.appendChild(renderCard(d,"drink")));
    renderCart(); refreshAvailabilityUI();
  }

  // ===== SIDES CONFIG (nueva parte para mostrador) =====
  let SIDES_STATE = { con_sazon:true, con_sal:true, sin_sal:true };
  function applySidesToUI(){
    // deshabilitamos radios (en modal) y mostramos nota
    const radios = document.querySelectorAll('input[name="fries"]');
    radios.forEach(r=>{
      const enabled = SIDES_STATE[r.value] !== false;
      r.disabled = !enabled;
      const label = r.closest('label');
      if(label) label.classList.toggle('disabled', !enabled);
    });
    const note = document.getElementById('friesStateNote');
    const disabledList = Object.entries(SIDES_STATE).filter(([k,v])=>v===false).map(([k])=>k);
    if(disabledList.length){
      note.innerHTML = 'Variantes deshabilitadas: ' + disabledList.map(k=>{
        if(k==='con_sazon') return 'Con saz√≥n';
        if(k==='con_sal') return 'Con sal';
        if(k==='sin_sal') return 'Sin sal';
        return k;
      }).join(', ');
      note.classList.add('side-disabled-note');
    } else {
      note.innerHTML = '';
      note.classList.remove('side-disabled-note');
    }
  }
  try{
    db.collection('config').doc('sides').onSnapshot(snap=>{
      const d = snap.exists ? (snap.data()||{}) : {};
      SIDES_STATE = { con_sazon: d.con_sazon !== false, con_sal: d.con_sal !== false, sin_sal: d.sin_sal !== false };
      applySidesToUI();
    }, e=>{ console.warn('sides err', e); applySidesToUI(); });
  }catch(e){ console.warn(e); applySidesToUI(); }

  // ===== Modal & add logic (igual que antes) =====
  const overlay=$("#overlay"),modTitle=$("#modTitle");
  const rowPatties=$("#rowPatties"),rowCheddar=$("#rowCheddar");
  const patVal=$("#patVal"),patInc=$("#patInc"),patDec=$("#patDec");
  const cheVal=$("#cheVal"),cheInc=$("#cheInc"),cheDec=$("#cheDec");
  const unitPreview=$("#unitPreview");
  const notes=$("#notes"),btnAdd=$("#btnAdd"),btnCancel=$("#btnCancel");
  let currentItem=null;

  function unitPricePreview(base){
    const pat = (+patVal.textContent||0) * EXTRA_PRICE_PATTY;
    const che = (+cheVal.textContent||0) * EXTRA_PRICE_CHEDDAR;
    unitPreview.textContent = money(base + pat + che);
  }

  function resetFries(){ document.querySelectorAll('input[name="fries"]').forEach(r=>r.checked=false); }
  function openCustomize(item){
    if(!isAvailable(item.id)) return;
    currentItem=item; modTitle.textContent="Personalizar: "+item.name;
    notes.value=""; autoGrow(notes); updateCount(notes);
    resetFries(); patVal.textContent="0"; cheVal.textContent="0";
    if(item.kind==="double"){ rowPatties.style.display="flex"; rowCheddar.style.display="flex"; }
    else if(item.kind==="chicken"){ rowPatties.style.display="none"; rowCheddar.style.display="flex"; }
    else{ rowPatties.style.display="none"; rowCheddar.style.display="none"; }
    unitPricePreview(item.price);
    applySidesToUI();
    overlay.classList.add("open");
  }
  btnCancel.onclick=()=> overlay.classList.remove("open");
  patInc.onclick=()=>{const v=+patVal.textContent||0;if(v<2)patVal.textContent=v+1; if(currentItem) unitPricePreview(currentItem.price);};
  patDec.onclick=()=>{const v=+patVal.textContent||0;if(v>0)patVal.textContent=v-1; if(currentItem) unitPricePreview(currentItem.price);};
  cheInc.onclick=()=>{const v=+cheVal.textContent||0;if(v<3)cheVal.textContent=v+1; if(currentItem) unitPricePreview(currentItem.price);};
  cheDec.onclick=()=>{const v=+cheVal.textContent||0;if(v>0)cheVal.textContent=v-1; if(currentItem) unitPricePreview(currentItem.price);};

  function autoGrow(el){ el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
  function updateCount(el){ const c=document.getElementById('notesCount'); if(c) c.textContent=`${el.value.length}/${el.maxLength||200}`; }

  btnAdd.onclick=()=>{
    if(!currentItem) return;
    const friesEl=document.querySelector('input[name="fries"]:checked');
    if(!friesEl){ alert("Eleg√≠ el tipo de papas."); return; }
    if(!SIDES_STATE[friesEl.value]){ alert("La variante seleccionada no est√° disponible. Eleg√≠ otra."); return; }
    const extras={patty:0,cheddar:0,EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY,EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR};
    if(currentItem.kind==="double"){ extras.patty=+patVal.textContent||0; extras.cheddar=+cheVal.textContent||0; }
    else if(currentItem.kind==="chicken"){ extras.cheddar=+cheVal.textContent||0; }
    const bucket=cart.burger; const prev=bucket[currentItem.id];
    if(prev){
      prev.qty+=1;
      prev.extras={ patty:Math.max(prev.extras?.patty||0, extras.patty), cheddar:Math.max(prev.extras?.cheddar||0, extras.cheddar), EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY, EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR };
      prev.fries=friesEl.value; const t=notes.value.trim(); if(t) prev.notes=t;
    }else{
      bucket[currentItem.id]={qty:1,item:currentItem,fries:friesEl.value,extras, ...(notes.value.trim()?{notes:notes.value.trim()}:{})};
    }
    overlay.classList.remove("open"); renderCart();
  };

  function renderCart(){
    const parts=[];
    for(const obj of Object.values(cart.burger)){
      const unit=obj.item.price+(obj.extras?.patty||0)*EXTRA_PRICE_PATTY+(obj.extras?.cheddar||0)*EXTRA_PRICE_CHEDDAR;
      const extras=[]; if(obj.extras?.patty) extras.push(`+${obj.extras.patty} medall√≥n`); if(obj.extras?.cheddar) extras.push(`+${obj.extras.cheddar} cheddar`);
      const friesLabel = obj.fries==="con_sazon" ? "Con saz√≥n" : (obj.fries==="con_sal" ? "Con sal" : (obj.fries==="sin_sal" ? "Sin sal" : "‚Äî"));
      parts.push(`<div class="item">
        <div>
          <strong>${obj.item.name}</strong>
          <div class="muted">Papas: ${friesLabel}</div>
          ${extras.length?`<div class="muted">${extras.join(" ¬∑ ")}</div>`:""}
          ${obj.notes?`<div class="muted">Nota: ${obj.notes}</div>`:""}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn" onclick="changeQty('burger','${obj.item.id}',-1)">-</button>
          <span>${obj.qty}</span>
          <button class="qtybtn" onclick="changeQty('burger','${obj.item.id}',1)">+</button>
          <span>${money(unit*(obj.qty||0))}</span>
        </div>
      </div>`);
    }
    for(const obj of Object.values(cart.drink)){
      parts.push(`<div class="item">
        <div><strong>${obj.item.name}</strong></div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn" onclick="changeQty('drink','${obj.item.id}',-1)">-</button>
          <span>${obj.qty}</span>
          <button class="qtybtn" onclick="changeQty('drink','${obj.item.id}',1)">+</button>
          <span>${money((obj.item.price||0)*(obj.qty||0))}</span>
        </div>
      </div>`);
    }
    cartItems.innerHTML = parts.length ? parts.join("") : "Sin √≠tems.";
    cartTotal.textContent = money(calcTotal());
  }
  window.changeQty=function(type,id,delta){
    const bucket=cart[type]; if(!bucket) return;
    const cur=bucket[id]?.qty||0, next=Math.max(0,cur+delta);
    if(next===0) delete bucket[id]; else bucket[id].qty=next;
    renderCart();
  }

  // Pagar: mantiene tu flujo original (continuidad del n√∫mero de pedido con contador global)
  async function nextOrderNumber(){
    return await db.runTransaction(async tx=>{
      const ref = db.collection('counters').doc('orders_global');
      const snap = await tx.get(ref);
      const cur = snap.exists ? (Number(snap.data().seq)||0) : 0;
      const nxt = cur + 1;
      tx.set(ref, { seq: nxt, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      return nxt;
    });
  }

  document.getElementById("btnPagar").onclick = async ()=>{
    try{
      const hasItems = Object.keys(cart.burger).length || Object.keys(cart.drink).length;
      if(!hasItems){ alert("Agreg√° al menos un producto."); return; }
      const nombreRaw = ($("#inpNombre").value||"").trim(); if(!nombreRaw){ alert("Ingres√° el nombre."); return; }
      const nombre = `${nombreRaw} (mostrador)`;
      const telefono = ($("#inpTel").value||"").trim();
      const pago = $("#selPago").value;
      const comentario = ($("#inpComentario").value||"").trim();

      const items=[]; for(const o of Object.values(cart.burger)){ items.push({id:o.item.id,name:o.item.name,price:o.item.price,qty:o.qty,fries:o.fries,notes:o.notes||'',extras:{patty:o.extras?.patty||0,cheddar:o.extras?.cheddar||0,EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY,EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR}}); }
      for(const o of Object.values(cart.drink)){ items.push({id:o.item.id,name:o.item.name,price:o.item.price,qty:o.qty,extras:{},fries:'',notes:''}); }

      const total = calcTotal();
      const orderNumber = await nextOrderNumber();

      const payload = {
        orderNumber, number: orderNumber, nombre, telefono, pago, comment: comentario,
        items, total, status:"accepted", payment_status:"paid",
        source:"mostrador", createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const ref = await db.collection("orders").add(payload);

      const pubId = ref.id.slice(0,22);
      await db.collection('order_public').doc(pubId).set({
        orderId: ref.id, orderNumber, status:'accepted',
        entrega:'retira', pago, nombre,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});

      cart={burger:{},drink:{}}; renderCart();
      $("#inpNombre").value=""; $("#inpTel").value=""; $("#inpComentario").value="";
      alert(`Pedido #${orderNumber} cargado`);
    }catch(e){ console.error(e); alert("No se pudo registrar el pedido."); }
  };

  // inicio
  mount();
  </script>
</body>
</html>
