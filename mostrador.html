<!doctype html> 
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <script>
  /* ======== SESI√ìN COMPARTIDA (mismo esquema que login.html) ======== */
  const TTL_HOURS = 20;
  const TTL_MS    = TTL_HOURS * 60 * 60 * 1000;

  function sessionValid(){
    const ok = localStorage.getItem('rb_admin_ok') === 'true';
    const ts = Number(localStorage.getItem('rb_admin_t') || 0);
    return ok && (Date.now() - ts) < TTL_MS;
  }
  function bumpSession(){  // renueva TTL con actividad
    if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
  }
  function logout(){
    localStorage.removeItem('rb_admin_ok');
    localStorage.removeItem('rb_admin_t');
    localStorage.removeItem('rb_auth_v2');
    sessionStorage.removeItem('rb_auth_v2');
    location.replace('login.html'); // <-- p√°gina de login
  }

  // Requerir sesi√≥n en p√°ginas internas
  (function requireSession(){
    if (!sessionValid()){
      const next = encodeURIComponent(
        (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
        (location.search || '') + (location.hash || '')
      );
      location.replace('login.html?next=' + next); // <-- login con ?next=
    } else {
      bumpSession();
    }
  })();

  // Mantener viva la sesi√≥n mientras se usa
  ['click','keydown','focus','mousemove','touchstart','scroll'].forEach(evt=>{
    window.addEventListener(evt, bumpSession, {passive:true});
  });
  </script>

  <style>
    :root{
      --primary:#645E52; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:800}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700;text-decoration:none;color:inherit}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.ghost{background:#fff}
    .btn:disabled,.btn.disabled{opacity:.55;cursor:not-allowed}

    .container{max-width:1200px;margin:20px auto;padding:0 12px;display:grid;grid-template-columns:1fr 380px;gap:18px}
    @media (max-width:980px){ .container{grid-template-columns:1fr} }

    h1{font-size:26px;margin:8px 0 12px}
    h2{font-size:20px;margin:18px 4px 10px}

    .grid{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:16px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column; position:relative}
    .card .imgwrap{ position:relative; }
    .card img{width:100%;height:200px;object-fit:cover;background:#eee}
    .content{padding:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px}
    .price{font-weight:800}
    .actions{display:flex;gap:8px;flex-wrap:wrap}

    .side{background:var(--card);border-radius:20px;box-shadow:var(--shadow);padding:14px;position:sticky;top:82px;height:fit-content}
    .side h3{margin:0 0 8px}
    .total{display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:18px;margin:8px 0 10px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid #efefef}
    .muted{color:var(--muted);font-size:13px}
    .qtybtn{border:1px solid var(--ring);background:#fff;border-radius:10px;padding:4px 8px;font-weight:800;cursor:pointer}
    .field{margin-top:8px}
    .field input,.field select,.field textarea{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    textarea{min-height:84px;border-radius:12px;resize:vertical}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.32);display:none;align-items:center;justify-content:center;z-index:40}
    .overlay.open{display:flex}
    .modal{background:#fff;border-radius:20px;box-shadow:var(--shadow);width:520px;max-width:92vw;padding:16px}
    .rowx{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:12px 0}
    .qtybox{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px}
    .qtybox button{width:28px;height:28px;border:1px solid var(--ring);background:#fff;border-radius:999px;font-weight:900;cursor:pointer}
    .pills{display:flex;flex-direction:column;gap:8px}
    .pill{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--ring);border-radius:12px;padding:10px 12px;cursor:pointer}
    .pill input{accent-color:var(--primary)}
    .pill.disabled{opacity:.55; pointer-events:none}
    .micro{font-size:12px;color:var(--muted)}

    /* Disponibilidad */
    .card[data-soldout="1"]{ opacity:.55; }
    .soldout-badge{
      position:absolute; top:10px; left:10px; z-index:2;
      background:#222; color:#fff; font-weight:800; font-size:12px;
      padding:6px 8px; border-radius:999px; letter-spacing:.3px;
    }

    /* === Notas (mejoradas) === */
    .textarea {
      width: 100%;
      min-height: 56px;
      max-height: 200px;
      padding: 12px 14px;
      border: 1px solid var(--ring);
      border-radius: 14px;
      background: #faf9f7;
      resize: none;
      font-size: 15px;
      line-height: 1.35;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .textarea::placeholder { color:#9a9a9a; }
    .textarea:focus {
      outline: 0;
      background:#fff;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(98,90,69,.18);
    }
    .field-foot { display:flex; justify-content:flex-end; margin-top:6px; font-size:12px; color:#8a8a8a; }
    .preview{font-weight:800}
    .side-disabled-note{ color:#b33; font-size:13px; margin-top:6px }

    /* Pickup selector */
    .pickup-row{display:flex;align-items:center;gap:8px;margin-top:10px}
    .pickup-arrow{width:42px;height:42px;border-radius:10px;border:1px solid var(--ring);display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:800;background:#fff}
    .pickup-arrow.disabled{opacity:.5;cursor:not-allowed}
    .pickup-time{min-width:120px;height:42px;border-radius:12px;border:1px solid var(--ring);display:flex;align-items:center;justify-content:center;font-weight:900;background:#fff;cursor:default}
    .pickup-time.disabled{opacity:.5}
    .pickup-mini{width:36px;height:36px;border-radius:8px;border:1px solid var(--ring);display:flex;align-items:center;justify-content:center;cursor:pointer;background:#fff}
    .pickup-cap{font-weight:800;margin-left:8px}
    .pickup-desc{font-size:12px;color:var(--muted);margin-top:6px}
    .slots-list{display:flex;flex-wrap:wrap;gap:8px}
    .slot-quick{padding:8px 10px;border-radius:999px;border:1px solid var(--ring);cursor:pointer}
    .slot-quick.disabled{opacity:.5;pointer-events:none}
    .no-slots{color:#b00020;font-weight:700}

    /* Badge falta papas */
    .badge-warn{display:inline-block;background:#ffe9a8;border:1px solid #e2c460;color:#7a5b00;border-radius:999px;padding:2px 8px;font-weight:800;font-size:11px;margin-left:6px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Rhodes Burgers</a>
      <div class="spacer"></div>

      <!-- Nav -->
      <a class="btn" href="pedido_local.html" title="Ver pedidos">üì¶ Pedidos</a>
      <a class="btn" href="finanzas.html" title="Ver finanzas">üìà Finanzas</a>
      <a class="btn" href="admin.html" title="Panel admin">‚öôÔ∏è Admin</a>

      <strong>Mostrador</strong>
    </div>
  </header>

  <main class="container">
    <section>
      <h1>Men√∫</h1>
      <h2>Hamburguesas</h2>
      <div id="burgersGrid" class="grid"></div>
      <h2 style="margin-top:20px">Bebidas</h2>
      <div id="drinksGrid" class="grid"></div>
    </section>

    <aside class="side">
      <h3>Carrito</h3>
      <div class="total"><span>Total</span><span id="cartTotal">$0</span></div>
      <div id="cartItems" class="muted" style="margin-bottom:8px">Sin √≠tems.</div>

      <div class="field"><input id="inpNombre" type="text" placeholder="Nombre (requerido)"></div>
      <div class="field"><input id="inpTel" type="tel" placeholder="Tel√©fono (opcional)"></div>
      <div class="field">
        <select id="selPago">
          <option value="efectivo">Efectivo</option>
          <option value="mercado_pago">Mercado Pago</option>
          <option value="debito">D√©bito</option>
          <option value="transferencia">Transferencia</option>
        </select>
      </div>

      <!-- PICKUP selector -->
      <div style="margin-top:10px">
        <div style="font-weight:700">Horario de retiro (solo hoy)</div>
        <div class="pickup-row" id="pickupControls">
          <div id="btnPrev" class="pickup-arrow" title="Anterior">‚óÄ</div>
          <div id="pickupTime" class="pickup-time">Cargando...</div>
          <div id="btnNext" class="pickup-arrow" title="Siguiente">‚ñ∂</div>
          <div id="btnQuick" class="pickup-mini" title="Ver lista">‚ñ¶</div>
          <div id="pickupCupos" class="pickup-cap muted" style="display:none">‚Äî cupos</div>
        </div>
        <div id="pickupDesc" class="pickup-desc">Cargando turnos...</div>
      </div>

      <div class="field"><textarea id="inpComentario" placeholder="Comentario"></textarea></div>

      <!-- Bot√≥n: Imprimir y cargar -->
      <button id="btnPrintAndLoad" class="btn primary" style="width:100%;margin-top:10px">Imprimir y cargar</button>
    </aside>
  </main>

  <!-- quick list modal -->
  <div class="overlay" id="slotsOverlay">
    <div class="modal" style="width:520px;max-width:92vw">
      <h3>Elegir horario</h3>
      <div id="slotsQuickList" class="slots-list" style="margin-top:8px"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="closeSlots">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Personalizar / Editar -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <h3 id="modTitle">Personalizar</h3>

      <div class="rowx" style="align-items:flex-start;flex-direction:column">
        <div class="muted" style="font-weight:600">Papas (pod√©s elegir ahora o al final)</div>
        <div class="pills" id="friesOptions">
          <label class="pill"><span>Sazonadas</span> <input type="radio" name="fries" value="con_sazon"></label>
          <label class="pill"><span>Con sal</span>  <input type="radio" name="fries" value="con_sal"></label>
          <label class="pill"><span>Sin sal</span>  <input type="radio" name="fries" value="sin_sal"></label>
        </div>
        <div id="friesStateNote" class="micro"></div>
        <div class="micro">Si no eleg√≠s, te lo pedimos antes de cargar el pedido.</div>
      </div>

      <div class="rowx" id="rowPatties" style="display:none">
        <div>Medallones extra</div>
        <div class="qtybox">
          <button id="patDec">-</button>
          <span id="patVal">0</span>
          <button id="patInc">+</button>
        </div>
      </div>

      <div class="rowx" id="rowCheddar" style="display:none">
        <div>Fetas de cheddar extra</div>
        <div class="qtybox">
          <button id="cheDec">-</button>
          <span id="cheVal">0</span>
          <button id="cheInc">+</button>
        </div>
      </div>

      <div class="rowx" id="rowPreview" style="justify-content:flex-end">
        <span class="muted">Subtotal unitario:</span>
        <span class="preview" id="unitPreview">$0</span>
      </div>

      <div class="rowx" style="align-items:flex-start;flex-direction:column">
        <label style="font-weight:600">Notas (opcional)</label>
        <textarea id="notes" class="textarea" maxlength="200"
                  placeholder="Sin cebolla, extra salsa, etc."
                  oninput="autoGrow(this); updateCount(this)"></textarea>
        <div class="field-foot"><span id="notesCount">0/200</span></div>
      </div>

      <div class="rowx" style="justify-content:flex-end">
        <button class="btn ghost" id="btnCancel">Cancelar</button>
        <button class="btn primary" id="btnAdd">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ if(!firebase.apps.length) firebase.initializeApp(firebaseConfig); }catch(e){}
  const db = firebase.firestore();

  const $=s=>document.querySelector(s);
  const money = n=>(Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  const FALLBACK_IMG="images/logo.png";

  // ===== Men√∫ =====
  const EXTRA_PRICE_PATTY=2400, EXTRA_PRICE_CHEDDAR=300;
  const BURGERS=[
    { id:"cheese_simple", name:"Cheeseburger Simple", price:10100,  img:"images/cheeseburger simple.jpg", kind:"simple", desc:"Medall√≥n con doble cheddar. Incluye papas." },
    { id:"cheese_doble",  name:"Cheeseburger Doble",  price:12500, img:"images/cheeseburger doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar. Incluye papas." },
    { id:"cheesebacon_simple", name:"CheeseBacon Simple", price:10600, img:"images/CheeseBacon Simple.jpg", kind:"simple", desc:"Medall√≥n con doble cheddar y bacon. Incluye papas." },
    { id:"cheesebacon_doble",  name:"CheeseBacon Doble",  price:13100, img:"images/CheeseBacon Doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar y bacon. Incluye papas." },
    { id:"morgan_simple", name:"Morgan Simple", price:11500, img:"images/Morgan Simple.jpg", kind:"simple", desc:"Doble cheddar, bacon, barbacoa y crispy onion. Incluye papas." },
    { id:"morgan_doble",  name:"Morgan Doble",  price:14200, img:"images/Morgan Doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar, bacon, barbacoa y crispy onion. Incluye papas." },
    { id:"bigjohn_simple", name:"Big John Simple", price:11500, img:"images/Big John Simple.jpg", kind:"simple", desc:"Medall√≥n con cheddar, lechuga, pepinillos y salsa Big Mac. Incluye papas." },
    { id:"bigjohn_doble",  name:"Big John Doble",  price:13800, img:"images/Big John Doble.jpg",  kind:"double", desc:"Doble medall√≥n con cheddar, lechuga, pepinillos y salsa Big Mac. Incluye papas." },
    { id:"rhodes_simple", name:"Rhodes Simple", price:11900, img:"images/Rhodes Simple.jpg", kind:"simple", desc:"Doble cheddar, bacon, morrones, cebolla y salsa spicy. Incluye papas." },
    { id:"rhodes_doble",  name:"Rhodes Doble",  price:14500, img:"images/Rhodes Doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar, bacon, morrones, cebolla y salsa spicy. Incluye papas." },
    { id:"burguesa_simple", name:"Burguesa Simple", price:11900, img:"images/Burguesa Simple.jpg", kind:"simple", desc:"Medall√≥n con doble cheddar, mostaza y miel, cebolla caramelizada. Incluye papas." },
    { id:"burguesa_doble",  name:"Burguesa Doble",  price:14500, img:"images/Burguesa Doble.jpg",  kind:"double", desc:"Doble medall√≥n con doble cheddar, mostaza y miel, cebolla caramelizada. Incluye papas." },
    { id:"pollo_crispy", name:"Pollo Crispy", price:9100, img:"images/Pollo crispy.jpg", kind:"chicken", desc:"Pechuga crispy con lechuga y mayo. Incluye papas." }
  ];
  const DRINKS=[
    { id:"andes_rubia", name:"Andes Origen Rubia 473ml", price:3800, img:"images/Andes Rubia.png" },
    { id:"andes_roja",  name:"Andes Origen Roja 473ml",  price:3800, img:"images/Andes Roja.png" },
    { id:"coca_org",    name:"Coca-Cola Original 500ml", price:2500, img:"images/Coca.png" },
    { id:"coca_zero",   name:"Coca-Cola Zero 500ml",     price:2500, img:"images/Coca Zero.png" },
    { id:"sprite",      name:"Sprite 500ml",             price:2500, img:"images/Sprite.png" },
    { id:"aq_pomelo",   name:"Aquarius Pomelo 500ml",    price:2000, img:"images/Pomelo.png" },
    { id:"aq_pera",     name:"Aquarius Pera 500ml",      price:2000, img:"images/Pera.png" },
    { id:"aq_manzana",  name:"Aquarius Manzana 500ml",   price:2000, img:"images/Manzana.png" },
    { id:"agua_sg",     name:"Agua sin gas 500ml",       price:1500, img:"images/Agua.png" }
  ];

  /* ===== SIDES CONFIG ===== */
  let SIDES_STATE = { con_sazon:true, con_sal:true, sin_sal:true };
  function applySidesToUI(){
    document.querySelectorAll('#friesOptions .pill').forEach(label=>{
      const input = label.querySelector('input[name="fries"]');
      if(!input) return;
      const val = input.value;
      const enabled = SIDES_STATE[val] !== false;
      input.disabled = !enabled;
      label.classList.toggle('disabled', !enabled);
    });
    const noteEl = document.getElementById('friesStateNote');
    const disabled = Object.entries(SIDES_STATE).filter(([k,v])=>v===false).map(([k])=>k);
    if(disabled.length){
      const human = disabled.map(k => k==='con_sazon'?'Sazonadas':k==='con_sal'?'Con sal':k==='sin_sal'?'Sin sal':k).join(', ');
      noteEl.textContent = 'Variantes deshabilitadas: ' + human;
      noteEl.classList.add('side-disabled-note');
    } else {
      noteEl.textContent = '';
      noteEl.classList.remove('side-disabled-note');
    }
  }
  try{
    db.collection('config').doc('sides').onSnapshot(snap=>{
      const data = snap.exists ? (snap.data()||{}) : {};
      SIDES_STATE = {
        con_sazon: data.con_sazon !== false,
        con_sal:   data.con_sal   !== false,
        sin_sal:   data.sin_sal   !== false
      };
      applySidesToUI();
    }, err=>{
      console.warn('sides onSnapshot err', err);
      applySidesToUI();
    });
  }catch(e){
    console.warn('subscribe sides failed', e);
    applySidesToUI();
  }

  /* ===== PICKUP / SLOTS ‚Äî SIN L√çMITE DE CUPO ===== */
  const MAX_PER_SLOT   = Infinity;         // << sin tope
  const MINUTES_AHEAD  = 5;
  const OPEN_TIME      = "12:00";
  const CLOSE_TIME     = "23:59";
  const START_10       = "19:10";
  const START_20       = "19:20";

  function parseHHMM(s){ if(!s) return null; const p=s.split(':'); if(p.length<2) return null; return { h:parseInt(p[0],10), m:parseInt(p[1],10) }; }
  function pad(n){ return String(n).padStart(2,'0'); }
  function slotKeyFromDate(d){ return ''+d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+'_'+pad(d.getHours())+pad(d.getMinutes()); }
  function slotPretty(d){ return d.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false}); }
  function dateTodayAt(hhmm){ const p=parseHHMM(hhmm); const now=new Date(); return new Date(now.getFullYear(),now.getMonth(),now.getDate(),p.h,p.m,0,0); }
  function genSlots(startAt, intervalMin){
    const open = dateTodayAt(OPEN_TIME), close = dateTodayAt(CLOSE_TIME);
    const start = startAt > open ? startAt : open;
    const res = [];
    let cur = new Date(start.getTime());
    while(cur.getTime() <= close.getTime() - intervalMin*60*1000){
      res.push(new Date(cur.getTime()));
      cur = new Date(cur.getTime() + intervalMin*60*1000);
    }
    return res;
  }

  let slotListeners = [];
  let allSlots = [];       // { date, key, count, full:false, tooSoon, unsub }
  let visibleSlots = [];   // filtrados por ‚Äúdemasiado pronto‚Äù
  let currentVisibleIndex = 0;

  function clearSlotListeners(){
    allSlots.forEach(s=>{ try{ if(s.unsub) s.unsub(); }catch(e){} });
    slotListeners=[]; allSlots=[]; visibleSlots=[];
  }

  function totalBurgersInCart(){
    let s=0;
    for(const k in cart.burger) s += Number(cart.burger[k].qty||0);
    return s;
  }

  async function subscribeAndRenderSlots(){
    clearSlotListeners();

    const burgers = totalBurgersInCart();
    const interval = (burgers <= 2) ? 10 : 20;
    const startStr = (burgers <= 2) ? START_10 : START_20;
    const startAt = dateTodayAt(startStr);
    const slots = genSlots(startAt, interval);

    allSlots = slots.map(d => ({ date:d, key:slotKeyFromDate(d), count:0, full:false, tooSoon:false, unsub:null }));

    $("#pickupTime").textContent = "Cargando...";
    $("#pickupCupos").style.display = "none";
    $("#pickupDesc").textContent = `Turnos cada ${interval} minutos desde ${startStr}. Cupos: sin l√≠mite.`;

    // Suscripciones solo para info (no bloquean)
    allSlots.forEach(sObj=>{
      (function(slotObj){
        const ref = db.collection('slots').doc(slotObj.key);
        const unsub = ref.onSnapshot(snap=>{
          try{
            const count = snap.exists ? Number(snap.data().count||0) : 0;
            slotObj.count = count;
            slotObj.full  = false; // << nunca se marca full
            const now = Date.now();
            slotObj.tooSoon = (new Date(slotObj.date)).getTime() <= (now + MINUTES_AHEAD*60*1000);
            rebuildVisibleSlotsAndKeepSelection();
          }catch(e){ console.warn('slot snap err', e); }
        }, err=>console.warn('slot snap err', err));
        slotObj.unsub = unsub;
        slotListeners.push(unsub);
      })(sObj);
    });

    setTimeout(rebuildVisibleSlotsAndKeepSelection, 200);
  }

  function rebuildVisibleSlotsAndKeepSelection(){
    const timeEl = $("#pickupTime");
    const capEl  = $("#pickupCupos");

    const prevKey = (window._selectedSlot && window._selectedSlot.key) ? window._selectedSlot.key : null;
    // Filtramos SOLO ‚ÄútooSoon‚Äù, no por cupo
    visibleSlots = allSlots.filter(s=>!s.tooSoon).sort((a,b)=>a.date-b.date);

    if(visibleSlots.length===0){
      currentVisibleIndex = -1;
      timeEl.innerHTML = '<span class="no-slots">A la brevedad</span>'; // << permite seguir
      timeEl.classList.add('disabled');
      capEl.style.display='none';
      $("#btnPrev").classList.add('disabled');
      $("#btnNext").classList.add('disabled');
      window._selectedSlot = null;
      renderQuickList();
      return;
    }

    const idx = visibleSlots.findIndex(s=>s.key===prevKey);
    if(idx>=0) currentVisibleIndex = idx;
    else {
      const now = Date.now();
      const near = visibleSlots.findIndex(s=>s.date.getTime()>=now);
      currentVisibleIndex = (near>=0)?near:0;
    }

    updatePickupUI();
  }

  function updatePickupUI(){
    const timeEl = $("#pickupTime");
    const capEl  = $("#pickupCupos");
    const prevBtn = $("#btnPrev");
    const nextBtn = $("#btnNext");

    if(currentVisibleIndex<0 || currentVisibleIndex>=visibleSlots.length){
      timeEl.textContent='A la brevedad';
      timeEl.classList.add('disabled');
      capEl.style.display='none';
      prevBtn.classList.add('disabled'); nextBtn.classList.add('disabled');
      window._selectedSlot=null; renderQuickList(); return;
    }

    const s = visibleSlots[currentVisibleIndex];
    timeEl.textContent = slotPretty(s.date);
    timeEl.classList.remove('disabled');

    capEl.textContent = 'sin l√≠mite';
    capEl.style.display = 'inline';

    (currentVisibleIndex<=0) ? prevBtn.classList.add('disabled') : prevBtn.classList.remove('disabled');
    (currentVisibleIndex>=visibleSlots.length-1) ? nextBtn.classList.add('disabled') : nextBtn.classList.remove('disabled');

    window._selectedSlot = { key:s.key, iso:s.date.toISOString(), pretty:slotPretty(s.date) };

    renderQuickList();
  }

  function renderQuickList(){
    const list = $("#slotsQuickList");
    if(!list) return;
    list.innerHTML = '';
    if(!visibleSlots.length){
      const div = document.createElement('div');
      div.className='muted';
      div.textContent = 'No hay horarios visibles. Se cargar√° ‚ÄúA la brevedad‚Äù.';
      list.appendChild(div);
      return;
    }
    visibleSlots.forEach((s, i)=>{
      const btn = document.createElement('div');
      btn.className = 'slot-quick';
      btn.textContent = `${slotPretty(s.date)} ¬∑ sin l√≠mite`;
      btn.onclick = ()=>{ currentVisibleIndex = i; updatePickupUI(); $("#slotsOverlay").classList.remove('open'); };
      list.appendChild(btn);
    });
  }

  async function refreshSlotsUI(){
    try{ await subscribeAndRenderSlots(); }catch(e){ console.warn('refreshSlotsUI error', e); $("#pickupDesc").textContent='Error al cargar turnos. Pod√©s continuar: se guardar√° ‚ÄúA la brevedad‚Äù.'; }
  }

  // (Eliminado) reserveSlotTransactional/decrementSlot -> ya no se usan
  function reserveSlotTransactional(){ return Promise.resolve(true); }
  function decrementSlot(){ return Promise.resolve(); }

  function getNextOrderNumber(){
    let lastKnown = 0;
    return db.collection('orders').orderBy('orderNumber','desc').limit(1).get()
      .then(qs=>{ if(!qs.empty) lastKnown = Number(qs.docs[0].data().orderNumber)||0; })
      .then(()=> db.runTransaction(async tx=>{
        const ref = db.collection('config').doc('counters');
        const snap = await tx.get(ref);
        const cur = snap.exists ? (Number(snap.data().orderNumber)||0) : 0;
        const base = Math.max(cur,lastKnown);
        const nxt  = base+1;
        tx.set(ref,{orderNumber:nxt,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
        return nxt;
      }));
  }

  // NAV controls + abrir lista
  document.addEventListener('DOMContentLoaded', ()=>{
    const prev = $("#btnPrev"), next = $("#btnNext"), quick = $("#btnQuick");
    const closeSlots = $("#closeSlots");
    if(prev) prev.addEventListener('click', ()=>{ if(!prev.classList.contains('disabled')){ currentVisibleIndex=Math.max(0,currentVisibleIndex-1); updatePickupUI(); } });
    if(next) next.addEventListener('click', ()=>{ if(!next.classList.contains('disabled')){ currentVisibleIndex=Math.min(visibleSlots.length-1,currentVisibleIndex+1); updatePickupUI(); } });
    if(quick) quick.addEventListener('click', ()=>{ renderQuickList(); $("#slotsOverlay").classList.add('open'); });
    if(closeSlots) closeSlots.addEventListener('click', ()=>$("#slotsOverlay").classList.remove('open'));
    $("#slotsOverlay").addEventListener('click', e=>{ if(e.target === $("#slotsOverlay")) $("#slotsOverlay").classList.remove('open'); });
  });

  /* ===== Carrito & UI ===== */
  const elBurgersGrid = document.getElementById('burgersGrid');
  const elDrinksGrid  = document.getElementById('drinksGrid');
  const cartItems=$("#cartItems"), cartTotal=$("#cartTotal");

  let cart = { burger:{}, drink:{} };

  function friesName(v){
    if(!v) return "‚Äî";
    if(v === "con_sazon") return "Sazonadas";
    if(v === "con_sal") return "Con sal";
    if(v === "sin_sal") return "Sin sal";
    const s = v.toString().toLowerCase();
    if(s.includes("sazon") && !s.includes("sin")) return "Sazonadas";
    if(s.includes("sin") && (s.includes("sal")||s.includes("sazon"))) return "Sin sal";
    if(s.includes("sal")) return "Con sal";
    return v;
  }

  function calcTotal(){
    let t=0;
    for(const b of Object.values(cart.burger)){
      const base=(b.item?.price||0),
            ep=(b.extras?.patty||0)*EXTRA_PRICE_PATTY,
            ec=(b.extras?.cheddar||0)*EXTRA_PRICE_CHEDDAR;
      t+=(base+ep+ec)*(b.qty||0);
    }
    for(const d of Object.values(cart.drink)){ t+=(d.item?.price||0)*(d.qty||0); }
    return t;
  }

  // ====== RENDER CARRITO con bot√≥n EDITAR ======
  function renderCart(){
    const parts=[];
    for(const [key,obj] of Object.entries(cart.burger)){
      const unit=obj.item.price+(obj.extras?.patty||0)*EXTRA_PRICE_PATTY+(obj.extras?.cheddar||0)*EXTRA_PRICE_CHEDDAR;
      const extras=[]; if(obj.extras?.patty) extras.push(`+${obj.extras.patty} medall√≥n`); if(obj.extras?.cheddar) extras.push(`+${obj.extras.cheddar} cheddar`);
      const needsFries = !obj.fries;
      parts.push(`<div class="item">
        <div>
          <strong>${obj.item.name}</strong>
          <div class="muted">Papas: ${friesName(obj.fries)}${needsFries?'<span class="badge-warn">Elegir</span>':''}</div>
          ${extras.length?`<div class="muted">${extras.join(" ¬∑ ")}</div>`:""}
          ${obj.notes?`<div class="muted">Nota: ${obj.notes}</div>`:""}
          <button class="btn" style="margin-top:6px" onclick="editItem('burger','${encodeURIComponent(key)}')">‚úèÔ∏è Editar</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn" onclick="changeQty('burger','${encodeURIComponent(key)}',-1)">-</button>
          <span>${obj.qty}</span>
          <button class="qtybtn" onclick="changeQty('burger','${encodeURIComponent(key)}',1)">+</button>
          <span>${money(unit*(obj.qty||0))}</span>
        </div>
      </div>`);
    }
    for(const [key,obj] of Object.entries(cart.drink)){
      parts.push(`<div class="item">
        <div><strong>${obj.item.name}</strong></div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn" onclick="changeQty('drink','${encodeURIComponent(key)}',-1)">-</button>
          <span>${obj.qty}</span>
          <button class="qtybtn" onclick="changeQty('drink','${encodeURIComponent(key)}',1)">+</button>
          <span>${money((obj.item.price||0)*(obj.qty||0))}</span>
        </div>
      </div>`);
    }
    cartItems.innerHTML = parts.length ? parts.join("") : "Sin √≠tems.";
    cartTotal.textContent = money(calcTotal());

    // Al cambiar carrito, refrescamos slots (para 10'/20')
    refreshSlotsUI();
  }

  window.changeQty=function(type,encKey,delta){
    const key = decodeURIComponent(encKey);
    const bucket = cart[type];
    if(!bucket) return;
    const cur = bucket[key]?.qty || 0;
    const next = Math.max(0, cur+delta);
    if(next === 0) delete bucket[key];
    else bucket[key].qty = next;
    renderCart();
  }

  function renderCard(item,type){
    const ok = isAvailable(item.id);
    const card=document.createElement("div"); card.className="card"; card.setAttribute('data-id', item.id); card.setAttribute('data-soldout', ok ? '0' : '1');
    card.innerHTML=`
      <div class="imgwrap">
        <img src="${encodeURI(item.img)}" alt="${item.name}" onerror="this.onerror=null;this.src='${FALLBACK_IMG}'">
        ${ok? '' : '<div class="soldout-badge">SIN STOCK</div>'}
      </div>
      <div class="content">
        <h3 style="margin:4px 0 6px">${item.name}</h3>
        ${item.desc?`<div class="muted">${item.desc}</div>`:""}
        <div class="row">
          <span class="price">${money(item.price)}</span>
          <div class="actions">
            <button class="btn" data-add ${ok?'':'disabled'}>Agregar</button>
          </div>
        </div>
      </div>`;
    const addBtn = card.querySelector("[data-add]");
    if(type==="drink"){
      addBtn.onclick=()=>{ if(!isAvailable(item.id)) return; const b=cart.drink; if(!b[item.id]) b[item.id]={qty:0,item}; b[item.id].qty+=1; renderCart(); };
    }else{
      addBtn.onclick=()=>{ if(!isAvailable(item.id)) return; openCustomize(item, null); };
    }
    return card;
  }

  function mount(){
    elBurgersGrid.innerHTML="";
    BURGERS.forEach(b=>elBurgersGrid.appendChild(renderCard(b,"burger")));

    elDrinksGrid.innerHTML="";
    DRINKS.forEach(d=>elDrinksGrid.appendChild(renderCard(d,"drink")));

    renderCart(); refreshAvailabilityUI();
    applySidesToUI();

    // iniciar slots una vez montado
    refreshSlotsUI();
  }

  /* ===== Disponibilidad (productos) ===== */
  const availability = new Map();
  const isAvailable = id => availability.has(id) ? !!availability.get(id) : true;
  function refreshAvailabilityUI(){
    document.querySelectorAll('.card[data-id]').forEach(card=>{
      const id = card.getAttribute('data-id');
      const ok = isAvailable(id);
      card.setAttribute('data-soldout', ok ? '0' : '1');
      const addBtn = card.querySelector('[data-add]');
      if(addBtn){ ok ? (addBtn.removeAttribute('disabled'), addBtn.classList.remove('disabled')) : (addBtn.setAttribute('disabled',''), addBtn.classList.add('disabled')); }
      let badge = card.querySelector('.soldout-badge');
      if(!ok){
        if(!badge){ badge=document.createElement('div'); badge.className='soldout-badge'; badge.textContent='SIN STOCK'; (card.querySelector('.imgwrap')||card).appendChild(badge); }
      }else if(badge){ badge.remove(); }
    });
  }
  try{
    db.collection('products').onSnapshot(snap=>{
      availability.clear();
      snap.forEach(doc=>{ const d=doc.data()||{}; availability.set(doc.id, d.available !== false); });
      refreshAvailabilityUI();
    });
  }catch(e){ console.warn(e); }

  // ===== Modal Personalizar / Editar =====
  const overlay=$("#overlay"), modTitle=$("#modTitle");
  const rowPatties=$("#rowPatties"), rowCheddar=$("#rowCheddar");
  const patVal=$("#patVal"), patInc=$("#patInc"), patDec=$("#patDec");
  const cheVal=$("#cheVal"), cheInc=$("#cheInc"), cheDec=$("#cheDec");
  const unitPreview=$("#unitPreview");
  const notes=$("#notes"), btnAdd=$("#btnAdd"), btnCancel=$("#btnCancel");
  let currentItem=null;
  let CUSTOMIZE_MODE = 'add'; // 'add' | 'edit' | 'checkout'
  let editingKey = null;      // key del carrito cuando editamos
  let resolveCheckoutStep = null; // para el flujo "al final"

  function unitPricePreview(base){
    const pat = (+patVal.textContent||0) * EXTRA_PRICE_PATTY;
    const che = (+cheVal.textContent||0) * EXTRA_PRICE_CHEDDAR;
    unitPreview.textContent = money(base + pat + che);
  }

  function autoGrow(el){ el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
  function updateCount(el){ const c=document.getElementById('notesCount'); if(c) c.textContent=`${el.value.length}/${el.maxLength||200}`; }
  function resetFries(){ document.querySelectorAll('input[name="fries"]').forEach(r=>{ r.checked=false; }); }
  function setFries(val){
    const r = document.querySelector(`input[name="fries"][value="${val}"]`);
    if(r && !r.disabled){ r.checked = true; }
  }
  function getSelectedFries(){
    const e = document.querySelector('input[name="fries"]:checked');
    return e ? e.value : null;
  }

  function openCustomize(item, keyForEdit, mode='add'){
    if(!isAvailable(item.id)) return;
    CUSTOMIZE_MODE = mode;
    editingKey = keyForEdit;
    currentItem=item; modTitle.textContent=(mode==='edit'?'Editar: ':'Personalizar: ')+item.name;

    // Prefill
    notes.value=""; resetFries();
    let pat=0, che=0, noteTxt='', fries=null;

    if(mode!=='add' && keyForEdit){
      const obj = cart.burger[keyForEdit];
      if(obj){
        fries = obj.fries || null;
        pat = obj.extras?.patty||0;
        che = obj.extras?.cheddar||0;
        noteTxt = obj.notes||'';
      }
    }

    if(fries) setFries(fries);
    patVal.textContent=String(pat);
    cheVal.textContent=String(che);
    notes.value = noteTxt;
    autoGrow(notes); updateCount(notes);

    // Reglas por tipo
    if(item.kind==="double"){ rowPatties.style.display="flex"; rowCheddar.style.display="flex"; }
    else if(item.kind==="chicken"){ rowPatties.style.display="none"; rowCheddar.style.display="flex"; }
    else{ rowPatties.style.display="none"; rowCheddar.style.display="none"; }

    unitPricePreview(item.price);
    applySidesToUI();
    overlay.classList.add("open");
  }

  if(btnCancel) btnCancel.onclick=()=> {
    overlay.classList.remove("open");
    if(CUSTOMIZE_MODE==='checkout' && typeof resolveCheckoutStep === 'function'){
      resolveCheckoutStep(false);
    }
  };
  if(patInc) patInc.onclick=()=>{const v=+patVal.textContent||0;if(v<2)patVal.textContent=v+1; if(currentItem) unitPricePreview(currentItem.price);};
  if(patDec) patDec.onclick=()=>{const v=+patVal.textContent||0;if(v>0)patVal.textContent=v-1; if(currentItem) unitPricePreview(currentItem.price);};
  if(cheInc) cheInc.onclick=()=>{const v=+cheVal.textContent||0;if(v<3)cheVal.textContent=v+1; if(currentItem) unitPricePreview(currentItem.price);};
  if(cheDec) cheDec.onclick=()=>{const v=+cheVal.textContent||0;if(v>0)cheVal.textContent=v-1; if(currentItem) unitPricePreview(currentItem.price);};

  function buildKey(itemId, fries, extras, noteSample){
    return [itemId, fries||'', extras.patty||0, extras.cheddar||0, (noteSample||'').slice(0,20).replace(/\|/g,'/')].join('|');
  }

  if (btnAdd) {
    btnAdd.onclick = () => {
      if (!currentItem) return;

      const chosenFries = getSelectedFries();
      const isDouble  = currentItem.kind === 'double';
      const isChicken = currentItem.kind === 'chicken';

      const pat = isDouble ? Math.min(2, (+patVal.textContent || 0)) : 0;
      const che = (isDouble || isChicken) ? Math.min(3, (+cheVal.textContent || 0)) : 0;

      const extras = { patty: pat, cheddar: che };
      const noteTxt = (notes.value || '').trim();

      if(CUSTOMIZE_MODE==='add'){
        const key = buildKey(currentItem.id, chosenFries, extras, noteTxt) + '|' + Date.now();
        cart.burger[key] = { qty: 1, item: currentItem, fries: chosenFries, extras, notes: noteTxt };
      }else if(CUSTOMIZE_MODE==='edit' || CUSTOMIZE_MODE==='checkout'){
        const prev = cart.burger[editingKey];
        if(prev){
          const newKeyBase = buildKey(prev.item.id, chosenFries ?? prev.fries, extras, noteTxt);
          let targetKey = Object.keys(cart.burger).find(k=>{
            if(k===editingKey) return false;
            const other = cart.burger[k];
            const compBase = buildKey(other.item.id, other.fries, other.extras||{}, other.notes||'');
            return compBase === newKeyBase;
          });
          if(!targetKey){
            targetKey = editingKey;
          }else{
            cart.burger[targetKey].qty += prev.qty;
            delete cart.burger[editingKey];
          }
          cart.burger[targetKey] = {
            ...(cart.burger[targetKey]||prev),
            item: prev.item,
            qty: (cart.burger[targetKey]?.qty ?? prev.qty),
            fries: chosenFries ?? prev.fries ?? null,
            extras,
            notes: noteTxt
          };
        }
      }

      overlay.classList.remove('open');
      renderCart();

      if(CUSTOMIZE_MODE==='checkout' && typeof resolveCheckoutStep === 'function'){
        resolveCheckoutStep(true);
      }
    };
  }

  window.editItem = function(type, encKey){
    if(type!=='burger') return;
    const key = decodeURIComponent(encKey);
    const obj = cart.burger[key];
    if(!obj) return;
    openCustomize(obj.item, key, 'edit');
  };

  if(typeof window !== 'undefined'){ window.autoGrow = autoGrow; window.updateCount = updateCount; }

  /* ====== Helpers de ticket ====== */
  function normalizeFriesLabel(raw){
    if(!raw && raw !== 0) return '';
    let s = String(raw).toLowerCase();
    s = s.replace(/[_-]/g,' ').replace(/\s+/g,' ').trim();
    if(!s) return '';
    if(/\bsin\b/.test(s) && (/\bsal\b/.test(s) || /\bsazon\b/.test(s) || s.includes('sin sal') || s.includes('sin sazon'))) return 'Sin sal';
    if(/\bsazon\b/.test(s) || s.includes('sazonadas') || s.includes('sazonada')) return 'Sazonadas';
    if(/\bsal\b/.test(s) || s.includes('con sal')) return 'Con sal';
    if(s.includes('sazon')) return 'Sazonadas';
    if(s.includes('sin') && s.includes('sal')) return 'Sin sal';
    if(s.includes('sal')) return 'Con sal';
    return '';
  }

  function buildTicketHTML(docSnap){
    const o = docSnap.data();
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const escapeHtml = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

    const orderDisplay = (()=>{ 
      const c=[o.orderNumber,o.number,o.numero,o.num,o.numPedido,o.nro,o.orderNo,o.seq,o.n,o.idPedido,o.pedidoNumber,o.pedido];
      for(const v of c){ if(v==null) continue; const n=typeof v==="string"?parseInt(v,10):v; if(Number.isFinite(n)) return `#${n}`; }
      return `#${(docSnap.id||'').slice(-5).toUpperCase()}`;
    })();

    const dt = (()=>{ const k=['createdAt','created_at','timestamp','date','fecha','time'];
      for(const kk of k){ const v=o[kk]; if(v?.toDate) return v.toDate(); if(typeof v==='number') return new Date(v); if(typeof v==='string'){const d=new Date(v); if(!isNaN(d)) return d;} }
      return new Date();
    })();
    const dateStr = dt.toLocaleDateString('es-AR');
    const timeStr = dt.toLocaleTimeString('es-AR',{hour12:false});

    const phone = (o.telefono || o.tel || o.phone || '').toString().trim();

    const items = Array.isArray(o.items)?o.items:[];
    const linesHTML = items.map(it=>{
      const qty = it.qty||1;
      const name = (it.name||'').toString();
      const base = (it.price||0);
      const pattyCount = it.extras?.patty||0;
      const pattyUnit  = it.extras?.EXTRA_PRICE_PATTY||0;
      const pattySum   = qty * pattyCount * pattyUnit;
      const cheddarCount = it.extras?.cheddar||0;
      const cheddarUnit  = it.extras?.EXTRA_PRICE_CHEDDAR||0;
      const cheddarSum   = qty * cheddarCount * cheddarUnit;
      const baseSubtotal = base * qty;
      const lineTotal    = baseSubtotal + pattySum + cheddarSum;

      const friesRaw = (it.fries || it.side || (Array.isArray(it.sides)? it.sides.join(' '): '') || (it.extras && it.extras.fries) || (it.item && it.item.fries) || '');
      const friesLabel = normalizeFriesLabel(friesRaw);

      let perUnitNotes = null;
      if (Array.isArray(it.notes)) perUnitNotes = it.notes;
      else if (Array.isArray(it.comments)) perUnitNotes = it.comments;
      else if (Array.isArray(it.comment)) perUnitNotes = it.comment;

      let commentPart = '';
      if (perUnitNotes && perUnitNotes.length){
        commentPart = perUnitNotes.map((c,i)=>`<div class="sub">‚Ä¢ Nota ${i+1}: ${escapeHtml(c)}</div>`).join('');
      } else {
        const single = (typeof it.notes === 'string' && it.notes.trim()) ? it.notes.trim()
                     : (typeof it.comment === 'string' && it.comment.trim()) ? it.comment.trim()
                     : null;
        if (single){
          commentPart = `<div class="sub">‚Ä¢ Nota: ${escapeHtml(single)}${qty>1?` (aplica a las ${qty} unidades)`:''}</div>`;
        }
      }

      return `
        <div class="row name"><div class="l">${qty} √ó ${escapeHtml(name)}</div></div>
        ${friesLabel ? `<div class="sub">‚Ä¢ Papas: ${escapeHtml(friesLabel)}</div>` : ''}
        ${commentPart}
        <div class="row amount"><div class="l"></div><div class="r">${money(baseSubtotal)}</div></div>
        ${cheddarCount ? `<div class="sub ex">‚Ä¢ +${cheddarCount} √ó Cheddar ‚Äî ${money(cheddarSum)}</div>` : ''}
        ${pattyCount ? `<div class="sub ex">‚Ä¢ +${pattyCount} √ó Medall√≥n extra ‚Äî ${money(pattySum)}</div>` : ''}
        <div class="row amount final"><div class="l"></div><div class="r">${money(lineTotal)}</div></div>
        <div class="sep"></div>
      `;
    }).join('') || '<div class="sub">Sin √≠tems.</div>';

    const total = (typeof o.total === 'number') ? o.total
      : items.reduce((t,it)=>{ const qty = it.qty||1; const base = (it.price||0)*qty; const patty = (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)*qty; const cheddar = (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0)*qty; return t + base + patty + cheddar; },0);

    const generalNote = (o.comment || o.notes || o.note || o.notes_general || o.comentario || o.comments || '').toString().trim();
    const commentBlock = generalNote ? `<div class="hr"></div><div class="blk"><div class="lbl">COMENTARIO</div><div>${escapeHtml(generalNote)}</div></div><div class="hr"></div>` : '';

    const pickupPretty = (o.pickup_time_pretty || null);

    const pickupBlockLarge = pickupPretty
      ? `<div style="text-align:center;margin:6px 0;font-size:20px;font-weight:900">Retira a las: ${escapeHtml(pickupPretty)}</div>`
      : `<div style="text-align:center;margin:6px 0;font-size:20px;font-weight:900">Retiro: A la brevedad</div>`;

    return `
<!doctype html>
<html><head><meta charset="utf-8"><title>Ticket ${escapeHtml(orderDisplay)}</title>
<style>
  @page{ size:58mm auto; margin:0; }
  html,body{margin:0;padding:0;color:#000;}
  *{-webkit-print-color-adjust:exact; print-color-adjust:exact; -webkit-text-size-adjust:100%;}
  body{ font-family: Arial, sans-serif; font-size:13px; font-weight:700; line-height:1.45; }
  .ticket{ width:48mm; margin:0 auto; padding:2mm 3mm 10mm 2mm; box-sizing:border-box; }
  .c{text-align:center}
  .brand{ font-size:16px; }
  .orderNo{ font-size:14px; margin:1mm 0 }
  .hr{ border-top:1px solid #000; margin:4px 0 }
  .lbl{ font-size:11px; text-transform:uppercase; }
  .blk{ margin:2px 0 2mm 0; }
  .row{ display:flex; justify-content:space-between; gap:4px; }
  .row .l{ flex:1 1 auto; min-width:0; }
  .row .r{ flex:0 0 auto; text-align:right; min-width:18mm; padding-left:1.5mm; white-space:nowrap; }
  .row.name .r{ display:none; }
  .row.amount .l{ display:block; }
  .row.amount.final{ margin-top:3px; }
  .sub{ font-size:11px; margin:1px 0 0 2mm; }
  .sub.ex{ white-space:nowrap; }
  .sep{ border-top:1px dashed #000; opacity:.5; margin:2mm 0 1.2mm 0; }
  .subtotal{ margin-top:2mm; }
  .total{ font-size:16px; margin-top:3mm; }
  .foot{ margin-top:3mm; text-align:center; font-size:10px; font-weight:400; }
</style>
</head>
<body>
  <div class="ticket">
    <div class="c brand">Rhodes Burgers</div>
    <div class="orderNo c">${escapeHtml(orderDisplay)}</div>

    <div class="hr"></div>

    ${o.nombre? `<div class="blk"><div class="lbl">CLIENTE</div><div>${escapeHtml(o.nombre)}</div></div>` : ''}
    ${phone ? `<div class="blk"><div class="lbl">TEL√âFONO</div><div>${escapeHtml(phone)}</div></div>` : ''}

    ${pickupBlockLarge}
    ${(o.pago||o.payment_method)? `<div class="blk"><div class="lbl">MEDIO DE PAGO</div><div>${escapeHtml((o.pago||o.payment_method)||'')}</div></div>` : ''}

    ${commentBlock}

    <div class="hr"></div>
    ${linesHTML}
    <div class="hr"></div>

    <div class="row subtotal"><div class="l">SUBTOTAL</div><div class="r">${money(total)}</div></div>
    <div class="row total"><div class="l">TOTAL</div><div class="r">${money(total)}</div></div>

    <div class="foot">
      ${escapeHtml(dateStr)} ‚Äî ${escapeHtml(timeStr)}
      ${pickupPretty ? `<div>Horario de retiro: ${escapeHtml(pickupPretty)}</div>` : `<div>Retiro: A la brevedad</div>`}
    </div>
  </div>
  <script>
    window.addEventListener('load', () => { setTimeout(() => { window.print(); }, 30); });
  <\/script>
</body>
</html>`;
  }
    
  function printInIframe(docSnap){
    const html = buildTicketHTML(docSnap);
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    iframe.setAttribute('aria-hidden','true');
    document.body.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open(); doc.write(html); doc.close();

    const cleanup = () => { try{ document.body.removeChild(iframe); }catch(e){} };
    try{ iframe.contentWindow.onafterprint = () => setTimeout(cleanup, 150); }catch(e){}
    setTimeout(cleanup, 15000);
  }

  // ====== Flujo: asegurar PAPAS antes de cargar ======
  async function ensureFriesForAll(){
    while(true){
      const missingEntry = Object.entries(cart.burger).find(([k,o])=>!o.fries);
      if(!missingEntry) return true;
      const [key, obj] = missingEntry;

      await new Promise(res=>{
        resolveCheckoutStep = res;
        openCustomize(obj.item, key, 'checkout');
      });
      if(!cart.burger[key] || !cart.burger[key].fries){
        const cont = confirm('Falta elegir papas para alguna hamburguesa. ¬øQuer√©s seguir eligiendo?');
        if(!cont) return false;
      }
    }
  }

  // ===== Imprimir y cargar =====
  let inFlight = false;
  const btnPrintAndLoad = document.getElementById('btnPrintAndLoad');

  if(btnPrintAndLoad){
    btnPrintAndLoad.addEventListener('click', async ()=>{
      if(inFlight) return;
      inFlight = true;
      btnPrintAndLoad.setAttribute('disabled','');
      btnPrintAndLoad.classList.add('disabled');

      try{
        const hasItems = Object.keys(cart.burger).length || Object.keys(cart.drink).length;
        if(!hasItems){ alert("Agreg√° al menos un producto."); throw new Error('empty'); }

        const okFries = await ensureFriesForAll();
        if(!okFries){ throw new Error('cancelled-fries'); }

        const nombreRaw = ($("#inpNombre").value||"").trim();
        if(!nombreRaw){ alert("Ingres√° el nombre."); throw new Error('no-name'); }
        const nombre = `${nombreRaw} (mostrador)`;
        const telefono = ($("#inpTel").value||"").trim();
        const pago = $("#selPago").value;
        const comentario = ($("#inpComentario").value||"").trim();

        const selected = window._selectedSlot || null; // puede ser null (a la brevedad)
        const orderNumber = await getNextOrderNumber();

        const items=[];
        for(const o of Object.values(cart.burger)){
          items.push({
            id:o.item.id, name:o.item.name, price:o.item.price, qty:o.qty,
            fries:o.fries||'', notes:o.notes||'',
            extras:{ patty:o.extras?.patty||0, cheddar:o.extras?.cheddar||0, EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY, EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR }
          });
        }
        for(const o of Object.values(cart.drink)){
          items.push({ id:o.item.id, name:o.item.name, price:o.item.price, qty:o.qty, fries:'', notes:'', extras:{} });
        }

        const total = calcTotal();

        // SIN reserva de slot (sin l√≠mite)
        const payload = {
          orderNumber, number:orderNumber, nombre, telefono, pago, comment: comentario,
          items, total, status:(pago==='mercado_pago'?'pending_payment':'accepted'),
          payment_status:(pago==='mercado_pago'?'pending_payment':'paid'),
          source:"mostrador",
          // si hay slot elegido lo guardamos, sino se guarda ASAP
          pickup_slot: selected ? selected.key : null,
          pickup_time: selected ? selected.iso : null,
          pickup_time_pretty: selected ? selected.pretty : null,
          pickup_asap: !selected,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        const ref = await db.collection("orders").add(payload);

        // order_public
        const pubId = ref.id.slice(0,22);
        await db.collection('order_public').doc(pubId).set({
          orderId: ref.id, orderNumber,
          status: payload.status==='pending_payment'?'pending_payment':'accepted',
          entrega:'retira', pago, nombre,
          pickup_slot: payload.pickup_slot,
          pickup_time: payload.pickup_time,
          pickup_time_pretty: payload.pickup_time_pretty || null,
          pickup_asap: payload.pickup_asap === true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});

        // imprimir
        let savedDoc = null;
        try{ savedDoc = await db.collection('orders').doc(ref.id).get(); }catch(e){ console.warn('no pudo leer doc recien guardado', e); }
        const snapForPrint = savedDoc || { id: ref.id, data: () => ({...payload, createdAt: new Date()}) };
        printInIframe(snapForPrint);

        // limpiar UI
        cart={burger:{},drink:{}}; renderCart();
        $("#inpNombre").value=""; $("#inpTel").value=""; $("#inpComentario").value="";
        alert(`Pedido #${orderNumber} cargado${selected?` para ${selected.pretty}`:' (A la brevedad)'}.`);
      }catch(err){
        if(err && ['empty','no-name','cancelled-fries'].includes(err.message)) {
          // mensajes ya mostrados o cancel√≥
        }else{
          console.error(err);
          alert('Error al cargar el pedido. Reintent√°.');
        }
      }finally{
        setTimeout(()=>{ inFlight=false; btnPrintAndLoad.removeAttribute('disabled'); btnPrintAndLoad.classList.remove('disabled'); }, 800);
      }
    });
  }

  // Inicio
  document.addEventListener('DOMContentLoaded', mount);
  window.addEventListener('storage', (e)=>{ if(e.key===null){ refreshSlotsUI(); } });
  </script>
</body>
</html>
