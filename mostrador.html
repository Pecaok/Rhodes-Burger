<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#645E52;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#eaeaea;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:18px;

      --price-cheddar:300;
      --price-patty:2500;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
    }
    .brand img{
      width:36px;
      height:36px;
      border-radius:10px;
      background:#fff;
      object-fit:contain;
      margin-right:8px;
    }
    .spacer{ flex:1; }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ring);
      background:#fff;
      padding:10px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      color:inherit;
      transition:0.15s ease;
    }
    .btn:hover{
      opacity:.85;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    .container{
      max-width:1200px;
      margin:20px auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 420px;
      gap:18px;
    }
    @media(max-width:980px){
      .container{ grid-template-columns:1fr; }
    }

    h1{ font-size:26px; margin:10px 0 12px; }
    h2{ font-size:20px; margin:18px 0 10px; }

    .grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(220px,1fr));
      gap:16px;
    }
    @media(max-width:720px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .card img{
      width:100%;
      height:200px;
      object-fit:cover;
    }

    .content{ padding:12px; }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
    }
    .price{ font-weight:800; }

    /* ---------- CARRITO FIJO ---------- */
    aside.side{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      position:sticky;
      top:80px;
      max-height:85vh;
      overflow-y:auto;
    }

    .field{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .field label{
      font-weight:600;
      font-size:14px;
    }
    .field input,
    .field select{
      padding:12px;
      border-radius:12px;
      border:1px solid var(--ring);
      font-size:15px;
      background:white;
    }

    .total{
      font-size:22px;
      font-weight:800;
      margin-bottom:12px;
      display:flex;
      justify-content:space-between;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
    }

    /* ---------- HORARIOS ---------- */
    .carousel{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:14px;
    }
    .arrow{
      width:44px;
      height:44px;
      display:inline-grid;
      place-items:center;
      background:#fff;
      cursor:pointer;
      border-radius:10px;
      border:1px solid var(--ring);
      font-size:22px;
      font-weight:700;
      user-select:none;
      transition:0.15s ease;
    }
    .arrow.disabled{
      opacity:.35;
      cursor:not-allowed;
    }

    .slot-display{
      min-width:160px;
      padding:12px 16px;
      background:#fff;
      border-radius:12px;
      border:1px solid var(--ring);
      text-align:center;
      font-weight:800;
      font-size:18px;
    }

    .slot-full{
      color:#b00020;
    }

    /* ---------- MODAL ---------- */
    .overlay{
      position: fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
    }

    .modal{
      width:480px;
      max-width:90%;
      background:white;
      border-radius:22px;
      padding:28px;
      box-shadow:0 15px 40px rgba(0,0,0,.25);
      animation:popup .25s ease-out;
    }

    @keyframes popup{
      from{ transform:scale(.92); opacity:0 }
      to{ transform:scale(1); opacity:1 }
    }

    textarea{
      width:100%;
      min-height:90px;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid #dfd9d0;
      background:#fcfaf7;
      font-size:15px;
      color:#3e3a33;
      resize:none;
      outline:none;
      transition:0.15s ease;
    }
    textarea:focus{
      border-color:#b8ad9e;
      background:#f9f6f2;
    }
  </style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png" alt="">Rhodes Burgers</a>
    <div class="spacer"></div>

    <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
    <a class="btn" href="finanzas.html">üìà Finanzas</a>
    <a class="btn" href="admin.html">‚öôÔ∏è Admin</a>

    <strong style="margin-left:8px">Mostrador</strong>
  </div>
</header>

<main class="container">

  <!-- LISTA DE PRODUCTOS -->
  <section>
    <h1>Men√∫</h1>

    <h2>Hamburguesas</h2>
    <div id="burgersGrid" class="grid"></div>

    <h2 style="margin-top:20px">Bebidas</h2>
    <div id="drinksGrid" class="grid"></div>

    <h2 style="margin-top:20px">Guarniciones</h2>
    <div id="sidesGrid" class="grid"></div>
  </section>

  <!-- CARRITO -->
  <aside class="side">
    <h2 style="margin-top:0">Carrito</h2>

    <div class="total">
      <span>Total</span>
      <span id="cartTotal">$0</span>
    </div>

    <div id="cartItems" class="muted">Sin √≠tems.</div>

    <div class="field">
      <label>Nombre (requerido)</label>
      <input id="inpNombre" type="text" placeholder="Ej: Juan">
    </div>

    <div class="field">
      <label>Tel√©fono (opcional)</label>
      <input id="inpTel" type="tel" placeholder="Ej: 1123456789">
    </div>

    <div class="field">
      <label>M√©todo de pago</label>
      <select id="selPago">
        <option value=""></option>
        <option value="efectivo">Efectivo</option>
        <option value="mercado_pago">Mercado Pago</option>
        <option value="debito">D√©bito</option>
        <option value="transferencia">Transferencia</option>
      </select>
    </div>

    <h3 style="margin-top:24px">Horario de retiro</h3>

    <div class="carousel">
      <div class="arrow" id="slotPrev">‚óÄ</div>
      <div class="slot-display" id="slotLabel">--:--</div>
      <div class="arrow" id="slotNext">‚ñ∂</div>
    </div>

    <div style="margin-top:10px">
      <label style="font-weight:600;font-size:14px">Horario personalizado</label>
      <input 
        id="manualTime" 
        type="time"
        style="margin-top:6px;padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:15px;width:160px"
      >
    </div>

    <div id="miniSlotSub" class="muted" style="margin-top:8px;font-size:14px;">
      Seleccionado: ‚Äî
    </div>

    <button id="btnCargarPedido" class="btn primary" style="width:100%;margin-top:18px">
      Cargar pedido
    </button>

  </aside>
</main>



<!-- ========== SCRIPTS FIREBASE & L√ìGICA COMPLETA ========== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>

///////////////////////////////////////////////////////////
///   üî• FIREBASE INIT
///////////////////////////////////////////////////////////
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

///////////////////////////////////////////////////////////
///   üîß CONSTANTES
///////////////////////////////////////////////////////////
const $ = s => document.querySelector(s);
const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

const EXTRA_PRICE_PATTY   = 2500;
const EXTRA_PRICE_CHEDDAR = 300;

const GRAMOS_POR_BLOQUE = 1500;
const G_POR_BURGER = 200;
const G_POR_SIDE   = 700;

///////////////////////////////////////////////////////////
///   üõí CARRITO
///////////////////////////////////////////////////////////
let cart = { burger:{}, drink:{}, side:{} };

function gramosDelPedido(){
  let g = 0;
  for(const id in cart.burger) g += cart.burger[id].qty * G_POR_BURGER;
  for(const id in cart.side)   g += cart.side[id].qty   * G_POR_SIDE;
  return g;
}

function renderCart(){
  const wrap = $("#cartItems");
  const totalEl = $("#cartTotal");

  let html = "";
  let total = 0;

  // STACKEO DE ITEMS IGUALES
  const stack = {};

  for(const id in cart.burger){
    const b = cart.burger[id];
    const key = `${b.item.id}|${b.friesRaw}|${b.extras.patty}|${b.extras.cheddar}|${b.notes}`;

    if(!stack[key]) stack[key] = { ...b };
    else stack[key].qty += b.qty;
  }

  // reemplazamos
  cart.burger = {};
  let idx = 0;
  for(const k in stack){
    const b = stack[k];
    cart.burger["b"+idx] = b;
    idx++;
  }

  // Pintar carrito
  for(const id in cart.burger){
    const b = cart.burger[id];
    const unit =
      b.item.price +
      (b.extras.patty * EXTRA_PRICE_PATTY) +
      (b.extras.cheddar * EXTRA_PRICE_CHEDDAR);

    const line = unit * b.qty;
    total += line;

    html += `
      <div style="margin-bottom:12px;display:flex;justify-content:space-between">
        <div>
          <strong>${b.qty}√ó ${b.item.name}</strong><br>
          <span class="muted">
            Papas: ${b.fries}
            ${
              b.extras.patty||b.extras.cheddar
              ? ` ¬∑ Extras: ${b.extras.patty} med ¬∑ ${b.extras.cheddar} cheddar`
              : ""
            }
            ${b.notes ? ` ¬∑ Nota: ${b.notes}` : ""}
          </span>
        </div>
        <div style="text-align:right">
          ${money(line)}
        </div>
      </div>
    `;
  }

  totalEl.textContent = money(total);
  wrap.innerHTML = html || "<span class='muted'>Sin √≠tems.</span>";
}



///////////////////////////////////////////////////////////
///   üçî PRODUCTOS (se carga desde Firebase)
///////////////////////////////////////////////////////////
let PRODUCTS = { burgers: [], drinks: [], sides: [] };

db.collection("products").onSnapshot(snap=>{
  PRODUCTS = { burgers:[], drinks:[], sides:[] };

  snap.forEach(doc=>{
    const d = doc.data();
    const item = {
      id: doc.id,
      name: d.name,
      price: d.price,
      img: d.img || "images/logo.png",
      description: d.description||"",
      category: d.category
    };

    if(d.category==="burger") PRODUCTS.burgers.push(item);
    if(d.category==="drink")  PRODUCTS.drinks.push(item);
    if(d.category==="side")   PRODUCTS.sides.push(item);
  });

  mountMenu();
});

function renderCard(item){
  const div = document.createElement("div");
  div.className = "card";

  div.innerHTML = `
    <img src="${item.img}">
    <div class="content">
      <h3>${item.name}</h3>
      <div class="muted">${item.description||""}</div>
      <div class="row">
        <span class="price">${money(item.price)}</span>
        <button class="btn addBtn">Agregar</button>
      </div>
    </div>
  `;

  div.querySelector(".addBtn").onclick = ()=> addItem(item);

  return div;
}

function mountMenu(){
  $("#burgersGrid").innerHTML = "";
  $("#drinksGrid").innerHTML  = "";
  $("#sidesGrid").innerHTML   = "";

  PRODUCTS.burgers.forEach(x=>$("#burgersGrid").appendChild(renderCard(x)));
  PRODUCTS.drinks.forEach(x=>$("#drinksGrid").appendChild(renderCard(x)));
  PRODUCTS.sides.forEach(x=>$("#sidesGrid").appendChild(renderCard(x)));
}

function addItem(item){
  if(item.category==="burger"){
    const id = item.id + "_" + Date.now();

    cart.burger[id] = {
      item,
      qty:1,
      fries:"Sin sal",
      friesRaw:"con_sal",
      extras:{patty:0,cheddar:0},
      notes:""
    };

  } else if(item.category==="drink"){
    const id = item.id;
    if(!cart.drink[id]) cart.drink[id]={item,qty:0};
    cart.drink[id].qty++;

  } else if(item.category==="side"){
    const id = item.id;
    if(!cart.side[id]) cart.side[id]={item,qty:0};
    cart.side[id].qty++;
  }

  renderCart();
}



///////////////////////////////////////////////////////////
///   üïí SISTEMA DE HORARIOS (con gramaje)
///////////////////////////////////////////////////////////

const SLOT_START = "19:15";
const SLOT_END   = "23:45";
const SLOT_INTERVAL = 15;

function parseHHMM(s){
  const [h,m]=s.split(":").map(Number);
  const now = new Date();
  return new Date(now.getFullYear(),now.getMonth(),now.getDate(),h,m);
}
function formatHHMM(d){
  return d.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
}

function generateSlots(){
  let arr = [];
  let cur = parseHHMM(SLOT_START);
  const end= parseHHMM(SLOT_END);

  while(cur<=end){
    arr.push(new Date(cur));
    cur = new Date(cur.getTime()+SLOT_INTERVAL*60000);
  }
  return arr;
}

let rawSlots = generateSlots();
let slotData = [];  // {key, date, gramsUsed, full}
let currentSlotIndex = 0;

function slotKey(d){
  const y=d.getFullYear();
  const M=String(d.getMonth()+1).padStart(2,"0");
  const D=String(d.getDate()).padStart(2,"0");
  const H=String(d.getHours()).padStart(2,"0");
  const m=String(d.getMinutes()).padStart(2,"0");
  return `${y}${M}${D}_${H}${m}`;
}

// carga en vivo
async function loadSlotUsage(){
  slotData = rawSlots.map(d=>({
    date:d,
    key:slotKey(d),
    gramsUsed:0,
    full:false
  }));

  slotData.forEach(s=>{
    db.collection("slots_grams").doc(s.key).onSnapshot(doc=>{
      const data = doc.data();
      s.gramsUsed = data?.gramsUsed || 0;
      s.full = s.gramsUsed >= GRAMOS_POR_BLOQUE;

      refreshSlotUI();
    });
  });
}

function refreshSlotUI(){
  const gramsPedido = gramosDelPedido();

  // 1. mostramos siempre todos
  // 2. marcamos cu√°l soporta los gramos
  slotData.forEach(s=>{
    const restante = GRAMOS_POR_BLOQUE - s.gramsUsed;

    s.canHandle = restante >= gramsPedido;
  });

  renderSlot();
}

function renderSlot(){
  const slot = slotData[currentSlotIndex];
  if(!slot){
    $("#slotLabel").textContent="Sin horarios";
    return;
  }

  let txt = formatHHMM(slot.date);

  if(!slot.canHandle){
    txt = txt + " ‚ö†";
  }

  if(slot.full){
    $("#slotLabel").classList.add("slot-full");
  } else {
    $("#slotLabel").classList.remove("slot-full");
  }

  $("#slotLabel").textContent = txt;

  window.selectedSlot = {
    key: slot.key,
    pretty: formatHHMM(slot.date)
  };

  $("#miniSlotSub").textContent = "Seleccionado: "+window.selectedSlot.pretty;

  $("#slotPrev").classList.toggle("disabled",currentSlotIndex===0);
  $("#slotNext").classList.toggle("disabled",currentSlotIndex===slotData.length-1);
}

$("#slotPrev").onclick = ()=>{
  if(currentSlotIndex>0){
    currentSlotIndex--;
    renderSlot();
  }
};
$("#slotNext").onclick = ()=>{
  if(currentSlotIndex<slotData.length-1){
    currentSlotIndex++;
    renderSlot();
  }
};



///////////////////////////////////////////////////////////
///   üì§ ENVIAR PEDIDO
///////////////////////////////////////////////////////////

async function sendOrder(){
  const nombre = $("#inpNombre").value.trim();
  if(!nombre) return alert("Ingres√° el nombre");

  const pago = $("#selPago").value.trim() || "efectivo";

  let slot = window.selectedSlot;

  const manual = $("#manualTime").value;
  if(manual){
    const now = new Date();
    slot = {
      pretty: manual,
      iso: new Date(now.getFullYear(),now.getMonth(),now.getDate(),
                    manual.split(":")[0],manual.split(":")[1])
            .toISOString()
    };
  }

  if(!slot){
    alert("Eleg√≠ horario");
    return;
  }

  // armar items
  const items=[];
  let total=0;

  for(const id in cart.burger){
    const b=cart.burger[id];
    const unit = b.item.price +
      b.extras.patty*EXTRA_PRICE_PATTY +
      b.extras.cheddar*EXTRA_PRICE_CHEDDAR;

    total += unit*b.qty;

    items.push({
      type:"burger",
      id:b.item.id,
      name:b.item.name,
      qty:b.qty,
      price:b.item.price,
      fries:b.fries,
      extras:b.extras,
      notes:b.notes||""
    });
  }

  for(const id in cart.drink){
    const d=cart.drink[id];
    total+=d.item.price*d.qty;
    items.push({
      type:"drink",
      id:d.item.id,
      name:d.item.name,
      qty:d.qty,
      price:d.item.price
    });
  }

  for(const id in cart.side){
    const s=cart.side[id];
    total+=s.item.price*s.qty;
    items.push({
      type:"side",
      id:s.item.id,
      name:s.item.name,
      qty:s.qty,
      price:s.item.price
    });
  }

  // generar n√∫mero de pedido
  async function nextOrder(){
    const ref=db.collection("config").doc("counters");
    let last=0;
    try{
      const qs=await db.collection("orders")
        .orderBy("orderNumber","desc")
        .limit(1).get();
      if(!qs.empty) last=qs.docs[0].data().orderNumber||0;
    }catch{}

    const n = await db.runTransaction(async tx=>{
      const snap=await tx.get(ref);
      const cur=snap.exists? (snap.data().orderNumber||0):0;
      const base=Math.max(cur,last);
      const next=base+1;
      tx.set(ref,{orderNumber:next},{merge:true});
      return next;
    });

    return n;
  }

  const orderNumber = await nextOrder();

  const order={
    orderNumber,
    nombre,
    telefono:$("#inpTel").value.trim(),
    entrega:"take_away",
    pago,
    pickup_slot:slot.pretty,
    pickup_time:slot.iso || new Date().toISOString(),
    status:(pago==="mercado_pago"?"pending_payment":"accepted"),
    payment_status:(pago==="mercado_pago"?"pending_payment":"paid"),
    items,
    total,
    source:"mostrador",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("orders").add(order);

  alert("Pedido cargado ‚úîÔ∏è  #" + orderNumber);

  cart = {burger:{},drink:{},side:{}};
  renderCart();
}

$("#btnCargarPedido").onclick = sendOrder;



///////////////////////////////////////////////////////////
///   INIT
///////////////////////////////////////////////////////////
document.addEventListener("DOMContentLoaded", ()=>{
  renderCart();
  loadSlotUsage();
});
</script>

</body>
</html>
