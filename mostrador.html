<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:800}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}

    main{max-width:1200px;margin:22px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:1000px){ main{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    h1{font-size:26px;margin:6px 0 12px}
    h2{font-size:18px;margin:0 0 10px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }

    .prod{display:flex;gap:12px;border:1px solid var(--ring);border-radius:14px;padding:10px}
    .prod img{width:110px;height:90px;object-fit:cover;border-radius:12px;background:#f0f0f0}
    .prod .t{flex:1 1 auto;min-width:0}
    .prod h3{margin:0 0 4px;font-size:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:6px}
    .price{font-weight:800}
    .qty{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px}
    .qty button{width:28px;height:28px;border:1px solid #e5e5e5;background:#fff;border-radius:999px;font-weight:900;cursor:pointer}

    /* Carrito */
    .cart .line{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;border-bottom:1px solid #efefef;padding:8px 0}
    .cart .line strong{display:block}
    .total{display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:18px;margin-top:10px}
    .cart .actions{display:flex;gap:10px;margin-top:10px}
    .empty{color:var(--muted);font-style:italic}

    /* Modal pagar */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;z-index:40}
    .overlay.open{display:flex}
    .modal{background:#fff;border-radius:20px;box-shadow:var(--shadow);width:560px;max-width:92vw;padding:16px}
    label{font-weight:600;display:block;margin:8px 0 6px}
    input[type="text"], select, textarea{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    textarea{min-height:90px}
    .rowx{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .ok{color:#2e7d32;font-weight:700}
    .err{color:#b00020;font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Mostrador</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="pedido_local.html">← Volver a Pedidos</a>
    </div>
  </header>

  <main>
    <!-- IZQUIERDA: menú en pares -->
    <section class="card">
      <h1>Menú (Mostrador)</h1>
      <div class="grid" id="menuGrid"></div>
    </section>

    <!-- DERECHA: carrito -->
    <aside class="card cart">
      <h2>Carrito</h2>
      <div id="cartList"></div>
      <div class="total">
        <span>Total</span>
        <span id="cartTotal">$ 0</span>
      </div>
      <div class="actions">
        <button class="btn ghost" id="btnClear">Vaciar</button>
        <button class="btn primary" id="btnPay">Pagar</button>
      </div>
      <div id="cartMsg" class="ok" style="display:none;margin-top:8px"></div>
      <div id="cartErr" class="err" style="display:none;margin-top:8px"></div>
    </aside>
  </main>

  <!-- Modal de pago -->
  <div class="overlay" id="payOverlay">
    <div class="modal">
      <h2>Confirmar pedido</h2>
      <div class="rowx" style="flex-direction:column;align-items:stretch">
        <div>
          <label>Nombre del cliente</label>
          <input id="inpNombre" type="text" placeholder="Ej: Juan Pérez">
          <div class="muted" style="margin-top:4px">Se guardará como <em>“Nombre Apellido (Mostrador)”</em>.</div>
        </div>
        <div>
          <label>Teléfono (opcional)</label>
          <input id="inpTelefono" type="text" placeholder="Ej: 11 2345 6789">
        </div>
        <div>
          <label>Medio de pago</label>
          <select id="selPago">
            <option value="efectivo">Efectivo</option>
            <option value="mercado_pago">Mercado Pago</option>
          </select>
        </div>
        <div>
          <label>Comentario (opcional)</label>
          <textarea id="inpNotas" placeholder="Observaciones…"></textarea>
        </div>
        <div class="rowx" style="justify-content:flex-end">
          <button class="btn ghost" id="btnCancelPay">Cancelar</button>
          <button class="btn primary" id="btnConfirmPay">Confirmar y guardar</button>
        </div>
        <div id="payMsg" class="ok" style="display:none"></div>
        <div id="payErr" class="err" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ========= FIREBASE =========
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  const db = firebase.firestore();

  // ========= DATA (burgers) =========
  const BURGERS = [
    { id:"bigjohn_simple", name:"Big John Simple", price:10900, img:"images/Big John Simple.jpg" },
    { id:"bigjohn_doble",  name:"Big John Doble",  price:13900, img:"images/Big John Doble.jpg" },
    { id:"bigjohn_triple", name:"Big John Triple", price:16900, img:"images/Big John Triple.jpg" },

    { id:"burguesa_simple", name:"Burguesa Simple", price:11900, img:"images/Burguesa Simple.jpg" },
    { id:"burguesa_doble",  name:"Burguesa Doble",  price:14900, img:"images/Burguesa Doble.jpg" },
    { id:"burguesa_triple", name:"Burguesa Triple", price:17900, img:"images/Burguesa Triple.jpg" },

    { id:"cheesebacon_spl", name:"CheeseBacon Simple", price:10500, img:"images/CheeseBacon Simple.jpg" },
    { id:"cheesebacon_dbl", name:"CheeseBacon Doble",  price:13500, img:"images/CheeseBacon Doble.jpg" },
    { id:"cheesebacon_tri", name:"CheeseBacon Triple", price:16500, img:"images/CheeseBacon Triple.jpg" },

    { id:"cheese_simple", name:"Cheeseburger Simple", price:9500, img:"images/cheeseburger simple.jpg" },
    { id:"cheese_doble",  name:"Cheeseburger Doble",  price:12500, img:"images/cheeseburger doble.jpg" },
    { id:"cheese_triple", name:"Cheeseburger Triple", price:15500, img:"images/Cheeseburger Triple.jpg" },

    { id:"rhodes_simple", name:"Rhodes Simple", price:11900, img:"images/Rhodes Simple.jpg" },
    { id:"rhodes_doble",  name:"Rhodes Doble",  price:14900, img:"images/Rhodes Doble.jpg" },
    { id:"rhodes_triple", name:"Rhodes Triple", price:17900, img:"images/Rhodes Triple.jpg" },

    { id:"morgan_simple", name:"Morgan Simple", price:10900, img:"images/Morgan Simple.jpg" },
    { id:"morgan_doble",  name:"Morgan Doble",  price:14500, img:"images/Morgan Doble.jpg" },
    { id:"morgan_triple", name:"Morgan Triple", price:17500, img:"images/Morgan Triple.jpg" },

    { id:"pollo_crispy",     name:"Pollo Crispy",       price:8900,  img:"images/Pollo crispy.jpg" },
    { id:"pollo_crispy_dbl", name:"Pollo Crispy Doble", price:11900, img:"images/Pollo crispy doble.jpg" },

    { id:"veggie", name:"Veggie", price:9900, img:"images/Veggie.jpg" },
    { id:"kids",   name:"Kids",   price:7900, img:"images/Kids.jpg" }
  ];
  const FALLBACK_IMG = "images/logo.png";

  // ========= HELPERS =========
  const $ = s => document.querySelector(s);
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

  // Carrito en memoria (no hace falta persistir)
  const cart = new Map(); // key=id, value={id,name,price,qty}
  function cartItems(){ return Array.from(cart.values()); }
  function cartTotal(){
    return cartItems().reduce((t,it)=>t + (it.price||0) * (it.qty||0), 0);
  }
  function renderCart(){
    const box = $("#cartList"); const items = cartItems();
    $("#cartMsg").style.display="none"; $("#cartErr").style.display="none";
    if(!items.length){
      box.innerHTML = '<div class="empty">Carrito vacío.</div>';
      $("#cartTotal").textContent = money(0);
      return;
    }
    box.innerHTML = items.map(it=>`
      <div class="line">
        <div>
          <strong>${it.qty}× ${it.name}</strong>
          <span class="muted" style="display:block">${money(it.price)} c/u</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <button class="btn ghost" onclick="decQty('${it.id}')">-</button>
          <button class="btn ghost" onclick="incQty('${it.id}')">+</button>
          <span>${money(it.qty*it.price)}</span>
        </div>
      </div>
    `).join("");
    $("#cartTotal").textContent = money(cartTotal());
  }
  window.incQty = id => { const it=cart.get(id); if(!it) return; it.qty=Math.min(99,(it.qty||1)+1); cart.set(id,it); renderCart(); }
  window.decQty = id => { const it=cart.get(id); if(!it) return; it.qty=Math.max(0,(it.qty||1)-1); if(it.qty===0) cart.delete(id); else cart.set(id,it); renderCart(); }

  function addToCart(prod){
    const cur = cart.get(prod.id) || {id:prod.id,name:prod.name,price:prod.price,qty:0};
    cur.qty = Math.min(99, cur.qty + 1);
    cart.set(prod.id, cur);
    renderCart();
  }

  function renderMenu(){
    const host = $("#menuGrid");
    host.innerHTML = "";
    BURGERS.forEach(b=>{
      const el = document.createElement("div");
      el.className = "prod";
      el.innerHTML = `
        <img src="${encodeURI(b.img)}" alt="${b.name}" onerror="this.onerror=null;this.src='${FALLBACK_IMG}'">
        <div class="t">
          <h3>${b.name}</h3>
          <div class="row">
            <span class="price">${money(b.price)}</span>
            <span class="qty">
              <button onclick='decQty("${b.id}")'>-</button>
              <span id="q_${b.id}">${(cart.get(b.id)?.qty)||0}</span>
              <button onclick='addToCart(${JSON.stringify(b).replace(/"/g,'&quot;')})'>+</button>
            </span>
          </div>
        </div>`;
      host.appendChild(el);
    });
  }

  // ========= PAGO / GUARDAR PEDIDO =========
  async function takeNextOrderNumber(tx){
    const ref = db.collection("config").doc("counters");
    const snap = await tx.get(ref);
    const prev = snap.exists ? (snap.data().orderNumber||0) : 0;
    const next = prev + 1;
    tx.set(ref, {orderNumber: next}, {merge:true});
    return next;
  }

  async function saveOrderFromCounter(payload){
    // Transacción para orderNumber
    let createdId=null, orderNumber=null;
    await db.runTransaction(async (tx)=>{
      const next = await takeNextOrderNumber(tx);
      orderNumber = next;
      const ref = db.collection("orders").doc(); // id auto
      const full = Object.assign({}, payload, {
        orderNumber,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      tx.set(ref, full);
      createdId = ref.id;
    });
    return { id: createdId, orderNumber };
  }

  function buildItemsFromCart(){
    return cartItems().map(it=>({
      type: "burger",
      id: it.id,
      name: it.name,
      qty: it.qty,
      price: it.price
      // Nota: desde mostrador no pedimos papas/extras; por compat se puede setear fries por defecto:
      // fries: "con_sazon"
    }));
  }

  // ========= UI eventos =========
  document.getElementById("btnClear").onclick = ()=>{ cart.clear(); renderCart(); renderMenu(); };
  document.getElementById("btnPay").onclick = ()=>{
    if(cart.size===0){ const m=$("#cartErr"); m.textContent="Agregá al menos 1 ítem."; m.style.display='block'; return; }
    $("#payOverlay").classList.add("open");
    $("#payMsg").style.display='none'; $("#payErr").style.display='none';
  };
  document.getElementById("btnCancelPay").onclick = ()=> $("#payOverlay").classList.remove("open");

  document.getElementById("btnConfirmPay").onclick = async ()=>{
    const payErr=$("#payErr"), payMsg=$("#payMsg");
    payErr.style.display='none'; payMsg.style.display='none';
    try{
      if(cart.size===0) throw new Error("El carrito está vacío.");
      const nombre = ($("#inpNombre").value||"Cliente").trim();
      const telefono = ($("#inpTelefono").value||"").trim();
      const pago = $("#selPago").value || "efectivo";
      const notes = ($("#inpNotas").value||"").trim();

      const items = buildItemsFromCart();
      const total = cartTotal();

      const payload = {
        nombre: nombre ? (nombre + " (Mostrador)") : "Cliente (Mostrador)",
        telefono,
        entrega: "take_away",
        pago,
        notes,
        status: "accepted",
        // si quisieras marcar pagado automáticamente desde mostrador, podés agregar:
        // paid: true, payment_status: "paid",
        items,
        total,
        source: "mostrador"
      };

      const res = await saveOrderFromCounter(payload);

      payMsg.textContent = `Pedido #${res.orderNumber} creado correctamente.`;
      payMsg.style.display='block';

      // Clean & cerrar
      cart.clear(); renderCart(); renderMenu();
      setTimeout(()=>{ $("#payOverlay").classList.remove("open"); }, 900);
    }catch(e){
      payErr.textContent = e?.message || "No se pudo guardar el pedido.";
      payErr.style.display='block';
    }
  };

  // ========= boot =========
  (function boot(){
    renderMenu();
    renderCart();
  })();
  </script>
</body>
</html>
