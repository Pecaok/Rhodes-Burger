<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#645E52;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#eaeaea;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:18px;
      --danger: #d32f2f;

      --price-cheddar:300;
      --price-patty:2500;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
      height: 100vh; /* Asegurar altura completa */
      overflow: hidden; /* Evitar scroll doble */
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
      height: 60px;
    }
    .topbar{
      max-width:100%;
      padding:10px 20px;
      display:flex;
      align-items:center;
      gap:12px;
      height: 100%;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
      font-size: 18px;
    }
    .brand img{
      width:36px;
      height:36px;
      border-radius:8px;
      margin-right:8px;
    }
    .spacer{ flex:1; }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content: center;
      gap:8px;
      border:1px solid var(--ring);
      background:#fff;
      padding:10px 16px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      color:inherit;
      transition: all .1s;
    }
    .btn:active { transform: scale(0.96); }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    /* LAYOUT PRINCIPAL */
    .container{
      display:grid;
      grid-template-columns: 1fr 450px; /* Columna carrito m√°s ancha */
      height: calc(100vh - 60px); /* Restar header */
      overflow: hidden;
    }

    /* SECCI√ìN MEN√ö (IZQUIERDA) */
    .menu-section {
      padding: 20px;
      overflow-y: auto; /* Scroll independiente */
    }

    h1{ font-size:24px; margin:0 0 16px; }
    h2{ font-size:18px; margin:24px 0 12px; border-bottom: 2px solid #eee; padding-bottom: 8px; }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
      gap:16px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      border: 1px solid var(--ring);
    }
    .card img{
      width:100%;
      height:140px;
      object-fit:cover;
    }

    .content{ padding:12px; display:flex; flex-direction:column; flex:1; }
    .content h3 { margin: 0 0 4px; font-size: 16px; }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:auto;
      padding-top: 12px;
    }
    .price{ font-weight:800; font-size: 16px; }
    .addBtn { padding: 6px 14px; font-size: 14px; }

    /* SECCI√ìN CARRITO (DERECHA) */
    aside.side{
      background:#fff;
      border-left: 1px solid var(--ring);
      padding: 20px;
      display:flex;
      flex-direction:column;
      height: 100%;
      box-shadow: -5px 0 20px rgba(0,0,0,0.03);
      z-index: 5;
    }

    .cart-header {
      display: flex; justify-content: space-between; align-items: flex-end;
      margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0;
    }
    .cart-title { font-size: 22px; font-weight: 800; }
    #cartTotal { font-size: 24px; font-weight: 900; color: var(--primary); }

    #cartScrollArea{
      flex:1;
      overflow-y:auto;
      margin-bottom:16px;
      padding-right:4px;
    }

    /* ITEM DEL CARRITO (MEJORADO) */
    .cart-item {
      background: #fdfdfd;
      border: 1px solid #eee;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
    }
    .cart-item-info { flex: 1; }
    .cart-item-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; display: block; }
    .cart-item-desc { font-size: 13px; color: #555; line-height: 1.4; }
    .cart-item-price { font-weight: 700; font-size: 15px; text-align: right; white-space: nowrap; }
    .cart-actions { margin-top: 6px; display: flex; gap: 10px; justify-content: flex-end; }
    .btn-icon { background: none; border: none; cursor: pointer; font-size: 18px; padding: 2px; opacity: 0.7; transition: opacity .2s; }
    .btn-icon:hover { opacity: 1; }

    /* FORMULARIO CARRITO */
    .form-grid { display: grid; gap: 12px; }
    .field input, .field select {
      width:100%; padding:14px; border-radius:12px; border:1px solid #ddd;
      font-size:16px; background: #fafafa; outline: none; transition: border .2s;
    }
    .field input:focus, .field select:focus { border-color: var(--primary); background: #fff; }
    .field label{ display:block; font-weight:600; margin-bottom:6px; font-size: 13px; color: #444; text-transform: uppercase; letter-spacing: 0.5px;}

    /* Slot Horario */
    .slot-row { display: flex; gap: 8px; align-items: center; }
    .slot-display { 
      flex: 1; text-align: center; font-weight: 800; font-size: 18px; 
      padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 12px; 
    }
    .arrow { 
      width: 48px; height: 48px; display: grid; place-items: center; 
      background: #fff; border: 1px solid #ddd; border-radius: 12px; 
      font-size: 20px; cursor: pointer; user-select: none;
    }
    .arrow:active { background: #eee; }
    
    #btnCargarPedido {
      width: 100%; margin-top: 15px; padding: 18px; font-size: 18px; 
      text-transform: uppercase; letter-spacing: 1px;
    }

    /* MODAL */
    .overlay{
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,.6); display:none;
      align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      width:500px; max-width:95%; background:white; border-radius:24px; padding:30px;
      box-shadow:0 20px 60px rgba(0,0,0,.3);
    }
    .chip-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .chip{
        display: inline-flex; align-items: center; gap: 8px;
        padding: 10px 16px; background: #f0f0f0; border: 2px solid transparent;
        border-radius: 99px; cursor: pointer; font-weight: 600; font-size: 14px;
        transition: all .2s;
    }
    .chip:has(input:checked) { background: #e0e8dc; border-color: var(--primary); color: var(--primary); }
    
    /* Contador */
    .qty-ctrl { display: flex; align-items: center; gap: 15px; background: #f9f9f9; padding: 4px; border-radius: 12px; border: 1px solid #eee; }
    .qtybtn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; font-weight: 700; }
    
    /* Alerta papas faltantes */
    .missing-fries { color: var(--danger); font-weight: 800; animation: blink 1s infinite; background: #fff0f0; padding: 2px 6px; border-radius: 4px; font-size: 12px; display: inline-block; margin-top: 4px; border: 1px solid #ffcccc;}
    @keyframes blink { 50% { opacity: 0.7; } }

  </style>
</head>
<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png" alt="">Rhodes Burgers</a>
    <div class="spacer"></div>
    <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
    <a class="btn" href="finanzas.html">üìà Finanzas</a>
  </div>
</header>

<div class="container">

  <section class="menu-section">
    <h1>Men√∫</h1>
    
    <h2>Hamburguesas</h2>
    <div id="burgersGrid" class="grid"></div>

    <h2 style="margin-top:30px">Bebidas</h2>
    <div id="drinksGrid" class="grid"></div>

    <h2 style="margin-top:30px">Guarniciones</h2>
    <div id="sidesGrid" class="grid"></div>
  </section>

  <aside class="side">
    <div class="cart-header">
      <span class="cart-title">Tu Pedido</span>
      <span id="cartTotal">$0</span>
    </div>

    <div id="cartScrollArea">
      <div id="cartItems" class="muted" style="text-align:center; padding-top:40px; font-size:16px;">
        Tu carrito est√° vac√≠o.
      </div>
    </div>

    <div class="form-grid">
      <div class="field">
        <label>Nombre del Cliente</label>
        <input id="inpNombre" type="text" placeholder="Ej: Juan Perez" autocomplete="off">
      </div>

      <div class="field">
        <label>M√©todo de Pago (Opcional)</label>
        <select id="selPago">
          <option value="" selected>Seleccionar en caja (o dejar vac√≠o)</option>
          <option value="efectivo">Efectivo</option>
          <option value="mercado_pago">Mercado Pago</option>
          <option value="debito">D√©bito</option>
          <option value="transferencia">Transferencia</option>
        </select>
      </div>

      <div class="field">
        <label>Horario de Retiro</label>
        <div class="slot-row">
          <div class="arrow" id="slotPrev">‚óÄ</div>
          <div class="slot-display" id="slotLabel">--:--</div>
          <div class="arrow" id="slotNext">‚ñ∂</div>
        </div>
        <div id="miniSlotSub" class="muted" style="text-align:center; margin-top:4px; font-size:12px;">Seleccionado: ‚Äî</div>
      </div>
    </div>

    <input id="inpTel" type="hidden"> 
    <input id="manualTime" type="hidden">

    <button id="btnCargarPedido" class="btn primary">CONFIRMAR PEDIDO</button>
  </aside>

</div>

<div class="overlay" id="overlayCustomize">
  <div class="modal">
    <h2 id="modTitle" style="margin-top:0">Personalizar</h2>

    <div class="field">
      <label style="font-size:16px; margin-bottom:10px">Eleg√≠ tus papas</label>
      <div class="chip-group">
        <label class="chip"><input type="radio" name="fries" value="con_sazon"> üçü Sazonadas</label>
        <label class="chip"><input type="radio" name="fries" value="con_sal"> üßÇ Con sal</label>
        <label class="chip"><input type="radio" name="fries" value="sin_sal"> ü•î Sin sal</label>
        </div>
    </div>

    <div id="rowPatties" class="row" style="display:none;margin-top:20px;">
      <div><strong>Medallones extra</strong> (+$2500 c/u)</div>
      <div class="qty-ctrl">
        <button id="patDec" class="qtybtn">-</button>
        <span id="patVal" style="font-weight:bold; min-width:20px; text-align:center">0</span>
        <button id="patInc" class="qtybtn">+</button>
      </div>
    </div>

    <div id="rowCheddar" class="row" style="display:none;margin-top:15px;">
      <div><strong>Cheddar extra</strong> (+$300 c/u)</div>
      <div class="qty-ctrl">
        <button id="cheDec" class="qtybtn">-</button>
        <span id="cheVal" style="font-weight:bold; min-width:20px; text-align:center">0</span>
        <button id="cheInc" class="qtybtn">+</button>
      </div>
    </div>

    <div class="field" style="margin-top:25px">
      <label>Notas / Aclaraciones</label>
      <textarea id="notes" placeholder="Ej: Sin pepinillos, sin salsa..."></textarea>
      <div id="notesCount" class="muted" style="text-align:right">0/200</div>
    </div>

    <div class="row" style="margin-top:25px; border-top:1px solid #eee; padding-top:15px">
      <span style="font-size:14px; color:#555">Total √≠tem:</span>
      <span id="unitPreview" style="font-weight:900; font-size:22px; color:var(--primary)"></span>
    </div>

    <div class="row" style="margin-top:20px; gap:10px">
      <button class="btn" id="btnCancel" style="flex:1">Cancelar</button>
      <button class="btn primary" id="btnAdd" style="flex:1">AGREGAR AL CARRITO</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ============= CONFIG FIREBASE ============= */
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const $ = s => document.querySelector(s);
const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
const FALLBACK_IMG = "images/logo.png";

const EXTRA_PRICE_PATTY   = 2500;
const EXTRA_PRICE_CHEDDAR = 300;

/* ============= MENU ============= */
let PRODUCTS = { burgers: [], drinks: [], sides: [] };
let MENU_ORDER = {};
let availability = new Map();

db.collection("config").doc("menuOrder").onSnapshot(snap=>{
  MENU_ORDER = snap.exists ? snap.data() : {};
  mountMenu();
});

const isAvailable = id => availability.get(id) !== false;

db.collection("products").onSnapshot(snap=>{
  availability.clear();
  PRODUCTS = { burgers: [], drinks: [], sides: [] };
  snap.forEach(doc=>{
    const d = doc.data();
    const item = {
      id: doc.id,
      name: d.name,
      price: d.price,
      img: d.img || FALLBACK_IMG,
      description: d.description || "",
      category: d.category,
      kind: d.kind || ""
    };
    if(d.available === false) availability.set(doc.id, false);
    const cat = (d.category||"").toLowerCase();
    if(cat.includes("burger") || cat.includes("hamburguesa")) PRODUCTS.burgers.push(item);
    else if(cat.includes("drink") || cat.includes("bebida")) PRODUCTS.drinks.push(item);
    else if(cat.includes("side") || cat.includes("guarnicion") || cat.includes("papas")) PRODUCTS.sides.push(item);
  });
  mountMenu();
});

function orderedList(category, arr){
  const order = MENU_ORDER[category] || [];
  const map = new Map(order.map((id,i)=>[id,i]));
  return [...arr].sort((a,b)=>{
    const A = map.has(a.id) ? map.get(a.id) : 9999;
    const B = map.has(b.id) ? map.get(b.id) : 9999;
    return A - B;
  });
}

const elBurgersGrid = $("#burgersGrid");
const elDrinksGrid  = $("#drinksGrid");
const elSidesGrid   = $("#sidesGrid");

function renderCard(item){
  const ok = isAvailable(item.id);
  const card = document.createElement("div");
  card.className = "card";
  if (!ok) card.style.opacity = ".45";

  card.innerHTML = `
    <img src="${item.img}" onerror="this.src='${FALLBACK_IMG}'">
    <div class="content">
      <h3>${item.name}</h3>
      ${item.description ? `<div class="muted" style="margin-bottom:auto">${item.description}</div>` : "<div style='margin-bottom:auto'></div>"}
      <div class="row">
        <span class="price">${money(item.price)}</span>
        <button class="btn addBtn" ${ok?"":"disabled"}>AGREGAR</button>
      </div>
    </div>
  `;

  const btn = card.querySelector(".addBtn");
  const cat = (item.category||"").toLowerCase();

  if(cat.includes("bebida") || cat.includes("drink")){
    btn.onclick = ()=>{
      if(!cart.drink[item.id]) cart.drink[item.id]={qty:0,item};
      cart.drink[item.id].qty++;
      renderCart();
    };
  }
  else if(cat.includes("guarnicion") || cat.includes("side") || cat.includes("papas")){
    btn.onclick = ()=>{
      if(!cart.side[item.id]) cart.side[item.id]={qty:0,item};
      cart.side[item.id].qty++;
      renderCart();
    };
  }
  else{
    // Hamburguesa -> Abre modal
    btn.onclick = ()=> openCustomize(item);
  }
  return card;
}

function mountMenu(){
  elBurgersGrid.innerHTML = ""; elDrinksGrid.innerHTML = ""; elSidesGrid.innerHTML = "";
  orderedList("hamburguesas", PRODUCTS.burgers).forEach(x=> elBurgersGrid.appendChild(renderCard(x)));
  orderedList("bebidas", PRODUCTS.drinks).forEach(x=> elDrinksGrid.appendChild(renderCard(x)));
  orderedList("guarniciones", PRODUCTS.sides).forEach(x=> elSidesGrid.appendChild(renderCard(x)));
}

/* ============= CARRITO ============= */
let cart = { burger:{}, drink:{}, side:{} };

function renderCart(){
  let html="";
  let total=0;
  const wrap = $("#cartItems");
  const totalEl=$("#cartTotal");

  // Hamburguesas
  for(const id in cart.burger){
    const b = cart.burger[id];
    const unit = b.item.price + b.extras.patty * EXTRA_PRICE_PATTY + b.extras.cheddar * EXTRA_PRICE_CHEDDAR;
    total += unit * b.qty;

    const extras=[];
    // VALIDACION VISUAL DE PAPAS
    if(b.fries) {
        extras.push(`üçü ${b.fries}`);
    } else {
        // Si no tiene papas, mostramos alerta roja
        extras.push(`<span class="missing-fries">‚ö†Ô∏è ELEGIR PAPAS</span>`);
    }

    if(b.extras.patty) extras.push("+"+b.extras.patty+" carne");
    if(b.extras.cheddar) extras.push("+"+b.extras.cheddar+" cheddar");
    if(b.notes) extras.push(`üìù "${b.notes}"`);

    html += `
      <div class="cart-item">
        <div class="cart-item-info">
          <span class="cart-item-name">${b.qty}√ó ${b.item.name}</span>
          <div class="cart-item-desc">${extras.join(" <br> ")}</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end">
           <span class="cart-item-price">${money(unit * b.qty)}</span>
           <div class="cart-actions">
             <button class="btn-icon" onclick="editBurger('${id}')" title="Editar">‚úèÔ∏è</button>
             <button class="btn-icon" onclick="removeFromCart('${id}', 'burger')" style="color:#b00" title="Eliminar">‚úï</button>
           </div>
        </div>
      </div>
    `;
  }

  // Bebidas
  for(const id in cart.drink){
    const d = cart.drink[id];
    total += d.item.price * d.qty;
    html += `
      <div class="cart-item">
        <div class="cart-item-info">
          <span class="cart-item-name">${d.qty}√ó ${d.item.name}</span>
          <div class="cart-item-desc">Bebida</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end">
           <span class="cart-item-price">${money(d.item.price*d.qty)}</span>
           <div class="cart-actions">
             <button class="btn-icon" onclick="removeFromCart('${id}', 'drink')" style="color:#b00">‚úï</button>
           </div>
        </div>
      </div>
    `;
  }

  // Guarniciones
  for(const id in cart.side){
    const s = cart.side[id];
    total += s.item.price * s.qty;
    html += `
      <div class="cart-item">
        <div class="cart-item-info">
          <span class="cart-item-name">${s.qty}√ó ${s.item.name}</span>
          <div class="cart-item-desc">Extra</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:flex-end">
           <span class="cart-item-price">${money(s.item.price*s.qty)}</span>
           <div class="cart-actions">
             <button class="btn-icon" onclick="removeFromCart('${id}', 'side')" style="color:#b00">‚úï</button>
           </div>
        </div>
      </div>
    `;
  }

  wrap.innerHTML = html || `<div style="text-align:center;padding:40px 0;color:#999;font-size:16px">üõí Tu carrito est√° vac√≠o</div>`;
  totalEl.textContent = money(total);
}

/* ============= MODAL PERSONALIZAR ============= */
let currentItem=null;

function openCustomize(item){
  currentItem=item;
  $("#patVal").textContent="0";
  $("#cheVal").textContent="0";
  $("#notes").value="";
  $("#notesCount").textContent="0/200";
  // Resetear radios
  document.querySelectorAll("input[name='fries']").forEach(x=> x.checked=false);

  const name=item.name.toLowerCase();
  $("#rowPatties").style.display = name.includes("doble") ? "flex":"none";
  $("#rowCheddar").style.display = (name.includes("doble")||name.includes("pollo")) ? "flex":"none";
  $("#modTitle").textContent = "Personalizar " + item.name;

  updatePreview();
  $("#overlayCustomize").style.display="flex";
  
  // Asignar funci√≥n de AGREGAR NUEVO
  $("#btnAdd").onclick = addItemFromModal;
  $("#btnAdd").textContent = "AGREGAR AL CARRITO";
}

function removeFromCart(id, type){
  if(type === "burger") delete cart.burger[id];
  if(type === "drink") delete cart.drink[id];
  if(type === "side") delete cart.side[id];
  renderCart();
}

function editBurger(id){
  const b = cart.burger[id];
  if(!b) return;
  currentItem = b.item;

  document.querySelectorAll("input[name='fries']").forEach(x=> x.checked = (x.value === b.friesRaw));
  $("#patVal").textContent = b.extras.patty;
  $("#cheVal").textContent = b.extras.cheddar;
  $("#notes").value = b.notes || "";
  $("#notesCount").textContent = (b.notes || "").length + "/200";
  $("#modTitle").textContent = "Editar " + b.item.name;

  const name = b.item.name.toLowerCase();
  $("#rowPatties").style.display = name.includes("doble") ? "flex" : "none";
  $("#rowCheddar").style.display = (name.includes("doble") || name.includes("pollo")) ? "flex" : "none";

  updatePreview();
  $("#overlayCustomize").style.display = "flex";

  // Asignar funci√≥n de GUARDAR CAMBIOS
  $("#btnAdd").textContent = "GUARDAR CAMBIOS";
  $("#btnAdd").onclick = () => {
    // Si no selecciona nada, friesRaw es undefined
    let friesRaw = document.querySelector("input[name='fries']:checked")?.value;
    let friesName = null;
    
    if(friesRaw === "con_sazon") friesName = "Sazonadas";
    else if(friesRaw === "con_sal") friesName = "Con sal";
    else if(friesRaw === "sin_sal") friesName = "Sin sal";
    // Si es undefined, friesName queda null (y activar√° la alerta en el carrito)

    cart.burger[id] = {
      ...b,
      fries: friesName,
      friesRaw: friesRaw,
      extras:{ patty:+$("#patVal").textContent, cheddar:+$("#cheVal").textContent },
      notes: $("#notes").value.trim()
    };

    $("#overlayCustomize").style.display = "none";
    renderCart();
  };
}

const addItemFromModal = ()=>{
  // Permitir agregar SIN seleccionar papas (para seleccionarlas luego o alertar)
  let friesRaw = document.querySelector("input[name='fries']:checked")?.value;
  let friesName = null;
  
  if(friesRaw === "con_sazon") friesName = "Sazonadas";
  else if(friesRaw === "con_sal") friesName = "Con sal";
  else if(friesRaw === "sin_sal") friesName = "Sin sal";

  const entry={
    item:currentItem,
    qty:1,
    fries:friesName,
    friesRaw:friesRaw, // Puede ser undefined
    extras:{ patty:+$("#patVal").textContent, cheddar:+$("#cheVal").textContent },
    notes:$("#notes").value.trim()
  };

  const newId=currentItem.id+"_"+Date.now();
  cart.burger[newId]=entry;
  $("#overlayCustomize").style.display="none";
  renderCart();
};

function updatePreview(){
  const base=currentItem.price;
  const patt=Number($("#patVal").textContent);
  const che=Number($("#cheVal").textContent);
  $("#unitPreview").textContent = money(base + patt*EXTRA_PRICE_PATTY + che*EXTRA_PRICE_CHEDDAR);
}

$("#patInc").onclick=()=>{ let v=+$("#patVal").textContent; if(v<2){ $("#patVal").textContent=v+1; updatePreview(); } }
$("#patDec").onclick=()=>{ let v=+$("#patVal").textContent; if(v>0){ $("#patVal").textContent=v-1; updatePreview(); } }
$("#cheInc").onclick=()=>{ let v=+$("#cheVal").textContent; if(v<3){ $("#cheVal").textContent=v+1; updatePreview(); } }
$("#cheDec").onclick=()=>{ let v=+$("#cheVal").textContent; if(v>0){ $("#cheVal").textContent=v-1; updatePreview(); } }
$("#notes").oninput=()=> $("#notesCount").textContent = $("#notes").value.length+"/200";
$("#btnCancel").onclick=()=>{ $("#overlayCustomize").style.display="none"; };


/* ============= SLOTS (HORARIOS) ============= */
const SLOT_START = "19:15";
const SLOT_END   = "23:45";
const SLOT_INTERVAL_MIN = 15;
const GRAMOS_POR_BLOQUE = 1500;

function parseHHMM(str){
  const [h,m] = str.split(":").map(Number);
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
}
function formatHHMM(d){
  return d.toLocaleTimeString("es-AR", {hour:"2-digit",minute:"2-digit",hour12:false});
}
function slotKey(d){
  const y=d.getFullYear();
  const M=String(d.getMonth()+1).padStart(2,"0");
  const D=String(d.getDate()).padStart(2,"0");
  const H=String(d.getHours()).padStart(2,"0");
  const m=String(d.getMinutes()).padStart(2,"0");
  return `${y}${M}${D}_${H}${m}`;
}

let slotObjects=[];
let slotSubs=[];
let currentSlotIndex=0;

function loadSlotsMostrador(){
  slotSubs.forEach(u=>{ try{u();}catch{} }); slotSubs=[];
  const start=parseHHMM(SLOT_START);
  const end=parseHHMM(SLOT_END);
  const arr=[];
  let cur=new Date(start);
  while(cur<=end){ arr.push(new Date(cur)); cur=new Date(cur.getTime() + SLOT_INTERVAL_MIN*60000); }

  slotObjects = arr.map(d => ({ date:d, key:slotKey(d), gramsUsed:0, full:false }));
  $("#slotLabel").textContent="Cargando...";
  
  slotObjects.forEach(s=>{
    const ref = db.collection("slots_grams").doc(s.key);
    const unsub = ref.onSnapshot(doc=>{
      if(!doc.exists){ ref.set({gramsUsed:0},{merge:true}); }
      const d = doc.data()||{};
      s.gramsUsed = Number(d.gramsUsed || 0);
      s.full = s.gramsUsed >= GRAMOS_POR_BLOQUE;
      // Auto-select first free
      if(currentSlotIndex===0 && s.full) {
         const idx = slotObjects.findIndex(x => !x.full);
         if(idx !== -1) currentSlotIndex = idx;
      }
      renderSlotMostrador();
    });
    slotSubs.push(unsub);
  });
}

function renderSlotMostrador(){
  if(slotObjects.length===0){ $("#slotLabel").textContent="Cerrado"; return; }
  if(currentSlotIndex<0) currentSlotIndex=0;
  if(currentSlotIndex>=slotObjects.length) currentSlotIndex=slotObjects.length-1;

  const s = slotObjects[currentSlotIndex];
  const pretty = formatHHMM(s.date);
  $("#slotLabel").textContent = pretty;
  
  if(s.full){
    $("#slotLabel").style.background="#ffeaea";
    $("#slotLabel").style.borderColor="#d32f2f";
    $("#slotLabel").style.color="#d32f2f";
  } else {
    $("#slotLabel").style.background="#fff";
    $("#slotLabel").style.borderColor="#eaeaea";
    $("#slotLabel").style.color="#111";
  }

  window.selectedSlot = { key:s.key, pretty, iso:s.date.toISOString(), full:s.full };
  $("#miniSlotSub").textContent = "Seleccionado: " + pretty;
  $("#slotPrev").classList.toggle("disabled", currentSlotIndex===0);
  $("#slotNext").classList.toggle("disabled", currentSlotIndex===slotObjects.length-1);
}

$("#slotPrev").onclick = ()=>{ if(currentSlotIndex>0){ currentSlotIndex--; renderSlotMostrador(); } };
$("#slotNext").onclick = ()=>{ if(currentSlotIndex < slotObjects.length-1){ currentSlotIndex++; renderSlotMostrador(); } };
window.addEventListener("DOMContentLoaded", loadSlotsMostrador);


/* ============= ENVIAR ============= */
async function sendToFirestore(){
  const btn = $("#btnCargarPedido");
  
  // 1. VALIDACI√ìN NOMBRE
  const nombre=$("#inpNombre").value.trim();
  if(!nombre){ alert("‚ö†Ô∏è Ingres√° el nombre del cliente."); $("#inpNombre").focus(); return; }
  
  // 2. VALIDACI√ìN PAPAS FALTANTES
  for (const id in cart.burger) {
    const burger = cart.burger[id];
    const name = burger.item.name.toLowerCase();
    const isSimple = !name.includes("doble") && !name.includes("pollo");
    
    // Si no es simple y NO eligi√≥ papas
    if (!isSimple && !burger.friesRaw) {
      alert(`‚ö†Ô∏è FALTAN PAPAS:\nLa hamburguesa "${burger.item.name}" no tiene papas seleccionadas.\n\nPor favor, edit√° el √≠tem en el carrito.`);
      return;
    }
  }

  // 3. CARRITO VAC√çO
  if(Object.keys(cart.burger).length===0 && Object.keys(cart.drink).length===0 && Object.keys(cart.side).length===0){
    alert("El carrito est√° vac√≠o"); return;
  }

  // 4. HORARIO
  let slot = window.selectedSlot;
  if(!slot){ alert("Eleg√≠ un horario"); return; }

  // 5. BLOQUEO DOBLE CLICK
  if(btn.disabled) return;
  btn.disabled = true;
  const originalText = btn.textContent;
  btn.textContent = "Procesando...";

  // Pago (opcional)
  let pago=$("#selPago").value.trim();
  if(!pago) pago = "mostrador_sin_especificar"; 

  try {
      const items=[];
      let rawTotal=0;

      for(const id in cart.burger){
        const b=cart.burger[id];
        const unit = b.item.price + b.extras.patty*EXTRA_PRICE_PATTY + b.extras.cheddar*EXTRA_PRICE_CHEDDAR;
        rawTotal += unit*b.qty;
        items.push({
          type:"burger",
          id:b.item.id,
          name:b.item.name,
          qty:b.qty, quantity:b.qty,
          price:b.item.price,
          fries:b.fries,
          extras:b.extras,
          notes:b.notes||""
        });
      }

      for(const id in cart.drink){
        const d=cart.drink[id];
        rawTotal += d.item.price*d.qty;
        items.push({
          type:"drink",
          id:d.item.id,
          name:d.item.name,
          qty:d.qty, quantity:d.qty,
          price:d.item.price
        });
      }

      for(const id in cart.side){
        const s=cart.side[id];
        rawTotal += s.item.price*s.qty;
        items.push({
          type:"side",
          id:s.item.id,
          name:s.item.name,
          qty:s.qty, quantity:s.qty,
          price:s.item.price
        });
      }

      const refCounters=db.collection("config").doc("counters");
      const orderNumber=await db.runTransaction(async tx=>{
        const snap=await tx.get(refCounters);
        const cur=snap.exists?Number(snap.data().orderNumber||0):0;
        const nxt=cur+1;
        tx.set(refCounters,{orderNumber:nxt},{merge:true});
        return nxt;
      });

      const order = {
        orderNumber,
        number: orderNumber,
        nombre,
        telefono: $("#inpTel").value.trim(),
        entrega: "take_away",
        pago,
        notes: "",
        pickup_slot: slot.pretty,
        pickup_time: slot.iso,
        status: pago==="mercado_pago" ? "pending_payment" : "accepted",
        payment_status: pago==="mercado_pago" ? "pending_payment" : "paid",
        items,
        total: rawTotal,
        rawTotal,
        source: "mostrador",
        createdAt: new Date().toISOString(), 
        createdAt_server: firebase.firestore.FieldValue.serverTimestamp()
      };

      await db.collection("orders").doc().set(order);

      alert(`‚úÖ Pedido cargado: #${orderNumber}`);

      cart = { burger:{}, drink:{}, side:{} };
      renderCart();
      $("#inpNombre").value="";
      $("#selPago").value="";
      
  } catch(e) {
      console.error(e);
      alert("Error de conexi√≥n. Intente nuevamente.");
  } finally {
      btn.disabled = false;
      btn.textContent = originalText;
  }
}

$("#btnCargarPedido").onclick = sendToFirestore;
</script>
</body>
</html>
