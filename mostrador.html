<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <!-- ================= SESI√ìN COMPARTIDA ================= -->
  <script>
    const TTL_HOURS = 20;
    const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

    function sessionValid(){
      const ok = localStorage.getItem('rb_admin_ok') === 'true';
      const ts = Number(localStorage.getItem('rb_admin_t') || 0);
      return ok && (Date.now() - ts) < TTL_MS;
    }
    function bumpSession(){
      if(sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
    }
    function logout(){
      localStorage.removeItem('rb_admin_ok');
      localStorage.removeItem('rb_admin_t');
      localStorage.removeItem('rb_auth_v2');
      sessionStorage.removeItem('rb_auth_v2');
      location.replace('login.html');
    }

    (function requireSession(){
      if(!sessionValid()){
        const next = encodeURIComponent(
          (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
          (location.search || '') + (location.hash || '')
        );
        location.replace('login.html?next=' + next);
      } else bumpSession();
    })();

    ['click','keydown','focus','mousemove','touchstart','scroll']
      .forEach(evt => window.addEventListener(evt, bumpSession, {passive:true}));
  </script>

  <!-- ====================== ESTILOS COMPLETOS MOSTRADOR ======================== -->
  <style>
    :root{
      --primary:#645E52;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#eaeaea;
      --shadow:0 12px 34px rgba(0,0,0,.10);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
    }
    .brand img{
      width:36px;
      height:36px;
      border-radius:10px;
      background:#fff;
      object-fit:contain;
      margin-right:8px;
    }
    .spacer{ flex:1; }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ring);
      background:#fff;
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      color:inherit;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    .btn.disabled,
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    /* =================== GRID =================== */
    .container{
      max-width:1200px;
      margin:20px auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 380px;
      gap:18px;
    }

    @media (max-width:980px){
      .container{ grid-template-columns:1fr; }
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(220px,1fr));
      gap:16px;
    }
    @media (max-width:720px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }

    .card img{
      width:100%;
      height:200px;
      object-fit:cover;
      background:#eee;
    }

    .content{
      padding:12px;
    }

    .price{ font-weight:800; }

    /* =================== CARRITO =================== */
    .side{
      background:var(--card);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:14px;
      position:sticky;
      top:82px;
      height:fit-content;
    }

    .total{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:800;
      font-size:18px;
      margin:8px 0 10px;
    }

    .item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-bottom:1px solid #efefef;
    }

    .muted{ color:var(--muted); font-size:13px; }

    .qtybtn{
      border:1px solid var(--ring);
      background:#fff;
      border-radius:10px;
      padding:4px 8px;
      font-weight:800;
      cursor:pointer;
    }

    .btn-full{
      width:100%;
      margin-top:14px;
      padding:12px;
      border-radius:20px;
      background:var(--primary);
      color:white;
      border:none;
      font-weight:700;
      cursor:pointer;
      text-align:center;
    }

    /* =================== MODALES =================== */

    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.32);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .overlay.open{ display:flex; }

    .modal{
      background:#fff;
      border-radius:20px;
      box-shadow:var(--shadow);
      width:520px;
      max-width:92vw;
      padding:16px;
    }

    .slots-list{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .slots-list button{
      background:var(--primary);
      border:none;
      color:white;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
  </style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png"> Rhodes Burgers</a>
    <div class="spacer"></div>
    <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
    <a class="btn" href="finanzas.html">üìà Finanzas</a>
    <a class="btn" href="admin.html">‚öôÔ∏è Admin</a>
    <strong>Mostrador</strong>
  </div>
</header>

<main class="container">

  <section>
    <h1>Men√∫</h1>

    <h2>Hamburguesas</h2>
    <div id="burgersGrid" class="grid"></div>

    <h2 style="margin-top:20px">Bebidas</h2>
    <div id="drinksGrid" class="grid"></div>

    <h2 style="margin-top:20px">Guarniciones</h2>
    <div id="sidesGrid" class="grid"></div>
  </section>

  <aside class="side">
    <h3>Carrito</h3>

    <div class="total">
      <span>Total</span>
      <span id="cartTotal">$0</span>
    </div>

    <div id="cartItems" class="muted">Sin √≠tems.</div>

    <div class="field">
      <input id="inpNombre" type="text" placeholder="Nombre (requerido)">
    </div>

    <div class="field">
      <input id="inpTel" type="tel" placeholder="Tel√©fono (opcional)">
    </div>

    <div class="field">
      <select id="selPago">
        <option value="">M√©todo de pago</option>
        <option value="efectivo">Efectivo</option>
        <option value="mercado_pago">Mercado Pago</option>
        <option value="debito">D√©bito</option>
        <option value="transferencia">Transferencia</option>
      </select>
    </div>

    <button id="btnOpenSlots" class="btn-full">Seleccionar horario</button>

    <button id="btnSubmit" class="btn-full">Cargar pedido</button>

  </aside>

</main>
<!-- ===================== MODAL: Selecci√≥n de horarios ===================== -->
<div class="overlay" id="slotsOverlay">
  <div class="modal" style="width:520px;max-width:92vw">
    <h3>Elegir horario</h3>

    <div id="slotsQuickList" class="slots-list" style="margin-top:12px"></div>

    <div style="display:flex;justify-content:flex-end;margin-top:18px">
      <button id="closeSlots" class="btn">Cerrar</button>
    </div>
  </div>
</div>



<!-- ===================== MODAL: Personalizar Hamburguesa ===================== -->
<div class="overlay" id="overlay">
  <div class="modal">

    <h3 id="modTitle">Personalizar</h3>

    <!-- PAPAS -->
    <div class="rowx" style="align-items:flex-start;flex-direction:column;margin-top:10px">
      <div class="muted" style="font-weight:600">Papas</div>

      <div class="pills" id="friesOptions" style="display:flex;gap:10px;margin-top:6px">
        <label class="pill"><span>Sazonadas</span> <input type="radio" name="fries" value="con_sazon"></label>
        <label class="pill"><span>Con sal</span>  <input type="radio" name="fries" value="con_sal"></label>
        <label class="pill"><span>Sin sal</span>  <input type="radio" name="fries" value="sin_sal"></label>
      </div>

      <div id="friesStateNote" class="micro" style="margin-top:4px"></div>
      <div class="micro">Si no eleg√≠s, te lo preguntamos antes de cargar el pedido.</div>
    </div>

    <!-- Medallones extra -->
    <div class="rowx" id="rowPatties" style="display:none;margin-top:16px;justify-content:space-between">
      <div style="font-weight:600">Medallones extra <span class="muted">(+$2500 c/u)</span></div>
      <div class="qtybox" style="display:flex;align-items:center;gap:8px">
        <button id="patDec" class="qtybtn">-</button>
        <span id="patVal">0</span>
        <button id="patInc" class="qtybtn">+</button>
      </div>
    </div>

    <!-- Cheddar extra -->
    <div class="rowx" id="rowCheddar" style="display:none;margin-top:16px;justify-content:space-between">
      <div style="font-weight:600">Fetas de cheddar <span class="muted">(+$300 c/u)</span></div>
      <div class="qtybox" style="display:flex;align-items:center;gap:8px">
        <button id="cheDec" class="qtybtn">-</button>
        <span id="cheVal">0</span>
        <button id="cheInc" class="qtybtn">+</button>
      </div>
    </div>

    <!-- PREVIEW -->
    <div class="rowx" id="rowPreview" style="margin-top:20px;justify-content:flex-end">
      <span class="muted">Subtotal unitario:</span>
      <span class="preview" id="unitPreview" style="font-weight:800">$0</span>
    </div>

    <!-- NOTAS -->
    <div class="rowx" style="align-items:flex-start;flex-direction:column;margin-top:20px">
      <label style="font-weight:600">Notas (opcional)</label>
      <textarea id="notes" class="textarea" maxlength="200"
        placeholder="Sin cebolla, extra salsa..." 
        style="width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px;min-height:90px"
        oninput="autoGrow(this); updateCount(this)">
      </textarea>
      <div class="field-foot"><span id="notesCount">0/200</span></div>
    </div>

    <!-- BOTONES -->
    <div class="rowx" style="justify-content:flex-end;margin-top:20px;gap:10px">
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn primary" id="btnAdd">Guardar</button>
    </div>

  </div>
</div>
<script>
/* ========================= HELPERS ========================= */
const $ = s => document.querySelector(s);
const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
const FALLBACK_IMG = "images/logo.png";

/* ======================= PRODUCTOS ======================= */
let PRODUCTS = { burgers: [], drinks: [], sides: [] };

/* ============================================================
      üî• ORDEN VISUAL DEL MEN√ö desde admin.html
============================================================ */
let MENU_ORDER = {}; // ejemplo: { hamburguesas:["id1","id2"], bebidas:["idA","idB"] }

db.collection("config").doc("menuOrder").onSnapshot(snap=>{
  MENU_ORDER = snap.exists ? snap.data() : {};
  mountMenu();  // re-render autom√°tico cuando cambian posiciones
});

/* ============================================================
      üî• ORDENAR LISTA SEG√öN menuOrder
============================================================ */
function orderedList(category, arr){
  const order = MENU_ORDER[category] || [];
  const map   = new Map(order.map((id,i)=>[id,i]));

  return [...arr].sort((a,b)=>{
    const A = map.has(a.id) ? map.get(a.id) : 9999;
    const B = map.has(b.id) ? map.get(b.id) : 9999;
    return A - B;
  });
}

/* ======================= DISPONIBILIDAD ======================= */
let availability = new Map();
const isAvailable = id => availability.get(id) !== false;

db.collection("products").onSnapshot(snap=>{
  availability.clear();
  PRODUCTS = { burgers: [], drinks: [], sides: [] };

  snap.forEach(doc=>{
    const d = doc.data();
    availability.set(doc.id, d.available !== false);

    if(!d.category) return;

    const item = {
      id: doc.id,
      name: d.name || "",
      price: d.price || 0,
      img: d.img || FALLBACK_IMG,
      description: d.description || "",
      category: d.category,
      kind: d.kind || "simple"
    };

    if(d.category === "burger" || d.category === "hamburguesas")
      PRODUCTS.burgers.push(item);

    if(d.category === "drink" || d.category === "bebidas")
      PRODUCTS.drinks.push(item);

    if(d.category === "guarniciones" || d.category === "side")
      PRODUCTS.sides.push(item);
  });

  mountMenu();
});

/* ======================= ELEMENTOS GRID ======================= */
const elBurgersGrid = $("#burgersGrid");
const elDrinksGrid  = $("#drinksGrid");
const elSidesGrid   = $("#sidesGrid");

/* ======================= CARD ======================= */
function renderCard(item){
  const ok = isAvailable(item.id);

  const card = document.createElement("div");
  card.className = "card";
  card.dataset.id = item.id;
  card.dataset.soldout = ok ? "0" : "1";

  card.innerHTML = `
    <div class="imgwrap">
      <img src="${item.img}" onerror="this.src='${FALLBACK_IMG}'">
      ${ok ? "" : `<div class="soldout-badge">SIN STOCK</div>`}
    </div>

    <div class="content">
      <h3 style="margin:4px 0 6px">${item.name}</h3>
      ${item.description ? `<div class="muted">${item.description}</div>` : ""}

      <div class="row">
        <span class="price">${money(item.price)}</span>
        <button class="btn addBtn" ${ok?"":"disabled"}>Agregar</button>
      </div>
    </div>
  `;

  const btn = card.querySelector(".addBtn");

  // BEBIDAS
  if(item.category === "drink"){
    btn.onclick = ()=>{
      if(!isAvailable(item.id)) return;
      if(!cart.drink[item.id]) cart.drink[item.id] = { qty: 0, item };
      cart.drink[item.id].qty++;
      renderCart();
    };
  }

  // GUARNICIONES
  else if(item.category === "guarniciones" || item.category === "side"){
    btn.onclick = ()=>{
      if(!isAvailable(item.id)) return;
      if(!cart.side[item.id]) cart.side[item.id] = { qty: 0, item };
      cart.side[item.id].qty++;
      renderCart();
    };
  }

  // HAMBURGUESAS (abre modal)
  else {
    btn.onclick = ()=>{
      if(!isAvailable(item.id)) return;
      openCustomize(item, null, "add");
    };
  }

  return card;
}

/* ======================= ORDENAR + MONTAR MEN√ö ======================= */
function mountMenu(){
  elBurgersGrid.innerHTML = "";
  elDrinksGrid.innerHTML  = "";
  elSidesGrid.innerHTML   = "";

  const burgersOrdered = orderedList("hamburguesas", PRODUCTS.burgers);
  const drinksOrdered  = orderedList("bebidas", PRODUCTS.drinks);
  const sidesOrdered   = orderedList("guarniciones", PRODUCTS.sides);

  burgersOrdered.forEach(b=> elBurgersGrid.appendChild(renderCard(b)));
  drinksOrdered.forEach(d=> elDrinksGrid.appendChild(renderCard(d)));
  sidesOrdered.forEach(s=> elSidesGrid.appendChild(renderCard(s)));

  refreshAvailabilityUI();
}

/* ======================= DISPONIBILIDAD UI ======================= */
function refreshAvailabilityUI(){
  document.querySelectorAll('.card[data-id]').forEach(card=>{
    const id = card.dataset.id;
    const ok = isAvailable(id);

    card.dataset.soldout = ok ? "0" : "1";

    const btn = card.querySelector(".addBtn");
    if(btn){
      btn.disabled = !ok;
      btn.classList.toggle("disabled", !ok);
    }

    let badge = card.querySelector(".soldout-badge");
    if(!ok){
      if(!badge){
        badge = document.createElement("div");
        badge.className = "soldout-badge";
        badge.textContent = "SIN STOCK";
        card.querySelector(".imgwrap").appendChild(badge);
      }
    } else {
      if(badge) badge.remove();
    }
  });
}
</script>
<script>
/* ======================= CARRITO ======================= */
let cart = { burger:{}, drink:{}, side:{} };

const cartItems = $("#cartItems");
const cartTotal = $("#cartTotal");

const EXTRA_PRICE_PATTY   = 2500;
const EXTRA_PRICE_CHEDDAR = 300;

/* ======================= TOTAL ======================= */
function calcTotal(){
  let t = 0;

  // Hamburguesas
  for(const b of Object.values(cart.burger)){
    const base  = b.item.price;
    const patty = (b.extras?.patty||0) * EXTRA_PRICE_PATTY;
    const che   = (b.extras?.cheddar||0) * EXTRA_PRICE_CHEDDAR;

    t += (base + patty + che) * b.qty;
  }

  // Bebidas
  for(const d of Object.values(cart.drink)){
    t += d.item.price * d.qty;
  }

  // Guarniciones
  for(const s of Object.values(cart.side)){
    t += s.item.price * s.qty;
  }

  return t;
}

/* ======================= UTILS ======================= */
function friesName(v){
  if(!v) return "‚Äî";
  if(v === "con_sazon") return "Sazonadas";
  if(v === "con_sal")   return "Con sal";
  if(v === "sin_sal")   return "Sin sal";
  return v;
}

/* ======================= RENDER CARRITO ======================= */
function renderCart(){
  const out = [];

  /* ======== HAMBURGUESAS ======== */
  for(const [key,o] of Object.entries(cart.burger)){
    const unit = o.item.price
               + (o.extras?.patty||0)*EXTRA_PRICE_PATTY
               + (o.extras?.cheddar||0)*EXTRA_PRICE_CHEDDAR;

    out.push(`
      <div class="item">
        <div>
          <strong>${o.item.name}</strong>

          <div class="muted">Papas: ${friesName(o.fries)} ${!o.fries?'<span class="badge-warn">Elegir</span>':''}</div>

          ${o.extras?.patty ? `<div class="muted">+${o.extras.patty} medall√≥n(es)</div>` : ''}
          ${o.extras?.cheddar ? `<div class="muted">+${o.extras.cheddar} cheddar</div>` : ''}
          ${o.notes ? `<div class="muted">Nota: ${o.notes}</div>` : ''}

          <button class="btn" style="margin-top:6px"
            onclick="editItem('burger','${encodeURIComponent(key)}')">‚úèÔ∏è Editar</button>
        </div>

        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn"
            onclick="changeQty('burger','${encodeURIComponent(key)}',-1)">-</button>

          <span>${o.qty}</span>

          <button class="qtybtn"
            onclick="changeQty('burger','${encodeURIComponent(key)}',1)">+</button>

          <span>${money(unit * o.qty)}</span>
        </div>
      </div>
    `);
  }

  /* ======== GUARNICIONES ======== */
  for(const [key,o] of Object.entries(cart.side)){
    out.push(`
      <div class="item">
        <div><strong>${o.item.name}</strong></div>

        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn"
            onclick="changeQty('side','${encodeURIComponent(key)}',-1)">-</button>

          <span>${o.qty}</span>

          <button class="qtybtn"
            onclick="changeQty('side','${encodeURIComponent(key)}',1)">+</button>

          <span>${money(o.item.price * o.qty)}</span>
        </div>
      </div>
    `);
  }

  /* ======== BEBIDAS ======== */
  for(const [key,o] of Object.entries(cart.drink)){
    out.push(`
      <div class="item">
        <div><strong>${o.item.name}</strong></div>

        <div style="display:flex;align-items:center;gap:8px">
          <button class="qtybtn"
            onclick="changeQty('drink','${encodeURIComponent(key)}',-1)">-</button>

          <span>${o.qty}</span>

          <button class="qtybtn"
            onclick="changeQty('drink','${encodeURIComponent(key)}',1)">+</button>

          <span>${money(o.item.price * o.qty)}</span>
        </div>
      </div>
    `);
  }

  cartItems.innerHTML = out.length ? out.join("") : "Sin √≠tems.";
  cartTotal.textContent = money(calcTotal());

  // Actualiza horarios si ya est√° montado (Bloque 5)
  if (typeof refreshSlotsUI === "function") refreshSlotsUI();
}

/* ======================= CAMBIAR CANTIDAD ======================= */
window.changeQty = function(type, encKey, delta){
  const key = decodeURIComponent(encKey);
  const bucket = cart[type];

  if(!bucket[key]) return;

  bucket[key].qty += delta;

  if(bucket[key].qty <= 0){
    delete bucket[key];
  }

  renderCart();
};

/* ======================= EDITAR ITEM (MODAL) ======================= */
window.editItem = function(type, encKey){
  if(type !== "burger") return;

  const key = decodeURIComponent(encKey);
  const data = cart.burger[key];

  if(!data) return;

  openCustomize(data.item, key, "edit");
};
</script>
<script>
/* ============================================================
      === BLOQUE 5 ‚Äî HORARIOS + CARGAR PEDIDO ===
============================================================ */

/* ========================= HORARIOS ========================= */

const slotsOverlay = $("#slotsOverlay");
const slotsQuickList = $("#slotsQuickList");
$("#closeSlots").onclick = ()=> slotsOverlay.classList.remove("open");

let selectedSlot = null;

/* genera horarios cada 10 min */
function generateSlots(){
  const slots = [];
  const now = new Date();

  // M√≠nimo 10 minutos m√°s tarde
  now.setMinutes(now.getMinutes() + 10);

  // Horario l√≠mite 23:59
  const end = new Date();
  end.setHours(23,59,0,0);

  while (now <= end){
    const hh = now.getHours().toString().padStart(2,'0');
    const mm = now.getMinutes().toString().padStart(2,'0');
    slots.push(`${hh}:${mm}`);
    now.setMinutes(now.getMinutes() + 10);
  }

  return slots;
}

/* Renderiza la lista */
function refreshSlotsUI(){
  const slots = generateSlots();
  slotsQuickList.innerHTML = "";

  slots.forEach(s=>{
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.style.margin = "4px 0";
    btn.textContent = s;

    btn.onclick = ()=>{
      selectedSlot = s;
      slotsOverlay.classList.remove("open");
      $("#slotView").textContent = s;
    };

    slotsQuickList.appendChild(btn);
  });
}

/* ===================== UI en el costado ===================== */

const sideBox = document.querySelector(".side");

const scheduleUI = document.createElement("div");
scheduleUI.style.marginTop = "14px";
scheduleUI.innerHTML = `
  <div class="field">
    <label style="font-weight:600">Horario de retiro</label>
    <button id="btnPickSlot" class="btn" style="width:100%; margin-top:6px">
      Elegir horario
    </button>
    <div class="muted" style="margin-top:4px">Seleccionado: <strong id="slotView">‚Äî</strong></div>
  </div>

  <button id="btnCheckout" class="btn primary" style="margin-top:16px; width:100%">
    Cargar pedido
  </button>
`;

sideBox.appendChild(scheduleUI);

$("#btnPickSlot").onclick = ()=>{
  refreshSlotsUI();
  slotsOverlay.classList.add("open");
};

/* ============================================================
      === VALIDAR Y ENVIAR A FIRESTORE ===
============================================================ */

$("#btnCheckout").onclick = async ()=>{

  /* ======= Validaci√≥n ======= */

  if(Object.keys(cart.burger).length === 0 &&
     Object.keys(cart.side).length   === 0 &&
     Object.keys(cart.drink).length  === 0){
    alert("El carrito est√° vac√≠o.");
    return;
  }

  const nombre = $("#inpNombre").value.trim();
  if(!nombre){
    alert("Falta el nombre.");
    return;
  }

  const pago = $("#selPago").value;
  if(!pago){
    alert("Seleccion√° m√©todo de pago.");
    return;
  }

  // Debe elegirse papas en todas las hamburguesas
  for(const o of Object.values(cart.burger)){
    if(!o.fries){
      alert(`Falta elegir tipo de papas en: ${o.item.name}`);
      return;
    }
  }

  if(!selectedSlot){
    alert("Seleccion√° un horario.");
    return;
  }

  /* ======= Armar pedido ======= */

  const pedido = {
    nombre,
    telefono: $("#inpTel").value.trim() || null,
    pago,
    horario: selectedSlot,
    total: calcTotal(),
    estado: "pendiente",
    timestamp: Date.now(),

    burgers: Object.entries(cart.burger).map(([key,o])=>({
      id: o.item.id,
      nombre: o.item.name,
      qty: o.qty,
      fries: o.fries,
      extras: o.extras,
      notes: o.notes,
      subtotal: (o.item.price
               + (o.extras?.patty||0)*EXTRA_PRICE_PATTY
               + (o.extras?.cheddar||0)*EXTRA_PRICE_CHEDDAR) * o.qty
    })),

    sides: Object.entries(cart.side).map(([key,o])=>({
      id: o.item.id,
      nombre: o.item.name,
      qty: o.qty,
      subtotal: o.item.price * o.qty
    })),

    drinks: Object.entries(cart.drink).map(([key,o])=>({
      id: o.item.id,
      nombre: o.item.name,
      qty: o.qty,
      subtotal: o.item.price * o.qty
    }))
  };

  /* ======= Guardar en Firestore ======= */
  try {
    await db.collection("pedido_local").add(pedido);

    alert("Pedido cargado correctamente.");

    // Reset
    cart = { burger:{}, drink:{}, side:{} };
    selectedSlot = null;

    $("#slotView").textContent = "‚Äî";
    $("#inpNombre").value = "";
    $("#inpTel").value = "";
    $("#selPago").value = "";

    renderCart();

  } catch (err){
    console.error(err);
    alert("Error guardando el pedido.");
  }
};
</script>
