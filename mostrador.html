<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mostrador ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#645E52;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#eaeaea;
      --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .topbar{
      max-width:1200px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
    }
    .brand img{
      width:36px;height:36px;object-fit:contain;margin-right:8px;border-radius:10px;
    }
    .spacer{ flex:1; }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--ring);
      background:#fff;
      padding:10px 16px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      color:inherit;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }

    .container{
      max-width:1200px;
      margin:20px auto;
      padding:0 12px;
      display:grid;
      grid-template-columns:1fr 420px;
      gap:18px;
    }
    @media(max-width:980px){
      .container{ grid-template-columns:1fr; }
    }

    h1{ font-size:26px;margin:10px 0 12px; }
    h2{ font-size:20px;margin:18px 0 10px; }

    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(220px,1fr));
      gap:16px;
    }
    @media(max-width:720px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .card img{
      width:100%;
      height:200px;
      object-fit:cover;
    }

    .content{ padding:12px; }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
    }
    .price{ font-weight:800; }

    /* ‚≠ê PANEL DERECHO (CARRITO FIJO) */
    aside.side{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      position:sticky;
      top:80px;
      height:calc(100vh - 100px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #cartScrollArea{
      flex:1;
      overflow-y:auto;
      margin-bottom:16px;
      padding-right:6px;
    }
    #cartItems{ flex:1;padding-right:8px; }

    .field input, .field select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--ring);
      font-size:15px;
    }

    .field label{
      display:block;
      font-weight:600;
      margin-bottom:4px;
    }
    .muted{ color:var(--muted);font-size:13px; }

    .qtybtn{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--ring);
      font-weight:700;
      cursor:pointer;
      background:#fff;
    }

    .carousel{
      display:flex;
      align-items:center;
      gap:12px;
      margin-top:14px;
    }
    .arrow{
      width:44px;height:44px;
      display:inline-grid;
      place-items:center;
      background:#fff;
      cursor:pointer;
      border-radius:10px;
      border:1px solid var(--ring);
      font-size:22px;
      font-weight:700;
      user-select:none;
    }
    .arrow.disabled{ opacity:.35;cursor:not-allowed; }

    .slot-display{
      min-width:160px;
      padding:12px 16px;
      background:#fff;
      border-radius:12px;
      border:1px solid var(--ring);
      text-align:center;
      font-weight:800;
      font-size:18px;
    }

    /* MODAL */
    .overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:99999;
    }
    .modal{
      width:480px;max-width:90%;
      background:white;
      border-radius:22px;
      padding:28px;
      box-shadow:0 15px 40px rgba(0,0,0,.25);
      animation:popup .25s ease-out;
    }
    @keyframes popup{
      from{ transform:scale(.92); opacity:0 }
      to{ transform:scale(1); opacity:1 }
    }
    textarea{
      width:100%;min-height:90px;padding:14px 16px;border-radius:14px;
      border:1px solid #dfd9d0;background:#fcfaf7;font-size:15px;
      resize:none;
    }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png">Rhodes Burgers</a>
    <div class="spacer"></div>

    <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
    <a class="btn" href="finanzas.html">üìà Finanzas</a>
    <a class="btn" href="admin.html">‚öôÔ∏è Admin</a>
    <strong>Mostrador</strong>
  </div>
</header>

<main class="container">

  <!-- PRODUCTOS -->
  <section>
    <h1>Men√∫</h1>

    <h2>Hamburguesas</h2>
    <div id="burgersGrid" class="grid"></div>

    <h2 style="margin-top:20px">Bebidas</h2>
    <div id="drinksGrid" class="grid"></div>

    <h2 style="margin-top:20px">Guarniciones</h2>
    <div id="sidesGrid" class="grid"></div>
  </section>
  <!-- CARRITO -->
  <aside class="side">
    <h2 style="margin-top:0">Carrito</h2>

    <div class="total">
      <span>Total</span>
      <span id="cartTotal">$0</span>
    </div>

    <div id="cartScrollArea">
      <div id="cartItems" class="muted">Sin √≠tems.</div>
    </div>

    <div class="field">
      <label>Nombre (requerido)</label>
      <input id="inpNombre" type="text" placeholder="Ej: Juan">
    </div>

    <div class="field">
      <label>Tel√©fono (opcional)</label>
      <input id="inpTel" type="tel" placeholder="Ej: 1123456789">
    </div>

    <div class="field">
      <label>M√©todo de pago</label>
      <select id="selPago">
        <option value=""></option>
        <option value="efectivo">Efectivo</option>
        <option value="mercado_pago">Mercado Pago</option>
        <option value="debito">D√©bito</option>
        <option value="transferencia">Transferencia</option>
      </select>
    </div>

    <h3 style="margin-top:24px">Horario de retiro</h3>

    <div class="carousel">
      <div class="arrow" id="slotPrev">‚óÄ</div>
      <div class="slot-display" id="slotLabel">--:--</div>
      <div class="arrow" id="slotNext">‚ñ∂</div>
    </div>

    <label style="margin-top:12px;display:block;font-weight:600;font-size:14px">
      Horario personalizado
    </label>
    <input id="manualTime" type="time"
      style="margin-top:4px;padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:15px;width:160px">

    <div id="miniSlotSub" class="muted" style="margin-top:8px;font-size:14px;">
      Seleccionado: ‚Äî
    </div>

    <button id="btnCargarPedido" class="btn primary" style="width:100%;margin-top:18px">
      Cargar pedido
    </button>

  </aside>
</main>
<!-- MODAL -->
<div class="overlay" id="overlayCustomize">
  <div class="modal">
    <h3 id="modTitle">Personalizar</h3>

    <div class="field">
      <label>Papas (obligatorio)</label>
      <div style="display:flex;gap:12px;margin-top:6px">
        <label class="chip"><input type="radio" name="fries" value="con_sazon"> Sazonadas</label>
        <label class="chip"><input type="radio" name="fries" value="con_sal"> Con sal</label>
        <label class="chip"><input type="radio" name="fries" value="sin_sal"> Sin sal</label>
      </div>
    </div>

    <div id="rowPatties" class="row" style="display:none;margin-top:22px;justify-content:space-between">
      <strong>Medallones extra</strong>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="patDec" class="qtybtn">-</button>
        <span id="patVal">0</span>
        <button id="patInc" class="qtybtn">+</button>
      </div>
    </div>

    <div id="rowCheddar" class="row" style="display:none;margin-top:18px;justify-content:space-between">
      <strong>Fetas cheddar extra</strong>
      <div style="display:flex;gap:10px;align-items:center">
        <button id="cheDec" class="qtybtn">-</button>
        <span id="cheVal">0</span>
        <button id="cheInc" class="qtybtn">+</button>
      </div>
    </div>

    <div class="row" style="margin-top:24px;justify-content:flex-end">
      <span class="muted" style="margin-right:6px">Subtotal unitario:</span>
      <span id="unitPreview" style="font-weight:800;font-size:20px"></span>
    </div>

    <div class="field" style="margin-top:22px">
      <label>Notas (opcional)</label>
      <textarea id="notes" maxlength="200" placeholder="Sin cebolla..."></textarea>
      <div id="notesCount" class="muted">0/200</div>
    </div>

    <div class="row" style="margin-top:26px;justify-content:flex-end;gap:10px">
      <button class="btn" id="btnCancel">Cancelar</button>
      <button class="btn primary" id="btnAdd">Agregar</button>
    </div>
  </div>
</div>
<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ================================
     FIREBASE INIT
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================================
     HELPERS / CONST
================================ */
const $ = s => document.querySelector(s);
const money = n => (Number(n)||0).toLocaleString("es-AR",{
  style:"currency",currency:"ARS",maximumFractionDigits:0
});
const FALLBACK_IMG = "images/logo.png";

const EXTRA_PRICE_PATTY   = 2500;
const EXTRA_PRICE_CHEDDAR = 300;

/* ================================
     MEN√ö / PRODUCTOS (Firebase)
================================ */
let PRODUCTS = { burgers: [], drinks: [], sides: [] };
let MENU_ORDER = {};
let availability = new Map();

/* Orden creado desde admin */
db.collection("config").doc("menuOrder").onSnapshot(snap=>{
  MENU_ORDER = snap.exists ? snap.data() : {};
  mountMenu();
});

/* Disponibilidad por producto */
const isAvailable = id => availability.get(id) !== false;

/* Productos reales desde Firestore */
db.collection("products").onSnapshot(snap=>{
  availability.clear();
  PRODUCTS = { burgers: [], drinks: [], sides: [] };

  snap.forEach(doc=>{
    const d = doc.data();
    const item = {
      id: doc.id,
      name: d.name,
      price: d.price,
      img: d.img || FALLBACK_IMG,
      description: d.description || "",
      category: d.category,
      kind: d.kind || ""
    };

    if(d.available === false) availability.set(doc.id, false);

    if(["burger","hamburguesas","hamburger"].includes(d.category))
      PRODUCTS.burgers.push(item);

    if(["drink","drinks","bebidas"].includes(d.category))
      PRODUCTS.drinks.push(item);

    if(["side","sides","guarniciones"].includes(d.category))
      PRODUCTS.sides.push(item);
  });

  mountMenu();
  refreshAvailabilityUI();
});

/* Mantener el orden configurado */
function orderedList(category, arr){
  const order = MENU_ORDER[category] || [];
  const orderMap = new Map(order.map((id,i)=>[id,i]));
  return [...arr].sort((a,b)=>{
    const A = orderMap.has(a.id) ? orderMap.get(a.id) : 9999;
    const B = orderMap.has(b.id) ? orderMap.get(b.id) : 9999;
    return A - B;
  });
}

/* Grids */
const elBurgersGrid = $("#burgersGrid");
const elDrinksGrid  = $("#drinksGrid");
const elSidesGrid   = $("#sidesGrid");

/* Render card */
function renderCard(item){
  const ok = isAvailable(item.id);

  const card = document.createElement("div");
  card.className = "card";
  card.dataset.id = item.id;

  if (!ok) card.dataset.soldout = "1";

  card.innerHTML = `
    <img src="${item.img}" onerror="this.src='${FALLBACK_IMG}'">
    <div class="content" style="${ok?"":"opacity:.45;filter:grayscale(100%)"}">
      <h3>${item.name}</h3>
      ${item.description ? `<div class="muted">${item.description}</div>` : ""}
      <div class="row">
        <span class="price">${money(item.price)}</span>
        <button class="btn addBtn" ${ok?"":"disabled"}>Agregar</button>
      </div>
    </div>
  `;

  const btn = card.querySelector(".addBtn");

  // bebidas
  if(["drink","drinks","bebidas"].includes(item.category)){
    btn.onclick = ()=>{
      if(!cart.drink[item.id]) cart.drink[item.id]={qty:0,item};
      cart.drink[item.id].qty++;
      renderCart();
    };
  }
  // guarniciones
  else if(["side","sides","guarniciones"].includes(item.category)){
    btn.onclick = ()=>{
      if(!cart.side[item.id]) cart.side[item.id]={qty:0,item};
      cart.side[item.id].qty++;
      renderCart();
    };
  }
  // hamburguesas
  else {
    btn.onclick = ()=> openCustomize(item);
  }

  return card;
}

/* Construir men√∫ */
function mountMenu(){
  elBurgersGrid.innerHTML = "";
  elDrinksGrid.innerHTML  = "";
  elSidesGrid.innerHTML   = "";

  orderedList("hamburguesas", PRODUCTS.burgers)
    .forEach(x=> elBurgersGrid.appendChild(renderCard(x)));

  orderedList("bebidas", PRODUCTS.drinks)
    .forEach(x=> elDrinksGrid.appendChild(renderCard(x)));

  orderedList("guarniciones", PRODUCTS.sides)
    .forEach(x=> elSidesGrid.appendChild(renderCard(x)));
}

/* Aplicar disponibilidad */
function refreshAvailabilityUI(){
  document.querySelectorAll(".addBtn").forEach(btn=>{
    if(btn.closest(".card").dataset.soldout === "1"){
      btn.disabled = true;
    }
  });
}

/* ================================
      CARRITO
================================ */
let cart = { burger:{}, drink:{}, side:{} };

/* Guardar */
function saveCart(){
  localStorage.setItem("rb_cart_mostrador", JSON.stringify(cart));
}

/* Cargar */
function loadCart(){
  try{
    const x = JSON.parse(localStorage.getItem("rb_cart_mostrador"));
    if(x) cart = x;
  }catch(e){}
}
loadCart();

cart = { burger:{}, drink:{}, side:{} };
localStorage.removeItem("rb_cart_mostrador");
renderCart();

/* Borrar ITEM */
function deleteItem(type, id){
  if(cart[type] && cart[type][id]){
    delete cart[type][id];
    renderCart();
  }
}

/* Render del carrito */
function renderCart(){
  saveCart();

  const wrap = $("#cartItems");
  const totalEl = $("#cartTotal");
  let html = "";
  let total = 0;

  const addLine = (type, id, name, qty, unit, extrasTxt="")=>{
    const line = qty * unit;
    total += line;

    const isBurger = type === "burger";

    html += `
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
        <div style="max-width:240px">
          <strong>${qty}√ó ${name}</strong><br>
          ${extrasTxt ? `<span class='muted'>${extrasTxt}</span>` : ""}
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <span>${money(line)}</span>
          <div style="display:flex;gap:6px">
            ${
              isBurger
                ? `<button onclick="editBurger('${id}')"
                           style="background:none;border:none;cursor:pointer;font-size:18px;color:#444"
                           title="Editar">‚úèÔ∏è</button>`
                : ""
            }
            <button onclick="deleteItem('${type}','${id}')"
                    style="background:none;border:none;cursor:pointer;font-size:18px;color:#a33"
                    title="Eliminar">üóëÔ∏è</button>
          </div>
        </div>
      </div>
    `;
  };

  /* Hamburguesas */
  for(const id in cart.burger){
    const b = cart.burger[id];
    const unit =
      b.item.price +
      b.extras.patty   * EXTRA_PRICE_PATTY +
      b.extras.cheddar * EXTRA_PRICE_CHEDDAR;

    const extras = [];
    if(b.fries) extras.push("Papas: " + b.fries);
    if(b.extras.patty)   extras.push("+"+b.extras.patty+" med");
    if(b.extras.cheddar) extras.push("+"+b.extras.cheddar+" cheddar");
    if(b.notes) extras.push("Nota: "+b.notes);

    addLine("burger", id, b.item.name, b.qty, unit, extras.join(" ¬∑ "));
  }

  /* Bebidas */
  for(const id in cart.drink){
    const d = cart.drink[id];
    addLine("drink", id, d.item.name, d.qty, d.item.price);
  }

  /* Guarniciones */
  for(const id in cart.side){
    const s = cart.side[id];
    addLine("side", id, s.item.name, s.qty, s.item.price);
  }

  wrap.innerHTML = html || "<span class='muted'>Sin √≠tems.</span>";
  totalEl.textContent = money(total);
}

/* ================================
      PERSONALIZAR BURGER
================================ */
let currentItem   = null;
let currentMode   = "add";
let currentEditId = null;

function resetCustomize(){
  $("#patVal").textContent = "0";
  $("#cheVal").textContent = "0";
  $("#notes").value = "";
  $("#notesCount").textContent = "0/200";
  document.querySelectorAll("input[name='fries']").forEach(x=> x.checked=false);
}

$("#notes").addEventListener("input",()=>{
  $("#notesCount").textContent = $("#notes").value.length + "/200";
});

/* Subtotal */
function updateUnitPreview(){
  if(!currentItem) return;
  const base    = currentItem.price;
  const patties = Number($("#patVal").textContent);
  const cheddar = Number($("#cheVal").textContent);

  const subtotal =
    base +
    patties * EXTRA_PRICE_PATTY +
    cheddar * EXTRA_PRICE_CHEDDAR;

  $("#unitPreview").textContent = money(subtotal);
}

/* Abrir modal */
function openCustomize(item, mode="add", id=null){
  currentItem   = item;
  currentMode   = mode;
  currentEditId = id;

  $("#modTitle").textContent =
    (mode==="edit" ? "Editar: " : "Personalizar: ") + item.name;

  resetCustomize();

  /* Mostrar extras seg√∫n tipo */
  const name = item.name.toLowerCase();
  const rowPatties = document.getElementById("rowPatties");
  const rowCheddar = document.getElementById("rowCheddar");

  if(name.includes("doble")){
    rowPatties.style.display = "flex";
    rowCheddar.style.display = "flex";
  }
  else if(name.includes("pollo")){
    rowPatties.style.display = "none";
    rowCheddar.style.display = "flex";
  }
  else {
    rowPatties.style.display = "none";
    rowCheddar.style.display = "none";
  }

  updateUnitPreview();
  $("#overlayCustomize").style.display = "flex";
}

/* Editar */
function editBurger(id){
  const b = cart.burger[id];
  if(!b) return;

  openCustomize(b.item, "edit", id);

  if(b.friesRaw){
    const r = document.querySelector(
      `input[name='fries'][value='${b.friesRaw}']`
    );
    if(r) r.checked = true;
  }

  $("#patVal").textContent = b.extras.patty;
  $("#cheVal").textContent = b.extras.cheddar;
  $("#notes").value = b.notes || "";
  $("#notesCount").textContent = (b.notes||"").length + "/200";

  updateUnitPreview();
}

/* Botones de extras */
$("#patInc").onclick = ()=>{
  let v = +$("#patVal").textContent;
  if(v < 2){
    $("#patVal").textContent = v + 1;
    updateUnitPreview();
  }
};
$("#patDec").onclick = ()=>{
  let v = +$("#patVal").textContent;
  if(v > 0){
    $("#patVal").textContent = v - 1;
    updateUnitPreview();
  }
};

$("#cheInc").onclick = ()=>{
  let v = +$("#cheVal").textContent;
  if(v < 3){
    $("#cheVal").textContent = v + 1;
    updateUnitPreview();
  }
};
$("#cheDec").onclick = ()=>{
  let v = +$("#cheVal").textContent;
  if(v > 0){
    $("#cheVal").textContent = v - 1;
    updateUnitPreview();
  }
};

/* Cancelar */
$("#btnCancel").onclick = ()=>
  $("#overlayCustomize").style.display = "none";

/* Agregar al carrito */
$("#btnAdd").onclick = ()=>{

  const fries = document.querySelector("input[name='fries']:checked");
  const friesValue = fries ? fries.value : "";
  const friesName =
      friesValue==="con_sazon" ? "Sazonadas" :
      friesValue==="con_sal"   ? "Con sal" :
      friesValue==="sin_sal"   ? "Sin sal" :
      "Sin papas";

  const entry = {
    item: currentItem,
    qty: 1,
    fries: friesName,
    friesRaw: friesValue,
    extras: {
      patty: Number($("#patVal").textContent),
      cheddar: Number($("#cheVal").textContent)
    },
    notes: $("#notes").value.trim()
  };

  /* STACKEAR si ya existe */
  let existingId = null;

  for(const id in cart.burger){
    const b = cart.burger[id];

    const same =
      b.item.id === entry.item.id &&
      b.friesRaw === entry.friesRaw &&
      b.extras.patty === entry.extras.patty &&
      b.extras.cheddar === entry.extras.cheddar &&
      (b.notes || "") === (entry.notes || "");

    if(same){
      existingId = id;
      break;
    }
  }

  if(currentMode==="edit" && currentEditId){
    cart.burger[currentEditId] = {
      ...entry,
      qty: cart.burger[currentEditId].qty
    };
  }
  else if(existingId){
    cart.burger[existingId].qty++;
  }
  else {
    const newId = currentItem.id + "_" + Date.now();
    cart.burger[newId] = entry;
  }

  $("#overlayCustomize").style.display = "none";
  renderCart();
};
</script>
<script>

/* === CONFIG PESOS === */
const GRAMS_PER_BURGER = 200;  // 1 hamburguesa = 200 g
let gramsBySlot = new Map();   // carga desde slots_grams
let SLOT_CAPACITY = 2000;      // limite por turno
  
/* ======================================================
      BLOQUE 5 ‚Äî TURNOS INTELIGENTES (slots_grams)
====================================================== */

/* CONSTANTES */
const BURGER_GRAMS = 200;     // Cada hamburguesa = 200g
const SLOT_LIMIT = 2000;      // L√≠mite total por horario
const SLOT_START = "19:15";
const SLOT_END   = "23:45";
const INTERVAL_MIN = 15;

/* ESTADOS */
let gramsBySlot = new Map();  // id ‚Üí gramsUsed
let allSlots = [];
let currentSlotIndex = 0;

/* ELEMENTOS */
const elSlotLabel = document.getElementById("slotLabel");
const elSlotSub   = document.getElementById("miniSlotSub");
const btnPrev     = document.getElementById("slotPrev");
const btnNext     = document.getElementById("slotNext");

/* ======================================================
      Helper: convertir HH:MM a Date de hoy
====================================================== */
function parseSlotToDate(str){
  const [h,m] = str.split(":").map(Number);
  const now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
}

/* ======================================================
      Helper: formatear Date a HH:MM
====================================================== */
function fmt(d){
  return d.toLocaleTimeString("es-AR",{
    hour:"2-digit", minute:"2-digit", hour12:false
  });
}

/* ======================================================
      Generar lista de slots del d√≠a
====================================================== */
function generateDailySlots(){
  const out = [];
  let cur = parseSlotToDate(SLOT_START);
  const end = parseSlotToDate(SLOT_END);

  while(cur <= end){
    out.push(new Date(cur));
    cur = new Date(cur.getTime() + INTERVAL_MIN * 60000);
  }
  return out;
}

/* ======================================================
      Obtener YYYYMMDD del d√≠a actual
====================================================== */
function todayPrefix(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  const d = String(now.getDate()).padStart(2,"0");
  return `${y}${m}${d}_`;   // ejemplo: 20251121_
}

/* ======================================================
      Cargar gramos desde Firestore (slots_grams)
====================================================== */
async function loadSlotConfig() {

  gramsBySlot = new Map();

  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth()+1).padStart(2,"0");
  const d = String(today.getDate()).padStart(2,"0");
  const prefix = `${y}${m}${d}_`;

  const snap = await db.collection("slots_grams").get();

  snap.forEach(doc=>{
    if(doc.id.startsWith(prefix)){
      gramsBySlot.set(doc.id, doc.data().gramsUsed || 0);
    }
  });
}
  console.log("Gramos por slot cargados:", gramsBySlot);
}

/* ======================================================
      Calcular gramos del carrito
====================================================== */
function calcCartGrams(){
  let tot = 0;
  for(const id in cart.burger){
    const b = cart.burger[id];
    tot += b.qty * BURGER_GRAMS;
  }
  return tot;
}

/* ======================================================
      Buscar PRIMER horario que tenga espacio
====================================================== */
function findFirstAvailableSlot(){
  const required = calcCartGrams();
  const prefix = todayPrefix();

  for(let i=0; i<allSlots.length; i++){
    const pretty = fmt(allSlots[i]);
    const slotId = prefix + pretty.replace(":","");

    const used = gramsBySlot.get(slotId) || 0;
    const free = SLOT_LIMIT - used;

    if(free >= required){
      return i;
    }
  }

  return -1; // ninguno disponible
}

/* ======================================================
      Render de slot actual
====================================================== */
function renderSlot() {
  const label = $("#slotLabel");
  const sub = $("#miniSlotSub");

  const required = getCartGrams();

  for(let i = currentSlotIndex; i < allSlots.length; i++){
    const d = allSlots[i];
    const pretty = formatHHMM(d);

    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");

    const slotId = `${y}${m}${dd}_${pretty.replace(":","")}`;

    const used = gramsBySlot.get(slotId) || 0;
    const free = SLOT_CAPACITY - used;

    if(free >= required){
      currentSlotIndex = i;
      label.textContent = pretty;
      window.selectedSlot = { iso: d.toISOString(), pretty };
      sub.textContent = "Seleccionado: " + pretty;
      updateArrows();
      return;
    }
  }

  label.textContent = "Sin horarios";
  window.selectedSlot = null;
  sub.textContent = "Seleccionado: ‚Äî";
}
}

/* ======================================================
      Habilitar / deshabilitar flechas
====================================================== */
function updateArrows(){
  btnPrev.classList.remove("disabled");
  btnNext.classList.remove("disabled");

  if(currentSlotIndex === 0)
    btnPrev.classList.add("disabled");

  if(currentSlotIndex === allSlots.length - 1)
    btnNext.classList.add("disabled");
}

/* ======================================================
      Recalcular horarios cuando cambia carrito
====================================================== */
async function recomputeSlots(){
  await loadSlotGrams();

  allSlots = generateDailySlots();

  const first = findFirstAvailableSlot();
  currentSlotIndex = (first >= 0 ? first : 0);

  renderSlot();
}

/* ======================================================
      Botones ‚Üê ‚Üí
====================================================== */
btnPrev.onclick = ()=>{
  if(currentSlotIndex > 0){
    currentSlotIndex--;
    renderSlot();
  }
};

btnNext.onclick = ()=>{
  if(currentSlotIndex < allSlots.length-1){
    currentSlotIndex++;
    renderSlot();
  }
};

/* ======================================================
      Cada vez que cambia el carrito ‚Üí recalcular
====================================================== */
const originalRenderCart_B5 = renderCart;

renderCart = function(){
  originalRenderCart_B5();
  recomputeSlots();
};

/* ======================================================
      INIT
====================================================== */
document.addEventListener("DOMContentLoaded", ()=>{
  allSlots = generateDailySlots();
  recomputeSlots();
});
</script>
<script>
/* ============================================================
   BLOQUE 6 ‚Äî ENVIAR PEDIDO + SUMAR GRAMOS A slots_grams
============================================================ */

async function sendToFirestore(){

  /* ============================
          VALIDACIONES
  ============================= */
  const nombre = $("#inpNombre").value.trim();
  if(!nombre){
    alert("Ingres√° el nombre");
    return;
  }

  const pago = $("#selPago").value.trim() || "sin_especificar";

  let slot = window.selectedSlot;

  /* -------- Horario manual -------- */
  const manual = $("#manualTime").value;
  if(manual){
    const now = new Date();
    slot = {
      pretty: manual,
      iso: new Date(
        now.getFullYear(), now.getMonth(), now.getDate(),
        manual.split(":")[0], manual.split(":")[1], 0
      ).toISOString()
    };
  }

  if(!slot){
    alert("Eleg√≠ un horario");
    return;
  }

  /* -------- Validar papas -------- */
  for(const id in cart.burger){
    const b = cart.burger[id];
    if(!b.friesRaw){
      alert(`La hamburguesa "${b.item.name}" no tiene papas seleccionadas.`);
      return;
    }
  }

  const tel = $("#inpTel").value.trim();

  let rawTotal = 0;
  let totalGrams = 0;
  const items = [];

  /* ============================
        ARMAR ITEMS (burger)
  ============================= */
  for(const id in cart.burger){
    const b = cart.burger[id];

    const unit =
      b.item.price +
      b.extras.patty   * EXTRA_PRICE_PATTY +
      b.extras.cheddar * EXTRA_PRICE_CHEDDAR;

    rawTotal += unit * b.qty;
    totalGrams += b.qty * BURGER_GRAMS;   // üî• 200g por unidad

    items.push({
      type: "burger",
      id: b.item.id,
      name: b.item.name,
      qty: b.qty,
      price: b.item.price,
      fries: b.fries,
      extras: {
        patty: b.extras.patty,
        cheddar: b.extras.cheddar
      },
      notes: b.notes || ""
    });
  }

  /* ============================
        ARMAR ITEMS (drinks)
  ============================= */
  for(const id in cart.drink){
    const d = cart.drink[id];
    rawTotal += d.item.price * d.qty;

    items.push({
      type:"drink",
      id:d.item.id,
      name:d.item.name,
      qty:d.qty,
      price:d.item.price
    });
  }

  /* ============================
        ARMAR ITEMS (sides)
  ============================= */
  for(const id in cart.side){
    const s = cart.side[id];
    rawTotal += s.item.price * s.qty;

    items.push({
      type:"side",
      id:s.item.id,
      name:s.item.name,
      qty:s.qty,
      price:s.item.price
    });
  }

  /* =====================================================
        OBTENER N¬∞ DE PEDIDO (transacci√≥n segura)
  ===================================================== */
  async function getNextOrder(){
    let lastKnown = 0;
    try{
      const qs = await db.collection('orders')
        .orderBy('orderNumber','desc')
        .limit(1)
        .get();
      if(!qs.empty) lastKnown = Number(qs.docs[0].data().orderNumber)||0;
    }catch(_){}

    const ref = db.collection("config").doc("counters");

    const next = await db.runTransaction(async tx=>{
      const snap = await tx.get(ref);
      const cur = snap.exists ? Number(snap.data().orderNumber||0) : 0;

      const base = Math.max(cur, lastKnown);
      const nxt = base + 1;

      tx.set(ref,{ orderNumber:nxt },{ merge:true });
      return nxt;
    });

    return next;
  }

  const orderNumber = await getNextOrder();

  /* =====================================================
                 CREAR PEDIDO (orders)
  ===================================================== */
  const order = {
    orderNumber,
    number: orderNumber,
    nombre,
    telefono: tel,
    entrega: "take_away",
    pago,
    notes: "",
    pickup_slot: slot.pretty,
    pickup_time: slot.iso,
    status: (pago==="mercado_pago" ? "pending_payment" : "accepted"),
    payment_status: (pago==="mercado_pago" ? "pending_payment" : "paid"),
    items,
    total: rawTotal,
    rawTotal,
    grams: totalGrams,   // <-- üî• GRAMOS DEL PEDIDO
    source: "mostrador",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  await db.collection("orders").add(order);

  /* =====================================================
                SUMAR GRAMOS EN slots_grams
  ===================================================== */
  const today = new Date();
  const y = today.getFullYear();
  const m = String(today.getMonth()+1).padStart(2,"0");
  const d = String(today.getDate()).padStart(2,"0");

  const slotId = `${y}${m}${d}_${slot.pretty.replace(":","")}`;

  const today = new Date();
const y = today.getFullYear();
const m = String(today.getMonth()+1).padStart(2,"0");
const d = String(today.getDate()).padStart(2,"0");

const slotId = `${y}${m}${d}_${slot.pretty.replace(":","")}`;
const ref = db.collection("slots_grams").doc(slotId);

await db.runTransaction(async tx=>{
  const snap = await tx.get(ref);
  const prev = snap.exists ? (snap.data().gramsUsed || 0) : 0;
  tx.set(ref, { gramsUsed: prev + totalGrams }, { merge:true });
});

  /* =====================================================
                RESETEAR CARRITO / UI
  ===================================================== */
  alert(`Pedido cargado ‚úîÔ∏è\nPedido #${orderNumber}`);

  cart = { burger:{}, drink:{}, side:{} };
  localStorage.removeItem("rb_cart_mostrador");
  renderCart();

  $("#inpNombre").value = "";
  $("#inpTel").value = "";
  $("#selPago").value = "";
  $("#manualTime").value = "";

  window.selectedSlot = null;
  $("#slotLabel").textContent = "--:--";
  $("#miniSlotSub").textContent = "Seleccionado: ‚Äî";

  recomputeSlots();  // recalcular turnos despu√©s de sumar gramos
}

$("#btnCargarPedido").onclick = sendToFirestore;
</script>
