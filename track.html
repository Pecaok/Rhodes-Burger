<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seguimiento de pedido • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:22px; --shadow:0 12px 34px rgba(0,0,0,.10); --ring:#eaeaea;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:5; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:900px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:32px;height:32px;border-radius:8px;margin-right:8px}
    .container{max-width:900px;margin:24px auto;padding:0 12px}
    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    h1{font-size:26px;margin:8px 0 12px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .badge{background:#f3f3f3;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;font-size:13px}
    .steps{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px}
    .step{background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:12px;text-align:center}
    .step .t{font-weight:800;margin-bottom:6px}
    .step.completed{background:#eafff2;border-color:#bff0d1}
    .step.current{outline:2px solid var(--primary)}
    .items .it{margin:6px 0}
    .items .sub{font-size:13px;color:var(--muted)}
    .money{white-space:nowrap}
    .notfound{color:#b00020;font-weight:600}
    .small{font-size:13px}
    .center{display:flex;justify-content:center;align-items:center}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div style="flex:1"></div>
      <a class="btn" href="index.html">Menú</a>
    </div>
  </header>

  <main class="container">
    <div class="card" id="cardInfo">
      <h1>Seguimiento de pedido</h1>
      <div id="head" class="muted">Cargando…</div>
      <div class="row" id="chips" style="margin-top:8px"></div>
      <div class="steps" style="margin-top:12px">
        <div class="step" id="s_accepted">
          <div class="t">Pedido recibido</div>
          <div class="small muted">Estamos validando tu orden</div>
        </div>
        <div class="step" id="s_in_prep">
          <div class="t">En preparación</div>
          <div class="small muted">El equipo ya lo está preparando</div>
        </div>
        <div class="step" id="s_ready">
          <div class="t">Listo para retirar</div>
          <div class="small muted">Podés pasar por el local</div>
        </div>
        <div class="step" id="s_delivered">
          <div class="t">Entregado</div>
          <div class="small muted">¡Buen provecho!</div>
        </div>
      </div>
      <div class="actions">
        <a id="btnShare" class="btn">Compartir seguimiento</a>
        <a href="index.html" class="btn primary">Seguir comprando</a>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Detalle</h3>
      <div id="items" class="items muted">—</div>
      <div style="display:flex;justify-content:flex-end;font-weight:800;margin-top:8px">
        Total: <span id="total" style="margin-left:6px"></span>
      </div>
    </div>

    <div id="notfound" class="card notfound" style="display:none">
      No pudimos encontrar el pedido. Verificá el enlace o el número.
    </div>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // ======= CONFIG FIREBASE (igual al resto del sitio) =======
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}
    const db = firebase.firestore();

    // ======= HELPERS =======
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const friesName = f => f==="con_sazon" ? "Con sazón" : (f==="sin_sazon" ? "Sin sazonar" : "—");
    function unitWithExtras(it){
      const base = it.price || 0;
      const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0);
      const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
      return base + pz + ch;
    }
    function computeOrderTotal(o){
      if (typeof o.total === "number") return o.total;
      const items = Array.isArray(o.items) ? o.items : [];
      return items.reduce((t,it)=> t + (it.type==="burger" ? unitWithExtras(it) : (it.price||0)) * (it.qty||0), 0);
    }
    function displayOrderNumber(o, docId){
      const cands=[o.orderNumber,o.number,o.num,o.numero,o.nro,o.orderNo,o.seq,o.n,o.idPedido];
      for(const c of cands){ if(Number.isFinite(+c)) return '#'+(+c); }
      return '#'+String(docId||'').slice(-5).toUpperCase();
    }

    // ======= PÁGINA =======
    const params = new URLSearchParams(location.search);
    const byId  = params.get('id');
    const byNum = params.get('num');

    const mapStatusToStep = {
      accepted: 's_accepted',
      pending_payment: 's_accepted',
      in_prep: 's_in_prep',
      ready: 's_ready',
      delivered: 's_delivered',
      cancelled: 's_accepted'
    };
    function paintSteps(status){
      const keys=['s_accepted','s_in_prep','s_ready','s_delivered'];
      keys.forEach(k=>{ $('#'+k).classList.remove('completed','current'); });
      const order=['accepted','in_prep','ready','delivered'];
      const idx = Math.max(0, order.indexOf(status==='pending_payment'?'accepted':status));
      for(let i=0;i<keys.length;i++){
        if(i<idx) $('#'+keys[i]).classList.add('completed');
      }
      $('#'+keys[idx]).classList.add('current');
    }

    function render(o, id){
      // header
      const nro = displayOrderNumber(o, id);
      const name = o.nombre || 'Cliente';
      $('#head').innerHTML = `<strong>${nro}</strong> — ${name}`;
      const chips = [];
      chips.push(`<span class="badge">Estado: ${o.status||'accepted'}</span>`);
      if (o.entrega) chips.push(`<span class="badge">Retiro: ${o.entrega}</span>`);
      if (o.pago) chips.push(`<span class="badge">Pago: ${o.pago}</span>`);
      $('#chips').innerHTML = chips.join('');

      // steps
      paintSteps(o.status||'accepted');

      // detalle
      const items = Array.isArray(o.items)?o.items:[];
      $('#items').innerHTML = items.map(it=>{
        if(it.type==='burger'){
          const unit=unitWithExtras(it), sub=unit*(it.qty||0);
          const ex=[]; if(it.extras?.patty)ex.push(`+${it.extras.patty} med`);
          if(it.extras?.cheddar)ex.push(`+${it.extras.cheddar} cheddar`);
          const notes=it.notes?` · Notas: ${it.notes}`:'';
          return `<div class="it"><div>• <strong>${it.qty||0}× ${it.name}</strong></div>
            <div class="sub">Papas: ${friesName(it.fries)}${ex.length?` · ${ex.join(' · ')}`:''}${notes}
            <div>Unit: <span class="money">${money(unit)}</span> — Subtotal: <span class="money">${money(sub)}</span></div></div></div>`;
        }else{
          const sub=(it.price||0)*(it.qty||0);
          return `<div class="it"><div>• <strong>${it.qty||0}× ${it.name}</strong></div>
            <div class="sub">Unit: <span class="money">${money(it.price||0)}</span> — Subtotal: <span class="money">${money(sub)}</span></div></div>`;
        }
      }).join('') || '<span class="muted">—</span>';

      $('#total').textContent = money(computeOrderTotal(o));

      // compartir
      const shareUrl = location.origin + location.pathname + `?id=${encodeURIComponent(id)}&num=${encodeURIComponent(o.orderNumber||'')}`;
      const shareText = `Seguí tu pedido ${nro} en Rhodes Burgers: ${shareUrl}`;
      $('#btnShare').onclick = async ()=>{
        try{
          if(navigator.share){ await navigator.share({title:'Seguimiento Rhodes', text:shareText, url:shareUrl}); }
          else { await navigator.clipboard.writeText(shareText); alert('Enlace copiado'); }
        }catch(_){}
      };
    }

    async function main(){
      let unsub=null;
      const notFound=()=>{ $('#notfound').style.display='block'; };
      const ok=()=>{ $('#notfound').style.display='none'; };

      if(byId){
        unsub = db.collection('orders').doc(byId).onSnapshot(s=>{
          if(!s.exists){ notFound(); return; }
          ok(); render(s.data(), s.id);
        }, _=>notFound());
        return;
      }
      if(byNum){
        db.collection('orders').where('orderNumber','==', Number(byNum)).limit(1)
          .onSnapshot(s=>{
            if(s.empty){ notFound(); return; }
            ok(); const d=s.docs[0]; render(d.data(), d.id);
          }, _=>notFound());
        return;
      }
      notFound();
    }
    main();
  </script>
</body>
</html>
