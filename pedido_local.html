<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos V3 (Nuevo) ‚Ä¢ Rhodes</title> <link rel="icon" href="images/logo.png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#625A45" />

  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f4f4f9; --card:#fff;
      --ring:#e0e0e0; --shadow:0 4px 12px rgba(0,0,0,.08);
      --font: Inter, system-ui, -apple-system, sans-serif;
      
      /* Estados */
      --st-accepted:#ffca28; --st-in_prep:#fb8c00; --st-ready:#00acc1; 
      --st-delivered:#43a047; --st-cancelled:#e53935;
      
      /* Pagos */
      --pay-paid:#2e7d32; --pay-pending:#f57c00;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    
    /* HEADER */
    header{position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.05);padding:0 12px}
    .topbar{max-width:1200px;margin:0 auto;height:60px;display:flex;align-items:center;gap:16px}
    .brand{display:flex;align-items:center;text-decoration:none;color:var(--primary);font-weight:800;font-size:18px}
    .brand img{width:32px;height:32px;border-radius:8px;margin-right:10px}
    .spacer{flex:1}
    
    /* BOTONES NAV */
    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:8px;text-decoration:none;color:var(--text);font-weight:600;font-size:14px;transition:all .2s;border:1px solid transparent;cursor:pointer}
    .btn:hover{background:#f0f0f0}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.danger{color:#d32f2f;background:#ffebee}
    .icon-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;border:none;background:#f0f0f0;cursor:pointer;font-size:16px;transition:all .2s}
    .icon-btn.active{background:var(--primary);color:#fff}

    /* CONTENEDOR */
    .container{max-width:1000px;margin:30px auto;padding:0 16px}
    h1{font-size:26px;font-weight:800;color:var(--primary);margin-bottom:20px}

    /* TABS FILTRO */
    .tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
    .chipf{padding:8px 16px;border-radius:20px;background:#e0e0e0;color:#555;font-weight:600;font-size:14px;cursor:pointer;border:none;transition:all .2s}
    .chipf.active{background:var(--primary);color:#fff;box-shadow:0 4px 8px rgba(98,90,69,.2)}

    /* TARJETA PEDIDO */
    .order{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:24px;margin-bottom:24px;border:1px solid transparent;transition:all .3s}
    .order:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .order.cancelled{opacity:.6;filter:grayscale(1)}

    .order-head{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:20px}
    .or-left{flex:1}
    .order-title{font-size:18px;font-weight:800;margin-bottom:4px}
    .muted{font-size:13px;color:var(--muted)}
    
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:6px;background:#f0f0f0;font-size:12px;font-weight:600;color:#444}
    .chip.mostrador{background:#e3f2fd;color:#0d47a1}

    .or-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .right-total{font-size:22px;font-weight:900;color:var(--primary)}

    /* ITEMS LISTA */
    .items{border-top:1px solid var(--ring);padding-top:16px}
    .cat-section{margin-bottom:16px}
    .cat-header{font-size:12px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    
    .item-row{display:flex;gap:12px;margin-bottom:8px;font-size:15px}
    .item-qty{font-weight:800;color:var(--primary);min-width:24px}
    .item-det{flex:1}
    .item-name{font-weight:700;text-transform:capitalize}
    .item-extras{font-size:13px;color:#666;margin-top:2px}
    .note-line{font-size:13px;color:#d32f2f;font-style:italic;margin-top:2px;font-weight:600}

    /* BOTONES ESTADO */
    .stateBtns{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}
    .state-btn{flex:1;min-width:100px;padding:8px;border:1px solid var(--ring);background:#fff;color:var(--text);border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;transition:all .2s}
    .state-btn:hover{background:#f5f5f5}
    .state-btn.on.state-accepted{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .state-btn.on.state-in_prep{background:var(--st-in_prep);border-color:var(--st-in_prep);color:#fff}
    .state-btn.on.state-ready{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .state-btn.on.state-delivered{background:var(--st-delivered);border-color:var(--st-delivered);color:#fff}
    .state-btn.state-cancelled:hover{background:#ffebee;color:#c62828;border-color:#ef9a9a}

    /* L√çNEA PAGO */
    .pay-line{display:flex;gap:8px;align-items:center;background:#f4f4f9;padding:4px;border-radius:10px}
    .pay-select{padding:8px;border-radius:8px;border:1px solid var(--ring);background:#fff;font-weight:600;color:var(--text);cursor:pointer}
    .pay-toggle{padding:8px 16px;border-radius:8px;border:none;font-weight:700;font-size:13px;cursor:pointer;color:#fff;min-width:110px}
    .pay-toggle.is-paid{background:var(--pay-paid)}
    .pay-toggle.is-pending{background:var(--pay-pending)}
    
    .empty-state{text-align:center;padding:40px;color:var(--muted);font-size:16px}

    @media print{
      header,.tabs,.stateBtns,.pay-line,.btn,.icon-btn{display:none!important}
      body{background:#fff} .container{margin:0;padding:0;max-width:none}
      .order{box-shadow:none;border:1px solid #000;margin-bottom:20px;page-break-inside:avoid}
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // 1. Init
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}
    const db = firebase.firestore();
    
    window.idToDoc = new Map(); 

    // 2. Auth
    function checkSession(){
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      if(!ok || (Date.now()-ts > 20*60*60*1000)) location.replace('login.html');
      else localStorage.setItem('rb_admin_t', String(Date.now()));
    }
    checkSession(); setInterval(checkSession, 5*60*1000);

    // 3. Funciones Globales (Exposed)
    window.logout = () => { localStorage.removeItem('rb_admin_ok'); location.replace('login.html'); };

    window.setOrderStatus = async (id, next, isPaid) => {
        if(next==='delivered' && !isPaid){
            alert("‚ö†Ô∏è COBRAR PRIMERO: El pedido figura pendiente."); return;
        }
        try{ await db.collection("orders").doc(id).update({status:next}); }catch(e){console.error(e);}
    };

    window.setPaymentStatus = async (id, currentPaid) => {
        // Si quiere marcar pagado (actual es false), revisamos metodo
        // (Lo hacemos en la UI, pero aqu√≠ forzamos el toggle)
        try{ 
            await db.collection("orders").doc(id).update({
                paid: !currentPaid, 
                payment_status: !currentPaid ? 'paid' : 'pending_payment'
            }); 
        }catch(e){console.error(e);}
    };
    
    window.updatePago = async (id, val) => {
        try{ await db.collection("orders").doc(id).update({pago:val}); }catch(e){}
    };

    window.printOrder = (id) => {
        const doc = window.idToDoc.get(id);
        if(doc) window.trySilentPrint(doc);
    };
    
    // 4. Helpers
    window.pickDate = (o) => {
       // Soporte robusto de fecha
       if(o.createdAt?.toDate) return o.createdAt.toDate();
       if(typeof o.createdAt==='string') return new Date(o.createdAt);
       return new Date();
    };

    // Normalizador de Papas
    window.cleanFries = (raw) => {
       if(!raw) return "";
       const s = String(raw).toLowerCase().replace(/[_-]/g,' ').trim();
       if(s.includes('sazon')) return "Sazonadas";
       if(s.includes('sin sal')) return "Sin sal";
       if(s.includes('con sal')||s.includes('sal')) return "Con sal";
       return s.charAt(0).toUpperCase() + s.slice(1);
    };
  </script>
</head>

<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="">Pedidos</a>
      <div class="spacer"></div>
      <button id="btnBell" class="icon-btn" title="Sonido">üîî</button>
      <button id="btnAutoPrint" class="icon-btn" title="Autoimprimir">üñ®Ô∏è</button>
      <button onclick="window.logout()" class="btn danger">Salir</button>
    </div>
  </header>

  <main class="container">
    <div class="tabs" id="tabs">
      <button class="chipf active" data-f="recibidos">Recibidos</button>
      <button class="chipf" data-f="entregados">Entregados</button>
      <button class="chipf" data-f="cancelled">Cancelados</button>
      <button class="chipf" data-f="all">Todos</button>
    </div>

    <div id="orders">
        <div class="empty-state">Cargando...</div>
    </div>
    <div id="ordersError" class="err" style="display:none">Error de conexi√≥n.</div>
  </main>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    let currentFilter = "recibidos";
    
    // Tabs logic
    document.getElementById("tabs").addEventListener("click", (e)=>{
        const el = e.target.closest(".chipf");
        if(!el) return;
        document.querySelectorAll(".chipf").forEach(b=>b.classList.remove("active"));
        el.classList.add("active");
        currentFilter = el.dataset.f;
        // Re-render
        if(window.lastSnap) renderList(window.lastSnap);
    });

    // Header Buttons
    const btnBell=document.getElementById("btnBell");
    let soundOn=JSON.parse(localStorage.getItem("rb_sound")||"true");
    const updBell=()=>{ btnBell.classList.toggle("active",soundOn); }; updBell();
    btnBell.onclick=()=>{ soundOn=!soundOn; localStorage.setItem("rb_sound",soundOn); updBell(); };

    const btnAP=document.getElementById("btnAutoPrint");
    let autoP=JSON.parse(localStorage.getItem("rb_autop")||"false");
    const updAP=()=>{ btnAP.classList.toggle("active",autoP); }; updAP();
    btnAP.onclick=()=>{ autoP=!autoP; localStorage.setItem("rb_autop",autoP); updAP(); };

    const playBeep=()=>{
        if(!soundOn) return;
        try{ const c=new(window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(); const g=c.createGain();
        o.type="square"; o.frequency.value=750; o.connect(g); g.connect(c.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.00001, c.currentTime+0.2); o.stop(c.currentTime+0.2); }catch(e){}
    };

    // === SUSCRIPCI√ìN A DB (SIN ORDENAR PARA EVITAR ERRORES) ===
    let isInit=true; setTimeout(()=>isInit=false,3000);
    
    db.collection("orders").limit(300).onSnapshot(snap => {
        window.lastSnap = snap;
        renderList(snap);

        snap.docChanges().forEach(ch => {
            if(ch.type==='added' && !isInit){
                playBeep();
                if(autoP) window.trySilentPrint(window.idToDoc.get(ch.doc.id));
            }
        });
    }, err => {
        console.error(err);
        document.getElementById("orders").innerHTML = '<div class="empty-state" style="color:red">Error cargando pedidos.</div>';
    });


    // === RENDER ===
    function renderList(snap){
        let docs = snap.docs.map(d => ({ data: d.data(), id: d.id, ref: d }));
        
        // 1. Ordenar en CLIENTE (Fecha Descendente)
        docs.sort((a,b) => window.pickDate(b.data) - window.pickDate(a.data));

        // 2. Filtrar
        const filtered = docs.filter(obj => {
            const s = obj.data.status || 'accepted';
            if(currentFilter==='recibidos') return ['accepted','in_prep','ready','pending_payment'].includes(s);
            if(currentFilter==='entregados') return s==='delivered';
            if(currentFilter==='cancelled') return s==='cancelled';
            return true;
        });

        // Guardar mapa para impresion
        window.idToDoc = new Map(snap.docs.map(d=>[d.id,d]));

        const cont = document.getElementById("orders");
        if(filtered.length===0){
            cont.innerHTML = '<div class="empty-state">No hay pedidos en esta secci√≥n.</div>';
            return;
        }
        cont.innerHTML = filtered.map(x => buildOrderHTML(x.ref)).join("");
    }

    function buildOrderHTML(doc){
        const o = doc.data();
        const dt = window.pickDate(o);
        const timeStr = dt.toLocaleTimeString("es-AR", {hour:'2-digit', minute:'2-digit'});
        
        const st = o.status || 'accepted';
        const isPaid = (o.payment_status==='paid') || !!o.paid;

        // Botones Estado
        const KEYS = ['accepted','in_prep','ready','delivered'];
        const LABELS = {accepted:'Recibido', in_prep:'En preparaci√≥n', ready:'Listo', delivered:'Entregado'};
        
        let btnsHTML = KEYS.map(k => {
            const isOn = (k === st) ? 'on' : '';
            const cls = `state-${k}`;
            return `<button class="state-btn ${cls} ${isOn}" onclick="setOrderStatus('${doc.id}', '${k}', ${isPaid})">${LABELS[k]}</button>`;
        }).join('');
        btnsHTML += `<button class="state-btn state-cancelled" onclick="setOrderStatus('${doc.id}', 'cancelled', ${isPaid})">Cancelar</button>`;

        // Pago
        let payVal = o.pago;
        if(payVal === 'mostrador_sin_especificar') payVal = "";

        // Items
        const items = Array.isArray(o.items) ? o.items : [];
        const cats = { b:[], f:[], d:[], o:[] };
        
        items.forEach(it => {
            const n = (it.name||"").toLowerCase();
            const t = (it.type||"").toLowerCase();
            const q = it.qty || 1;
            
            if(t==='burger' || n.includes('hamburguesa')){
                cats.b.push(it);
                // Extraer papas
                let fName = it.fries;
                if(!fName && it.extras?.fries) fName = it.extras.fries;
                if(!fName && it.guarnicion) fName = it.guarnicion;
                
                if(fName && fName !== 'sin_papas') cats.f.push({name: fName, qty: q});
                
            } else if(t==='side' || n.includes('papas')){
                cats.f.push(it);
            } else if(t==='drink' || n.includes('coca')){
                cats.d.push(it);
            } else {
                cats.o.push(it);
            }
        });

        const renderSec = (list, icon, title) => {
            if(!list.length) return "";
            const rows = list.map(it => {
                let ex = [];
                if(it.extras?.patty) ex.push(`+${it.extras.patty} carne`);
                if(it.extras?.cheddar) ex.push(`+${it.extras.cheddar} cheddar`);
                
                let dName = it.name;
                if(title.includes("PAPAS")) dName = window.cleanFries(it.name);

                return `<div class="item-row">
                   <div class="item-qty">${it.qty||1}</div>
                   <div class="item-det">
                      <div class="item-name">${dName}</div>
                      ${ex.length ? `<div class="item-extras">${ex.join(' ¬∑ ')}</div>` : ''}
                      ${it.notes ? `<div class="note-line">üìù ${it.notes}</div>` : ''}
                   </div>
                </div>`;
            }).join("");
            return `<div class="cat-section"><div class="cat-header">${icon} ${title}</div>${rows}</div>`;
        };

        const htmlItems = renderSec(cats.b,'üçî','HAMBURGUESAS') + renderSec(cats.f,'üçü','GUARNICIONES / PAPAS') + renderSec(cats.d,'ü•§','BEBIDAS') + renderSec(cats.o,'üî∏','OTROS');
        
        const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);

        return `
        <div class="order ${st==='cancelled'?'cancelled':''}">
           <div class="order-head">
              <div class="or-left">
                 <div class="order-title">#${o.orderNumber||'--'} ‚Äî ${o.source==='mostrador'?o.nombre+' (Mostrador)':o.nombre}</div>
                 <div class="or-meta">
                    <span>üïë ${timeStr}</span>
                    <span class="chip ${o.source==='mostrador'?'mostrador':''}">Retiro: ${o.entrega||'take_away'}</span>
                    ${o.pickup_time_pretty ? `<span class="chip">‚è∞ ${o.pickup_time_pretty}</span>` : ''}
                 </div>
                 <div class="stateBtns">${btnsHTML}</div>
              </div>
              <div class="or-right">
                 <div class="right-total">${money(total)}</div>
                 <div class="pay-line">
                    <select class="pay-select" onchange="updatePago('${doc.id}', this.value)">
                       <option value="" disabled ${!payVal?'selected':''}>M√©todo...</option>
                       <option value="efectivo" ${payVal==='efectivo'?'selected':''}>Efectivo</option>
                       <option value="mercado_pago" ${payVal==='mercado_pago'?'selected':''}>QR (MP)</option>
                       <option value="debito" ${payVal==='debito'?'selected':''}>D√©bito</option>
                       <option value="transferencia" ${payVal==='transferencia'?'selected':''}>Transferencia</option>
                    </select>
                    <button class="pay-toggle ${isPaid?'is-paid':'is-pending'}" onclick="setPaymentStatus('${doc.id}', ${isPaid}, '${payVal||''}')">
                       ${isPaid ? 'PAGADO ‚úì' : 'PENDIENTE $'}
                    </button>
                    <button class="print-btn" onclick="printOrder('${doc.id}')">üñ®</button>
                 </div>
              </div>
           </div>
           <div class="items">${htmlItems || '<div class="muted">Sin items</div>'}</div>
        </div>`;
    }

    // --- IMPRESI√ìN TICKET (58mm) ---
    window.trySilentPrint = function(docSnap){
       const o = docSnap.data();
       const esc = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
       const m = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
       
       const dt = window.pickDate(o);
       const dateStr = dt.toLocaleDateString("es-AR");
       const timeStr = dt.toLocaleTimeString("es-AR",{hour12:false});
       
       let payTxt = o.pago;
       if(!payTxt || payTxt==='mostrador_sin_especificar') payTxt="A COBRAR EN CAJA";
       else if(payTxt==='mercado_pago') payTxt="QR (MP)";
       else payTxt = payTxt.toUpperCase();

       const isPaid = (o.payment_status === 'paid') || o.paid;
       const stPay = isPaid ? "PAGADO" : "PENDIENTE";
       
       // Items Ticket
       const items = Array.isArray(o.items) ? o.items : [];
       const cats = { b:[], f:[], d:[], o:[] };
       items.forEach(it => {
          const n = (it.name||"").toLowerCase();
          const t = (it.type||"").toLowerCase();
          const q = it.qty || 1;
          if(t==='burger' || n.includes('hamburguesa')){
             cats.b.push(it);
             let fName = it.fries;
             if(!fName && it.extras?.fries) fName = it.extras.fries;
             if(!fName && it.guarnicion) fName = it.guarnicion;
             if(fName && fName!=='sin_papas') cats.f.push({name: fName, qty: q});
          } else if(t==='side' || n.includes('papas')) cats.f.push(it);
          else if(t==='drink' || n.includes('coca')) cats.d.push(it);
          else cats.o.push(it);
       });

       const rSec = (l, ti) => {
         if(!l.length) return "";
         const r = l.map(i => {
            let dName = esc(i.name);
            if(ti.includes("PAPA")) dName = window.cleanFries(i.name);
            
            let h = `<div class="row name"><div class="l">${i.qty||1} √ó ${dName}</div></div>`;
            if(!ti.includes("PAPA")){
               if(i.extras?.patty) h+=`<div class="sub">‚Ä¢ +${i.extras.patty} carne</div>`;
               if(i.extras?.cheddar) h+=`<div class="sub">‚Ä¢ +${i.extras.cheddar} cheddar</div>`;
            }
            if(i.notes) h+=`<div class="sub">üìù ${esc(i.notes)}</div>`;
            h+=`<div class="sep"></div>`;
            return h;
         }).join("");
         return `<div class="blk"><div class="lbl" style="border-bottom:1px solid #000;display:inline-block;margin-top:6px">${ti}</div></div>${r}`;
       };

       const body = rSec(cats.b,'HAMBURGUESAS') + rSec(cats.f,'PAPAS') + rSec(cats.d,'BEBIDAS') + rSec(cats.o,'OTROS');
       const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);
       const name = o.source==='mostrador' ? (o.nombre+' (Mostrador)') : o.nombre;

       const html = `<!doctype html><html><head><style>
       @page{size:58mm auto;margin:0} body{width:58mm;margin:0 auto;padding:5px;font-family:monospace;font-size:12px;font-weight:700;color:#000;line-height:1.2}
       .c{text-align:center} .hr{border-top:1px dashed #000;margin:6px 0} .row{display:flex;justify-content:space-between}
       .lbl{font-size:10px;text-transform:uppercase} .sub{font-size:11px;margin-left:5px;font-weight:400} .sep{border-top:1px dotted #999;margin:3px 0}
       </style></head><body>
         <div class="c" style="font-size:16px;margin-bottom:4px">Rhodes Burgers</div>
         <div class="c" style="font-size:14px">#${o.orderNumber||'--'}</div>
         <div class="c" style="font-size:18px;margin:5px 0">[ ${stPay} ]</div>
         <div class="hr"></div>
         <div><span class="lbl">CLIENTE:</span> ${esc(name)}</div>
         <div class="c" style="font-size:16px;margin:6px 0;font-weight:900">Retira: ${esc(o.pickup_time_pretty||'A la brevedad')}</div>
         <div><span class="lbl">PAGO:</span> ${payTxt}</div>
         ${o.notes ? `<div class="hr"></div><div><span class="lbl">NOTA:</span> ${esc(o.notes)}</div>` : ''}
         <div class="hr"></div>
         ${body}
         <div class="hr"></div>
         <div class="row"><div class="l">TOTAL</div><div>${m(total)}</div></div>
         <div class="c" style="margin-top:10px;font-size:10px">${dateStr} ${timeStr}</div>
         <script>window.onload=()=>{setTimeout(()=>{window.print()},200)}<\/script>
       </body></html>`;

       const f = document.createElement('iframe'); f.style.cssText='position:fixed;left:0;top:0;width:0;height:0;border:0';
       document.body.appendChild(f); const d=f.contentWindow.document; d.open();d.write(html);d.close();
       setTimeout(()=>f.remove(), 10000);
    };
  });
  </script>
</body>
</html>
