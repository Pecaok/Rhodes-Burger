<!doctype html>
<html lang="es">
  <script>
  const TTL_HOURS = 20;
  const TTL_MS    = TTL_HOURS * 60 * 60 * 1000;

  function sessionValid(){
    const ok = localStorage.getItem('rb_admin_ok') === 'true';
    const ts = Number(localStorage.getItem('rb_admin_t') || 0);
    return ok && (Date.now() - ts) < TTL_MS;
  }
  function bumpSession(){
    if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
  }
  function logout(){
    try{ localStorage.removeItem('rb_admin_ok'); }catch(_){}
    try{ localStorage.removeItem('rb_admin_t'); }catch(_){}
    try{ localStorage.removeItem('rb_auth_v2'); }catch(_){}
    try{ sessionStorage.removeItem('rb_auth_v2'); }catch(_){}
    const next = encodeURIComponent('pedido_local.html');
    location.replace('login.html?reason=logout&next=' + next);
  }

  (function requireSession(){
    if (!sessionValid()){
      const next = encodeURIComponent(
        (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
        (location.search || '') + (location.hash || '')
      );
      location.replace('login.html?next=' + next);
    } else {
      bumpSession();
    }
  })();

  ['click','keydown','focus','mousemove','touchstart','scroll']
    .forEach(evt => window.addEventListener(evt, bumpSession, {passive:true}));
  </script>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#625A45" />

  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#444; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
      --font: Inter, system-ui, "Segoe UI", Roboto, Arial, sans-serif;

      --st-accepted:#FBC02D;
      --st-in_prep:#FB8C00;
      --st-ready:#00ACC1;
      --st-delivered:#2E7D32;
      --st-cancelled:#D32F2F;

      --pay-pending:#FFA000;
      --pay-paid:#625A45;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;background:var(--bg);color:var(--text);font-family:var(--font)
    }

    header{
      position:sticky;top:0;z-index:10;
      background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)
    }

    .topbar{
      max-width:1100px;margin:0 auto;padding:10px 12px;
      display:flex;align-items:center;gap:12px
    }

    .brand{
      display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700
    }
    .brand img{
      width:36px;height:36px;border-radius:10px;background:#fff;
      object-fit:contain;margin-right:8px
    }
    .spacer{flex:1}

    .btn{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--ring);background:#fff;
      padding:8px 12px;border-radius:999px;
      cursor:pointer;font-weight:600;text-decoration:none;color:inherit
    }
    .btn.primary,.btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}

    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .chipf{
      background:#f3f3f3;border:1px solid var(--ring);color:#111;
      border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer;
    }
    .chipf.active{background:var(--primary);color:#fff;border-color:var(--primary)}

    .order{
      background:var(--card);border-radius:18px;
      box-shadow:var(--shadow);padding:16px 18px;margin:14px 0
    }

    .order-head{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px
    }

    .order-title{font-weight:800}
    .muted{color:var(--muted)}

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{
      background:#f3f3f3;border:1px solid var(--ring);
      padding:6px 10px;border-radius:999px;font-size:13px
    }

    .right-total{font-weight:800;font-size:18px;white-space:nowrap}

    .items{margin-top:10px}
    .sub{color:#111;font-size:13px;margin-top:3px}
    .divider{height:1px;background:#efefef;margin:10px 0}
    .err{color:#b00020;font-weight:600}

    .stateBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .state-btn{
      border:2px solid #dcdcdc;background:#fff;color:#111;
      border-radius:999px;padding:8px 12px;font-weight:800;
      cursor:pointer;min-width:160px;text-align:center
    }

    .state-btn.on{color:#fff;background:var(--primary);border-color:var(--primary)}
    .state-accepted.on{background:var(--st-accepted)!important;color:#000}
    .state-in_prep.on{background:var(--st-in_prep)!important;color:#fff}
    .state-ready.on{background:var(--st-ready)!important;color:#fff}
    .state-delivered.on{background:var(--st-delivered)!important;color:#fff}
    .state-cancelled.on{background:var(--st-cancelled)!important;color:#fff}

    .pay-line{
      margin-top:6px;display:flex;align-items:center;
      gap:10px;flex-wrap:wrap
    }

    .pay-method-select{
      padding:6px 10px;border-radius:8px;
      border:1px solid var(--ring);background:#fff;
      height:36px;font-size:14px
    }

    .pay-toggle{min-width:200px;text-align:center}
    .pay-toggle.is-paid{background:var(--pay-paid);color:#fff;border-color:var(--pay-paid)}
    .pay-toggle.is-pending{background:var(--pay-pending);color:#fff;border-color:var(--pay-pending)}

    .order.cancelled{opacity:.65}
    .order.cancelled .order-title{text-decoration:line-through}
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png">Pedidos</a>

      <div class="spacer"></div>

      <nav style="display:flex;gap:8px;">
        <a href="pedido_local.html" class="btn primary">üì¶ Pedidos</a>
        <a href="finanzas.html" class="btn">üìà Finanzas</a>
        <a href="mostrador.html" class="btn">üßæ Mostrador</a>
        <a href="admin.html" class="btn">‚öôÔ∏è Admin</a>
      </nav>

      <button id="btnBell" class="btn">üîî Sonido</button>
      <button id="btnAutoPrint" class="btn">üñ® Auto</button>
      <button id="btnLogout" class="btn danger">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>

    <div class="tabs" id="tabs">
      <span class="chipf active" data-f="recibidos">Recibidos</span>
      <span class="chipf" data-f="entregados">Entregados</span>
      <span class="chipf" data-f="cancelled">Cancelados</span>
      <span class="chipf" data-f="all">Todos</span>
    </div>

    <div id="orders"></div>
    <div id="ordersError" class="err" style="display:none;margin-top:8px"></div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
window.addEventListener('DOMContentLoaded', () => {

  const firebaseConfig = {
    apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain:"rhodes-burguers.firebaseapp.com",
    projectId:"rhodes-burguers",
    storageBucket:"rhodes-burguers.firebasestorage.app",
    messagingSenderId:"951646688091",
    appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig);}catch(e){}

  const db=firebase.firestore();
  const $ = s => document.querySelector(s);
  const money = n => (Number(n)||0).toLocaleString("es-AR",
      {style:"currency",currency:"ARS",maximumFractionDigits:0});

  /* ======== fecha ======== */
  function chooseDateField(o){
    const prefs=['createdAt','created_at','timestamp','date','fecha','time'];
    return prefs.find(k=>o[k]!=null) || null;
  }

  function pickDocDate(o){
    const pref=['createdAt','created_at','timestamp','date','fecha','time'];
    for(const k of pref){
      const v=o[k];
      if(v?.toDate) return v.toDate();
      if(typeof v==="number") return new Date(v);
      if(typeof v==="string"){
        const d=new Date(v); if(!isNaN(d)) return d;
      }
    }
    return new Date();
  }

  function displayOrderNumber(doc){
    const o=doc.data();
    const keys=[o.orderNumber,o.number,o.numero,o.num,o.numPedido,o.nro,
                o.orderNo,o.seq,o.n,o.idPedido,o.pedidoNumber,o.pedido];
    for(const v of keys){
      if(v==null) continue;
      const n = typeof v==="string"?parseInt(v,10):v;
      if(Number.isFinite(n)) return `#${n}`;
    }
    return `#${doc.id.slice(-5).toUpperCase()}`;
  }

  /* ======== pickup ======== */
  function formatSlotTime(raw){
    if(!raw) return null;
    try{
      if(raw?.toDate) return raw.toDate().toLocaleTimeString("es-AR",{hour:'2-digit',minute:'2-digit',hour12:false});
      if(raw?.seconds) return new Date(raw.seconds*1000).toLocaleTimeString("es-AR",{hour:'2-digit',minute:'2-digit',hour12:false});
      if(typeof raw==="string"){
        const d=new Date(raw); if(!isNaN(d)) return d.toLocaleTimeString("es-AR",{hour:'2-digit',minute:'2-digit',hour12:false});
        const m=raw.match(/(\d{2})(\d{2})$/); if(m) return m[1]+":"+m[2];
      }
      if(raw instanceof Date) return raw.toLocaleTimeString("es-AR",{hour:'2-digit',minute:'2-digit',hour12:false});
    }catch(e){}
    return null;
  }

  function getPickupPretty(o){
    let pretty =
      o.pickup_time_pretty ||
      formatSlotTime(o.pickup_time || o.pickupTime || o.pickup);

    if(!pretty && o.pickup_slot){
      const m=String(o.pickup_slot).match(/(\d{2})(\d{2})$/);
      if(m) pretty = m[1]+":"+m[2];
    }

    if(!pretty && o.pickup_asap===true)
      pretty="A la brevedad";

    return pretty || "‚Äî";
  }

  /* ======== sonido ======== */
  let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
  let audioCtx=null,audioReady=false;

  function getAudioCtx(){
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    return audioCtx;
  }

  async function ensureAudioReady(){
    try{
      const c=getAudioCtx();
      if(c.state==="suspended") await c.resume();
      audioReady=(c.state==="running");
    }catch(e){ audioReady=false; }
    return audioReady;
  }

  function beepOnce(ctx,d=0.2,f=900,g=0.7){
    const o=ctx.createOscillator(), ga=ctx.createGain();
    o.type="square"; o.frequency.value=f;
    o.connect(ga); ga.connect(ctx.destination);
    ga.gain.setValueAtTime(0.0001,ctx.currentTime);
    ga.gain.exponentialRampToValueAtTime(g,ctx.currentTime+0.02);
    ga.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d);
    o.start(); o.stop(ctx.currentTime+d+0.02);
  }

  async function playBeepTriple(){
    if(!soundEnabled) return;
    if(!await ensureAudioReady()) return;
    const c=getAudioCtx();
    beepOnce(c); setTimeout(()=>beepOnce(c),300); setTimeout(()=>beepOnce(c),600);
  }

  $("#btnBell").onclick = ()=>{
    soundEnabled=!soundEnabled;
    localStorage.setItem("rb_bell_enabled",JSON.stringify(soundEnabled));
    $("#btnBell").classList.toggle("active",soundEnabled);
    if(soundEnabled) playBeepTriple();
  };
  $("#btnBell").classList.toggle("active",soundEnabled);

  $("#btnLogout").onclick=()=>logout();

  /* ======== filtros ======== */
  const tabs=$("#tabs");
  let currentFilter="recibidos", lastSnap=null, idToDoc=new Map();

  tabs.addEventListener("click",e=>{
    const el=e.target.closest("[data-f]");
    if(!el) return;
    currentFilter=el.dataset.f;
    tabs.querySelectorAll(".chipf").forEach(x=>x.classList.remove("active"));
    el.classList.add("active");
    if(lastSnap) renderList(lastSnap);
  });

  const passFilter = o => {
    const s=o.status||"accepted";
    if(currentFilter==="recibidos") return ["accepted","pending_payment","in_prep","ready"].includes(s);
    if(currentFilter==="entregados") return s==="delivered";
    if(currentFilter==="cancelled") return s==="cancelled";
    return true;
  };

  /* ======== acciones ======== */
  async function setOrderStatus(id,next){
    try{
      await db.collection("orders").doc(id).update({
        status: next,
        statusHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()})
      });
    }catch(e){ alert("No se pudo actualizar el estado: "+e.message); }
  }

  async function setPaymentStatus(id,paid){
    try{
      await db.collection("orders").doc(id).update({
        paid: !!paid,
        payment_status: paid?"paid":"pending_payment",
        statusHistory: firebase.firestore.FieldValue.arrayUnion({
          to: paid?"paid":"pending_payment",
          at:new Date().toISOString()
        })
      });
    }catch(e){
      alert("Error guardando pago: "+e.message);
    }
  }

  /* ======== auto imprimir ======== */
  let autoPrint = JSON.parse(localStorage.getItem("rb_auto_print") || "false");
  $("#btnAutoPrint").classList.toggle("active", autoPrint);

  $("#btnAutoPrint").onclick = ()=>{
    autoPrint=!autoPrint;
    localStorage.setItem("rb_auto_print",JSON.stringify(autoPrint));
    $("#btnAutoPrint").classList.toggle("active", autoPrint);
  };
    /* ========= RENDER DE CADA PEDIDO ========= */
    const STATE_SEQ=['accepted','in_prep','ready','delivered','cancelled'];
    const STATE_LABEL={
      accepted:"Recibido",
      in_prep:"En preparaci√≥n",
      ready:"Listo para retirar",
      delivered:"Entregado",
      cancelled:"Cancelar"
    };

    function normalizeFriesLabel(raw){
      if(!raw) return "";
      let s=String(raw).toLowerCase().replace(/[_-]/g," ").trim();
      if(!s) return "";
      if(s.includes("sin sal")) return "Sin sal";
      if(s.includes("sazon")) return "Sazonadas";
      if(s.includes("sal")) return "Con sal";
      return "";
    }

    function computeRawSubtotal(o){
      const items = Array.isArray(o.items)?o.items:[];
      return items.reduce((t,it)=>{
        const qty=it.qty||1;
        const base=(it.price||0)*qty;
        const patty=(it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)*qty;
        const cheddar=(it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0)*qty;
        return t+base+patty+cheddar;
      },0);
    }

    function computeOrderTotal(o){
      return (typeof o.total==="number") ? o.total : computeRawSubtotal(o);
    }

    function renderOrder(doc){
      const o=doc.data();
      const dt=pickDocDate(o);
      const dtText = dt.toLocaleDateString("es-AR")+", "+dt.toLocaleTimeString("es-AR");
      const pickupPretty = getPickupPretty(o);
      const isPaid = o.payment_status==="paid" || o.paid===true;
      const st = o.status ?? "accepted";
      const items = Array.isArray(o.items)?o.items:[];

      const lines = items.map(it=>{
        const qty=it.qty||1;
        const subtotal=
          (it.price||0)*qty
          + (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)*qty
          + (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0)*qty;

        const friesText = normalizeFriesLabel(it.fries||it.side||"") || "‚Äî";

        let commentHtml="";
        if (Array.isArray(it.notes)){
          commentHtml = it.notes.map((c,i)=>`<div class="sub">‚Ä¢ Nota ${i+1}: ${c}</div>`).join("");
        } else if (typeof it.notes==="string" && it.notes.trim()){
          commentHtml = `<div class="sub">‚Ä¢ Nota: ${it.notes.trim()}${qty>1?" (todas)":""}</div>`;
        }

        return `
        <div class="item">
          <div>‚Ä¢ <strong>${qty}√ó ${it.name||""}</strong></div>
          <div class="sub">Papas: ${friesText}</div>
          ${commentHtml}
          <div class="sub">Subtotal: ${money(subtotal)}</div>
        </div>`;
      }).join("");

      const payToggleClass = isPaid ? "is-paid" : "is-pending";
      const payToggleText = isPaid ? "PAGADO ‚úì" : "PENDIENTE DE PAGO";

      const payMethodSelect = `
        <select class="pay-method-select" data-id="${doc.id}">
          <option value="">M√©todo de pago...</option>
          <option value="efectivo"     ${o.pago==="efectivo"?"selected":""}>Efectivo</option>
          <option value="debito"       ${o.pago==="debito"?"selected":""}>D√©bito</option>
          <option value="credito"      ${o.pago==="credito"?"selected":""}>Cr√©dito</option>
          <option value="mercadopago"  ${o.pago==="mercadopago"?"selected":""}>Mercado Pago</option>
          <option value="transferencia"${o.pago==="transferencia"?"selected":""}>Transferencia</option>
          <option value="otro"         ${o.pago==="otro"?"selected":""}>Otro</option>
        </select>
      `;

      return `
      <div class="order ${st==="cancelled"?"cancelled":""}" data-id="${doc.id}">
        <div class="order-head">
          <div>
            <div class="order-title">${displayOrderNumber(doc)} ‚Äî ${o.nombre||"Cliente"}</div>
            <div class="muted">${dtText}</div>

            <div class="chips">
              <span class="chip">Estado: ${st}</span>
              <span class="chip">Retiro: ${o.entrega||"mostrador"}</span>
              <span class="chip">Horario: ${pickupPretty}</span>
              ${o.telefono?`<span class="chip">Tel: ${o.telefono}</span>`:""}
              ${o.source?`<span class="chip">Origen: ${o.source}</span>`:""}
            </div>

            <div class="stateBtns">
              ${STATE_SEQ.map(key=>`
                <button class="state-btn state-${key} ${STATE_SEQ.indexOf(key)<=STATE_SEQ.indexOf(st)?"on":""}"
                  data-act="${key}">${STATE_LABEL[key]}
                </button>`).join("")}
            </div>
          </div>

          <div>
            <div class="right-total">${money(computeOrderTotal(o))}</div>

            <div class="pay-line">
              ${payMethodSelect}

              <button class="btn pay-toggle ${payToggleClass}"
                data-pay-toggle="${isPaid?"paid":"pending"}">
                ${payToggleText}
              </button>

              <button class="btn" data-print>üñ® Imprimir</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="items">${lines||"<div class='muted'>Sin √≠tems.</div>"}</div>
      </div>`;
    }

    /* ========= RENDER LISTA ========= */
    function renderList(snap){
      lastSnap=snap;
      idToDoc=new Map(snap.docs.map(d=>[d.id,d]));

      const docs=snap.docs.filter(d=>passFilter(d.data()));
      $("#orders").innerHTML = docs.length
        ? docs.map(renderOrder).join("")
        : "<p class='muted'>No hay pedidos.</p>";

      document.querySelectorAll(".order").forEach(card=>{
        const id=card.dataset.id;

        /* Estado */
        card.querySelectorAll("[data-act]").forEach(btn=>{
          btn.addEventListener("click",()=>setOrderStatus(id,btn.dataset.act));
        });

        /* Pago */
        const payBtn = card.querySelector("[data-pay-toggle]");
        if(payBtn){
          payBtn.addEventListener("click", async ()=>{
            const wasPaid = payBtn.dataset.payToggle==="paid";
            payBtn.disabled=true;

            payBtn.dataset.payToggle = wasPaid?"pending":"paid";
            payBtn.classList.toggle("is-paid",!wasPaid);
            payBtn.classList.toggle("is-pending",wasPaid);
            payBtn.textContent = wasPaid ? "PENDIENTE DE PAGO" : "PAGADO ‚úì";

            await setPaymentStatus(id,!wasPaid);
            payBtn.disabled=false;
          });
        }

        /* M√©todo de pago */
        const select = card.querySelector(".pay-method-select");
        if(select){
          select.addEventListener("change", async ()=>{
            await db.collection("orders").doc(id).update({
              pago: select.value,
              payment_method: select.value
            });
          });
        }

        /* üî• IMPRIMIR ‚Äî VERSI√ìN FIX */
        const pr = card.querySelector("[data-print]");
        if(pr){
          pr.addEventListener("click",()=>{
            const snapDoc = lastSnap.docs.find(x=>x.id===id);
            if(snapDoc) trySilentPrint(snapDoc);
          });
        }
      });
    }

    /* ========= TICKET ========= */
    function trySilentPrint(docSnap){
      const html = buildTicketHTML(docSnap);
      const iframe=document.createElement("iframe");
      iframe.style.position="fixed";
      iframe.style.right=0;
      iframe.style.bottom=0;
      iframe.style.width=0;
      iframe.style.height=0;
      iframe.style.border=0;
      document.body.appendChild(iframe);

      const doc=iframe.contentWindow.document;
      doc.open(); doc.write(html); doc.close();

      iframe.contentWindow.onafterprint=()=>iframe.remove();
      setTimeout(()=>iframe.remove(),15000);
    }

    /* ========= FIRESTORE SUBSCRIBE ========= */
    (async function subscribe(){
      try{
        const probe=await db.collection("orders").limit(1).get();
        let dateField=null;
        if(!probe.empty) dateField=chooseDateField(probe.docs[0].data());

        let q=db.collection("orders");
        if(dateField) q=q.orderBy(dateField,"desc");

        let first=true;

        q.limit(500).onSnapshot(snap=>{
          $("#ordersError").style.display="none";
          renderList(snap);

          if(first){ first=false; return; }

          snap.docChanges().forEach(ch=>{
            if(ch.type==="added"){
              playBeepTriple();
              if(autoPrint){
                const snapDoc = snap.docs.find(x=>x.id===ch.doc.id);
                if(snapDoc) trySilentPrint(snapDoc);
              }
            }
          });
        });
      }catch(e){
        $("#ordersError").textContent="No se pudo cargar la lista.";
        $("#ordersError").style.display="block";
      }
    })();

  });
  </script>

  <script src="pwa.js"></script>
</body>
</html>
