<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:22px; --shadow:0 12px 34px rgba(0,0,0,.10); --ring:#eaeaea;
      --warn:#ffb74d; --warnText:#8a4b00; --danger:#b00020;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.active{background:var(--primary);color:#fff;border-color:#2ecc71}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b00000}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}
    .kpi{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;margin:0 0 18px 0;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .kbadge{min-width:160px;background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:10px 14px}
    .klabel{font-size:12px;color:var(--muted)}
    .kvalue{font-weight:800;font-size:20px}
    .chartwrap{width:100%;margin-top:10px}
    .chartbox{width:100%;height:260px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .chipf{background:#f3f3f3;border:1px solid var(--ring);color:#333;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chipf.active{background:#2ecc71;color:#fff;border-color:#2ecc71}
    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#f3f3f3;border:1px solid var(--ring);color:#333;border-radius:999px;padding:6px 10px;font-size:13px}
    .muted{color:var(--muted)}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap}
    .items{margin-top:10px}
    .item{margin:8px 0 6px 0}
    .item strong{font-weight:700}
    .item .sub{color:var(--muted);font-size:13px;margin-top:3px}
    .money{white-space:nowrap}
    .divider{height:1px;background:#efefef;margin:10px 0}
    input[type="month"]{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;outline:none}
    .stateBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .err{color:var(--danger);font-weight:600}

    /* Botonera de pago (grande) */
    .payGroup{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .paybtn{font-size:18px;padding:14px 18px;border-width:2px;border-radius:14px;cursor:pointer}
    .paybtn.paid{background:var(--primary);border-color:var(--primary);color:#fff}
    .paybtn.unpaid{background:#fff3e0;border-color:var(--warn);color:var(--warnText)}
  </style>
</head>
<body>
  <!-- Guardia de acceso con sesi√≥n de 10 minutos -->
  <script>
    (function guard(){
      const exp = parseInt(localStorage.getItem('rb_auth_expires')||'0',10);
      const now = Date.now();
      if (!exp || now > exp) {
        localStorage.removeItem('rb_auth_token');
        localStorage.removeItem('rb_auth_expires');
        localStorage.removeItem('rb_auth_v2');
        localStorage.removeItem('rb_admin_ok');
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=expired&next=' + next);
        return;
      }
      const msLeft = exp - now;
      setTimeout(()=>{
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=expired&next=' + next);
      }, Math.min(msLeft, 2147483647));
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Pedidos</a>
      <div class="spacer"></div>
      <button id="btnBell" class="btn" title="Activar/desactivar sonido">üîî Sonido</button>
      <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <div class="kpi">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <strong>Resumen mensual</strong>
        <input type="month" id="monthPicker" />
        <button id="btnReloadKPI" class="btn">Actualizar</button>
      </div>
      <div class="spacer"></div>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div class="kbadge"><div class="klabel">Pedidos</div><div class="kvalue" id="kpiCount">‚Äî</div></div>
        <div class="kbadge"><div class="klabel">Ingresos</div><div class="kvalue" id="kpiRevenue">‚Äî</div></div>
      </div>
      <div class="chartwrap"><canvas id="monthChart" class="chartbox"></canvas></div>
      <div id="kpiError" class="err" style="display:none;margin-top:6px"></div>
    </div>

    <h1>√öltimos pedidos</h1>
    <div class="tabs" id="tabs">
      <span class="chipf active" data-f="all">Todos</span>
      <span class="chipf" data-f="new">Nuevos</span>
      <span class="chipf" data-f="in_prep">En preparaci√≥n</span>
      <span class="chipf" data-f="ready">Listos</span>
      <span class="chipf" data-f="delivered">Entregados</span>
      <span class="chipf" data-f="cancelled">Cancelados</span>
    </div>
    <div id="orders"></div>
    <div id="ordersError" class="err" style="display:none;margin-top:8px"></div>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* ===================== FIREBASE ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}
    const db = firebase.firestore();

    /* ===================== HELPERS ===================== */
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const friesName = f => f==="con_sazon" ? "Con saz√≥n" : (f==="sin_sazon" ? "Sin sazonar" : "‚Äî");
    const monthPicker = $("#monthPicker");
    const kpiErr = $("#kpiError");
    const ordersErr = $("#ordersError");

    (function setDefaultMonth(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      try{ monthPicker.value = `${d.getFullYear()}-${m}`; }catch(_){}
    })();

    function pickDocDate(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){
        if (obj[k]==null) continue;
        const v = obj[k];
        try{
          if (v?.toDate) return v.toDate();
          if (typeof v === 'number') return new Date(v);
          if (typeof v === 'string') {
            const d = new Date(v);
            if (!isNaN(d.getTime())) return d;
            const m = v.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?/);
            if (m){
              const day=+m[1], mon=+m[2]-1, yr=+m[3]<100?2000+(+m[3]):+m[3];
              const hh=+m[4]||0, mm=+m[5]||0;
              const d2=new Date(yr,mon,day,hh,mm,0,0);
              if(!isNaN(d2.getTime())) return d2;
            }
          }
        }catch(e){}
      }
      return null;
    }
    function chooseDateField(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){ if (obj && obj[k]!=null) return k; }
      return null;
    }
    function displayOrderNumber(doc){
      const o = doc.data();
      const candidates = [o.orderNumber, o.number, o.numero, o.num, o.numPedido, o.nro, o.orderNo, o.seq, o.n, o.idPedido, o.pedidoNumber, o.pedido];
      for (const c of candidates){
        if (c == null) continue;
        const n = (typeof c === "string") ? parseInt(c,10) : c;
        if (Number.isFinite(n)) return `#${n}`;
      }
      return `#${doc.id.slice(-5).toUpperCase()}`;
    }
    function unitWithExtras(it){
      const base = it.price || 0;
      const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0);
      const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
      return base + pz + ch;
    }
    function computeOrderTotal(o){
      if (typeof o.total === "number") return o.total;
      const items = Array.isArray(o.items) ? o.items : [];
      return items.reduce((t,it)=> t + (it.type==="burger" ? unitWithExtras(it) : (it.price||0)) * (it.qty||0), 0);
    }

    /* ===================== SONIDO (m√°s fuerte + MP3 opcional) ===================== */
    const SOUND_PATHS = ["sound.mp3","audio/sound.mp3","sounds/sound.mp3"];
    let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
    let soundVolume  = parseFloat(localStorage.getItem("rb_sound_volume")||"0.9");
    let audioCtx = null, audioBuffer = null;

    const btnBell = $("#btnBell");
    const updateBellUI = ()=> btnBell.classList.toggle("active", soundEnabled);
    updateBellUI();

    function getAudioCtx(){ if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
    async function tryLoadBuffer(path){
      const res = await fetch(path,{cache:"no-store"}); if(!res.ok) throw new Error("not found");
      const arr = await res.arrayBuffer(); const ctx = getAudioCtx(); return await ctx.decodeAudioData(arr);
    }
    async function loadCustomSound(){
      for (const p of SOUND_PATHS){
        try{ audioBuffer = await tryLoadBuffer(p); localStorage.setItem("rb_sound_src", p); return true; }catch(_){}
      }
      return false;
    }
    function unlockAudio(){ try{ getAudioCtx().resume(); }catch(e){} }
    window.addEventListener("pointerdown", unlockAudio, {once:true});
    function playBeep(){
      if(!soundEnabled) return;
      try{
        const ctx = getAudioCtx();
        if (audioCtx.state === "suspended") audioCtx.resume();
        if (audioBuffer){
          const src = ctx.createBufferSource();
          src.buffer = audioBuffer;
          const gain = ctx.createGain();
          gain.gain.value = soundVolume;
          src.connect(gain).connect(ctx.destination);
          src.start(0);
        } else {
          const o = ctx.createOscillator(); const g = ctx.createGain();
          o.type = "square"; o.frequency.value = 1000;
          o.connect(g); g.connect(ctx.destination);
          const now = ctx.currentTime;
          g.gain.setValueAtTime(0.0001, now);
          g.gain.exponentialRampToValueAtTime(soundVolume, now + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now + 0.40);
          o.start(now); o.stop(now + 0.42);
        }
      }catch(e){}
    }
    loadCustomSound();

    btnBell.onclick = ()=>{ soundEnabled=!soundEnabled; localStorage.setItem("rb_bell_enabled", JSON.stringify(soundEnabled)); updateBellUI(); unlockAudio(); };
    $("#btnLogout").onclick = ()=>{
      localStorage.removeItem('rb_auth_token');
      localStorage.removeItem('rb_auth_expires');
      localStorage.removeItem("rb_auth_v2");
      localStorage.removeItem("rb_admin_ok");
      location.replace('login.html?reason=guard');
    };

    /* ===================== KPI + CHART ===================== */
    let monthChart;
    function ensureChart(labels, orders, revenue){
      const ctx = document.getElementById("monthChart").getContext("2d");
      if(monthChart) monthChart.destroy();
      monthChart = new Chart(ctx,{type:'bar',data:{labels,
        datasets:[
          {type:'bar',label:'Pedidos',data:orders,backgroundColor:'rgba(46,204,113,.35)',borderColor:'#2ecc71',borderWidth:1,yAxisID:'y'},
          {type:'line',label:'Ingresos ($)',data:revenue,borderColor:'#2ecc71',backgroundColor:'rgba(46,204,113,.10)',borderWidth:2,tension:.25,yAxisID:'y2'}
        ]},
        options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
          scales:{y:{beginAtZero:true},y2:{beginAtZero:true,position:'right'},x:{grid:{display:false}}}}
      });
    }

    const monthKey = ()=> {
      const d = monthPicker && monthPicker.value
        ? new Date(monthPicker.value + '-01T00:00:00')
        : new Date();
      return {y:d.getFullYear(), m:d.getMonth()+1, days:new Date(d.getFullYear(), d.getMonth()+1, 0).getDate()};
    };

    async function loadKPI(){
      kpiErr.style.display="none"; kpiErr.textContent="";
      try{
        const probe = await db.collection('orders').limit(1).get();
        let dateField = null;
        if (!probe.empty) dateField = chooseDateField(probe.docs[0].data());

        let q = db.collection('orders');
        if (dateField) q = q.orderBy(dateField,'desc'); else q = q.orderBy(firebase.firestore.FieldPath.documentId());
        const snap = await q.limit(1000).get();

        const {y,m,days} = monthKey();
        const labels = Array.from({length:days},(_,i)=>`${i+1}`);
        const dayOrders = Array(days).fill(0);
        const dayRevenue = Array(days).fill(0);
        let count=0, revenue=0;

        snap.forEach(doc=>{
          const data=doc.data();
          const dt = pickDocDate(data); if(!dt) return;
          if (dt.getFullYear()!==y || (dt.getMonth()+1)!==m) return;
          const d = dt.getDate()-1;
          dayOrders[d] += 1;
          const tot = computeOrderTotal(data);
          dayRevenue[d] += tot;
          count++; revenue += tot;
        });

        $("#kpiCount").textContent = count.toLocaleString("es-AR");
        $("#kpiRevenue").textContent = money(revenue);
        ensureChart(labels, dayOrders, dayRevenue);
      }catch(err){
        console.error(err);
        kpiErr.textContent = "No se pudo cargar el resumen mensual.";
        kpiErr.style.display="block";
      }
    }
    $("#btnReloadKPI").onclick = loadKPI;

    /* ===================== LISTADO + ESTADOS + PAGO ===================== */
    const tabs = $("#tabs"); const ordersHost = $("#orders");
    let currentFilter="all", lastSnap=null, initialLoaded=false; const seenIds=new Set();

    tabs.addEventListener("click",(e)=>{
      const el=e.target.closest("[data-f]"); if(!el) return;
      currentFilter=el.dataset.f;
      tabs.querySelectorAll(".chipf").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      if(lastSnap) renderList(lastSnap);
    });

    const passFilter = (o)=>{
      if(currentFilter==="all") return true;
      if(currentFilter==="new") return (o.status??"accepted")==="accepted"||(o.status??"accepted")==="pending_payment";
      return (o.status??"")===currentFilter;
    };

    async function setOrderStatus(id,next,orderData){
      try{
        // Confirmaci√≥n si marcan entregado pero el efectivo est√° pendiente
        const payState = (orderData?.paymentStatus) || (orderData?.pago==='efectivo' ? 'unpaid' : 'paid');
        if(next==='delivered' && orderData?.pago==='efectivo' && payState!=='paid'){
          const ok = confirm('Este pedido en efectivo est√° marcado como PENDIENTE DE PAGO. ¬øConfirm√°s ENTREGADO igualmente?');
          if(!ok) return;
        }
        await db.collection("orders").doc(id).update({
          status: next,
          statusHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()}),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        playBeep();
      }catch(e){ alert("No se pudo actualizar el estado: "+(e?.message||e)); }
    }

    async function setPaymentStatus(id,next){
      try{
        await db.collection("orders").doc(id).set({
          paymentStatus: next, // 'paid' | 'unpaid'
          paymentHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()}),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        playBeep();
      }catch(e){ alert("No se pudo actualizar el pago: "+(e?.message||e)); }
    }

    function renderOrder(doc){
      const o=doc.data(); const dt=pickDocDate(o);
      const dtText=dt? dt.toLocaleDateString('es-AR')+', '+dt.toLocaleTimeString('es-AR') : '‚Äî';
      const items = Array.isArray(o.items)?o.items:[];
      const lines = items.map(it=>{
        if(it.type==="burger"){
          const unit=unitWithExtras(it), sub=unit*(it.qty||0);
          const ex=[]; if(it.extras?.patty)ex.push(`+${it.extras.patty} med`); if(it.extras?.cheddar)ex.push(`+${it.extras.cheddar} cheddar`);
          const notes=it.notes?` ¬∑ Notas: ${it.notes}`:"";
          return `<div class="item"><div>‚Ä¢ <strong>${it.qty||0}√ó ${it.name}</strong></div>
          <div class="sub">Papas: ${friesName(it.fries)}${ex.length?` ¬∑ ${ex.join(" ¬∑ ")}`:""}${notes}
          <div>Unit: <span class="money">${money(unit)}</span> ‚Äî Subtotal: <span class="money">${money(sub)}</span></div></div></div>`;
        } else {
          const sub=(it.price||0)*(it.qty||0);
          return `<div class="item"><div>‚Ä¢ <strong>${it.qty||0}√ó ${it.name}</strong></div>
          <div class="sub">Unit: <span class="money">${money(it.price||0)}</span> ‚Äî Subtotal: <span class="money">${money(sub)}</span></div></div>`;
        }
      }).join("");

      const telChip=o.telefono?`<span class="chip">Tel: ${o.telefono}</span>`:"";
      const st=o.status??"accepted";

      // Estado de pago
      const payState = o.paymentStatus || (o.pago==='efectivo' ? 'unpaid' : 'paid'); // default
      const payChip = `<span class="chip">Pago: ${o.pago||'‚Äî'}${o.pago==='efectivo' ? ' ‚Äî ' + (payState==='paid'?'PAGADO':'PENDIENTE') : ''}</span>`;

      // Botones de estado (ahora SIEMPRE visibles, salvo cancelado)
      const showStateBtns = (st!=='cancelled');
      const stateBtns = showStateBtns
        ? `<div class="stateBtns">
             <button class="btn" data-act="accepted">Recibido</button>
             <button class="btn" data-act="in_prep">En preparaci√≥n</button>
             <button class="btn" data-act="ready">Listo para retirar</button>
             <button class="btn" data-act="delivered">Entregado</button>
           </div>`
        : "";

      // Botones grandes de pago (solo para efectivo)
      const payBtns = (o.pago==='efectivo')
        ? `<div class="payGroup">
             <button class="paybtn paid"   data-pay="paid"   title="Marcar como PAGADO">PAGO</button>
             <button class="paybtn unpaid" data-pay="unpaid" title="Marcar como PENDIENTE">PENDIENTE DE PAGO</button>
           </div>`
        : "";

      return `<div class="order" data-id="${doc.id}">
        <div class="order-head">
          <div>
            <div class="order-title">${displayOrderNumber(doc)} ‚Äî ${o.nombre??'Cliente'}</div>
            <div class="muted">${dtText}</div>
            <div class="chips">
              <span class="chip">Pedido: ${displayOrderNumber(doc)}</span>
              <span class="chip">Estado: ${st}</span>
              <span class="chip">Retiro: ${o.entrega||'‚Äî'}</span>
              ${telChip}
              ${payChip}
            </div>
            ${stateBtns}
            ${payBtns}
          </div>
          <div class="right-total">${money(computeOrderTotal(o))}</div>
        </div>
        <div class="divider"></div>
        <div class="items">${lines || '<div class="muted">Sin √≠tems.</div>'}</div>
      </div>`;
    }

    function renderList(snap){
      const docs = snap.docs.filter(d=>passFilter(d.data()));
      ordersHost.innerHTML = docs.length
        ? docs.map(renderOrder).join("")
        : '<p class="muted">No hay pedidos.</p>';

      document.querySelectorAll(".order").forEach(card=>{
        const id=card.dataset.id;

        // Clicks de estado (con orden actual para validaciones)
        card.querySelectorAll("[data-act]").forEach(btn=>{
          btn.addEventListener("click",()=>{
            const doc = lastSnap?.docs?.find(d=>d.id===id);
            const o = doc?.data?.() || {};
            setOrderStatus(id, btn.dataset.act, o);
          });
        });

        // Clicks de pago
        card.querySelectorAll("[data-pay]").forEach(btn=>{
          btn.addEventListener("click",()=> setPaymentStatus(id, btn.dataset.pay));
        });
      });
    }

    (async function subscribeOrders(){
      try{
        const probe = await db.collection("orders").limit(1).get();
        let dateField = null;
        if (!probe.empty) dateField = chooseDateField(probe.docs[0].data());
        let q = db.collection("orders");
        if (dateField) q = q.orderBy(dateField,'desc'); else q = q.orderBy(firebase.firestore.FieldPath.documentId());
        q.limit(100).onSnapshot(snap=>{
          ordersErr.style.display="none"; ordersErr.textContent="";
          lastSnap=snap; renderList(snap);
          snap.docChanges().forEach(ch=>{
            if(ch.type==='added'){
              const id=ch.doc.id;
              if(!initialLoaded && !seenIds.has(id)){ seenIds.add(id); } else { playBeep(); }
            }
          });
          initialLoaded=true;
        }, (err)=>{
          console.error(err);
          ordersErr.textContent="No se pudo cargar la lista de pedidos.";
          ordersErr.style.display="block";
        });
      }catch(err){
        console.error(err);
        ordersErr.textContent="No se pudo inicializar la lista de pedidos.";
        ordersErr.style.display="block";
      }
    })();

    // Cargar KPI al iniciar
    loadKPI();
  });
  </script>
</body>
</html>
