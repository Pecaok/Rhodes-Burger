<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#625A45" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #625A45; --primary-dark: #4a4434;
      --text: #1f2937; --muted: #6b7280; --bg: #f3f4f6; --card: #ffffff;
      --ring: #e5e7eb; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --font: 'Inter', sans-serif;
      
      /* Colores Estado */
      --st-accepted: #fbbf24; 
      --st-in_prep: #f97316; 
      --st-ready: #06b6d4; 
      --st-delivered: #22c55e; 
      --st-cancelled: #ef4444; 
      --pay-paid: #15803d; --pay-pending: #ea580c;
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font); -webkit-tap-highlight-color: transparent;}
    
    /* --- HEADER UNIFICADO --- */
    header { position: sticky; top: 0; z-index: 1000; background: #fff; border-bottom: 1px solid var(--ring); }
    
    .topbar {
        max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 12px;
        display: flex; align-items: center; gap: 6px;
        overflow: visible; 
    }

    .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; text-decoration: none; margin-right: 5px; flex-shrink: 0; }
    .brand img { width: 32px; height: 32px; border-radius: 6px; margin-right: 8px; }
    
    .spacer { flex: 1; }

    .nav-btn {
        padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #4b5563; font-weight: 600; font-size: 14px; 
        transition: all 0.2s; border: 1px solid transparent; flex-shrink: 0; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; background: transparent;
    }
    .nav-btn:hover { background: #f9fafb; }
    .nav-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 5px rgba(98, 90, 69, 0.3); }
    
    .icon-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--ring); background: #fff; cursor: pointer; font-size: 16px; flex-shrink: 0; transition: all 0.2s; }
    .icon-btn:hover { background: #f0f0f0; }
    
    /* ESTILOS ACTIVOS */
    .icon-btn.active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    .icon-btn#btnBell.active { background: #e0f2fe; border-color: #0284c7; color: #0284c7; }
    .icon-btn#btnAutoPrint.active { background: #dcfce7; border-color: #16a34a; color: #15803d; }
    
    .btn-danger { color: #d32f2f; background: #ffebee; border: 1px solid #ffcdd2; }

    /* DROPDOWN MENU */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { 
        display: none; position: absolute; background-color: #fff; min-width: 160px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-radius: 12px; border: 1px solid var(--ring); 
        z-index: 2000; top: 115%; right: 0; 
        padding: 5px; 
    }
    .dropdown.show .dropdown-content { display: block; animation: slideDown 0.2s ease; }
    .dropdown-content a { display: block; padding: 10px; text-decoration: none; color: #374151; font-size: 14px; font-weight: 500; border-radius: 8px; }
    .dropdown-content a:hover { background: #f3f4f6; color: var(--primary); }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- CONTENEDOR --- */
    .container { max-width: 800px; margin: 20px auto; padding: 0 16px; padding-bottom: 80px; }
    h1 { font-size: 24px; font-weight: 800; color: #111; margin-bottom: 16px; }

    /* TABS */
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .tab { padding: 8px 16px; border-radius: 99px; background: #fff; border: 1px solid var(--ring); color: #6b7280; font-weight: 600; font-size: 13px; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
    .tab.active { background: #1f2937; color: #fff; border-color: #1f2937; }

    /* TARJETA */
    .order { background: #fff; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 20px; overflow: hidden; border: 1px solid var(--ring); animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .order-head { padding: 16px; border-bottom: 1px dashed var(--ring); display: flex; justify-content: space-between; align-items: flex-start; }
    .order-title { font-size: 18px; font-weight: 800; color: #111; line-height: 1.2; }
    .order-meta { font-size: 13px; color: var(--muted); margin-top: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    
    .chip { padding: 2px 8px; border-radius: 6px; background: #f3f4f6; font-weight: 600; font-size: 11px; color: #374151; }
    .chip.mostrador { background: #e0f2fe; color: #0369a1; }
    .chip.time { background: #fef3c7; color: #92400e; }
    .chip.pedidosya { background: #fce7f3; color: #be185d; }
    .chip.rappi { background: #ffedd5; color: #c2410c; }
    
    .price-tag { font-size: 20px; font-weight: 900; color: var(--primary); white-space: nowrap; }

    /* ITEMS */
    .items { padding: 16px; background: #fafafa; }
    .cat-group { margin-bottom: 12px; }
    .cat-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; gap: 4px; }
    .it-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-start; }
    .it-qty { background: #fff; border: 1px solid var(--ring); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 700; font-size: 13px; color: #111; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; }
    .it-det { flex: 1; }
    .it-name { font-weight: 600; font-size: 15px; color: #374151; line-height: 1.3; }
    .it-sub { font-size: 13px; color: #6b7280; display: block; margin-top: 2px; }
    .it-note { font-size: 12px; color: #ef4444; font-weight: 600; background: #fef2f2; display: inline-block; padding: 2px 6px; border-radius: 4px; margin-top: 2px; }

    /* ACTIONS */
    .actions-area { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .stateBtns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .state-btn { padding: 10px 4px; border: 1px solid var(--ring); background: #fff; color: #6b7280; border-radius: 10px; font-weight: 600; font-size: 11px; cursor: pointer; text-align: center; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
    .state-btn:active { transform: scale(0.96); }
    
    .state-btn.on.state-accepted { background: var(--st-accepted); color: #000; border-color: var(--st-accepted); box-shadow: 0 4px 10px rgba(251, 191, 36, 0.3); }
    .state-btn.on.state-in_prep { background: var(--st-in_prep); color: #fff; border-color: var(--st-in_prep); box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3); }
    .state-btn.on.state-ready { background: var(--st-ready); color: #fff; border-color: var(--st-ready); box-shadow: 0 4px 10px rgba(6, 182, 212, 0.3); }
    .state-btn.on.state-delivered { background: var(--st-delivered); color: #fff; border-color: var(--st-delivered); box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
    .state-btn.cancelled { grid-column: span 4; border-color: #fee2e2; color: #ef4444; margin-top: 5px; }

    /* CONTROL ROW (PAGO + ORIGEN) */
    .control-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .pay-select, .source-select { 
        padding: 10px; border-radius: 10px; border: 1px solid var(--ring); 
        font-size: 13px; background: #fff; -webkit-appearance: none; font-weight: 600;
        flex: 1;
    }

    .pay-btn { padding: 0 16px; border-radius: 10px; border: none; font-weight: 700; font-size: 13px; color: #fff; display: flex; align-items: center; gap: 6px; cursor: pointer; flex: 1; justify-content: center; }
    .pay-btn.pending { background: var(--pay-pending); }
    .pay-btn.paid { background: var(--pay-paid); }
    .icon-btn-lg { width: 42px; height: 42px; border-radius: 10px; border: 1px solid var(--ring); background: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; flex-shrink: 0; }

    @media (max-width: 768px) {
        .brand span { display: none; }
        .nav-btn { padding: 8px; font-size: 12px; }
        .nav-btn span { display: none; }
        .dropdown { position: static; }
        .order-head { flex-direction: column; gap: 10px; }
        .price-tag { align-self: flex-end; margin-top: -30px; }
        .stateBtns { grid-template-columns: 1fr 1fr; }
        .control-row { flex-wrap: wrap; }
        .pay-select, .source-select { min-width: 48%; }
    }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try{ firebase.initializeApp(firebaseConfig); }catch(e){ console.error("Error Firebase:", e); }
    const db = firebase.firestore();
    window.idToDoc = new Map();

    const TTL_MS = 20 * 60 * 60 * 1000;
    function checkSession(){
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      if(!ok || (Date.now()-ts > TTL_MS)) location.replace('login.html');
      else localStorage.setItem('rb_admin_t', String(Date.now()));
    }
    checkSession(); setInterval(checkSession, 5*60*1000);

    // =================================================================
    // üî• DATA DE SOPORTE (RECETAS, INVENTARIO, CATALOGO) üî•
    // =================================================================
    let RECETAS_DB = {}; 
    let INVENTARIO_DB = {}; 
    let PRODUCT_CATALOG = {}; // üî• Para saber categor√≠a real (bebida/burger)

    // Cargar Cat√°logo de Productos para identificar categor√≠as
    db.collection('products').onSnapshot(snap => {
        PRODUCT_CATALOG = {};
        snap.forEach(doc => { 
            const d = doc.data();
            // Guardamos por ID y por Nombre para b√∫squeda r√°pida
            PRODUCT_CATALOG[doc.id] = d.category;
            PRODUCT_CATALOG[d.name.trim().toLowerCase()] = d.category;
        });
        if(window.lastSnap) renderList(window.lastSnap); // Re-renderizar si cambia el cat√°logo
    });

    db.collection('recipes').onSnapshot(snap => {
        RECETAS_DB = {};
        snap.forEach(doc => { RECETAS_DB[doc.id] = doc.data().ingredients; });
    });

    db.collection('inventory').onSnapshot(snap => {
        INVENTARIO_DB = {};
        snap.forEach(doc => { 
            INVENTARIO_DB[doc.data().name.trim().toLowerCase()] = doc.id; 
        });
    });
    
    // Cargar precios (por si se necesita recalcular ticket)
    let PRICES_DB = { patty: 2500, cheddar: 300 };
    db.collection('config').doc('prices').onSnapshot(doc => {
        if(doc.exists) PRICES_DB = doc.data();
    });

    function findSmartId(keywords) {
        const stockNames = Object.keys(INVENTARIO_DB);
        for (const key of keywords) {
            if (INVENTARIO_DB[key.toLowerCase()]) return INVENTARIO_DB[key.toLowerCase()];
        }
        for (const stockName of stockNames) {
            for (const key of keywords) {
                if (stockName.includes(key.toLowerCase())) return INVENTARIO_DB[stockName];
            }
        }
        return null;
    }

    async function gestionarStock(pedido, factor) {
        if (!pedido.items) return;
        if(factor === -1 && pedido.stockDescontado) return;
        if(factor === 1 && !pedido.stockDescontado) return;

        console.log(`üìä STOCK update (${factor}) pedido #${pedido.orderNumber}`);
        const batch = db.batch();
        let huboCambios = false;

        pedido.items.forEach(item => {
            const prodName = String(item.name||"").trim(); 
            const prodNameLower = prodName.toLowerCase();
            const qtyPedida = Number(item.qty || 1);

            let ingredientes = RECETAS_DB[prodName];
            if (!ingredientes) {
                const key = Object.keys(RECETAS_DB).find(k => prodName.includes(k));
                if(key) ingredientes = RECETAS_DB[key];
            }

            if (ingredientes) {
                ingredientes.forEach(ing => {
                    let ingID = INVENTARIO_DB[ing.ingrediente.trim().toLowerCase()];
                    if(!ingID) ingID = findSmartId([ing.ingrediente]);

                    if (ingID) {
                        const ref = db.collection('inventory').doc(ingID);
                        const delta = Number(ing.cantidad) * qtyPedida * factor;
                        batch.update(ref, { qty: firebase.firestore.FieldValue.increment(delta) });
                        huboCambios = true;
                    }
                });
            }

            if(item.extras){
                for (const [key, valRaw] of Object.entries(item.extras)) {
                    const val = Number(valRaw);
                    if (val > 0) {
                        let searchTerms = [];
                        let amountPerUnit = 1;

                        if (key === 'patty') {
                            if (prodNameLower.includes('pollo') || prodNameLower.includes('crispy')) {
                                searchTerms = ['medall√≥n de pollo', 'pollo', 'crispy'];
                            } else {
                                searchTerms = ['carne', 'medallon', 'patty'];
                            }
                        } 
                        else if (key === 'cheddar') { searchTerms = ['cheddar', 'queso']; }
                        else if (key === 'bacon') { searchTerms = ['bacon', 'panceta']; amountPerUnit = 0.03; } 
                        else if (key === 'brioche') { searchTerms = ['brioche', 'pan brioche']; }
                        else { searchTerms = [key]; }

                        const ingID = findSmartId(searchTerms);
                        if (ingID) {
                            const ref = db.collection('inventory').doc(ingID);
                            const delta = amountPerUnit * val * factor;
                            batch.update(ref, { qty: firebase.firestore.FieldValue.increment(delta) });
                            huboCambios = true;
                        }
                    }
                }
            }

            // Detecci√≥n de burger para descontar pan y papas (si no hay receta expl√≠cita)
            // üî• USAMOS LA MISMA L√ìGICA QUE EN FINANZAS
            // Normalizar categor√≠a de DB a min√∫sculas
            let catDB = PRODUCT_CATALOG[prodNameLower] || PRODUCT_CATALOG[item.id];
            if (catDB) catDB = String(catDB).toLowerCase().trim();

            let esBurger = false;
            
            if (catDB) {
                if (catDB.includes('hamburguesa') || catDB.includes('burger')) esBurger = true;
            } else {
                // Fallback por nombre
                esBurger = prodNameLower.includes('hamburguesa') || prodNameLower.includes('burger') || prodNameLower.includes('doble') || prodNameLower.includes('simple') || prodNameLower.includes('royal') || prodNameLower.includes('crispy') || prodNameLower.includes('cuarto') || prodNameLower.includes('big');
            }

            if (esBurger) {
                const papasID = findSmartId(['papas', 'bastones', 'papas fritas', 'congeladas', 'bolsa de papas']);
                if (papasID) {
                    const ref = db.collection('inventory').doc(papasID);
                    const deltaPapas = 0.2 * qtyPedida * factor;
                    batch.update(ref, { qty: firebase.firestore.FieldValue.increment(deltaPapas) });
                    huboCambios = true;
                }
            }
        });

        if (huboCambios) {
            const pedidoRef = db.collection('orders').doc(pedido.id);
            batch.update(pedidoRef, { stockDescontado: (factor === -1) });
            await batch.commit();
            console.log("‚úÖ Stock actualizado.");
        }
    }

    // GLOBALES
    window.logout = () => { localStorage.removeItem('rb_admin_ok'); location.replace('login.html'); };

    window.setOrderStatus = async (id, next, isPaid) => {
        if(next==='delivered' && !isPaid){ alert("‚ö†Ô∏è COBRAR PRIMERO: El pedido figura pendiente."); return; }
        try{ 
            const docSnap = await db.collection('orders').doc(id).get();
            if(!docSnap.exists) return;
            const pedidoData = { id: docSnap.id, ...docSnap.data() };

            if(next === 'delivered'){ await gestionarStock(pedidoData, -1); } 
            else if(next === 'cancelled'){ await gestionarStock(pedidoData, 1); }

            await db.collection("orders").doc(id).update({status:next}); 
        }catch(e){console.error(e);}
    };

    window.setPaymentStatus = async (id, currentPaid, currentMethod) => {
        if(!currentPaid && (!currentMethod || currentMethod === "")){ 
            alert("‚ö†Ô∏è Seleccion√° un M√âTODO DE PAGO primero."); return; 
        }
        try{ await db.collection("orders").doc(id).update({ paid: !currentPaid, payment_status: !currentPaid ? 'paid' : 'pending_payment' }); }catch(e){}
    };
    
    // Funci√≥n inteligente de pago (auto-paga si es MP, Debito, etc)
    window.updatePago = async (id, val) => { 
        try { 
            const updateData = { pago: val };
            if (['mercado_pago', 'debito', 'transferencia'].includes(val)) {
                updateData.paid = true;
                updateData.payment_status = 'paid';
            }
            await db.collection("orders").doc(id).update(updateData); 
        } catch(e) { console.error(e); } 
    };

    window.updateSource = async (id, val) => { 
        try { await db.collection("orders").doc(id).update({ source: val }); } catch(e) {} 
    };

    window.printOrder = (id) => { const doc = window.idToDoc.get(id); if(doc) window.trySilentPrint(doc); };
    window.pickDate = (o) => { if(o.createdAt?.toDate) return o.createdAt.toDate(); if(typeof o.createdAt==='string') return new Date(o.createdAt); return new Date(); };
    window.cleanFries = (raw) => { if(!raw) return ""; const s = String(raw).toLowerCase().replace(/[_-]/g,' ').trim(); if(s.includes('sazon')) return "Sazonadas"; if(s.includes('sin sal')) return "Sin sal"; if(s.includes('con sal')||s.includes('sal')) return "Con sal"; return s.charAt(0).toUpperCase() + s.slice(1); };
    
    // üî• CATEGORIZACI√ìN INTELIGENTE: USA EL CAT√ÅLOGO DE LA DB üî•
    window.getCat = (item) => {
        const n = String(item.name || "").trim().toLowerCase();
        const t = String(item.type || "").toLowerCase();
        const id = item.id;

        // 1. Prioridad: Tipo expl√≠cito (del mostrador)
        if (t === 'drink') return 'd';
        if (t === 'side') return 'f';
        if (t === 'burger') return 'b';

        // 2. Prioridad: Buscar en Cat√°logo (para pedidos web)
        let catDB = PRODUCT_CATALOG[id] || PRODUCT_CATALOG[n];
        
        if (catDB) {
            // Convertimos a min√∫scula y checkeamos
            catDB = String(catDB).toLowerCase().trim();
            if (catDB.includes('bebida') || catDB.includes('drink')) return 'd';
            if (catDB.includes('guarnicion') || catDB.includes('papa') || catDB.includes('side')) return 'f';
            if (catDB.includes('hamburguesa') || catDB.includes('burger')) return 'b';
        }

        // 3. Fallback: Palabras clave (si no est√° en cat√°logo)
        const drinks = ['coca', 'agua', 'cerveza', 'andes', 'aquarius', 'pepsi', '7up', 'heineken', 'corona', 'patagonia', 'brahma', 'quilmes', 'stella', 'imperial', 'sprite', 'levite', 'paso de los toros', 'vino', 'fanta', 'gaseosa'];
        if (drinks.some(k => n.includes(k))) return 'd';

        if (n.includes('papas') || n.includes('fritas') || n.includes('aros') || n.includes('nugget')) return 'f';

        // Si no es nada de lo anterior, asumimos que es plato principal (Burger)
        return 'b'; 
    };
  </script>
</head>

<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt=""><span>Pedidos</span></a>
      
      <div class="spacer"></div>

      <a href="pedido_local.html" class="nav-btn active">üì¶ Pedidos</a>
      <a href="finanzas.html" class="nav-btn">üìà Finanzas</a>
      
      <div class="dropdown">
            <button onclick="document.querySelector('.dropdown').classList.toggle('show')" class="nav-btn">üìã Stock ‚ñæ</button>
            <div class="dropdown-content">
                <a href="stock.html">üì¶ Stock</a>
                <a href="ingresos.html">üì• Ingresos</a>
            </div>
      </div>
      
      <a href="mostrador.html" class="nav-btn">üßæ Mostrador</a>
      <a href="admin.html" class="nav-btn">‚öôÔ∏è Admin</a>
      
      <button id="btnBell" class="icon-btn" title="Sonido">üîî</button>
      <button id="btnAutoPrint" class="icon-btn" title="Autoimprimir">üñ®Ô∏è</button>
      <button onclick="window.logout()" class="nav-btn btn-danger">Salir</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>
    <div class="tabs" id="tabs">
      <button class="tab active" data-f="recibidos">Cocina / Recibidos</button>
      <button class="tab" data-f="entregados">Entregados</button>
      <button class="tab" data-f="cancelled">Cancelados</button>
      <button class="tab" data-f="all">Todos</button>
    </div>
    <div id="orders"><div class="empty-state">Cargando...</div></div>
  </main>

 <script>
  window.addEventListener('DOMContentLoaded', () => {
    // --- 1. CONFIGURACI√ìN DE AUDIO ---
    let audioCtx = null;
    const initAudio = () => {
        if (!audioCtx) {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    };
    document.body.addEventListener('click', initAudio, { once: true });
    document.body.addEventListener('touchstart', initAudio, { once: true });

    const playBeep = () => {
        let soundOn = JSON.parse(localStorage.getItem("rb_sound")||"true");
        if(!soundOn) return;
        initAudio();
        if (!audioCtx) return;
        const now = audioCtx.currentTime;
        const createBeep = (startTime) => {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square'; osc.frequency.setValueAtTime(1000, startTime); 
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(startTime);
            gain.gain.setValueAtTime(0.5, startTime); 
            gain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.15);
            osc.stop(startTime + 0.15);
        };
        createBeep(now); createBeep(now + 0.25); createBeep(now + 0.50); createBeep(now + 0.75);
    };

    // --- 2. LOGICA INTERFAZ ---
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    let currentFilter = "recibidos"; let lastSnap = null;
    
    document.getElementById("tabs").addEventListener("click", (e)=>{
        const btn = e.target.closest(".tab"); if(!btn) return;
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.f;
        if(window.lastSnap) renderList(window.lastSnap);
    });

    // --- BOTONES CON ESTADO VISUAL ---
    const btnBell = document.getElementById("btnBell");
    let soundOn = JSON.parse(localStorage.getItem("rb_sound")||"true");
    
    const updBell = ()=>{ 
        btnBell.classList.toggle("active", soundOn); 
        btnBell.innerText = soundOn ? 'üîî' : 'üîï';
    }; 
    updBell();

    btnBell.onclick = ()=>{ 
        initAudio(); // Importante
        soundOn = !soundOn; 
        localStorage.setItem("rb_sound", soundOn); 
        updBell(); 
        if(soundOn) playBeep(); 
    };

    const btnAP = document.getElementById("btnAutoPrint");
    let autoP = JSON.parse(localStorage.getItem("rb_autop")||"false");
    
    const updAP = ()=>{ 
        btnAP.classList.toggle("active", autoP); 
    }; 
    updAP();

    btnAP.onclick = ()=>{ 
        autoP = !autoP; 
        localStorage.setItem("rb_autop", autoP); 
        updAP(); 
    };

    // --- 3. FIREBASE ---
    let isInit=true; setTimeout(()=>isInit=false, 3000);
    db.collection("orders").orderBy("orderNumber", "desc").limit(300).onSnapshot(snap => {
        window.lastSnap = snap;
        renderList(snap);
        snap.docChanges().forEach(ch => {
            if(ch.type==='added' && !isInit){
                console.log("üîî Nuevo:", ch.doc.data().orderNumber);
                if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]); 
                playBeep(); 
                if(autoP) window.trySilentPrint(window.idToDoc.get(ch.doc.id));
            }
        });
    }, err => {
        document.getElementById("orders").innerHTML = `<div class="empty-state" style="color:red">Error: ${err.message}</div>`;
    });

    // --- HELPER HORARIOS ---
    function getCleanTime(o, defaultTime) {
        if (o.pickup_slot && typeof o.pickup_slot === 'string' && o.pickup_slot.includes(':')) return o.pickup_slot;
        let raw = o.pickup_time_pretty || o.pickup_time;
        if (raw && typeof raw === 'string') {
            if (raw.includes('_')) {
                const parts = raw.split('_'); const timePart = parts[parts.length - 1]; 
                if (timePart.length === 4 && !isNaN(timePart)) return timePart.substring(0, 2) + ':' + timePart.substring(2, 4);
            }
            if (raw.includes(':') && raw.length <= 5) return raw;
        }
        return defaultTime;
    }

    // üî•üî•üî• FUNCI√ìN CORREGIDA Y ROBUSTA üî•üî•üî•
    function consolidateItems(list) {
        const map = new Map();
        list.forEach(it => {
            let exKey = "";
            if(it.extras) {
                 const keys = Object.keys(it.extras).sort();
                 exKey = keys.map(k => `${k}:${it.extras[k]}`).join("-");
            }
            
            // CORRECCION: Convertimos todo a String para evitar el error .trim()
            const noteKey = String(it.notes || "").trim().toLowerCase();
            const nameKey = String(it.name || "").trim();
            
            const key = `${nameKey}_${exKey}_${noteKey}`;
            
            if(map.has(key)){
                map.get(key).qty += (Number(it.qty)||1);
            } else {
                map.set(key, { ...it, qty: (Number(it.qty)||1) });
            }
        });
        return Array.from(map.values());
    }

    // --- RENDER ---
    function renderList(snap){
        let docs = snap.docs.map(d => ({ data: d.data(), id: d.id, ref: d }));
        window.idToDoc = new Map(snap.docs.map(d=>[d.id,d]));
        docs.sort((a,b) => window.pickDate(b.data) - window.pickDate(a.data));

        const filtered = docs.filter(o => {
            const s = o.data.status || 'accepted';
            if(currentFilter === 'recibidos') return ['accepted','in_prep','ready','pending_payment'].includes(s);
            if(currentFilter === 'entregados') return s === 'delivered';
            if(currentFilter === 'cancelled') return s === 'cancelled';
            return true;
        });

        const cont = document.getElementById("orders");
        if(filtered.length===0){ cont.innerHTML = '<div class="empty-state">No hay pedidos.</div>'; return; }
        cont.innerHTML = filtered.map(x => buildOrderHTML(x.ref)).join("");
    }

    function buildOrderHTML(doc){
        const o = doc.data();
        const dt = window.pickDate(o);
        const dateStr = dt.toLocaleDateString("es-AR", {day:'2-digit', month:'2-digit'}); // üî• SE AGREGA FECHA
        const timeStr = dt.toLocaleTimeString("es-AR", {hour:'2-digit', minute:'2-digit'});
        const st = o.status || 'accepted';
        const isPaid = (o.payment_status==='paid') || !!o.paid;
        
        const displayTime = getCleanTime(o, ""); 
        
        const LABELS = {accepted:'Recibido', in_prep:'Cocina', ready:'Listo', delivered:'Entregado'};
        const btns = ['accepted','in_prep','ready','delivered'].map(k => {
            const isOn = (k === st) ? 'on' : '';
            const opacity = (k==='delivered' && !isPaid) ? 'opacity:0.5' : '';
            return `<div class="state-btn ${isOn} state-${k}" style="${opacity}" onclick="setOrderStatus('${doc.id}', '${k}', ${isPaid})"><span>${LABELS[k]}</span></div>`;
        }).join('');

        let payVal = o.pago;
        if(payVal === 'mostrador_sin_especificar') payVal = "";

        let srcVal = o.source || 'web'; // Default Web si no tiene

        const items = Array.isArray(o.items) ? o.items : [];
        let cats = { b:[], f:[], d:[], o:[] };
        items.forEach(it => {
            const cat = window.getCat(it);
            if(cat === 'b'){
                cats.b.push(it);
                let fName = it.fries;
                if(!fName && it.extras?.fries) fName = it.extras.fries;
                if(!fName && it.guarnicion) fName = it.guarnicion;
                if(fName && fName !== 'sin_papas') cats.f.push({name: fName, qty: it.qty||1});
            } else { cats[cat].push(it); }
        });

        // üî• APLICAMOS CONSOLIDACI√ìN PARA LA VISTA
        cats.b = consolidateItems(cats.b);
        cats.f = consolidateItems(cats.f);
        cats.d = consolidateItems(cats.d);
        cats.o = consolidateItems(cats.o);

        const renderSec = (list, icon, title) => {
            if(!list.length) return "";
            const rows = list.map(it => {
                let ex = [];
                if(it.extras?.patty) ex.push(`+${it.extras.patty} carne`);
                if(it.extras?.cheddar) ex.push(`+${it.extras.cheddar} cheddar`);
                
                let dName = esc(it.name);
                if(title.includes("PAPAS")) dName = window.cleanFries(it.name);

                const extrasHtml = ex.map(e => `<div class="it-sub" style="color:#d97706; font-weight:600">‚Ä¢ ${e}</div>`).join('');

                return `<div class="it-row">
                   <div class="it-qty">${it.qty||1}</div>
                   <div class="it-det">
                      <div class="it-name">${dName}</div>
                      ${extrasHtml}
                      ${it.notes ? `<div class="it-note">${esc(it.notes)}</div>` : ''}
                   </div>
                </div>`;
            }).join("");
            return `<div class="cat-group"><div class="cat-title">${icon} ${title}</div>${rows}</div>`;
        };

        const esc = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
        const itemsHTML = renderSec(cats.b,'üçî','HAMBURGUESAS') + renderSec(cats.f,'üçü','PAPAS') + renderSec(cats.d,'ü•§','BEBIDAS') + renderSec(cats.o,'üî∏','OTROS');
        const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);

        return `
        <div class="order ${st==='cancelled'?'cancelled':''}">
           <div class="order-head">
              <div>
                 <div class="order-title">#${o.orderNumber||'--'} ‚Äî ${o.source==='mostrador'?esc(o.nombre)+' (Local)':esc(o.nombre)}</div>
                 <div class="order-meta">
                    <span>${dateStr} ${timeStr}</span> 
                    <span class="chip ${srcVal}">${esc(srcVal)}</span> ${displayTime ? `<span class="chip time">‚è∞ ${esc(displayTime)}</span>` : ''}
                 </div>
              </div>
              <div class="price-tag">${money(total)}</div>
           </div>
           
           <div class="items">${itemsHTML || '<div class="it-sub">Sin √≠tems</div>'}</div>

           <div class="actions-area">
              <div class="control-row">
                 <select class="pay-select" onchange="updatePago('${doc.id}', this.value)">
                    <option value="" ${!payVal?'selected':''}>Pago...</option>
                    <option value="efectivo" ${payVal==='efectivo'?'selected':''}>Efectivo</option>
                    <option value="mercado_pago" ${payVal==='mercado_pago'?'selected':''}>QR (MP)</option>
                    <option value="debito" ${payVal==='debito'?'selected':''}>D√©bito</option>
                    <option value="transferencia" ${payVal==='transferencia'?'selected':''}>Transferencia</option>
                 </select>

                 <select class="source-select" onchange="updateSource('${doc.id}', this.value)">
                    <option value="web" ${srcVal==='web'?'selected':''}>Web</option>
                    <option value="mostrador" ${srcVal==='mostrador'?'selected':''}>Local</option>
                    <option value="pedidosya" ${srcVal==='pedidosya'?'selected':''}>PedidosYa</option>
                    <option value="rappi" ${srcVal==='rappi'?'selected':''}>Rappi</option>
                 </select>
              </div>

              <div class="control-row">
                 <button class="pay-btn ${isPaid?'paid':'pending'}" onclick="setPaymentStatus('${doc.id}', ${isPaid}, '${payVal}')">
                    ${isPaid ? 'PAGADO' : 'COBRAR'}
                 </button>
                 <div class="icon-btn-lg" onclick="printOrder('${doc.id}')">üñ®Ô∏è</div>
              </div>

              <div class="stateBtns">
                 ${btns}
                 <div class="state-btn cancelled" onclick="setOrderStatus('${doc.id}', 'cancelled', ${isPaid})">CANCELAR</div>
              </div>
           </div>
        </div>`;
    }

    // --- IMPRESI√ìN ---
    window.trySilentPrint = function(docSnap){
       const o = docSnap.data();
       const esc = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
       const m = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
       
       const dt = window.pickDate(o);
       const dateStr = dt.toLocaleDateString("es-AR");
       const timeStr = dt.toLocaleTimeString("es-AR",{hour12:false});

       const horarioRetiro = getCleanTime(o, timeStr.substring(0, 5));

       let payTxt = o.pago;
       if(!payTxt || payTxt==='mostrador_sin_especificar' || payTxt==="") payTxt="A COBRAR EN CAJA";
       else if(payTxt==='mercado_pago') payTxt="QR (MP)";
       else payTxt = payTxt.toUpperCase();

       const isPaid = (o.payment_status === 'paid') || o.paid;
       const stPay = isPaid ? "PAGADO" : "PENDIENTE";
       
       const items = Array.isArray(o.items) ? o.items : [];
       let cats = { b:[], f:[], d:[], o:[] };
       items.forEach(it => {
          const cat = window.getCat(it);
          if(cat==='b'){
             cats.b.push(it);
             let fName = it.fries;
             if(!fName && it.extras?.fries) fName = it.extras.fries;
             if(!fName && it.guarnicion) fName = it.guarnicion;
             if(fName && fName!=='sin_papas') cats.f.push({name: fName, qty: it.qty||1});
          } else { cats[cat].push(it); }
       });

       cats.b = consolidateItems(cats.b);
       cats.f = consolidateItems(cats.f);
       cats.d = consolidateItems(cats.d);
       cats.o = consolidateItems(cats.o);
       
       const rSec = (l, ti) => {
         if(!l.length) return "";
         const r = l.map(i => {
            let dName = esc(i.name);
            if(ti.includes("PAPA")) dName = window.cleanFries(i.name);
            let h = `<div class="row name"><div class="l">${i.qty||1} √ó ${dName}</div></div>`;
            if(!ti.includes("PAPA")){
               if(i.extras?.patty) h+=`<div class="sub">‚Ä¢ +${i.extras.patty} carne</div>`;
               if(i.extras?.cheddar) h+=`<div class="sub">‚Ä¢ +${i.extras.cheddar} cheddar</div>`;
            }
            if(i.notes) h+=`<div class="sub">üìù ${esc(i.notes)}</div>`;
            h+=`<div class="sep"></div>`;
            return h;
         }).join("");
         return `<div class="blk"><div class="lbl" style="border-bottom:1px solid #000;display:inline-block;margin-top:6px">${ti}</div></div>${r}`;
       };

       const body = rSec(cats.b,'HAMBURGUESAS') + rSec(cats.f,'PAPAS') + rSec(cats.d,'BEBIDAS') + rSec(cats.o,'OTROS');
       const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);
       const name = o.source==='mostrador' ? (o.nombre+' (Local)') : o.nombre;

       const html = `<!doctype html><html><head><style>
       @page{size:58mm auto;margin:0} body{width:58mm;margin:0 auto;padding:5px;font-family:monospace;font-size:12px;font-weight:700;color:#000;line-height:1.2}
       .c{text-align:center} .hr{border-top:1px dashed #000;margin:6px 0} .row{display:flex;justify-content:space-between}
       .lbl{font-size:10px;text-transform:uppercase} .sub{font-size:11px;margin-left:5px;font-weight:400} .sep{border-top:1px dotted #999;margin:3px 0}
       </style></head><body>
         <div class="c" style="font-size:16px;margin-bottom:4px">Rhodes Burgers</div>
         <div class="c" style="font-size:14px">#${o.orderNumber||'--'}</div>
         <div class="c" style="font-size:18px;margin:5px 0">[ ${stPay} ]</div>
         <div class="hr"></div>
         <div><span class="lbl">CLIENTE:</span> ${esc(name)}</div>
         <div class="c" style="font-size:16px;margin:6px 0;font-weight:900">Retira: ${esc(horarioRetiro)}</div>
         <div><span class="lbl">PAGO:</span> ${payTxt}</div>
         ${o.notes ? `<div class="hr"></div><div><span class="lbl">NOTA:</span> ${esc(o.notes)}</div>` : ''}
         <div class="hr"></div>
         ${body}
         <div class="hr"></div>
         <div class="row"><div class="l">TOTAL</div><div>${m(total)}</div></div>
         <div class="c" style="margin-top:10px;font-size:10px">${dateStr} ${timeStr}</div>
         <script>window.onload=()=>{setTimeout(()=>{window.print()},200)}<\/script>
       </body></html>`;
       
       const f = document.createElement('iframe'); f.style.cssText='position:fixed;left:0;top:0;width:0;height:0;border:0';
       document.body.append(f); const d=f.contentWindow.document; d.open();d.write(html);d.close();
       setTimeout(()=>f.remove(), 10000);
    };
  });
  </script>
</body>
</html>
