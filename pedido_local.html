<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:22px; --shadow:0 12px 34px rgba(0,0,0,.10); --ring:#eaeaea;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.ghost{background:#fff}
    .btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.small{padding:6px 10px;font-size:13px}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    .kpi{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;margin:0 0 18px 0;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .kpi .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .kbadge{min-width:160px;background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:10px 14px}
    .klabel{font-size:12px;color:var(--muted)}
    .kvalue{font-weight:800;font-size:20px}
    .chartwrap{width:100%;margin-top:10px}
    .chartbox{width:100%;height:260px}

    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
    .chip{background:#f3f3f3;border:1px solid var(--ring);color:#333;border-radius:999px;padding:6px 10px;font-size:13px}
    .chip.badge{background:#f7f7f7}

    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .muted{color:var(--muted)}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap}
    .items{margin-top:10px}
    .item{margin:8px 0 6px 0}
    .item strong{font-weight:700}
    .item .sub{color:var(--muted);font-size:13px;margin-top:3px}
    .money{white-space:nowrap}
    .divider{height:1px;background:#efefef;margin:10px 0}

    input[type="month"]{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;outline:none}

    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .pill{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}
    .pill.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Pedidos</a>
      <div class="spacer"></div>
      <button id="btnBell" class="btn ghost" title="Activar/desactivar sonido">üîî Sonido</button>
      <button id="btnLogout" class="btn">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <div class="kpi">
      <div class="row">
        <strong>Resumen mensual</strong>
        <input type="month" id="monthPicker">
        <button id="btnReloadKPI" class="btn ghost">Actualizar</button>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <div class="kbadge"><div class="klabel">Pedidos</div><div class="kvalue" id="kpiCount">‚Äî</div></div>
        <div class="kbadge"><div class="klabel">Ingresos</div><div class="kvalue" id="kpiRevenue">‚Äî</div></div>
      </div>
      <div class="chartwrap"><canvas id="monthChart" class="chartbox"></canvas></div>
    </div>

    <h1>√öltimos pedidos</h1>
    <div class="filters">
      <span class="chip badge">Todos</span>
      <span class="chip badge">Nuevos</span>
      <span class="chip badge">En preparaci√≥n</span>
      <span class="chip badge">Listos</span>
      <span class="chip badge">Entregados</span>
      <span class="chip badge">Cancelados</span>
    </div>
    <div id="orders"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    /* ===== GUARD (login simple) ===== */
    const SESSION_KEY="rb_auth_v1";
    if(!localStorage.getItem(SESSION_KEY)) location.href="login.html";
    document.getElementById("btnLogout").onclick=()=>{localStorage.removeItem(SESSION_KEY);location.href="login.html";};

    /* ===== FIREBASE ===== */
    const firebaseConfig={apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.firestore();

    /* ===== HELPERS ===== */
    const $=s=>document.querySelector(s);
    const money=n=>(Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const friesName=f=>f==="con_sazon"?"Con saz√≥n":(f==="sin_sazon"?"Sin sazonar":"‚Äî");
    function unitWithExtras(it){const b=it.price||0,p=(it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0),c=(it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0);return b+p+c;}
    function computeOrderTotal(o){if(typeof o.total==="number")return o.total;let t=0;const items=Array.isArray(o.items)?o.items:[];for(const it of items){t+= (it.type==="burger"?unitWithExtras(it):(it.price||0))*(it.qty||0);}return t;}

    /* ===== RENDER ===== */
    function renderOrder(doc){
      const o=doc.data(), id=doc.id;
      const when=o.createdAt?.toDate?o.createdAt.toDate():null;
      const dt=when?when.toLocaleDateString('es-AR')+', '+when.toLocaleTimeString('es-AR'):'‚Äî';
      const items=Array.isArray(o.items)?o.items:[];
      const lines=items.map(it=>{
        if(it.type==="burger"){
          const unit=unitWithExtras(it), sub=unit*(it.qty||0), ex=[];
          if(it.extras?.patty)ex.push(`+${it.extras.patty} med`);
          if(it.extras?.cheddar)ex.push(`+${it.extras.cheddar} cheddar`);
          const notes=it.notes?` ¬∑ Notas: ${it.notes}`:"";
          return `<div class="item"><div>‚Ä¢ <strong>${it.qty||0}√ó ${it.name}</strong></div><div class="sub">Papas: ${friesName(it.fries)}${ex.length?` ¬∑ ${ex.join(" ¬∑ ")}`:""}${notes}<div>Unit: <span class="money">${money(unit)}</span> ‚Äî Subtotal: <span class="money">${money(sub)}</span></div></div></div>`;
        }else{
          const sub=(it.price||0)*(it.qty||0);
          return `<div class="item"><div>‚Ä¢ <strong>${it.qty||0}√ó ${it.name}</strong></div><div class="sub">Unit: <span class="money">${money(it.price||0)}</span> ‚Äî Subtotal: <span class="money">${money(sub)}</span></div></div>`;
        }
      }).join("");
      const telChip=o.telefono?`<span class="chip">Tel: ${o.telefono}</span>`:"";
      const statusChip=`<span class="chip">Estado: ${o.status||"‚Äî"}</span>`;
      return `
        <div class="order">
          <div class="order-head">
            <div>
              <div class="order-title">#${o.orderNumber??"‚Äî"} ‚Äî ${o.nombre??"Cliente"}</div>
              <div class="muted">${dt}</div>
              <div class="chips">
                ${statusChip}
                <span class="chip">Retiro: ${o.entrega||'‚Äî'}</span>
                ${telChip}
                <span class="chip">Pago: ${o.pago||'‚Äî'}</span>
              </div>
            </div>
            <div class="right-total">${money(computeOrderTotal(o))}</div>
          </div>
          <div class="actions">
            <button class="pill" data-id="${id}" data-status="preparing">En preparaci√≥n</button>
            <button class="pill" data-id="${id}" data-status="ready_for_pickup">Listo para retirar</button>
            <button class="pill" data-id="${id}" data-status="delivered">Entregado</button>
          </div>
          <div class="divider"></div>
          <div class="items">${lines||'<div class="muted">Sin √≠tems.</div>'}</div>
        </div>`;
    }

    /* ===== BEEP ===== */
    let soundEnabled=JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
    const btnBell=$("#btnBell");
    function updateBellUI(){btnBell.classList.toggle("active",soundEnabled);}
    updateBellUI();
    btnBell.onclick=()=>{soundEnabled=!soundEnabled;localStorage.setItem("rb_bell_enabled",JSON.stringify(soundEnabled));updateBellUI();};
    function playBeep(){if(!soundEnabled)return;try{const c=new (window.AudioContext||window.webkitAudioContext)(),o=c.createOscillator(),g=c.createGain();o.type="sine";o.frequency.value=880;o.connect(g);g.connect(c.destination);o.start();g.gain.setValueAtTime(0.0001,c.currentTime);g.gain.exponentialRampToValueAtTime(0.2,c.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+0.18);o.stop(c.currentTime+0.2);}catch(e){}}

    /* ===== KPI & CHART ===== */
    const monthPicker=$("#monthPicker"),kpiCount=$("#kpiCount"),kpiRevenue=$("#kpiRevenue"),btnReloadKPI=$("#btnReloadKPI");
    (function(){const d=new Date();const m=(d.getMonth()+1).toString().padStart(2,"0");monthPicker.value=`${d.getFullYear()}-${m}`;})();
    function monthRange(ym){const [y,m]=ym.split("-").map(n=>parseInt(n,10));return {start:new Date(y,m-1,1,0,0,0,0),end:new Date(y,m,1,0,0,0,0)};}
    let monthChart;
    function ensureChart(labels,orders,revenue){
      const ctx=document.getElementById("monthChart").getContext("2d");
      if(monthChart){monthChart.destroy();}
      monthChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[
        {type:'bar',label:'Pedidos',data:orders,backgroundColor:'rgba(46, 204, 113, 0.35)',borderColor:'#2ecc71',borderWidth:1,yAxisID:'y'},
        {type:'line',label:'Ingresos ($)',data:revenue,borderColor:'#2ecc71',backgroundColor:'rgba(46, 204, 113, 0.10)',borderWidth:2,tension:.25,yAxisID:'y2'}
      ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{display:true},tooltip:{callbacks:{label:(ctx)=>ctx.datasetIndex===1?`${ctx.dataset.label}: ${(ctx.parsed.y||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0})}`:`${ctx.dataset.label}: ${ctx.parsed.y}`}}},scales:{y:{beginAtZero:true,title:{display:true,text:'Pedidos'},grid:{color:'rgba(0,0,0,0.05)'}},y2:{beginAtZero:true,position:'right',title:{display:true,text:'Ingresos ($)'},grid:{drawOnChartArea:false}},x:{grid:{display:false}}}});
    }
    async function loadKPI(){
      const ym=monthPicker.value;if(!ym)return;
      const [yStr,mStr]=ym.split("-");const y=parseInt(yStr,10),m=parseInt(mStr,10);
      const totalDays=new Date(y,m,0).getDate();
      const labels=Array.from({length:totalDays},(_,i)=>String(i+1));
      const dayOrders=Array.from({length:totalDays},()=>0);
      const dayRevenue=Array.from({length:totalDays},()=>0);
      const {start,end}=monthRange(ym);
      let count=0,revenue=0;
      const snap=await db.collection("orders")
        .where("createdAt",">=",firebase.firestore.Timestamp.fromDate(start))
        .where("createdAt","<",firebase.firestore.Timestamp.fromDate(end))
        .get();
      snap.forEach(d=>{const data=d.data();const when=data.createdAt?.toDate?data.createdAt.toDate():null;const idx=Math.max(0,Math.min(totalDays-1,(when?when.getDate():1)-1));const tot=computeOrderTotal(data);count+=1;revenue+=tot;dayOrders[idx]+=1;dayRevenue[idx]+=tot;});
      kpiCount.textContent=count.toLocaleString("es-AR");kpiRevenue.textContent=money(revenue);
      ensureChart(labels,dayOrders,dayRevenue);
    }
    btnReloadKPI.onclick=loadKPI;monthPicker.onchange=loadKPI;loadKPI();

    /* ===== LISTADO + SONIDO ===== */
    const ordersHost=$("#orders");const seenIds=new Set();let initialLoaded=false;
    db.collection("orders").orderBy("createdAt","desc").limit(100).onSnapshot(snap=>{
      ordersHost.innerHTML=snap.empty?'<p class="muted">No hay pedidos.</p>':snap.docs.map(renderOrder).join("");
      snap.docChanges().forEach(ch=>{if(ch.type==='added'){const id=ch.doc.id;if(!initialLoaded&&!seenIds.has(id)){seenIds.add(id);}else{playBeep();}}});
      initialLoaded=true;
    });

    /* ===== CAMBIO DE ESTADO (SIN arrayUnion, SIN serverTimestamp) ===== */
    async function setStatus(orderId,nextStatus){
      const ref=db.collection("orders").doc(orderId);
      await db.runTransaction(async tx=>{
        const snap=await tx.get(ref);
        const cur=snap.exists?(snap.data()||{}):{};
        const history=Array.isArray(cur.history)?cur.history.slice(0,500):[];
        history.push({atMs:Date.now(),status:nextStatus});
        tx.update(ref,{status:nextStatus,updatedAtMs:Date.now(),history});
      });
    }
    document.addEventListener("click",async e=>{
      const btn=e.target.closest("[data-status]");if(!btn)return;
      const id=btn.getAttribute("data-id");const st=btn.getAttribute("data-status");
      btn.disabled=true;btn.classList.add("primary");
      try{await setStatus(id,st);}catch(err){console.error(err);alert("No se pudo actualizar el estado: "+(err?.message||err));}
      finally{btn.disabled=false;btn.classList.remove("primary");}
    });
  </script>
</body>
</html>
