<!doctype html>
<html lang="es">
  <script>
  /* ======== SESI√ìN COMPARTIDA ======== */
  const TTL_HOURS = 20;
  const TTL_MS    = TTL_HOURS * 60 * 60 * 1000;

  function sessionValid(){
    const ok = localStorage.getItem('rb_admin_ok') === 'true';
    const ts = Number(localStorage.getItem('rb_admin_t') || 0);
    return ok && (Date.now() - ts) < TTL_MS;
  }
  function bumpSession(){
    if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
  }
  function logout(){
    try{ localStorage.removeItem('rb_admin_ok'); }catch(_){}
    try{ localStorage.removeItem('rb_admin_t'); }catch(_){}
    try{ localStorage.removeItem('rb_auth_v2'); }catch(_){}
    try{ sessionStorage.removeItem('rb_auth_v2'); }catch(_){}
    const next = encodeURIComponent('pedido_local.html');
    location.replace('login.html?reason=logout&next=' + next);
  }

  (function requireSession(){
    if (!sessionValid()){
      const next = encodeURIComponent(
        (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
        (location.search || '') + (location.hash || '')
      );
      location.replace('login.html?next=' + next);
    } else {
      bumpSession();
    }
  })();

  ['click','keydown','focus','mousemove','touchstart','scroll'].forEach(evt=>{
    window.addEventListener(evt, bumpSession, {passive:true});
  });
  </script>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#625A45" />

  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#444; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
      --font: Inter, system-ui, "Segoe UI", Roboto, Arial, sans-serif;
      --st-accepted:#FBC02D; --st-in_prep:#FB8C00; --st-ready:#00ACC1; --st-delivered:#2E7D32; --st-cancelled:#D32F2F;
      --pay-pending:#FFA000; --pay-paid:#625A45;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit}
    .btn.active,.btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .chipf{background:#f3f3f3;border:1px solid var(--ring);color:#111;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chipf.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    
    /* Order Card */
    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:20px;margin:16px 0; border:1px solid transparent}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800; font-size: 1.1rem;}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#f0f0f0;border:1px solid #ddd;color:#333;border-radius:6px;padding:4px 8px;font-size:12px;font-weight:600}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap}
    
    /* ITEMS CATEGORIZADOS */
    .cat-section { margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
    .cat-header {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #888;
        margin-bottom: 8px;
        font-weight: 800;
        display: flex; align-items: center; gap: 6px;
    }
    
    .item-row { display: flex; gap: 12px; margin-bottom: 12px; font-size: 15px; align-items: flex-start; }
    .item-qty { font-weight: 800; font-size: 16px; color: var(--primary); min-width: 24px; }
    .item-det { flex: 1; }
    .item-name { font-weight: 700; color: #111; line-height: 1.2; }
    
    .item-extras { margin-top: 4px; display: flex; flex-direction: column; gap: 2px; }
    .extra-line { font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; }
    .note-line { color: #d32f2f; font-style: italic; font-weight: 600; font-size: 13px; margin-top: 4px; }

    /* Botones Estado */
    .stateBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .state-btn{border:2px solid #dcdcdc;background:#fff;color:#111;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;min-width:160px;text-align:center}
    .state-btn.on{color:#fff;border-color:var(--primary);background:var(--primary)}
    .state-accepted.on{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .state-in_prep.on{background:var(--st-in_prep);border-color:var(--st-in_prep);color:#fff}
    .state-ready.on{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .state-delivered.on{background:var(--st-delivered);border-color:var(--st-delivered);color:#fff}
    .state-cancelled.on{background:var(--st-cancelled);border-color:var(--st-cancelled);color:#fff}

    /* L√≠nea de pago */
    .pay-line{margin-top:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .pay-toggle{min-width:200px;text-align:center}
    .pay-toggle.is-paid{ background:var(--pay-paid); color:#fff; border-color:var(--pay-paid); }
    .pay-toggle.is-pending{ background:var(--pay-pending); color:#fff; border-color:var(--pay-pending); }
    .pay-toggle[disabled]{opacity:.9; cursor:default;}

    .order.cancelled{opacity:.7}
    .order.cancelled .order-title{text-decoration:line-through}

    @media print{
      @page{size:A4 portrait;margin:12mm}
      header,.tabs,.stateBtns,.pay-line .btn,.danger,#btnBell,[title="Ver finanzas"],[title="Panel admin"],[title="Abrir mostrador"],#btnInstall,#btnAutoPrint{display:none!important}
      .order{break-inside:avoid;box-shadow:none;border:1px solid #eee}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Pedidos</a>
      <div class="spacer"></div>
      <nav style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <a href="pedido_local.html" class="btn primary" title="Ver pedidos">üì¶ Pedidos</a>
        <a href="finanzas.html" class="btn" title="Finanzas">üìà Finanzas</a>
        <a href="mostrador.html" class="btn" title="Mostrador">üßæ Mostrador</a>
        <a href="admin.html" class="btn" title="Panel admin">‚öôÔ∏è Admin</a>
      </nav>
      <button id="btnBell" class="btn" title="Activar/desactivar sonido">üîî Sonido</button>
      <button id="btnAutoPrint" class="btn" title="Autoimprimir nuevos pedidos">üñ®Ô∏è Autoimprimir</button>
      <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>
    <div class="tabs" id="tabs">
      <span class="chipf active" data-f="recibidos">Recibidos</span>
      <span class="chipf" data-f="entregados">Entregados</span>
      <span class="chipf" data-f="cancelled">Cancelados</span>
      <span class="chipf" data-f="all">Todos</span>
    </div>
    <div id="orders"></div>
    <div id="ordersError" class="err" style="display:none;margin-top:8px"></div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig);}catch(e){}

    const db = firebase.firestore();
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function pickDocDate(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){
        const v = obj[k];
        if (v?.toDate) return v.toDate();
        if (typeof v === 'number') return new Date(v);
        if (typeof v === 'string'){ const d=new Date(v); if(!isNaN(d)) return d; }
      }
      return null;
    }
    function displayOrderNumber(doc){
      const o=doc.data();
      const c=[o.orderNumber,o.number,o.numero,o.num,o.numPedido,o.nro,o.orderNo,o.seq,o.n,o.idPedido,o.pedidoNumber,o.pedido];
      for(const v of c){ if(v==null) continue; const n=typeof v==="string"?parseInt(v,10):v; if(Number.isFinite(n)) return `#${n}`; }
      return `#${doc.id.slice(-5).toUpperCase()}`;
    }
    function getPickupPretty(o){
      if (o.pickup_time_pretty && String(o.pickup_time_pretty).trim() !== "") return o.pickup_time_pretty;
      if (o.pickup_slot && /^\d{2}:\d{2}$/.test(o.pickup_slot)) return o.pickup_slot;
      const t = o.pickup_time || o.pickupTime || o.pickup;
      if (t) {
        try{
          if (typeof t?.toDate === "function") return t.toDate().toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
          const d = new Date(t);
          if (!isNaN(d)) return d.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
        }catch(_){}
      }
      if (typeof o.pickup_slot === "string") { const m = o.pickup_slot.match(/^(\d{2})(\d{2})$/); if (m) return `${m[1]}:${m[2]}`; }
      if (o.pickup_asap === true) return "A la brevedad";
      return null;
    }

    let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
    let audioCtx = null, audioReady = false;
    function getAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
    async function ensureAudioReady(){ try{ const ctx=getAudioCtx(); if(ctx.state==='suspended') await ctx.resume(); audioReady=(ctx.state==='running'); }catch(e){ audioReady=false; } return audioReady; }
    function beepOnce(ctx, d=0.22, f=900, g=0.7){ const o=ctx.createOscillator(), ga=ctx.createGain(); o.type="square"; o.frequency.value=f; o.connect(ga); ga.connect(ctx.destination); ga.gain.setValueAtTime(0.0001, ctx.currentTime); ga.gain.exponentialRampToValueAtTime(g, ctx.currentTime+0.02); ga.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+d); o.start(); o.stop(ctx.currentTime+d+0.02); }
    async function playBeepTriple(){ if(!soundEnabled) return; const ok=await ensureAudioReady(); if(!ok) return; const ctx=getAudioCtx(); beepOnce(ctx); setTimeout(()=>beepOnce(ctx),320); setTimeout(()=>beepOnce(ctx),640); }
    ['click','touchstart','keydown'].forEach(evt=> window.addEventListener(evt, ()=>{ if(!audioReady) ensureAudioReady(); }, {passive:true}));

    const btnBell=$("#btnBell");
    const updateBellUI=()=>btnBell.classList.toggle("active",soundEnabled);
    updateBellUI();
    btnBell.onclick=()=>{ soundEnabled=!soundEnabled; localStorage.setItem("rb_bell_enabled", JSON.stringify(soundEnabled)); updateBellUI(); if(soundEnabled) playBeepTriple(); };
    $("#btnLogout").onclick=()=>{ logout(); };

    const tabs=$("#tabs");
    let currentFilter="recibidos", lastSnap=null, idToDoc=new Map();
    tabs.addEventListener("click",(e)=>{
      const el=e.target.closest("[data-f]"); if(!el) return;
      currentFilter = el.dataset.f;
      tabs.querySelectorAll(".chipf").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      if (lastSnap) renderList(lastSnap);
    });
    const passFilter=o=>{
      const s = o.status ?? "accepted";
      if(currentFilter==="recibidos"){ return s==="accepted" || s==="pending_payment" || s==="in_prep" || s==="ready"; }
      if(currentFilter==="entregados"){ return s==="delivered"; }
      if(currentFilter==="cancelled"){ return s==="cancelled"; }
      return true;
    };

    async function setOrderStatus(id,next){
      try{ await db.collection("orders").doc(id).update({ status: next, statusHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()}) }); }catch(e){ alert("Error: "+e); }
    }
    async function setPaymentStatus(id, paid){
      try{ await db.collection("orders").doc(id).update({ paid: !!paid, payment_status: paid ? "paid" : "pending_payment", statusHistory: firebase.firestore.FieldValue.arrayUnion({to: paid?"paid":"pending_payment", at:new Date().toISOString()}) }); }catch(e){ alert("Error pago: "+e); }
    }

    const btnStateClass=st=>`state-btn state-${st}`;
    const STATE_SEQ = ['accepted','in_prep','ready','delivered','cancelled'];
    const STATE_LABEL = {accepted:'Recibido', in_prep:'En preparaci√≥n', ready:'Listo para retirar', delivered:'Entregado', cancelled:'Cancelar'};
    const computeRawSubtotal = o => {
      if (typeof o.rawTotal === "number") return o.rawTotal;
      const items = Array.isArray(o.items)?o.items:[];
      return items.reduce((t,it)=>{
        const qty = it.qty||1; const base = (it.price||0)*qty;
        return t + base; 
      },0);
    };
    const computeOrderTotal = o => (typeof o.total === "number") ? o.total : computeRawSubtotal(o);

    /* ========== RENDER CATEGORIZADO (LIMPIO) ========== */
    function renderOrder(doc){
      const o = doc.data();
      const dt = pickDocDate(o);
      const dtText = dt ? dt.toLocaleDateString('es-AR')+', '+dt.toLocaleTimeString('es-AR') : '‚Äî';
      const items = Array.isArray(o.items) ? o.items : [];

      const cats = { burgers:[], fries:[], drinks:[], others:[] };

      items.forEach(it => {
          const name = (it.name||"").toLowerCase();
          const type = (it.type||"").toLowerCase();
          const qty  = it.qty || it.quantity || 1;
          
          if(type === 'burger' || name.includes('hamburguesa') || name.includes('doble') || name.includes('simple') || name.includes('crispy')) {
              cats.burgers.push(it);
              // EXTRAER PAPAS
              if(it.fries && it.fries !== 'sin_papas') {
                  cats.fries.push({ name: it.fries, qty: qty }); // SIN REFERENCIA DE ORIGEN
              }
          } else if (type === 'side' || name.includes('papas') || name.includes('fritas')) {
              cats.fries.push(it);
          } else if (type === 'drink' || name.includes('coca') || name.includes('agua') || name.includes('cerveza') || name.includes('sprite')) {
              cats.drinks.push(it);
          } else {
              cats.others.push(it);
          }
      });

      const renderSection = (title, list, icon) => {
          if(!list.length) return "";
          const rows = list.map(it => {
              const qty = it.qty || it.quantity || 1;
              const name = it.name || "√çtem";
              let extras = [];
              if(it.extras?.patty) extras.push(`ü•© +${it.extras.patty} carne`);
              if(it.extras?.cheddar) extras.push(`üßÄ +${it.extras.cheddar} cheddar`);
              
              const extrasHTML = extras.length 
                ? `<div class="item-extras">${extras.map(e => `<div class="extra-line">${e}</div>`).join("")}</div>` 
                : "";
                
              const notesHTML = it.notes ? `<div class="note-line">üìù ${it.notes}</div>` : "";

              return `
                <div class="item-row">
                   <div class="item-qty">${qty}</div>
                   <div class="item-det">
                      <div class="item-name">${name}</div>
                      ${extrasHTML}
                      ${notesHTML}
                   </div>
                </div>
              `;
          }).join("");

          return `
            <div class="cat-section">
                <div class="cat-header">${icon} ${title}</div>
                ${rows}
            </div>
          `;
      };

      const burgersHTML = renderSection("HAMBURGUESAS", cats.burgers, "üçî");
      const sidesHTML   = renderSection("GUARNICIONES / PAPAS", cats.fries, "üçü");
      const drinksHTML  = renderSection("BEBIDAS", cats.drinks, "ü•§");
      const othersHTML  = renderSection("OTROS", cats.others, "üî∏");

      const fullItemsHTML = burgersHTML + sidesHTML + drinksHTML + othersHTML;

      const pickupPretty = getPickupPretty(o);
      const srcChip = o.source === "mostrador" ? `<span class="chip" style="background:#e3f2fd;color:#0d47a1">üñ•Ô∏è Mostrador</span>` : "";
      const noteGeneral = (o.comment || o.notes || "").toString().trim() ? `<span class="chip">üìù ${o.comment || o.notes}</span>` : "";
      const st = o.status ?? "accepted";
      const curIdx = Math.max(STATE_SEQ.indexOf(st),0);
      
      const stateBtns = `<div class="stateBtns">${STATE_SEQ.map((key,idx)=>`<button class="${btnStateClass(key)} ${idx<=curIdx?'on':''}" data-act="${key}">${STATE_LABEL[key]}</button>`).join('')}</div>`;

      const isPaid = ((o.payment_status === "paid") || o.paid === true);
      const payBtnClasses = `btn pay-toggle ${isPaid?'is-paid':'is-pending'}`;
      const payLine = `
        <div class="pay-line">
          <select class="btn" data-select-pago style="min-width:140px">
            <option value="" disabled ${(!o.pago)?'selected':''}>M√©todo...</option>
            <option value="efectivo" ${o.pago==="efectivo"?"selected":""}>Efectivo</option>
            <option value="debito" ${o.pago==="debito"?"selected":""}>Debito</option>
            <option value="mercado_pago" ${o.pago==="mercado_pago"?"selected":""}>MP</option>
            <option value="transferencia" ${o.pago==="transferencia"?"selected":""}>Transf</option>
          </select>
          <button class="${payBtnClasses}" data-pay-toggle="${isPaid?'paid':'pending'}">${isPaid ? 'PAGADO ‚úì' : 'PENDIENTE $'}</button>
          <button class="btn" data-print>üñ®</button>
        </div>`;

      return `
        <div class="order ${st==='cancelled'?'cancelled':''}" data-id="${doc.id}">
          <div class="order-head">
            <div>
              <div class="order-title">${displayOrderNumber(doc)} ‚Äî ${o.nombre || "Cliente"}</div>
              <div class="muted">N¬∞ interno: ${o.orderNumber || '‚Äî'}</div>
              <div class="muted">${dtText}</div>
              <div class="chips">
                ${srcChip}
                <span class="chip">Retiro: ${o.entrega||"take_away"}</span>
                <span class="chip">‚è∞ ${pickupPretty || "‚Äî"}</span>
                ${noteGeneral}
              </div>
              ${stateBtns}
            </div>
            <div>
              <div class="right-total">${money(computeOrderTotal(o))}</div>
              ${payLine}
            </div>
          </div>
          <div class="items-body">${fullItemsHTML || '<div class="cat-section"><div class="muted">Sin √≠tems</div></div>'}</div>
        </div>
      `;
    }

    /* ===========================================================
       TICKET 58MM LIMPIO (SIN REFERENCIAS)
       =========================================================== */
    function buildTicketHTML(docSnap){
      const o = docSnap.data();
      const escapeHtml = s => (s || "").toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      const moneyT = n => (Number(n) || 0).toLocaleString("es-AR", {style: "currency", currency: "ARS", maximumFractionDigits: 0});
      const orderDisplay = o.orderNumber ? `#${o.orderNumber}` : `#${docSnap.id.slice(-5).toUpperCase()}`;
      
      let dateStr="", timeStr="";
      const dt = pickDocDate(o);
      if(dt){ dateStr=dt.toLocaleDateString("es-AR"); timeStr=dt.toLocaleTimeString("es-AR", { hour12: false }); }
      
      const pickup = getPickupPretty(o) || "A la brevedad";
      const pickupBlockLarge = `<div style="text-align:center;margin:6px 0;font-size:20px;font-weight:900">Retira: ${escapeHtml(pickup)}</div>`;

      // MAPA DE PAGOS
      const PAGO_MAP = {
        "mostrador_sin_especificar": "A COBRAR EN CAJA",
        "efectivo": "EFECTIVO",
        "mercado_pago": "MERCADO PAGO",
        "debito": "D√âBITO",
        "transferencia": "TRANSFERENCIA"
      };
      const pagoReal = o.pago || "";
      const pagoShow = PAGO_MAP[pagoReal] || escapeHtml(pagoReal) || "";

      // SEPARAR ITEMS
      const items = Array.isArray(o.items) ? o.items : [];
      const cats = { burgers:[], fries:[], drinks:[], others:[] };

      items.forEach(it => {
          const name = (it.name||"").toLowerCase();
          const type = (it.type||"").toLowerCase();
          const qty  = it.qty || it.quantity || 1;
          
          if(type === 'burger' || name.includes('hamburguesa') || name.includes('doble') || name.includes('simple') || name.includes('crispy')) {
              cats.burgers.push(it);
              // EXTRAER PAPAS Y MANDARLAS A SU SECCI√ìN
              if(it.fries && it.fries !== 'sin_papas') {
                  cats.fries.push({ name: it.fries, qty: qty }); // SIN REFERENCIA
              }
          } else if (type === 'side' || name.includes('papas')) {
              cats.fries.push(it);
          } else if (type === 'drink' || name.includes('coca')) {
              cats.drinks.push(it);
          } else {
              cats.others.push(it);
          }
      });

      const renderTktSection = (title, list) => {
          if(!list.length) return "";
          const rows = list.map(it => {
              const qty = it.qty||1;
              let h = `<div class="row name"><div class="l">${qty} √ó ${escapeHtml(it.name)}</div></div>`;
              // Extras (solo si no es papa, para evitar duplicar info)
              if(!title.includes("PAPAS")) {
                  if(it.extras?.patty) h += `<div class="sub">‚Ä¢ +${it.extras.patty} carne</div>`;
                  if(it.extras?.cheddar) h += `<div class="sub">‚Ä¢ +${it.extras.cheddar} cheddar</div>`;
              }
              if(it.notes) h += `<div class="sub">üìù ${escapeHtml(it.notes)}</div>`;
              h += `<div class="sep"></div>`;
              return h;
          }).join("");
          return `<div class="blk"><div class="lbl" style="border-bottom:1px solid #000; display:inline-block; margin-bottom:4px; margin-top:8px">${title}</div></div>${rows}`;
      };

      const htmlBody = 
        renderTktSection("HAMBURGUESAS", cats.burgers) +
        renderTktSection("PAPAS", cats.fries) +
        renderTktSection("BEBIDAS", cats.drinks) +
        renderTktSection("OTROS", cats.others);

      const isPaid = ((o.payment_status === "paid") || o.paid === true);
      const payState = isPaid ? "PAGADO" : "PENDIENTE";

      return `
        <!doctype html><html><head><meta charset="utf-8"><title>Ticket</title>
        <style>
          @page{size:58mm auto;margin:0}
          body{width:58mm;font-family:Arial,sans-serif;font-size:13px;font-weight:700;margin:0;padding:2mm;color:#000;box-sizing:border-box}
          .c{text-align:center}
          .brand{font-size:16px}
          .hr{border-top:1px solid #000;margin:4px 0}
          .blk{margin:2px 0}
          .lbl{font-size:11px;text-transform:uppercase}
          .row{display:flex;justify-content:space-between}
          .sub{font-size:11px;margin-left:2mm}
          .sep{border-top:1px dashed #000;opacity:.4;margin:2mm 0}
          .foot{margin-top:3mm;text-align:center;font-size:10px;font-weight:400}
        </style>
        </head><body>
          <div class="c brand">Rhodes Burgers</div>
          <div class="c">${escapeHtml(orderDisplay)}</div>
          <div class="c" style="font-size:18px; margin:4px 0">[ ${payState} ]</div>
          <div class="hr"></div>
          ${o.nombre ? `<div class="blk"><div class="lbl">CLIENTE</div><div>${escapeHtml(o.nombre)}</div></div>` : ""}
          ${pickupBlockLarge}
          ${(pagoShow)?`<div class="blk"><div class="lbl">PAGO</div><div>${pagoShow}</div></div>`:""}
          <div class="hr"></div>
          ${htmlBody}
          <div class="hr"></div>
          <div class="row"><div class="l">TOTAL</div><div>${moneyT(o.total||0)}</div></div>
          <div class="foot">${dateStr} ‚Äî ${timeStr}</div>
          <script>window.onload=()=>{setTimeout(()=>{window.print()},30);}<\/script>
        </body></html>
      `;
    }

    function trySilentPrint(docSnap){ 
      const html = buildTicketHTML(docSnap);
      const iframe = document.createElement('iframe');
      iframe.style.cssText = 'position:fixed;right:0;bottom:0;width:0;height:0;border:0';
      document.body.appendChild(iframe);
      const doc = iframe.contentWindow.document;
      doc.open(); doc.write(html); doc.close();
      setTimeout(()=>{ try{document.body.removeChild(iframe)}catch(e){} }, 15000);
    }

    let autoPrint = JSON.parse(localStorage.getItem("rb_auto_print") || "false");
    const btnAutoPrint = document.getElementById("btnAutoPrint");
    const updateAP = ()=> btnAutoPrint.classList.toggle("active", autoPrint);
    updateAP();
    btnAutoPrint.onclick = ()=>{ autoPrint = !autoPrint; localStorage.setItem("rb_auto_print", JSON.stringify(autoPrint)); updateAP(); };

    (async function subscribeOrders(){
      try{
        let q = db.collection("orders").orderBy("createdAt", "desc").orderBy(firebase.firestore.FieldPath.documentId(), "desc");
        let firstSnapshot = true;
        q.limit(500).onSnapshot(async snap=>{
          lastSnap = snap;
          document.getElementById("ordersError").style.display="none";
          renderList(snap);
          if (firstSnapshot) { firstSnapshot = false; return; }
          for (const ch of snap.docChanges()){
            if (ch.type === 'added') {
              try{ playBeepTriple(); }catch(_){}
              if (autoPrint) trySilentPrint(idToDoc.get(ch.doc.id) || ch.doc);
            }
          }
        }, err=>{ document.getElementById("ordersError").style.display="block"; });
      }catch(err){ document.getElementById("ordersError").style.display="block"; }
    })();

    function renderList(snap){
      const docs=snap.docs.filter(d=>passFilter(d.data()));
      idToDoc=new Map(snap.docs.map(d=>[d.id,d]));
      document.getElementById("orders").innerHTML = docs.length ? docs.map(renderOrder).join("") : '<p class="muted" style="text-align:center; padding:20px">No hay pedidos.</p>';
      
      document.querySelectorAll(".order").forEach(card=>{
        const id=card.dataset.id;
        card.querySelectorAll("[data-act]").forEach(btn=>btn.addEventListener("click",()=>setOrderStatus(id,btn.dataset.act)));
        const payToggle=card.querySelector("[data-pay-toggle]");
        if(payToggle && currentFilter!=="entregados"){
          payToggle.addEventListener("click", ()=>{
            const wasPaid = payToggle.dataset.payToggle === "paid";
            setPaymentStatus(id, !wasPaid);
          });
        }
        const selPago=card.querySelector("[data-select-pago]");
        if(selPago) selPago.addEventListener("change", ()=> db.collection("orders").doc(id).update({ pago: selPago.value }));
        const pr=card.querySelector("[data-print]");
        if(pr) pr.addEventListener("click",()=> trySilentPrint(idToDoc.get(id)));
      });
    }
  });
  </script>
</body>
</html>
