¬°Tienes toda la raz√≥n! El problema es que en el c√≥digo CSS (los estilos) est√°bamos buscando una clase llamada .accepted, pero en el Javascript (la l√≥gica) le est√°bamos poniendo nombre state-accepted. Esa peque√±a diferencia de "nombre" hace que el navegador no sepa que tiene que pintarlos.
He corregido el archivo pedido_local.html para que los nombres coincidan perfectamente.
Aqu√≠ tienes el c√≥digo completo arreglado. Solo c√≥pialo y p√©galo.
Cambios realizados:
 * Correg√≠ la secci√≥n <style> para que reconozca los botones como .state-accepted, .state-ready, etc.
 * Ahora los botones se iluminar√°n con el color correspondiente (Amarillo, Naranja, Azul, Verde) cuando est√©n activos.
<!-- end list -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#625A45" />

  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#444; --bg:#f4f4f9; --card:#fff;
      --ring:#e0e0e0; --shadow:0 4px 12px rgba(0,0,0,.08);
      --font: Inter, system-ui, -apple-system, sans-serif;
      /* Colores de Estado */
      --st-accepted:#ffca28; 
      --st-in_prep:#fb8c00; 
      --st-ready:#00acc1; 
      --st-delivered:#43a047; 
      --st-cancelled:#e53935;
      
      --pay-paid:#2e7d32; --pay-pending:#f57c00;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    
    header{position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.05);padding:0 12px}
    .topbar{max-width:1200px;margin:0 auto;height:60px;display:flex;align-items:center;gap:16px}
    .brand{display:flex;align-items:center;text-decoration:none;color:var(--primary);font-weight:800;font-size:18px}
    .brand img{width:32px;height:32px;border-radius:8px;margin-right:10px}
    .spacer{flex:1}
    
    .nav-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;text-decoration:none;color:var(--text);font-weight:600;font-size:14px;transition:all .2s;border:none;cursor:pointer;background:transparent}
    .nav-btn:hover{background:#f0f0f0}
    .nav-btn.active{background:var(--primary);color:#fff}
    .icon-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;border:1px solid var(--ring);background:#fff;cursor:pointer;font-size:18px;transition:all .2s}
    .icon-btn:hover{background:#f0f0f0}
    .icon-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn-danger{color:#d32f2f;background:#ffebee;border:1px solid #ffcdd2}
    .btn-danger:hover{background:#ffcdd2}

    .container{max-width:1000px;margin:30px auto;padding:0 16px}
    h1{font-size:26px;font-weight:800;color:var(--primary);margin-bottom:20px}
    
    .tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
    .tab{padding:8px 16px;border-radius:20px;background:#e0e0e0;color:#555;font-weight:600;font-size:14px;cursor:pointer;border:none;transition:all .2s}
    .tab.active{background:var(--primary);color:#fff;box-shadow:0 4px 8px rgba(98,90,69,.2)}

    .order{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:24px;margin-bottom:24px;border:1px solid transparent;transition:all .3s}
    .order:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .order.cancelled{opacity:.6;filter:grayscale(1)}

    .order-head{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:20px}
    .or-left{flex:1}
    .order-title{font-size:18px;font-weight:800;margin-bottom:4px}
    .muted{font-size:13px;color:var(--muted)}
    
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:6px;background:#f0f0f0;font-size:12px;font-weight:600;color:#444}
    .chip.mostrador{background:#e3f2fd;color:#0d47a1}

    .or-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .right-total{font-size:22px;font-weight:900;color:var(--primary)}

    .items{border-top:1px solid var(--ring);padding-top:16px}
    .cat-group{margin-bottom:16px}
    .cat-title{font-size:12px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .it-row{display:flex;gap:12px;margin-bottom:8px;font-size:15px}
    .it-qty{font-weight:800;color:var(--primary);min-width:24px}
    .it-det{flex:1}
    .it-name{font-weight:700;text-transform:capitalize}
    .it-sub{font-size:13px;color:#666;margin-top:2px}
    .it-note{font-size:13px;color:#d32f2f;font-style:italic;margin-top:2px;font-weight:600}

    /* ESTILOS DE BOTONES DE ESTADO CORREGIDOS */
    .stateBtns{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}
    .state-btn{flex:1;min-width:100px;padding:8px;border:1px solid var(--ring);background:#fff;color:var(--text);border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;transition:all .2s}
    .state-btn:hover{background:#f5f5f5}
    
    /* üî• AQU√ç ESTABA EL ERROR: Ahora coinciden con el JS (state-accepted, etc) */
    .state-btn.on.state-accepted{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .state-btn.on.state-in_prep{background:var(--st-in_prep);border-color:var(--st-in_prep);color:#fff}
    .state-btn.on.state-ready{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .state-btn.on.state-delivered{background:var(--st-delivered);border-color:var(--st-delivered);color:#fff}
    
    .state-btn.cancelled:hover{background:#ffebee;color:#c62828;border-color:#ef9a9a}

    .pay-line{display:flex;gap:8px;align-items:center;background:#f4f4f9;padding:4px;border-radius:10px}
    .pay-select{padding:8px;border-radius:8px;border:1px solid var(--ring);background:#fff;font-weight:600;color:var(--text);cursor:pointer; outline:none; min-width: 140px;}
    .pay-toggle{padding:8px 16px;border-radius:8px;border:none;font-weight:700;font-size:13px;cursor:pointer;color:#fff;min-width:110px}
    .pay-toggle.is-paid{background:var(--pay-paid)}
    .pay-toggle.is-pending{background:var(--pay-pending)}
    .print-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:1px solid var(--ring);background:#fff;cursor:pointer;font-size:18px}
    .print-btn:hover{background:#f0f0f0}

    .empty-state{text-align:center;padding:40px;color:var(--muted);font-size:16px}

    @media print{
      header,.tabs,.stateBtns,.pay-line,.print-btn,.btn-danger,#btnBell,#btnAutoPrint{display:none!important}
      body{background:#fff} .container{margin:0;padding:0;max-width:none}
      .order{box-shadow:none;border:1px solid #000;margin-bottom:20px;break-inside:avoid}
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try{ firebase.initializeApp(firebaseConfig); }catch(e){ console.error("Error Firebase:", e); }
    const db = firebase.firestore();
    window.idToDoc = new Map();

    // 2. Auth
    const TTL_MS = 20 * 60 * 60 * 1000;
    function checkSession(){
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      if(!ok || (Date.now()-ts > TTL_MS)) location.replace('login.html');
      else localStorage.setItem('rb_admin_t', String(Date.now()));
    }
    checkSession(); setInterval(checkSession, 5*60*1000);

    // =================================================================
    // üî• SISTEMA DE STOCK INTELIGENTE üî•
    // =================================================================
    
    let RECETAS_DB = {}; 
    let INVENTARIO_DB = {}; 

    db.collection('recipes').onSnapshot(snap => {
        RECETAS_DB = {};
        snap.forEach(doc => { RECETAS_DB[doc.id] = doc.data().ingredients; });
    });

    db.collection('inventory').onSnapshot(snap => {
        INVENTARIO_DB = {};
        snap.forEach(doc => { 
            INVENTARIO_DB[doc.data().name.trim().toLowerCase()] = doc.id; 
        });
    });

    function findSmartId(keywords) {
        const stockNames = Object.keys(INVENTARIO_DB);
        for (const key of keywords) {
            if (INVENTARIO_DB[key.toLowerCase()]) return INVENTARIO_DB[key.toLowerCase()];
        }
        for (const stockName of stockNames) {
            for (const key of keywords) {
                if (stockName.includes(key.toLowerCase())) return INVENTARIO_DB[stockName];
            }
        }
        return null;
    }

    async function gestionarStock(pedido, factor) {
        if (!pedido.items) return;
        if(factor === -1 && pedido.stockDescontado) return;
        if(factor === 1 && !pedido.stockDescontado) return;

        console.log(`üìä STOCK update (${factor}) pedido #${pedido.orderNumber}`);
        const batch = db.batch();
        let huboCambios = false;

        pedido.items.forEach(item => {
            const prodName = item.name.trim(); 
            const prodNameLower = prodName.toLowerCase();
            const qtyPedida = Number(item.qty || 1);

            let ingredientes = RECETAS_DB[prodName];
            if (!ingredientes) {
                const key = Object.keys(RECETAS_DB).find(k => prodName.includes(k));
                if(key) ingredientes = RECETAS_DB[key];
            }

            if (ingredientes) {
                ingredientes.forEach(ing => {
                    let ingID = INVENTARIO_DB[ing.ingrediente.trim().toLowerCase()];
                    if(!ingID) ingID = findSmartId([ing.ingrediente]);

                    if (ingID) {
                        const ref = db.collection('inventory').doc(ingID);
                        const delta = Number(ing.cantidad) * qtyPedida * factor;
                        batch.update(ref, { qty: firebase.firestore.FieldValue.increment(delta) });
                        huboCambios = true;
                    }
                });
            }

            if(item.extras){
                for (const [key, valRaw] of Object.entries(item.extras)) {
                    const val = Number(valRaw);
                    if (val > 0) {
                        let searchTerms = [];
                        let amountPerUnit = 1;

                        if (key === 'patty') {
                            if (prodNameLower.includes('pollo') || prodNameLower.includes('crispy')) {
                                searchTerms = ['medall√≥n de pollo', 'pollo', 'crispy'];
                            } else {
                                searchTerms = ['carne', 'medallon', 'patty'];
                            }
                        } 
                        else if (key === 'cheddar') { searchTerms = ['cheddar', 'queso']; }
                        else if (key === 'bacon') { searchTerms = ['bacon', 'panceta']; amountPerUnit = 0.03; } 
                        else if (key === 'brioche') { searchTerms = ['brioche', 'pan brioche']; }
                        else { searchTerms = [key]; }

                        const ingID = findSmartId(searchTerms);
                        if (ingID) {
                            const ref = db.collection('inventory').doc(ingID);
                            const delta = amountPerUnit * val * factor;
                            batch.update(ref, { qty: firebase.firestore.FieldValue.increment(delta) });
                            huboCambios = true;
                        }
                    }
                }
            }

            const esBurger = prodNameLower.includes('hamburguesa') || prodNameLower.includes('burger') || prodNameLower.includes('doble') || prodNameLower.includes('simple') || prodNameLower.includes('royal') || prodNameLower.includes('crispy') || prodNameLower.includes('cuarto') || prodNameLower.includes('big');
            
            if (esBurger) {
                const papasID = findSmartId(['papas', 'bastones', 'papas fritas', 'congeladas', 'bolsa de papas']);
                if (papasID) {
                    const ref = db.collection('inventory').doc(papasID);
                    const deltaPapas = 0.2 * qtyPedida * factor;
                    batch.update(ref, { qty: firebase.firestore.FieldValue.increment(deltaPapas) });
                    huboCambios = true;
                }
            }
        });

        if (huboCambios) {
            const pedidoRef = db.collection('orders').doc(pedido.id);
            batch.update(pedidoRef, { stockDescontado: (factor === -1) });
            await batch.commit();
            console.log("‚úÖ Stock actualizado.");
        }
    }

    window.logout = () => { localStorage.removeItem('rb_admin_ok'); location.replace('login.html'); };

    window.setOrderStatus = async (id, next, isPaid) => {
        if(next==='delivered' && !isPaid){ alert("‚ö†Ô∏è COBRAR PRIMERO: El pedido figura pendiente."); return; }
        try{ 
            const docSnap = await db.collection('orders').doc(id).get();
            if(!docSnap.exists) return;
            const pedidoData = { id: docSnap.id, ...docSnap.data() };

            if(next === 'delivered'){ await gestionarStock(pedidoData, -1); } 
            else if(next === 'cancelled'){ await gestionarStock(pedidoData, 1); }

            await db.collection("orders").doc(id).update({status:next}); 
        }catch(e){console.error(e);}
    };

    window.setPaymentStatus = async (id, currentPaid, currentMethod) => {
        if(!currentPaid && (!currentMethod || currentMethod === "")){ 
            alert("‚ö†Ô∏è Seleccion√° un M√âTODO DE PAGO primero."); return; 
        }
        try{ await db.collection("orders").doc(id).update({ paid: !currentPaid, payment_status: !currentPaid ? 'paid' : 'pending_payment' }); }catch(e){}
    };
    
    window.updatePago = async (id, val) => { try{ await db.collection("orders").doc(id).update({pago:val}); }catch(e){} };

    window.printOrder = (id) => { const doc = window.idToDoc.get(id); if(doc) window.trySilentPrint(doc); };
    
    window.pickDate = (o) => { if(o.createdAt?.toDate) return o.createdAt.toDate(); if(typeof o.createdAt==='string') return new Date(o.createdAt); return new Date(); };
    window.cleanFries = (raw) => { if(!raw) return ""; const s = String(raw).toLowerCase().replace(/[_-]/g,' ').trim(); if(s.includes('sazon')) return "Sazonadas"; if(s.includes('sin sal')) return "Sin sal"; if(s.includes('con sal')||s.includes('sal')) return "Con sal"; return s.charAt(0).toUpperCase() + s.slice(1); };

    window.getCat = (item) => { const n = (item.name||"").toLowerCase(); const t = (item.type||"").toLowerCase(); if(t==='burger' || n.includes('hamburguesa') || n.includes('doble') || n.includes('simple') || n.includes('crispy')) return 'b'; if(t==='side' || n.includes('papas') || n.includes('fritas') || n.includes('sazon') || n.includes('sin sal') || n.includes('con sal')) return 'f'; if(t==='drink' || n.includes('coca') || n.includes('agua') || n.includes('cerveza')) return 'd'; return 'o'; };
  </script>
</head>

<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="">Pedidos</a>
      <div class="spacer"></div>
      <a href="pedido_local.html" class="nav-btn active">üì¶ Pedidos</a>
      <a href="finanzas.html" class="nav-btn">üìà Finanzas</a>
      <div class="dropdown" style="position:relative;display:inline-block">
            <button onclick="document.getElementById('ddStock').classList.toggle('show')" class="nav-btn">üìã Stock ‚ñæ</button>
            <div id="ddStock" style="display:none;position:absolute;background:#fff;border:1px solid #ccc;border-radius:8px;top:100%;left:0;min-width:150px;box-shadow:0 5px 15px rgba(0,0,0,0.1)">
                <a href="stock.html" style="display:block;padding:10px;text-decoration:none;color:#333;border-bottom:1px solid #eee">üì¶ Stock</a>
                <a href="ingresos.html" style="display:block;padding:10px;text-decoration:none;color:#333">üì• Ingresos</a>
            </div>
      </div>
      <style>.show{display:block!important}</style>
      <a href="mostrador.html" class="nav-btn">üßæ Mostrador</a>
      <a href="admin.html" class="nav-btn">‚öôÔ∏è Admin</a>
      
      <button id="btnBell" class="icon-btn" title="Sonido">üîî</button>
      <button id="btnAutoPrint" class="icon-btn" title="Autoimprimir">üñ®Ô∏è</button>
      <button onclick="window.logout()" class="nav-btn btn-danger">Salir</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>
    <div class="tabs" id="tabs">
      <button class="tab active" data-f="recibidos">Recibidos (Cocina)</button>
      <button class="tab" data-f="entregados">Entregados</button>
      <button class="tab" data-f="cancelled">Cancelados</button>
      <button class="tab" data-f="all">Todos</button>
    </div>
    <div id="orders"><div class="empty-state">Cargando...</div></div>
    <div id="ordersError" class="err" style="display:none">Error de conexi√≥n.</div>
  </main>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    let currentFilter = "recibidos"; let lastSnap = null;
    
    document.getElementById("tabs").addEventListener("click", (e)=>{
        const btn = e.target.closest(".tab"); if(!btn) return;
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.f;
        if(window.lastSnap) renderList(window.lastSnap);
    });

    // Header Buttons
    const btnBell = document.getElementById("btnBell");
    let soundOn = JSON.parse(localStorage.getItem("rb_sound")||"true");
    const updBell = ()=>{ btnBell.classList.toggle("active", soundOn); }; updBell();
    btnBell.onclick = ()=>{ soundOn=!soundOn; localStorage.setItem("rb_sound", soundOn); updBell(); };

    const btnAP = document.getElementById("btnAutoPrint");
    let autoP = JSON.parse(localStorage.getItem("rb_autop")||"false");
    const updAP = ()=>{ btnAP.classList.toggle("active", autoP); }; updAP();
    btnAP.onclick = ()=>{ autoP=!autoP; localStorage.setItem("rb_autop", autoP); updAP(); };

    const playBeep = ()=>{
        if(!soundOn) return;
        try{ const c=new(window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(); const g=c.createGain();
        o.type="square"; o.frequency.value=750; o.connect(g); g.connect(c.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.00001, c.currentTime+0.2); o.stop(c.currentTime+0.2); }catch(e){}
    };

    // SUSCRIPCI√ìN
    let isInit=true; setTimeout(()=>isInit=false, 3000);
    // Orden por n√∫mero para asegurar visibilidad
    db.collection("orders").orderBy("orderNumber", "desc").limit(300).onSnapshot(snap => {
        window.lastSnap = snap;
        renderList(snap);
        snap.docChanges().forEach(ch => {
            if(ch.type==='added' && !isInit){
                playBeep(); setTimeout(playBeep, 250);
                if(autoP) window.trySilentPrint(window.idToDoc.get(ch.doc.id));
            }
        });
    }, err => {
        document.getElementById("orders").innerHTML = `<div class="empty-state" style="color:red">Error: ${err.message}</div>`;
    });

    function renderList(snap){
        let docs = snap.docs.map(d => ({ data: d.data(), id: d.id, ref: d }));
        window.idToDoc = new Map(snap.docs.map(d=>[d.id,d]));
        
        // Ordenar visual (nuevo arriba)
        docs.sort((a,b) => window.pickDate(b.data) - window.pickDate(a.data));

        const filtered = docs.filter(o => {
            const s = o.data.status || 'accepted';
            if(currentFilter === 'recibidos') return ['accepted','in_prep','ready','pending_payment'].includes(s);
            if(currentFilter === 'entregados') return s === 'delivered';
            if(currentFilter === 'cancelled') return s === 'cancelled';
            return true;
        });

        const cont = document.getElementById("orders");
        if(filtered.length===0){ cont.innerHTML = '<div class="empty-state">No hay pedidos en esta secci√≥n.</div>'; return; }
        cont.innerHTML = filtered.map(x => buildOrderHTML(x.ref)).join("");
    }

    function buildOrderHTML(doc){
        const o = doc.data();
        const dt = window.pickDate(o);
        const timeStr = dt.toLocaleTimeString("es-AR", {hour:'2-digit', minute:'2-digit'});
        
        const st = o.status || 'accepted';
        const isPaid = (o.payment_status==='paid') || !!o.paid;
        
        const STATES = ['accepted','in_prep','ready','delivered'];
        const LABELS = {accepted:'Recibido', in_prep:'En preparaci√≥n', ready:'Listo', delivered:'Entregado'};
        
        let btnsHTML = STATES.map(k => {
            const isOn = (k === st) ? 'on' : '';
            const disabled = (k==='delivered' && !isPaid) ? 'opacity:0.5' : '';
            return `<button class="state-btn ${isOn} state-${k}" style="${disabled}" onclick="setOrderStatus('${doc.id}', '${k}', ${isPaid})">${LABELS[k]}</button>`;
        }).join('') + `<button class="state-btn cancelled" onclick="setOrderStatus('${doc.id}', 'cancelled', ${isPaid})">Cancelar</button>`;

        // üî• PAGO
        let payVal = o.pago;
        if(payVal === 'mostrador_sin_especificar') payVal = "";

        const items = Array.isArray(o.items) ? o.items : [];
        const cats = { b:[], f:[], d:[], o:[] };
        items.forEach(it => {
            const cat = window.getCat(it);
            if(cat === 'b'){
                cats.b.push(it);
                let fName = it.fries;
                if(!fName && it.extras?.fries) fName = it.extras.fries;
                if(!fName && it.guarnicion) fName = it.guarnicion;
                if(fName && fName !== 'sin_papas') cats.f.push({name: fName, qty: it.qty||1});
            } else {
                cats[cat].push(it);
            }
        });

        const renderSec = (list, icon, title) => {
            if(!list.length) return "";
            const rows = list.map(it => {
                let ex = [];
                if(it.extras?.patty) ex.push(`+${it.extras.patty} carne`);
                if(it.extras?.cheddar) ex.push(`+${it.extras.cheddar} cheddar`);
                
                let dName = it.name;
                if(title.includes("PAPAS")) dName = window.cleanFries(it.name);

                return `<div class="it-row">
                   <div class="it-qty">${it.qty||1}</div>
                   <div class="it-det">
                      <div class="it-name">${dName}</div>
                      ${ex.length ? `<div class="it-sub">${ex.join(' ¬∑ ')}</div>` : ''}
                      ${it.notes ? `<div class="it-note">üìù ${it.notes}</div>` : ''}
                   </div>
                </div>`;
            }).join("");
            return `<div class="cat-group"><div class="cat-title">${icon} ${title}</div>${rows}</div>`;
        };

        const itemsHTML = 
             renderSec(cats.b,'üçî','HAMBURGUESAS') + 
             renderSec(cats.f,'üçü','GUARNICIONES / PAPAS') + 
             renderSec(cats.d,'ü•§','BEBIDAS') + 
             renderSec(cats.o,'üî∏','OTROS');
        
        const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);

        return `
        <div class="order ${st==='cancelled'?'cancelled':''}">
           <div class="order-head">
              <div class="or-left">
                 <div class="order-title">#${o.orderNumber||'--'} ‚Äî ${o.source==='mostrador'?o.nombre+' (Mostrador)':o.nombre}</div>
                 <div class="or-meta">
                    <span>üïë ${timeStr}</span>
                    <span class="chip ${o.source==='mostrador'?'mostrador':''}">Retiro: ${o.entrega||'take_away'}</span>
                    ${o.pickup_time_pretty ? `<span class="chip">‚è∞ ${o.pickup_time_pretty}</span>` : ''}
                 </div>
                 <div class="stateBtns">${btnsHTML}</div>
              </div>
              <div class="or-right">
                 <div class="right-total">${money(total)}</div>
                 <div class="pay-line">
                    <select class="pay-select" onchange="updatePago('${doc.id}', this.value)">
                       <option value="" ${!payVal?'selected':''}> (Seleccionar...) </option> <option value="efectivo" ${payVal==='efectivo'?'selected':''}>Efectivo</option>
                       <option value="mercado_pago" ${payVal==='mercado_pago'?'selected':''}>QR (MP)</option>
                       <option value="debito" ${payVal==='debito'?'selected':''}>D√©bito</option>
                       <option value="transferencia" ${payVal==='transferencia'?'selected':''}>Transferencia</option>
                    </select>
                    <button class="pay-toggle ${isPaid?'is-paid':'is-pending'}" onclick="setPaymentStatus('${doc.id}', ${isPaid}, '${payVal}')">
                       ${isPaid ? 'PAGADO ‚úì' : 'PENDIENTE $'}
                    </button>
                    <button class="print-btn" onclick="printOrder('${doc.id}')">üñ®Ô∏è</button>
                 </div>
              </div>
           </div>
           <div class="items">${itemsHTML || '<div class="it-sub">Sin √≠tems</div>'}</div>
        </div>`;
    }

    // --- TICKET (58mm) ---
    window.trySilentPrint = function(docSnap){
       const o = docSnap.data();
       const esc = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
       const m = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
       const dt = window.pickDate(o);
       const dateStr = dt.toLocaleDateString("es-AR");
       const timeStr = dt.toLocaleTimeString("es-AR",{hour12:false});

       let payTxt = o.pago;
       if(!payTxt || payTxt==='mostrador_sin_especificar' || payTxt==="") payTxt="A COBRAR EN CAJA";
       else if(payTxt==='mercado_pago') payTxt="QR (MP)";
       else payTxt = payTxt.toUpperCase();

       const isPaid = (o.payment_status === 'paid') || o.paid;
       const stPay = isPaid ? "PAGADO" : "PENDIENTE";
       
       const items = Array.isArray(o.items) ? o.items : [];
       const cats = { b:[], f:[], d:[], o:[] };
       items.forEach(it => {
          const cat = window.getCat(it);
          if(cat==='b'){
             cats.b.push(it);
             let fName = it.fries;
             if(!fName && it.extras?.fries) fName = it.extras.fries;
             if(!fName && it.guarnicion) fName = it.guarnicion;
             if(fName && fName!=='sin_papas') cats.f.push({name: fName, qty: it.qty||1});
          } else {
             cats[cat].push(it);
          }
       });
       
       const rSec = (l, ti) => {
         if(!l.length) return "";
         const r = l.map(i => {
            let dName = esc(i.name);
            if(ti.includes("PAPA")) dName = window.cleanFries(i.name);
            let h = `<div class="row name"><div class="l">${i.qty||1} √ó ${dName}</div></div>`;
            if(!ti.includes("PAPA")){
               if(i.extras?.patty) h+=`<div class="sub">‚Ä¢ +${i.extras.patty} carne</div>`;
               if(i.extras?.cheddar) h+=`<div class="sub">‚Ä¢ +${i.extras.cheddar} cheddar</div>`;
            }
            if(i.notes) h+=`<div class="sub">üìù ${esc(i.notes)}</div>`;
            h+=`<div class="sep"></div>`;
            return h;
         }).join("");
         return `<div class="blk"><div class="lbl" style="border-bottom:1px solid #000;display:inline-block;margin-top:6px">${ti}</div></div>${r}`;
       };

       const body = rSec(cats.b,'HAMBURGUESAS') + rSec(cats.f,'PAPAS') + rSec(cats.d,'BEBIDAS') + rSec(cats.o,'OTROS');
       const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);
       const name = o.source==='mostrador' ? (o.nombre+' (Mostrador)') : o.nombre;

       const html = `<!doctype html><html><head><style>
       @page{size:58mm auto;margin:0} body{width:58mm;margin:0 auto;padding:5px;font-family:monospace;font-size:12px;font-weight:700;color:#000;line-height:1.2}
       .c{text-align:center} .hr{border-top:1px dashed #000;margin:6px 0} .row{display:flex;justify-content:space-between}
       .lbl{font-size:10px;text-transform:uppercase} .sub{font-size:11px;margin-left:5px;font-weight:400} .sep{border-top:1px dotted #999;margin:3px 0}
       </style></head><body>
         <div class="c" style="font-size:16px;margin-bottom:4px">Rhodes Burgers</div>
         <div class="c" style="font-size:14px">#${o.orderNumber||'--'}</div>
         <div class="c" style="font-size:18px;margin:5px 0">[ ${stPay} ]</div>
         <div class="hr"></div>
         <div><span class="lbl">CLIENTE:</span> ${esc(name)}</div>
         <div class="c" style="font-size:16px;margin:6px 0;font-weight:900">Retira: ${esc(o.pickup_time_pretty||'A la brevedad')}</div>
         <div><span class="lbl">PAGO:</span> ${payTxt}</div>
         ${o.notes ? `<div class="hr"></div><div><span class="lbl">NOTA:</span> ${esc(o.notes)}</div>` : ''}
         <div class="hr"></div>
         ${body}
         <div class="hr"></div>
         <div class="row"><div class="l">TOTAL</div><div>${m(total)}</div></div>
         <div class="c" style="margin-top:10px;font-size:10px">${dateStr} ${timeStr}</div>
         <script>window.onload=()=>{setTimeout(()=>{window.print()},200)}<\/script>
       </body></html>`;
       
       const f = document.createElement('iframe'); f.style.cssText='position:fixed;left:0;top:0;width:0;height:0;border:0';
       document.body.append(f); const d=f.contentWindow.document; d.open();d.write(html);d.close();
       setTimeout(()=>f.remove(), 10000);
    };
  });
  </script>
</body>
</html>

