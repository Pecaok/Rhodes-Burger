<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#444; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
      --font: Inter, system-ui, "Segoe UI", Roboto, Arial, "Helvetica Neue", "Noto Sans", sans-serif;
      --st-accepted:#FBC02D; --st-in_prep:#FB8C00; --st-ready:#00ACC1; --st-delivered:#2E7D32; --st-cancelled:#D32F2F;
      --pay-pending:#FFA000; --pay-paid:#625A45;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;background:#fff;font-weight:700}
    .muted{color:var(--muted)}
    input[type="date"]{padding:6px 10px;border:1px solid var(--ring);border-radius:10px;background:#fff}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .chipf{background:#f3f3f3;border:1px solid var(--ring);color:#111;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chipf.active{background:var(--primary);color:#fff;border-color:var(--primary)}

    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#f3f3f3;border:1px solid var(--ring);color:#111;border-radius:999px;padding:6px 10px;font-size:13px}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap}
    .items{margin-top:10px}
    .item{margin:8px 0 6px 0}
    .item .sub{color:#111;font-size:13px;margin-top:3px}
    .divider{height:1px;background:#efefef;margin:10px 0}
    .err{color:#b00020;font-weight:600}
    @media print{
      @page{size:A4 portrait;margin:12mm}
      header,.tabs,.toolbar{display:none!important}
      .order{break-inside:avoid;box-shadow:none;border:1px solid #eee}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Pedidos</a>
      <div class="spacer"></div>
      <a href="finanzas.html" class="btn" title="Ver finanzas">üìà Finanzas</a>
      <button id="btnBell" class="btn" title="Sonido">üîî Sonido</button>
      <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>

    <div class="toolbar">
      <span class="badge">Jornada&nbsp;<input id="dayPicker" type="date"></span>
      <button id="btnPrev" class="btn">‚óÄ</button>
      <button id="btnNext" class="btn">‚ñ∂</button>
      <button id="btnToday" class="btn">Hoy</button>
      <span id="rangeLabel" class="badge muted">‚Äî</span>
    </div>

    <div class="tabs" id="tabs">
      <span class="chipf active" data-f="all">Todos</span>
      <span class="chipf" data-f="new">Nuevos</span>
      <span class="chipf" data-f="inprep_group">En preparaci√≥n</span>
      <span class="chipf" data-f="cancelled">Cancelados</span>
      <span class="chipf" data-f="cancelled_hist">Cancelados (hist√≥rico)</span>
    </div>

    <div id="orders"></div>
    <div id="ordersError" class="err" style="display:none;margin-top:8px"></div>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
  const firebaseConfig={apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers"};
  try{firebase.initializeApp(firebaseConfig);}catch(e){}
  const db=firebase.firestore();

  const $=s=>document.querySelector(s);
  const J_START_H=19;
  function startOfJornada(d){const base=new Date(d);const same=new Date(base.getFullYear(),base.getMonth(),base.getDate(),J_START_H,0,0,0);if(base<same)same.setDate(same.getDate()-1);return same;}
  function rangeForDay(d){const s=startOfJornada(d);const e=new Date(s);e.setDate(e.getDate()+1);return{start:s,end:e};}
  function month19RangeFromAny(d){const y=d.getFullYear(),m=d.getMonth();return{start:new Date(y,m,1,J_START_H,0,0,0),end:new Date(y,m+1,1,J_START_H,0,0,0)};}

  function chooseDateField(obj){for(const k of ['createdAt','created_at','fecha','date','time','timestamp','createdAtMs'])if(obj&&obj[k]!=null)return k;return null;}
  function pickDocDate(o){
    for(const k of ['createdAt','created_at','fecha','date','time']){
      const v=o[k]; if(v?.toDate)return v.toDate(); if(typeof v==='string'){const d=new Date(v);if(!isNaN(d))return d;}
    }
    if(typeof o.createdAtMs==='number')return new Date(o.createdAtMs);
    if(typeof o.timestamp==='number')return new Date(o.timestamp);
    return null;
  }

  function renderOrder(doc){
    const o=doc.data(); const dt=pickDocDate(o);
    return `<div class="order"><div class="order-head"><div>
      <div class="order-title">#${o.orderNumber||doc.id.slice(-5)} ‚Äî ${o.nombre||'Cliente'}</div>
      <div class="muted">${dt?dt.toLocaleString('es-AR'):'‚Äî'}</div></div>
      <div class="right-total">${(o.total||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0})}</div></div></div>`;
  }

  let currentFilter="all",unsub=null;
  async function refreshQuery(){
    if(unsub)unsub();
    const picked=new Date($("#dayPicker").value+'T12:00:00');
    let range=currentFilter==="cancelled_hist"?month19RangeFromAny(picked):rangeForDay(picked);
    const probe=await db.collection("orders").limit(1).get();
    let dateField=null;if(!probe.empty)dateField=chooseDateField(probe.docs[0].data());
    let q=db.collection("orders");
    if(dateField){
      const isTs=['createdAt','created_at','fecha','date','time'].includes(dateField);
      const s=isTs?range.start:range.start.getTime();
      const e=isTs?range.end:range.end.getTime();
      q=q.where(dateField,">=",s).where(dateField,"<",e).orderBy(dateField,"desc");
    }else{q=q.orderBy(firebase.firestore.FieldPath.documentId());}
    unsub=q.limit(200).onSnapshot(snap=>{
      $("#orders").innerHTML=snap.docs.map(renderOrder).join("")||"<p class='muted'>No hay pedidos.</p>";
    },err=>{$("#ordersError").textContent="No se pudo cargar la lista";$("#ordersError").style.display="block";});
  }

  document.querySelectorAll("#tabs .chipf").forEach(b=>b.onclick=()=>{currentFilter=b.dataset.f;document.querySelectorAll("#tabs .chipf").forEach(x=>x.classList.remove("active"));b.classList.add("active");refreshQuery();});
  (function initDay(){const d=new Date();$("#dayPicker").value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;$("#btnToday").onclick=()=>{const d=new Date();$("#dayPicker").value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;refreshQuery();};$("#btnPrev").onclick=()=>{const d=new Date($("#dayPicker").value);d.setDate(d.getDate()-1);$("#dayPicker").value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;refreshQuery();};$("#btnNext").onclick=()=>{const d=new Date($("#dayPicker").value);d.setDate(d.getDate()+1);$("#dayPicker").value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;refreshQuery();};$("#dayPicker").addEventListener("change",refreshQuery);})();
  refreshQuery();
  </script>
</body>
</html>
