<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#625A45" />

  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f4f4f9; --card:#fff;
      --ring:#e0e0e0; --shadow:0 4px 12px rgba(0,0,0,.08);
      --font: Inter, system-ui, -apple-system, sans-serif;
      --st-accepted:#ffca28; --st-in_prep:#fb8c00; --st-ready:#00acc1; --st-delivered:#43a047; --st-cancelled:#e53935;
      --pay-paid:#625A45; --pay-pending:#f57c00;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font);-webkit-font-smoothing:antialiased}
    
    /* Header */
    header{position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.05);padding:0 12px}
    .topbar{max-width:1200px;margin:0 auto;height:60px;display:flex;align-items:center;gap:16px}
    .brand{display:flex;align-items:center;text-decoration:none;color:var(--primary);font-weight:800;font-size:18px}
    .brand img{width:32px;height:32px;border-radius:8px;margin-right:10px}
    .spacer{flex:1}
    
    /* Botones Header */
    .nav-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:8px;text-decoration:none;color:var(--text);font-weight:600;font-size:14px;transition:all .2s}
    .nav-btn:hover{background:#f0f0f0}
    .nav-btn.active{background:var(--primary);color:#fff}
    .icon-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;border:none;background:#f0f0f0;cursor:pointer;font-size:16px;transition:all .2s}
    .icon-btn:hover{background:#e0e0e0}
    .icon-btn.active{background:var(--primary);color:#fff}
    .btn-danger{color:#d32f2f;background:#ffebee} .btn-danger:hover{background:#ffcdd2}

    /* Contenedor Principal */
    .container{max-width:1000px;margin:30px auto;padding:0 16px}
    h1{font-size:26px;font-weight:800;color:var(--primary);margin-bottom:20px}

    /* Filtros */
    .tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap}
    .tab{padding:8px 16px;border-radius:20px;background:#e0e0e0;color:#555;font-weight:600;font-size:14px;cursor:pointer;transition:all .2s;border:none}
    .tab.active{background:var(--primary);color:#fff;box-shadow:0 4px 8px rgba(98,90,69,.2)}

    /* Tarjeta de Pedido */
    .order-card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:24px;margin-bottom:24px;border:1px solid transparent;transition:all .3s}
    .order-card:hover{box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .order-card.cancelled{opacity:.6;filter:grayscale(1)}

    /* Encabezado del Pedido */
    .or-header{display:flex;justify-content:space-between;align-items:flex-start;gap:20px;margin-bottom:20px}
    .or-left{flex:1}
    .or-title{font-size:18px;font-weight:800;margin-bottom:4px}
    .or-meta{font-size:13px;color:var(--muted);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;padding:4px 8px;border-radius:6px;background:#f0f0f0;font-size:12px;font-weight:600;color:#555}
    .chip.mostrador{background:#e3f2fd;color:#1565c0}
    .or-right{text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .or-total{font-size:22px;font-weight:900;color:var(--primary)}

    /* Botones de Estado */
    .state-btns{display:flex;gap:6px;flex-wrap:wrap;margin-top:12px}
    .st-btn{flex:1;min-width:110px;padding:8px;border:2px solid var(--ring);background:#fff;color:var(--text);border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;transition:all .2s}
    .st-btn:hover{background:#f9f9f9}
    .st-btn.on.accepted{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .st-btn.on.in_prep{background:var(--st-in_prep);border-color:var(--st-in_prep);color:#fff}
    .st-btn.on.ready{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .st-btn.on.delivered{background:var(--st-delivered);border-color:var(--st-delivered);color:#fff}
    .st-btn.cancelled:hover{background:#ffebee;color:#c62828;border-color:#ef9a9a}

    /* L√≠nea de Pago */
    .pay-line{display:flex;gap:8px;align-items:center;background:#f4f4f9;padding:4px;border-radius:10px}
    .pay-select{padding:8px 12px;border-radius:8px;border:1px solid var(--ring);background:#fff;font-weight:600;color:var(--text);flex:1;cursor:pointer}
    .pay-status-btn{padding:8px 16px;border-radius:8px;border:none;font-weight:700;font-size:13px;cursor:pointer;transition:all .2s;color:#fff;min-width:120px}
    .pay-status-btn.is-paid{background:var(--pay-paid)}
    .pay-status-btn.is-pending{background:var(--pay-pending)}
    .print-btn{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:1px solid var(--ring);background:#fff;cursor:pointer;font-size:16px}
    .print-btn:hover{background:#f0f0f0}

    /* Lista de √çtems */
    .items-list{border-top:1px solid var(--ring);padding-top:16px}
    .cat-group{margin-bottom:16px}
    .cat-title{font-size:12px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .it-row{display:flex;gap:12px;margin-bottom:10px;font-size:15px}
    .it-qty{font-weight:800;color:var(--primary);min-width:24px}
    .it-det{flex:1}
    .it-name{font-weight:700}
    .it-sub{font-size:13px;color:#666;margin-top:2px}
    .it-note{font-size:13px;color:#d32f2f;font-style:italic;margin-top:2px;font-weight:600}
    
    .empty-state{text-align:center;padding:40px;color:var(--muted);font-size:16px;background:#fff;border-radius:16px;box-shadow:var(--shadow)}

    @media print{
      header, .tabs, .state-btns, .pay-line, .print-btn, #btnBell, #btnAutoPrint, .nav-btn, .btn-danger { display:none!important }
      body{background:#fff} .container{max-width:none;margin:0;padding:0}
      .order-card{box-shadow:none;border:1px solid #eee;break-inside:avoid;margin-bottom:20px}
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // 1. Inicializar Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}
    const db = firebase.firestore();
    window.idToDoc = new Map(); // Para impresi√≥n

    // 2. Sesi√≥n
    const TTL_MS = 20 * 60 * 60 * 1000;
    function checkSession(){
      const ok = localStorage.getItem('rb_admin_ok') === 'true';
      const ts = Number(localStorage.getItem('rb_admin_t') || 0);
      if(!ok || (Date.now() - ts > TTL_MS)) location.replace('login.html');
      else localStorage.setItem('rb_admin_t', String(Date.now()));
    }
    checkSession();
    setInterval(checkSession, 5*60*1000);

    /* --- FUNCIONES GLOBALES (ACCESIBLES DESDE HTML) --- */
    window.logout = () => {
       localStorage.removeItem('rb_admin_ok');
       location.replace('login.html');
    };

    window.setOrderStatus = async (id, next, isPaid) => {
      if (next === 'delivered' && !isPaid) {
          alert("‚ö†Ô∏è El pedido debe estar PAGADO para marcarse como entregado.");
          return;
      }
      try{ 
          await db.collection("orders").doc(id).update({ status: next }); 
      }catch(e){ console.error(e); }
    };

    window.setPaymentStatus = async (id, currentState, currentMethod) => {
      // Validaci√≥n: No permitir marcar pagado si no hay m√©todo
      if(!currentState && (!currentMethod || currentMethod === "")){
          alert("‚ö†Ô∏è Seleccion√° un M√âTODO DE PAGO antes de marcar como pagado.");
          return;
      }
      const newState = !currentState;
      try{ 
          await db.collection("orders").doc(id).update({ 
              paid: newState, 
              payment_status: newState ? "paid" : "pending_payment"
          }); 
      }catch(e){ console.error(e); }
    };

    window.updatePago = async (id, value) => {
      try{ await db.collection("orders").doc(id).update({ pago: value }); }
      catch(e){ console.error(e); }
    };

    window.printOrder = (id) => {
      const doc = window.idToDoc.get(id);
      if(doc) window.trySilentPrint(doc);
    };

    // Helper fecha universal
    window.pickDate = (o) => {
      const v = o.createdAt || o.created_at || o.timestamp || o.date;
      if(v?.toDate) return v.toDate();
      if(typeof v==='string') { const d=new Date(v); if(!isNaN(d)) return d; }
      if(typeof v==='number') return new Date(v);
      return new Date();
    };
  </script>
</head>

<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes">Pedidos</a>
      <div class="spacer"></div>
      <nav style="display:flex;gap:8px">
        <a href="pedido_local.html" class="nav-btn active">üì¶ Pedidos</a>
        <a href="finanzas.html" class="nav-btn">üìà Finanzas</a>
        <a href="mostrador.html" class="nav-btn">üßæ Mostrador</a>
        <a href="admin.html" class="nav-btn">‚öôÔ∏è Admin</a>
        <button id="btnBell" class="icon-btn" title="Sonido">üîî</button>
        <button id="btnAutoPrint" class="icon-btn" title="Autoimprimir">üñ®Ô∏è</button>
        <button onclick="window.logout()" class="nav-btn btn-danger">Salir</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>
    
    <div class="tabs" id="tabs">
      <button class="tab active" data-f="recibidos">Recibidos (Cocina)</button>
      <button class="tab" data-f="entregados">Entregados</button>
      <button class="tab" data-f="cancelled">Cancelados</button>
      <button class="tab" data-f="all">Todos</button>
    </div>

    <div id="ordersList">
        <div class="empty-state">Cargando pedidos...</div>
    </div>
  </main>

  <script>
  /* --- L√ìGICA DE UI Y RENDERIZADO --- */
  window.addEventListener('DOMContentLoaded', () => {
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    
    let currentFilter = "recibidos";
    let lastSnap = null;

    // Manejo de Tabs
    document.getElementById("tabs").addEventListener("click", (e)=>{
        const btn = e.target.closest(".tab");
        if(!btn) return;
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentFilter = btn.dataset.f;
        if(lastSnap) renderList(lastSnap);
    });

    // Configuraci√≥n Botones Header
    const btnBell = document.getElementById("btnBell");
    let soundOn = JSON.parse(localStorage.getItem("rb_sound")||"true");
    const updSound = ()=>{ btnBell.classList.toggle("active", soundOn); }; updSound();
    btnBell.onclick = ()=>{ soundOn=!soundOn; localStorage.setItem("rb_sound", soundOn); updSound(); };

    const btnAP = document.getElementById("btnAutoPrint");
    let autoPrint = JSON.parse(localStorage.getItem("rb_autoprint")||"false");
    const updAP = ()=>{ btnAP.classList.toggle("active", autoPrint); }; updAP();
    btnAP.onclick = ()=>{ autoPrint=!autoPrint; localStorage.setItem("rb_autoprint", autoPrint); updAP(); };

    const playBeep = ()=>{
        if(!soundOn) return;
        try{ const c=new(window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(); const g=c.createGain();
        o.type="square"; o.frequency.value=750; o.connect(g); g.connect(c.destination);
        o.start(); g.gain.exponentialRampToValueAtTime(0.00001, c.currentTime+0.2); o.stop(c.currentTime+0.2); }catch(e){}
    };

    // --- SUSCRIPCI√ìN A FIREBASE (SIN ORDENAR EN DB) ---
    let isInit=true; setTimeout(()=>isInit=false, 3000);
    db.collection("orders").limit(250).onSnapshot(snap => {
        lastSnap = snap;
        renderList(snap);
        
        snap.docChanges().forEach(ch => {
            if(ch.type==='added' && !isInit){
                playBeep(); setTimeout(playBeep, 250);
                if(autoPrint) window.trySilentPrint(window.idToDoc.get(ch.doc.id));
            }
        });
    }, err => {
        document.getElementById("ordersList").innerHTML = `<div class="empty-state" style="color:red">Error de conexi√≥n: ${err.message}</div>`;
    });


    /* --- FUNCI√ìN PRINCIPAL DE RENDERIZADO --- */
    function renderList(snap){
        let docs = snap.docs.map(d => ({ data: d.data(), id: d.id, ref: d }));
        window.idToDoc = new Map(snap.docs.map(d=>[d.id,d]));

        // 1. ORDENAR EN CLIENTE (Por fecha descendente)
        docs.sort((a,b) => window.pickDate(b.data) - window.pickDate(a.data));

        // 2. FILTRAR
        const filtered = docs.filter(o => {
            const s = o.data.status || 'accepted';
            if(currentFilter === 'recibidos') return ['accepted','in_prep','ready'].includes(s);
            if(currentFilter === 'entregados') return s === 'delivered';
            if(currentFilter === 'cancelled') return s === 'cancelled';
            return true;
        });

        // 3. GENERAR HTML
        const container = document.getElementById("ordersList");
        if(filtered.length === 0){
            container.innerHTML = '<div class="empty-state">No hay pedidos en esta secci√≥n.</div>';
            return;
        }
        container.innerHTML = filtered.map(x => renderCard(x.ref)).join("");
    }


    /* --- RENDERIZADO DE CARTA INDIVIDUAL --- */
    function renderCard(doc){
        const o = doc.data();
        const dt = window.pickDate(o);
        const timeStr = dt.toLocaleTimeString("es-AR", {hour:'2-digit', minute:'2-digit'});
        const st = o.status || 'accepted';
        const isPaid = (o.payment_status === 'paid') || o.paid === true;
        
        // Botones de Estado
        const states = ['accepted','in_prep','ready','delivered'];
        const labels = {accepted:'Recibido', in_prep:'En preparaci√≥n', ready:'Listo para retirar', delivered:'Entregado'};
        const curIdx = states.indexOf(st);
        const stateBtnsHTML = states.map((k, i) => {
            const isOn = (k === st) ? 'on' : '';
            // Deshabilitar si no est√° pagado y es delivered (visual)
            const disabled = (k==='delivered' && !isPaid) ? 'opacity:0.5' : '';
            return `<button class="st-btn ${isOn} ${k}" style="${disabled}" onclick="setOrderStatus('${doc.id}', '${k}', ${isPaid})">${labels[k]}</button>`;
        }).join('') + `<button class="st-btn cancelled" onclick="setOrderStatus('${doc.id}', 'cancelled', ${isPaid})">Cancelar</button>`;

        // L√≠nea de Pago
        let payVal = o.pago;
        if(payVal === 'mostrador_sin_especificar') payVal = ""; // Para que el select muestre "M√©todo..."

        // Procesar items
        const items = Array.isArray(o.items) ? o.items : [];
        const cats = { b:[], f:[], d:[], o:[] };
        items.forEach(it => {
            const t = (it.type||"").toLowerCase(); const n = (it.name||"").toLowerCase();
            if(t==='burger' || n.includes('hamburguesa')) cats.b.push(it);
            else if(t==='side' || n.includes('papas')) cats.f.push(it);
            else if(t==='drink' || n.includes('coca')) cats.d.push(it);
            else cats.o.push(it);
        });

        const renderCat = (list, icon, title) => {
            if(!list.length) return "";
            const rows = list.map(it => {
                let extras = [];
                if(it.extras?.patty) extras.push(`+${it.extras.patty} carne`);
                if(it.extras?.cheddar) extras.push(`+${it.extras.cheddar} cheddar`);
                
                let dName = it.name;
                // Normalizar nombre de papas si es guarnici√≥n
                if(title.includes("PAPAS") || it.fries || it.guarnicion){
                   const raw = it.fries || it.guarnicion || it.name;
                   const s = String(raw).toLowerCase().replace(/[_-]/g,' ');
                   if(s.includes('sazon')) dName="Sazonadas";
                   else if(s.includes('sin sal')) dName="Sin sal";
                   else if(s.includes('con sal') || s.includes('sal')) dName="Con sal";
                }

                return `<div class="it-row">
                    <div class="it-qty">${it.qty||1}</div>
                    <div class="it-det">
                        <div class="it-name">${dName}</div>
                        ${extras.length ? `<div class="it-sub">${extras.join(' ¬∑ ')}</div>`:''}
                        ${it.notes ? `<div class="it-note">üìù ${it.notes}</div>`:''}
                    </div>
                </div>`;
            }).join("");
            return `<div class="cat-group"><div class="cat-title">${icon} ${title}</div>${rows}</div>`;
        };

        const itemsHTML = renderCat(cats.b,'üçî','HAMBURGUESAS') + 
                          renderCat(cats.f,'üçü','GUARNICIONES / PAPAS') + 
                          renderCat(cats.d,'ü•§','BEBIDAS') + 
                          renderCat(cats.o,'üî∏','OTROS');

        // Calcular total si no existe
        const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);

        return `
        <div class="order-card ${st==='cancelled'?'cancelled':''}">
            <div class="or-header">
                <div class="or-left">
                    <div class="or-title">#${o.orderNumber||'--'} ‚Äî ${o.source==='mostrador' ? o.nombre+' (Mostrador)' : o.nombre}</div>
                    <div class="or-meta">
                        <span>üïë ${timeStr}</span>
                        <span class="chip ${o.source==='mostrador'?'mostrador':''}">Retiro: ${o.entrega||'take_away'}</span>
                        ${o.pickup_time_pretty ? `<span class="chip">‚è∞ ${o.pickup_time_pretty}</span>`:''}
                    </div>
                    <div class="state-btns">${stateBtnsHTML}</div>
                </div>
                <div class="or-right">
                    <div class="or-total">${money(total)}</div>
                    <div class="pay-line">
                        <select class="pay-select" onchange="updatePago('${doc.id}', this.value)">
                            <option value="" disabled ${!payVal?'selected':''}>M√©todo...</option>
                            <option value="efectivo" ${payVal==='efectivo'?'selected':''}>Efectivo</option>
                            <option value="mercado_pago" ${payVal==='mercado_pago'?'selected':''}>QR (MP)</option>
                            <option value="transferencia" ${payVal==='transferencia'?'selected':''}>Transferencia</option>
                        </select>
                        <button class="pay-status-btn ${isPaid?'is-paid':'is-pending'}" onclick="setPaymentStatus('${doc.id}', ${isPaid}, '${payVal}')">
                            ${isPaid ? 'PAGADO ‚úì' : 'PENDIENTE $'}
                        </button>
                        <button class="print-btn" onclick="printOrder('${doc.id}')">üñ®Ô∏è</button>
                    </div>
                </div>
            </div>
            <div class="items-list">${itemsHTML || '<div class="it-sub">Sin √≠tems</div>'}</div>
        </div>`;
    }

    /* --- FUNCI√ìN IMPRESI√ìN TICKET (58mm) --- */
    window.trySilentPrint = function(docSnap){
       const o = docSnap.data();
       const esc = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
       const m = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
       
       const dt = window.pickDate(o);
       const dateStr = dt.toLocaleDateString("es-AR");
       const timeStr = dt.toLocaleTimeString("es-AR",{hour12:false});

       let payTxt = o.pago;
       if(!payTxt || payTxt==='mostrador_sin_especificar') payTxt="A COBRAR EN CAJA";
       if(payTxt==='mercado_pago') payTxt="QR (MP)";
       
       const isPaid = (o.payment_status === 'paid') || o.paid;
       
       // Procesar items para ticket (simplificado)
       const items = Array.isArray(o.items)?o.items:[];
       let body = "";
       items.forEach(it=>{
          let dName = esc(it.name);
          // Normalizar papas en ticket
          if(it.type==='side' || dName.toLowerCase().includes('papas') || it.fries){
             const s = String(it.fries||it.name).toLowerCase().replace(/[_-]/g,' ');
             if(s.includes('sazon')) dName="Papas Sazonadas";
             else if(s.includes('sin sal')) dName="Papas Sin sal";
             else if(s.includes('sal')) dName="Papas Con sal";
          }
          body += `<div class="row" style="margin:4px 0"><div style="font-weight:700">${it.qty||1} x ${dName}</div></div>`;
          if(it.notes) body += `<div style="font-size:11px;margin-left:14px">üìù ${esc(it.notes)}</div>`;
          body += `<div style="border-top:1px dotted #ccc;margin:4px 0"></div>`;
       });

       const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);
       
       const html = `<!doctype html><html><head><style>
       @page{size:58mm auto;margin:0}body{width:58mm;margin:0 auto;padding:5px;font-family:monospace;font-size:12px;color:#000}
       .c{text-align:center}.b{font-weight:700}.h{font-size:14px}.hr{border-top:1px dashed #000;margin:8px 0}
       </style></head><body>
       <div class="c b h">Rhodes Burgers</div>
       <div class="c">Ord: #${o.orderNumber||'--'}</div>
       <div class="c b" style="font-size:16px;margin:5px 0">[ ${isPaid?'PAGADO':'PENDIENTE'} ]</div>
       <div class="hr"></div>
       <div>Cliente: ${esc(o.nombre)}</div>
       <div class="c b h" style="margin:5px 0">Retira: ${esc(o.pickup_time_pretty||'A la brevedad')}</div>
       <div>Pago: ${payTxt}</div>
       ${o.notes ? `<div class="hr"></div><div>Nota: ${esc(o.notes)}</div>`:''}
       <div class="hr"></div>
       ${body}
       <div class="hr"></div>
       <div style="display:flex;justify-content:space-between;font-size:14px" class="b"><div>TOTAL</div><div>${m(total)}</div></div>
       <div class="c" style="margin-top:10px;font-size:10px">${dateStr} ${timeStr}</div>
       <script>window.onload=()=>{setTimeout(()=>{window.print()},200)}<\/script>
       </body></html>`;
       
       const f = document.createElement('iframe'); f.style.cssText='position:fixed;top:0;left:0;width:0;height:0;border:0';
       document.body.append(f); const d=f.contentWindow.document; d.open();d.write(html);d.close();
       setTimeout(()=>f.remove(), 10000);
    };

  }); // End DOMContentLoaded
  </script>
</body>
</html>
