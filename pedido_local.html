<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers â€” Pedidos en vivo</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f7f7f8; --card:#fff; --radius:16px; --shadow:0 6px 24px rgba(0,0,0,.06) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.05) }
    .top{ max-width:1100px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand{ display:flex; align-items:center; gap:8px; font-weight:800 }
    .brand img{ width:34px; height:34px; border-radius:8px; object-fit:contain }
    .sp{ flex:1 }
    .btn{ border:2px solid var(--primary); border-radius:999px; padding:8px 14px; background:#fff; color:var(--primary); font-weight:700; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    main{ max-width:1100px; margin:18px auto; padding:0 12px; display:grid; grid-template-columns: 2fr 1fr; gap:16px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px }
    h2{ margin:0 0 10px; font-size:20px }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px }
    select, input[type="search"]{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .item{ border:1px solid #eee; border-radius:14px; padding:10px 12px }
    .muted{ color:var(--muted); font-size:13px }
    .money{ font-weight:800 }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:8px 10px; border-bottom:1px solid #eee; text-align:left; }
    th{ font-size:13px; color:#444 }
    .right{ text-align:right }
    @media (max-width:900px){ main{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand">
      <img src="images/logo.png" alt="Rhodes Burgers">
      <span>Pedidos en vivo</span>
    </div>
    <div class="sp"></div>
    <button id="btnSound" class="btn">ðŸ”” Activar sonido</button>
  </div>
</header>

<main>
  <!-- Columna izquierda: pedidos -->
  <section class="card">
    <h2>Pedidos</h2>
    <div class="row">
      <label>Mes:
        <select id="selMes"></select>
      </label>
      <label>AÃ±o:
        <select id="selAnio"></select>
      </label>
      <input id="busca" type="search" placeholder="Buscar por nombre o direcciÃ³n">
    </div>
    <div id="lista" class="list"></div>
    <p id="status" class="muted"></p>
  </section>

  <!-- Columna derecha: resumen -->
  <aside class="card">
    <h2>Resumen por mes</h2>
    <table id="tablaMeses">
      <thead>
        <tr><th>Mes</th><th class="right">Ventas</th><th class="right">Ingresos</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </aside>
</main>

<!-- Sonido (puedes reemplazar por un MP3 propio: sounds/new-order.mp3) -->
<audio id="newOrderAudio" preload="auto">
  <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3">
</audio>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
  const $ = s=>document.querySelector(s);
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

  const lista = $("#lista");
  const statusEl = $("#status");
  const selMes = $("#selMes");
  const selAnio = $("#selAnio");
  const busca = $("#busca");

  const audio = $("#newOrderAudio");
  let soundEnabled=false, firstLoad=true;
  $("#btnSound").onclick = async ()=>{
    try{ await audio.play(); audio.pause(); audio.currentTime=0; soundEnabled=true; alert("Sonido activado âœ…"); }catch(e){ alert("No se pudo activar sonido. TocÃ¡ de nuevo."); }
  };

  // Meses UI
  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  meses.forEach((m,i)=> selMes.innerHTML += `<option value="${i}">${m}</option>`);
  const hoy = new Date();
  selMes.value = hoy.getMonth();
  const yearNow = hoy.getFullYear();
  for (let y=yearNow-3; y<=yearNow+1; y++) selAnio.innerHTML += `<option value="${y}" ${y===yearNow?"selected":""}>${y}</option>`;

  let allOrders = []; // cache local de pedidos
  let unsub = null;

  function listen(){
    if (unsub) unsub();
    // Traemos todo y filtramos por mes en cliente (simple)
    unsub = db.collection("orders").orderBy("createdAt","desc").onSnapshot(snap=>{
      const addedNow=[];
      snap.docChanges().forEach(ch=>{
        if (ch.type==="added") addedNow.push(ch.doc.id);
      });

      allOrders = [];
      snap.forEach(d=>{
        const data = d.data()||{};
        allOrders.push({ id:d.id, ...data });
      });

      if (!firstLoad && addedNow.length && soundEnabled){
        try{ audio.play().catch(()=>{}); }catch(_){}
      }
      firstLoad=false;

      render();
      renderSummary();
    }, err=>{
      console.error(err);
      statusEl.textContent = "Error leyendo pedidos. RevisÃ¡ reglas de Firestore.";
    });
  }

  function inSelectedMonth(o){
    const ts = o.createdAt?.toDate ? o.createdAt.toDate() : null;
    if (!ts) return false; // si aÃºn no llegÃ³ el serverTimestamp lo omitimos
    return ts.getMonth() === Number(selMes.value) && ts.getFullYear() === Number(selAnio.value);
  }

  function render(){
    const term = busca.value.trim().toLowerCase();
    const filtered = allOrders
      .filter(o => inSelectedMonth(o))
      .filter(o => (o.status!=="cancelled")) // excluir cancelados en la lista; quitalo si querÃ©s ver todos
      .filter(o => !term || (`${o.nombre||""} ${o.direccion||""}`).toLowerCase().includes(term));

    if (filtered.length===0){
      lista.innerHTML = `<div class="muted">No hay pedidos para mostrar.</div>`;
      return;
    }

    lista.innerHTML = filtered.map(o=>{
      const dt = o.createdAt?.toDate ? o.createdAt.toDate() : null;
      const f = dt ? dt.toLocaleString("es-AR",{hour12:false}) : "â€”";
      const items = (o.items||[]).map(it=>{
        const line = `${it.qty||it.quantity}Ã— ${it.name||it.title}`;
        return `<div class="muted">â€¢ ${line}${it.notes?` â€” <em>${it.notes}</em>`:""}</div>`;
      }).join("");
      const papas = o.fries==="con_sazon"?"Con sazÃ³n":o.fries==="sin_sazon"?"Sin sazonar":"â€”";
      return `
        <div class="item">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <strong>#${o.id.slice(-6)} â€” ${o.nombre||"Sin nombre"}</strong>
            <span class="money">${money(o.total||0)}</span>
          </div>
          <div class="muted">${f}</div>
          <div>Entrega: <strong>${o.entrega||"-"}</strong> ${o.entrega==="delivery"&&o.direccion?`â€” ${o.direccion}`:""}</div>
          <div>Papas: <strong>${papas}</strong></div>
          <div style="margin-top:4px">${items}</div>
        </div>`;
    }).join("");
  }

  function renderSummary(){
    // Agrupar por mes/aÃ±o, excluyendo cancelados
    const map = new Map();
    for (const o of allOrders){
      if (o.status==="cancelled") continue; // no contar cancelados
      const dt = o.createdAt?.toDate ? o.createdAt.toDate() : null;
      if (!dt) continue;
      const key = `${dt.getFullYear()}-${dt.getMonth()}`; // YYYY-M
      if (!map.has(key)) map.set(key, { year: dt.getFullYear(), month: dt.getMonth(), ventas:0, ingresos:0 });
      const agg = map.get(key);
      agg.ventas += 1;                 // cantidad de pedidos
      agg.ingresos += Number(o.total)||0; // suma de total
    }

    const rows = Array.from(map.values()).sort((a,b)=> (b.year-a.year) || (b.month-a.month));
    const tbody = document.querySelector("#tablaMeses tbody");
    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Sin datos</td></tr>`;
      return;
    }
    tbody.innerHTML = rows.map(r=>{
      return `<tr>
        <td>${meses[r.month]} ${r.year}</td>
        <td class="right">${r.ventas}</td>
        <td class="right">${money(r.ingresos)}</td>
      </tr>`;
    }).join("");
  }

  selMes.addEventListener("change", render);
  selAnio.addEventListener("change", render);
  busca.addEventListener("input", render);

  // Go!
  listen();
</script>
</body>
</html>
