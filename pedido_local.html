<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Pedidos</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1000px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }

    .container{ max-width:1000px; margin:24px auto; padding:0 12px }
    h1{ font-size:28px; margin:0 0 14px }
    .filters{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px }
    select,input[type="text"]{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px }
    .list{ display:flex; flex-direction:column; gap:12px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px 14px; display:grid; grid-template-columns:1fr auto; gap:8px; align-items:start }
    .muted{ color:var(--muted) }
    .items{ margin-top:6px; color:#333; }
    .items li{ margin:2px 0 }
    .total{ font-weight:800; font-size:16px; }
    .chip{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e7e7e7; }
    .chip.efectivo{ background:#fff7e6; border-color:#ffd180 }
    .chip.mercado{ background:#e6fff0; border-color:#b5f0cf }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img src="images/logo.png" alt="Rhodes Burgers"></a>
      <strong>Panel de pedidos</strong>
      <div class="spacer"></div>
      <button class="btn ghost" id="btnSound">ðŸ”” Activar sonido</button>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Pedidos</h1>

      <div class="filters">
        <label>Mes:
          <select id="selMes"></select>
        </label>
        <label>AÃ±o:
          <select id="selAnio"></select>
        </label>
        <input id="inpSearch" type="text" placeholder="Buscar por nombre o notas" />
      </div>

      <div class="list" id="ordersList"></div>
    </div>
  </main>

  <audio id="sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <!-- Firebase v10 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, onSnapshot, orderBy, query } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    const $ = s => document.querySelector(s);
    const listEl   = $("#ordersList");
    const selMes   = $("#selMes");
    const selAnio  = $("#selAnio");
    const inpSearch= $("#inpSearch");
    const sound    = $("#sound");
    const btnSound = $("#btnSound");

    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const friesLabel = v => v==="con_sazon" ? "Con sazÃ³n" : v==="sin_sazon" ? "Sin sazonar" : "â€”";

    // poblar combos
    const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const now = new Date();
    meses.forEach((m,i)=> selMes.innerHTML += `<option value="${i}">${m}</option>`);
    selMes.value = now.getMonth();
    for(let y=now.getFullYear()-1;y<=now.getFullYear()+1;y++) selAnio.innerHTML += `<option>${y}</option>`;
    selAnio.value = now.getFullYear();

    // estado
    let docs = [];          // snapshot crudo
    let knownIds = new Set; // para sonido

    function render(){
      const m = Number(selMes.value), y = Number(selAnio.value);
      const q = (inpSearch.value||"").trim().toLowerCase();

      const filtered = docs.filter(d=>{
        const data = d.data;
        const ts = data.createdAt?.toDate ? data.createdAt.toDate() : (data.createdAt? new Date(data.createdAt) : null);
        if(!ts) return false;
        if(ts.getMonth()!==m || ts.getFullYear()!==y) return false;

        if(q){
          const hay = (data.nombre||"").toLowerCase().includes(q)
            || (data.direccion||"").toLowerCase().includes(q)
            || (data.items||[]).some(it => (it.name||"").toLowerCase().includes(q))
            || (data.notes||"").toLowerCase().includes(q);
          if(!hay) return false;
        }
        return true;
      });

      listEl.innerHTML = filtered.map(d=>{
        const o = d.data;
        const ts = o.createdAt?.toDate ? o.createdAt.toDate() : new Date(o.createdAt||Date.now());
        const idShown = o.orderNumber ? `#${o.orderNumber}` : `#${d.id}`;
        const chipClass = (o.metodoPago||o.pago)==="efectivo" ? "efectivo" : "mercado";
        const chipText  = (o.metodoPago||o.pago)==="efectivo" ? "Efectivo" : "Mercado Pago";
        const itemsHtml = (o.items||[]).map(it => `â€¢ ${it.qty}Ã— ${it.name}`).join("<br>");

        return `
        <div class="card">
          <div>
            <div><strong>${idShown}</strong> â€” <strong>${o.nombre||"Cliente"}</strong> &nbsp; <span class="chip ${chipClass}">${chipText}</span></div>
            <div class="muted">${ts.toLocaleDateString("es-AR")} ${ts.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",second:"2-digit"})}</div>
            <div>Entrega: <strong>take_away</strong></div>
            <div>Papas: <strong>${friesLabel(o.fries)}</strong></div>
            <div class="items">${itemsHtml}</div>
          </div>
          <div class="total">${money(o.total||0)}</div>
        </div>`;
      }).join("") || `<div class="muted">No hay pedidos para mostrar con los filtros seleccionados.</div>`;
    }

    selMes.onchange = render;
    selAnio.onchange = render;
    inpSearch.oninput = render;

    btnSound.onclick = ()=> {
      sound.play().then(()=> sound.pause()).catch(()=>{});
      btnSound.textContent = "ðŸ”” Sonido activado";
    };

    // SuscripciÃ³n en tiempo real (colecciÃ³n correcta: 'pedidos')
    const qRef = query(collection(db,"pedidos"), orderBy("createdAt","desc"));
    onSnapshot(qRef, (snap)=>{
      // detectar nuevos para sonido
      let hasNew = false;
      snap.docChanges().forEach(ch=>{
        if(ch.type==="added" && !knownIds.has(ch.doc.id)){
          hasNew = true;
          knownIds.add(ch.doc.id);
        }
      });

      docs = snap.docs.map(d=>({ id:d.id, data:d.data() }));
      render();

      if(hasNew){
        sound.play().catch(()=>{}); // puede requerir un click previo (usa el botÃ³n Activar sonido)
      }
    });
  </script>
</body>
</html>
