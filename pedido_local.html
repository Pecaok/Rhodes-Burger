<!doctype html> 
<html lang="es">

<!-- ============================
   SESI√ìN COMPARTIDA (ADMIN)
=============================== -->
<script>
const TTL_HOURS = 20;
const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

function sessionValid(){
  const ok = localStorage.getItem('rb_admin_ok') === 'true';
  const ts = Number(localStorage.getItem('rb_admin_t') || 0);
  return ok && (Date.now() - ts) < TTL_MS;
}
function bumpSession(){ 
  if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now())); 
}
function logout(){
  try{ localStorage.removeItem('rb_admin_ok'); }catch(_){}
  try{ localStorage.removeItem('rb_admin_t'); }catch(_){}
  try{ localStorage.removeItem('rb_auth_v2'); }catch(_){}
  try{ sessionStorage.removeItem('rb_auth_v2'); }catch(_){}
  location.replace('login.html');
}
(function(){
  if (!sessionValid()){
    const next = encodeURIComponent(location.pathname.replace(/^\//,''));
    location.replace('login.html?next=' + next);
  } else bumpSession();
})();
['click','keydown','focus','mousemove','touchstart','scroll']
.forEach(evt=>{
  window.addEventListener(evt, bumpSession, {passive:true});
});
</script>

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pedidos ‚Ä¢ Rhodes Burgers</title>
<link rel="icon" href="images/logo.png">

<style>
:root{
  --primary:#625A45;
  --text:#111;
  --muted:#444;
  --bg:#f6f6f6;
  --card:#fff;
  --ring:#eaeaea;
  --shadow:0 12px 34px rgba(0,0,0,.10);
  --font: Inter, system-ui, "Segoe UI", Roboto, Arial, sans-serif;

  --st-accepted:#FBC02D;
  --st-in_prep:#FB8C00;
  --st-ready:#00ACC1;
  --st-delivered:#2E7D32;
  --st-cancelled:#D32F2F;

  --pay-pending:#FFA000;
  --pay-paid:#625A45;
}

html,body{
  margin:0;
  background:var(--bg);
  font-family:var(--font);
  color:var(--text);
}

header{
  position:sticky;
  top:0;
  z-index:10;
  background:#fff;
  box-shadow:0 2px 12px rgba(0,0,0,.06)
}

.topbar{
  max-width:1100px;
  margin:0 auto;
  padding:10px 12px;
  display:flex;
  align-items:center;
  gap:12px;
}

.brand{
  display:flex;
  align-items:center;
  text-decoration:none;
  font-weight:700;
  color:inherit;
}
.brand img{
  width:36px;
  height:36px;
  border-radius:10px;
  margin-right:8px;
}

.spacer{ flex:1; }

.btn{
  display:inline-flex;
  align-items:center;
  gap:8px;
  border:1px solid var(--ring);
  padding:8px 12px;
  border-radius:999px;
  cursor:pointer;
  background:#fff;
  font-weight:600;
  text-decoration:none;
  color:inherit;
}

.btn.primary,
.btn.active{
  background:var(--primary);
  color:#fff;
  border-color:var(--primary);
}

.btn.danger{
  background:#fff5f5;
  color:#b30000;
}

.container{
  max-width:1100px;
  margin:24px auto;
  padding:0 12px;
}

h1{
  font-size:28px;
  margin:10px 0 18px;
}

.tabs{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin:14px 0;
}

.chipf{
  background:#f3f3f3;
  border:1px solid var(--ring);
  border-radius:999px;
  padding:6px 10px;
  font-size:13px;
  cursor:pointer;
}
.chipf.active{
  background:var(--primary);
  border-color:var(--primary);
  color:#fff;
}

.order{
  background:var(--card);
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:16px 18px;
  margin:14px 0;
}

.order-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
}

.order-title{
  font-weight:800;
}

.muted{
  color:var(--muted);
}

.chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:6px;
}

.chip{
  background:#f3f3f3;
  border:1px solid var(--ring);
  border-radius:999px;
  padding:6px 10px;
  font-size:13px;
}

.right-total{
  font-weight:800;
  font-size:18px;
  white-space:nowrap;
}

.items{ margin-top:10px; }
.item{ margin:8px 0 6px; }
.item .sub{ font-size:13px; margin-top:3px; }

.divider{
  height:1px;
  background:#efefef;
  margin:10px 0;
}

.stateBtns{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}

.state-btn{
  border:2px solid #dcdcdc;
  border-radius:999px;
  padding:8px 12px;
  min-width:160px;
  font-weight:800;
  cursor:pointer;
  text-align:center;
  background:#fff;
}

.state-btn.on{ color:#fff; }
.state-accepted.on{ background:var(--st-accepted); border-color:var(--st-accepted); color:#000; }
.state-in_prep.on{ background:var(--st-in_prep); border-color:var(--st-in_prep); }
.state-ready.on{ background:var(--st-ready); border-color:var(--st-ready); }
.state-delivered.on{ background:var(--st-delivered); border-color:var(--st-delivered); }
.state-cancelled.on{ background:var(--st-cancelled); border-color:var(--st-cancelled); }

.pay-line{
  margin-top:6px;
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}

.pay-method-select{
  padding:6px 10px;
  border:1px solid var(--ring);
  border-radius:8px;
  background:#fff;
  font-size:14px;
  height:36px;
}

.pay-toggle{
  min-width:200px;
  text-align:center;
}
.pay-toggle.is-paid{
  background:var(--pay-paid);
  border-color:var(--pay-paid);
  color:#fff;
}
.pay-toggle.is-pending{
  background:var(--pay-pending);
  border-color:var(--pay-pending);
  color:#fff;
}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png">Pedidos</a>
    <div class="spacer"></div>

    <a href="pedido_local.html" class="btn primary">üì¶ Pedidos</a>
    <a href="finanzas.html" class="btn">üìà Finanzas</a>
    <a href="mostrador.html" class="btn">üßæ Mostrador</a>
    <a href="admin.html" class="btn">‚öôÔ∏è Admin</a>

    <button id="btnBell" class="btn">üîî</button>
    <button id="btnLogout" class="btn danger">‚èª Cerrar sesi√≥n</button>
  </div>
</header>

<main class="container">
  <h1>√öltimos pedidos</h1>

  <div class="tabs" id="tabs">
    <span class="chipf active" data-f="recibidos">Recibidos</span>
    <span class="chipf" data-f="entregados">Entregados</span>
    <span class="chipf" data-f="cancelled">Cancelados</span>
    <span class="chipf" data-f="all">Todos</span>
  </div>

  <div id="orders"></div>
  <div id="ordersError" class="err" style="display:none;margin-top:8px"></div>
</main>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
window.addEventListener('DOMContentLoaded', () => {

  /* ============================
       FIREBASE INIT
  ============================ */
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig);}catch(e){}

  const db = firebase.firestore();
  const $ = s => document.querySelector(s);

  const money = n =>
    (Number(n)||0).toLocaleString("es-AR",{
      style:"currency",
      currency:"ARS",
      maximumFractionDigits:0
    });


  /* ============================
        FECHAS Y ORDENES
  ============================ */
  function pickDocDate(obj){
    const keys = [
      'createdAt','created_at','timestamp','date','fecha','time'
    ];
    for(const k of keys){
      const v = obj[k];
      if (v?.toDate) return v.toDate();
      if (typeof v === 'number') return new Date(v);
      if (typeof v === 'string'){
        const d = new Date(v);
        if(!isNaN(d)) return d;
      }
    }
    return null;
  }

  function displayOrderNumber(doc){
    const o = doc.data();
    const keys = [
      o.orderNumber,o.number,o.numero,o.num,o.numPedido,o.nro,
      o.orderNo,o.seq,o.n,o.idPedido,o.pedidoNumber,o.pedido
    ];
    for(const v of keys){
      if(v==null) continue;
      const n = typeof v==="string" ? parseInt(v,10) : v;
      if(Number.isFinite(n)) return `#${n}`;
    }
    return `#${doc.id.slice(-5).toUpperCase()}`;
  }


  /* ============================
     FORMATO HORARIO RETIRO
  ============================ */
  function formatSlotTime(raw){
    if(!raw) return null;
    try{
      if(typeof raw?.toDate === 'function')
        return raw.toDate().toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
      if(typeof raw === 'string'){
        const d=new Date(raw);
        if(!isNaN(d))
          return d.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
        const m = raw.match(/(\d{2})(\d{2})$/);
        if(m) return `${m[1]}:${m[2]}`;
      }
    }catch(e){}
    return null;
  }

  function getPickupPretty(o){
    let pretty =
      o.pickup_time_pretty ||
      formatSlotTime(o.pickup_time || o.pickup);

    if(!pretty && o.pickup_slot){
      const m = String(o.pickup_slot).match(/(\d{2})(\d{2})$/);
      if(m) pretty = `${m[1]}:${m[2]}`;
    }

    if (!pretty && o.pickup_asap === true) pretty = "A la brevedad";

    return pretty || "‚Äî";
  }


  /* ============================
          SONIDO
  ============================ */
  let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
  const btnBell = $("#btnBell");

  function updateBellUI(){
    btnBell.classList.toggle("active", soundEnabled);
  }
  updateBellUI();

  btnBell.onclick = () => {
    soundEnabled = !soundEnabled;
    localStorage.setItem("rb_bell_enabled", JSON.stringify(soundEnabled));
    updateBellUI();
  };

  function playBeep(){
    if(!soundEnabled) return;
    const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    audio.volume = 0.4;
    audio.play().catch(()=>{});
  }


  /* ============================
          FILTROS
  ============================ */
  const tabs = $("#tabs");
  let currentFilter = "recibidos";
  let lastSnap = null;

  tabs.addEventListener("click", e=>{
    const el = e.target.closest("[data-f]");
    if(!el) return;

    currentFilter = el.dataset.f;
    tabs.querySelectorAll(".chipf").forEach(t=>t.classList.remove("active"));
    el.classList.add("active");

    if(lastSnap) renderList(lastSnap);
  });

  const passFilter = o => {
    const s = o.status || "accepted";

    if(currentFilter==="recibidos")
      return ["accepted","pending_payment","in_prep","ready"].includes(s);

    if(currentFilter==="entregados")
      return s==="delivered";

    if(currentFilter==="cancelled")
      return s==="cancelled";

    return true;
  };


  /* ============================
      ACCI√ìN CAMBIAR ESTADO
  ============================ */
  async function setOrderStatus(id,next){
    try{
      await db.collection("orders").doc(id).update({
        status: next,
        statusHistory: firebase.firestore.FieldValue.arrayUnion({
          to:next,
          at:new Date().toISOString()
        })
      });
    }catch(e){
      alert("Error cambiando estado: " + e);
    }
  }

  /* ============================
      PAGADO / PENDIENTE
  ============================ */
  async function setPaymentStatus(id, paid){
    try{
      await db.collection("orders").doc(id).update({
        paid: !!paid,
        payment_status: paid ? "paid" : "pending_payment",
        statusHistory: firebase.firestore.FieldValue.arrayUnion({
          to: paid?"paid":"pending_payment",
          at:new Date().toISOString()
        })
      });
    }catch(e){
      alert("No se pudo actualizar pago: "+e);
    }
  }


  /* ============================
        NORMALIZAR PAPAS
  ============================ */
  function normalizeFriesLabel(raw){
    if(!raw) return '';
    let s = String(raw).toLowerCase().trim();
    if(s.includes("sin sal")) return "Sin sal";
    if(s.includes("sazon")) return "Sazonadas";
    if(s.includes("sal")) return "Con sal";
    return '';
  }


  /* ============================
         RENDER PEDIDO
  ============================ */
  const STATE_SEQ = ["accepted","in_prep","ready","delivered","cancelled"];
  const STATE_LABEL = {
    accepted:"Recibido",
    in_prep:"En preparaci√≥n",
    ready:"Listo",
    delivered:"Entregado",
    cancelled:"Cancelar"
  };

  function renderOrder(doc){
    const o = doc.data();
    const dt = pickDocDate(o);
    const dtText = dt ? dt.toLocaleDateString("es-AR")+" "+dt.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"}) : "‚Äî";

    const items = o.items || [];
    const pickupPretty = getPickupPretty(o);

    /* ITEMS */
    const itemsHTML = items.map(it=>{
      const qty = it.qty||1;
      const baseSubtotal = (it.price||0)*qty;

      const extras = [];
      if(it.extras?.patty) extras.push(`+${it.extras.patty} medall√≥n`);
      if(it.extras?.cheddar) extras.push(`+${it.extras.cheddar} cheddar`);

      const fries = normalizeFriesLabel(it.fries||it.side);

      return `
        <div class="item">
          <div><strong>${qty}√ó ${it.name}</strong></div>
          <div class="sub">Papas: ${fries||"‚Äî"} ${extras.length? " ¬∑ Extras: "+extras.join(" ¬∑ "):""}</div>
          <div class="sub">Subtotal: ${money(baseSubtotal)}</div>
        </div>
      `;
    }).join("");


    /* ESTADOS */
    const st = o.status || "accepted";
    const curIdx = STATE_SEQ.indexOf(st);

    const stateBtns = `
      <div class="stateBtns">
        ${STATE_SEQ.map((s,idx)=>`
          <button class="state-btn state-${s} ${idx<=curIdx?"on":""}" data-act="${s}">
            ${STATE_LABEL[s]}
          </button>
        `).join("")}
      </div>
    `;


    /* PAGO */
    const isPaid = (o.payment_status==="paid" || o.paid===true);

    const payBtnClass = isPaid ? "pay-toggle is-paid" : "pay-toggle is-pending";

    const payLine = `
    <div class="pay-line">

      <select class="pay-method-select" data-id="${doc.id}">
        <option value="">M√©todo...</option>
        <option value="efectivo"      ${o.pago==="efectivo"?"selected":""}>Efectivo</option>
        <option value="debito"        ${o.pago==="debito"?"selected":""}>D√©bito</option>
        <option value="credito"       ${o.pago==="credito"?"selected":""}>Cr√©dito</option>
        <option value="mercadopago"   ${o.pago==="mercadopago"?"selected":""}>Mercado Pago</option>
        <option value="transferencia" ${o.pago==="transferencia"?"selected":""}>Transferencia</option>
        <option value="otro"          ${o.pago==="otro"?"selected":""}>Otro</option>
      </select>

      <span class="chip">Pago: ${o.pago||"‚Äî"}</span>

      <button class="${payBtnClass}" data-pay-toggle="${isPaid?'paid':'pending'}">
        ${isPaid ? "PAGADO ‚úì" : "PENDIENTE DE PAGO"}
      </button>

      <button class="btn" data-print>üñ® Imprimir</button>
    </div>
    `;


    return `
    <div class="order" data-id="${doc.id}">
      <div class="order-head">

        <div>
          <div class="order-title">${displayOrderNumber(doc)} ‚Äî ${o.nombre||"Cliente"}</div>
          <div class="muted">${dtText}</div>

          <div class="chips">
            <span class="chip">Estado: ${st}</span>
            <span class="chip">Retiro: ${o.entrega||"mostrador"}</span>
            <span class="chip">Horario: ${pickupPretty}</span>
            ${o.telefono?`<span class="chip">Tel: ${o.telefono}</span>`:""}
            ${o.source?`<span class="chip">Origen: ${o.source}</span>`:""}
          </div>

          ${stateBtns}
        </div>

        <div>
          <div class="right-total">${money(o.total || 0)}</div>
          ${payLine}
        </div>

      </div>

      <div class="divider"></div>

      <div class="items">${itemsHTML}</div>
    </div>
    `;
  }


  /* ============================
        RENDER LISTA
  ============================ */
  function renderList(snap){
    const docs = snap.docs.filter(d=>passFilter(d.data()));

    lastSnap = snap;

    $("#orders").innerHTML =
      docs.length ? docs.map(renderOrder).join("") :
      `<p class="muted">No hay pedidos.</p>`;

    document.querySelectorAll(".order").forEach(card=>{

      const id = card.dataset.id;


      /* ‚Äî‚Äî‚Äî Cambiar estado ‚Äî‚Äî‚Äî */
      card.querySelectorAll("[data-act]").forEach(btn=>
        btn.addEventListener("click",()=> setOrderStatus(id,btn.dataset.act))
      );


      /* ‚Äî‚Äî‚Äî Selector m√©todo de pago ‚Äî‚Äî‚Äî */
      const paySelect = card.querySelector(".pay-method-select");
      if(paySelect){
        paySelect.addEventListener("change", async ()=>{
          const newMethod = paySelect.value;
          try{
            await db.collection("orders").doc(id).update({
              pago:newMethod,
              payment_method:newMethod
            });
          }catch(e){
            alert("Error guardando m√©todo de pago: "+e);
          }
        });
      }


      /* ‚Äî‚Äî‚Äî Bot√≥n PAGADO/PENDIENTE ‚Äî‚Äî‚Äî */
      const payToggle = card.querySelector("[data-pay-toggle]");
      if(payToggle){
        payToggle.addEventListener("click", async ()=>{
          const wasPaid = (payToggle.dataset.payToggle==="paid");
          const newState = !wasPaid;

          payToggle.textContent = newState ? "PAGADO ‚úì" : "PENDIENTE DE PAGO";
          payToggle.dataset.payToggle = newState ? "paid" : "pending";
          payToggle.classList.toggle("is-paid", newState);
          payToggle.classList.toggle("is-pending", !newState);

          await setPaymentStatus(id, newState);
        });
      }


      /* ‚Äî‚Äî‚Äî IMPRIMIR (nueva pesta√±a) ‚Äî‚Äî‚Äî */
      const pr = card.querySelector("[data-print]");
      if(pr){
        pr.addEventListener("click", () => {
          const snapDoc = lastSnap.docs.find(x => x.id === id);
          if(snapDoc) openPrintTab(snapDoc);
        });
      }

    });
  }


  /* ============================
        IMPRIMIR EN NUEVA PESTA√ëA
  ============================ */
  function openPrintTab(docSnap){
    const ticketHTML = buildTicketHTML(docSnap);
    const w = window.open("", "_blank");
    w.document.write(ticketHTML);
    w.document.close();
  }


  /* ============================
         BUILDER TICKET
  ============================ */
  function buildTicketHTML(docSnap){
    const o = docSnap.data();
    return `
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Ticket</title>
<style>
  body{
    font-family: Arial, sans-serif;
    padding:10px;
    font-size:14px;
  }
  .big{ font-size:20px; font-weight:800; text-align:center; }
  .line{ margin:6px 0; }
</style>
</head>
<body>

  <div class="big">Rhodes Burgers</div>
  <div class="big">${displayOrderNumber(docSnap)}</div>
  <hr>

  <div class="line"><b>Cliente:</b> ${o.nombre||""}</div>
  <div class="line"><b>Pago:</b> ${o.pago||"‚Äî"}</div>
  <div class="line"><b>Retiro:</b> ${getPickupPretty(o)}</div>
  <hr>

  <b>Items:</b><br>
  ${(o.items||[]).map(it=>`${it.qty}√ó ${it.name}`).join("<br>")}

  <hr>
  <div class="big">Total: ${money(o.total||0)}</div>

  <script>
     setTimeout(()=>window.print(),300);
  <\/script>

</body>
</html>
    `;
  }


  /* ============================
        SUSCRIPCI√ìN FIRESTORE
  ============================ */
  db.collection("orders")
    .orderBy("createdAt","desc")
    .limit(500)
    .onSnapshot(
      snap => {
        $("#ordersError").style.display="none";
        renderList(snap);
        playBeep();
      },
      err => {
        console.error(err);
        $("#ordersError").textContent = "Error cargando pedidos.";
        $("#ordersError").style.display="block";
      }
    );

});
</script>
<!-- ============================
        PWA LOADER
============================= -->
<script src="pwa.js"></script>

</body>
</html>

