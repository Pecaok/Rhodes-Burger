<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#625A45;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --radius:18px;
      --ring:#eaeaea;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
      position:sticky;
      top:0;
      z-index:20;
    }
    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      max-width:1200px;
      margin:0 auto;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      font-weight:800;
      color:inherit;
    }
    .brand img{
      width:32px;
      height:32px;
      object-fit:contain;
      margin-right:8px;
      border-radius:10px;
      background:#fff;
    }
    .spacer{flex:1}
    nav a{
      text-decoration:none;
      padding:6px 12px;
      background:#fff;
      border:1px solid var(--ring);
      border-radius:999px;
      font-weight:700;
      color:#000;
    }

    h1{
      margin:20px auto 10px;
      max-width:1200px;
      padding:0 14px;
      font-size:26px;
      font-weight:800;
    }

    /* Filtros */
    .filters{
      max-width:1200px;
      margin:0 auto;
      padding:0 14px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .filters button{
      padding:6px 14px;
      border:1px solid var(--ring);
      background:#fff;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
    }
    .filters button.active{
      border-color:var(--primary);
      background:var(--primary);
      color:#fff;
    }

    /* Tarjetas de pedido */
    .order-card{
      max-width:1200px;
      margin:20px auto;
      padding:14px;
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 12px 30px rgba(0,0,0,.08);
    }

    .order-header{
      display:flex;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
      font-weight:700;
      font-size:18px;
    }

    .order-meta{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      color:var(--muted);
    }
    .badge{
      padding:3px 8px;
      background:#eee;
      border-radius:8px;
      font-weight:600;
      font-size:12px;
    }

    /* Estado */
    .status-row{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .status-row button{
      padding:8px 14px;
      border:1px solid var(--ring);
      border-radius:8px;
      font-weight:700;
      background:#fff;
      cursor:pointer;
    }

    /* M√©todo de pago */
    .pay-row{
      margin-top:12px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    select{
      padding:6px 10px;
      border-radius:10px;
      border:1px solid var(--ring);
      font-weight:700;
    }

    .pay-badge{
      padding:6px 14px;
      background:#F7A400;
      color:#fff;
      border-radius:999px;
      font-weight:800;
      font-size:13px;
    }

    /* Bot√≥n imprimir */
    .print-btn{
      padding:8px 14px;
      background:#fff;
      border-radius:8px;
      border:1px solid var(--ring);
      font-weight:700;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }

    /* Items */
    .items{
      margin-top:16px;
      border-top:1px solid #eee;
      padding-top:10px;
      font-size:14px;
    }
    .items strong{font-size:15px}

  </style>
</head>

<body>
<header>
  <div class="topbar">
    <a class="brand"><img src="images/logo.png">Rhodes Burgers</a>
    <div class="spacer"></div>
    <nav>
      <a href="pedido_local.html">üì¶ Pedidos</a>
      <a href="finanzas.html">üìà Finanzas</a>
      <a href="admin.html">‚öôÔ∏è Admin</a>
    </nav>
  </div>
</header>

<h1>√öltimos pedidos</h1>

<div class="filters">
  <button data-filter="recibidos" class="active">Recibidos</button>
  <button data-filter="entregados">Entregados</button>
  <button data-filter="cancelados">Cancelados</button>
  <button data-filter="todos">Todos</button>
</div>

<div id="ordersContainer"></div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ============================
   üî• CONFIG FIREBASE
============================ */
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const ordersContainer = document.getElementById("ordersContainer");


/* ============================
   üî• FILTROS
============================ */
let currentFilter = "recibidos";

document.querySelectorAll(".filters button").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".filters button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentFilter = btn.dataset.filter;
    renderOrders();
  };
});


/* ============================
   üî• ESCUCHA EN VIVO FIRESTORE
============================ */
let ordersRaw = [];

db.collection("orders")
  .orderBy("createdAt","desc")
  .onSnapshot(snap=>{
    ordersRaw = snap.docs;
    renderOrders();
  });


/* ============================
   üî• FILTRAR + RENDERIZAR
============================ */
function shouldShow(order){
  const st = order.status || order.data().status || "";
  if(currentFilter==="todos") return true;
  if(currentFilter==="recibidos") return st==="accepted" || st==="pending_payment";
  if(currentFilter==="entregados") return st==="completed";
  if(currentFilter==="cancelados") return st==="cancelled";
  return true;
}

function renderOrders(){
  ordersContainer.innerHTML = "";
  let count = 0;

  ordersRaw.forEach(doc=>{
    const o = doc.data();
    if(!shouldShow(o)) return;

    count++;

    const card = document.createElement("div");
    card.className = "order-card";

    /* ======================
       üî• CABECERA
    ====================== */
    const date = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
    const dateStr = date.toLocaleDateString("es-AR");
    const timeStr = date.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit"});

    const orderNumber = o.orderNumber || doc.id.slice(-5).toUpperCase();

    card.innerHTML = `
      <div class="order-header">
        <div>#${orderNumber} ‚Äî ${o.nombre || "Cliente"}</div>
        <div>$ ${o.total?.toLocaleString("es-AR")}</div>
      </div>

      <div class="order-meta">
        <div class="badge">Estado: ${o.status}</div>
        <div class="badge">Retiro: mostrador</div>
        ${o.pickup_time_pretty ? `<div class="badge">Horario: ${o.pickup_time_pretty}</div>` : ""}
        <div class="badge">Tel: ${o.telefono || "-"}</div>
        <div class="badge">Origen: mostrador</div>
      </div>

      <div class="status-row">
        <button data-act="recibido">Recibido</button>
        <button data-act="preparacion">En preparaci√≥n</button>
        <button data-act="listo">Listo</button>
        <button data-act="entregado">Entregado</button>
        <button data-act="cancelar">Cancelar</button>
      </div>

      <div class="pay-row">
        <select class="selPago">
          <option value="efectivo" ${o.pago==="efectivo"?"selected":""}>Efectivo</option>
          <option value="debito" ${o.pago==="debito"?"selected":""}>D√©bito</option>
          <option value="mercado_pago" ${o.pago==="mercado_pago"?"selected":""}>Mercado Pago</option>
          <option value="transferencia" ${o.pago==="transferencia"?"selected":""}>Transferencia</option>
        </select>

        <div class="pay-badge">
          ${o.payment_status==="paid" ? "PAGADO" : "PENDIENTE DE PAGO"}
        </div>

        <button class="print-btn">üñ®Ô∏è Imprimir</button>
      </div>

      <div class="items">
        ${buildItemsHTML(o.items)}
        <div style="margin-top:10px;font-weight:800">Subtotal: $ ${o.total?.toLocaleString("es-AR")}</div>
      </div>
    `;

    /* ==========================
       üî• EVENTO CAMBIAR PAGO
    ========================== */
    card.querySelector(".selPago").onchange = e=>{
      const pago = e.target.value;

      db.collection("orders").doc(doc.id).set({
        pago,
        payment_status: pago==="efectivo" || pago==="debito" ? "paid" : "pending_payment"
      },{merge:true});
    };

    /* ==========================
       üî• BOT√ìN IMPRIMIR
    ========================== */
    card.querySelector(".print-btn").onclick = ()=>{
      printInIframe(doc);
    };

    ordersContainer.appendChild(card);
  });

  if(count===0){
    ordersContainer.innerHTML = `<p style="padding:20px;color:#666">No hay pedidos.</p>`;
  }
}


/* ============================
   üî• FORMATEAR ITEMS
============================ */
function buildItemsHTML(items){
  if(!items || !items.length) return "Sin √≠tems.";

  return items.map(it=>{
    let extra = "";
    if(it.extras){
      if(it.extras.patty) extra += ` (+${it.extras.patty} medall√≥n)`;
      if(it.extras.cheddar) extra += ` (+${it.extras.cheddar} cheddar)`;
    }
    return `
      <div style="margin-bottom:8px">
        <strong>${it.qty}√ó ${it.name}</strong><br>
        Papas: ${it.fries || "-"}<br>
        ${extra ? `<span style="color:#666">${extra}</span><br>`:""}
        $ ${(it.price * it.qty).toLocaleString("es-AR")}
      </div>
    `;
  }).join("");
}


/* ============================
   üî• FUNCI√ìN PARA IMPRIMIR
   (ticket completo en la parte 3)
============================ */
function printInIframe(docSnap){
  const html = buildTicketHTML(docSnap); // viene en parte 3

  const iframe = document.createElement("iframe");
  iframe.style.position = "fixed";
  iframe.style.width = "0";
  iframe.style.height = "0";
  iframe.style.border = "0";
  document.body.appendChild(iframe);

  const win = iframe.contentWindow;
  win.document.open();
  win.document.write(html);
  win.document.close();

  win.addEventListener("load", ()=>{
    win.print();
    setTimeout(()=>iframe.remove(), 800);
  });
}
</script>
<script>
/* ======================================================
   üî• TICKET 58 MM ‚Äî IGUAL AL DEL MOSTRADOR
====================================================== */

function normalizeFriesLabel(raw){
  if(!raw) return "";
  let s = raw.toString().toLowerCase().replace(/_/g," ").trim();

  if(s.includes("sin") && s.includes("sal")) return "Sin sal";
  if(s.includes("sazon")) return "Sazonadas";
  if(s.includes("sal")) return "Con sal";

  return "";
}

function buildTicketHTML(docSnap){
  const o = docSnap.data ? docSnap.data() : docSnap;  
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  const escape = s => (s||"").toString()
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");

  const dateObj = o.createdAt?.toDate ? o.createdAt.toDate() : new Date();
  const dateStr = dateObj.toLocaleDateString("es-AR");
  const timeStr = dateObj.toLocaleTimeString("es-AR",{hour12:false});

  const orderNo = o.orderNumber || o.num || ("#" + docSnap.id.slice(-5).toUpperCase());
  const phone = o.telefono || o.tel || "";

  const generalComment = o.comment || o.comentario || o.notes || "";

  const pickupPretty = o.pickup_time_pretty || null;

  /* ======================================================
     üî• Construcci√≥n de ITEMS (igual mostrador)
  ====================================================== */
  const itemsHTML = (o.items||[]).map(it=>{
    const qty = it.qty || 1;
    const name = escape(it.name);

    const base = it.price * qty;

    const pattyCount = it.extras?.patty || 0;
    const cheddarCount = it.extras?.cheddar || 0;

    const pattySum = pattyCount * qty * (it.extras?.EXTRA_PRICE_PATTY || 0);
    const cheddarSum = cheddarCount * qty * (it.extras?.EXTRA_PRICE_CHEDDAR || 0);

    const totalLine = base + pattySum + cheddarSum;

    const fries = normalizeFriesLabel(it.fries);

    let notesHTML = "";
    if(it.notes){
      notesHTML = `<div class="sub">‚Ä¢ Nota: ${escape(it.notes)}</div>`;
    }

    const extrasHTML = [];
    if(cheddarCount){
      extrasHTML.push(`
        <div class="row extra">
          <div class="l">+${cheddarCount} √ó Cheddar</div>
          <div class="r">${money(cheddarSum)}</div>
        </div>
      `);
    }
    if(pattyCount){
      extrasHTML.push(`
        <div class="row extra">
          <div class="l">+${pattyCount} √ó Medall√≥n extra</div>
          <div class="r">${money(pattySum)}</div>
        </div>
      `);
    }

    return `
      <div class="row name">
        <div class="l">${qty} √ó ${name}</div>
      </div>
      ${fries ? `<div class="sub">‚Ä¢ Papas: ${fries}</div>` : ""}
      ${notesHTML}
      <div class="row amount"><div class="l"></div><div class="r">${money(base)}</div></div>
      ${extrasHTML.join("")}
      <div class="row amount final"><div class="l"></div><div class="r">${money(totalLine)}</div></div>
      <div class="sep"></div>
    `;
  }).join("");

  const total = (typeof o.total === "number") ? o.total :
    (o.items||[]).reduce((t,it)=>{
      const base = it.price * it.qty;
      const extras = (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0) +
                     (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0);
      return t + base + extras;
    },0);

  /* ======================================================
     üî• HTML COMPLETO DEL TICKET
  ====================================================== */
  return `
<!doctype html>
<html>
<head>
<meta charset="utf-8">

<style>
  @page { size:58mm auto; margin:0; }
  * { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
  body { font-family:Arial, sans-serif; font-size:13px; font-weight:700; margin:0; }
  .ticket { width:48mm; padding:2mm 2mm 8mm; }

  .c { text-align:center; }
  .brand { font-size:16px; }
  .orderNo { font-size:14px; margin:1mm 0; }

  .hr { border-top:1px solid #000; margin:3px 0; }

  .lbl { font-size:11px; text-transform:uppercase; }
  .blk { margin:2px 0 2mm 0; }

  .row { display:flex; justify-content:space-between; }
  .l { flex:1; }
  .r { min-width:20mm; text-align:right; }

  .sub { font-size:11px; margin-left:2mm; }
  .sep { border-top:1px dashed #000; opacity:.5; margin:2mm 0; }

  .row.extra .l { font-size:11px; }
  .row.extra .r { font-size:12px; }

  .totalRow { font-size:16px; margin-top:3mm; }

  .foot { margin-top:4mm; text-align:center; font-size:10px; font-weight:400; }
</style>

</head>
<body>
<div class="ticket">

  <div class="c brand">Rhodes Burgers</div>
  <div class="orderNo c">#${escape(orderNo)}</div>

  <div class="hr"></div>

  ${o.nombre ? `
    <div class="blk">
      <div class="lbl">CLIENTE</div>
      <div>${escape(o.nombre)}</div>
    </div>
  ` : ""}

  ${phone ? `
    <div class="blk">
      <div class="lbl">TEL√âFONO</div>
      <div>${escape(phone)}</div>
    </div>
  ` : ""}

  ${pickupPretty ? `
    <div class="c" style="margin:6px 0;font-size:20px;font-weight:900">
      Retira a las:<br>${escape(pickupPretty)}
    </div>
  ` : `
    <div class="c" style="margin:6px 0;font-size:20px;font-weight:900">
      Retiro: A la brevedad
    </div>
  `}

  ${(o.pago||o.payment_method) ? `
    <div class="blk">
      <div class="lbl">MEDIO DE PAGO</div>
      <div>${escape(o.pago || o.payment_method)}</div>
    </div>
  `:""}

  ${generalComment ? `
    <div class="hr"></div>
    <div class="blk">
      <div class="lbl">COMENTARIO</div>
      <div>${escape(generalComment)}</div>
    </div>
    <div class="hr"></div>
  `:""}

  <div class="hr"></div>

  ${itemsHTML}

  <div class="hr"></div>

  <div class="row totalRow">
    <div class="l">TOTAL</div>
    <div class="r">${money(total)}</div>
  </div>

  <div class="foot">
    ${dateStr} ‚Äî ${timeStr}
    <div>${pickupPretty ? `Horario de retiro: ${escape(pickupPretty)}` : "Retiro: A la brevedad"}</div>
  </div>

</div>

<script>
  window.onload = ()=>{ setTimeout(()=>{ window.print(); },30); };
</script>

</body>
</html>`;
}
</script>
