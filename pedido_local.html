<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:22px; --shadow:0 12px 34px rgba(0,0,0,.10); --ring:#eaeaea;
      --danger:#d32f2f; --warn:#ff9800; --ok:#2e7d32;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.active{background:var(--primary);color:#fff;border-color:#2ecc71}
    .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}
    .btn.warn{border-color:#ffe0b2;background:#fff8e1;color:#8a5b00}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .chipf{background:#f3f3f3;border:1px solid var(--ring);color:#333;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chipf.active{background:#2ecc71;color:#fff;border-color:#2ecc71}

    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    .order.cancelled{opacity:.65; text-decoration:line-through}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#f3f3f3;border:1px solid var(--ring);color:#333;border-radius:999px;padding:6px 10px;font-size:13px}
    .muted{color:var(--muted)}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap;display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .payBadge{display:inline-block;border-radius:12px;padding:6px 10px;font-weight:800}
    .payBadge.paid{background:#e8f8ef;color:#137a42;border:1px solid #bdebd1}
    .payBadge.pending{background:#fff3cd;color:#8a5b00;border:1px solid #ffe7a6}

    .items{margin-top:10px}
    .item{margin:8px 0 6px 0}
    .item strong{font-weight:700}
    .item .sub{color:var(--muted);font-size:13px;margin-top:3px}
    .money{white-space:nowrap}
    .divider{height:1px;background:#efefef;margin:10px 0}

    .stateBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .stateBtns .btn{min-width:170px;justify-content:center} /* mismo ancho para todos */
    .payRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .payRow .btn{min-width:170px;justify-content:center}
    .highlightPending{box-shadow:0 0 0 3px rgba(255,193,7,.35)} /* resalta PENDIENTE */
    .err{color:#b00020;font-weight:600}
  </style>
</head>
<body>
  <!-- Guardia de acceso con TTL de 20 horas -->
  <script>
    (function guard(){
      const TTL_HOURS = 20;
      const qs = new URLSearchParams(location.search);
      if (qs.get('auth') === '1') {
        try{
          const now = Date.now();
          localStorage.setItem('rb_admin_ok','true');
          localStorage.setItem('rb_admin_t', String(now));
          localStorage.setItem('rb_auth_v2','ok');
          sessionStorage.setItem('rb_auth_v2','ok');
        }catch(e){}
        try{ history.replaceState(null,'',location.pathname); }catch(e){}
      }
      const ok   = (localStorage.getItem('rb_admin_ok')==='true') || (localStorage.getItem('rb_auth_v2')==='ok') || (sessionStorage.getItem('rb_auth_v2')==='ok');
      const ts   = Number(localStorage.getItem('rb_admin_t')||0);
      const live = (Date.now() - ts) < TTL_HOURS*60*60*1000;
      if (!(ok && live)) location.replace('login.html?reason=guard');
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Pedidos</a>
      <div class="spacer"></div>
      <button id="btnBell" class="btn" title="Activar/desactivar sonido">üîî Sonido</button>
      <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>
    <div class="tabs" id="tabs">
      <span class="chipf active" data-f="all">Todos</span>
      <span class="chipf" data-f="new">Nuevos</span>
      <span class="chipf" data-f="in_prep">En preparaci√≥n</span>
      <span class="chipf" data-f="ready">Listos</span>
      <span class="chipf" data-f="delivered">Entregados</span>
      <span class="chipf" data-f="cancelled">Cancelados</span>
    </div>
    <div id="orders"></div>
    <div id="ordersError" class="err" style="display:none;margin-top:8px"></div>
  </main>

  <!-- Libs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* ===================== FIREBASE ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}
    const db = firebase.firestore();

    /* ===================== HELPERS ===================== */
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const friesName = f => f==="con_sazon" ? "Con saz√≥n" : (f==="sin_sazon" ? "Sin sazonar" : "‚Äî");

    function unitWithExtras(it){
      const base = it.price || 0;
      const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0);
      const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
      return base + pz + ch;
    }
    function computeOrderTotal(o){
      if (typeof o.total === "number") return o.total;
      const items = Array.isArray(o.items) ? o.items : [];
      return items.reduce((t,it)=> t + (it.type==="burger" ? unitWithExtras(it) : (it.price||0)) * (it.qty||0), 0);
    }
    function pickDocDate(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){
        const v = obj[k];
        if (v?.toDate) return v.toDate();
        if (typeof v === 'number') return new Date(v);
        if (typeof v === 'string'){ const d=new Date(v); if(!isNaN(d)) return d; }
      }
      return null;
    }
    function displayOrderNumber(doc){
      const o = doc.data();
      const candidates = [
        o.orderNumber, o.number, o.numero, o.num, o.numPedido, o.nro,
        o.orderNo, o.seq, o.n, o.idPedido, o.pedidoNumber, o.pedido
      ];
      for (const c of candidates){
        if (c == null) continue;
        const n = (typeof c === "string") ? parseInt(c,10) : c;
        if (Number.isFinite(n)) return `#${n}`;
      }
      return `#${doc.id.slice(-5).toUpperCase()}`;
    }
    function payLabel(o){
      const method = (o.pago||o.payment_method||"‚Äî").replace("_"," ");
      const paid = (o.paid===true) || (o.payment_status==="paid") || (o.payment==="paid");
      return { text: `${method} ‚Äî ${paid ? "PAGADO" : "PENDIENTE"}`, paid };
    }

    /* ===================== AUDIO + SALIR ===================== */
    let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
    const btnBell = $("#btnBell");
    const updateBellUI = ()=> btnBell.classList.toggle("active", soundEnabled);
    updateBellUI();
    btnBell.onclick = ()=>{
      soundEnabled = !soundEnabled;
      localStorage.setItem("rb_bell_enabled", JSON.stringify(soundEnabled));
      updateBellUI();
    };
    $("#btnLogout").onclick = ()=>{
      localStorage.removeItem("rb_auth_v2");
      localStorage.removeItem("rb_admin_ok");
      sessionStorage.removeItem("rb_auth_v2");
      location.replace("login.html?reason=logout");
    };
    function playBeep(){
      if(!soundEnabled) return;
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = "square"; o.frequency.value = 1046; // m√°s fuerte/alto
        o.connect(g); g.connect(ctx.destination); o.start();
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.35, ctx.currentTime + 0.03);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
        o.stop(ctx.currentTime + 0.36);
      }catch(e){}
      // Notificaci√≥n del sistema solo en nuevos
      try{
        if (Notification && Notification.permission === "granted") {
          new Notification("Nuevo pedido recibido");
        }
      }catch(_){}
    }
    // Pide permiso 1 vez (opcional)
    try{ if (Notification && Notification.permission === "default") Notification.requestPermission(); }catch(_){}

    /* ===================== PRINT: datos del local + helpers ===================== */
    const STORE = {
      name: "Rhodes Burgers",
      address: "Av. San Mart√≠n 1620, Bel√©n de Escobar",
      phone: "11 7059 6483",
      instagram: "@rhodesburguers"
    };
    const peso = n => (Number(n)||0).toLocaleString("es-AR", { style:"currency", currency:"ARS", maximumFractionDigits:0 });
    const fdt  = d => new Date(d).toLocaleString("es-AR", { dateStyle:"short", timeStyle:"short" });

    async function printOrder(docId){
      try{
        const snap = await db.collection("orders").doc(docId).get();
        if (!snap.exists){ alert("No se encontr√≥ el pedido."); return; }
        const o = snap.data() || {};
        const html = buildTicketHTML(o, docId);
        openPrintWindow(html);
      }catch(e){
        console.error(e);
        alert("No se pudo imprimir el ticket.");
      }
    }
    function buildTicketHTML(o, docId){
      const orderNo = o.orderNumber ? `#${o.orderNumber}` : `ID ${String(docId).slice(-6).toUpperCase()}`;
      const when = o.createdAt?.toDate ? o.createdAt.toDate() : (o.createdAt ? new Date(o.createdAt) : new Date());
      const items = Array.isArray(o.items) ? o.items : [];

      let lines = "";
      items.forEach(it=>{
        const qty = it.qty||0;
        const name = it.name||"";
        const unit = it.type==="burger" ? unitWithExtras(it) : (it.price||0);
        const sub  = unit * qty;

        lines += `
          <div class="row">
            <div class="l">${qty}√ó ${name}</div>
            <div class="r">${peso(sub)}</div>
          </div>`;

        if (it.type==="burger"){
          const fx = [];
          if (it.fries) fx.push(`Papas: ${friesName(it.fries)}`);
          if (it.extras?.patty)   fx.push(`+${it.extras.patty} med`);
          if (it.extras?.cheddar) fx.push(`+${it.extras.cheddar} cheddar`);
          if (fx.length) lines += `<div class="sub"> ${fx.join(" ¬∑ ")} </div>`;
          if (it.notes)  lines += `<div class="sub"> Notas: ${it.notes} </div>`;
        }
      });

      const total = o.total || computeOrderTotal(o);
      const pL = payLabel(o);

      const css = `
        <style>
          @page { size: 80mm auto; margin: 4mm }
          *{ box-sizing:border-box }
          body{ font: 13px/1.35 "SFMono-Regular", ui-monospace, Menlo, Consolas, monospace; }
          .ctr{ text-align:center }
          .row{ display:flex; justify-content:space-between; }
          .sub{ color:#555; margin:2px 0 6px 0; }
          .sep{ border-top:1px dashed #000; margin:6px 0; }
          .big{ font-size:16px; font-weight:700 }
          .muted{ color:#555 }
          .mt8{ margin-top:8px }
        </style>`;

      const header = `
        <div class="ctr big">${STORE.name}</div>
        <div class="ctr">${STORE.address}</div>
        <div class="ctr">Tel: ${STORE.phone}</div>
        <div class="ctr">${STORE.instagram}</div>
        <div class="sep"></div>
        <div class="row"><div>Pedido</div><div>${orderNo}</div></div>
        <div class="row"><div>Fecha</div><div>${fdt(when)}</div></div>
        <div class="row"><div>Cliente</div><div>${o.nombre||"‚Äî"}</div></div>
        <div class="row"><div>Retiro</div><div>${(o.entrega||"take_away").replace("_"," ")}</div></div>
        <div class="row"><div>Pago</div><div>${pL.text}</div></div>
        <div class="sep"></div>`;

      const footer = `
        <div class="sep"></div>
        <div class="row big"><div>Total</div><div>${peso(total)}</div></div>
        <div class="mt8 ctr">¬°Gracias por su compra!</div>
        <div class="ctr muted">Mostr√° este ticket al retirar</div>`;

      return `<!doctype html><html><head><meta charset="utf-8">${css}</head><body>
        ${header}
        ${lines}
        ${footer}
      </body></html>`;
    }
    function openPrintWindow(html){
      const w = window.open("", "_blank", "width=400,height=600");
      if(!w){ alert("Permit√≠ ventanas emergentes para imprimir."); return; }
      w.document.open(); w.document.write(html); w.document.close();
      w.focus();
      w.onload = ()=> { try{ w.print(); }catch(_){ } setTimeout(()=>{ try{ w.close(); }catch(_){ } }, 250); };
    }

    /* ===================== LISTADO + ESTADOS ===================== */
    const tabs = $("#tabs"); const ordersHost = $("#orders");
    const ordersErr = $("#ordersError");
    let currentFilter="all", lastSnap=null, initialLoaded=false; const seenIds=new Set();

    tabs.addEventListener("click",(e)=>{
      const el=e.target.closest("[data-f]"); if(!el) return;
      currentFilter=el.dataset.f;
      tabs.querySelectorAll(".chipf").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      if(lastSnap) renderList(lastSnap);
    });

    const passFilter = (o)=>{
      if(currentFilter==="all") return true;
      if(currentFilter==="new") return (o.status??"accepted")==="accepted"||(o.status??"accepted")==="pending_payment";
      return (o.status??"")===currentFilter;
    };

    async function setOrderStatus(id,next){
      try{
        await db.collection("orders").doc(id).update({
          status: next,
          statusHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()})
        });
      }catch(e){ alert("No se pudo actualizar el estado: "+(e?.message||e)); }
    }
    async function setOrderPaid(id, paid){
      try{
        await db.collection("orders").doc(id).update({
          paid: !!paid,
          payment_status: paid ? "paid" : "pending",
          paidHistory: firebase.firestore.FieldValue.arrayUnion({paid:!!paid,at:new Date().toISOString()})
        });
      }catch(e){ alert("No se pudo actualizar el pago: "+(e?.message||e)); }
    }

    function renderOrder(doc){
      const o=doc.data(); const dt=pickDocDate(o);
      const dtText=dt? dt.toLocaleDateString('es-AR')+', '+dt.toLocaleTimeString('es-AR') : '‚Äî';
      const items = Array.isArray(o.items)?o.items:[];

      const lines = items.map(it=>{
        if(it.type==="burger"){
          const unit=unitWithExtras(it), sub=unit*(it.qty||0);
          const ex=[]; if(it.extras?.patty)ex.push(`+${it.extras.patty} med`); if(it.extras?.cheddar)ex.push(`+${it.extras.cheddar} cheddar`);
          const notes=it.notes?` ¬∑ Notas: ${it.notes}`:"";
          return `<div class="item"><div>‚Ä¢ <strong>${it.qty||0}√ó ${it.name}</strong></div>
          <div class="sub">Papas: ${friesName(it.fries)}${ex.length?` ¬∑ ${ex.join(" ¬∑ ")}`:""}${notes}
          <div>Unit: <span class="money">${money(unit)}</span> ‚Äî Subtotal: <span class="money">${money(sub)}</span></div></div></div>`;
        } else {
          const sub=(it.price||0)*(it.qty||0);
          return `<div class="item"><div>‚Ä¢ <strong>${it.qty||0}√ó ${it.name}</strong></div>
          <div class="sub">Unit: <span class="money">${money(it.price||0)}</span> ‚Äî Subtotal: <span class="money">${money(sub)}</span></div></div>`;
        }
      }).join("");

      const telChip=o.telefono?`<span class="chip">Tel: ${o.telefono}</span>`:"";
      const st=o.status??"accepted";
      const pL = payLabel(o);

      const stateBtns = `
        <div class="stateBtns">
          <button class="btn" data-act="in_prep">En preparaci√≥n</button>
          <button class="btn" data-act="ready">Listo para retirar</button>
          <button class="btn" data-act="delivered">Entregado</button>
          <button class="btn danger" data-act="cancelled">Cancelar</button>
          <button class="btn" data-act="print">Imprimir</button>
        </div>
        <div class="payRow">
          <button class="btn" data-pay="paid">Pago</button>
          <button class="btn warn" data-pay="pending" id="btnPending">Pendiente de pago</button>
        </div>`;

      const payBadgeClass = pL.paid ? "payBadge paid" : "payBadge pending";

      return `<div class="order ${st==='cancelled'?'cancelled':''}" data-id="${doc.id}">
        <div class="order-head">
          <div>
            <div class="order-title">${displayOrderNumber(doc)} ‚Äî ${o.nombre??'Cliente'}</div>
            <div class="muted">${dtText}</div>
            <div class="chips">
              <span class="chip">Estado: ${st}</span>
              <span class="chip">Retiro: ${o.entrega||'‚Äî'}</span>
              ${telChip}
              <span class="chip">Pago: ${(o.pago||'‚Äî')}</span>
            </div>
            ${stateBtns}
          </div>
          <div class="right-total">
            <div class="money" style="font-size:20px">${money(computeOrderTotal(o))}</div>
            <span class="${payBadgeClass} ${pL.paid?'':'highlightPending'}">${pL.text}</span>
          </div>
        </div>
        <div class="divider"></div>
        <div class="items">${lines || '<div class="muted">Sin √≠tems.</div>'}</div>
      </div>`;
    }

    function renderList(snap){
      const docs = snap.docs.filter(d=>passFilter(d.data()));
      ordersHost.innerHTML = docs.length
        ? docs.map(renderOrder).join("")
        : '<p class="muted">No hay pedidos.</p>';

      document.querySelectorAll(".order").forEach(card=>{
        const id=card.dataset.id;
        card.querySelectorAll("[data-act]").forEach(btn=>{
          btn.addEventListener("click",()=>{
            const act = btn.dataset.act;
            if (act === "print") printOrder(id);
            else setOrderStatus(id,act);
          });
        });
        card.querySelectorAll("[data-pay]").forEach(btn=>{
          btn.addEventListener("click",()=>{
            const mode = btn.dataset.pay;
            setOrderPaid(id, mode==="paid");
          });
        });
      });
    }

    // Suscripci√≥n: ordenar por fecha si existe; sino por id
    (async function subscribeOrders(){
      try{
        const probe = await db.collection("orders").limit(1).get();
        let dateField = null;
        if (!probe.empty) {
          const d = probe.docs[0].data();
          for (const k of ['createdAt','created_at','timestamp','date','fecha','time']){ if (d[k]!=null){ dateField = k; break; } }
        }
        let q = db.collection("orders");
        if (dateField) q = q.orderBy(dateField,'desc'); else q = q.orderBy(firebase.firestore.FieldPath.documentId());
        q.limit(120).onSnapshot(snap=>{
          ordersErr.style.display="none"; ordersErr.textContent="";
          // Sonar solo cuando entra un doc nuevo, ignorando la precarga
          if (initialLoaded){
            snap.docChanges().forEach(ch=>{ if (ch.type==='added' && !seenIds.has(ch.doc.id)){ playBeep(); seenIds.add(ch.doc.id); } });
          }else{
            snap.forEach(d=>seenIds.add(d.id));
            initialLoaded = true;
          }
          lastSnap=snap; renderList(snap);
        }, (err)=>{
          console.error(err);
          ordersErr.textContent="No se pudo cargar la lista de pedidos.";
          ordersErr.style.display="block";
        });
      }catch(err){
        console.error(err);
        ordersErr.textContent="No se pudo inicializar la lista de pedidos.";
        ordersErr.style.display="block";
      }
    })();

  });
  </script>
</body>
</html>
