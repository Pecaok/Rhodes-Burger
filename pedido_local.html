<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#625A45" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
   
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <style>
    :root{ --primary: #625A45; --primary-dark: #4a4434; --text: #1f2937; --muted: #6b7280; --bg: #f3f4f6; --card: #ffffff; --ring: #e5e7eb; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --font: 'Inter', sans-serif; --st-accepted: #fbbf24; --st-in_prep: #f97316; --st-ready: #06b6d4; --st-delivered: #22c55e; --st-cancelled: #ef4444; --pay-paid: #15803d; --pay-pending: #ea580c; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font); -webkit-tap-highlight-color: transparent;}
    #pageLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 99999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s; }
    #pageLoader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    #pageLoader video { width: 250px; max-width: 80%; height: auto; object-fit: contain; mix-blend-mode: screen; }
    header { position: sticky; top: 0; z-index: 1000; background: #fff; border-bottom: 1px solid var(--ring); }
    .topbar { max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 12px; display: flex; align-items: center; gap: 6px; overflow: visible; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; text-decoration: none; margin-right: 5px; flex-shrink: 0; }
    .brand img { width: 32px; height: 32px; border-radius: 6px; margin-right: 8px; }
    .spacer { flex: 1; }
    .nav-btn { padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #4b5563; font-weight: 600; font-size: 14px; transition: all 0.2s; border: 1px solid transparent; flex-shrink: 0; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; background: transparent; }
    .nav-btn:hover { background: #f9fafb; }
    .nav-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 5px rgba(98, 90, 69, 0.3); }
    .icon-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--ring); background: #fff; cursor: pointer; font-size: 16px; flex-shrink: 0; transition: all 0.2s; }
    .icon-btn:hover { background: #f0f0f0; }
    .icon-btn.active { box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
    .icon-btn#btnBell.active { background: #e0f2fe; border-color: #0284c7; color: #0284c7; }
    .icon-btn#btnAutoPrint.active { background: #dcfce7; border-color: #16a34a; color: #15803d; }
    .btn-danger { color: #d32f2f; background: #ffebee; border: 1px solid #ffcdd2; }
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 160px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-radius: 12px; border: 1px solid var(--ring); z-index: 2000; top: 115%; right: 0; padding: 5px; }
    .dropdown.show .dropdown-content { display: block; animation: slideDown 0.2s ease; }
    .dropdown-content a { display: block; padding: 10px; text-decoration: none; color: #374151; font-size: 14px; font-weight: 500; border-radius: 8px; }
    .dropdown-content a:hover { background: #f3f4f6; color: var(--primary); }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .container { max-width: 800px; margin: 20px auto; padding: 0 16px; padding-bottom: 80px; }
    h1 { font-size: 24px; font-weight: 800; color: #111; margin-bottom: 16px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
    .tab { padding: 8px 16px; border-radius: 99px; background: #fff; border: 1px solid var(--ring); color: #6b7280; font-weight: 600; font-size: 13px; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
    .tab.active { background: #1f2937; color: #fff; border-color: #1f2937; }
    .order { background: #fff; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 20px; overflow: hidden; border: 1px solid var(--ring); animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .order-head { padding: 16px; border-bottom: 1px dashed var(--ring); display: flex; justify-content: space-between; align-items: flex-start; }
    .order-title { font-size: 18px; font-weight: 800; color: #111; line-height: 1.2; }
    .order-meta { font-size: 13px; color: var(--muted); margin-top: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .chip { padding: 2px 8px; border-radius: 6px; background: #f3f4f6; font-weight: 600; font-size: 11px; color: #374151; }
    .chip.mostrador { background: #e0f2fe; color: #0369a1; }
    .chip.time { background: #fef3c7; color: #92400e; }
    .chip.pedidosya { background: #fce7f3; color: #be185d; }
    .chip.rappi { background: #ffedd5; color: #c2410c; }
    .price-tag { font-size: 20px; font-weight: 900; color: var(--primary); white-space: nowrap; }
    .items { padding: 16px; background: #fafafa; }
    .cat-group { margin-bottom: 12px; }
    .cat-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; gap: 4px; }
    .it-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-start; }
    .it-qty { background: #fff; border: 1px solid var(--ring); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 700; font-size: 13px; color: #111; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; }
    .it-det { flex: 1; }
    .it-name { font-weight: 600; font-size: 15px; color: #374151; line-height: 1.3; }
    .it-sub { font-size: 13px; color: #6b7280; display: block; margin-top: 2px; }
    .it-price { font-weight: 700; font-size: 14px; color: var(--primary); margin-left: auto; white-space: nowrap; }
    .it-note { font-size: 12px; color: #ef4444; font-weight: 600; background: #fef2f2; display: inline-block; padding: 2px 6px; border-radius: 4px; margin-top: 2px; }
    .actions-area { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .stateBtns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .state-btn { padding: 10px 4px; border: 1px solid var(--ring); background: #fff; color: #6b7280; border-radius: 10px; font-weight: 600; font-size: 11px; cursor: pointer; text-align: center; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
    .state-btn:active { transform: scale(0.96); }
    .state-btn.on.state-accepted { background: var(--st-accepted); color: #000; border-color: var(--st-accepted); box-shadow: 0 4px 10px rgba(251, 191, 36, 0.3); }
    .state-btn.on.state-in_prep { background: var(--st-in_prep); color: #fff; border-color: var(--st-in_prep); box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3); }
    .state-btn.on.state-ready { background: var(--st-ready); color: #fff; border-color: var(--st-ready); box-shadow: 0 4px 10px rgba(6, 182, 212, 0.3); }
    .state-btn.on.state-delivered { background: var(--st-delivered); color: #fff; border-color: var(--st-delivered); box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
    .state-btn.cancelled { grid-column: span 4; border-color: #fee2e2; color: #ef4444; margin-top: 5px; }
    .control-row { display: flex; gap: 8px; margin-bottom: 8px; }
    .pay-select, .source-select { padding: 10px; border-radius: 10px; border: 1px solid var(--ring); font-size: 13px; background: #fff; -webkit-appearance: none; font-weight: 600; flex: 1; }
    .pay-btn { padding: 0 16px; border-radius: 10px; border: none; font-weight: 700; font-size: 13px; color: #fff; display: flex; align-items: center; gap: 6px; cursor: pointer; flex: 1; justify-content: center; }
    .pay-btn.pending { background: var(--pay-pending); }
    .pay-btn.paid { background: var(--pay-paid); }
    .icon-btn-lg { width: 42px; height: 42px; border-radius: 10px; border: 1px solid var(--ring); background: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; flex-shrink: 0; }
    @media (max-width: 768px) {
        .brand span { display: none; }
        .nav-btn { padding: 8px; font-size: 12px; }
        .nav-btn span { display: none; }
        .dropdown { position: static; }
        .order-head { flex-direction: column; gap: 10px; }
        .price-tag { align-self: flex-end; margin-top: -30px; }
        .stateBtns { grid-template-columns: 1fr 1fr; }
        .control-row { flex-wrap: wrap; }
        .pay-select, .source-select { min-width: 48%; }
    }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try{ firebase.initializeApp(firebaseConfig); }catch(e){ console.error("Error Firebase:", e); }
    const db = firebase.firestore();
    window.idToDoc = new Map();

    const TTL_MS = 20 * 60 * 60 * 1000;
    function checkSession(){
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      if(!ok || (Date.now()-ts > TTL_MS)) location.replace('login.html');
      else localStorage.setItem('rb_admin_t', String(Date.now()));
    }
    checkSession(); setInterval(checkSession, 5*60*1000);

    // DATOS EN MEMORIA
    let RECETAS_DB = {}; 
    let SUB_RECIPES_DB = {}; 
    let INVENTARIO_DB = {}; 
    let ID_TO_COLLECTION = {}; 
    let STOCK_NAME_TO_ID = {}; // Bolsa Global
    let PRODUCT_CATALOG = {}; 
    let PRICES_DB = { patty: 2500, cheddar: 300 }; 

    function normalize(str) {
        return String(str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }

    // CARGAS
    db.collection('products').onSnapshot(snap => {
        PRODUCT_CATALOG = {};
        snap.forEach(doc => { 
            const d = doc.data();
            const cat = normalize(d.category);
            const name = normalize(d.name);
            PRODUCT_CATALOG[doc.id] = cat;
            if(name) PRODUCT_CATALOG[name] = cat;
        });
        if(window.lastSnap) renderList(window.lastSnap); 
    });

    db.collection('recipes').onSnapshot(snap => {
        RECETAS_DB = {};
        snap.forEach(doc => { RECETAS_DB[doc.id] = doc.data().ingredients; });
    });

    db.collection('subrecipes').onSnapshot(snap => {
        snap.forEach(doc => {
            const d = doc.data();
            SUB_RECIPES_DB[doc.id] = d;
            ID_TO_COLLECTION[doc.id] = 'subrecipes'; 
            if(d.name) STOCK_NAME_TO_ID[normalize(d.name)] = doc.id;
        });
    });

    db.collection('inventory').onSnapshot(snap => {
        snap.forEach(doc => { 
            const d = doc.data();
            INVENTARIO_DB[normalize(d.name)] = doc.id; 
            ID_TO_COLLECTION[doc.id] = 'inventory'; 
            if(d.name) STOCK_NAME_TO_ID[normalize(d.name)] = doc.id;
        });
    });
    
    db.collection('config').doc('prices').onSnapshot(doc => {
        if(doc.exists) { PRICES_DB = doc.data(); if(window.lastSnap) renderList(window.lastSnap); }
    });

    // BUSQUEDA INTELIGENTE
    function findSmartId(keywords) {
        for (const key of keywords) {
            const norm = normalize(key);
            if (STOCK_NAME_TO_ID[norm]) return STOCK_NAME_TO_ID[norm];
        }
        const allNormNames = Object.keys(STOCK_NAME_TO_ID);
        for (const dbName of allNormNames) {
            for (const key of keywords) {
                const normKey = normalize(key);
                if (dbName.includes(normKey) || normKey.includes(dbName)) return STOCK_NAME_TO_ID[dbName];
            }
        }
        return null;
    }

    // =================================================================
    // üî• GESTI√ìN DE STOCK (CORREGIDA: DETECCI√ìN POR √çTEM INDIVIDUAL)
    // =================================================================
    async function gestionarStock(pedido, factor) {
        if (!pedido.items) return;
        if(factor === -1 && pedido.stockDescontado) return; 
        if(factor === 1 && !pedido.stockDescontado) return; 

        const batch = db.batch();
        let huboCambios = false;
        let logs = []; 

        let itemsCalc = Array.isArray(pedido.items) ? [...pedido.items] : [];
        if(Array.isArray(pedido.bebidas)) itemsCalc = itemsCalc.concat(pedido.bebidas);
        if(Array.isArray(pedido.drinks)) itemsCalc = itemsCalc.concat(pedido.drinks);

        let totalBurgers = 0;
        let doritosCount = 0; 
        let portionsCount = 0; 
        let saltCount = 0;

        const applyDecrement = (targetID, amount, logName) => {
            if(!targetID) return false;
            let collectionName = ID_TO_COLLECTION[targetID] || 'inventory'; 
            const ref = db.collection(collectionName).doc(targetID);
            batch.update(ref, { qty: firebase.firestore.FieldValue.increment(amount * factor) });
            huboCambios = true;
            logs.push(`   - ${logName || 'Item'}: ${amount} (en ${collectionName})`);
            return true;
        };

        itemsCalc.forEach(item => {
            const rawName = item.name || "Item sin nombre";
            const nameNorm = normalize(rawName);
            const notesNorm = normalize(item.notes||"");
            const qty = Math.ceil(Number(item.qty || 1));
            
            // Detectamos la opci√≥n de este √≠tem (fries o guarnicion)
            let friesOpt = String(item.fries || "").toLowerCase().trim();
            if(!friesOpt && item.extras?.fries) friesOpt = String(item.extras.fries).toLowerCase().trim();
            if(!friesOpt && item.guarnicion) friesOpt = String(item.guarnicion).toLowerCase().trim();

            logs.push(`üì¶ ${rawName} (x${qty}) [Op: ${friesOpt || 'def'}]`);

            // 1. Detectar Burger
            if(nameNorm.includes('hamb')||nameNorm.includes('burger')||nameNorm.includes('doble')||nameNorm.includes('simple')) {
                totalBurgers += qty;
            }

            // 2. Detectar Porci√≥n
            if(nameNorm.includes("porcion") && (nameNorm.includes("papa") || nameNorm.includes("frita"))) {
                portionsCount += qty;
            }

            // --- L√ìGICA DE CONDIMENTOS POR √çTEM ---
            const esPapa = nameNorm.includes("papa") || nameNorm.includes("frita") || nameNorm.includes("bastones") || totalBurgers > 0;

            if (esPapa) {
                if (friesOpt.includes('sazon') || nameNorm.includes("sazon") || notesNorm.includes("sazon")) {
                    doritosCount += qty;
                } 
                else if (friesOpt === 'sin_sal' || nameNorm.includes("sin sal") || notesNorm.includes("sin sal")) {
                    // No hace nada (Sin sal)
                }
                else {
                    saltCount += qty; // Por defecto o 'con_sal'
                }
            }

            // 3. RECETAS
            let recipeName = Object.keys(RECETAS_DB).find(k => normalize(k) === nameNorm);
            if (!recipeName) recipeName = Object.keys(RECETAS_DB).find(k => nameNorm.includes(normalize(k)));

            let recipeFound = false;
            if (recipeName) {
                const ingredientes = RECETAS_DB[recipeName];
                recipeFound = true;
                ingredientes.forEach(ing => {
                    let targetID = ing.id;
                    let targetQty = Number(ing.qty);
                    if (!targetID && ing.ingrediente) {
                        targetID = findSmartId([ing.ingrediente]);
                        targetQty = Number(ing.cantidad);
                    }
                    if (targetID) applyDecrement(targetID, targetQty * qty, "Receta");
                });
            } 

            // 4. FALLBACK CARNE
            if (!recipeFound && (nameNorm.includes('hamb')||nameNorm.includes('burger'))) {
                let patties = nameNorm.includes('doble') ? 2 : (nameNorm.includes('triple') ? 3 : 1);
                const pattyId = findSmartId(['medallon', 'carne', 'patty']);
                if(pattyId) applyDecrement(pattyId, patties * qty, `Auto-Patty (${patties})`);
            }

            // 5. EXTRAS
            if(item.extras){
                for (const [key, valRaw] of Object.entries(item.extras)) {
                    const val = Number(valRaw);
                    if (val > 0) {
                        const search = key === 'patty' ? 'medallon' : (key === 'bacon' ? 'panceta' : key);
                        const ingID = findSmartId([search]);
                        if(ingID) applyDecrement(ingID, (key==='bacon' ? 0.03 : 1) * val * qty, `Extra ${key}`);
                    }
                }
            }
        });

        // --- AUTOM√ÅTICOS GLOBALES ---
        const autoDesc = (keys, qtyToDeduct, name) => {
            const id = findSmartId(keys);
            if(id) applyDecrement(id, qtyToDeduct, name);
        };

        if(totalBurgers > 0) {
            autoDesc(['papas fritas', 'bastones'], totalBurgers * 200, "Papas (200g)");
            autoDesc(['carton', 'caja'], Math.ceil(totalBurgers), "Caja Papa");
            autoDesc(['papel', 'parafinado'], Math.ceil(totalBurgers), "Papel");
            const bolsas = Math.ceil(totalBurgers / 2);
            autoDesc(['bolsa', 'kraft'], bolsas, "Bolsas");
        }

        if(portionsCount > 0) {
            autoDesc(['papas fritas', 'bastones'], portionsCount * 350, "Papas Porci√≥n (350g)");
        }

        if(saltCount > 0) autoDesc(['sal', 'sal fina'], saltCount * 2, `Sal (${saltCount*2}g)`);
        if(doritosCount > 0) autoDesc(['sazonador doritos', 'dorito'], doritosCount * 5, `Sazonador (${doritosCount*5}g)`);

        if (huboCambios) {
            const pedidoRef = db.collection('orders').doc(pedido.id);
            batch.update(pedidoRef, { stockDescontado: (factor === -1) });
            await batch.commit();
            alert("‚úÖ STOCK ACTUALIZADO\n\n" + logs.join("\n"));
        } else {
            alert("‚ö†Ô∏è NO SE DESCONT√ì NADA");
        }
    }

    // GLOBALES
    window.logout = () => { localStorage.removeItem('rb_admin_ok'); location.replace('login.html'); };

    window.setOrderStatus = async (id, next, isPaid) => {
        if(next==='delivered' && !isPaid){ alert("‚ö†Ô∏è COBRAR PRIMERO: El pedido figura pendiente."); return; }
        try{ 
            const docSnap = await db.collection('orders').doc(id).get();
            if(!docSnap.exists) return;
            const pedidoData = { id: docSnap.id, ...docSnap.data() };
            if(next === 'delivered'){ await gestionarStock(pedidoData, -1); } 
            else if(next === 'cancelled'){ await gestionarStock(pedidoData, 1); }
            await db.collection("orders").doc(id).update({status:next}); 
        }catch(e){ alert("Error: " + e.message); }
    };

    window.deleteOrder = async (id) => {
        if(!confirm("‚ö†Ô∏è ¬øEliminar permanentemente?")) return;
        try { await db.collection("orders").doc(id).delete(); } catch(e) { alert("Error: " + e.message); }
    };

    window.setPaymentStatus = async (id, currentPaid, currentMethod) => {
        if(!currentPaid && (!currentMethod || currentMethod === "")){ 
            alert("‚ö†Ô∏è Seleccion√° M√âTODO DE PAGO."); return; 
        }
        try{ await db.collection("orders").doc(id).update({ paid: !currentPaid, payment_status: !currentPaid ? 'paid' : 'pending_payment' }); }catch(e){}
    };
    
    window.updatePago = async (id, val) => { 
        try { 
            const updateData = { pago: val };
            if (val && val !== "") { updateData.paid = true; updateData.payment_status = 'paid'; }
            await db.collection("orders").doc(id).update(updateData); 
        } catch(e) { console.error(e); } 
    };

    window.updateSource = async (id, val) => { 
        try { await db.collection("orders").doc(id).update({ source: val }); } catch(e) {} 
    };

    window.printOrder = (id) => { const doc = window.idToDoc.get(id); if(doc) window.trySilentPrint(doc); };
    
    window.pickDate = (o) => { 
        if(!o) return new Date();
        if(o.createdAt?.toDate) return o.createdAt.toDate(); 
        if(typeof o.createdAt==='string') return new Date(o.createdAt); 
        return new Date(); 
    };
    
    window.cleanFries = (raw) => { 
        if(!raw) return ""; 
        const s = String(raw).toLowerCase().replace(/[_-]/g,' ').trim(); 
        if(s.includes('sazon')) return "Sazonadas"; 
        if(s.includes('sin sal')) return "Sin sal"; 
        if(s.includes('con sal')||s.includes('sal')) return "Con Sal"; 
        return s.charAt(0).toUpperCase() + s.slice(1); 
    };
    
    window.getCat = (item) => {
        const n = String(item.name || "").trim().toLowerCase();
        const t = String(item.type || "").toLowerCase();
        if (t === 'drink' || t === 'bebida') return 'd';
        if (t === 'side' || t === 'guarnicion' || t === 'papa') return 'f';
        if (t === 'burger' || t === 'hamburguesa') return 'b';
        if (n.includes('coca') || n.includes('agua') || n.includes('cerveza')) return 'd';
        if (n.includes('papas') || n.includes('fritas')) return 'f';
        return 'b'; 
    };

    function consolidateItems(list) {
        const map = new Map();
        list.forEach(it => {
            let exKey = "";
            if(it.extras) exKey = Object.keys(it.extras).sort().map(k => `${k}:${it.extras[k]}`).join("-");
            const key = `${it.name}_${exKey}_${(it.notes||'').toLowerCase().trim()}`;
            if(map.has(key)){ map.get(key).qty += (Number(it.qty)||1); } 
            else { map.set(key, { ...it, qty: (Number(it.qty)||1) }); }
        });
        return Array.from(map.values());
    }

    function getCleanTime(o, defaultTime) {
        if (o.pickup_slot && o.pickup_slot.includes(':')) return o.pickup_slot;
        return defaultTime;
    }

    async function importarPedidosYa() {
        const input = document.getElementById('excelInput');
        if (!input.files.length) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {range: 1, defval:""});
            const batch = db.batch();
            for (const row of rows) {
                const r = {}; Object.keys(row).forEach(k => r[k.toLowerCase().trim()] = row[k]);
                if (!r['nro de pedido']) continue;
                const ref = db.collection('orders').doc();
                batch.set(ref, { orderNumber: String(r['nro de pedido']), source: 'pedidosya', status: 'delivered', paid: true, nombre: r['nombre del cliente'] || 'Cli', total: Number(r['total del pedido']) || 0, createdAt: new Date().toISOString(), items: [] });
            }
            await batch.commit(); alert("Importado"); location.reload();
        };
        reader.readAsArrayBuffer(input.files[0]);
    }
  </script>
</head>

<body>
  <div id="pageLoader">
    <video autoplay loop muted playsinline><source src="images/loader.mp4" type="video/mp4"></video>
  </div>

  <input type="file" id="excelInput" style="display:none" accept=".xlsx, .xls" onchange="importarPedidosYa()">

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt=""><span>Pedidos</span></a>
      <div class="spacer"></div>
      <button onclick="document.getElementById('excelInput').click()" class="nav-btn" style="background:#f97316; color:white;">üì• Importar</button>
      <a href="pedido_local.html" class="nav-btn active">üì¶ Pedidos</a>
      <a href="finanzas.html" class="nav-btn">üìà Finanzas</a>
      <a href="mostrador.html" class="nav-btn">üßæ Mostrador</a>
      <button id="btnBell" class="icon-btn">üîî</button>
      <button id="btnAutoPrint" class="icon-btn">üñ®Ô∏è</button>
      <button onclick="window.logout()" class="nav-btn btn-danger">Salir</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>
    <div class="tabs" id="tabs">
      <button class="tab active" data-f="recibidos">Cocina</button>
      <button class="tab" data-f="entregados">Entregados</button>
      <button class="tab" data-f="cancelled">Cancelados</button>
      <button class="tab" data-f="all">Todos</button>
    </div>
    <div id="orders"></div>
  </main>

 <script>
  window.addEventListener('DOMContentLoaded', () => {
    // AUDIO
    let audioCtx = null;
    const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };
    const playBeep = () => { if(!JSON.parse(localStorage.getItem("rb_sound")||"true")) return; initAudio(); const osc = audioCtx.createOscillator(); osc.type='square'; osc.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+0.15); };

    db.collection("orders").orderBy("orderNumber", "desc").limit(100).onSnapshot(snap => {
        window.lastSnap = snap;
        const cont = document.getElementById("orders");
        cont.innerHTML = snap.docs.map(doc => buildOrderHTML(doc)).join("");
        document.getElementById('pageLoader').classList.add("hidden");
    });

    function buildOrderHTML(doc){
        const o = doc.data();
        const items = (o.items||[]).concat(o.bebidas||[]).concat(o.drinks||[]);
        return `
        <div class="order">
           <div class="order-head">
              <div class="order-title">#${o.orderNumber} - ${o.nombre}</div>
              <div class="price-tag">$${o.total}</div>
           </div>
           <div class="items">
              ${items.map(it => `
                <div class="it-row">
                   <div class="it-qty">${it.qty}</div>
                   <div class="it-det"><div class="it-name">${it.name} ${it.fries ? `<small>(${window.cleanFries(it.fries)})</small>`:''}</div></div>
                </div>`).join("")}
           </div>
           <div class="actions-area">
              <div class="control-row">
                 <button class="pay-btn ${o.paid?'paid':'pending'}" onclick="setPaymentStatus('${doc.id}', ${!!o.paid}, '${o.pago||''}')">${o.paid?'PAGADO':'COBRAR'}</button>
                 <div class="icon-btn-lg" onclick="printOrder('${doc.id}')">üñ®Ô∏è</div>
              </div>
              <div class="stateBtns">
                 <button class="state-btn ${o.status==='in_prep'?'on':''}" onclick="setOrderStatus('${doc.id}','in_prep',${!!o.paid})">Cocina</button>
                 <button class="state-btn ${o.status==='ready'?'on':''}" onclick="setOrderStatus('${doc.id}','ready',${!!o.paid})">Listo</button>
                 <button class="state-btn ${o.status==='delivered'?'on':''}" onclick="setOrderStatus('${doc.id}','delivered',${!!o.paid})">Entregado</button>
              </div>
           </div>
        </div>`;
    }

    // IMPRESI√ìN SILENCIOSA
    window.trySilentPrint = (docSnap) => {
        const o = docSnap.data();
        const html = `<html><body onload="window.print()">Rhodes - #${o.orderNumber} - ${o.nombre}</body></html>`;
        const f = document.createElement('iframe'); f.style.display='none'; document.body.append(f);
        f.contentWindow.document.write(html); f.contentWindow.document.close();
        setTimeout(()=>f.remove(), 5000);
    };
  });
 </script>
</body>
</html>
