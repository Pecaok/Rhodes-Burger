<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Panel de pedidos</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    body::before{ content:""; position:fixed; inset:0; background:url("images/logo.png") center 120px/320px no-repeat; opacity:.06; pointer-events:none; z-index:0; filter:grayscale(100%) }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1000px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain; display:block }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }

    .container{ max-width:1000px; margin:24px auto; padding:0 12px }
    h1{ font-size:28px; margin:14px 4px 18px; display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .controls{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px }
    select, input[type="search"]{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px; font:inherit }
    .stats{ display:flex; gap:12px; flex-wrap:wrap; margin:10px 0 16px }
    .stat{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:12px 16px; min-width:180px }
    .stat .k{ font-size:12px; color:var(--muted) }
    .stat .v{ font-size:20px; font-weight:800 }

    .list{ display:flex; flex-direction:column; gap:10px }
    .order{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px }
    .orderHead{ display:flex; align-items:center; justify-content:space-between; gap:10px }
    .muted{ color:var(--muted) }
    .items{ margin:8px 0 0 0; padding-left:18px }
    .pill{ display:inline-block; background:#f0f0f0; padding:2px 8px; border-radius:999px; font-size:12px; color:#444; border:1px solid #e5e5e5 }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand" aria-label="Volver al menÃº">
        <img src="/images/logo.png" alt="Rhodes Burgers"
             onerror="this.onerror=null;this.src='images/logo.png'; if(this.naturalWidth===0){ this.src='/logo.png'; }">
      </a>
      <div class="spacer"></div>
      <button id="btnSound" class="btn ghost">ðŸ”” Activar sonido</button>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Panel de pedidos</h1>

      <div class="controls">
        <label>
          <span class="muted" style="font-size:12px">Mes:</span><br>
          <select id="selMes"></select>
        </label>
        <label>
          <span class="muted" style="font-size:12px">AÃ±o:</span><br>
          <select id="selAnio"></select>
        </label>
        <label style="flex:1; min-width:240px">
          <span class="muted" style="font-size:12px">Buscar (nombre, nÃºmero, comentarios):</span><br>
          <input id="inpSearch" type="search" placeholder="Buscarâ€¦" />
        </label>
      </div>

      <div class="stats">
        <div class="stat"><div class="k">Pedidos (mes)</div><div class="v" id="stPedidos">0</div></div>
        <div class="stat"><div class="k">Ingresos (mes)</div><div class="v" id="stIngresos">$0</div></div>
      </div>

      <div id="ordersList" class="list"></div>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /*************** FIREBASE (tus credenciales) ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /*************** UTIL ***************/
    const $ = s => document.querySelector(s);
    const money = n => (n||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];

    // Sonido (necesita interacciÃ³n del usuario)
    let allowSound = localStorage.getItem("rb_sound_enabled")==="1";
    const btnSound = $("#btnSound");
    function beep(){
      if(!allowSound) return;
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type="sine"; o.frequency.value=880; o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.35);
        o.start(); o.stop(ctx.currentTime+0.4);
      }catch(e){}
    }
    function renderSoundBtn(){ btnSound.textContent = allowSound ? "ðŸ”• Desactivar sonido" : "ðŸ”” Activar sonido"; }
    btnSound.onclick = ()=>{ allowSound = !allowSound; localStorage.setItem("rb_sound_enabled", allowSound?"1":"0"); renderSoundBtn(); if(allowSound) beep(); };
    renderSoundBtn();

    /*************** CONTROLES ***************/
    const selMes=$("#selMes"), selAnio=$("#selAnio"), inpSearch=$("#inpSearch");
    const list=$("#ordersList"), stPedidos=$("#stPedidos"), stIngresos=$("#stIngresos");

    // Mes / AÃ±o actuales
    const now = new Date();
    months.forEach((m,i)=>{ const o=document.createElement("option"); o.value=i; o.textContent=m; if(i===now.getMonth()) o.selected=true; selMes.appendChild(o); });
    for(let y=now.getFullYear()-2; y<=now.getFullYear()+1; y++){ const o=document.createElement("option"); o.value=y; o.textContent=y; if(y===now.getFullYear()) o.selected=true; selAnio.appendChild(o); }

    let unsubscribe=null;
    selMes.onchange = selAnio.onchange = ()=> attachListener();
    inpSearch.oninput = ()=> render();

    // Estado en memoria
    let docs = [];      // todos los docs del snapshot actual del mes
    let firstLoad = true;

    function monthRange(y, m){ // m: 0-11
      const start = new Date(y, m, 1, 0,0,0,0);
      const end   = new Date(y, m+1, 1, 0,0,0,0);
      return {start, end};
    }

    function attachListener(){
      if(unsubscribe) unsubscribe();

      firstLoad = true;
      docs = [];
      list.innerHTML = `<div class="order"><span class="muted">Cargando pedidos...</span></div>`;

      const y = +selAnio.value, m = +selMes.value;
      const {start, end} = monthRange(y, m);

      // Query por rango de mes
      unsubscribe = db.collection("orders")
        .where("createdAt", ">=", firebase.firestore.Timestamp.fromDate(start))
        .where("createdAt", "<",  firebase.firestore.Timestamp.fromDate(end))
        .orderBy("createdAt","desc")
        .onSnapshot((snap)=>{
          // Al primer snapshot no son "nuevos" (no sonar)
          const isInitial = firstLoad; firstLoad=false;

          docs = snap.docs.map(d=>({ id:d.id, ...d.data() }));
          render();

          if(!isInitial){
            // Detectar "added" para sonido
            snap.docChanges().forEach(ch=>{
              if(ch.type==="added"){
                // Evitar sonar si el timestamp es viejo o aÃºn null
                const t = ch.doc.data().createdAt?.toDate?.() || new Date();
                const ageMs = Date.now() - t.getTime();
                if(ageMs < 15000) beep();
              }
            });
          }
        }, (err)=>{
          console.error(err);
          list.innerHTML = `<div class="order"><span class="muted">No se pudieron cargar pedidos. RevisÃ¡ Firestore.</span></div>`;
        });
    }

    function render(){
      const q = (inpSearch.value||"").toLowerCase().trim();
      let total = 0, cant = 0;

      const rows = [];
      for(const o of docs){
        // filtro por bÃºsqueda
        const hay = [
          String(o.orderNumber||""), String(o.nombre||""),
          String(o.direccion||""), String(o.comments||"")
        ].join(" ").toLowerCase();
        if(q && !hay.includes(q)) continue;

        cant++;
        total += Number(o.total||0);

        const dt = o.createdAt?.toDate?.();
        const fecha = dt ? dt.toLocaleString("es-AR",{dateStyle:"short", timeStyle:"short"}) : "â€”";
        const friesTxt = o.fries==="con_sazon" ? "Con sazÃ³n" : (o.fries==="sin_sazon"?"Sin sazonar":"â€”");
        const pagoTxt = o.pago==="mercado_pago" ? "Mercado Pago" : (o.pago==="efectivo"?"Efectivo":"â€”");
        const orderNum = o.orderNumber ? `#${o.orderNumber}` : `#${o.id}`;

        const items = (o.items||[]).map(i=>`<li>â€¢ ${i.qty}Ã— ${i.name}</li>`).join("");

        rows.push(`
          <div class="order">
            <div class="orderHead">
              <div><strong>${orderNum}</strong> â€” <span class="muted">${o.nombre||"â€”"}</span></div>
              <div style="font-weight:800">${money(o.total||0)}</div>
            </div>
            <div class="muted" style="margin-top:4px">${fecha}</div>
            <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
              <span class="pill">Retiro: Take Away</span>
              <span class="pill">Papas: ${friesTxt}</span>
              <span class="pill">Pago: ${pagoTxt}</span>
            </div>
            ${o.comments?`<div style="margin-top:6px"><strong>Comentarios:</strong> <span class="muted">${o.comments}</span></div>`:""}
            <ul class="items">${items}</ul>
          </div>
        `);
      }

      list.innerHTML = rows.join("") || `<div class="order"><span class="muted">No hay pedidos para mostrar.</span></div>`;
      stPedidos.textContent = cant;
      stIngresos.textContent = money(total);
    }

    // Arranque
    attachListener();
  </script>
</body>
</html>
