<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:22px; --shadow:0 12px 34px rgba(0,0,0,.10); --ring:#eaeaea;

      /* Tipograf√≠a (no se toca) */
      --font: Inter, system-ui, "Segoe UI", Roboto, Arial, "Helvetica Neue", "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", sans-serif;

      /* Estados */
      --st-accepted:#FBC02D; --st-in_prep:#FB8C00; --st-ready:#00ACC1;
      --st-delivered:#2E7D32; --st-cancelled:#D32F2F;
      --pay-pending:#FFA000; --pay-paid:#2ECC71;

      /* (s√≥lo para impresi√≥n de ESTA p√°gina, no del ticket) */
      --page-size:58mm;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:var(--font);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .chipf{background:#f3f3f3;border:1px solid var(--ring);color:#333;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chipf.active{background:#2ecc71;color:#fff;border-color:#2ecc71}

    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#f3f3f3;border:1px solid var(--ring);color:#333;border-radius:999px;padding:6px 10px;font-size:13px}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap}

    .items{margin-top:10px}
    .item{margin:8px 0 6px 0}
    .item .sub{color:var(--muted);font-size:13px;margin-top:3px}
    .money{white-space:nowrap}
    .divider{height:1px;background:#efefef;margin:10px 0}
    .err{color:#b00020;font-weight:600}

    .stateBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .state-btn{border:2px solid #dcdcdc;background:#fff;color:#333;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;min-width:160px;text-align:center}
    .state-btn.on{color:#fff;border-color:var(--primary);background:var(--primary)}
    .state-accepted.on{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .state-in_prep.on{background:var(--st-in_prep);border-color:var(--st-in_prep);color:#fff}
    .state-ready.on{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .state-delivered.on{background:var(--st-delivered);border-color:var(--st-delivered);color:#fff}
    .state-cancelled.on{background:var(--st-cancelled);border-color:var(--st-cancelled);color:#fff}

    .pay-line{margin-top:6px}
    .pay-pill{display:inline-block;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
    .pay-paid{background:var(--pay-paid);color:#fff}
    .pay-pending{background:var(--pay-pending);color:#fff}

    .order.cancelled{opacity:.7}
    .order.cancelled .order-title{text-decoration:line-through}

    /* Si imprimen la LISTA en esta p√°gina */
    @media print{
      @page{ size: A4 portrait; margin: 12mm; }
      header,.tabs,.stateBtns,.pay-line .btn,.danger,#btnBell,[title="Ver finanzas"]{display:none !important}
      .order{break-inside:avoid;box-shadow:none;border:1px solid #eee}
    }
  </style>
</head>
<body>
  <!-- Guardia (TTL 20h) con ?auth=1) -->
  <script>
    (function guard(){
      const TTL_MS = 20*60*60*1000;
      const qs = new URLSearchParams(location.search);
      if (qs.get('auth') === '1') {
        try{
          localStorage.setItem('rb_auth_v2','ok');
          localStorage.setItem('rb_admin_ok','true');
          localStorage.setItem('rb_admin_t', String(Date.now()));
          sessionStorage.setItem('rb_auth_v2','ok');
        }catch(e){}
        try{ history.replaceState(null,'',location.pathname); }catch(e){}
      }
      const ok = (localStorage.getItem('rb_auth_v2')==='ok')
              || (localStorage.getItem('rb_admin_ok')==='true')
              || (sessionStorage.getItem('rb_auth_v2')==='ok');
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      const live = (Date.now()-ts) < TTL_MS;
      if (!(ok && live)) location.replace('login.html?reason=guard&next=pedido_local.html');
      else try{ localStorage.setItem('rb_admin_t', String(Date.now())); }catch(e){}
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Pedidos</a>
      <div class="spacer"></div>
      <a href="finanzas.html" class="btn" title="Ver finanzas">üìà Finanzas</a>
      <button id="btnBell" class="btn" title="Activar/desactivar sonido">üîî Sonido</button>
      <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>
    <div class="tabs" id="tabs">
      <span class="chipf active" data-f="all">Todos</span>
      <span class="chipf" data-f="new">Nuevos</span>
      <span class="chipf" data-f="in_prep">En preparaci√≥n</span>
      <span class="chipf" data-f="ready">Listos</span>
      <span class="chipf" data-f="delivered">Entregados</span>
      <span class="chipf" data-f="cancelled">Cancelados</span>
    </div>
    <div id="orders"></div>
    <div id="ordersError" class="err" style="display:none;margin-top:8px"></div>
  </main>

  <!-- Libs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* ===================== FIREBASE ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}
    const db = firebase.firestore();

    /* ===================== HELPERS ===================== */
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const friesName = f => f==="con_sazon" ? "Con saz√≥n" : (f==="sin_sazon" ? "Sin sazonar" : "‚Äî");

    const STATE_SEQ = ['accepted','in_prep','ready','delivered','cancelled'];
    const STATE_LABEL = {accepted:'Recibido', in_prep:'En preparaci√≥n', ready:'Listo para retirar', delivered:'Entregado', cancelled:'Cancelar'};
    const DISPLAY_LABEL = s => STATE_LABEL[s] || s;

    function pickDocDate(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){
        const v = obj[k];
        if (v?.toDate) return v.toDate();
        if (typeof v === 'number') return new Date(v);
        if (typeof v === 'string'){ const d=new Date(v); if(!isNaN(d)) return d; }
      }
      return null;
    }
    function chooseDateField(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){ if (obj && obj[k]!=null) return k; }
      return null;
    }
    function displayOrderNumber(doc){
      const o = doc.data();
      const candidates = [o.orderNumber,o.number,o.numero,o.num,o.numPedido,o.nro,o.orderNo,o.seq,o.n,o.idPedido,o.pedidoNumber,o.pedido];
      for (const c of candidates){
        if (c == null) continue;
        const n = (typeof c === "string") ? parseInt(c,10) : c;
        if (Number.isFinite(n)) return `#${n}`;
      }
      return `#${doc.id.slice(-5).toUpperCase()}`;
    }
    function unitWithExtras(it){
      const base = it.price || 0;
      const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0);
      const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
      return base + pz + ch;
    }
    function computeOrderTotal(o){
      if (typeof o.total === "number") return o.total;
      const items = Array.isArray(o.items) ? o.items : [];
      return items.reduce((t,it)=> t + (it.type==="burger" ? unitWithExtras(it) : (it.price||0)) * (it.qty||0), 0);
    }

    /* ===================== AUDIO + SALIR ===================== */
    let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
    const btnBell = $("#btnBell");
    const updateBellUI = ()=> btnBell.classList.toggle("active", soundEnabled);
    updateBellUI();
    btnBell.onclick = ()=>{
      soundEnabled = !soundEnabled;
      localStorage.setItem("rb_bell_enabled", JSON.stringify(soundEnabled));
      updateBellUI();
    };
    $("#btnLogout").onclick = ()=>{
      localStorage.removeItem("rb_auth_v2"); localStorage.removeItem("rb_admin_ok"); localStorage.removeItem("rb_admin_t");
      sessionStorage.removeItem("rb_auth_v2");
      location.replace("login.html?reason=logout&next=pedido_local.html");
    };

    function beepOnce(ctx, duration=0.28, freq=880, gain=0.7){
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type="square"; o.frequency.value=freq;
      o.connect(g); g.connect(ctx.destination);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(gain, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);
      o.start(); o.stop(ctx.currentTime + duration + 0.02);
    }
    function playBeepTriple(){
      if(!soundEnabled) return;
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        beepOnce(ctx,0.28,900,0.8);
        setTimeout(()=>beepOnce(ctx,0.28,900,0.8), 350);
        setTimeout(()=>beepOnce(ctx,0.28,900,0.8), 700);
      }catch(e){}
    }

    /* ===================== LISTADO ===================== */
    const tabs = $("#tabs"); const ordersHost = $("#orders");
    let currentFilter="all", lastSnap=null; let idToDoc = new Map();

    tabs.addEventListener("click",(e)=>{
      const el=e.target.closest("[data-f]"); if(!el) return;
      currentFilter=el.dataset.f;
      tabs.querySelectorAll(".chipf").forEach(x=>x.classList.remove("active"));
      el.classList.add("active");
      if(lastSnap) renderList(lastSnap);
    });

    const passFilter = (o)=>{
      if(currentFilter==="all") return true;
      if(currentFilter==="new") return (o.status??"accepted")==="accepted"||(o.status??"accepted")==="pending_payment";
      return (o.status??"")===currentFilter;
    };

    async function setOrderStatus(id,next){
      try{
        await db.collection("orders").doc(id).update({
          status: next,
          statusHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()})
        });
      }catch(e){ alert("No se pudo actualizar el estado: "+(e?.message||e)); }
    }
    async function setPaymentStatus(id, paid){
      try{
        await db.collection("orders").doc(id).update({
          paid: !!paid,
          payment_status: paid ? "paid" : "pending_payment",
          statusHistory: firebase.firestore.FieldValue.arrayUnion({to: paid?"paid":"pending_payment", at:new Date().toISOString()})
        });
      }catch(e){ alert("No se pudo actualizar el pago: "+(e?.message||e)); }
    }

    function btnStateClass(st){ return `state-btn state-${st}`; }

    function renderOrder(doc){
      const o=doc.data(); const dt=pickDocDate(o);
      const dtText=dt? dt.toLocaleDateString('es-AR')+', '+dt.toLocaleTimeString('es-AR') : '‚Äî';
      const items = Array.isArray(o.items)?o.items:[];
      const lines = items.map(it=>{
        if(it.type==="burger"){
          const unit=unitWithExtras(it), sub=unit*(it.qty||0);
          const ex=[]; if(it.extras?.patty)ex.push(`+${it.extras.patty} med`); if(it.extras?.cheddar)ex.push(`+${it.extras.cheddar} cheddar`);
          const notes=it.notes?` ¬∑ Notas: ${it.notes}`:"";
          return `<div class="item"><div>‚Ä¢ <strong>${it.qty||0}√ó ${it.name}</strong></div>
          <div class="sub">Papas: ${friesName(it.fries)}${ex.length?` ¬∑ ${ex.join(" ¬∑ ")}`:""}${notes}
          <div>Unit: <span class="money">${money(unit)}</span> ‚Äî Subtotal: <span class="money">${money(sub)}</span></div></div></div>`;
        } else {
          const sub=(it.price||0)*(it.qty||0);
          return `<div class="item"><div>‚Ä¢ <strong>${it.qty||0}√ó ${it.name}</strong></div>
          <div class="sub">Unit: <span class="money">${money(it.price||0)}</span> ‚Äî Subtotal: <span class="money">${money(sub)}</span></div></div>`;
        }
      }).join("");

      const telChip=o.telefono?`<span class="chip">Tel: ${o.telefono}</span>`:"";
      const st=o.status??"accepted";
      const curIdx = Math.max(STATE_SEQ.indexOf(st), 0);

      const stateBtns = `
        <div class="stateBtns">
          ${STATE_SEQ.map((key,idx)=>`
            <button class="${btnStateClass(key)} ${idx<=curIdx?'on':''}" data-act="${key}">${DISPLAY_LABEL(key)}</button>
          `).join('')}
        </div>`;

      const paymentPaid = (o.payment_status==='paid' || o.paid);
      const payLine = `
        <div class="pay-line">
          <span class="chip">Pago: ${o.pago||'‚Äî'}</span>
          <span class="pay-pill ${paymentPaid?'pay-paid':'pay-pending'}">${paymentPaid?'PAGADO':'PENDIENTE DE PAGO'}</span>
          <button class="btn" data-pay="${paymentPaid?'pending':'paid'}" style="margin-left:6px">
            ${paymentPaid?'‚è≥ Marcar PENDIENTE':'‚úì Marcar PAGADO'}
          </button>
          <button class="btn" data-print>üñ® Imprimir</button>
        </div>`;

      return `<div class="order" data-id="${doc.id}">
        <div class="order-head">
          <div>
            <div class="order-title">${displayOrderNumber(doc)} ‚Äî ${o.nombre??'Cliente'}</div>
            <div class="muted">${dtText}</div>
            <div class="chips">
              <span class="chip">Pedido: ${displayOrderNumber(doc)}</span>
              <span class="chip">Estado: ${st}</span>
              <span class="chip">Retiro: ${o.entrega||'‚Äî'}</span>
              ${telChip}
            </div>
            ${stateBtns}
          </div>
          <div>
            <div class="right-total">${money(computeOrderTotal(o))}</div>
            ${payLine}
          </div>
        </div>
        <div class="divider"></div>
        <div class="items">${lines || '<div class="muted">Sin √≠tems.</div>'}</div>
      </div>`;
    }

    /* ===================== PRINT auto-fit (58mm, 80mm, etc.) ===================== */
    function openPrintForDoc(docSnap){
      if(!docSnap) return;
      const o = docSnap.data();
      const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

      const orderNo = (()=>{
        const c=[o.orderNumber,o.number,o.numero,o.num,o.numPedido,o.nro,o.orderNo,o.seq,o.n,o.idPedido,o.pedidoNumber,o.pedido];
        for(const v of c){ if(v==null) continue; const n=typeof v==="string"?parseInt(v,10):v; if(Number.isFinite(n)) return `#${n}`; }
        return `#${docSnap.id.slice(-5).toUpperCase()}`;
      })();

      const dt=(()=>{
        const k=['createdAt','created_at','timestamp','date','fecha','time'];
        for(const kk of k){ const v=o[kk]; if(v?.toDate) return v.toDate(); if(typeof v==='number') return new Date(v); if(typeof v==='string'){const d=new Date(v); if(!isNaN(d)) return d;} }
        return null;
      })();
      const dateStr = dt ? dt.toLocaleDateString('es-AR')+' '+dt.toLocaleTimeString('es-AR') : '';

      const norm = (s, map) => { if(!s) return '‚Äî'; s=String(s).toLowerCase(); for(const k in map){ if(s.includes(k)) return map[k]; } return s.replace(/[_-]/g,' ').replace(/\b\w/g,m=>m.toUpperCase()); };
      const nicePay    = norm(o.pago || o.payment_method, {mercado:'Mercado Pago', efect:'Efectivo', trans:'Transferencia'});
      const niceEntrega= norm(o.entrega, {take:'Retira', pick:'Retira', deliv:'Delivery'});
      const paidPill   = (o.payment_status==='paid' || o.paid) ? 'PAGADO' : 'PENDIENTE';

      const items = Array.isArray(o.items)?o.items:[];
      const linesHTML = items.map(it=>{
        if(it.type==='burger'){
          const unit = (it.price||0)
            + (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)
            + (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0);
          const sub  = unit*(it.qty||0);
          const ex=[]; if(it.extras?.patty)ex.push(`+${it.extras.patty} med`); if(it.extras?.cheddar)ex.push(`+${it.extras.cheddar} cheddar`);
          const notes = it.notes ? ` ¬∑ ${it.notes}` : '';
          return `
            <div class="row"><div>${it.qty||0}√ó ${it.name||''}</div><div class="r">${money(sub)}</div></div>
            <div class="sub">Papas: ${it.fries==='con_sazon'?'Con saz√≥n':'Sin sazonar'}${ex.length?` ¬∑ ${ex.join(' ¬∑ ')}`:''}${notes}</div>`;
        }else{
          const sub=(it.price||0)*(it.qty||0);
          return `<div class="row"><div>${(it.qty||0)}√ó ${it.name||''}</div><div class="r">${money(sub)}</div></div>`;
        }
      }).join('');

      const total = (()=>{
        if(typeof o.total==='number') return o.total;
        return items.reduce((t,it)=>{
          if(it.type==='burger'){
            const u=(it.price||0)+(it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)+(it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0);
            return t+u*(it.qty||0);
          }
          return t+(it.price||0)*(it.qty||0);
        },0);
      })();

      // Tipograf√≠a desde :root (no se toca)
      const cs   = getComputedStyle(document.documentElement);
      const FONT = (cs.getPropertyValue('--font')||'system-ui, Arial, sans-serif').trim();

      const html = `
<!doctype html>
<html><head><meta charset="utf-8"><title>Ticket ${orderNo}</title>
<style>
  :root{
    /* M√°ximo seguro para cubrir 58mm y 80mm (se usa junto con 100%-safe) */
    --ticket-max-mm: 72mm;      /* si el rollo es 80mm, ocupar√° hasta ~68mm √∫tiles */
    --safe-total-mm: 14mm;      /* zona segura total (‚âà7mm por lado) */
    --side-pad-mm:   1.5mm;     /* padding interno del ticket */
    --font: ${FONT};
  }
  @page{ size: auto; margin: 0; } /* el driver define el ancho real; sin margen del navegador */
  html,body{margin:0;padding:0;color:#000;}
  body{
    font-family: var(--font); font-size:12px; line-height:1.35;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    width: 100%; margin: 0 auto;
    print-color-adjust:exact; -webkit-print-color-adjust:exact;
  }
  .page{ width:100%; display:flex; justify-content:center; }

  /* Ticket = min(ancho m√°ximo en mm, 100% - zona segura). Sin transforms. */
  .ticket{
    width: min(var(--ticket-max-mm), calc(100% - var(--safe-total-mm)));
    margin: 0 auto;
    padding: 0 var(--side-pad-mm);
    box-sizing: border-box;
    overflow-wrap:anywhere; word-break:break-word; white-space:normal;
  }

  .c{text-align:center}
  .row{display:flex;justify-content:space-between;gap:8px}
  .row > div:first-child{min-width:0}
  .sub{margin:2px 0 4px 0;font-size:11px;white-space:pre-wrap}
  .r{text-align:right;white-space:nowrap}
  .hr{border-top:1px dashed #000;margin:6px 0}
  .lg{font-weight:800}
  .kv{display:flex;justify-content:space-between;gap:8px}
  .kv > div:first-child{white-space:nowrap}   /* evita ‚ÄúPag o‚Äù, ‚ÄúEnt rega‚Äù, etc. */
  .pill{display:inline-block;padding:2px 6px;border:1px solid #000;border-radius:999px;font-weight:800}
  .foot{margin-top:8px;font-size:11px;text-align:center}

  @media print{ .ticket{break-inside:avoid} }
</style>
</head>
<body>
  <div class="page">
    <div class="ticket">
      <div class="c">
        <div class="lg">Rhodes Burgers</div>
        <div>${orderNo}</div>
        <div style="font-size:11px">${dateStr}</div>
      </div>
      <div class="hr"></div>
      ${linesHTML || '<div class="sub">Sin √≠tems.</div>'}
      <div class="hr"></div>
      <div class="row lg"><div>Total</div><div>${money(total)}</div></div>
      <div class="kv"><div>Pago</div><div>${nicePay} ¬∑ <span class="pill">${paidPill}</span></div></div>
      <div class="kv"><div>Entrega</div><div>${niceEntrega}</div></div>
      ${o.nombre? `<div class="kv"><div>Cliente</div><div>${o.nombre}</div></div>`:''}
      ${o.telefono? `<div class="kv"><div>Tel</div><div>${o.telefono}</div></div>`:''}
      ${o.status? `<div class="kv"><div>Estado</div><div>${o.status}</div></div>`:''}
      <div class="foot">¬°Gracias por tu compra!</div>
    </div>
  </div>
  <script>window.print(); window.onafterprint=()=>window.close();<\/script>
</body></html>`;

      const w = window.open('', '_blank', 'width=420,height=600');
      w.document.open(); w.document.write(html); w.document.close();
      try{ w.focus(); }catch(_){}
    }

    function renderList(snap){
      const docs = snap.docs.filter(d=>passFilter(d.data()));
      idToDoc = new Map(snap.docs.map(d=>[d.id,d]));
      document.getElementById("orders").innerHTML = docs.length
        ? docs.map(renderOrder).join("")
        : '<p class="muted">No hay pedidos.</p>';

      document.querySelectorAll(".order").forEach(card=>{
        const id=card.dataset.id;
        card.querySelectorAll("[data-act]").forEach(btn=>btn.addEventListener("click",()=>setOrderStatus(id,btn.dataset.act)));
        const payBtn = card.querySelector("[data-pay]");
        if(payBtn) payBtn.addEventListener("click",()=> setPaymentStatus(id, payBtn.dataset.pay==="paid"));
        const pr = card.querySelector("[data-print]");
        if(pr) pr.addEventListener("click",()=> openPrintForDoc(idToDoc.get(id)));
      });
    }

    (async function subscribeOrders(){
      try{
        const probe = await db.collection("orders").limit(1).get();
        let dateField = null;
        if (!probe.empty) dateField = chooseDateField(probe.docs[0].data());
        let q = db.collection("orders");
        q = dateField ? q.orderBy(dateField,'desc') : q.orderBy(firebase.firestore.FieldPath.documentId());
        q.limit(100).onSnapshot(snap=>{
          document.getElementById("ordersError").style.display="none";
          document.getElementById("ordersError").textContent="";
          lastSnap=snap; renderList(snap);
        }, (err)=>{
          console.error(err);
          const el=document.getElementById("ordersError");
          el.textContent="No se pudo cargar la lista de pedidos."; el.style.display="block";
        });
      }catch(err){
        console.error(err);
        const el=document.getElementById("ordersError");
        el.textContent="No se pudo inicializar la lista de pedidos."; el.style.display="block";
      }
    })();
  });
  </script>
</body>
</html>
