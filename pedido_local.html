<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos â€¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:22px; --shadow:0 12px 34px rgba(0,0,0,.10); --ring:#eaeaea;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.ghost{background:#fff}
    .btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.sm{ padding:6px 10px; font-size:13px; border-radius:10px }
    .btn.sm[disabled]{opacity:.5; pointer-events:none}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    /* KPI Box */
    .kpi{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;margin:0 0 18px 0;display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .kpi .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .kbadge{min-width:160px;background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:10px 14px}
    .klabel{font-size:12px;color:var(--muted)}
    .kvalue{font-weight:800;font-size:20px}
    .chartwrap{width:100%;margin-top:10px}
    .chartbox{width:100%;height:260px}

    .filters{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
    .fbtn{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 12px;cursor:pointer}
    .fbtn.active{background:#e9f8ef;border-color:#b7ebc9}

    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#f3f3f3;border:1px solid var(--ring);color:#333;border-radius:999px;padding:6px 10px;font-size:13px}
    .muted{color:var(--muted)}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap}
    .items{margin-top:10px}
    .item{margin:8px 0 6px 0}
    .item strong{font-weight:700}
    .item .sub{color:var(--muted);font-size:13px;margin-top:3px}
    .money{white-space:nowrap}
    .divider{height:1px;background:#efefef;margin:10px 0}
    input[type="month"]{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;outline:none}

    /* Chip de estado por color */
    .chip.st-new    { background:#eafaf1; border-color:#bcebd0; }
    .chip.st-prep   { background:#fff5e6; border-color:#ffd9a0; }
    .chip.st-ready  { background:#e8f1ff; border-color:#b9d4ff; }
    .chip.st-done   { background:#eef9ff; border-color:#bfe9ff; opacity:.85 }
    .chip.st-cancel { background:#fff0f0; border-color:#ffc7c7; color:#aa2e25 }
  </style>

  <!-- Guard de sesiÃ³n -->
  <script>
    const SESS_KEY = "rb_admin_session_v1";
    (function enforceLogin(){
      try{
        const raw = localStorage.getItem(SESS_KEY);
        if(!raw) throw new Error("no session");
        const s = JSON.parse(raw);
        if(!s || !s.exp || Date.now() > s.exp) throw new Error("expired");
      }catch(e){
        const next = location.pathname + location.search;
        location.replace("login.html?next=" + encodeURIComponent(next));
      }
    })();
  </script>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#">
        <img src="images/logo.png" alt="Rhodes Burgers">
        Pedidos
      </a>
      <div class="spacer"></div>
      <button id="btnBell" class="btn ghost" title="Activar/desactivar sonido">ðŸ”” Sonido</button>
      <button id="btnLogout" class="btn ghost" title="Cerrar sesiÃ³n">âŽ‹ Cerrar sesiÃ³n</button>
    </div>
  </header>

  <main class="container">
    <div class="kpi">
      <div class="row">
        <strong>Resumen mensual</strong>
        <input type="month" id="monthPicker">
        <button id="btnReloadKPI" class="btn ghost">Actualizar</button>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <div class="kbadge">
          <div class="klabel">Pedidos</div>
          <div class="kvalue" id="kpiCount">â€”</div>
        </div>
        <div class="kbadge">
          <div class="klabel">Ingresos</div>
          <div class="kvalue" id="kpiRevenue">â€”</div>
        </div>
      </div>

      <div class="chartwrap">
        <canvas id="monthChart" class="chartbox"></canvas>
      </div>
    </div>

    <h1>Ãšltimos pedidos</h1>

    <!-- Filtros por estado -->
    <div class="filters" id="filters">
      <button class="fbtn active" data-filter="all">Todos <span class="muted" id="cnt_all">(â€”)</span></button>
      <button class="fbtn" data-filter="nuevo">Nuevos <span class="muted" id="cnt_nuevo">(â€”)</span></button>
      <button class="fbtn" data-filter="en_preparacion">En preparaciÃ³n <span class="muted" id="cnt_en_preparacion">(â€”)</span></button>
      <button class="fbtn" data-filter="listo">Listos <span class="muted" id="cnt_listo">(â€”)</span></button>
      <button class="fbtn" data-filter="entregado">Entregados <span class="muted" id="cnt_entregado">(â€”)</span></button>
      <button class="fbtn" data-filter="cancelado">Cancelados <span class="muted" id="cnt_cancelado">(â€”)</span></button>
    </div>

    <div id="orders"></div>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    /* ===================== FIREBASE ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ===================== HELPERS ===================== */
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    // Estados
    const STATUS = {
      NUEVO: "nuevo",
      PREP: "en_preparacion",
      LISTO: "listo",
      ENTREGADO: "entregado",
      CANCELADO: "cancelado",
    };
    const STATUS_LABEL = {
      [STATUS.NUEVO]: "Nuevo",
      [STATUS.PREP]: "En preparaciÃ³n",
      [STATUS.LISTO]: "Listo para retirar",
      [STATUS.ENTREGADO]: "Entregado",
      [STATUS.CANCELADO]: "Cancelado",
    };
    const STATUS_CLASS = {
      [STATUS.NUEVO]: "st-new",
      [STATUS.PREP]: "st-prep",
      [STATUS.LISTO]: "st-ready",
      [STATUS.ENTREGADO]: "st-done",
      [STATUS.CANCELADO]: "st-cancel",
    };
    const STATUS_PRIORITY = {
      [STATUS.NUEVO]: 0,
      [STATUS.PREP]: 1,
      [STATUS.LISTO]: 2,
      [STATUS.ENTREGADO]: 3,
      [STATUS.CANCELADO]: 4,
    };

    // Nro pedido
    function getOrderNumber(o){
      if (typeof o?.nro === "number" && o.nro > 0) return o.nro;
      if (typeof o?.orderNumber === "number" && o.orderNumber > 0) return o.orderNumber;
      return null;
    }

    function unitWithExtras(item){
      const base = item.price || 0;
      const pz = (item.extras?.patty||0)   * (item.extras?.EXTRA_PRICE_PATTY||0);
      const ch = (item.extras?.cheddar||0) * (item.extras?.EXTRA_PRICE_CHEDDAR||0);
      return base + pz + ch;
    }
    function computeOrderTotal(o){
      if (typeof o.total === "number") return o.total;
      const items = Array.isArray(o.items) ? o.items : [];
      let t=0;
      for(const it of items){
        if(it.type==="burger"){
          t += unitWithExtras(it) * (it.qty||0);
        }else{
          t += (it.price||0) * (it.qty||0);
        }
      }
      return t;
    }
    const friesName = f => f==="con_sazon" ? "Con sazÃ³n" : (f==="sin_sazon" ? "Sin sazonar" : "â€”");

    async function updateStatus(orderId, nextStatus){
      if(!orderId || !nextStatus) return;
      try{
        await db.collection("orders").doc(orderId).update({
          status: nextStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          statusHistory: firebase.firestore.FieldValue.arrayUnion({
            status: nextStatus,
            at: firebase.firestore.FieldValue.serverTimestamp()
          })
        });
        if(nextStatus === STATUS.LISTO){ playBeep(); } // ping al marcar "Listo"
      }catch(e){
        alert("No se pudo actualizar el estado: " + (e?.message||e));
        console.error(e);
      }
    }

    function renderOrder(doc, id){
      const o = doc.data();
      const when = o.createdAt?.toDate ? o.createdAt.toDate() : null;
      const dt   = when ? when.toLocaleDateString('es-AR') + ', ' + when.toLocaleTimeString('es-AR') : 'â€”';
      const items = Array.isArray(o.items) ? o.items : [];
      const nro = getOrderNumber(o);
      const nroTxt = nro ? `#${nro}` : "#(s/n)";
      const st = o.status || STATUS.NUEVO;
      const stLabel = STATUS_LABEL[st] || st;
      const stClass = STATUS_CLASS[st] || "";

      const lines = items.map(it=>{
        if(it.type === "burger"){
          const unit = unitWithExtras(it);
          const subtotal = unit * (it.qty||0);
          const extras = [];
          if(it.extras?.patty)   extras.push(`+${it.extras.patty} med`);
          if(it.extras?.cheddar) extras.push(`+${it.extras.cheddar} cheddar`);
          const notes = it.notes ? ` Â· Notas: ${it.notes}` : "";
          return `
            <div class="item">
              <div>â€¢ <strong>${it.qty||0}Ã— ${it.name}</strong></div>
              <div class="sub">
                Papas: ${friesName(it.fries)}${extras.length?` Â· ${extras.join(" Â· ")}`:""}${notes}
                <div>Unit: <span class="money">${money(unit)}</span> â€” Subtotal: <span class="money">${money(subtotal)}</span></div>
              </div>
            </div>`;
        }else{
          const subtotal = (it.price||0) * (it.qty||0);
          return `
            <div class="item">
              <div>â€¢ <strong>${it.qty||0}Ã— ${it.name}</strong></div>
              <div class="sub">Unit: <span class="money">${money(it.price||0)}</span> â€” Subtotal: <span class="money">${money(subtotal)}</span></div>
            </div>`;
        }
      }).join("");

      const telChip = o.telefono ? `<span class="chip">Tel: ${o.telefono}</span>` : "";

      // SIEMPRE mostrar los 3 botones. Deshabilitar si ya estÃ¡ entregado/cancelado.
      const isLocked = (st === STATUS.ENTREGADO || st === STATUS.CANCELADO);
      const actions = `
        <button class="btn sm ${st===STATUS.PREP?'active':''}" ${isLocked?'disabled':''}
                onclick="updateStatus('${id}','${STATUS.PREP}')">En preparaciÃ³n</button>
        <button class="btn sm ${st===STATUS.LISTO?'active':''}" ${isLocked?'disabled':''}
                onclick="updateStatus('${id}','${STATUS.LISTO}')">Listo para retirar</button>
        <button class="btn sm ${st===STATUS.ENTREGADO?'active':''}" ${isLocked?'disabled':''}
                onclick="updateStatus('${id}','${STATUS.ENTREGADO}')">Entregado</button>
      `;

      return `
        <div class="order">
          <div class="order-head">
            <div>
              <div class="order-title">${nroTxt} â€” ${o.nombre ?? 'Cliente'}</div>
              <div class="muted">${dt}</div>
              <div class="chips">
                <span class="chip ${stClass}">Estado: ${stLabel}</span>
                <span class="chip">Retiro: ${o.entrega||'â€”'}</span>
                ${telChip}
                <span class="chip">Pago: ${o.pago||'â€”'}</span>
              </div>
            </div>
            <div class="right-total">${money(computeOrderTotal(o))}</div>
          </div>

          <div class="chips" style="margin-top:10px">${actions}</div>

          <div class="divider"></div>
          <div class="items">
            ${lines || '<div class="muted">Sin Ã­tems.</div>'}
          </div>
        </div>`;
    }

    /* ===================== AUDIO (BEEP) ===================== */
    let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
    const btnBell = $("#btnBell");
    function updateBellUI(){ btnBell.classList.toggle("active", soundEnabled); }
    updateBellUI();
    btnBell.onclick = ()=>{
      soundEnabled = !soundEnabled;
      localStorage.setItem("rb_bell_enabled", JSON.stringify(soundEnabled));
      updateBellUI();
    };
    function playBeep(){
      if(!soundEnabled) return;
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.value = 880;
        o.connect(g); g.connect(ctx.destination);
        o.start();
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
        o.stop(ctx.currentTime + 0.2);
      }catch(e){}
    }

    /* ===================== KPI + CHART (Mensual) ===================== */
    const monthPicker = $("#monthPicker");
    const kpiCount = $("#kpiCount");
    const kpiRevenue = $("#kpiRevenue");
    const btnReloadKPI = $("#btnReloadKPI");

    (function setDefaultMonth(){
      const d = new Date();
      const m = (d.getMonth()+1).toString().padStart(2,"0");
      monthPicker.value = `${d.getFullYear()}-${m}`;
    })();

    function monthRange(ym){
      const [y,m] = ym.split("-").map(n=>parseInt(n,10));
      const start = new Date(y, m-1, 1, 0,0,0,0);
      const end   = new Date(y, m,   1, 0,0,0,0);
      return {start, end};
    }

    let monthChart;
    function ensureChart(labels, orders, revenue){
      const ctx = document.getElementById("monthChart").getContext("2d");
      if(monthChart){ monthChart.destroy(); }
      monthChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              type: 'bar',
              label: 'Pedidos',
              data: orders,
              backgroundColor: 'rgba(46, 204, 113, 0.35)',
              borderColor: '#2ecc71',
              borderWidth: 1,
              yAxisID: 'y',
            },
            {
              type: 'line',
              label: 'Ingresos ($)',
              data: revenue,
              borderColor: '#2ecc71',
              backgroundColor: 'rgba(46, 204, 113, 0.10)',
              borderWidth: 2,
              tension: .25,
              yAxisID: 'y2',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: function(ctx){
                  if(ctx.datasetIndex===1){
                    const v = ctx.parsed.y || 0;
                    return `${ctx.dataset.label}: ${ (v).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}) }`;
                  }
                  return `${ctx.dataset.label}: ${ctx.parsed.y}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero:true,
              title: { display:true, text:'Pedidos' },
              grid:{ color:'rgba(0,0,0,0.05)' }
            },
            y2: {
              beginAtZero:true,
              position:'right',
              title: { display:true, text:'Ingresos ($)' },
              grid:{ drawOnChartArea:false }
            },
            x: { grid:{ display:false } }
          }
        }
      });
    }

    async function loadKPI(){
      const ym = monthPicker.value;
      if(!ym) return;

      const [yStr,mStr] = ym.split("-");
      const y = parseInt(yStr,10), m = parseInt(mStr,10);
      const totalDays = new Date(y, m, 0).getDate();
      const labels = Array.from({length:totalDays}, (_,i)=> (i+1).toString());
      const dayOrders = Array.from({length:totalDays}, ()=>0);
      const dayRevenue = Array.from({length:totalDays}, ()=>0);

      const {start, end} = monthRange(ym);
      let count=0, revenue=0;

      const snap = await db.collection("orders")
        .where("createdAt", ">=", firebase.firestore.Timestamp.fromDate(start))
        .where("createdAt", "<",  firebase.firestore.Timestamp.fromDate(end))
        .get();

      snap.forEach(doc=>{
        const data = doc.data();
        const when = data.createdAt?.toDate ? data.createdAt.toDate() : null;
        const d = when ? when.getDate() : 1;
        const idx = Math.max(0, Math.min(totalDays-1, d-1));
        const total = computeOrderTotal(data);
        count += 1;
        revenue += total;
        dayOrders[idx] += 1;
        dayRevenue[idx] += total;
      });

      kpiCount.textContent = count.toLocaleString("es-AR");
      kpiRevenue.textContent = money(revenue);
      ensureChart(labels, dayOrders, dayRevenue);
    }

    btnReloadKPI.onclick = loadKPI;
    monthPicker.onchange = loadKPI;
    loadKPI();

    /* ===================== LISTADO + FILTROS + AVISO NUEVOS ===================== */
    const ordersHost = $("#orders");
    const filtersWrap = $("#filters");
    const cnt_all = $("#cnt_all");
    const cnt_nuevo = $("#cnt_nuevo");
    const cnt_en_prep = $("#cnt_en_preparacion");
    const cnt_listo = $("#cnt_listo");
    const cnt_entregado = $("#cnt_entregado");
    const cnt_cancelado = $("#cnt_cancelado");

    let currentFilter = "all";
    let lastDocs = [];
    const seenIds = new Set();
    let initialLoaded = false;

    function setFilterUI(val){
      currentFilter = val;
      filtersWrap.querySelectorAll(".fbtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.filter===val);
      });
      renderListFromCache();
    }

    filtersWrap.addEventListener("click", (e)=>{
      const b = e.target.closest(".fbtn");
      if(!b) return;
      setFilterUI(b.dataset.filter);
    });

    function updateCounters(docs){
      const counts = {
        all: docs.length,
        nuevo: 0,
        en_preparacion: 0,
        listo: 0,
        entregado: 0,
        cancelado: 0
      };
      docs.forEach(d=>{
        const st = (d.data().status || "nuevo");
        if(counts[st] !== undefined) counts[st]++;
      });
      cnt_all.textContent = `(${counts.all})`;
      cnt_nuevo.textContent = `(${counts.nuevo})`;
      cnt_en_prep.textContent = `(${counts.en_preparacion})`;
      cnt_listo.textContent = `(${counts.listo})`;
      cnt_entregado.textContent = `(${counts.entregado})`;
      cnt_cancelado.textContent = `(${counts.cancelado})`;
    }

    function renderListFromCache(){
      if (!lastDocs.length){
        ordersHost.innerHTML = '<p class="muted">No hay pedidos.</p>';
        return;
      }
      let docs = lastDocs;
      if(currentFilter !== "all"){
        docs = docs.filter(d => (d.data().status || "nuevo") === currentFilter);
      }
      docs.sort((a,b)=>{
        const A = a.data(), B = b.data();
        const stA = STATUS_PRIORITY[A.status || "nuevo"] ?? 99;
        const stB = STATUS_PRIORITY[B.status || "nuevo"] ?? 99;
        if(stA !== stB) return stA - stB;
        const tA = A.createdAt?.toMillis ? A.createdAt.toMillis() : 0;
        const tB = B.createdAt?.toMillis ? B.createdAt.toMillis() : 0;
        return tB - tA;
      });

      ordersHost.innerHTML = docs.map(d => renderOrder(d, d.id)).join("");
    }

    db.collection("orders").orderBy("createdAt","desc").limit(300)
      .onSnapshot(snap=>{
        lastDocs = snap.docs.slice();
        updateCounters(lastDocs);
        renderListFromCache();

        snap.docChanges().forEach(ch=>{
          if(ch.type==='added'){
            const id = ch.doc.id;
            if(!initialLoaded && !seenIds.has(id)){
              seenIds.add(id);
            } else {
              playBeep();
            }
          }
        });
        initialLoaded = true;
      });

    // Logout
    const btnLogout = document.getElementById("btnLogout");
    if (btnLogout) {
      btnLogout.onclick = ()=>{
        try { localStorage.removeItem("rb_admin_session_v1"); } catch(e){}
        location.replace("login.html");
      };
    }
  </script>
</body>
</html>
