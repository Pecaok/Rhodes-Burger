<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel de pedidos - Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1100px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer; white-space:nowrap }
    .btn.primary{ background:var(--primary); color:#fff }
    .container{ max-width:1100px; margin:22px auto; padding:0 12px }
    h1{ font-size:34px; margin:6px 4px 18px }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px }
    select,input[type="text"]{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px; background:#fff; min-width:160px }
    .stats{ display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin:12px 0 18px }
    .stat{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; font-size:18px; font-weight:800 }
    .list{ display:flex; flex-direction:column; gap:14px }
    .order{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px }
    .order .row{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px }
    .order h3{ margin:0 0 4px; font-size:18px }
    .muted{ color:var(--muted) }
    ul.items{ margin:8px 0 0 16px; padding:0 }
    .badge{ display:inline-block; background:#f2f2f2; border:1px solid #e8e8e8; color:#333; padding:4px 8px; border-radius:999px; font-size:12px; margin-right:6px }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand">
        <img src="images/logo.png" alt="Rhodes Burgers" onerror="this.onerror=null;this.src='images/logo.jpg';">
      </a>
      <h2 style="margin:0;font-size:18px">Panel de pedidos</h2>
      <div class="spacer"></div>
      <button class="btn" id="btnSound">ðŸ”” Activar sonido</button>
    </div>
  </header>

  <main class="container">
    <div class="controls">
      <label>Mes:
        <select id="selMes"></select>
      </label>
      <label>AÃ±o:
        <select id="selAnio"></select>
      </label>
      <input id="inpBuscar" type="text" placeholder="Buscar (nombre, nÃºmero, direcciÃ³n, comentarios)">
    </div>

    <div class="stats">
      <div class="stat">Pedidos (mes): <span id="statPedidos">0</span></div>
      <div class="stat">Ingresos (mes): <span id="statIngresos">$0</span></div>
    </div>

    <div class="list" id="ordersList"></div>
  </main>

  <!-- Firebase (compat, igual que pedido_cliente) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /*************** FIREBASE CONFIG (TU PROYECTO) ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /*************** UI & ESTADO ***************/
    const $ = s => document.querySelector(s);
    const listEl = $("#ordersList");
    const statPedidosEl = $("#statPedidos");
    const statIngresosEl = $("#statIngresos");
    const selMes = $("#selMes");
    const selAnio = $("#selAnio");
    const inpBuscar = $("#inpBuscar");
    const money = n => n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    // Mes/AÃ±o (poblar selects)
    const MONTHS = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const now = new Date();
    for(let i=0;i<12;i++){
      const o=document.createElement("option"); o.value=i; o.textContent=MONTHS[i]; selMes.appendChild(o);
    }
    const year = now.getFullYear();
    for(let y=year-2;y<=year+1;y++){
      const o=document.createElement("option"); o.value=y; o.textContent=y; selAnio.appendChild(o);
    }
    selMes.value = String(now.getMonth());
    selAnio.value = String(year);

    let enableSound=false;
    let audioCtx=null;
    $("#btnSound").onclick = async()=>{
      enableSound=!enableSound;
      if(enableSound && !audioCtx){
        try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch{}
      }
      $("#btnSound").textContent = enableSound? "ðŸ”” Sonando" : "ðŸ”• Activar sonido";
    };
    function ping(){
      if(!enableSound || !audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type="sine"; o.frequency.setValueAtTime(880,audioCtx.currentTime);
      g.gain.setValueAtTime(0.001,audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, audioCtx.currentTime+0.02);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.4);
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime+0.42);
    }

    // Cache de pedidos y Ãºltima fecha para sonar
    let allOrders = [];   // {id, ...data}
    let firstSnapshotDone=false;

    function withinMonth(ts, y, m){
      if(!ts) return false;
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.getFullYear()==y && d.getMonth()==m;
    }

    function render(){
      const y = +selAnio.value, m = +selMes.value;
      const q = (inpBuscar.value||"").trim().toLowerCase();

      // filtrar por mes/aÃ±o
      const monthOrders = allOrders.filter(o => withinMonth(o.createdAt, y, m));

      // buscar
      const filtered = monthOrders.filter(o=>{
        if(!q) return true;
        const fields = [
          String(o.orderNumber||""),
          String(o.nombre||o.name||""),
          String(o.direccion||""),
          String(o.comments||o.comentarios||""),
          (o.items||[]).map(i=>`${i.qty||i.cantidad||1} ${i.name||i.nombre||""}`).join(" ")
        ].join(" ").toLowerCase();
        return fields.includes(q);
      });

      // ordenar por fecha desc
      filtered.sort((a,b)=>{
        const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return tb - ta;
      });

      // totals
      const count = filtered.length;
      const ingresos = monthOrders.reduce((s,o)=> s + (o.total||0), 0);

      statPedidosEl.textContent = String(count);
      statIngresosEl.textContent = money(ingresos);

      // render list
      listEl.innerHTML = filtered.map(o=>{
        const nPedido = (o.orderNumber!=null) ? `#${o.orderNumber}` : `#${o.id.slice(0,6)}`;
        const fecha = o.createdAt?.toDate ? o.createdAt.toDate() : null;
        const fechaTxt = fecha ? fecha.toLocaleString() : "";
        const retiro = o.entrega || o.retiro || "take_away";
        const papas = o.fries || o.papas || "-";
        const pago  = o.pago || o.metodoPago || "-";
        const comentarios = o.comments || o.comentarios || "";

        const itemsHtml = (o.items||[]).map(it=>{
          const q = it.qty || it.cantidad || 1;
          const name = it.name || it.nombre || "";
          return `<li>${q}Ã— ${name}</li>`;
        }).join("");

        return `
          <div class="order">
            <div class="row">
              <div>
                <h3>${nPedido} â€” ${o.nombre||o.name||""}</h3>
                <div class="muted">${fechaTxt}</div>
                <div style="margin:6px 0">
                  <span class="badge">Retiro: ${retiro}</span>
                  <span class="badge">Papas: ${papas}</span>
                  <span class="badge">Pago: ${pago}</span>
                </div>
                ${comentarios ? `<div>ðŸ’¬ ${comentarios}</div>` : ``}
                <ul class="items">${itemsHtml}</ul>
              </div>
              <div style="font-weight:800; font-size:18px">${money(o.total||0)}</div>
            </div>
          </div>`;
      }).join("") || `<div class="muted">No hay pedidos para mostrar.</div>`;
    }

    // Listeners UI
    selMes.onchange = render;
    selAnio.onchange = render;
    inpBuscar.oninput = render;

    // SuscripciÃ³n en tiempo real
    db.collection("orders")
      .orderBy("createdAt","desc")
      .onSnapshot(snap=>{
        const addedIds = new Set();
        snap.docChanges().forEach(ch=>{
          if(ch.type==="added") addedIds.add(ch.doc.id);
        });

        allOrders = snap.docs.map(d=>({ id:d.id, ...d.data() }));

        // sonido solo despuÃ©s del primer render (para no sonar con histÃ³ricos)
        if(firstSnapshotDone && addedIds.size>0) ping();
        firstSnapshotDone = true;

        render();
      });
  </script>
</body>
</html>
