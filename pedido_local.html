<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#625A45" />

  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#444; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
      --font: Inter, system-ui, "Segoe UI", Roboto, Arial, sans-serif;
      --st-accepted:#FBC02D; --st-in_prep:#FB8C00; --st-ready:#00ACC1; --st-delivered:#2E7D32; --st-cancelled:#D32F2F;
      --pay-pending:#FFA000; --pay-paid:#625A45;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit}
    .btn.active,.btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .chipf{background:#f3f3f3;border:1px solid var(--ring);color:#111;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chipf.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    
    /* Order Card */
    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:20px;margin:16px 0; border:1px solid transparent}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800; font-size: 1.1rem;}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#f0f0f0;border:1px solid #ddd;color:#333;border-radius:6px;padding:4px 8px;font-size:12px;font-weight:600}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap}
    
    /* ITEMS */
    .cat-section { margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 10px; }
    .cat-header { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 8px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
    .item-row { display: flex; gap: 12px; margin-bottom: 12px; font-size: 15px; align-items: flex-start; }
    .item-qty { font-weight: 800; font-size: 16px; color: var(--primary); min-width: 24px; }
    .item-det { flex: 1; }
    .item-name { font-weight: 700; color: #111; line-height: 1.2; }
    .item-extras { margin-top: 4px; display: flex; flex-direction: column; gap: 2px; }
    .extra-line { font-size: 13px; color: #555; display: flex; align-items: center; gap: 6px; }
    .note-line { color: #d32f2f; font-style: italic; font-weight: 600; font-size: 13px; margin-top: 4px; }

    /* Botones Estado */
    .stateBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .state-btn{border:2px solid #dcdcdc;background:#fff;color:#111;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;min-width:160px;text-align:center}
    .state-btn.on{color:#fff;border-color:var(--primary);background:var(--primary)}
    .state-accepted.on{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .state-in_prep.on{background:var(--st-in_prep);border-color:var(--st-in_prep);color:#fff}
    .state-ready.on{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .state-delivered.on{background:var(--st-delivered);border-color:var(--st-delivered);color:#fff}
    .state-cancelled.on{background:var(--st-cancelled);border-color:var(--st-cancelled);color:#fff}

    /* L√≠nea de pago */
    .pay-line{margin-top:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .pay-toggle{min-width:200px;text-align:center}
    .pay-toggle.is-paid{ background:var(--pay-paid); color:#fff; border-color:var(--pay-paid); }
    .pay-toggle.is-pending{ background:var(--pay-pending); color:#fff; border-color:var(--pay-pending); }
    .pay-toggle[disabled]{opacity:.9; cursor:default;}

    .order.cancelled{opacity:.7}
    .order.cancelled .order-title{text-decoration:line-through}

    @media print{
      @page{size:A4 portrait;margin:12mm}
      header,.tabs,.stateBtns,.pay-line .btn,.danger,#btnBell,[title="Ver finanzas"],[title="Panel admin"],[title="Abrir mostrador"],#btnInstall,#btnAutoPrint{display:none!important}
      .order{break-inside:avoid;box-shadow:none;border:1px solid #eee}
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* 1. INIT FIREBASE */
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}
    const db = firebase.firestore();

    /* 2. HELPERS GLOBALES */
    window.idToDoc = new Map(); // Mapa para impresi√≥n
    
    // Manejo de sesi√≥n
    const TTL_MS = 20 * 60 * 60 * 1000;
    function sessionValid(){
      const ok = localStorage.getItem('rb_admin_ok') === 'true';
      const ts = Number(localStorage.getItem('rb_admin_t') || 0);
      return ok && (Date.now() - ts) < TTL_MS;
    }
    if (!sessionValid()){
      const next = encodeURIComponent('pedido_local.html');
      location.replace('login.html?next=' + next);
    } else {
      localStorage.setItem('rb_admin_t', String(Date.now()));
    }

    // Funciones expuestas a window para que el HTML las vea
    window.logout = function(){
       localStorage.removeItem('rb_admin_ok');
       location.replace('login.html');
    };

    window.setOrderStatus = async function(id, next, isPaid){
      if (next === 'delivered' && !isPaid) {
          alert("‚ö†Ô∏è ATENCI√ìN: El pedido no est√° pagado.");
          return;
      }
      try{ 
          await db.collection("orders").doc(id).update({ 
              status: next, 
              statusHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()}) 
          }); 
      }catch(e){ alert("Error: "+e.message); }
    };

    window.setPaymentStatus = async function(id, paid){
      try{ 
          await db.collection("orders").doc(id).update({ 
              paid: !!paid, 
              payment_status: paid ? "paid" : "pending_payment"
          }); 
      }catch(e){ alert("Error: "+e.message); }
    };

    window.updatePago = async function(id, value){
      try{ await db.collection("orders").doc(id).update({ pago: value }); }
      catch(e){ alert("Error: "+e.message); }
    };

    window.printOrder = function(id){
      const doc = window.idToDoc.get(id);
      if(doc) window.trySilentPrint(doc);
    };

    window.pickDocDate = function(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){
        const v = obj[k];
        if (v?.toDate) return v.toDate();
        if (typeof v === 'string'){ const d=new Date(v); if(!isNaN(d)) return d; }
        if (typeof v === 'number') return new Date(v);
      }
      return new Date();
    };
  </script>
</head>

<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes">Pedidos</a>
      <div class="spacer"></div>
      <nav style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <a href="pedido_local.html" class="btn primary" title="Ver pedidos">üì¶ Pedidos</a>
        <a href="finanzas.html" class="btn" title="Finanzas">üìà Finanzas</a>
        <a href="mostrador.html" class="btn" title="Mostrador">üßæ Mostrador</a>
        <a href="admin.html" class="btn" title="Panel admin">‚öôÔ∏è Admin</a>
      </nav>
      <button id="btnBell" class="btn" title="Sonido">üîî</button>
      <button id="btnAutoPrint" class="btn" title="Autoimprimir">üñ®Ô∏è</button>
      <button onclick="window.logout()" class="btn danger">Salir</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>
    <div class="tabs" id="tabs">
      <span class="chipf active" data-f="recibidos">Recibidos</span>
      <span class="chipf" data-f="entregados">Entregados</span>
      <span class="chipf" data-f="cancelled">Cancelados</span>
      <span class="chipf" data-f="all">Todos</span>
    </div>
    <div id="orders"></div>
    <div id="ordersError" class="err" style="display:none;margin-top:8px;text-align:center;color:red">Error cargando pedidos.</div>
  </main>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    
    /* --- UI LOGIC --- */
    let currentFilter = "recibidos";
    let lastSnap = null;
    
    // Tabs
    document.getElementById("tabs").addEventListener("click", (e)=>{
        const el = e.target.closest("[data-f]");
        if(!el) return;
        currentFilter = el.dataset.f;
        document.querySelectorAll(".chipf").forEach(x => x.classList.remove("active"));
        el.classList.add("active");
        if(lastSnap) renderList(lastSnap);
    });

    // Botones Header
    const btnBell = document.getElementById("btnBell");
    let soundOn = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
    const updBell = ()=>{ btnBell.classList.toggle("active", soundOn); };
    updBell();
    btnBell.onclick = ()=>{ soundOn=!soundOn; localStorage.setItem("rb_bell_enabled", soundOn); updBell(); };

    const btnAP = document.getElementById("btnAutoPrint");
    let autoPrint = JSON.parse(localStorage.getItem("rb_auto_print")||"false");
    const updAP = ()=>{ btnAP.classList.toggle("active", autoPrint); };
    updAP();
    btnAP.onclick = ()=>{ autoPrint=!autoPrint; localStorage.setItem("rb_auto_print", autoPrint); updAP(); };

    // Beep
    const playBeep = ()=>{
        if(!soundOn) return;
        try{
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            const o = ctx.createOscillator(); const g = ctx.createGain();
            o.type = "square"; o.frequency.value = 700;
            o.connect(g); g.connect(ctx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.15); o.stop(ctx.currentTime + 0.15);
        }catch(e){}
    };

    /* --- SUBSCRIBE FIREBASE (SOLUCI√ìN VISIBILIDAD) --- */
    (async function init(){
        try {
            // üî• PEDIMOS TODO SIN ORDENAR (Para que no falle por √≠ndices)
            // Limitamos a 200 para no explotar la memoria
            let q = db.collection("orders").limit(200);
            
            q.onSnapshot(snap => {
                document.getElementById("ordersError").style.display = "none";
                lastSnap = snap;
                renderList(snap);

                // Auto acciones
                let isInit = true; setTimeout(()=>isInit=false, 3000); // Hack carga inicial
                snap.docChanges().forEach(ch => {
                    if(ch.type === 'added' && !isInit){
                        playBeep();
                        setTimeout(playBeep, 200);
                        if(autoPrint) window.trySilentPrint(window.idToDoc.get(ch.doc.id)||ch.doc);
                    }
                });

            }, err => {
                console.error(err);
                document.getElementById("ordersError").style.display = "block";
            });
        } catch(e){ console.error(e); }
    })();

    /* --- RENDER LIST --- */
    function renderList(snap){
        let docs = snap.docs.map(d => ({ data: d.data(), id: d.id, ref: d }));
        
        // üî• ORDENAMOS NOSOTROS EN EL NAVEGADOR
        docs.sort((a,b) => {
            const dA = window.pickDocDate(a.data);
            const dB = window.pickDocDate(b.data);
            return dB - dA; // Descendente (m√°s nuevo primero)
        });

        // FILTRO
        const filtered = docs.filter(obj => {
            const s = obj.data.status || 'accepted';
            if(currentFilter === 'recibidos') return ['accepted','pending_payment','in_prep','ready'].includes(s);
            if(currentFilter === 'entregados') return s === 'delivered';
            if(currentFilter === 'cancelled') return s === 'cancelled';
            return true;
        });

        // Guardar mapa global para imprimir
        window.idToDoc = new Map(snap.docs.map(d=>[d.id,d]));

        const container = document.getElementById("orders");
        if(filtered.length === 0){
            container.innerHTML = '<p class="muted" style="text-align:center; padding:20px">No hay pedidos para mostrar.</p>';
            return;
        }
        container.innerHTML = filtered.map(x => renderOrderCard(x.ref)).join("");
    }

    function renderOrderCard(doc){
        const o = doc.data();
        const dt = window.pickDocDate(o);
        const time = dt.toLocaleTimeString("es-AR", {hour:'2-digit', minute:'2-digit'});
        
        // Estado
        const st = o.status || 'accepted';
        const isPaid = (o.payment_status === 'paid') || o.paid === true;
        
        // Botones de estado
        const STATES = ['accepted','in_prep','ready','delivered','cancelled'];
        const LABELS = {accepted:'Recibido', in_prep:'Cocina', ready:'Listo', delivered:'Entregado', cancelled:'Cancelar'};
        const currentIdx = STATES.indexOf(st);
        
        const btns = STATES.map((k, i) => {
            const active = (k === st) ? 'on' : '';
            // Bloqueo visual si es 'delivered' y no pagado? (opcional)
            return `<button class="state-btn state-${k} ${active}" onclick="setOrderStatus('${doc.id}', '${k}', ${isPaid})">${LABELS[k]}</button>`;
        }).join('');

        // Pago
        const payClass = isPaid ? 'is-paid' : 'is-pending';
        const payLabel = isPaid ? 'PAGADO ‚úì' : 'PENDIENTE $';
        // Fix select value
        let payVal = o.pago;
        if(payVal === 'mostrador_sin_especificar') payVal = "";

        // Render Items
        const items = Array.isArray(o.items) ? o.items : [];
        const cats = { burgers:[], fries:[], drinks:[], others:[] };
        items.forEach(it => {
            const n = (it.name||"").toLowerCase();
            const t = (it.type||"").toLowerCase();
            const q = it.qty || 1;
            if(t==='burger' || n.includes('hamburguesa')){
                cats.burgers.push(it);
                if(it.fries && it.fries!=='sin_papas') cats.fries.push({name:it.fries, qty:q});
            } else if(t==='side' || n.includes('papas')) cats.fries.push(it);
            else if(t==='drink' || n.includes('coca')) cats.drinks.push(it);
            else cats.others.push(it);
        });

        const renderSec = (list, icon, title) => {
            if(!list.length) return "";
            const rows = list.map(it => {
                let ex = [];
                if(it.extras?.patty) ex.push(`+${it.extras.patty} carne`);
                if(it.extras?.cheddar) ex.push(`+${it.extras.cheddar} cheddar`);
                
                // Normalizar nombre papas
                let dName = it.name;
                if(title.includes("PAPAS")){
                   const s = String(dName).toLowerCase().replace(/[_-]/g,' ');
                   if(s.includes('sazon')) dName="Sazonadas";
                   else if(s.includes('sin sal')) dName="Sin sal";
                   else if(s.includes('con sal') || s.includes('sal')) dName="Con sal";
                }

                return `<div class="item-row">
                   <div class="item-qty">${it.qty||1}</div>
                   <div class="item-det">
                      <div class="item-name">${dName}</div>
                      ${ex.length ? `<div class="extra-line">${ex.join(' ¬∑ ')}</div>` : ''}
                      ${it.notes ? `<div class="note-line">üìù ${it.notes}</div>` : ''}
                   </div>
                </div>`;
            }).join("");
            return `<div class="cat-section"><div class="cat-header">${icon} ${title}</div>${rows}</div>`;
        };

        const itemsHTML = 
             renderSec(cats.burgers, 'üçî', 'HAMBURGUESAS') +
             renderSec(cats.fries, 'üçü', 'GUARNICIONES / PAPAS') +
             renderSec(cats.drinks, 'ü•§', 'BEBIDAS') +
             renderSec(cats.others, 'üî∏', 'OTROS');

        // Calcular total
        const total = o.total || items.reduce((acc, i)=> acc + ((i.price||0)*(i.qty||1)), 0);

        return `
        <div class="order ${st==='cancelled'?'cancelled':''}">
           <div class="order-head">
              <div>
                 <div class="order-title">#${o.orderNumber || '---'} ‚Äî ${o.source==='mostrador' ? (o.nombre+' (Mostrador)') : o.nombre}</div>
                 <div class="muted">${time}</div>
                 <div class="chips">
                    <span class="chip">Retiro: ${o.entrega||'take_away'}</span>
                    ${o.pickup_time_pretty ? `<span class="chip">‚è∞ ${o.pickup_time_pretty}</span>` : ''}
                 </div>
                 <div class="stateBtns">${btns}</div>
              </div>
              <div>
                 <div class="right-total">${money(total)}</div>
                 <div class="pay-line">
                    <select class="btn" style="min-width:130px" onchange="updatePago('${doc.id}', this.value)">
                       <option value="" disabled ${!payVal?'selected':''}>M√©todo...</option>
                       <option value="efectivo" ${payVal==='efectivo'?'selected':''}>Efectivo</option>
                       <option value="mercado_pago" ${payVal==='mercado_pago'?'selected':''}>QR (MP)</option>
                       <option value="transferencia" ${payVal==='transferencia'?'selected':''}>Transferencia</option>
                    </select>
                    <button class="pay-toggle ${payClass}" onclick="setPaymentStatus('${doc.id}', ${!isPaid})">${payLabel}</button>
                    <button class="btn" onclick="printOrder('${doc.id}')">üñ®</button>
                 </div>
              </div>
           </div>
           <div class="items">${itemsHTML || '<div class="muted">Sin √≠tems</div>'}</div>
        </div>
        `;
    }

    /* --- TICKET IMPRESI√ìN (58mm) --- */
    window.trySilentPrint = function(docSnap){
       const o = docSnap.data();
       const escape = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
       const m = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
       
       const dt = window.pickDocDate(o);
       const dateStr = dt.toLocaleDateString("es-AR");
       const timeStr = dt.toLocaleTimeString("es-AR",{hour12:false});

       let payTxt = o.pago || "";
       if(payTxt === 'mostrador_sin_especificar') payTxt = "A COBRAR EN CAJA";
       if(payTxt === 'mercado_pago') payTxt = "QR (MP)";
       if(payTxt === 'efectivo') payTxt = "EFECTIVO";
       
       const isPaid = (o.payment_status === 'paid') || o.paid;
       const stPay = isPaid ? "PAGADO" : "PENDIENTE";

       // Procesar items ticket
       const items = Array.isArray(o.items) ? o.items : [];
       const cats = { b:[], f:[], d:[], o:[] };
       items.forEach(it => {
          const n = (it.name||"").toLowerCase();
          const t = (it.type||"").toLowerCase();
          const q = it.qty || 1;
          if(t==='burger' || n.includes('hamburguesa')){
             cats.b.push(it);
             if(it.fries && it.fries!=='sin_papas') cats.f.push({name:it.fries, qty:q});
          } else if(t==='side' || n.includes('papas')) cats.f.push(it);
          else if(t==='drink' || n.includes('coca')) cats.d.push(it);
          else cats.o.push(it);
       });
       
       const rSec = (l, ti) => {
         if(!l.length) return "";
         const r = l.map(i => {
            let dName = escape(i.name);
            if(ti.includes("PAPA")){
               const s = String(i.name).toLowerCase().replace(/[_-]/g,' ');
               if(s.includes('sazon')) dName="Sazonadas";
               else if(s.includes('sin sal')) dName="Sin sal";
               else if(s.includes('sal')) dName="Con sal";
            }
            let h = `<div class="row name"><div class="l">${i.qty||1} √ó ${dName}</div></div>`;
            if(!ti.includes("PAPA")){
               if(i.extras?.patty) h+=`<div class="sub">‚Ä¢ +${i.extras.patty} carne</div>`;
               if(i.extras?.cheddar) h+=`<div class="sub">‚Ä¢ +${i.extras.cheddar} cheddar</div>`;
            }
            if(i.notes) h+=`<div class="sub">üìù ${escape(i.notes)}</div>`;
            h+=`<div class="sep"></div>`;
            return h;
         }).join("");
         return `<div class="blk"><div class="lbl" style="border-bottom:1px solid #000;display:inline-block;margin-top:6px">${ti}</div></div>${r}`;
       };

       const body = rSec(cats.b,'HAMBURGUESAS') + rSec(cats.f,'PAPAS') + rSec(cats.d,'BEBIDAS') + rSec(cats.o,'OTROS');
       const note = o.comment || o.notes || "";
       const num = o.orderNumber ? `#${o.orderNumber}` : '---';
       const name = o.source==='mostrador' ? (o.nombre+' (Mostrador)') : o.nombre;
       const pickup = o.pickup_time_pretty || "A la brevedad";
       const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);

       const html = `
       <!doctype html><html><head><meta charset="utf-8"><style>
       @page{size:58mm auto;margin:0} body{width:58mm;margin:0 auto;padding:4px;font-family:Arial,sans-serif;font-size:13px;font-weight:700;color:#000;line-height:1.2}
       .c{text-align:center} .hr{border-top:1px dashed #000;margin:6px 0} .row{display:flex;justify-content:space-between}
       .lbl{font-size:10px;text-transform:uppercase} .sub{font-size:11px;margin-left:5px;font-weight:400} 
       .sep{border-top:1px dotted #999;margin:3px 0} .foot{margin-top:10px;text-align:center;font-size:10px;font-weight:400}
       </style></head><body>
         <div class="c" style="font-size:16px;margin-bottom:4px">Rhodes Burgers</div>
         <div class="c" style="font-size:14px">${num}</div>
         <div class="c" style="font-size:18px;margin:5px 0">[ ${stPay} ]</div>
         <div class="hr"></div>
         <div style="margin:4px 0"><span class="lbl">CLIENTE:</span> ${escape(name)}</div>
         <div class="c" style="font-size:16px;margin:6px 0;font-weight:900">Retira: ${escape(pickup)}</div>
         ${pagoTxt ? `<div style="margin:4px 0"><span class="lbl">PAGO:</span> ${pagoTxt}</div>` : ''}
         ${note ? `<div class="hr"></div><div><span class="lbl">NOTA:</span> ${escape(note)}</div>` : ''}
         <div class="hr"></div>
         ${body}
         <div class="hr"></div>
         <div class="row"><div class="l">TOTAL</div><div>${m(total)}</div></div>
         <div class="foot">${dateStr} ‚Äî ${timeStr}</div>
         <script>window.onload=()=>{setTimeout(()=>{window.print()},100)}<\/script>
       </body></html>`;
       
       const ifr = document.createElement('iframe');
       ifr.style.cssText='position:fixed;right:0;bottom:0;width:0;height:0;border:0';
       document.body.appendChild(ifr);
       const d = ifr.contentWindow.document;
       d.open(); d.write(html); d.close();
       setTimeout(()=>{ try{document.body.removeChild(ifr)}catch(e){} }, 15000);
    };

  });
  </script>
</body>
</html>
