<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel de pedidos - Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1100px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }

    .container{ max-width:1100px; margin:24px auto; padding:0 12px }
    h1{ font-size:28px; margin:10px 4px 14px }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .controls input, .controls select{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:10px }
    .cards{ display:grid; grid-template-columns:2fr 1fr; gap:16px; margin-top:12px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px }
    .order{ padding:12px 0; border-bottom:1px solid #efefef; display:flex; justify-content:space-between; gap:12px }
    .muted{ color:var(--muted) }
    .sumgrid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-top:12px }
    .sum{ background:#fff; border-radius:16px; padding:12px; box-shadow:var(--shadow) }
    table{ width:100%; border-collapse:collapse; margin-top:12px; background:#fff; border-radius:16px; overflow:hidden; box-shadow:var(--shadow) }
    th,td{ padding:10px 12px; border-bottom:1px solid #f0f0f0; text-align:left }
    th{ background:#fafafa; }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img src="images/logo.png" alt="Rhodes Burgers"></a>
      <strong>Panel de pedidos</strong>
      <div class="spacer"></div>
      <button class="btn" id="btnSound">ðŸ”” Activar sonido</button>
      <a class="btn ghost" href="index.html">MenÃº</a>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="controls">
        <label>Mes:
          <select id="selMes"></select>
        </label>
        <label>AÃ±o:
          <select id="selAnio"></select>
        </label>
        <input id="txtBuscar" placeholder="Buscar por nombre o texto" />
      </div>

      <div class="cards">
        <div class="card">
          <h1>Pedidos</h1>
          <div id="list"></div>
        </div>

        <div class="card">
          <h1>Totales del mes</h1>
          <div class="sumgrid">
            <div class="sum"><div class="muted">Cantidad</div><div id="tCant" style="font-weight:800;font-size:22px">0</div></div>
            <div class="sum"><div class="muted">Ingresos</div><div id="tMonto" style="font-weight:800;font-size:22px">$0</div></div>
          </div>

          <h1 style="margin-top:18px">Totales por mes (aÃ±o)</h1>
          <table id="tablaMeses">
            <thead><tr><th>Mes</th><th>Pedidos</th><th>Ingresos</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /*************** FIREBASE (tus credenciales) ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const $=s=>document.querySelector(s);
    const money=n=>n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    // Controles
    const selMes=$("#selMes"), selAnio=$("#selAnio"), txtBuscar=$("#txtBuscar");
    const list=$("#list"), tCant=$("#tCant"), tMonto=$("#tMonto");
    const tablaMeses=$("#tablaMeses tbody");

    // Poblar selects
    const meses=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const now=new Date(); const curM=now.getMonth(); const curY=now.getFullYear();
    selMes.innerHTML = meses.map((m,i)=>`<option value="${i}" ${i===curM?"selected":""}>${m}</option>`).join("");
    let yOpts=""; for(let y=curY-2;y<=curY+1;y++) yOpts+=`<option ${y===curY?"selected":""}>${y}</option>`;
    selAnio.innerHTML=yOpts;

    let unsub=null;
    let firstLoad=true;
    let lastIds=new Set();
    let soundEnabled=false;
    let ding;

    // Sonido
    $("#btnSound").onclick=async ()=>{
      try{
        ding = ding || new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        await ding.play(); // prueba
        ding.pause(); ding.currentTime=0;
        soundEnabled = true;
        $("#btnSound").textContent="ðŸ”” Sonido activado";
      }catch(e){ alert("Dale permiso al navegador para reproducir sonido."); }
    };

    function watch(){
      if(unsub) unsub();
      const y=+selAnio.value, m=+selMes.value;
      const start=new Date(y,m,1); const end=new Date(y,m+1,1);

      unsub = db.collection("orders")
        .where("createdAt",">=",start)
        .where("createdAt","<",end)
        .orderBy("createdAt","desc")
        .onSnapshot(snap=>{
          const orders=[];
          let cant=0, monto=0;

          snap.docChanges().forEach(ch=>{
            if(!firstLoad && ch.type==="added" && soundEnabled){
              // Nuevo pedido real
              (ding||new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg")).play().catch(()=>{});
            }
          });

          snap.forEach(doc=>{
            const o=doc.data(); o.id=doc.id;
            orders.push(o);
            cant += 1;
            monto += +o.total||0;
          });

          renderList(orders);
          tCant.textContent = String(cant);
          tMonto.textContent = money(monto);

          firstLoad=false;
        });

      // Totales por mes del aÃ±o
      buildYearTotals(+selAnio.value);
    }

    function renderList(orders){
      const q=txtBuscar.value.trim().toLowerCase();
      const rows=[];
      for(const o of orders){
        const fecha=o.createdAt?.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
        const line = `
          <div class="order">
            <div>
              <div><strong>${o.orderNumber || "(sin #)"}</strong> â€” ${o.nombre||""}</div>
              <div class="muted">${fecha.toLocaleDateString()} ${fecha.toLocaleTimeString()}</div>
              <div class="muted">Retiro: take_away â€¢ Papas: ${o.fries==="con_sazon"?"Con sazÃ³n":"Sin sazonar"}</div>
              <div class="muted">${(o.items||[]).map(i=>`â€¢ ${i.qty}Ã— ${i.name}`).join("<br>")}</div>
            </div>
            <div style="font-weight:800">${money(o.total||0)}</div>
          </div>`;
        if(!q || line.toLowerCase().includes(q)) rows.push(line);
      }
      list.innerHTML = rows.join("") || `<p class="muted">No hay pedidos para mostrar.</p>`;
    }

    async function buildYearTotals(year){
      const monthTotals = Array.from({length:12},()=>({c:0,m:0}));
      const start=new Date(year,0,1); const end=new Date(year+1,0,1);
      const snap = await db.collection("orders")
        .where("createdAt",">=",start)
        .where("createdAt","<",end)
        .get();
      snap.forEach(d=>{
        const o=d.data(); const dt=o.createdAt?.toDate ? o.createdAt.toDate() : new Date(o.createdAt);
        const mm=dt.getMonth();
        monthTotals[mm].c += 1;
        monthTotals[mm].m += +o.total||0;
      });
      tablaMeses.innerHTML = monthTotals.map((t,i)=>`<tr><td>${meses[i]}</td><td>${t.c}</td><td>${money(t.m)}</td></tr>`).join("");
    }

    selMes.onchange=watch; selAnio.onchange=watch; txtBuscar.oninput=()=>unsub && watch();
    watch();
  </script>
</body>
</html>
