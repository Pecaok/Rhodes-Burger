<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#444; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
      --font: Inter, system-ui, "Segoe UI", Roboto, Arial, "Helvetica Neue", "Noto Sans", sans-serif;
      --st-accepted:#FBC02D; --st-in_prep:#FB8C00; --st-ready:#00ACC1; --st-delivered:#2E7D32; --st-cancelled:#D32F2F;
      --pay-pending:#FFA000; --pay-paid:#625A45;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}

    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    .toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;background:#fff;font-weight:700}
    .muted{color:var(--muted)}
    input[type="date"]{padding:6px 10px;border:1px solid var(--ring);border-radius:10px;background:#fff}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .chipf{background:#f3f3f3;border:1px solid var(--ring);color:#111;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
    .chipf.active{background:var(--primary);color:#fff;border-color:var(--primary)}

    .order{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    .order-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
    .order-title{font-weight:800}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{background:#f3f3f3;border:1px solid var(--ring);color:#111;border-radius:999px;padding:6px 10px;font-size:13px}
    .right-total{font-weight:800;font-size:18px;white-space:nowrap}
    .items{margin-top:10px}
    .item{margin:8px 0 6px 0}
    .item .sub{color:#111;font-size:13px;margin-top:3px}
    .divider{height:1px;background:#efefef;margin:10px 0}
    .err{color:#b00020;font-weight:600}
    .stateBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .state-btn{border:2px solid #dcdcdc;background:#fff;color:#111;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer;min-width:160px;text-align:center}
    .state-btn.on{color:#fff;border-color:var(--primary);background:var(--primary)}
    .state-accepted.on{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .state-in_prep.on{background:var(--st-in_prep);border-color:var(--st-in_prep);color:#fff}
    .state-ready.on{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .state-delivered.on{background:var(--st-delivered);border-color:var(--st-delivered);color:#fff}
    .state-cancelled.on{background:var(--st-cancelled);border-color:var(--st-cancelled);color:#fff}

    .pay-line{margin-top:6px}
    .pay-pill{display:inline-block;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
    .pay-paid{background:var(--pay-paid);color:#fff}
    .pay-pending{background:var(--pay-pending);color:#fff}

    @media print{
      @page{size:A4 portrait;margin:12mm}
      header,.tabs,.stateBtns,.pay-line .btn,.danger,#btnBell,[title="Ver finanzas"],.toolbar{display:none!important}
      .order{break-inside:avoid;box-shadow:none;border:1px solid #eee}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Pedidos</a>
      <div class="spacer"></div>
      <a href="finanzas.html" class="btn" title="Ver finanzas">üìà Finanzas</a>
      <button id="btnBell" class="btn" title="Activar/desactivar sonido">üîî Sonido</button>
      <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <h1>√öltimos pedidos</h1>

    <!-- Jornada 19‚Üí19 -->
    <div class="toolbar">
      <span class="badge">Jornada&nbsp;<input id="dayPicker" type="date"></span>
      <button id="btnPrev" class="btn" title="D√≠a anterior">‚óÄ</button>
      <button id="btnNext" class="btn" title="D√≠a siguiente">‚ñ∂</button>
      <button id="btnToday" class="btn">Hoy</button>
      <span id="rangeLabel" class="badge muted">‚Äî</span>
    </div>

    <!-- Filtros -->
    <div class="tabs" id="tabs">
      <span class="chipf active" data-f="all">Todos</span>
      <span class="chipf" data-f="new">Nuevos</span>
      <span class="chipf" data-f="inprep_group">En preparaci√≥n</span>
      <span class="chipf" data-f="cancelled">Cancelados</span>
      <span class="chipf" data-f="cancelled_hist">Cancelados (hist√≥rico)</span>
    </div>

    <div id="orders"></div>
    <div id="ordersError" class="err" style="display:none;margin-top:8px"></div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  /* ================== CONFIG & LOGIN ================== */
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  const db = firebase.firestore();

  const $ = s => document.querySelector(s);

  $("#btnLogout").onclick=()=>{
    localStorage.clear();
    sessionStorage.clear();
    location.replace("login.html?reason=logout&next=pedido_local.html");
  };

  /* ================== AUDIO (beep) ================== */
  let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled")||"true");
  let audioCtx = null, audioReady = false;
  function getAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); return audioCtx; }
  async function ensureAudioReady(){ try{ const ctx=getAudioCtx(); if(ctx.state==='suspended') await ctx.resume(); audioReady=(ctx.state==='running'); }catch(e){ audioReady=false; } return audioReady; }
  function beepOnce(ctx, d=0.28, f=880, g=0.7){ const o=ctx.createOscillator(), ga=ctx.createGain(); o.type="square"; o.frequency.value=f; o.connect(ga); ga.connect(ctx.destination); ga.gain.setValueAtTime(0.0001, ctx.currentTime); ga.gain.exponentialRampToValueAtTime(g, ctx.currentTime+0.02); ga.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+d); o.start(); o.stop(ctx.currentTime+d+0.02); }
  async function playBeepTriple(){ if(!soundEnabled) return; const ok=await ensureAudioReady(); if(!ok) return; const ctx=getAudioCtx(); beepOnce(ctx,0.28,900,0.8); setTimeout(()=>beepOnce(ctx,0.28,900,0.8),350); setTimeout(()=>beepOnce(ctx,0.28,900,0.8),700); }
  ['click','touchstart','keydown'].forEach(evt=> window.addEventListener(evt, ()=>{ if(!audioReady) ensureAudioReady(); }, {passive:true}));
  const btnBell=$("#btnBell");
  const updateBellUI=()=>btnBell.classList.toggle("active",soundEnabled);
  updateBellUI();
  btnBell.onclick=()=>{ soundEnabled=!soundEnabled; localStorage.setItem("rb_bell_enabled", JSON.stringify(soundEnabled)); updateBellUI(); if(soundEnabled) playBeepTriple(); };

  /* ================== FECHA (jornada 19‚Üí19) ================== */
  const dayPicker = $("#dayPicker");
  const rangeLabel = $("#rangeLabel");
  const J_START_H = 19; // 19:00

  function yyyy_mm_dd(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function startOfJornada(d){
    const base = new Date(d);
    const sameDayStart = new Date(base.getFullYear(), base.getMonth(), base.getDate(), J_START_H, 0, 0, 0);
    if (base < sameDayStart) sameDayStart.setDate(sameDayStart.getDate()-1);
    return sameDayStart;
  }
  function rangeForDay(d){
    const start = startOfJornada(d);
    const end = new Date(start); end.setDate(end.getDate()+1);
    return {start,end};
  }
  function month19RangeFromAny(d){
    const y = d.getFullYear(), m = d.getMonth();
    const start = new Date(y,m,1,J_START_H,0,0,0);
    const end = new Date(y,m+1,1,J_START_H,0,0,0);
    return {start,end};
  }

  /* ================== ESTADO UI ================== */
  const tabs=$("#tabs");
  let currentFilter="all";
  tabs.addEventListener("click",(e)=>{
    const el=e.target.closest("[data-f]"); if(!el) return;
    currentFilter = el.dataset.f;
    tabs.querySelectorAll(".chipf").forEach(x=>x.classList.remove("active"));
    el.classList.add("active");
    refreshQuery();
  });

  (function initDay(){
    const today = new Date();
    try{ dayPicker.value = yyyy_mm_dd(today); }catch(_){}
    $("#btnToday").onclick = ()=>{ dayPicker.value = yyyy_mm_dd(new Date()); refreshQuery(); };
    $("#btnPrev").onclick  = ()=>{ const d=new Date(dayPicker.value); d.setDate(d.getDate()-1); dayPicker.value = yyyy_mm_dd(d); refreshQuery(); };
    $("#btnNext").onclick  = ()=>{ const d=new Date(dayPicker.value); d.setDate(d.getDate()+1); dayPicker.value = yyyy_mm_dd(d); refreshQuery(); };
    dayPicker.addEventListener("change", refreshQuery);
  })();

  /* ================== RENDER ORDENES ================== */
  const STATE_SEQ = ['accepted','in_prep','ready','delivered','cancelled'];
  const STATE_LABEL = {accepted:'Recibido', in_prep:'En preparaci√≥n', ready:'Listo para retirar', delivered:'Entregado', cancelled:'Cancelar'};
  const DISPLAY_LABEL = s => STATE_LABEL[s] || s;
  const friesName = f => f==="con_sazon" ? "Con saz√≥n" : (f==="sin_sazon" ? "Sin sazonar" : "");
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

  function pickDocDate(obj){
    const cand=['createdAt','date','fecha','timestamp','created_at','time'];
    for(const k of cand){
      const v=obj?.[k];
      if(v?.toDate) return v.toDate();
      if(typeof v==='number') return new Date(v);
      if(typeof v==='string'){ const d=new Date(v); if(!isNaN(d)) return d; }
    }
    return null;
  }
  function displayOrderNumber(doc){
    const o=doc.data();
    const c=[o.orderNumber,o.number,o.numero,o.num,o.numPedido,o.nro,o.orderNo,o.seq,o.n,o.idPedido,o.pedidoNumber,o.pedido];
    for(const v of c){ if(v==null) continue; const n=typeof v==="string"?parseInt(v,10):v; if(Number.isFinite(n)) return `#${n}`; }
    return `#${doc.id.slice(-5).toUpperCase()}`;
  }
  const computeOrderTotal = o => {
    if (typeof o.total === "number") return o.total;
    const items = Array.isArray(o.items)?o.items:[];
    return items.reduce((t,it)=>{
      const qty = it.qty||1;
      const base = (it.price||0)*qty;
      const patty = (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)*qty;
      const cheddar = (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0)*qty;
      return t + base + patty + cheddar;
    },0);
  };

  function renderOrder(doc){
    const o=doc.data(); const dt=pickDocDate(o);
    const dtText=dt? dt.toLocaleDateString('es-AR')+', '+dt.toLocaleTimeString('es-AR'):'‚Äî';
    const items=Array.isArray(o.items)?o.items:[];

    const lines=items.map(it=>{
      const qty=it.qty||1;
      const subtotal=(it.price||0)*qty
        + (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)*qty
        + (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0)*qty;
      return `<div class="item">
        <div>‚Ä¢ <strong>${qty}√ó ${it.name||''}</strong></div>
        <div class="sub">Papas: ${friesName(it.fries)}${it.notes?` ¬∑ Nota: ${it.notes}`:''}</div>
        <div class="sub">Subtotal: ${money(subtotal)}</div>
      </div>`;
    }).join("");

    const telChip=o.telefono?`<span class="chip">Tel: ${o.telefono}</span>`:"";
    const st=o.status??"accepted";
    const curIdx=Math.max(STATE_SEQ.indexOf(st),0);
    const stateBtns=`<div class="stateBtns">
      ${STATE_SEQ.map((key,idx)=>`<button class="state-btn state-${key} ${idx<=curIdx?'on':''}" data-act="${key}">${DISPLAY_LABEL(key)}</button>`).join('')}
    </div>`;

    const paymentPaid=(o.payment_status==='paid'||o.paid);
    const payLine=`<div class="pay-line">
      <span class="chip">Pago: ${o.pago||'‚Äî'}</span>
      <span class="pay-pill ${paymentPaid?'pay-paid':'pay-pending'}">${paymentPaid?'PAGADO':'PENDIENTE DE PAGO'}</span>
      <button class="btn" data-pay="${paymentPaid?'pending':'paid'}" style="margin-left:6px">${paymentPaid?'‚è≥ Marcar PENDIENTE':'‚úì Marcar PAGADO'}</button>
      <button class="btn" data-print>üñ® Imprimir</button>
    </div>`;

    return `<div class="order" data-id="${doc.id}">
      <div class="order-head">
        <div>
          <div class="order-title">${displayOrderNumber(doc)} ‚Äî ${o.nombre??'Cliente'}</div>
          <div class="muted">${dtText}</div>
          <div class="chips">
            <span class="chip">Pedido: ${displayOrderNumber(doc)}</span>
            <span class="chip">Estado: ${st}</span>
            <span class="chip">Retiro: ${o.entrega||'‚Äî'}</span>
            ${telChip}
          </div>
          ${stateBtns}
        </div>
        <div>
          <div class="right-total">${money(computeOrderTotal(o))}</div>
          ${payLine}
        </div>
      </div>
      <div class="divider"></div>
      <div class="items">${lines || '<div class="muted">Sin √≠tems.</div>'}</div>
    </div>`;
  }

  /* ================== ACCIONES ================== */
  async function setOrderStatus(id,next){
    try{
      await db.collection("orders").doc(id).update({
        status: next,
        statusHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()})
      });
    }catch(e){ alert("No se pudo actualizar el estado: "+(e?.message||e)); }
  }
  async function setPaymentStatus(id, paid){
    try{
      await db.collection("orders").doc(id).update({
        paid: !!paid,
        payment_status: paid ? "paid" : "pending_payment",
        statusHistory: firebase.firestore.FieldValue.arrayUnion({to: paid?"paid":"pending_payment", at:new Date().toISOString()})
      });
    }catch(e){ alert("No se pudo actualizar el pago: "+(e?.message||e)); }
  }

  /* ================== SUSCRIPCI√ìN SIN √çNDICES COMPUESTOS ================== */
  let unsubs = [];
  let unionMap = new Map();
  let initialLoaded=false;

  function updateRangeLabel(start,end){
    const fmt = new Intl.DateTimeFormat('es-AR',{dateStyle:'medium', timeStyle:'short'});
    $("#rangeLabel").textContent = `Mostrando: ${fmt.format(start)} ‚Üí ${fmt.format(end)}`;
  }

  function passFilterLocal(o){
    if(currentFilter==="all") return true;
    if(currentFilter==="new"){
      const s = (o.status??"accepted");
      return (s==="accepted" || s==="pending_payment");
    }
    if(currentFilter==="inprep_group"){
      const s = (o.status||"");
      return (s==="in_prep" || s==="ready" || s==="delivered");
    }
    if(currentFilter==="cancelled" || currentFilter==="cancelled_hist"){
      return (o.status==="cancelled");
    }
    return true;
  }

  function renderFromMap(range){
    const docs = Array.from(unionMap.values())
      .filter(d=>{
        const dt = pickDocDate(d.data());
        return dt && dt>=range.start && dt<range.end;
      })
      .filter(d=>passFilterLocal(d.data()))
      .sort((a,b)=>{
        const da=pickDocDate(a.data())?.getTime()||0;
        const db=pickDocDate(b.data())?.getTime()||0;
        return db-da;
      });

    document.getElementById("orders").innerHTML = docs.length ? docs.map(renderOrder).join("") : '<p class="muted">No hay pedidos.</p>';

    document.querySelectorAll(".order").forEach(card=>{
      const id=card.dataset.id;
      card.querySelectorAll("[data-act]").forEach(btn=>btn.addEventListener("click",()=>setOrderStatus(id,btn.dataset.act)));
      const payBtn=card.querySelector("[data-pay]");
      if(payBtn) payBtn.addEventListener("click",()=>setPaymentStatus(id,payBtn.dataset.pay==="paid"));
      const pr=card.querySelector("[data-print]");
      if(pr) pr.addEventListener("click",()=> printInIframe(unionMap.get(id)));
    });
  }

  function listenForField(field, range){
    try{
      const unsub = db.collection("orders")
        .orderBy(field, "desc")
        .limit(500)
        .onSnapshot(snap=>{
          document.getElementById("ordersError").style.display="none";
          document.getElementById("ordersError").textContent="";
          snap.docs.forEach(d=> unionMap.set(d.id, d));
          renderFromMap(range);
          if(initialLoaded){
            snap.docChanges().forEach(ch=>{ if(ch.type==='added'){ playBeepTriple(); }});
          }
          initialLoaded = true;
        }, err=>{
          // Muchos docs pueden no tener este campo: ignoramos el error de "FAILED_PRECONDITION: The query requires an index"
          console.warn(`[listener ${field}]`, err?.message||err);
        });
      unsubs.push(unsub);
    }catch(err){
      console.warn(`[listener ${field}]`, err?.message||err);
    }
  }

  function refreshQuery(){
    unsubs.forEach(u=>{ try{u()}catch(e){} }); unsubs=[];
    unionMap = new Map();
    initialLoaded=false;

    const picked = new Date($("#dayPicker").value+'T12:00:00');
    const range = (currentFilter==="cancelled_hist") ? month19RangeFromAny(picked) : rangeForDay(picked);
    updateRangeLabel(range.start, range.end);

    // escuchamos por m√∫ltiples campos de fecha sin where (no necesita √≠ndices)
    const FIELDS = ['createdAt','date','fecha','timestamp','created_at','time'];
    FIELDS.forEach(f=> listenForField(f, range));

    // fallback adicional por documentId (sin √≠ndices)
    try{
      const unsubAny = db.collection("orders")
        .orderBy(firebase.firestore.FieldPath.documentId(), "desc")
        .limit(300)
        .onSnapshot(snap=>{
          snap.docs.forEach(d=> unionMap.set(d.id, d));
          renderFromMap(range);
        }, err=> console.warn("[listener docId]", err?.message||err));
      unsubs.push(unsubAny);
    }catch(e){}
  }

  /* ==================== TICKET (impresi√≥n) ==================== */
  function buildTicketHTML(docSnap){
    const o = docSnap.data();
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const orderDisplay = (()=> {
      const c=[o.orderNumber,o.number,o.numero,o.num,o.numPedido,o.nro,o.orderNo,o.seq,o.n,o.idPedido,o.pedidoNumber,o.pedido];
      for(const v of c){ if(v==null) continue; const n=typeof v==="string"?parseInt(v,10):v; if(Number.isFinite(n)) return `#${n}`; }
      return `#${docSnap.id.slice(-5).toUpperCase()}`;
    })();
    const dt = pickDocDate(o) || new Date();
    const dateStr = dt.toLocaleDateString('es-AR');
    const timeStr = dt.toLocaleTimeString('es-AR',{hour12:false});

    const items = Array.isArray(o.items)?o.items:[];
    const friesStr = f => f==="con_sazon" ? "Con saz√≥n" : (f==="sin_sazon" ? "Sin sazonar" : "");

    const linesHTML = items.map(it=>{
      const qty = it.qty||1;
      const base = (it.price||0);
      const pattyCount = it.extras?.patty||0;
      const pattyUnit  = it.extras?.EXTRA_PRICE_PATTY||0;
      const pattySum   = qty * pattyCount * pattyUnit;
      const cheddarCount = it.extras?.cheddar||0;
      const cheddarUnit  = it.extras?.EXTRA_PRICE_CHEDDAR||0;
      const cheddarSum   = qty * cheddarCount * cheddarUnit;
      const baseSubtotal = base * qty;
      const lineTotal    = baseSubtotal + pattySum + cheddarSum;
      return `
        <div class="row name"><div class="l">${qty} √ó ${it.name||''}</div></div>
        ${it.fries ? `<div class="sub">‚Ä¢ Papas: ${friesStr(it.fries)}</div>` : ''}
        <div class="row amount"><div class="l"></div><div class="r">${money(baseSubtotal)}</div></div>
        ${cheddarCount ? `<div class="sub ex">‚Ä¢ +${cheddarCount} √ó Cheddar ‚Äî ${money(cheddarSum)}</div>`:''}
        ${pattyCount ? `<div class="sub ex">‚Ä¢ +${pattyCount} √ó Medall√≥n extra ‚Äî ${money(pattySum)}</div>`:''}
        ${it.notes ? `<div class="sub">‚Ä¢ Nota: ${it.notes}</div>` : ''}
        <div class="row amount final"><div class="l"></div><div class="r">${money(lineTotal)}</div></div>
        <div class="sep"></div>
      `;
    }).join('') || '<div class="sub">Sin √≠tems.</div>';

    const total = (()=>{
      if(typeof o.total==='number') return o.total;
      return items.reduce((t,it)=>{
        const qty = it.qty||1;
        const base = (it.price||0)*qty;
        const patty = (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)*qty;
        const cheddar = (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0)*qty;
        return t + base + patty + cheddar;
      },0);
    })();

    return `
<!doctype html>
<html><head><meta charset="utf-8"><title>Ticket ${orderDisplay}</title>
<style>
  @page{ size:58mm auto; margin:0; }
  html,body{margin:0;padding:0;color:#000;}
  *{-webkit-print-color-adjust:exact; print-color-adjust:exact; -webkit-text-size-adjust:100%;}
  body{ font-family: Arial, sans-serif; font-size:13px; font-weight:700; line-height:1.45; }
  .ticket{ width:48mm; margin:0 auto; padding:2mm 3mm 2mm 2mm; box-sizing:border-box; }
  .c{text-align:center}
  .brand{ font-size:16px; }
  .orderNo{ font-size:14px; margin:1mm 0 }
  .hr{ border-top:1px solid #000; margin:4px 0 }
  .lbl{ font-size:11px; text-transform:uppercase; }
  .blk{ margin:2px 0 2mm 0; }
  .row{ display:flex; justify-content:space-between; gap:4px; }
  .row .l{ flex:1 1 auto; min-width:0; }
  .row .r{ flex:0 0 auto; text-align:right; min-width:18mm; padding-left:1.5mm; white-space:nowrap; }
  .row.name .r{ display:none; }
  .row.amount .l{ display:block; }
  .row.amount.final{ margin-top:3px; }
  .sub{ font-size:11px; margin:1px 0 0 2mm; }
  .sub.ex{ white-space:nowrap; }
  .sep{ border-top:1px dashed #000; opacity:.5; margin:2mm 0 1.2mm 0; }
  .total{ font-size:16px; margin-top:3mm; }
  .foot{ margin-top:3mm; text-align:center; font-size:10px; font-weight:400; }
</style>
</head>
<body>
  <div class="ticket">
    <div class="c brand">Rhodes Burgers</div>
    <div class="orderNo c">${orderDisplay}</div>
    <div class="hr"></div>
    ${o.nombre? `<div class="blk"><div class="lbl">CLIENTE</div><div>${o.nombre}</div></div>`:''}
    ${(o.pago||o.payment_method)? `<div class="blk"><div class="lbl">MEDIO DE PAGO</div><div>${(o.pago||o.payment_method)||''}</div></div>`:''}
    <div class="hr"></div>
    ${linesHTML}
    <div class="hr"></div>
    <div class="row total"><div class="l">TOTAL</div><div class="r">${money(total)}</div></div>
    <div class="foot">${dateStr} ‚Äî ${timeStr}</div>
  </div>
  <script>window.addEventListener('load', () => { setTimeout(() => { window.print(); }, 30); });<\/script>
</body>
</html>`;
  }
  function printInIframe(docSnap){
    const html = buildTicketHTML(docSnap);
    const iframe = document.createElement('iframe');
    Object.assign(iframe.style,{position:'fixed',right:'0',bottom:'0',width:'0',height:'0',border:'0'});
    iframe.setAttribute('aria-hidden','true');
    document.body.appendChild(iframe);
    const doc = iframe.contentWindow.document;
    doc.open(); doc.write(html); doc.close();
    const cleanup = () => { try{ document.body.removeChild(iframe); }catch(e){} };
    iframe.contentWindow.onafterprint = () => setTimeout(cleanup, 150);
    setTimeout(cleanup, 15000);
  }

  /* ================== ARRANQUE ================== */
  refreshQuery();
  </script>
</body>
</html>
