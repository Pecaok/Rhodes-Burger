<!doctype html>
<html lang="es">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
Â  <title>Pedidos â€¢ Rhodes Burgers</title>
Â  <link rel="icon" href="images/logo.png" />
Â  <link rel="manifest" href="manifest.json">
Â  <meta name="theme-color" content="#625A45" />

Â  <link rel="preconnect" href="https://fonts.googleapis.com">
Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

Â  <style>
Â  Â  :root{
Â  Â  Â  --primary: #625A45; --primary-dark: #4a4434;
Â  Â  Â  --text: #1f2937; --muted: #6b7280; --bg: #f3f4f6; --card: #ffffff;
Â  Â  Â  --ring: #e5e7eb; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
Â  Â  Â  --font: 'Inter', sans-serif;
Â  Â  Â Â 
Â  Â  Â  /* Colores Estado */
Â  Â  Â  --st-accepted: #fbbf24;Â 
Â  Â  Â  --st-in_prep: #f97316;Â 
Â  Â  Â  --st-ready: #06b6d4;Â 
Â  Â  Â  --st-delivered: #22c55e;Â 
Â  Â  Â  --st-cancelled: #ef4444;Â 
Â  Â  Â  --pay-paid: #15803d; --pay-pending: #ea580c;
Â  Â  }

Â  Â  *{box-sizing:border-box}
Â  Â  body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font); -webkit-tap-highlight-color: transparent;}
Â  Â Â 
Â  Â  /* --- HEADER UNIFICADO --- */
Â  Â  header { position: sticky; top: 0; z-index: 1000; background: #fff; border-bottom: 1px solid var(--ring); }
Â  Â Â 
Â  Â  .topbar {
Â  Â  Â  Â  max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 12px;
Â  Â  Â  Â  display: flex; align-items: center; gap: 6px;
Â  Â  Â  Â  /* IMPORTANTE: Quitamos el overflow para que el dropdown se vea */
Â  Â  Â  Â  overflow: visible;Â 
Â  Â  }

Â  Â  .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; text-decoration: none; margin-right: 5px; flex-shrink: 0; }
Â  Â  .brand img { width: 32px; height: 32px; border-radius: 6px; margin-right: 8px; }
Â  Â Â 
Â  Â  .spacer { flex: 1; }

Â  Â  .nav-btn {
Â  Â  Â  Â  padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #4b5563; font-weight: 600; font-size: 14px;Â 
Â  Â  Â  Â  transition: all 0.2s; border: 1px solid transparent; flex-shrink: 0; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; background: transparent;
Â  Â  }
Â  Â  .nav-btn:hover { background: #f9fafb; }
Â  Â  .nav-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 5px rgba(98, 90, 69, 0.3); }
Â  Â Â 
Â  Â  .icon-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid var(--ring); background: #fff; cursor: pointer; font-size: 16px; flex-shrink: 0; transition: all 0.2s; }
Â  Â  .icon-btn:hover { background: #f0f0f0; }
Â  Â Â 
Â  Â  .btn-danger { color: #d32f2f; background: #ffebee; border: 1px solid #ffcdd2; }

Â  Â  /* DROPDOWN MENU */
Â  Â  .dropdown { position: relative; display: inline-block; }
Â  Â  .dropdown-content {Â 
Â  Â  Â  Â  display: none; position: absolute; background-color: #fff; min-width: 160px;Â 
Â  Â  Â  Â  box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-radius: 12px; border: 1px solid var(--ring);Â 
Â  Â  Â  Â  z-index: 2000; top: 115%; right: 0;Â 
Â  Â  Â  Â  padding: 5px;Â 
Â  Â  }
Â  Â  .dropdown.show .dropdown-content { display: block; animation: slideDown 0.2s ease; }
Â  Â  .dropdown-content a { display: block; padding: 10px; text-decoration: none; color: #374151; font-size: 14px; font-weight: 500; border-radius: 8px; }
Â  Â  .dropdown-content a:hover { background: #f3f4f6; color: var(--primary); }
Â  Â  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

Â  Â  /* --- CONTENEDOR --- */
Â  Â  .container { max-width: 800px; margin: 20px auto; padding: 0 16px; padding-bottom: 80px; }
Â  Â  h1 { font-size: 24px; font-weight: 800; color: #111; margin-bottom: 16px; }

Â  Â  /* TABS */
Â  Â  .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
Â  Â  .tab { padding: 8px 16px; border-radius: 99px; background: #fff; border: 1px solid var(--ring); color: #6b7280; font-weight: 600; font-size: 13px; cursor: pointer; white-space: nowrap; flex-shrink: 0; }
Â  Â  .tab.active { background: #1f2937; color: #fff; border-color: #1f2937; }

Â  Â  /* TARJETA */
Â  Â  .order { background: #fff; border-radius: 16px; box-shadow: var(--shadow); margin-bottom: 20px; overflow: hidden; border: 1px solid var(--ring); animation: fadeIn 0.3s ease-out; }
Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

Â  Â  .order-head { padding: 16px; border-bottom: 1px dashed var(--ring); display: flex; justify-content: space-between; align-items: flex-start; }
Â  Â  .order-title { font-size: 18px; font-weight: 800; color: #111; line-height: 1.2; }
Â  Â  .order-meta { font-size: 13px; color: var(--muted); margin-top: 4px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
Â  Â Â 
Â  Â  .chip { padding: 2px 8px; border-radius: 6px; background: #f3f4f6; font-weight: 600; font-size: 11px; color: #374151; }
Â  Â  .chip.mostrador { background: #e0f2fe; color: #0369a1; }
Â  Â  .chip.time { background: #fef3c7; color: #92400e; }
Â  Â  .price-tag { font-size: 20px; font-weight: 900; color: var(--primary); white-space: nowrap; }

Â  Â  /* ITEMS */
Â  Â  .items { padding: 16px; background: #fafafa; }
Â  Â  .cat-group { margin-bottom: 12px; }
Â  Â  .cat-title { font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; margin-bottom: 6px; display: flex; align-items: center; gap: 4px; }
Â  Â  .it-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-start; }
Â  Â  .it-qty { background: #fff; border: 1px solid var(--ring); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: 700; font-size: 13px; color: #111; box-shadow: 0 1px 2px rgba(0,0,0,0.05); flex-shrink: 0; }
Â  Â  .it-det { flex: 1; }
Â  Â  .it-name { font-weight: 600; font-size: 15px; color: #374151; line-height: 1.3; }
Â  Â  .it-sub { font-size: 13px; color: #6b7280; }
Â  Â  .it-note { font-size: 12px; color: #ef4444; font-weight: 600; background: #fef2f2; display: inline-block; padding: 2px 6px; border-radius: 4px; margin-top: 2px; }

Â  Â  /* ACTIONS */
Â  Â  .actions-area { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
Â  Â  .stateBtns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
Â  Â  .state-btn { padding: 10px 4px; border: 1px solid var(--ring); background: #fff; color: #6b7280; border-radius: 10px; font-weight: 600; font-size: 11px; cursor: pointer; text-align: center; transition: all 0.15s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
Â  Â  .state-btn:active { transform: scale(0.96); }
Â  Â Â 
Â  Â  .state-btn.on.state-accepted { background: var(--st-accepted); color: #000; border-color: var(--st-accepted); box-shadow: 0 4px 10px rgba(251, 191, 36, 0.3); }
Â  Â  .state-btn.on.state-in_prep { background: var(--st-in_prep); color: #fff; border-color: var(--st-in_prep); box-shadow: 0 4px 10px rgba(249, 115, 22, 0.3); }
Â  Â  .state-btn.on.state-ready { background: var(--st-ready); color: #fff; border-color: var(--st-ready); box-shadow: 0 4px 10px rgba(6, 182, 212, 0.3); }
Â  Â  .state-btn.on.state-delivered { background: var(--st-delivered); color: #fff; border-color: var(--st-delivered); box-shadow: 0 4px 10px rgba(34, 197, 94, 0.3); }
Â  Â  .state-btn.cancelled { grid-column: span 4; border-color: #fee2e2; color: #ef4444; margin-top: 5px; }

Â  Â  .pay-toolbar { display: flex; gap: 8px; }
Â  Â  .pay-select { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--ring); font-size: 14px; background: #fff; -webkit-appearance: none; }
Â  Â  .pay-btn { padding: 0 16px; border-radius: 10px; border: none; font-weight: 700; font-size: 13px; color: #fff; display: flex; align-items: center; gap: 6px; cursor: pointer; flex: 1; justify-content: center; }
Â  Â  .pay-btn.pending { background: var(--pay-pending); }
Â  Â  .pay-btn.paid { background: var(--pay-paid); }
Â  Â  .icon-btn-lg { width: 42px; height: 42px; border-radius: 10px; border: 1px solid var(--ring); background: #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; flex-shrink: 0; }

Â  Â  /* MEDIA QUERIES PARA CELULARES (Fix del Header) */
Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  .brand span { display: none; } /* Ocultar texto "Pedidos" del logo */
Â  Â  Â  Â  .nav-btn { padding: 8px; font-size: 12px; } /* Botones mÃ¡s chicos */
Â  Â  Â  Â  .nav-btn span { display: none; } /* Opcional: Ocultar texto botones si no entran */
Â  Â  Â  Â  .dropdown { position: static; } /* Truco para dropdown full width si se quiere, o dejar relative */
Â  Â  Â  Â Â 
Â  Â  Â  Â  .order-head { flex-direction: column; gap: 10px; }
Â  Â  Â  Â  .price-tag { align-self: flex-end; margin-top: -30px; }
Â  Â  Â  Â  .stateBtns { grid-template-columns: 1fr 1fr; }
Â  Â  Â  Â  .pay-toolbar { flex-wrap: wrap; }
Â  Â  Â  Â  .pay-select { min-width: 100%; }
Â  Â  }
Â  Â  .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
Â  </style>

Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

Â  <script>
Â  Â  const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
Â  Â  try{ firebase.initializeApp(firebaseConfig); }catch(e){ console.error("Error Firebase:", e); }
Â  Â  const db = firebase.firestore();
Â  Â  window.idToDoc = new Map();

Â  Â  const TTL_MS = 20 * 60 * 60 * 1000;
Â  Â  function checkSession(){
Â  Â  Â  const ok = localStorage.getItem('rb_admin_ok')==='true';
Â  Â  Â  const ts = Number(localStorage.getItem('rb_admin_t')||0);
Â  Â  Â  if(!ok || (Date.now()-ts > TTL_MS)) location.replace('login.html');
Â  Â  Â  else localStorage.setItem('rb_admin_t', String(Date.now()));
Â  Â  }
Â  Â  checkSession(); setInterval(checkSession, 5*60*1000);

Â  Â  // =================================================================
Â  Â  // ğŸ”¥ SISTEMA DE STOCK INTELIGENTE ğŸ”¥
Â  Â  // =================================================================
Â  Â  let RECETAS_DB = {};Â 
Â  Â  let INVENTARIO_DB = {};Â 

Â  Â  db.collection('recipes').onSnapshot(snap => {
Â  Â  Â  Â  RECETAS_DB = {};
Â  Â  Â  Â  snap.forEach(doc => { RECETAS_DB[doc.id] = doc.data().ingredients; });
Â  Â  });

Â  Â  db.collection('inventory').onSnapshot(snap => {
Â  Â  Â  Â  INVENTARIO_DB = {};
Â  Â  Â  Â  snap.forEach(doc => {Â 
Â  Â  Â  Â  Â  Â  INVENTARIO_DB[doc.data().name.trim().toLowerCase()] = doc.id;Â 
Â  Â  Â  Â  });
Â  Â  });

Â  Â  function findSmartId(keywords) {
Â  Â  Â  Â  const stockNames = Object.keys(INVENTARIO_DB);
Â  Â  Â  Â  for (const key of keywords) {
Â  Â  Â  Â  Â  Â  if (INVENTARIO_DB[key.toLowerCase()]) return INVENTARIO_DB[key.toLowerCase()];
Â  Â  Â  Â  }
Â  Â  Â  Â  for (const stockName of stockNames) {
Â  Â  Â  Â  Â  Â  for (const key of keywords) {
Â  Â  Â  Â  Â  Â  Â  Â  if (stockName.includes(key.toLowerCase())) return INVENTARIO_DB[stockName];
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return null;
Â  Â  }

Â  Â  async function gestionarStock(pedido, factor) {
Â  Â  Â  Â  if (!pedido.items) return;
Â  Â  Â  Â  if(factor === -1 && pedido.stockDescontado) return;
Â  Â  Â  Â  if(factor === 1 && !pedido.stockDescontado) return;

Â  Â  Â  Â  console.log(`ğŸ“Š STOCK update (${factor}) pedido #${pedido.orderNumber}`);
Â  Â  Â  Â  const batch = db.batch();
Â  Â  Â  Â  let huboCambios = false;

Â  Â  Â  Â  pedido.items.forEach(item => {
Â  Â  Â  Â  Â  Â  const prodName = item.name.trim();Â 
Â  Â  Â  Â  Â  Â  const prodNameLower = prodName.toLowerCase();
Â  Â  Â  Â  Â  Â  const qtyPedida = Number(item.qty || 1);

Â  Â  Â  Â  Â  Â  let ingredientes = RECETAS_DB[prodName];
Â  Â  Â  Â  Â  Â  if (!ingredientes) {
Â  Â  Â  Â  Â  Â  Â  Â  const key = Object.keys(RECETAS_DB).find(k => prodName.includes(k));
Â  Â  Â  Â  Â  Â  Â  Â  if(key) ingredientes = RECETAS_DB[key];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (ingredientes) {
Â  Â  Â  Â  Â  Â  Â  Â  ingredientes.forEach(ing => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let ingID = INVENTARIO_DB[ing.ingrediente.trim().toLowerCase()];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!ingID) ingID = findSmartId([ing.ingrediente]);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ingID) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ref = db.collection('inventory').doc(ingID);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delta = Number(ing.cantidad) * qtyPedida * factor;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(ref, { qty: firebase.firestore.FieldValue.increment(delta) });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  huboCambios = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(item.extras){
Â  Â  Â  Â  Â  Â  Â  Â  for (const [key, valRaw] of Object.entries(item.extras)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = Number(valRaw);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (val > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let searchTerms = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let amountPerUnit = 1;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (key === 'patty') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (prodNameLower.includes('pollo') || prodNameLower.includes('crispy')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  searchTerms = ['medallÃ³n de pollo', 'pollo', 'crispy'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  searchTerms = ['carne', 'medallon', 'patty'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (key === 'cheddar') { searchTerms = ['cheddar', 'queso']; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (key === 'bacon') { searchTerms = ['bacon', 'panceta']; amountPerUnit = 0.03; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (key === 'brioche') { searchTerms = ['brioche', 'pan brioche']; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else { searchTerms = [key]; }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ingID = findSmartId(searchTerms);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ingID) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ref = db.collection('inventory').doc(ingID);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delta = amountPerUnit * val * factor;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(ref, { qty: firebase.firestore.FieldValue.increment(delta) });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  huboCambios = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const esBurger = prodNameLower.includes('hamburguesa') || prodNameLower.includes('burger') || prodNameLower.includes('doble') || prodNameLower.includes('simple') || prodNameLower.includes('royal') || prodNameLower.includes('crispy') || prodNameLower.includes('cuarto') || prodNameLower.includes('big');
Â  Â  Â  Â  Â  Â  if (esBurger) {
Â  Â  Â  Â  Â  Â  Â  Â  const papasID = findSmartId(['papas', 'bastones', 'papas fritas', 'congeladas', 'bolsa de papas']);
Â  Â  Â  Â  Â  Â  Â  Â  if (papasID) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ref = db.collection('inventory').doc(papasID);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deltaPapas = 0.2 * qtyPedida * factor;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch.update(ref, { qty: firebase.firestore.FieldValue.increment(deltaPapas) });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  huboCambios = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (huboCambios) {
Â  Â  Â  Â  Â  Â  const pedidoRef = db.collection('orders').doc(pedido.id);
Â  Â  Â  Â  Â  Â  batch.update(pedidoRef, { stockDescontado: (factor === -1) });
Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  console.log("âœ… Stock actualizado.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // GLOBALES
Â  Â  window.logout = () => { localStorage.removeItem('rb_admin_ok'); location.replace('login.html'); };

Â  Â  window.setOrderStatus = async (id, next, isPaid) => {
Â  Â  Â  Â  if(next==='delivered' && !isPaid){ alert("âš ï¸ COBRAR PRIMERO: El pedido figura pendiente."); return; }
Â  Â  Â  Â  try{Â 
Â  Â  Â  Â  Â  Â  const docSnap = await db.collection('orders').doc(id).get();
Â  Â  Â  Â  Â  Â  if(!docSnap.exists) return;
Â  Â  Â  Â  Â  Â  const pedidoData = { id: docSnap.id, ...docSnap.data() };

Â  Â  Â  Â  Â  Â  if(next === 'delivered'){ await gestionarStock(pedidoData, -1); }Â 
Â  Â  Â  Â  Â  Â  else if(next === 'cancelled'){ await gestionarStock(pedidoData, 1); }

Â  Â  Â  Â  Â  Â  await db.collection("orders").doc(id).update({status:next});Â 
Â  Â  Â  Â  }catch(e){console.error(e);}
Â  Â  };

Â  Â  window.setPaymentStatus = async (id, currentPaid, currentMethod) => {
Â  Â  Â  Â  if(!currentPaid && (!currentMethod || currentMethod === "")){Â 
Â  Â  Â  Â  Â  Â  alert("âš ï¸ SeleccionÃ¡ un MÃ‰TODO DE PAGO primero."); return;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  try{ await db.collection("orders").doc(id).update({ paid: !currentPaid, payment_status: !currentPaid ? 'paid' : 'pending_payment' }); }catch(e){}
Â  Â  };
Â  Â Â 
Â  Â  window.updatePago = async (id, val) => { try{ await db.collection("orders").doc(id).update({pago:val}); }catch(e){} };
Â  Â  window.printOrder = (id) => { const doc = window.idToDoc.get(id); if(doc) window.trySilentPrint(doc); };
Â  Â  window.pickDate = (o) => { if(o.createdAt?.toDate) return o.createdAt.toDate(); if(typeof o.createdAt==='string') return new Date(o.createdAt); return new Date(); };
Â  Â  window.cleanFries = (raw) => { if(!raw) return ""; const s = String(raw).toLowerCase().replace(/[_-]/g,' ').trim(); if(s.includes('sazon')) return "Sazonadas"; if(s.includes('sin sal')) return "Sin sal"; if(s.includes('con sal')||s.includes('sal')) return "Con sal"; return s.charAt(0).toUpperCase() + s.slice(1); };
Â  Â  window.getCat = (item) => { const n = (item.name||"").toLowerCase(); const t = (item.type||"").toLowerCase(); if(t==='burger' || n.includes('hamburguesa') || n.includes('doble') || n.includes('simple') || n.includes('crispy')) return 'b'; if(t==='side' || n.includes('papas') || n.includes('fritas') || n.includes('sazon') || n.includes('sin sal') || n.includes('con sal')) return 'f'; if(t==='drink' || n.includes('coca') || n.includes('agua') || n.includes('cerveza')) return 'd'; return 'o'; };
Â  </script>
</head>

<body>
Â  <header>
Â  Â  <div class="topbar">
Â  Â  Â  <a class="brand" href="#"><img src="images/logo.png" alt=""><span>Pedidos</span></a>
Â  Â  Â Â 
Â  Â  Â  <div class="spacer"></div>

Â  Â  Â  <a href="pedido_local.html" class="nav-btn active">ğŸ“¦ Pedidos</a>
Â  Â  Â  <a href="finanzas.html" class="nav-btn">ğŸ“ˆ Finanzas</a>
Â  Â  Â Â 
Â  Â  Â  <div class="dropdown">
Â  Â  Â  Â  Â  Â  <button onclick="document.querySelector('.dropdown').classList.toggle('show')" class="nav-btn">ğŸ“‹ Stock â–¾</button>
Â  Â  Â  Â  Â  Â  <div class="dropdown-content">
Â  Â  Â  Â  Â  Â  Â  Â  <a href="stock.html">ğŸ“¦ Stock</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="ingresos.html">ğŸ“¥ Ingresos</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  <a href="mostrador.html" class="nav-btn">ğŸ§¾ Mostrador</a>
Â  Â  Â  <a href="admin.html" class="nav-btn">âš™ï¸ Admin</a>
Â  Â  Â Â 
Â  Â  Â  <button id="btnBell" class="icon-btn" title="Sonido">ğŸ””</button>
Â  Â  Â  <button id="btnAutoPrint" class="icon-btn" title="Autoimprimir">ğŸ–¨ï¸</button>
Â  Â  Â  <button onclick="window.logout()" class="nav-btn btn-danger">Salir</button>
Â  Â  </div>
Â  </header>

Â  <main class="container">
Â  Â  <h1>Ãšltimos pedidos</h1>
Â  Â  <div class="tabs" id="tabs">
Â  Â  Â  <button class="tab active" data-f="recibidos">Cocina / Recibidos</button>
Â  Â  Â  <button class="tab" data-f="entregados">Entregados</button>
Â  Â  Â  <button class="tab" data-f="cancelled">Cancelados</button>
Â  Â  Â  <button class="tab" data-f="all">Todos</button>
Â  Â  </div>
Â  Â  <div id="orders"><div class="empty-state">Cargando...</div></div>
Â  </main>

Â  <script>
Â  window.addEventListener('DOMContentLoaded', () => {
Â  Â  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
Â  Â  let currentFilter = "recibidos"; let lastSnap = null;
Â  Â Â 
Â  Â  document.getElementById("tabs").addEventListener("click", (e)=>{
Â  Â  Â  Â  const btn = e.target.closest(".tab"); if(!btn) return;
Â  Â  Â  Â  document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
Â  Â  Â  Â  btn.classList.add("active");
Â  Â  Â  Â  currentFilter = btn.dataset.f;
Â  Â  Â  Â  if(window.lastSnap) renderList(window.lastSnap);
Â  Â  });

Â  Â  const btnBell = document.getElementById("btnBell");
Â  Â  let soundOn = JSON.parse(localStorage.getItem("rb_sound")||"true");
Â  Â  const updBell = ()=>{ btnBell.classList.toggle("active", soundOn); }; updBell();
Â  Â  btnBell.onclick = ()=>{ soundOn=!soundOn; localStorage.setItem("rb_sound", soundOn); updBell(); };

Â  Â  const btnAP = document.getElementById("btnAutoPrint");
Â  Â  let autoP = JSON.parse(localStorage.getItem("rb_autop")||"false");
Â  Â  const updAP = ()=>{ btnAP.classList.toggle("active", autoP); }; updAP();
Â  Â  btnAP.onclick = ()=>{ autoP=!autoP; localStorage.setItem("rb_autop", autoP); updAP(); };

Â  Â  const playBeep = ()=>{
Â  Â  Â  Â  if(!soundOn) return;
Â  Â  Â  Â  try{ const c=new(window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(); const g=c.createGain();
Â  Â  Â  Â  o.type="square"; o.frequency.value=750; o.connect(g); g.connect(c.destination);
Â  Â  Â  Â  o.start(); g.gain.exponentialRampToValueAtTime(0.00001, c.currentTime+0.2); o.stop(c.currentTime+0.2); }catch(e){}
Â  Â  };

Â  Â  let isInit=true; setTimeout(()=>isInit=false, 3000);
Â  Â  db.collection("orders").orderBy("orderNumber", "desc").limit(300).onSnapshot(snap => {
Â  Â  Â  Â  window.lastSnap = snap;
Â  Â  Â  Â  renderList(snap);
Â  Â  Â  Â  snap.docChanges().forEach(ch => {
Â  Â  Â  Â  Â  Â  if(ch.type==='added' && !isInit){
Â  Â  Â  Â  Â  Â  Â  Â  if(navigator.vibrate) navigator.vibrate(200);
Â  Â  Â  Â  Â  Â  Â  Â  playBeep();Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(autoP) window.trySilentPrint(window.idToDoc.get(ch.doc.id));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }, err => {
Â  Â  Â  Â  document.getElementById("orders").innerHTML = `<div class="empty-state" style="color:red">Error: ${err.message}</div>`;
Â  Â  });

Â  Â  function renderList(snap){
Â  Â  Â  Â  let docs = snap.docs.map(d => ({ data: d.data(), id: d.id, ref: d }));
Â  Â  Â  Â  window.idToDoc = new Map(snap.docs.map(d=>[d.id,d]));
Â  Â  Â  Â  docs.sort((a,b) => window.pickDate(b.data) - window.pickDate(a.data));

Â  Â  Â  Â  const filtered = docs.filter(o => {
Â  Â  Â  Â  Â  Â  const s = o.data.status || 'accepted';
Â  Â  Â  Â  Â  Â  if(currentFilter === 'recibidos') return ['accepted','in_prep','ready','pending_payment'].includes(s);
Â  Â  Â  Â  Â  Â  if(currentFilter === 'entregados') return s === 'delivered';
Â  Â  Â  Â  Â  Â  if(currentFilter === 'cancelled') return s === 'cancelled';
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  });

Â  Â  Â  Â  const cont = document.getElementById("orders");
Â  Â  Â  Â  if(filtered.length===0){ cont.innerHTML = '<div class="empty-state">No hay pedidos en esta secciÃ³n.</div>'; return; }
Â  Â  Â  Â  cont.innerHTML = filtered.map(x => buildOrderHTML(x.ref)).join("");
Â  Â  }

Â  Â  function buildOrderHTML(doc){
Â  Â  Â  Â  const o = doc.data();
Â  Â  Â  Â  const dt = window.pickDate(o);
Â  Â  Â  Â  const timeStr = dt.toLocaleTimeString("es-AR", {hour:'2-digit', minute:'2-digit'});
Â  Â  Â  Â Â 
Â  Â  Â  Â  const st = o.status || 'accepted';
Â  Â  Â  Â  const isPaid = (o.payment_status==='paid') || !!o.paid;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const LABELS = {accepted:'Recibido', in_prep:'Cocina', ready:'Listo', delivered:'Entregado'};
Â  Â  Â  Â Â 
Â  Â  Â  Â  const btns = ['accepted','in_prep','ready','delivered'].map(k => {
Â  Â  Â  Â  Â  Â  const isOn = (k === st) ? 'on' : '';
Â  Â  Â  Â  Â  Â  const opacity = (k==='delivered' && !isPaid) ? 'opacity:0.5' : '';
Â  Â  Â  Â  Â  Â  return `<div class="state-btn ${isOn} state-${k}" style="${opacity}" onclick="setOrderStatus('${doc.id}', '${k}', ${isPaid})">
Â  Â  Â  Â  Â  Â  Â  Â  <span>${LABELS[k]}</span>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  let payVal = o.pago;
Â  Â  Â  Â  if(payVal === 'mostrador_sin_especificar') payVal = "";

Â  Â  Â  Â  const items = Array.isArray(o.items) ? o.items : [];
Â  Â  Â  Â  const cats = { b:[], f:[], d:[], o:[] };
Â  Â  Â  Â  items.forEach(it => {
Â  Â  Â  Â  Â  Â  const cat = window.getCat(it);
Â  Â  Â  Â  Â  Â  if(cat === 'b'){
Â  Â  Â  Â  Â  Â  Â  Â  cats.b.push(it);
Â  Â  Â  Â  Â  Â  Â  Â  let fName = it.fries;
Â  Â  Â  Â  Â  Â  Â  Â  if(!fName && it.extras?.fries) fName = it.extras.fries;
Â  Â  Â  Â  Â  Â  Â  Â  if(!fName && it.guarnicion) fName = it.guarnicion;
Â  Â  Â  Â  Â  Â  Â  Â  if(fName && fName !== 'sin_papas') cats.f.push({name: fName, qty: it.qty||1});
Â  Â  Â  Â  Â  Â  } else { cats[cat].push(it); }
Â  Â  Â  Â  });

Â  Â  Â  Â  const renderSec = (list, icon, title) => {
Â  Â  Â  Â  Â  Â  if(!list.length) return "";
Â  Â  Â  Â  Â  Â  const rows = list.map(it => {
Â  Â  Â  Â  Â  Â  Â  Â  let ex = [];
Â  Â  Â  Â  Â  Â  Â  Â  if(it.extras?.patty) ex.push(`+${it.extras.patty} carne`);
Â  Â  Â  Â  Â  Â  Â  Â  if(it.extras?.cheddar) ex.push(`+${it.extras.cheddar} cheddar`);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let dName = esc(it.name);
Â  Â  Â  Â  Â  Â  Â  Â  if(title.includes("PAPAS")) dName = window.cleanFries(it.name);

Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="it-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="it-qty">${it.qty||1}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="it-det">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="it-name">${dName}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${ex.length ? `<div class="it-sub">${ex.join(' Â· ')}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.notes ? `<div class="it-note">${esc(it.notes)}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }).join("");
Â  Â  Â  Â  Â  Â  return `<div class="cat-group"><div class="cat-title">${icon} ${title}</div>${rows}</div>`;
Â  Â  Â  Â  };

Â  Â  Â  Â  const esc = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
Â  Â  Â  Â  const itemsHTML = renderSec(cats.b,'ğŸ”','HAMBURGUESAS') + renderSec(cats.f,'ğŸŸ','PAPAS') + renderSec(cats.d,'ğŸ¥¤','BEBIDAS') + renderSec(cats.o,'ğŸ”¸','OTROS');
Â  Â  Â  Â  const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);

Â  Â  Â  Â  return `
Â  Â  Â  Â  <div class="order ${st==='cancelled'?'cancelled':''}">
Â  Â  Â  Â  Â  Â <div class="order-head">
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="order-title">#${o.orderNumber||'--'} â€” ${o.source==='mostrador'?esc(o.nombre)+' (Local)':esc(o.nombre)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="order-meta">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${timeStr}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="chip ${o.source==='mostrador'?'mostrador':''}">${esc(o.entrega||'take_away')}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${o.pickup_time_pretty ? `<span class="chip time">â° ${esc(o.pickup_time_pretty)}</span>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="price-tag">${money(total)}</div>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â <div class="items">${itemsHTML || '<div class="it-sub">Sin Ã­tems</div>'}</div>

Â  Â  Â  Â  Â  Â <div class="actions-area">
Â  Â  Â  Â  Â  Â  Â  <div class="pay-toolbar">
Â  Â  Â  Â  Â  Â  Â  Â  Â <select class="pay-select" onchange="updatePago('${doc.id}', this.value)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="" ${!payVal?'selected':''}>Forma de Pago...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="efectivo" ${payVal==='efectivo'?'selected':''}>Efectivo</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="mercado_pago" ${payVal==='mercado_pago'?'selected':''}>QR (MP)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="debito" ${payVal==='debito'?'selected':''}>DÃ©bito</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="transferencia" ${payVal==='transferencia'?'selected':''}>Transferencia</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="pay-btn ${isPaid?'paid':'pending'}" onclick="setPaymentStatus('${doc.id}', ${isPaid}, '${payVal}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${isPaid ? 'PAGADO' : 'COBRAR'}
Â  Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="icon-btn-lg" onclick="printOrder('${doc.id}')">ğŸ–¨ï¸</div>
Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  <div class="stateBtns">
Â  Â  Â  Â  Â  Â  Â  Â  Â ${btns}
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="state-btn cancelled" onclick="setOrderStatus('${doc.id}', 'cancelled', ${isPaid})">CANCELAR</div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  </div>`;
Â  Â  }

Â  Â  window.trySilentPrint = function(docSnap){
Â  Â  Â  Â const o = docSnap.data();
Â  Â  Â  Â const esc = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
Â  Â  Â  Â const m = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
Â  Â  Â  Â const dt = window.pickDate(o);
Â  Â  Â  Â const dateStr = dt.toLocaleDateString("es-AR");
Â  Â  Â  Â const timeStr = dt.toLocaleTimeString("es-AR",{hour12:false});

Â  Â  Â  Â let payTxt = o.pago;
Â  Â  Â  Â if(!payTxt || payTxt==='mostrador_sin_especificar' || payTxt==="") payTxt="A COBRAR EN CAJA";
Â  Â  Â  Â else if(payTxt==='mercado_pago') payTxt="QR (MP)";
Â  Â  Â  Â else payTxt = payTxt.toUpperCase();

Â  Â  Â  Â const isPaid = (o.payment_status === 'paid') || o.paid;
Â  Â  Â  Â const stPay = isPaid ? "PAGADO" : "PENDIENTE";
Â  Â  Â  Â 
Â  Â  Â  Â const items = Array.isArray(o.items) ? o.items : [];
Â  Â  Â  Â const cats = { b:[], f:[], d:[], o:[] };
Â  Â  Â  Â items.forEach(it => {
Â  Â  Â  Â  Â  const cat = window.getCat(it);
Â  Â  Â  Â  Â  if(cat==='b'){
Â  Â  Â  Â  Â  Â  Â cats.b.push(it);
Â  Â  Â  Â  Â  Â  Â let fName = it.fries;
Â  Â  Â  Â  Â  Â  Â if(!fName && it.extras?.fries) fName = it.extras.fries;
Â  Â  Â  Â  Â  Â  Â if(!fName && it.guarnicion) fName = it.guarnicion;
Â  Â  Â  Â  Â  Â  Â if(fName && fName!=='sin_papas') cats.f.push({name: fName, qty: it.qty||1});
Â  Â  Â  Â  Â  } else { cats[cat].push(it); }
Â  Â  Â  Â });
Â  Â  Â  Â 
Â  Â  Â  Â const rSec = (l, ti) => {
Â  Â  Â  Â  Â if(!l.length) return "";
Â  Â  Â  Â  Â const r = l.map(i => {
Â  Â  Â  Â  Â  Â  let dName = esc(i.name);
Â  Â  Â  Â  Â  Â  if(ti.includes("PAPA")) dName = window.cleanFries(i.name);
Â  Â  Â  Â  Â  Â  let h = `<div class="row name"><div class="l">${i.qty||1} Ã— ${dName}</div></div>`;
Â  Â  Â  Â  Â  Â  if(!ti.includes("PAPA")){
Â  Â  Â  Â  Â  Â  Â  Â if(i.extras?.patty) h+=`<div class="sub">â€¢ +${i.extras.patty} carne</div>`;
Â  Â  Â  Â  Â  Â  Â  Â if(i.extras?.cheddar) h+=`<div class="sub">â€¢ +${i.extras.cheddar} cheddar</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(i.notes) h+=`<div class="sub">ğŸ“ ${esc(i.notes)}</div>`;
Â  Â  Â  Â  Â  Â  h+=`<div class="sep"></div>`;
Â  Â  Â  Â  Â  Â  return h;
Â  Â  Â  Â  Â }).join("");
Â  Â  Â  Â  Â return `<div class="blk"><div class="lbl" style="border-bottom:1px solid #000;display:inline-block;margin-top:6px">${ti}</div></div>${r}`;
Â  Â  Â  Â };

Â  Â  Â  Â const body = rSec(cats.b,'HAMBURGUESAS') + rSec(cats.f,'PAPAS') + rSec(cats.d,'BEBIDAS') + rSec(cats.o,'OTROS');
Â  Â  Â  Â const total = o.total || items.reduce((a,i)=>a+((i.price||0)*(i.qty||1)),0);
Â  Â  Â  Â const name = o.source==='mostrador' ? (o.nombre+' (Local)') : o.nombre;

Â  Â  Â  Â const html = `<!doctype html><html><head><style>
Â  Â  Â  Â @page{size:58mm auto;margin:0} body{width:58mm;margin:0 auto;padding:5px;font-family:monospace;font-size:12px;font-weight:700;color:#000;line-height:1.2}
Â  Â  Â  Â .c{text-align:center} .hr{border-top:1px dashed #000;margin:6px 0} .row{display:flex;justify-content:space-between}
Â  Â  Â  Â .lbl{font-size:10px;text-transform:uppercase} .sub{font-size:11px;margin-left:5px;font-weight:400} .sep{border-top:1px dotted #999;margin:3px 0}
Â  Â  Â  Â </style></head><body>
Â  Â  Â  Â  Â <div class="c" style="font-size:16px;margin-bottom:4px">Rhodes Burgers</div>
Â  Â  Â  Â  Â <div class="c" style="font-size:14px">#${o.orderNumber||'--'}</div>
Â  Â  Â  Â  Â <div class="c" style="font-size:18px;margin:5px 0">[ ${stPay} ]</div>
Â  Â  Â  Â  Â <div class="hr"></div>
Â  Â  Â  Â  Â <div><span class="lbl">CLIENTE:</span> ${esc(name)}</div>
Â  Â  Â  Â  Â <div class="c" style="font-size:16px;margin:6px 0;font-weight:900">Retira: ${esc(o.pickup_time_pretty||'A la brevedad')}</div>
Â  Â  Â  Â  Â <div><span class="lbl">PAGO:</span> ${payTxt}</div>
Â  Â  Â  Â  Â ${o.notes ? `<div class="hr"></div><div><span class="lbl">NOTA:</span> ${esc(o.notes)}</div>` : ''}
Â  Â  Â  Â  Â <div class="hr"></div>
Â  Â  Â  Â  Â ${body}
Â  Â  Â  Â  Â <div class="hr"></div>
Â  Â  Â  Â  Â <div class="row"><div class="l">TOTAL</div><div>${m(total)}</div></div>
Â  Â  Â  Â  Â <div class="c" style="margin-top:10px;font-size:10px">${dateStr} ${timeStr}</div>
Â  Â  Â  Â  Â <script>window.onload=()=>{setTimeout(()=>{window.print()},200)}<\/script>
Â  Â  Â  Â </body></html>`;
Â  Â  Â  Â 
Â  Â  Â  Â const f = document.createElement('iframe'); f.style.cssText='position:fixed;left:0;top:0;width:0;height:0;border:0';
Â  Â  Â  Â document.body.append(f); const d=f.contentWindow.document; d.open();d.write(html);d.close();
Â  Â  Â  Â setTimeout(()=>f.remove(), 10000);
Â  Â  };
Â  });
Â  </script>
</body>
</html>
