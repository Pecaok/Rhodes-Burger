<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Pedidos (Local)</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1100px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:8px 14px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.small{ padding:6px 10px; font-size:13px }
    .btn.primary{ background:var(--primary); color:#fff }
    .container{ max-width:1100px; margin:20px auto; padding:0 12px }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; align-items:center }
    select, input[type="search"]{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:14px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; display:flex; flex-direction:column; gap:8px }
    .row{ display:flex; justify-content:space-between; gap:8px }
    .muted{ color:var(--muted); font-size:13px }
    .tag{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; font-weight:700; }
    .s-pending{ background:#fff3cd }
    .s-accepted{ background:#cfe9ff }
    .s-ready{ background:#e6ffe0 }
    .s-delivered{ background:#e9ecef }
    .s-cancelled{ background:#ffe0e0 }
    ul{ margin:6px 0 0 16px; padding:0 }
    li{ margin:2px 0 }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img src="images/logo.png" alt="Rhodes Burgers"></a>
      <h3 style="margin:0 8px;">Panel de pedidos</h3>
      <div class="spacer"></div>
      <button id="btnSound" class="btn">ðŸ”” Activar sonido</button>
      <a class="btn" href="pedido_cliente.html" target="_blank">Pantalla cliente</a>
    </div>
  </header>

  <main class="container">
    <div class="controls">
      <label>Estado:
        <select id="filtroEstado">
          <option value="all">Todos</option>
          <option value="accepted" selected>Aceptados</option>
          <option value="ready">Listos</option>
          <option value="delivered">Entregados</option>
          <option value="cancelled">Cancelados</option>
          <option value="pending">Pendientes (heredados)</option>
        </select>
      </label>
      <input id="buscar" type="search" placeholder="Buscar por nombre o direcciÃ³n">
    </div>
    <div id="lista" class="grid"></div>
    <p id="status" class="muted"></p>
  </main>

  <!-- Sonido (ponÃ© tu propio mp3 en /sounds/new-order.mp3 si querÃ©s) -->
  <audio id="newOrderAudio" preload="auto">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAA..." type="audio/mp3">
    <!-- Si querÃ©s usar un archivo real, reemplazÃ¡ la lÃ­nea de arriba por:
    <source src="sounds/new-order.mp3" type="audio/mpeg">
    -->
  </audio>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Mismos datos que en pedido_cliente.html
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const lista = $("#lista");
    const statusEl = $("#status");
    const filtro = $("#filtroEstado");
    const buscar = $("#buscar");

    let firstLoad = true;           // para no sonar por los pedidos histÃ³ricos
    let soundEnabled = false;

    // ActivaciÃ³n de sonido (necesaria por polÃ­ticas del navegador)
    const audio = document.getElementById("newOrderAudio");
    document.getElementById("btnSound").addEventListener("click", async ()=>{
      try{
        await audio.play();     // un "ping" cortito embebido
        audio.pause(); audio.currentTime = 0;
        soundEnabled = true;
        alert("Sonido activado âœ…");
      }catch(e){
        alert("No se pudo habilitar el sonido. ProbÃ¡ nuevamente.");
      }
    });

    // SuscripciÃ³n
    let unsub = null;
    function listen() {
      if (unsub) unsub();

      // Ordenamos por createdAt desc (tolera null al inicio)
      let q = db.collection("orders").orderBy("createdAt","desc");

      unsub = q.onSnapshot(async snap=>{
        const docs = [];
        snap.forEach(d=> docs.push({id:d.id, ...d.data()}));

        // Auto-aceptar pedidos "pending" reciÃ©n agregados
        const changes = snap.docChanges();
        for (const ch of changes) {
          if (ch.type === "added") {
            const d = ch.doc.data() || {};
            if (d.status === "pending") {
              try { await ch.doc.ref.update({ status: "accepted" }); } catch(_) {}
            }
            // Sonido solo para nuevos (no en primera carga)
            if (!firstLoad && soundEnabled) {
              try { audio.play().catch(()=>{}); } catch(_){}
            }
          }
        }
        firstLoad = false;

        render(docs);
      }, err=>{
        console.error(err);
        statusEl.textContent = "Error leyendo pedidos. RevisÃ¡ Reglas de Firestore.";
      });
    }

    function render(docs){
      const est = filtro.value;
      const term = buscar.value.trim().toLowerCase();

      const filtered = docs.filter(o=>{
        const okEstado = (est==="all") || (o.status===est);
        const txt = `${o.nombre||""} ${o.direccion||""}`.toLowerCase();
        const okText = !term || txt.includes(term);
        return okEstado && okText;
      });

      if(filtered.length===0){
        lista.innerHTML = `<div class="muted">No hay pedidos para mostrar.</div>`;
        return;
      }

      lista.innerHTML = filtered.map(o=>{
        const fecha = o.createdAt?.toDate ? o.createdAt.toDate() : null;
        const fstr = fecha ? fecha.toLocaleString("es-AR",{hour12:false}) : "â€”";
        const items = (o.items||[]).map(it=>{
          const linea = `${it.qty||it.quantity}Ã— ${it.name||it.title} ${it.price?`(${money(it.price)})`:""}`;
          return `<li>${linea}${it.notes?` â€” <em>${it.notes}</em>`:""}</li>`;
        }).join("");

        const estado = o.status||"accepted";
        const sClass = `s-${estado}`;

        return `
        <div class="card" data-id="${o.id}">
          <div class="row">
            <strong>#${o.id.slice(-6)}</strong>
            <span class="tag ${sClass}">${estado}</span>
          </div>
          <div class="row"><div><strong>${o.nombre||"Sin nombre"}</strong></div><div>${money(o.total||0)}</div></div>
          <div class="muted">${fstr}</div>
          <div>Entrega: <strong>${o.entrega||"-"}</strong>${o.entrega==="delivery" && o.direccion?` â€” ${o.direccion}`:""}</div>
          <div>Papas: <strong>${o.fries==="con_sazon"?"Con sazÃ³n":o.fries==="sin_sazon"?"Sin sazonar":"â€”"}</strong></div>
          <div>Items:<ul>${items}</ul></div>

          <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:6px">
            ${actionButtons(estado)}
          </div>
        </div>`;
      }).join("");

      // Wire buttons
      lista.querySelectorAll("[data-action]").forEach(btn=>{
        btn.addEventListener("click", async (e)=>{
          const el = e.currentTarget;
          const id = el.closest(".card").dataset.id;
          const next = el.dataset.action;
          try{
            el.disabled = true;
            await db.collection("orders").doc(id).update({ status: next });
          }catch(err){
            console.error(err);
            alert("No se pudo actualizar el estado.");
          }finally{
            el.disabled = false;
          }
        });
      });
    }

    // Flujo SIN aceptar: pending y accepted comparten acciones (Listo / Cancelar)
    function actionButtons(estado){
      const flowMap = {
        pending:   [{t:"Listo", to:"ready"}, {t:"Cancelar", to:"cancelled"}],
        accepted:  [{t:"Listo", to:"ready"}, {t:"Cancelar", to:"cancelled"}],
        ready:     [{t:"Entregado", to:"delivered"}],
        delivered: [],
        cancelled: []
      };
      const flow = flowMap[estado] || [];
      if(flow.length===0) return `<span class="muted">Sin acciones</span>`;
      return flow.map(b=>`<button class="btn small" data-action="${b.to}">${b.t}</button>`).join("");
    }

    filtro.addEventListener("change", renderFromCache);
    buscar.addEventListener("input", renderFromCache);
    function renderFromCache(){ /* trigger nueva escucha para aplicar filtros en vivo */ listen(); }

    // Inicio
    listen();
  </script>
</body>
</html>
