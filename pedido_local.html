<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos - Rhodes Burguers</title>
  <style>
    :root { --verde:#28a745; }
    body{
      font-family: Arial, sans-serif; margin:0; padding-top:80px;
      background-image:url('background.jpg'); background-size: contain;
      background-repeat:no-repeat; background-position:center; background-attachment:fixed; background-color:#f0f0f0;
    }
    /* HEADER UNIFICADO */
    header{
      background:white; position:fixed; top:0; width:100%; padding:10px 24px;
      display:flex; justify-content:space-between; align-items:center; z-index:10;
      box-shadow:0 2px 5px rgba(0,0,0,.1);
    }
    header img{ height:50px; }
    .header-right { display:flex; align-items:center; gap:12px; transform: translateX(-80px); }
    header a{ background:var(--verde); color:#fff; text-decoration:none; padding:8px 16px; border-radius:6px; font-weight:bold; }
    .sound-toggle{ border:2px solid #0f7a33; background:#eafff2; color:#0b3e20; font-weight:700; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .sound-toggle[aria-pressed="true"]{ background:#22c55e; color:#0b3e20; }

    .total-dia{
      font-size: 20px; text-align:center; margin: 20px auto; font-weight:700;
      background:#fff; padding:12px; border-radius:10px; max-width:420px;
      box-shadow:0 2px 5px rgba(0,0,0,.2); border:2px solid #000;
    }
    .pedido{
      background:#fff; border-radius:10px; padding:16px; margin: 16px auto; max-width:720px;
      box-shadow:0 2px 5px rgba(0,0,0,.2); border:2px solid #000;
    }
    .pedido p{ margin:6px 0; }
    ul{ padding-left:20px; margin:6px 0; }
    .toast {
      position: fixed; top: 16px; right: 16px;
      background: #22c55e; color: #0b3e20; border: 2px solid #0f7a33;
      padding: 10px 14px; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,.15);
      font-weight: 700; z-index: 1000; opacity: 0; transform: translateY(-8px);
      transition: opacity .25s ease, transform .25s ease; pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.appspot.com",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== Sonido/Toast =====
    let audioCtx = null;
    function ensureAudioContext() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") return audioCtx.resume().catch(()=>{});
      return Promise.resolve();
    }
    function beep(duration=110, frequency=880, type="sine", volume=0.15) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type; osc.frequency.value = frequency;
      gain.gain.value = volume;
      osc.connect(gain).connect(audioCtx.destination);
      osc.start(); setTimeout(() => osc.stop(), duration);
    }
    function notify(m) {
      const t = document.getElementById("toast");
      t.textContent = m; t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 3500);
    }

    const contenedor = document.getElementById("contenedor-pedidos");
    const totalMesEl = document.getElementById("total-mes");
    const soundBtn = document.getElementById("sound-btn");

    let soundEnabled = localStorage.getItem("soundEnabled") === "true";
    soundBtn.setAttribute("aria-pressed", soundEnabled ? "true" : "false");
    soundBtn.textContent = soundEnabled ? "ðŸ”Š Sonido ON" : "ðŸ”‡ Sonido OFF";
    document.addEventListener("click", async () => { if (soundEnabled) await ensureAudioContext(); }, { once: true });
    soundBtn.addEventListener("click", async () => {
      soundEnabled = !soundEnabled; localStorage.setItem("soundEnabled", soundEnabled ? "true" : "false");
      soundBtn.setAttribute("aria-pressed", soundEnabled ? "true" : "false");
      soundBtn.textContent = soundEnabled ? "ðŸ”Š Sonido ON" : "ðŸ”‡ Sonido OFF";
      if (soundEnabled) { await ensureAudioContext(); beep(120, 880); }
    });

    // ===== Lectura robusta desde Firebase =====
    const pedidosRef = collection(db, "pedidos");
    const pedidosQuery = query(pedidosRef, orderBy("timestamp", "desc"));

    // Helper para tomar el primer valor disponible entre varias claves posibles
    const pick = (obj, keys, fallback='-') => {
      for (const k of keys) {
        const v = obj?.[k];
        if (v !== undefined && v !== null && v !== '') return v;
      }
      return fallback;
    };

    // Convierte timestamp (serverTimestamp/Date/seconds) a Date vÃ¡lida
    const toDate = (ts) => {
      if (!ts) return new Date();
      if (typeof ts.toDate === 'function') return ts.toDate();
      if (typeof ts === 'number') return new Date(ts);
      if (ts.seconds) return new Date(ts.seconds * 1000);
      const d = new Date(ts);
      return isNaN(d.getTime()) ? new Date() : d;
    };

    let initialized = false;

    onSnapshot(pedidosQuery, async (snapshot) => {
      if (initialized) {
        snapshot.docChanges().forEach(async change => {
          if (change.type === "added" && !change.doc.metadata.hasPendingWrites) {
            const data = change.doc.data();
            const nombre = pick(data, ["nombre","cliente","user","nombreCliente"], "Cliente");
            notify(`ðŸŸ¢ Nuevo pedido de ${nombre}`);
            if (soundEnabled) { await ensureAudioContext(); beep(110, 880); setTimeout(()=>beep(110, 660), 160); }
          }
        });
      }

      contenedor.innerHTML = "";
      let totalMes = 0;

      snapshot.forEach(doc => {
        const data = doc.data();

        // Campos robustos
        const nombre  = pick(data, ["nombre","cliente","user","nombreCliente"]);
        const metodo  = pick(data, ["metodo","metodoPago","pago","paymentMethod"]);
        const entrega = pick(data, ["entrega","tipo","tipoEntrega","deliveryType"]);
        const coments = pick(data, ["comentarios","comentario","notes"], "-");
        const items   = pick(data, ["pedido","items","cart","productos"], []);
        const fecha   = toDate(data.timestamp);

        // CÃ¡lculo total
        const totalPedido = Array.isArray(items)
          ? items.reduce((acc, it) => acc + (Number(it.price)||0) * (Number(it.quantity)||0), 0)
          : 0;
        totalMes += totalPedido;

        // HTML
        const div = document.createElement("div");
        div.className = "pedido";
        div.innerHTML = `
          <p><strong>Cliente:</strong> ${nombre}</p>
          <p><strong>Fecha:</strong> ${fecha.toLocaleString()}</p>
          <p><strong>MÃ©todo de pago:</strong> ${metodo}</p>
          <p><strong>Tipo de entrega:</strong> ${entrega}</p>
          <p><strong>Comentarios:</strong> ${coments}</p>

          <p><strong>Productos:</strong></p>
          <ul>
            ${
              Array.isArray(items) && items.length
              ? items.map(p => {
                  const qty = Number(p.quantity)||0;
                  const price = Number(p.price)||0;
                  const name = p.item || p.nombre || p.title || "Producto";
                  return `<li>${qty} x ${name} - $${qty*price}</li>`;
                }).join('')
              : '<li>(Sin Ã­tems)</li>'
            }
          </ul>

          <p><strong>Total del pedido:</strong> $${totalPedido}</p>
        `;
        contenedor.appendChild(div);
      });

      totalMesEl.textContent = `Total acumulado del mes: $${totalMes}`;
      initialized = true;
    });
  </script>
</head>
<body>
  <header>
    <img src="logo.jpg" alt="Rhodes Burguers">
    <div class="header-right">
      <button id="sound-btn" class="sound-toggle" aria-pressed="false" type="button">ðŸ”‡ Sonido OFF</button>
      <a href="index.html">MenÃº</a>
    </div>
  </header>

  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <div class="total-dia" id="total-mes">Total acumulado del mes: $0</div>
  <div id="contenedor-pedidos"></div>
</body>
</html>
