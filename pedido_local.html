<!doctype html>
<html lang="es">
<!-- ========================= SESI√ìN COMPARTIDA ========================= -->
<script>
  const TTL_HOURS = 20;
  const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

  function sessionValid() {
    const ok = localStorage.getItem('rb_admin_ok') === 'true';
    const ts = Number(localStorage.getItem('rb_admin_t') || 0);
    return ok && (Date.now() - ts) < TTL_MS;
  }
  function bumpSession() {
    if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
  }
  function logout() {
    try { localStorage.removeItem('rb_admin_ok'); } catch (_) {}
    try { localStorage.removeItem('rb_admin_t'); } catch (_) {}
    try { localStorage.removeItem('rb_auth_v2'); } catch (_) {}
    try { sessionStorage.removeItem('rb_auth_v2'); } catch (_) {}
    location.replace('login.html?reason=logout');
  }
  (function requireSession() {
    if (!sessionValid()) {
      const next = encodeURIComponent('pedido_local.html');
      location.replace('login.html?next=' + next);
    } else bumpSession();
  })();

  ['click', 'keydown', 'focus', 'mousemove', 'touchstart', 'scroll']
    .forEach(evt => window.addEventListener(evt, bumpSession, { passive: true }));
</script>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pedidos ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#625A45;
      --text:#111;
      --muted:#444;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#eaeaea;
      --shadow:0 12px 34px rgba(0,0,0,.10);
      --font: Inter, system-ui, "Segoe UI", Roboto, Arial, sans-serif;

      --st-accepted:#FBC02D;
      --st-in_prep:#FB8C00;
      --st-ready:#00ACC1;
      --st-delivered:#2E7D32;
      --st-cancelled:#D32F2F;

      --pay-pending:#FFA000;
      --pay-paid:#625A45;
    }

    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font)}

    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{
      max-width:1100px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      gap:12px
    }
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}

    .btn{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--ring);background:#fff;
      padding:8px 12px;border-radius:999px;
      cursor:pointer;font-weight:600;color:inherit
    }
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}

    .container{max-width:1100px;margin:24px auto;padding:0 12px}

    .tabs{display:flex;gap:10px;margin:14px 0}
    .chipf{
      background:#f3f3f3;border:1px solid var(--ring);
      padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer
    }
    .chipf.active{background:var(--primary);color:#fff}

    .order{
      background:var(--card);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px 18px;
      margin:14px 0
    }
    .order-head{
      display:flex;
      justify-content:space-between;
      gap:20px;
      flex-wrap:nowrap;
    }
    .order-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      min-width:220px;
    }

    .order-title{font-weight:800}
    .muted{color:var(--muted)}

    .chip{
      background:#f3f3f3;border:1px solid var(--ring);
      padding:6px 10px;border-radius:999px;font-size:13px
    }
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}

    .pay-line{display:flex;align-items:center;gap:10px;flex-wrap:nowrap;margin-top:10px}
    .pay-method-select{
      min-width:150px;
      max-width:160px;
      height:36px;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--ring);
      background:#fff;
      font-size:14px;
    }

    .pay-toggle.is-paid{
      background:var(--pay-paid);
      color:#fff;border-color:var(--pay-paid)
    }
    .pay-toggle.is-pending{
      background:var(--pay-pending);
      color:#fff;border-color:var(--pay-pending)
    }

    .stateBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .state-btn{
      border:2px solid #dcdcdc;background:#fff;
      border-radius:999px;padding:8px 12px;
      font-weight:800;cursor:pointer
    }

    .items .sub{font-size:13px;color:#555;margin-left:10px}
  </style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png" alt="">Pedidos</a>

    <nav style="display:flex;gap:8px; margin-left:20px;">
      <a href="pedido_local.html" class="btn primary">üì¶ Pedidos</a>
      <a href="finanzas.html" class="btn">üìà Finanzas</a>
      <a href="mostrador.html" class="btn">üßæ Mostrador</a>
      <a href="admin.html" class="btn">‚öôÔ∏è Admin</a>
    </nav>

    <!-- BOTONES ACTIVADOS -->
    <button id="btnBell" class="btn">üîî Sonido</button>
    <button id="btnAutoPrint" class="btn">üñ® Auto</button>

    <button id="btnLogout" class="btn danger">‚èª Cerrar sesi√≥n</button>
  </div>
</header>

<main class="container">
  <h1>√öltimos pedidos</h1>

  <div class="tabs" id="tabs">
    <span class="chipf active" data-f="recibidos">Recibidos</span>
    <span class="chipf" data-f="entregados">Entregados</span>
    <span class="chipf" data-f="cancelled">Cancelados</span>
    <span class="chipf" data-f="all">Todos</span>
  </div>

  <div id="orders"></div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ======================================================================
   TODO EL JS FUNCIONAL ‚Äì CORREGIDO Y ARMADO
====================================================================== */
window.addEventListener("DOMContentLoaded", () => {

  /* ================= FIREBASE ================= */
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const $ = s => document.querySelector(s);



  /* ================= SONIDO ================= */
  let soundEnabled = JSON.parse(localStorage.getItem("rb_bell_enabled") || "true");
  let audioCtx = null, audioReady = false;

  function getAudioCtx(){
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    return audioCtx;
  }
  async function ensureAudioReady(){
    try{
      const ctx=getAudioCtx();
      if(ctx.state==="suspended") await ctx.resume();
      audioReady = (ctx.state==="running");
    }catch(e){ audioReady=false; }
    return audioReady;
  }
  function beepOnce(ctx,d=0.22,f=900,g=0.7){
    const o=ctx.createOscillator(), ga=ctx.createGain();
    o.type="square"; o.frequency.value=f;
    o.connect(ga); ga.connect(ctx.destination);
    ga.gain.setValueAtTime(0.0001,ctx.currentTime);
    ga.gain.exponentialRampToValueAtTime(g,ctx.currentTime+0.02);
    ga.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d);
    o.start(); o.stop(ctx.currentTime+d+0.02);
  }
  async function playBeepTriple(){
    if(!soundEnabled) return;
    const ok=await ensureAudioReady();
    if(!ok) return;
    const ctx=getAudioCtx();
    beepOnce(ctx); setTimeout(()=>beepOnce(ctx),320); setTimeout(()=>beepOnce(ctx),640);
  }

  const btnBell = $("#btnBell");
  const updateBellUI = () => btnBell.classList.toggle("active", soundEnabled);
  updateBellUI();
  btnBell.onclick = ()=>{
    soundEnabled = !soundEnabled;
    localStorage.setItem("rb_bell_enabled", JSON.stringify(soundEnabled));
    updateBellUI();
    if(soundEnabled) playBeepTriple();
  };



  /* ================= AUTOPRINT ================= */
  let autoPrint = JSON.parse(localStorage.getItem("rb_auto_print") || "false");
  const btnAutoPrint = $("#btnAutoPrint");
  const updateAP = ()=> btnAutoPrint.classList.toggle("active", autoPrint);
  updateAP();
  btnAutoPrint.onclick = ()=>{
    autoPrint = !autoPrint;
    localStorage.setItem("rb_auto_print", JSON.stringify(autoPrint));
    updateAP();
  };



  /* ================= FILTROS ================= */
  const tabs = $("#tabs");
  let currentFilter = "recibidos";
  tabs.addEventListener("click", e=>{
    const el = e.target.closest("[data-f]");
    if(!el) return;
    currentFilter = el.dataset.f;
    tabs.querySelectorAll(".chipf").forEach(x=>x.classList.remove("active"));
    el.classList.add("active");
    if(lastSnap) renderList(lastSnap);
  });

  const passFilter = o=>{
    const s = o.status || "accepted";
    if(currentFilter==="recibidos") return ["accepted","pending_payment","in_prep","ready"].includes(s);
    if(currentFilter==="entregados") return s==="delivered";
    if(currentFilter==="cancelled") return s==="cancelled";
    return true;
  };



  /* ================= FORMATO FECHAS Y HORARIOS ================= */
  function pickDate(o){
    const keys=["createdAt","created_at","timestamp","date","fecha","time"];
    for(const k of keys){
      const v=o[k];
      if(v?.toDate) return v.toDate();
      if(typeof v==="number") return new Date(v);
      if(typeof v==="string"){ const d=new Date(v); if(!isNaN(d)) return d; }
    }
    return new Date();
  }
  function formatSlotTime(raw){
    if(!raw) return null;
    try{
      if(raw?.toDate) return raw.toDate().toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
      if(raw instanceof Date) return raw.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
      if(typeof raw==="string"){
        const d=new Date(raw);
        if(!isNaN(d)) return d.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
        const m=raw.match(/(\d{2})(\d{2})$/); if(m) return m[1]+":"+m[2];
      }
      if(raw?.seconds) return new Date(raw.seconds*1000).toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false});
    }catch(e){}
    return null;
  }
  function getPickupPretty(o){
    let p = o.pickup_time_pretty ||
            formatSlotTime(o.pickup_time || o.pickup || o.pickupTime);
    if(!p && o.pickup_slot){
      const m=String(o.pickup_slot).match(/(\d{2})(\d{2})$/);
      if(m) p=m[1]+":"+m[2];
    }
    if(!p && o.pickup_asap===true) p="A la brevedad";
    return p || null;
  }



  /* ================= ESTADOS ================= */
  async function setOrderStatus(id,next){
    try{
      await db.collection("orders").doc(id).update({
        status: next,
        statusHistory: firebase.firestore.FieldValue.arrayUnion({to:next,at:new Date().toISOString()})
      });
    }catch(e){
      alert("Error cambiando estado: " + (e?.message||e));
    }
  }
  async function setPaymentStatus(id,paid){
    try{
      await db.collection("orders").doc(id).update({
        paid: paid,
        payment_status: paid?"paid":"pending_payment",
        statusHistory: firebase.firestore.FieldValue.arrayUnion({to:paid?"paid":"pending_payment",at:new Date().toISOString()})
      });
    }catch(e){
      alert("Error cambiando pago: "+(e?.message||e));
    }
  }

  const STATE_SEQ=["accepted","in_prep","ready","delivered","cancelled"];
  const STATE_LABEL={
    accepted:"Recibido",
    in_prep:"En preparaci√≥n",
    ready:"Listo para retirar",
    delivered:"Entregado",
    cancelled:"Cancelar"
  };



  /* ================= RENDER PEDIDO ================= */
  function renderOrder(doc){
    const o=doc.data();
    const dt = pickDate(o);
    const dtText = dt.toLocaleDateString("es-AR") + ", " + dt.toLocaleTimeString("es-AR",{hour12:false});
    const pickupPretty = getPickupPretty(o);

    const items = Array.isArray(o.items)? o.items: [];

    const itemsHTML = items.map(it=>{
      const qty=it.qty||1;
      const base = (it.price||0)*qty;
      const patty = (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)*qty;
      const cheddar = (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0)*qty;

      const fries = it.fries || it.side || (Array.isArray(it.sides)?it.sides.join(" "):"") || "‚Äî";

      return `
        <div>
          <div>‚Ä¢ <strong>${qty}√ó ${it.name||""}</strong></div>
          <div class="sub">Papas: ${fries}</div>
          <div class="sub">Subtotal: $ ${base+patty+cheddar}</div>
        </div>
      `;
    }).join("");

    const st = o.status || "accepted";
    const stateBtns = `
      <div class="stateBtns">
        ${STATE_SEQ.map(k => `
          <button class="state-btn" data-act="${k}">${STATE_LABEL[k]}</button>
        `).join("")}
      </div>
    `;

    const isPaid = (o.payment_status==="paid" || o.paid===true);
    const payClasses = `btn pay-toggle ${isPaid?"is-paid":"is-pending"}`;
    const payText = isPaid?"PAGADO ‚úì":"PENDIENTE DE PAGO";

    const payLine = `
      <div class="pay-line">
        <select class="pay-method-select" data-id="${doc.id}">
          <option value="">M√©todo de pago...</option>
          <option value="efectivo" ${o.pago==="efectivo"?"selected":""}>Efectivo</option>
          <option value="debito" ${o.pago==="debito"?"selected":""}>Debito</option>
          <option value="credito" ${o.pago==="credito"?"selected":""}>Credito</option>
          <option value="mercadopago" ${o.pago==="mercadopago"?"selected":""}>MercadoPago</option>
          <option value="transferencia" ${o.pago==="transferencia"?"selected":""}>Transferencia</option>
          <option value="otro" ${o.pago==="otro"?"selected":""}>Otro</option>
        </select>

        <button class="${payClasses}" data-pay-toggle="${isPaid?'paid':'pending'}">
          ${payText}
        </button>

        <button class="btn" data-print>üñ® Imprimir</button>
      </div>
    `;

    const total = o.total || items.reduce((t,it)=>{
      const qty=it.qty||1;
      return t+(it.price||0)*qty+(it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0)*qty+(it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0)*qty;
    },0);

    return `
      <div class="order" data-id="${doc.id}">
        <div class="order-head">
          <div>
            <div class="order-title">#${o.orderNumber || doc.id.slice(-5)} ‚Äî ${o.nombre||"Cliente"}</div>
            <div class="muted">${dtText}</div>

            <div class="chips">
              <span class="chip">Pedido: #${o.orderNumber || doc.id.slice(-5)}</span>
              <span class="chip">Estado: ${st}</span>
              <span class="chip">Retiro: ${o.entrega||"mostrador"}</span>
              <span class="chip">Horario: ${pickupPretty||"‚Äî"}</span>
            </div>

            ${stateBtns}
          </div>

          <div class="order-right">
            <div class="right-total">$ ${total}</div>
            ${payLine}
          </div>
        </div>

        <div class="divider"></div>
        <div class="items">${itemsHTML}</div>
      </div>
    `;
  }



  /* ================= TICKET ================= */
  function buildTicketHTML(docSnap){
    const o = docSnap.data();

    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    const orderNum = o.orderNumber || docSnap.id.slice(-5);
    const dt = pickDate(o);
    const dateStr = dt.toLocaleDateString("es-AR");
    const timeStr = dt.toLocaleTimeString("es-AR",{hour12:false});

    const pickupPretty = getPickupPretty(o) || "A la brevedad";

    const items = Array.isArray(o.items)?o.items:[];

    const lines = items.map(it=>{
      const qty=it.qty||1;
      const base=(it.price||0)*qty;
      return `${qty}√ó ${it.name} - ${money(base)}`;
    }).join("<br>");

    const total = o.total || items.reduce((t,it)=>{
      const qty=it.qty||1;
      return t+(it.price||0)*qty;
    },0);

    return `
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Ticket</title>
<style>
  @page{ size:58mm auto; margin:0; }
  body{font-family:Arial; font-size:13px;}
  .c{text-align:center}
  .blk{margin:4px 0}
</style>
</head>
<body>
  <div class="c"><strong>Rhodes Burgers</strong></div>
  <div class="c">Pedido #${orderNum}</div>
  <div>${dateStr} ${timeStr}</div>

  <div class="blk"><strong>Retira:</strong> ${pickupPretty}</div>

  <hr>
  ${lines}
  <hr>

  <div><strong>Total:</strong> ${money(total)}</div>

  <script>window.onload=()=>setTimeout(()=>print(),50)</script>
</body>
</html>
    `;
  }

  function printInIframe(docSnap){
    const html = buildTicketHTML(docSnap);
    const iframe = document.createElement("iframe");
    iframe.style.position="fixed";
    iframe.style.width="0"; iframe.style.height="0";
    document.body.appendChild(iframe);
    const d = iframe.contentWindow.document;
    d.open(); d.write(html); d.close();
    setTimeout(()=>document.body.removeChild(iframe),3000);
  }



  /* ================= RENDER LIST ================= */
  let lastSnap=null;
  let idToDoc=new Map();

  function renderList(snap){
    const docs = snap.docs.filter(d=>passFilter(d.data()));
    idToDoc = new Map(snap.docs.map(d=>[d.id,d]));

    $("#orders").innerHTML = docs.length ?
      docs.map(renderOrder).join("") :
      '<p class="muted">No hay pedidos.</p>';

    document.querySelectorAll(".order").forEach(card=>{
      const id=card.dataset.id;

      card.querySelectorAll("[data-act]").forEach(btn=>{
        btn.onclick = ()=> setOrderStatus(id, btn.dataset.act);
      });

      const paySel = card.querySelector(".pay-method-select");
      if(paySel){
        paySel.onchange = async ()=>{
          const v = paySel.value;
          await db.collection("orders").doc(id).update({pago:v,payment_method:v});
        };
      }

      const toggle = card.querySelector("[data-pay-toggle]");
      if(toggle){
        toggle.onclick = async ()=>{
          const paid = toggle.dataset.payToggle==="pending";
          toggle.dataset.payToggle = paid?"paid":"pending";
          toggle.textContent = paid?"PAGADO ‚úì":"PENDIENTE DE PAGO";
          toggle.classList.toggle("is-paid",paid);
          toggle.classList.toggle("is-pending",!paid);
          await setPaymentStatus(id,paid);
        };
      }

      const b = card.querySelector("[data-print]");
      if(b){
        b.onclick = ()=>printInIframe(idToDoc.get(id));
      }
    });
  }



  /* ================= SUSCRIPCI√ìN REALTIME ================= */
  db.collection("orders").orderBy("createdAt","desc").limit(300)
    .onSnapshot(snap=>{
      lastSnap=snap;
      renderList(snap);

      snap.docChanges().forEach(ch=>{
        if(ch.type==="added"){
          playBeepTriple();
          if(autoPrint) printInIframe(ch.doc);
        }
      });
    });

}); // DOMContentLoaded
</script>

</body>
</html>
