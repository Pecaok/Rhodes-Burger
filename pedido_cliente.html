<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71;
      --text:#141414;
      --muted:#667085;
      --bg:#f6f7f8;
      --card:#ffffff;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --ring:#e7e7e7;
    }
    *{box-sizing:border-box}
    html,body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}

    /* ---------- Topbar ---------- */
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px}
    .brand{display:inline-flex; align-items:center; gap:10px; text-decoration:none; color:inherit}
    .brand img{width:34px; height:34px; border-radius:8px; object-fit:contain}
    .spacer{flex:1}
    .btn{display:inline-flex; align-items:center; gap:10px; border:2px solid var(--ring); padding:10px 16px; border-radius:999px; color:#333; background:#fff; font-weight:700; text-decoration:none; cursor:pointer}
    .btn.primary{ border-color:var(--primary); background:var(--primary); color:#fff }
    .btn.ghost{border-color:var(--ring); color:#333}
    .btn.small{ padding:8px 12px; font-weight:600 }

    /* ---------- Layout ---------- */
    main{max-width:1100px; margin:24px auto; padding:0 12px; position:relative}
    h1{font-size:32px; margin:12px 4px 18px}
    .grid-2{display:grid; grid-template-columns: 1.1fr .9fr; gap:20px}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}

    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:14px}
    .field label{font-weight:700}
    .field input, .field textarea{
      width:100%; border:2px solid var(--ring); border-radius:12px; padding:12px 14px; font-size:16px; outline:none;
      background:#fff;
    }
    .field textarea{min-height:120px; resize:vertical}

    .inline{display:flex; gap:12px; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      border:2px solid var(--ring); border-radius:16px; padding:12px 16px; cursor:pointer; user-select:none;
      background:#fff; min-width:180px; justify-content:flex-start;
    }
    .pill .dot{
      width:16px; height:16px; border:2px solid #aaa; border-radius:999px; display:inline-block;
      background:#fff; position:relative;
    }
    .pill input{display:none}
    .pill.selected{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(46,204,113,.12) }
    .pill.selected .dot{border-color:var(--primary)}
    .pill.selected .dot::after{
      content:""; position:absolute; inset:3px; border-radius:999px; background:var(--primary);
    }
    .muted{color:var(--muted); font-size:14px}

    .totalRow{display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; margin-top:10px}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px}

    /* ---------- Tabla de resumen ---------- */
    .summary .row{
      display:flex; align-items:flex-start; justify-content:space-between; padding:12px 0; border-bottom:1px solid #efefef;
    }
    .summary .name{font-weight:700}
    .summary .sub{color:var(--muted); font-size:13px; margin-top:4px}

    /* ---------- Marca de agua de fondo (logo de fondo) ---------- */
    .wm{
      position:fixed; inset:0; z-index:0; pointer-events:none;
      display:flex; align-items:center; justify-content:center;
      opacity:.14;               /* m√°s notorio, ajust√° si quer√©s */
    }
    .wm img{
      width:100vw; height:100vh; object-fit:cover;   /* Cubre toda la pantalla */
      filter:grayscale(100%) contrast(120%);
    }

    /* ---------- Responsivo ---------- */
    @media (max-width:900px){
      .grid-2{ grid-template-columns: 1fr; }
    }
    @media (max-width:640px){
      .wm{ opacity:.16 }
      .pill{ min-width:unset; }
      .btn.small{ padding:7px 10px }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <!-- Solo el logo (sin texto) -->
      <a href="index.html" class="brand" aria-label="Volver al men√∫">
        <img src="images/logo.png" alt="Rhodes Burgers">
      </a>
      <div class="spacer"></div>
      <a class="btn small ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <!-- Marca de agua de fondo, ocupa TODA la pantalla -->
  <div class="wm" aria-hidden="true">
    <img src="images/logo.png" alt="">
  </div>

  <main>
    <h1>Confirmar pedido</h1>

    <div class="grid-2">
      <!-- Columna izquierda: datos -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" placeholder="Ej: Juan P√©rez" autocomplete="name" />
        </div>

        <div class="field">
          <label>Tel√©fono (opcional)</label>
          <input id="inpTel" placeholder="Ej: 11 2345 6789" autocomplete="tel" />
        </div>

        <div class="field">
          <label>Medio de pago</label>
          <div class="inline" id="wrapPago">
            <label class="pill" data-value="mercado_pago">
              <span class="dot"></span>
              <span>üí≥ Mercado Pago</span>
              <input type="radio" name="pago" value="mercado_pago">
            </label>
            <label class="pill" data-value="efectivo">
              <span class="dot"></span>
              <span>üíµ Efectivo</span>
              <input type="radio" name="pago" value="efectivo">
            </label>
          </div>
        </div>

        <div class="field">
          <label>Tipo de entrega</label>
          <div class="inline" id="wrapEntrega">
            <label class="pill" data-value="take_away">
              <span class="dot"></span>
              <span>üßæ Take Away</span>
              <input type="radio" name="entrega" value="take_away">
            </label>
          </div>
          <div class="muted">* Solo retiro por el local.</div>
        </div>

        <div class="field">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div class="actions">
          <a class="btn ghost" href="index.html">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>
      </section>

      <!-- Columna derecha: Resumen -->
      <aside class="card summary">
        <h2 style="margin:0 0 10px">Resumen</h2>
        <div id="sumItems"></div>
        <div class="totalRow"><span>Total</span><span id="sumTotal">$ 0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (compat, sin tocar tu conexi√≥n) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // === TU CONFIG FIREBASE (la que me pasaste) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    // ===== Utilidades y carrito =====
    const $ = s => document.querySelector(s);
    const CART_KEY = "rhodes_cart_v3";
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function loadCart(){
      try{ return JSON.parse(localStorage.getItem(CART_KEY)) || { burger:{}, drink:{}, fries:null }; }
      catch{ return { burger:{}, drink:{}, fries:null }; }
    }
    function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    function clearCart(){ saveCart({ burger:{}, drink:{}, fries:null }); }

    function calcTotal(cart){
      let t = 0;
      for(const b of Object.values(cart.burger)){
        const base = Number(b.item?.price)||0;
        const extras = ((b.extras?.patty||0)* (b.extraPricePatty||0)) + ((b.extras?.cheddar||0)* (b.extraPriceCheddar||0));
        t += (base + extras) * (b.qty||0);
      }
      for(const d of Object.values(cart.drink)){
        t += (Number(d.item?.price)||0) * (d.qty||0);
      }
      return t;
    }

    // === Estado ===
    let cart = loadCart();

    // Radios pill
    function setupPills(container){
      container.querySelectorAll(".pill").forEach(p=>{
        p.addEventListener("click", ()=>{
          container.querySelectorAll(".pill").forEach(x=>x.classList.remove("selected"));
          p.classList.add("selected");
          const input = p.querySelector("input[type=radio]");
          if(input) input.checked = true;
        });
      });
    }
    setupPills($("#wrapPago"));
    setupPills($("#wrapEntrega"));

    // Render resumen
    const sumBox = $("#sumItems");
    const sumTotal = $("#sumTotal");

    function renderResumen(){
      sumBox.innerHTML = "";
      // hamburguesas
      for(const obj of Object.values(cart.burger)){
        const unit = Number(obj.item?.price)||0;
        const extrasCost = ((obj.extras?.patty||0)*(obj.extraPricePatty||0)) + ((obj.extras?.cheddar||0)*(obj.extraPriceCheddar||0));
        const txtExtras = [];
        if(obj.extras){
          if(obj.extras.patty) txtExtras.push(`+${obj.extras.patty} medall√≥n(es)`);
          if(obj.extras.cheddar) txtExtras.push(`+${obj.extras.cheddar} cheddar`);
        }
        const friesTxt = obj.friesChoice === "con_sazon" ? "Con saz√≥n" : (obj.friesChoice==="sin_sazon" ? "Sin sazonar" : "-");
        sumBox.insertAdjacentHTML("beforeend", `
          <div class="row">
            <div>
              <div class="name">${obj.item?.name||"Hamburguesa"} <span class="muted">¬∑ $ ${unit.toLocaleString("es-AR")} x ${obj.qty||1}</span></div>
              <div class="sub">Papas: ${friesTxt}${txtExtras.length?` ¬∑ ${txtExtras.join(" ¬∑ ")}`:""}</div>
            </div>
            <div>${money((unit+extrasCost)*(obj.qty||1))}</div>
          </div>
        `);
      }
      // bebidas
      for(const obj of Object.values(cart.drink)){
        sumBox.insertAdjacentHTML("beforeend", `
          <div class="row">
            <div>
              <div class="name">${obj.item?.name||"Bebida"} <span class="muted">¬∑ $ ${(obj.item?.price||0).toLocaleString("es-AR")} x ${obj.qty||1}</span></div>
            </div>
            <div>${money((Number(obj.item?.price)||0)*(obj.qty||1))}</div>
          </div>
        `);
      }
      sumTotal.textContent = money(calcTotal(cart));
    }
    renderResumen();

    // Confirmar
    $("#btnConfirmar").onclick = async ()=>{
      // Validaciones
      const nombre = $("#inpNombre").value.trim();
      if(!nombre){ alert("Ingres√° tu nombre y apellido."); return; }

      const tel = $("#inpTel").value.trim();

      const pagoSel = document.querySelector('input[name="pago"]:checked');
      if(!pagoSel){ alert("Eleg√≠ un medio de pago."); return; }
      const pago = pagoSel.value;

      const entrSel = document.querySelector('input[name="entrega"]:checked');
      if(!entrSel){ alert("Eleg√≠ el tipo de entrega (Take Away)."); return; }
      const entrega = entrSel.value;

      if(Object.keys(cart.burger).length===0 && Object.keys(cart.drink).length===0){
        alert("Tu carrito est√° vac√≠o."); return;
      }

      // Preparar items para Firestore
      const itemsFS = [];
      for(const b of Object.values(cart.burger)){
        itemsFS.push({
          type:"burger",
          id:b.item?.id || "",
          name:b.item?.name || "Hamburguesa",
          qty: b.qty||1,
          price: Number(b.item?.price)||0,
          fries: b.friesChoice || null,
          extras: b.extras || null
        });
      }
      for(const d of Object.values(cart.drink)){
        itemsFS.push({
          type:"drink",
          id:d.item?.id || "",
          name:d.item?.name || "Bebida",
          qty: d.qty||1,
          price: Number(d.item?.price)||0,
        });
      }

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nombre,
        telefono: tel || "",
        pago,
        entrega,
        notes: $("#inpNotas").value.trim() || "",
        items: itemsFS,
        total: calcTotal(cart),
        status: "accepted"
      };

      const btn = $("#btnConfirmar");
      btn.disabled = true; btn.textContent = "Guardando...";

      try{
        // Guardamos el pedido
        const ref = await db.collection("orders").add(order);

        if(pago === "mercado_pago"){
          // Armo items para MP (evitar precios 0)
          const mpItems = [];
          for(const it of itemsFS){
            if(it.type==="burger" || it.type==="drink"){
              if(Number(it.price)>0){
                mpItems.push({
                  title: it.name,
                  quantity: it.qty || 1,
                  currency_id: "ARS",
                  unit_price: Number(it.price)||0
                });
              }
            }
          }
          if(mpItems.length===0){
            mpItems.push({ title:"Pedido Rhodes Burgers", quantity:1, currency_id:"ARS", unit_price: Number(order.total)||0 });
          }

          // Llamo a Netlify (tu funci√≥n createPreference existente)
          const resp = await fetch("/.netlify/functions/createPreference", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ orderId: ref.id, items: mpItems, total: Number(order.total)||0 })
          });
          const raw = await resp.text(); let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }

          if(!resp.ok){
            console.error("MP error", resp.status, data);
            alert(`No pudimos iniciar Mercado Pago (HTTP ${resp.status}).`);
            btn.disabled=false; btn.textContent="Ir a pagar"; return;
          }
          const url = data.init_point || data.sandbox_init_point;
          if(!url){ alert("Preferencia creada sin URL. Revis√° el Access Token en Netlify."); btn.disabled=false; btn.textContent="Ir a pagar"; return; }

          clearCart();
          window.location.href = url;
          return;
        }

        // Efectivo
        clearCart();
        alert("¬°Pedido enviado! ‚úÖ");
        window.location.href = "index.html";
      }catch(err){
        console.error(err);
        alert("No pudimos guardar el pedido.");
      }finally{
        btn.disabled=false; btn.textContent="Ir a pagar";
      }
    };
  </script>
</body>
</html>
