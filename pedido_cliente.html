<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <link rel="stylesheet" href="css/theme.css" />
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand">
        <img src="images/logo.png" alt="Rhodes Burgers"
             onerror="this.onerror=null;this.src='images/logo.jpg'">
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">← Seguir comprando</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>
    <div class="grid-2">
      <!-- Columna izquierda: datos -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" placeholder="Ej: Juan Pérez" autocomplete="name" />
        </div>

        <div class="inline">
          <label class="pill"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
          <label class="pill"><input type="radio" name="pago" value="efectivo"> Efectivo</label>
        </div>

        <div class="inline" style="margin-top:8px">
          <label class="pill"><input type="radio" name="entrega" value="delivery"> Delivery</label>
          <label class="pill"><input type="radio" name="entrega" value="take_away"> Take Away</label>
        </div>

        <div class="field" id="dirWrap" style="display:none">
          <label>Dirección (solo si es Delivery)</label>
          <input id="inpDireccion" placeholder="Calle, número, piso" autocomplete="address-line1" />
        </div>

        <!-- (SIN papas acá: las papas vienen desde el index por cada hamburguesa) -->

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnCancelar">Cancelar</button>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>
        <p class="muted" id="status" style="margin-top:8px"></p>
      </section>

      <!-- Columna derecha: resumen -->
      <aside class="card">
        <h2>Resumen</h2>
        <div id="items"></div>
        <div class="total"><span>Total</span><span id="total">$0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (compat, como vos lo tenías) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    // ===== CARRITO / UI =====
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const CART_KEY = "rhodes_cart_v3";

    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{}}; }catch{ return {burger:{},drink:{}}; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function clearCart(){ saveCart({burger:{},drink:{}}); }
    function cartCount(c){ let n=0; for(const b of Object.values(c.burger)) n+=b.qty; for(const d of Object.values(c.drink||{})) n+=d.qty; return n; }
    function calcTotal(c){
      let t=0;
      for(const b of Object.values(c.burger)){
        const base = Number(b.item?.price)||0;
        const pat = Number(b.extras?.patty)||0;
        const che = Number(b.extras?.cheddar)||0;
        // si los extras suman precio en tu index, podés sumarlos acá también si querés
        t += base * (Number(b.qty)||0);
      }
      for(const d of Object.values(c.drink||{})){
        t += (Number(d.item?.price)||0) * (Number(d.qty)||0);
      }
      return t;
    }

    let cart = loadCart();

    const itemsEl = $("#items");
    const totalEl = $("#total");
    const statusEl = $("#status");
    const dirWrap = $("#dirWrap"), inpDireccion=$("#inpDireccion");
    const inpNombre = $("#inpNombre");
    const btnConfirmar = $("#btnConfirmar");

    function renderResumen(){
      const rows=[];
      // Hamburguesas (con detalle de papas por producto)
      for(const obj of Object.values(cart.burger)){
        const friesTxt = obj.fries === "con_sazon" ? "Con sazón"
                        : obj.fries === "sin_sazon" ? "Sin sazonar" : "—";
        const extrasTxt=[];
        if(obj.extras){
          if(obj.extras.patty) extrasTxt.push(`+${obj.extras.patty} medallón(es)`);
          if(obj.extras.cheddar) extrasTxt.push(`+${obj.extras.cheddar} cheddar`);
        }
        rows.push(`<div class="item">
          <div>
            <strong>${obj.item.name}</strong>
            <div class="muted">Papas: ${friesTxt}</div>
            ${extrasTxt.length?`<div class="muted">${extrasTxt.join(" · ")}</div>`:""}
            ${obj.notes?`<div class="muted">Notas: ${obj.notes}</div>`:""}
            <div class="muted">${money(obj.item.price)} x ${obj.qty}</div>
          </div>
          <div>${money((Number(obj.item.price)||0)*obj.qty)}</div>
        </div>`);
      }
      // Bebidas
      for(const obj of Object.values(cart.drink||{})){
        rows.push(`<div class="item">
          <div>
            <strong>${obj.item.name}</strong>
            <div class="muted">${money(obj.item.price)} x ${obj.qty}</div>
          </div>
          <div>${money((Number(obj.item.price)||0)*obj.qty)}</div>
        </div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal(cart));
    }

    // Mostrar/ocultar dirección por tipo de entrega
    document.querySelectorAll('input[name="entrega"]').forEach(r=>{
      r.addEventListener("change", ()=>{ dirWrap.style.display = (r.value==="delivery") ? "block" : "none"; });
    });

    $("#btnCancelar").onclick = ()=> { window.location.href = "index.html"; };

    // Confirmar
    btnConfirmar.onclick = async ()=>{
      if(cartCount(cart)===0){ alert("Tu carrito está vacío."); return; }
      const nombre = inpNombre.value.trim();
      if(!nombre){ alert("Ingresá tu nombre y apellido."); return; }
      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Elegí un método de pago."); return; }
      const entregaEl = document.querySelector('input[name="entrega"]:checked');
      if(!entregaEl){ alert("Elegí si es Delivery o Take Away."); return; }

      const entrega = entregaEl.value;
      const direccion = entrega==="delivery" ? (inpDireccion.value.trim()) : "";
      if(entrega==="delivery" && !direccion){ alert("Ingresá la dirección para Delivery."); return; }

      // Ítems para Firestore y para MP
      const itemsFS=[], mpItems=[];
      for(const o of Object.values(cart.burger)){
        itemsFS.push({
          type:"burger",
          id:o.item.id,
          name:o.item.name,
          qty:o.qty,
          price:Number(o.item.price)||0,
          fries: o.fries || null,
          ...(o.notes?{notes:o.notes}:{})
        });
        mpItems.push({title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0});
      }
      for(const o of Object.values(cart.drink||{})){
        itemsFS.push({type:"drink", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0});
        mpItems.push({title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0});
      }

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nombre,
        pago: pagoEl.value,
        entrega,
        direccion,
        // sin 'fries' global porque ahora va por ítem
        items: itemsFS,
        total: calcTotal(cart),
        status: "accepted"
      };

      try{
        btnConfirmar.disabled = true;
        statusEl.textContent = "Guardando pedido...";
        const docRef = await db.collection("orders").add(order);

        if (order.pago === "mercado_pago") {
          const valid = mpItems.filter(x => x.quantity>0 && Number.isFinite(x.unit_price) && x.unit_price>0);
          const payloadItems = valid.length ? valid : [{ title:"Pedido Rhodes Burgers", quantity:1, currency_id:"ARS", unit_price:Number(order.total)||0 }];

          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId: docRef.id, total: Number(order.total)||0, nombre: order.nombre, items: payloadItems })
          });

          const raw = await resp.text(); let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }
          if(!resp.ok){ console.error("MP error", resp.status, data); alert(`Error MP ${resp.status}: ${data.error||data.raw||"sin detalle"}`); btnConfirmar.disabled=false; return; }

          const url = data.init_point || data.sandbox_init_point;
          if(!url){ alert("Preferencia creada sin URL. Revisá el Access Token en Netlify."); btnConfirmar.disabled=false; return; }

          clearCart();
          window.location.href = url;
          return;
        }

        // Efectivo
        clearCart();
        alert("¡Pedido enviado! ✅");
        window.location.href = "index.html";
      }catch(err){
        console.error(err);
        statusEl.textContent = "Error guardando el pedido.";
        alert("No pudimos guardar el pedido o iniciar el pago.");
      }finally{
        btnConfirmar.disabled = false;
      }
    };

    // Inicio
    (function init(){ renderResumen(); })();
  </script>
</body>
</html>
