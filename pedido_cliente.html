<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <!-- Si ya tenés un theme.css, usalo. Este HTML quedó pensado para el mismo look&feel que index -->
  <link rel="stylesheet" href="css/theme.css" />
  <style>
    /* Ajustes suaves por si tu theme no existe o para reforzar el layout */
    body { background: #f6f6f6; color:#111; font-family: system-ui, Segoe UI, Roboto, Inter, Arial, sans-serif; margin:0; }
    .topbar { max-width: 1100px; margin: 0 auto; padding: 12px; display:flex; align-items:center; gap:12px; }
    header { position:sticky; top:0; background:#fff; box-shadow: 0 2px 12px rgba(0,0,0,.06); z-index:10; }
    .brand { display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; }
    .brand img { width:36px; height:36px; border-radius:10px; object-fit:contain; background:#fff; }
    .spacer{ flex:1; }

    .container { max-width:1100px; margin: 24px auto; padding: 0 12px; }
    h1 { font-size: 36px; margin: 10px 4px 18px; }

    .grid2 { display:grid; grid-template-columns: 1fr 420px; gap: 18px; }
    @media (max-width: 980px){
      .grid2 { grid-template-columns: 1fr; }
    }

    .card { background:#fff; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:16px; }

    .field { margin: 14px 0; }
    .field label { display:block; font-weight:700; margin-bottom:6px; }
    .input, textarea { width:100%; border:1px solid #e7e7e7; border-radius:12px; padding:12px 14px; font-size:16px; }
    textarea { min-height:110px; resize:vertical; }

    .group { margin: 14px 0; }
    .pills { display:flex; gap:12px; flex-wrap:wrap; }
    .pill {
      border:1px solid #e7e7e7; border-radius:999px; padding:10px 14px;
      display:inline-flex; align-items:center; gap:8px; background:#fff;
    }
    .pill input { accent-color:#2ecc71; }
    .subnote { color:#888; font-size:13px; margin-top:6px; }

    .btn { display:inline-flex; align-items:center; justify-content:center; gap:10px;
      border:2px solid #2ecc71; padding:10px 18px; border-radius:999px; color:#2ecc71; background:#fff; font-weight:800; cursor:pointer; }
    .btn.primary { background:#2ecc71; color:#fff; }
    .btn.ghost { border-color:#e7e7e7; color:#333; }

    .row-actions { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }

    .sum-item { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #f0f0f0; }
    .sum-item .muted { color:#666; font-size:14px; }
    .total { margin-top: 10px; display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; }
    .muted { color:#666; }
    .ok { color:#2ecc71; }
    .err { color:#c0392b; }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand">
        <img src="images/logo.png" alt="Rhodes Burgers">
        <strong>Rhodes Burgers</strong>
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">← Volver al menú</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>

    <div class="grid2">
      <!-- Columna izquierda: formulario -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" class="input" placeholder="Ej: Juan Pérez" autocomplete="name" />
        </div>

        <div class="field">
          <label>Teléfono (opcional)</label>
          <input id="inpTel" class="input" placeholder="Ej: 11 2345 6789" autocomplete="tel" />
        </div>

        <div class="group">
          <label>Medio de pago</label>
          <div class="pills">
            <label class="pill"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
            <label class="pill"><input type="radio" name="pago" value="efectivo"> Efectivo</label>
          </div>
        </div>

        <div class="group">
          <label>Tipo de entrega</label>
          <div class="pills">
            <label class="pill"><input type="radio" name="entrega" value="take_away" checked> Take Away</label>
          </div>
          <div class="subnote">* Solo retiro por el local.</div>
        </div>

        <div class="field">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div class="row-actions">
          <button id="btnCancelar" class="btn ghost">Cancelar</button>
          <button id="btnConfirmar" class="btn primary">Ir a pagar</button>
        </div>

        <p id="status" class="muted" style="margin-top:10px"></p>
      </section>

      <!-- Columna derecha: resumen -->
      <aside class="card">
        <h2 style="margin:6px 0 10px">Resumen</h2>
        <div id="items"></div>
        <div id="friesInfo" class="muted" style="margin-top:8px"></div>
        <div class="total"><span>Total</span><span id="total">$0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (solo lo usamos para EFECTIVO si querés escribir directo) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Tus credenciales (las mismas que ya venías usando)
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    /* =================== Helpers & Estado =================== */
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const encB64 = (obj) => {
      const str = JSON.stringify(obj);
      // TextEncoder -> btoa
      const bytes = new TextEncoder().encode(str);
      let bin = "";
      bytes.forEach(b => bin += String.fromCharCode(b));
      return btoa(bin);
    };

    const CART_KEY = "rhodes_cart_v3";
    function loadCart(){
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{},fries:null}; }
      catch { return {burger:{},drink:{},fries:null}; }
    }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function clearCart(){ saveCart({burger:{},drink:{},fries:null}); }
    function cartCount(c){ let n=0; for(const b of Object.values(c.burger)) n+=b.qty; for(const d of Object.values(c.drink)) n+=d.qty; return n; }
    function calcTotal(c){
      let t=0;
      for(const b of Object.values(c.burger)){
        const base = Number(b.item?.price||0);
        // si manejás extras en index, sumalos acá si querés
        t += base * (b.qty||0);
      }
      for(const d of Object.values(c.drink)){
        t += Number(d.item?.price||0) * (d.qty||0);
      }
      return t;
    }

    let cart = loadCart();

    /* =================== Render Resumen =================== */
    const itemsEl = $("#items"), totalEl = $("#total"), friesInfo = $("#friesInfo");
    function renderResumen(){
      const rows = [];
      for(const o of Object.values(cart.burger)){
        const unit = Number(o.item?.price||0);
        const friesTxt = o.fries ? ` · Papas: ${o.fries==="con_sazon"?"Con sazón":"Sin sazonar"}` : "";
        rows.push(`
          <div class="sum-item">
            <div>
              <div><strong>${o.item.name}</strong></div>
              <div class="muted">${money(unit)} x ${o.qty}${friesTxt}</div>
            </div>
            <div>${money(unit*(o.qty||0))}</div>
          </div>
        `);
      }
      for(const o of Object.values(cart.drink)){
        const unit = Number(o.item?.price||0);
        rows.push(`
          <div class="sum-item">
            <div>
              <div><strong>${o.item.name}</strong></div>
              <div class="muted">${money(unit)} x ${o.qty}</div>
            </div>
            <div>${money(unit*(o.qty||0))}</div>
          </div>
        `);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal(cart));

      // Si usás papas globales en index, mostralas:
      if (cart.fries) {
        friesInfo.textContent = `Papas elegidas: ${cart.fries==="con_sazon"?"Con sazón":"Sin sazonar"}.`;
      } else {
        friesInfo.textContent = "";
      }
    }
    renderResumen();

    /* =================== Interacciones =================== */
    $("#btnCancelar").onclick = ()=> location.href="index.html";

    $("#btnConfirmar").onclick = async () => {
      if (cartCount(cart) === 0) { alert("Tu carrito está vacío."); return; }

      const nombre = $("#inpNombre").value.trim();
      if (!nombre) { alert("Ingresá tu nombre y apellido."); return; }

      const tel = $("#inpTel").value.trim();
      const notas = $("#inpNotas").value.trim();

      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if (!pagoEl) { alert("Elegí un medio de pago."); return; }
      const pago = pagoEl.value;

      const entrega = "take_away"; // única opción activa

      // Armamos items para Firestore y para MP
      const itemsFS = [], mpItems = [];
      for (const o of Object.values(cart.burger)) {
        itemsFS.push({
          type:"burger",
          id:o.item.id, name:o.item.name,
          qty:o.qty, price:Number(o.item.price)||0,
          fries: o.fries || cart.fries || null,
          ...(o.notes?{notes:o.notes}:{})
        });
        mpItems.push({
          title: o.item.name,
          quantity: Number(o.qty)||1,
          unit_price: Number(o.item.price)||0,
          currency_id: "ARS"
        });
      }
      for (const o of Object.values(cart.drink)) {
        itemsFS.push({ type:"drink", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0 });
        mpItems.push({ title:o.item.name, quantity:Number(o.qty)||1, unit_price:Number(o.item.price)||0, currency_id:"ARS" });
      }

      const order = {
        nombre, telefono: tel || "", pago, entrega,
        fries: cart.fries || null,
        items: itemsFS,
        notas: notas || "",
        total: calcTotal(cart),
        status: pago === "efectivo" ? "accepted" : "pending"
      };

      const btn = $("#btnConfirmar"), status = $("#status");
      btn.disabled = true; status.textContent = "Procesando...";

      try {
        if (pago === "mercado_pago") {
          // Filtramos ítems con precio > 0; si justo todos dan $0, mandamos uno resumen con el total
          const valid = mpItems.filter(x => (x.quantity>0) && Number.isFinite(x.unit_price) && x.unit_price>0);
          const payloadItems = valid.length ? valid : [{ title:"Pedido Rhodes Burgers", quantity:1, unit_price:Number(order.total)||0, currency_id:"ARS" }];

          // Codificar orden para que la guarde mp-success SOLO si el pago queda "approved"
          const orderB64 = encB64(order);

          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderB64, items: payloadItems, ref: "web" })
          });

          const raw = await resp.text();
          let data={}; try{ data=JSON.parse(raw) }catch{ data={ raw } }

          if (!resp.ok || !data.init_point) {
            console.error("MP error", resp.status, data);
            alert("No se pudo iniciar el pago. Probá de nuevo.");
            return;
          }

          // Éxito: limpiamos carrito y salimos a MP
          clearCart();
          location.href = data.init_point;
          return;
        }

        // === EFECTIVO === (se guarda directo desde el cliente, como ya hacías)
        const doc = await db.collection("orders").add({
          ...order,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        clearCart();
        alert("¡Pedido enviado! ✅");
        location.href = "index.html";
      } catch (err) {
        console.error(err);
        status.textContent = "No pudimos procesar el pedido.";
        alert("Ocurrió un error. Probá nuevamente.");
      } finally {
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
