<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pedido - Rhodes Burgers</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>Ver mi pedido</h1>
  <div id="cart-container"></div>

  <h2>Datos del cliente</h2>
  <input type="text" id="inpNombre" placeholder="Nombre y apellido"/>
  
  <h3>Método de pago</h3>
  <label><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
  <label><input type="radio" name="pago" value="efectivo"> Efectivo</label>
  
  <h3>Tipo de entrega</h3>
  <label><input type="radio" name="entrega" value="delivery"> Delivery</label>
  <label><input type="radio" name="entrega" value="takeaway"> Take Away</label>
  
  <div id="direccion-container" style="display:none;">
    <input type="text" id="inpDireccion" placeholder="Dirección para delivery"/>
  </div>
  
  <h3>Tipo de papas</h3>
  <label><input type="radio" name="papas" value="sazonadas"> Sazonadas</label>
  <label><input type="radio" name="papas" value="sin_sazonar"> Sin sazonar</label>
  
  <p id="status"></p>
  <button id="btnConfirmar">Ir a pagar</button>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    // Simulación carrito (debería venir de localStorage o Firebase)
    let cart = JSON.parse(localStorage.getItem("cart") || '{"burger":{},"drink":{}}');
    const cartCount = () => {
      return Object.values(cart.burger).reduce((a,b)=>a+b.qty,0) +
             Object.values(cart.drink).reduce((a,b)=>a+b.qty,0);
    };
    const calcTotal = () => {
      let total = 0;
      for(const o of Object.values(cart.burger)) total += Number(o.item.price)*o.qty;
      for(const o of Object.values(cart.drink)) total += Number(o.item.price)*o.qty;
      return total;
    };
    const clearCart = () => { localStorage.removeItem("cart"); cart = {burger:{},drink:{}}; };

    // Mostrar dirección si elige delivery
    document.querySelectorAll('input[name="entrega"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        document.getElementById("direccion-container").style.display =
          r.value === "delivery" ? "block" : "none";
      });
    });

    document.getElementById("btnConfirmar").onclick = async () => {
      const $ = (s)=>document.querySelector(s);

      if(cartCount()===0){ alert("Tu carrito está vacío."); return; }
      const nombre = $("#inpNombre").value.trim();
      if(!nombre){ alert("Ingresá tu nombre y apellido."); return; }
      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Elegí un método de pago."); return; }
      const entregaEl = document.querySelector('input[name="entrega"]:checked');
      if(!entregaEl){ alert("Elegí si es Delivery o Take Away."); return; }
      const papasEl = document.querySelector('input[name="papas"]:checked');
      if(!papasEl){ alert("Elegí una opción de papas."); return; }

      const entrega = entregaEl.value;
      const direccion = entrega==="delivery" ? ($("#inpDireccion").value.trim()) : "";
      if(entrega==="delivery" && !direccion){ alert("Ingresá la dirección para Delivery."); return; }

      const itemsFS=[];
      for (const o of Object.values(cart.burger)) itemsFS.push({type:"burger", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0, ...(o.notes?{notes:o.notes}:{})});
      for (const o of Object.values(cart.drink))  itemsFS.push({type:"drink",  id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0});

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nombre,
        pago: pagoEl.value,
        entrega,
        direccion,
        fries: papasEl.value,
        items: itemsFS,
        total: Number(calcTotal())||0,
        status: "pending"
      };

      try{
        const btn = document.getElementById("btnConfirmar");
        btn.disabled = true;
        document.getElementById("status").textContent = "Guardando pedido...";
        const docRef = await db.collection("orders").add(order);

        if (order.pago === "mercado_pago") {
          let mpItems = order.items.map(it => ({
            title: String(it.name),
            quantity: Number(it.qty)||1,
            currency_id: "ARS",
            unit_price: Number(it.price)||0
          }))
          .filter(x => x.quantity > 0 && Number.isFinite(x.unit_price) && x.unit_price > 0);

          if (mpItems.length === 0) {
            const amount = Number(order.total)||0;
            if (amount <= 0) { alert("El total del pedido es 0. No se puede pagar por MP."); btn.disabled=false; return; }
            mpItems = [{ title:"Pedido Rhodes Burgers", quantity:1, currency_id:"ARS", unit_price: amount }];
          }

          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId: docRef.id, total: Number(order.total)||0, nombre: order.nombre, items: mpItems })
          });
          const data = await resp.json();
          if(!resp.ok){ alert(`Error MP ${resp.status}: ${data.error||"sin detalle"}`); btn.disabled=false; return; }

          const url = data.init_point || data.sandbox_init_point;
          if(!url){ alert("Preferencia creada sin URL. Revisá el Access Token en Netlify."); btn.disabled=false; return; }

          clearCart();
          window.location.href = url;
          return;
        }

        clearCart();
        alert("¡Pedido enviado! ✅");
        window.location.href = "index.html";
      }catch(err){
        console.error(err);
        alert("Error guardando el pedido o conectando con Mercado Pago.");
      }finally{
        document.getElementById("btnConfirmar").disabled = false;
      }
    };
  </script>
</body>
</html>
