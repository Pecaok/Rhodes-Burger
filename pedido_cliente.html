<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{--primary:#625A45;--text:#111;--muted:#666;--bg:#f6f6f6;--card:#fff;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.08);--ring:#eaeaea}
    *{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .btn.disabled, .btn[disabled]{ opacity:.6; pointer-events:none; }
    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h1{font-size:32px;margin:10px 0 18px}
    label{font-weight:600;margin:6px 0;display:block}
    input[type="text"]{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    .group{margin:14px 0}
    .chips{display:flex;gap:12px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:999px;padding:10px 14px}
    .chip input{accent-color:var(--primary)}
    .muted{color:var(--muted)}
    .right .row{display:flex;align-items:center;justify-content:space-between;margin:10px 0}
    .total{font-weight:800;font-size:18px}
    textarea{width:100%;min-height:90px;border:1px solid var(--ring);border-radius:12px;padding:10px}
    .actions{display:flex;gap:10px;margin-top:12px}.actions .btn{flex:1}
    .statusHint{font-size:13px;color:var(--muted);margin-top:10px}
    html,body{min-height:100%} body{position:relative}
    body::before{content:"";position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:clamp(240px,48vmin,560px);background:url("images/logo.png") center/contain no-repeat;opacity:.08;pointer-events:none;z-index:5}
    .muted-small{color:var(--muted); font-size:13px; margin-top:6px;}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">← Seguir comprando</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>Confirmar pedido</h1>

      <div class="group">
        <label>Nombre y apellido</label>
        <input id="inpNombre" type="text" placeholder="Ej: Juan Pérez">
      </div>

      <div class="group">
        <label>Teléfono (opcional)</label>
        <input id="inpTelefono" type="text" placeholder="Ej: 11 2345 6789">
      </div>

      <div class="group">
        <label>Medio de pago</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="pago" value="mercado_pago"> Transferencia</label>
          <label class="chip"><input type="radio" name="pago" value="efectivo"> En Local</label>
        </div>
      </div>

      <div class="group">
        <label>Tipo de entrega</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="entrega" value="take_away" checked> Take Away</label>
        </div>
        <div class="muted" style="margin-top:6px">* Solo retiro por el local.</div>
      </div>

      <div class="group">
        <label>Notas (opcional)</label>
        <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        <div class="muted-small">Estas notas serán guardadas en el pedido y aparecerán en el ticket.</div>
      </div>

      <div class="actions">
        <a class="btn ghost" href="index.html">Cancelar</a>
        <button class="btn primary" id="btnConfirmar">Confirmar Pedido</button>
      </div>

      <div class="statusHint">Te redirigimos a WhatsApp con el detalle y un link para seguir el estado.</div>
    </section>

    <aside class="card right">
      <h3>Resumen</h3>
      <div id="resumen"></div>
      <div class="row total">
        <div>Total</div><div id="resTotal">$ 0</div>
      </div>
    </aside>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* === FIREBASE === */
    var firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var db = firebase.firestore();

    /* === CONTADOR UNIFICADO === */
    async function getNextOrderNumber(){
      let lastKnown = 0;
      try {
        const qs = await db.collection('orders').orderBy('orderNumber','desc').limit(1).get();
        if(!qs.empty) lastKnown = Number(qs.docs[0].data().orderNumber)||0;
      } catch(_){}
      const ref = db.collection('config').doc('counters');
      const next = await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        const cur  = snap.exists ? (Number(snap.data().orderNumber)||0) : 0;
        const base = Math.max(cur,lastKnown);
        const nxt  = base + 1;
        tx.set(ref,{orderNumber:nxt,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
        return nxt;
      });
      return next;
    }

    /* === UTIL & ESTADO === */
    var CART_KEY="rhodes_cart_v3";
    function $(s){return document.querySelector(s)}
    function money(n){return (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0})}
    function genTrackToken(len=22){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s="";for(var i=0;i<len;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}
    function loadCart(){try{return JSON.parse(localStorage.getItem(CART_KEY))||{burger:{},drink:{}}}catch(e){return {burger:{},drink:{}}}}
    var cart=loadCart();

    // util para calcular unidad con extras
    function unitWithExtras(it){
      var base=(it.item&&it.item.price)?it.item.price:(it.price||0);
      var pz=((it.extras&&it.extras.patty)?it.extras.patty:0)*((it.extras&&it.extras.EXTRA_PRICE_PATTY)?it.extras.EXTRA_PRICE_PATTY:0);
      var ch=((it.extras&&it.extras.cheddar)?it.extras.cheddar:0)*((it.extras&&it.extras.EXTRA_PRICE_CHEDDAR)?it.extras.EXTRA_PRICE_CHEDDAR:0);
      return base+pz+ch;
    }
    function calcTotal(){var t=0,k,obj;for(k in cart.burger){obj=cart.burger[k];t+=unitWithExtras(obj)*(obj.qty||0)}for(k in cart.drink){obj=cart.drink[k];t+=((obj.item&&obj.item.price)||0)*(obj.qty||0)}return t}

    // CORRECCIÓN: mapear correctamente las 3 opciones de papas
    function friesName(v){
      if(!v) return "—";
      if(v === "con_sazon") return "Sazonadas";
      if(v === "con_sal") return "Con sal";
      if(v === "sin_sal") return "Sin sal";
      // compatibilidad con valores anteriores o variantes
      var s = String(v||'').toLowerCase();
      if(s.includes("sazon") && !s.includes("sin")) return "Sazonadas";
      if(s.includes("sin") && (s.includes("sal")||s.includes("sazon"))) return "Sin sal";
      if(s.includes("sal")) return "Con sal";
      return v;
    }

    /* === RESUMEN === */
    (function renderResumen(){
      var resumen=$("#resumen"),resTotal=$("#resTotal");resumen.innerHTML="";
      var k,obj,extras,unit,line,html;

      // helper escape
      function escapeHtml(s){
        return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }

      for(k in cart.burger){
        obj=cart.burger[k];
        extras=[];
        if(obj.extras && obj.extras.patty){ extras.push("+"+obj.extras.patty+" medallón(es)"); }
        if(obj.extras && obj.extras.cheddar){ extras.push("+"+obj.extras.cheddar+" cheddar"); }
        unit = unitWithExtras(obj);
        line = unit * (obj.qty||0);

        var notesEsc = obj.notes ? escapeHtml(obj.notes) : "";

        html = '<div class="row" style="align-items:flex-start"><div><div><strong>' +
          (obj.qty||0) + '× ' + (obj.item?escapeHtml(obj.item.name):"") + '</strong></div>' +
          '<div class="muted">Papas: ' + friesName(obj.fries) + (extras.length?(' · '+extras.join(' · ')):'') + '</div>' +
          (notesEsc ? ('<div class="muted">Notas: ' + notesEsc + '</div>') : '') +
          '</div><div>' + money(line) + '</div></div>';
        resumen.insertAdjacentHTML("beforeend", html);
      }

      for(k in cart.drink){
        obj = cart.drink[k];
        line = ((obj.item && obj.item.price) || 0) * (obj.qty||0);
        html = '<div class="row"><div><strong>' + (obj.qty||0) + '× ' + (obj.item?escapeHtml(obj.item.name):"") + '</strong></div><div>' + money(line) + '</div></div>';
        resumen.insertAdjacentHTML("beforeend", html);
      }

      // Nota general del pedido (si existe)
      var notaGeneral = $("#inpNotas").value ? $("#inpNotas").value.trim() : "";
      if(notaGeneral){
        var notaEsc = escapeHtml(notaGeneral);
        resumen.insertAdjacentHTML("beforeend", '<div style="margin-top:8px"><strong>Nota del pedido</strong><div class="muted">' + notaEsc + '</div></div>');
      }

      resTotal.textContent = money(calcTotal());
    })();

    /* === BUILD ORDER === */
    function selectedPago(){var el=document.querySelector('input[name="pago"]:checked');return el?el.value:"";}
    function buildOrder(orderNumber){
      var items=[],k,b,d;
      for(k in cart.burger){
        b=cart.burger[k];
        // preserve exactly what the cart stored for fries (no default override)
        items.push({
          type:"burger",
          id:b.item?b.item.id:"",
          name:b.item?b.item.name:"",
          qty:b.qty||0,
          price:b.item?(b.item.price||0):0,
          fries: b.fries || "",
          extras:{
            patty:(b.extras&&b.extras.patty)?b.extras.patty:0,
            cheddar:(b.extras&&b.extras.cheddar)?b.extras.cheddar:0,
            EXTRA_PRICE_PATTY:(b.extras&&b.extras.EXTRA_PRICE_PATTY)?b.extras.EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY,
            EXTRA_PRICE_CHEDDAR:(b.extras&&b.extras.EXTRA_PRICE_CHEDDAR)?b.extras.EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR
          },
          notes: b.notes || "" // <-- nota por ítem
        });
      }
      for(k in cart.drink){d=cart.drink[k];items.push({type:"drink",id:d.item?d.item.id:"",name:d.item?d.item.name:"",qty:d.qty||0,price:d.item?(d.item.price||0):0});}
      var pago=selectedPago();
      return {
        orderNumber:orderNumber, number:orderNumber,
        nombre:$("#inpNombre").value.trim(),
        telefono:$("#inpTelefono").value.trim(),
        entrega:"take_away",
        pago:pago,
        notes:$("#inpNotas").value.trim(), // <-- nota general del pedido
        status:(pago==="mercado_pago"?"pending_payment":"accepted"),
        payment_status:(pago==="mercado_pago"?"pending_payment":"paid"),
        items:items,total:calcTotal(),source:"web",
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      };
    }

    /* === WhatsApp === */
    function moneyFmt(n){return (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0})}
    function buildWhatsappText(order){
      var lines=[],pagoLabel=(order.pago==='efectivo'?'Efectivo':'Mercado Pago');
      lines.push("Hola! Quiero confirmar el pedido #"+order.orderNumber);
      lines.push("Nombre: "+order.nombre+(order.telefono?(" — Tel: "+order.telefono):""));
      lines.push("Retiro: Take Away");
      lines.push("Medio de pago: "+pagoLabel);
      lines.push("------------------------------");
      for(var i=0;i<order.items.length;i++){
        var it=order.items[i];
        if(it.type==='burger'){
          var extras=[]; if(it.extras&&it.extras.patty){extras.push("+"+it.extras.patty+" med")} if(it.extras&&it.extras.cheddar){extras.push("+"+it.extras.cheddar+" cheddar")}
          var friesLabel = friesName(it.fries);
          lines.push((it.qty||0)+"× "+(it.name||"")+" (Papas: "+friesLabel+(extras.length?(" · "+extras.join(" · ")):"")+")");
          if(it.notes){lines.push("  Notas: "+it.notes);} // nota por ítem
        }else{ lines.push((it.qty||0)+"× "+(it.name||"")); }
      }
      lines.push("------------------------------");
      lines.push("Total: "+moneyFmt(order.total));
      if(order.notes){lines.push("Notas del pedido: "+order.notes);} // nota general
      if(order.trackToken){
        var base=location.origin;
        var trackUrl=base+"/gracias.html?id="+encodeURIComponent(order.id||"")+"&t="+encodeURIComponent(order.trackToken);
        lines.push("Seguimiento: "+trackUrl);
      }
      return encodeURIComponent(lines.join("\n"));
    }
    function openWhatsApp(order){
      var PHONE_NUMBER="5491170596483";
      var txt=buildWhatsappText(order);
      var url="https://wa.me/"+PHONE_NUMBER+"?text="+txt;
      window.open(url,"_blank");
    }
    function clearCart(){try{localStorage.setItem(CART_KEY,JSON.stringify({burger:{},drink:{}}))}catch(e){}}

    /* === Crear & Confirmar === */
    function createOrder(){
      if(!Object.keys(cart.burger||{}).length && !Object.keys(cart.drink||{}).length){alert("Tu carrito está vacío.");return Promise.resolve(null);}
      var nombre=$("#inpNombre").value.trim(); if(!nombre){alert("Ingresá tu nombre.");return Promise.resolve(null);}
      var pago=selectedPago(); if(!pago){alert("Elegí un medio de pago.");return Promise.resolve(null);}

      var createdId=null, orderNumber=null, trackToken=genTrackToken();

      return getNextOrderNumber().then(async function(next){
        orderNumber=next;
        var order=buildOrder(orderNumber);
        order.trackToken=trackToken;

        var ref=db.collection("orders").doc();
        await ref.set(order);
        createdId=ref.id;

        await db.collection("order_public").doc(trackToken).set({
          orderId:createdId, orderNumber:orderNumber,
          status: order.status==='pending_payment' ? 'pending_payment' : 'accepted',
          entrega:"take_away", pago:selectedPago(),
          nombre: ($("#inpNombre").value.trim().split(" ")[0]||"Cliente"),
          createdAt:firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt:firebase.firestore.FieldValue.serverTimestamp()
        },{merge:true});

        return {id:createdId,orderNumber:orderNumber,trackToken:trackToken};
      });
    }

    // Evitar doble click: deshabilitar mientras se procesa
    document.getElementById("btnConfirmar").onclick = function(){
      var btn = this;
      if(btn.disabled) return;
      btn.disabled = true;
      btn.classList.add('disabled');

      createOrder().then(function(res){
        btn.disabled = false;
        btn.classList.remove('disabled');
        if(!res) return;
        var pago=selectedPago();
        localStorage.setItem("last_order_id",res.id);
        db.collection("orders").doc(res.id).get().then(function(doc){
          var order={id:res.id}; if(doc.exists){order=Object.assign(order,doc.data());}
          order.trackToken=order.trackToken||res.trackToken;
          if(pago==="efectivo"||pago==="mercado_pago"){ openWhatsApp(order); }
          clearCart();
          window.location.href="gracias.html?id="+encodeURIComponent(res.id)+"&t="+encodeURIComponent(res.trackToken);
        }).catch(function(e){
          console.error(e);
          // aunque haya error al recuperar, redirigimos con la info mínima
          clearCart();
          window.location.href="gracias.html?id="+encodeURIComponent(res.id)+"&t="+encodeURIComponent(res.trackToken);
        });
      }).catch(function(e){
        console.error(e);
        btn.disabled = false;
        btn.classList.remove('disabled');
        alert("Ocurrió un error al confirmar el pedido. Probá nuevamente.");
      });
    };

    // Si el usuario edita la nota o el carrito desde otra pestaña, sería bueno refrescar resumen:
    window.addEventListener('storage', function(e){
      if(e.key===CART_KEY || e.key===null){ cart = loadCart(); /* re-render resumen */ (function(){ var resumen=$("#resumen"),resTotal=$("#resTotal"); resumen.innerHTML=""; var k,obj,extras,unit,line,html;
        function escapeHtml(s){return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
        for(k in cart.burger){ obj=cart.burger[k]; extras=[]; if(obj.extras && obj.extras.patty) extras.push("+"+obj.extras.patty+" medallón(es)"); if(obj.extras && obj.extras.cheddar) extras.push("+"+obj.extras.cheddar+" cheddar"); unit=unitWithExtras(obj); line=unit*(obj.qty||0); var notesEsc = obj.notes ? escapeHtml(obj.notes) : ""; html = '<div class=\"row\" style=\"align-items:flex-start\"><div><div><strong>'+(obj.qty||0)+'× '+(obj.item?escapeHtml(obj.item.name):"")+'</strong></div><div class=\"muted\">Papas: '+friesName(obj.fries)+(extras.length?(' · '+extras.join(' · ')):'')+'</div>'+(notesEsc?('<div class=\"muted\">Notas: '+notesEsc+'</div>'):'')+'</div><div>'+money(line)+'</div></div>'; resumen.insertAdjacentHTML("beforeend", html); }
        for(k in cart.drink){ obj=cart.drink[k]; line=((obj.item&&obj.item.price)||0)*(obj.qty||0); html = '<div class=\"row\"><div><strong>'+(obj.qty||0)+'× '+(obj.item?escapeHtml(obj.item.name):"")+'</strong></div><div>'+money(line)+'</div></div>'; resumen.insertAdjacentHTML("beforeend", html); }
        var notaGeneral = $("#inpNotas") ? $("#inpNotas").value.trim() : ""; if(notaGeneral){ var notaEsc = escapeHtml(notaGeneral); resumen.insertAdjacentHTML("beforeend", '<div style=\"margin-top:8px\"><strong>Nota del pedido</strong><div class=\"muted\">' + notaEsc + '</div></div>'); }
        resTotal.textContent = money(calcTotal()); })(); }
    }, false);

  </script>
</body>
</html>
