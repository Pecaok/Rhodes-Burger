<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.ghost{background:#fff}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:34px;margin:12px 4px 18px}

    .grid{display:grid;grid-template-columns: 1fr 420px; gap:18px}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    label{font-weight:700}
    input[type="text"]{width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px;outline:none}
    textarea{width:100%;min-height:90px;padding:10px;border:1px solid var(--ring);border-radius:12px}

    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:10px 14px;cursor:pointer}
    .pill input{accent-color:var(--primary)}
    .muted{color:var(--muted);font-size:13px}

    .line{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #efefef}
    .total{display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:18px;margin-top:10px}

    /* Fondo con logo grande, m√°s oscuro y menos zoom */
    body::before{
      content:""; position:fixed; inset:0;
      background: radial-gradient(rgba(0,0,0,.06), rgba(0,0,0,.06)), url("images/logo.png") center/500px no-repeat;
      opacity:.35; pointer-events:none; z-index:0; filter:grayscale(100%);
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html" title="Volver al men√∫">
        <img src="images/logo.png" alt="Rhodes Burgers">
      </a>
      <div class="spacer"></div>
      <a class="btn" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>

    <div class="grid">
      <!-- Datos cliente -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" type="text" placeholder="Ej: Juan P√©rez">
        </div>

        <div class="field">
          <label>Tel√©fono (opcional)</label>
          <input id="inpTel" type="text" placeholder="Ej: 11 2345 6789">
        </div>

        <div class="field">
          <label>Medio de pago</label>
          <div class="row">
            <label class="pill"><input type="radio" name="mp" value="mercado_pago"> üí≥ Mercado Pago</label>
            <label class="pill"><input type="radio" name="mp" value="efectivo"> üíµ Efectivo</label>
          </div>
        </div>

        <div class="field">
          <label>Tipo de entrega</label>
          <div class="row">
            <label class="pill"><input type="radio" name="entrega" value="take_away" checked> üõçÔ∏è Take Away</label>
          </div>
          <div class="muted">* Solo retiro por el local.</div>
        </div>

        <div class="field">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div class="row" style="margin-top:10px">
          <a class="btn" href="index.html">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>
      </section>

      <!-- Resumen -->
      <aside class="card">
        <h3>Resumen</h3>
        <div id="resume"></div>
        <div class="total"><span>Total</span><span id="resumeTotal">$ 0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (App, Firestore y Auth ‚Äì compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    window.ensureAuthReady = new Promise((resolve)=>{
      firebase.auth().onAuthStateChanged(async (user)=>{
        try{ if(!user) await firebase.auth().signInAnonymously(); }
        catch(e){ console.error("Auth an√≥nimo:", e); }
        finally{
          window.db = firebase.firestore();
          resolve();
        }
      });
    });
  </script>

  <script>
  window.ensureAuthReady.then(()=>{

    /* ====== CONST ====== */
    const CART_KEY = "rhodes_cart_v3";
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const WHATSAPP_NUMBER = "5491170596483"; // cambi√° si hace falta

    /* ====== CARGA CARRITO ====== */
    let cart = {burger:{},drink:{}};
    try{ cart = JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{}}; }catch{}
    const resumeHost = $("#resume"), resumeTotal = $("#resumeTotal");

    function unitWithExtras(obj){
      const base = obj.item?.price||0;
      const pat  = (obj.extras?.patty||0)   * (obj.extras?.EXTRA_PRICE_PATTY||0);
      const che  = (obj.extras?.cheddar||0) * (obj.extras?.EXTRA_PRICE_CHEDDAR||0);
      return base+pat+che;
    }
    function cartTotal(){
      let t=0;
      for(const b of Object.values(cart.burger)) t += unitWithExtras(b)*b.qty;
      for(const d of Object.values(cart.drink))  t += (d.item?.price||0)*d.qty;
      return t;
    }
    function friesName(v){ return v==="con_sazon"?"Con saz√≥n":"Sin sazonar"; }

    function renderResumen(){
      const lines=[];
      for(const b of Object.values(cart.burger)){
        const extraTxt=[];
        if(b.extras?.patty) extraTxt.push(`+${b.extras.patty} med`);
        if(b.extras?.cheddar) extraTxt.push(`+${b.extras.cheddar} cheddar`);
        const unit = unitWithExtras(b);
        lines.push(`
          <div class="line">
            <div>
              <div><strong>${b.item.name}</strong></div>
              <div class="muted">Papas: ${friesName(b.fries)}${extraTxt.length?` ¬∑ ${extraTxt.join(" ¬∑ ")}`:""}</div>
            </div>
            <div>${money(unit)}</div>
          </div>
        `);
      }
      for(const d of Object.values(cart.drink)){
        lines.push(`
          <div class="line">
            <div><strong>${d.item.name}</strong></div>
            <div>${money(d.item.price||0)}</div>
          </div>
        `);
      }
      resumeHost.innerHTML = lines.join("") || '<div class="muted">No hay productos en el carrito.</div>';
      resumeTotal.textContent = money(cartTotal());
    }
    renderResumen();

    /* ====== VALIDACI√ìN Y ENV√çO ====== */
    const btnConfirmar = $("#btnConfirmar");
    btnConfirmar.onclick = async ()=>{
      const nombre = $("#inpNombre").value.trim();
      const tel     = $("#inpTel").value.trim();
      const pagoEl  = document.querySelector('input[name="mp"]:checked');
      const entregaEl = document.querySelector('input[name="entrega"]:checked');

      if(!Object.keys(cart.burger||{}).length && !Object.keys(cart.drink||{}).length){
        alert("Tu carrito est√° vac√≠o."); return;
      }
      if(!nombre){ alert("Ingres√° tu nombre."); return; }
      if(!pagoEl){ alert("Seleccion√° el medio de pago."); return; }

      const pago = pagoEl.value; // "mercado_pago" | "efectivo"
      const entrega = (entregaEl?.value)||"take_away";
      const notas = $("#inpNotas").value.trim();

      try{
        // Generar n√∫mero de pedido (counter/transaction)
        const ctrRef = db.collection("config").doc("counters");
        let orderNumber = 1;
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(ctrRef);
          const next = (snap.exists && typeof snap.data().orderNumber==="number")
            ? snap.data().orderNumber + 1 : 1;
          tx.set(ctrRef, { orderNumber: next }, { merge:true });
          orderNumber = next;
        });

        // Armar items como array para guardar
        const items = [];
        for(const b of Object.values(cart.burger)){
          items.push({
            type:"burger",
            id:b.item.id,
            name:b.item.name,
            qty:b.qty,
            price:b.item.price,
            fries:b.fries,
            extras:b.extras||{},
            notes:b.notes||""
          });
        }
        for(const d of Object.values(cart.drink)){
          items.push({
            type:"drink",
            id:d.item.id,
            name:d.item.name,
            qty:d.qty,
            price:d.item.price
          });
        }

        const total = cartTotal();

        // Crear pedido en Firestore
        const docRef = await db.collection("orders").add({
          orderNumber,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          status: "accepted",           // el local maneja estados luego
          nombre,
          telefono: tel||"",
          entrega,
          pago,
          notas: notas||"",
          items,
          total
        });

        // Limpiar carrito
        localStorage.removeItem(CART_KEY);

        // Armar detalle para WhatsApp si eligi√≥ "Mercado Pago"
        if(pago==="mercado_pago"){
          const lines = [];
          lines.push(`*Rhodes Burgers*`);
          lines.push(`Pedido *#${orderNumber}*`);
          lines.push(`Cliente: ${nombre}`);
          if(tel) lines.push(`Tel: ${tel}`);
          lines.push(`Entrega: ${entrega.replace("_"," ")}`);
          lines.push(``);
          for(const it of items){
            if(it.type==="burger"){
              const extras=[];
              if(it.extras?.patty) extras.push(`+${it.extras.patty} med`);
              if(it.extras?.cheddar) extras.push(`+${it.extras.cheddar} cheddar`);
              lines.push(`‚Ä¢ ${it.qty}√ó ${it.name}`);
              lines.push(`   Papas: ${friesName(it.fries)}${extras.length?` ¬∑ ${extras.join(" ¬∑ ")}`:""}`);
              if(it.notes) lines.push(`   Notas: ${it.notes}`);
            }else{
              lines.push(`‚Ä¢ ${it.qty}√ó ${it.name}`);
            }
          }
          lines.push(``);
          lines.push(`*Total:* ${money(total)}`);
          const msg = encodeURIComponent(lines.join("\n"));
          const wa = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
          window.open(wa, "_blank");
        }

        // Ir a gracias
        window.location.href = "gracias.html";
      }catch(err){
        console.error(err);
        alert("No se pudo confirmar el pedido. Intent√° nuevamente.");
      }
    };

  }); // ensureAuthReady
  </script>
</body>
</html>
