<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi Pedido - Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 4px 12px rgba(0,0,0,.08); --logo-url:url("images/logo.png"); }
    *{ box-sizing:border-box }
    html,body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--text); background:var(--bg) }
    body::before{ content:""; position:fixed; inset:0; z-index:0; pointer-events:none; background-image:var(--logo-url); background-repeat:no-repeat; background-position:center 120px; background-size:clamp(260px,45vw,560px); opacity:.08; filter:grayscale(100%); }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1000px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ height:48px; width:auto; object-fit:contain; display:block }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:999px; cursor:pointer; border:2px solid var(--primary); background:#fff; color:var(--primary); font-weight:700; text-decoration:none }
    .btn.primary{ background:var(--primary); color:#fff }
    .container{ max-width:1000px; margin:24px auto; padding:0 12px; position:relative; z-index:1 }
    .layout{ display:grid; grid-template-columns:1fr 1fr; gap:20px }
    @media (max-width:900px){ .layout{ grid-template-columns:1fr } }
    .card{ background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:16px }
    .card h2{ margin:0 0 10px; font-size:22px }
    .muted{ color:var(--muted); font-size:14px }
    ul{ list-style:none; padding:0; margin:0 }
    li{ padding:10px 0; border-bottom:1px solid #eee }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px }
    .total{ font-weight:800; font-size:18px; margin-top:10px }
    form .field{ margin:10px 0 }
    form label{ display:block; font-weight:700; margin-bottom:6px }
    form input[type="text"], form input[type="tel"]{ width:100%; padding:10px; border:1px solid #e7e7e7; border-radius:12px; font-size:15px; background:#fff }
    .radio-row{ display:flex; gap:12px; flex-wrap:wrap }
    .radio-row label{ display:inline-flex; align-items:center; gap:8px; border:1px solid #e7e7e7; border-radius:999px; padding:8px 12px; cursor:pointer }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .ok,.err{ padding:10px; border-radius:12px; margin:10px 0; display:none }
    .ok{ background:#e7f8ef; border:1px solid #c7efda; color:#0c6b3f }
    .err{ background:#fde7e7; border:1px solid #ffc1c1; color:#8a1c1c }
    .small{ font-size:13px; color:#777 }
    .right{ text-align:right }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img id="logo" src="" alt="Rhodes Burgers"></a>
      <div class="spacer"></div>
      <a class="btn" href="index.html">⬅️ Editar pedido</a>
    </div>
  </header>

  <main class="container">
    <h1>Mi Pedido</h1>
    <div class="layout">
      <section class="card">
        <h2>Resumen</h2>
        <div id="friesLine" class="muted" style="display:none"></div>
        <ul id="lista-pedido"></ul>
        <div class="total row"><span>Total</span><span id="total">$0</span></div>
        <div class="small right" id="itemsCount"></div>
      </section>

      <section class="card">
        <h2>Datos para confirmar</h2>
        <form id="formPedido">
          <div class="field"><label for="nombre">Nombre</label><input id="nombre" type="text" required></div>
          <div class="field"><label for="apellido">Apellido</label><input id="apellido" type="text" required></div>
          <div class="field"><label for="telefono">Teléfono (opcional)</label><input id="telefono" type="tel" inputmode="tel"></div>

          <div class="field">
            <label>Método de pago</label>
            <div class="radio-row">
              <label><input type="radio" name="pago" value="Efectivo" required> Efectivo</label>
              <label><input type="radio" name="pago" value="Mercado Pago" required> Mercado Pago</label>
              <label><input type="radio" name="pago" value="Transferencia" required> Transferencia</label>
            </div>
          </div>

          <div class="field">
            <label>Entrega</label>
            <div class="radio-row" id="entregaRow">
              <label><input type="radio" name="entrega" value="Delivery" required> Delivery</label>
              <label><input type="radio" name="entrega" value="Take Away" required> Take Away</label>
            </div>
          </div>

          <div class="field" id="direccionField" style="display:none">
            <label for="direccion">Dirección</label>
            <input id="direccion" type="text" placeholder="Calle y altura, piso/depto">
          </div>

          <div class="field">
            <label for="notas">Notas (opcional)</label>
            <input id="notas" type="text" placeholder="Timbre roto, etc.">
          </div>

          <div class="err" id="errMsg"></div>
          <div class="ok" id="okMsg"></div>

          <div class="actions">
            <button type="button" class="btn" id="btnVolver">⬅️ Volver</button>
            <button type="submit" class="btn primary" id="btnConfirmar">Confirmar pedido</button>
          </div>
        </form>
      </section>
    </div>
  </main>

  <!-- Resolver logo en header/fondo -->
  <script>
    (function(){
      const opts=["images/logo.png","images/logo.jpg","/images/logo.png","/images/logo.jpg","images/Logo.png","images/Logo.jpg"];
      (async()=>{for(const s of opts){const i=new Image();i.src=s+"?v="+Date.now();try{await i.decode();document.getElementById("logo").src=s;document.documentElement.style.setProperty("--logo-url",`url("${s}")`);let l=document.querySelector('link[rel="icon"]');if(!l){l=document.createElement("link");l.rel="icon";document.head.appendChild(l);}l.href=s;return;}catch{}}})();
    })();
  </script>

  <!-- Firebase + Firestore (SDK con long-polling + fallback REST automático) -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { initializeFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Tu configuración
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5Y0WDE0ouLn-Ib_iD1yUesok5SEh88",
      authDomain: "rhodes-burgers.firebaseapp.com",
      projectId: "rhodes-burgers",
      storageBucket: "rhodes-burgers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e",
      measurementId: "G-LQVYTJWHSM"
    };

    const app = getApps()[0] || initializeApp(firebaseConfig);
    // Evita bloqueos del transporte de Firestore
    const db = initializeFirestore(app, { experimentalForceLongPolling: true, useFetchStreams: false });

    // ---------- helpers carrito/UI ----------
    const CART_KEY="rhodes_cart_v3";
    const $=s=>document.querySelector(s);
    const money=n=>n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const lista=$("#lista-pedido"), totalSpan=$("#total"), friesLine=$("#friesLine"), itemsCount=$("#itemsCount");
    const getCookie = name => (document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\\]\\\\])/g,"\\\\$1")+'=([^;]*)'))||[])[1] && decodeURIComponent((document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\\]\\\\])/g,"\\\\$1")+'=([^;]*)'))||[])[1]);
    const decodeCartBase64 = b64 => { try{ const bin=atob(b64); const bytes=Uint8Array.from(bin,c=>c.charCodeAt(0)); return JSON.parse(new TextDecoder().decode(bytes)); }catch{ return null; } };
    function parseCart(){
      const p=new URLSearchParams(location.search);
      if(p.has("cart")){ const c=decodeCartBase64(p.get("cart")); if(c) return c; }
      try{ const raw=sessionStorage.getItem(CART_KEY); if(raw) return JSON.parse(raw); }catch{}
      const ck=getCookie("cart"); if(ck){ const c=decodeCartBase64(ck); if(c) return c; }
      return {burger:{},drink:{},fries:null};
    }
    const cart=parseCart();

    function renderResumen(){
      lista.innerHTML=""; let total=0; let count=0;
      if(cart.fries){ friesLine.style.display="block"; friesLine.textContent=`Papas: ${cart.fries==="con_sazon"?"Con sazón":"Sin sazonar"}`; }
      if(cart.burger){ for(const o of Object.values(cart.burger)){ const ex=[]; if(o.extras?.patty) ex.push(`+${o.extras.patty} medallón(es)`); if(o.extras?.cheddar) ex.push(`+${o.extras.cheddar} cheddar`); const li=document.createElement("li"); li.innerHTML=`<div class="row"><div><strong>${o.item?.name||"Producto"}</strong>${ex.length?`<div class="muted">${ex.join(" · ")}</div>`:""}${o.notes?`<div class="muted">Notas: ${o.notes}</div>`:""}</div><div>${money((o.item?.price||0)*(o.qty||0))}</div></div>`; lista.appendChild(li); total+=(o.item?.price||0)*(o.qty||0); count+=(o.qty||0);} }
      if(cart.drink){ for(const o of Object.values(cart.drink)){ const li=document.createElement("li"); li.innerHTML=`<div class="row"><div><strong>${o.item?.name||"Bebida"}</strong></div><div>${money((o.item?.price||0)*(o.qty||0))}</div></div>`; lista.appendChild(li); total+=(o.item?.price||0)*(o.qty||0); count+=(o.qty||0);} }
      totalSpan.textContent=money(total); itemsCount.textContent = count?`${count} ítem(s)`:"";
    }
    renderResumen();

    const form=$("#formPedido"), direccionField=$("#direccionField"), errMsg=$("#errMsg"), okMsg=$("#okMsg");
    $("#entregaRow").addEventListener("change", ()=>{ const val=(new FormData(form).get("entrega"))||""; direccionField.style.display=(val==="Delivery")?"block":"none"; if(val!=="Delivery") $("#direccion").value=""; });
    $("#btnVolver").addEventListener("click", ()=>location.href="index.html");

    const withTimeout = (p,ms=15000)=>Promise.race([p,new Promise((_,r)=>setTimeout(()=>r(new Error("TIMEOUT: No se pudo contactar a Firestore")),ms))]);
    const showError = m=>{ errMsg.style.display="block"; errMsg.textContent=m; };
    const showOK = m=>{ okMsg.style.display="block"; okMsg.textContent=m; };

    // ---------- Fallback REST (por si el SDK se cuelga) ----------
    async function restCreate(collectionName, obj){
      const url = `https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/${encodeURIComponent(collectionName)}?key=${encodeURIComponent(firebaseConfig.apiKey)}`;
      const body = {
        fields: {
          raw: { stringValue: JSON.stringify(obj) },
          status: { stringValue: obj.status || "pendiente" },
          ts:  { timestampValue: new Date().toISOString() }
        }
      };
      const res = await fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body) });
      if(!res.ok){ const txt = await res.text().catch(()=>String(res.status)); throw new Error(`REST ${res.status}: ${txt}`); }
      const data = await res.json();
      return (data.name||"").split("/").pop() || "sin_id";
    }

    async function trySDK(payload){
      return withTimeout(addDoc(collection(db,"pedidos"), payload), 15000);
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); errMsg.style.display="none"; okMsg.style.display="none";

      const nombre=$("#nombre").value.trim();
      const apellido=$("#apellido").value.trim();
      const telefono=$("#telefono").value.trim();
      const pago=form.querySelector('input[name="pago"]:checked')?.value||"";
      const entrega=form.querySelector('input[name="entrega"]:checked')?.value||"";
      const direccion=$("#direccion")?.value.trim()||"";
      const notas=$("#notas")?.value.trim()||"";

      if(!nombre||!apellido) return showError("Completá nombre y apellido.");
      if(!pago) return showError("Elegí un método de pago.");
      if(!entrega) return showError("Indicá si es Delivery o Take Away.");
      if(entrega==="Delivery" && !direccion) return showError("Ingresá la dirección para el Delivery.");
      const hasItems = (cart && (Object.keys(cart.burger||{}).length || Object.keys(cart.drink||{}).length));
      if(!hasItems) return showError("Tu pedido está vacío.");

      const btn=$("#btnConfirmar"); btn.disabled=true; btn.textContent="Confirmando...";

      const payloadSDK = {
        cliente:{ nombre, apellido, telefono: telefono||null },
        pago, entrega, direccion: entrega==="Delivery"?direccion:null,
        notas: notas||null, fries: cart.fries||null,
        items:{ burgers: mapBurgers(cart.burger), drinks: mapDrinks(cart.drink) },
        total: calcTotal(cart),
        createdAt: serverTimestamp(),
        status:"pendiente"
      };

      const payloadREST = {
        ...payloadSDK,
        createdAt: new Date().toISOString() // para REST guardo ISO
      };

      try{
        // 1) Intento con SDK
        try{
          const ref = await trySDK(payloadSDK);
          showOK(`¡Listo! Pedido creado. Código: ${ref.id}`);
        }catch(errSDK){
          console.warn("[SDK] falló o tardó, uso REST:", errSDK);
          const id = await restCreate("pedidos", payloadREST);
          showOK(`¡Listo! Pedido creado. Código: ${id} (REST)`);
        }

        // limpiar carrito
        try{ sessionStorage.removeItem(CART_KEY); }catch{}
        document.cookie = "cart=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/; SameSite=Lax";
      }catch(errAny){
        console.error(errAny);
        showError(errAny?.message || String(errAny));
      }finally{
        btn.disabled=false; btn.textContent="Confirmar pedido";
      }
    });

    function calcTotal(c){ let t=0; if(c?.burger){ for(const o of Object.values(c.burger)){ t+=(o.item?.price||0)*(o.qty||0);} } if(c?.drink){ for(const o of Object.values(c.drink)){ t+=(o.item?.price||0)*(o.qty||0);} } return t; }
    function mapBurgers(b){ if(!b) return []; return Object.values(b).map(o=>({ id:o.item?.id||null, name:o.item?.name||null, price:o.item?.price||0, qty:o.qty||0, extras:o.extras||{}, notes:o.notes||null })); }
    function mapDrinks(d){ if(!d) return []; return Object.values(d).map(o=>({ id:o.item?.id||null, name:o.item?.name||null, price:o.item?.price||0, qty:o.qty||0 })); }
  </script>
</body>
</html>
