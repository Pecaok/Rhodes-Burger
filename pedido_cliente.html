<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    body::before{ content:""; position:fixed; inset:0; background:url("images/logo.png") center 120px/320px no-repeat; opacity:.06; pointer-events:none; z-index:0; filter:grayscale(100%) }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:900px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }
    .container{ max-width:900px; margin:24px auto; padding:0 12px }
    h1{ font-size:34px; margin:14px 4px 18px }
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:16px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px }
    .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0 }
    .field input, .field textarea{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px }
    .inline{ display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 }
    .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid #e7e7e7; border-radius:999px; padding:8px 12px; cursor:pointer }
    .muted{ color:var(--muted); font-size:14px }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid #efefef }
    .total{ display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; margin-top:10px }
    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .numPedido{ font-weight:700; letter-spacing:.5px }
    .banner{ background:#fff7d6; border:1px solid #ffe08a; color:#7a5b00; padding:10px 12px; border-radius:12px; margin-bottom:12px }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand">
        <img id="brandLogo" src="images/logo.png" alt="Rhodes Burgers"
             onerror="this.onerror=null;this.src='images/logo.jpg'">
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">← Seguir comprando</a>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Confirmar pedido</h1>
      <div id="warn" class="banner" style="display:none"></div>
      <div class="grid">
        <!-- Columna izquierda -->
        <div class="card">
          <div class="field">
            <label>Número de pedido</label>
            <input id="inpNro" class="numPedido" readonly />
          </div>

          <div class="field">
            <label>Nombre y apellido</label>
            <input id="inpNombre" placeholder="Ej: Juan Pérez" autocomplete="name" />
          </div>

          <div class="field">
            <label>Método de pago</label>
            <div class="inline">
              <label class="pill"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
              <label class="pill"><input type="radio" name="pago" value="efectivo" checked> Efectivo</label>
            </div>
          </div>

          <div class="field">
            <label>Retiro</label>
            <div class="muted">Modalidad: <strong>Take Away</strong> (retira en el local).</div>
          </div>

          <div class="field">
            <label>Papas fritas (obligatorio)</label>
            <div class="inline">
              <label class="pill"><input type="radio" name="papas" value="con_sazon"> Con sazón</label>
              <label class="pill"><input type="radio" name="papas" value="sin_sazon"> Sin sazonar</label>
            </div>
            <div class="muted">Si ya elegiste en el menú, viene preseleccionado.</div>
          </div>

          <div class="field">
            <label>Comentarios</label>
            <textarea id="inpComentarios" placeholder="Ej: Sin mayonesa, agregar servilletas"></textarea>
          </div>

          <div class="row-actions">
            <button class="btn" id="btnCancelar">Cancelar</button>
            <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
          </div>
          <p class="muted" id="status" style="margin-top:8px"></p>
        </div>

        <!-- Columna derecha -->
        <div class="card">
          <h3>Resumen</h3>
          <div id="items"></div>
          <div class="total"><span>Total</span><span id="total">$0</span></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /*************** FIREBASE ***************/
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /*************** UTIL ***************/
    const $ = s => document.querySelector(s);
    const money = n => n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    const CART_KEYS = ["rhodes_cart_v3","rhodes_cart_v2","rhodes_cart","cart","pending_cart","backup_cart"];

    function normalizeCart(raw){
      const blank = { burger:{}, drink:{}, fries:null };
      if(!raw) return blank;

      // array -> normaliza
      if(Array.isArray(raw)){
        const out = { ...blank };
        for(const it of raw){
          const type = it.type === "drink" ? "drink" : "burger";
          const item = it.item ? it.item : { id: it.id, name: it.name, price: it.price };
          if(!item?.id) continue;
          const bucket = out[type];
          bucket[item.id] = {
            qty: it.qty || 1,
            item,
            extras: it.extras || { patty:0, cheddar:0 },
            notes: it.notes || ""
          };
        }
        return out;
      }

      // objeto esperado
      const burger = {};
      const drink  = {};
      const fries  = raw.fries ?? null;

      if(raw.burger || raw.drink){
        for(const [id,obj] of Object.entries(raw.burger || {})){
          const itm = obj.item ? obj.item : { id, name: obj.name, price: obj.price };
          if(!itm?.id) continue;
          burger[itm.id] = {
            qty: obj.qty || 1,
            item: itm,
            extras: obj.extras || { patty:0, cheddar:0 },
            notes: obj.notes || ""
          };
        }
        for(const [id,obj] of Object.entries(raw.drink || {})){
          const itm = obj.item ? obj.item : { id, name: obj.name, price: obj.price };
          if(!itm?.id) continue;
          drink[itm.id] = {
            qty: obj.qty || 1,
            item: itm
          };
        }
        return { burger, drink, fries };
      }

      // otras formas conocidas
      for(const k of ["items","products","lista"]){
        if(Array.isArray(raw[k])) return normalizeCart(raw[k]);
      }
      return blank;
    }

    // Lee de localStorage y sessionStorage y mergea
    function loadCart(){
      const storages = [localStorage, sessionStorage];
      let result = { burger:{}, drink:{}, fries:null };
      for(const store of storages){
        for(const key of CART_KEYS){
          try{
            const val = store.getItem(key);
            if(!val) continue;
            const parsed = JSON.parse(val);
            const norm = normalizeCart(parsed);

            // mergea
            for(const [id,obj] of Object.entries(norm.burger)){
              result.burger[id] = result.burger[id] || obj;
            }
            for(const [id,obj] of Object.entries(norm.drink)){
              result.drink[id] = result.drink[id] || obj;
            }
            if(norm.fries && !result.fries) result.fries = norm.fries;
          }catch(e){}
        }
      }
      return result;
    }

    function clearCart(){
      localStorage.setItem("rhodes_cart_v3", JSON.stringify({burger:{},drink:{},fries:null}));
    }

    let cart = loadCart();

    function calcTotal(){
      let t=0;
      for(const b of Object.values(cart.burger)){
        t += (b.item?.price||0) * (b.qty||1);
      }
      for(const d of Object.values(cart.drink)){
        t += (d.item?.price||0) * (d.qty||1);
      }
      return t;
    }

    const itemsEl = $("#items");
    const totalEl = $("#total");
    const statusEl = $("#status");
    const inpNombre = $("#inpNombre");
    const inpNro = $("#inpNro");
    const warnEl = $("#warn");

    function emptyCart(c){
      return Object.keys(c.burger||{}).length===0 && Object.keys(c.drink||{}).length===0;
    }

    function renderResumen(){
      const rows=[];
      for(const obj of Object.values(cart.burger)){
        const extras=[];
        if(obj.extras?.patty)   extras.push(`+${obj.extras.patty} medallón(es)`);
        if(obj.extras?.cheddar) extras.push(`+${obj.extras.cheddar} cheddar`);
        rows.push(`
          <div class="item">
            <div>
              <strong>${obj.item?.name||"Producto"}</strong>
              ${extras.length?`<div class="muted">${extras.join(" · ")}</div>`:""}
              ${obj.notes?`<div class="muted">Notas: ${obj.notes}</div>`:""}
            </div>
            <div>${money((obj.item?.price||0)*(obj.qty||1))}</div>
          </div>`);
      }
      for(const obj of Object.values(cart.drink)){
        rows.push(`
          <div class="item">
            <div><strong>${obj.item?.name||"Bebida"}</strong></div>
            <div>${money((obj.item?.price||0)*(obj.qty||1))}</div>
          </div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal());

      // Preseleccionar papas si venía de index
      if(cart.fries){
        const r = document.querySelector(\`input[name="papas"][value="\${cart.fries}"]\`);
        if(r) r.checked = true;
      }

      // Aviso si no se encontró nada
      if(emptyCart(cart)){
        warnEl.style.display = "block";
        warnEl.textContent = "No encontramos productos en el carrito. Volvé al menú, agregá tus productos y luego tocá “Ver pedido”.";
      } else {
        warnEl.style.display = "none";
      }
    }

    /*************** NÚMERO DE PEDIDO SECUENCIAL ***************/
    function nextOrderNumber(){
      const last = parseInt(localStorage.getItem("lastOrderNumber")||"0",10);
      const next = last + 1;
      localStorage.setItem("lastOrderNumber", String(next));
      return next;
    }
    const orderNumber = nextOrderNumber();
    inpNro.value = "#" + orderNumber;

    /*************** EVENTOS ***************/
    $("#btnCancelar").onclick = ()=> { window.location.href = "index.html"; };

    $("#btnConfirmar").onclick = async ()=>{
      if(emptyCart(cart)){ alert("Tu carrito está vacío."); return; }

      const nombre = inpNombre.value.trim();
      if(!nombre){ alert("Ingresá tu nombre y apellido."); return; }
      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Elegí un método de pago."); return; }
      const papasEl = document.querySelector('input[name="papas"]:checked');
      if(!papasEl){ alert("Elegí una opción de papas (obligatorio)."); return; }
      const comentarios = ($("#inpComentarios").value||"").trim();

      const items=[];
      for(const o of Object.values(cart.burger)) items.push({type:"burger", id:o.item.id, name:o.item.name, qty:o.qty, price:o.item.price});
      for(const o of Object.values(cart.drink))  items.push({type:"drink",  id:o.item.id, name:o.item.name, qty:o.qty, price:o.item.price});

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        orderNumber,
        nombre,
        pago: pagoEl.value,
        entrega: "take_away",
        direccion: "",
        fries: papasEl.value,
        items,
        comentarios,
        total: calcTotal(),
        status: "pending"
      };

      try{
        statusEl.textContent = "Guardando pedido...";
        await db.collection("orders").add(order);
      }catch(err){
        console.error(err);
        alert("No pudimos guardar el pedido en Firestore.");
        statusEl.textContent = "Error al guardar en Firestore.";
        return;
      }

      if(pagoEl.value === "mercado_pago"){
        try{
          const mpItems = items.map(it => ({ title: it.name, quantity: it.qty, unit_price: it.price }));
          const resp = await fetch("/.netlify/functions/createPreference",{
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
              items: mpItems,
              orderId: String(orderNumber),
              total: order.total,
              payer: { name: nombre }
            })
          });
          const data = await resp.json();
          if(data && data.init_point){
            clearCart();
            window.location.href = data.init_point; // redirección a MP
            return;
          }else{
            alert("No recibimos el link de pago (init_point). Revisá la función serverless.");
            return;
          }
        }catch(err){
          console.error(err);
          alert("Error al iniciar el pago con Mercado Pago.");
          return;
        }
      }else{
        clearCart();
        window.location.href = "gracias.html";
      }
    };

    // Inicio
    (function init(){
      renderResumen();
    })();
  </script>
</body>
</html>
