<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#22c55e; /* verde */
      --primary-600:#16a34a;
      --text:#111;
      --muted:#6b7280;
      --bg:#f6f6f6;
      --card:#fff;
      --ring:#e5e7eb;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --logo-url: url("images/logo.png");
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }

    /* Fondo con logo a PANTALLA COMPLETA */
    body::before{
      content:"";
      position:fixed; inset:0;
      background: var(--logo-url) center center / cover no-repeat fixed;
      opacity:.06; pointer-events:none; z-index:0; filter:grayscale(100%);
    }

    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1100px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand{ display:inline-flex; align-items:center; gap:10px; text-decoration:none; color:inherit }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer; transition:.15s }
    .btn:hover{ transform:translateY(-1px) }
    .btn.primary{ background:var(--primary); color:#fff; border-color:var(--primary) }
    .btn.primary:hover{ background:var(--primary-600); border-color:var(--primary-600) }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }

    main{ position:relative; z-index:1 }
    .container{ max-width:1100px; margin:24px auto; padding:0 12px }
    h1{ font-size:34px; margin:14px 4px 18px }

    .grid-2{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px }
    @media (max-width:900px){ .grid-2{ grid-template-columns:1fr } }

    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px }
    .field{ display:flex; flex-direction:column; gap:8px; margin:0 0 12px }
    .field label{ font-weight:700; font-size:14px }
    input[type="text"], textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--ring); outline:none; background:#fff;
      font-size:15px;
    }
    input[type="text"]:focus, textarea:focus{ border-color:#d1d5db; box-shadow:0 0 0 4px rgba(34,197,94,.12) }
    textarea{ min-height:90px; resize:vertical }

    .group-title{ font-weight:800; margin:18px 0 6px }
    .inline{ display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 4px }
    .pill{
      display:inline-flex; align-items:center; gap:10px; padding:14px 18px; border:2px solid var(--ring); border-radius:16px; cursor:pointer; user-select:none;
      background:#fff; transition:.15s;
    }
    .pill:hover{ border-color:#d1d5db; transform:translateY(-1px) }
    .pill input{ appearance:none; width:18px; height:18px; border:2px solid #cbd5e1; border-radius:999px; display:inline-block; position:relative }
    .pill input:checked{ border-color:var(--primary) }
    .pill input:checked::after{ content:""; position:absolute; inset:3px; background:var(--primary); border-radius:999px }
    .pill .ico{ font-size:18px; margin-left:2px; opacity:.9 }

    /* M√≥vil */
    @media (max-width:520px){
      .pill{ padding:10px 12px; border-radius:14px; gap:8px }
      input[type="text"], textarea{ padding:11px 12px; font-size:14.5px }
      .btn{ padding:9px 14px }
    }

    .total{ display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; margin-top:10px }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid #efefef }
    .muted{ color:var(--muted); font-size:14px }
    .hint{ color:var(--muted); font-size:13px; margin-top:4px }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <!-- Solo logo (sin texto) -->
      <a href="index.html" class="brand" aria-label="Inicio">
        <img id="logoHeader" src="images/logo.png" alt="">
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>

    <div class="grid-2">
      <!-- Izquierda -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" placeholder="Ej: Juan P√©rez" autocomplete="name" />
        </div>

        <div class="field">
          <label>Tel√©fono (opcional)</label>
          <input id="inpTelefono" placeholder="Ej: 11 2345 6789" inputmode="tel" autocomplete="tel" />
        </div>

        <div class="group">
          <div class="group-title">Medio de pago</div>
          <div class="inline" id="pagos">
            <label class="pill">
              <input type="radio" name="pago" value="mercado_pago" />
              <span class="ico">üí≥</span><span>Mercado Pago</span>
            </label>
            <label class="pill">
              <input type="radio" name="pago" value="efectivo" />
              <span class="ico">üíµ</span><span>Efectivo</span>
            </label>
          </div>
        </div>

        <div class="group">
          <div class="group-title">Tipo de entrega</div>
          <div class="inline" id="entregas">
            <label class="pill">
              <input type="radio" name="entrega" value="take_away" />
              <span class="ico">üõçÔ∏è</span><span>Take Away</span>
            </label>
          </div>
          <div class="hint">* Solo retiro por el local.</div>
        </div>

        <div class="field" style="margin-top:12px">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div class="actions">
          <a class="btn ghost" id="btnCancelar">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>
        <p class="muted" id="status" style="margin-top:8px"></p>
      </section>

      <!-- Derecha -->
      <aside class="card">
        <h2 style="margin:0 0 12px">Resumen</h2>
        <div id="items"></div>
        <div class="total"><span>Total</span><span id="total">$0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (MISMA VERSI√ìN Y CONFIG) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    /* ---------- Util & Estado ---------- */
    const CART_KEY="rhodes_cart_v3";
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{}}; }catch{ return {burger:{},drink:{}}; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function clearCart(){ saveCart({burger:{},drink:{}}); }
    function cartCount(c){ let n=0; for(const b of Object.values(c.burger)) n+=b.qty; for(const d of Object.values(c.drink)) n+=d.qty; return n; }
    function calcTotal(c){ let t=0; for(const b of Object.values(c.burger)) t+=(Number(b.item?.price)||0)*b.qty; for(const d of Object.values(c.drink)) t+=(Number(d.item?.price)||0)*d.qty; return t; }

    let cart = loadCart();

    /* ---------- UI refs ---------- */
    const itemsEl = $("#items");
    const totalEl = $("#total");
    const statusEl = $("#status");
    const inpNombre = $("#inpNombre");
    const inpTel    = $("#inpTelefono");
    const inpNotas  = $("#inpNotas");
    const btnConfirmar = $("#btnConfirmar");

    function renderResumen(){
      const rows=[];
      for(const obj of Object.values(cart.burger)){
        rows.push(`<div class="item">
          <div>
            <strong>${obj.item.name}</strong>
            <div class="muted">${money(obj.item.price)} x ${obj.qty}</div>
          </div>
          <div>${money((Number(obj.item.price)||0)*obj.qty)}</div>
        </div>`);
      }
      for(const obj of Object.values(cart.drink)){
        rows.push(`<div class="item">
          <div><strong>${obj.item.name}</strong><div class="muted">${money(obj.item.price)} x ${obj.qty}</div></div>
          <div>${money((Number(obj.item.price)||0)*obj.qty)}</div>
        </div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal(cart));
    }

    $("#btnCancelar").onclick = ()=> location.href="index.html";

    /* ---------- Confirmar ---------- */
    btnConfirmar.onclick = async ()=>{
      if(cartCount(cart)===0){ alert("Tu carrito est√° vac√≠o."); return; }
      const nombre = inpNombre.value.trim();
      if(!nombre){ alert("Ingres√° tu nombre y apellido."); return; }

      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Eleg√≠ un medio de pago."); return; }

      const entregaEl = document.querySelector('input[name="entrega"]:checked');
      if(!entregaEl){ alert("Confirm√° el tipo de entrega."); return; }

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nombre,
        telefono: inpTel.value.trim() || null,
        pago: pagoEl.value,                // "mercado_pago" | "efectivo"
        entrega: entregaEl.value,          // "take_away"
        items: buildItemsForFS(cart),
        total: calcTotal(cart),
        notas: (inpNotas.value.trim() || null),
        status: "accepted"                 // igual a tu flujo actual
      };

      try{
        btnConfirmar.disabled = true;
        statusEl.textContent = "Guardando pedido...";

        // Guarda en Firestore (mismo comportamiento que ten√≠as)
        const docRef = await db.collection("orders").add(order);

        // Si es MP creamos preferencia y redirigimos
        if(order.pago === "mercado_pago"){
          const mpItems = buildItemsForMP(cart, order.total);
          const resp = await fetch("/.netlify/functions/createPreference", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ orderId: docRef.id, items: mpItems, total: Number(order.total)||0, nombre: order.nombre })
          });
          const raw = await resp.text(); let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }
          if(!resp.ok){ console.error("MP error", resp.status, data); alert(`Error MP ${resp.status}: ${data.error||data.raw||"sin detalle"}`); btnConfirmar.disabled=false; return; }
          const url = data.init_point || data.sandbox_init_point;
          if(!url){ alert("Preferencia creada sin URL. Revis√° el Access Token en Netlify."); btnConfirmar.disabled=false; return; }
          clearCart();
          location.href = url;
          return;
        }

        // Efectivo
        clearCart();
        alert("¬°Pedido enviado! ‚úÖ");
        location.href="index.html";
      }catch(err){
        console.error(err);
        statusEl.textContent = "Error guardando el pedido.";
        alert("No pudimos guardar el pedido o iniciar el pago.");
      }finally{
        btnConfirmar.disabled = false;
      }
    };

    function buildItemsForFS(c){
      const out=[];
      for(const o of Object.values(c.burger)){
        out.push({type:"burger", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0, ...(o.notes?{notes:o.notes}:{})});
      }
      for(const o of Object.values(c.drink)){
        out.push({type:"drink", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0});
      }
      return out;
    }
    function buildItemsForMP(c, total){
      const items=[];
      for(const o of Object.values(c.burger)){
        items.push({ title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0 });
      }
      for(const o of Object.values(c.drink)){
        items.push({ title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0 });
      }
      const valid = items.filter(x => x.quantity>0 && Number.isFinite(x.unit_price) && x.unit_price>0);
      return valid.length ? valid : [{ title:"Pedido Rhodes Burgers", quantity:1, currency_id:"ARS", unit_price:Number(total)||0 }];
    }

    // Fallback PNG -> JPG para logo (header y fondo)
    (function(){
      const img = document.getElementById("logoHeader");
      img.addEventListener("error", ()=>{
        if(!img.dataset.swapped){
          img.dataset.swapped = "1";
          img.src = "images/logo.jpg";
          document.documentElement.style.setProperty("--logo-url", 'url("images/logo.jpg")');
        }
      });
    })();

    // Init
    renderResumen();
  </script>
</body>
</html>
