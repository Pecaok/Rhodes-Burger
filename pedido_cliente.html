<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Confirmar pedido</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <header>
    <a href="index.html"><img src="images/logo.png" alt="Rhodes Burgers" style="height:50px"/></a>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>

    <div class="card">
      <label>Número de pedido</label>
      <input type="text" id="orderNumber" readonly />

      <label>Nombre y apellido</label>
      <input type="text" id="nombre" placeholder="Ej: Juan Pérez" required />

      <label>Método de pago</label>
      <div class="options">
        <label><input type="radio" name="pago" value="mercado_pago" required/> Mercado Pago</label>
        <label><input type="radio" name="pago" value="efectivo"/> Efectivo</label>
      </div>

      <p><strong>Retiro:</strong> Modalidad: <em>Take Away</em> (retira en el local).</p>

      <label>Papas fritas (obligatorio)</label>
      <div class="options">
        <label><input type="radio" name="papas" value="con" required/> Con sazón</label>
        <label><input type="radio" name="papas" value="sin"/> Sin sazonar</label>
      </div>

      <label>Comentarios</label>
      <textarea id="comentarios" placeholder="Ej: Sin mayonesa, agregar servilletas"></textarea>

      <div class="actions">
        <button onclick="cancelar()">Cancelar</button>
        <button onclick="confirmarPedido()">Ir a pagar</button>
      </div>
    </div>
  </main>

  <script>
    // ======== NUMERO DE PEDIDO SECUENCIAL ========
    function generarNumeroPedido() {
      let last = localStorage.getItem("lastOrderNumber") || "0";
      let next = parseInt(last) + 1;
      localStorage.setItem("lastOrderNumber", next);
      return next;
    }
    document.getElementById("orderNumber").value = "#" + generarNumeroPedido();

    function cancelar() {
      window.location.href = "index.html";
    }

    async function confirmarPedido() {
      const nombre = document.getElementById("nombre").value.trim();
      const pagoEl = document.querySelector("input[name='pago']:checked");
      const papas = document.querySelector("input[name='papas']:checked");
      const comentarios = document.getElementById("comentarios").value.trim();
      const orderNumber = document.getElementById("orderNumber").value;

      if (!nombre || !pagoEl || !papas) {
        alert("Por favor completá todos los campos obligatorios.");
        return;
      }

      // Simulación: items guardados en localStorage desde el menú
      const items = JSON.parse(localStorage.getItem("pedido")) || [];
      if (!items.length) {
        alert("No tenés productos en el pedido.");
        return;
      }

      const total = items.reduce((acc, it) => acc + it.price * it.qty, 0);

      // Guardar pedido en Firestore (si corresponde)
      try {
        await fetch("/.netlify/functions/saveOrder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            orderNumber,
            nombre,
            pago: pagoEl.value,
            papas: papas.value,
            comentarios,
            items,
            total,
            fecha: new Date().toISOString()
          })
        });
      } catch (err) {
        console.error("Error guardando pedido:", err);
      }

      // ========== SI ELIGE MERCADO PAGO ==========
      if (pagoEl.value === "mercado_pago") {
        const itemsMP = items.map(it => ({
          title: it.name,
          quantity: it.qty,
          unit_price: it.price
        }));

        try {
          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              items: itemsMP,
              orderId: orderNumber,
              total
            })
          });

          const data = await resp.json();
          console.log("MP respuesta:", data);

          if (data.init_point) {
            window.location.href = data.init_point; // << redirección a MP
          } else {
            alert("No recibimos link de pago. Revisá consola.");
          }
        } catch (err) {
          console.error(err);
          alert("Error al iniciar pago con Mercado Pago.");
        }
        return;
      }

      // ========== SI ELIGE EFECTIVO ==========
      window.location.href = "gracias.html";
    }
  </script>
</body>
</html>
