<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    body::before{ content:""; position:fixed; inset:0; background:url("images/logo.png") center 120px/320px no-repeat; opacity:.06; pointer-events:none; z-index:0; filter:grayscale(100%) }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:900px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }
    .container{ max-width:900px; margin:24px auto; padding:0 12px }
    h1{ font-size:34px; margin:14px 4px 18px }
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:16px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px }
    .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0 }
    .field input,.field textarea{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px }
    .inline{ display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 }
    .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid #e7e7e7; border-radius:999px; padding:8px 12px }
    .hid{ display:none }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid #efefef }
    .muted{ color:var(--muted); font-size:14px }
    .total{ display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; margin-top:10px }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img src="images/logo.png" onerror="this.src='images/logo.jpg'" alt="Rhodes Burgers"></a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">← Seguir comprando</a>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Confirmar pedido</h1>
      <div class="grid">
        <!-- Columna izquierda: datos -->
        <div class="card">
          <div class="field">
            <label>Número de pedido</label>
            <input id="inpNumero" placeholder="Ej: 1" inputmode="numeric" />
          </div>

          <div class="field">
            <label>Nombre y apellido</label>
            <input id="inpNombre" placeholder="Ej: Juan Pérez" autocomplete="name" />
          </div>

          <div class="inline">
            <label class="pill"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
            <label class="pill"><input type="radio" name="pago" value="efectivo" checked> Efectivo</label>
          </div>

          <div class="field">
            <label>Retiro</label>
            <div class="muted">Modalidad: <b>Take Away</b> (retira en el local).</div>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Papas fritas (obligatorio)</label>
            <div class="inline">
              <label class="pill"><input type="radio" name="papas" value="con_sazon"> Con sazón</label>
              <label class="pill"><input type="radio" name="papas" value="sin_sazon"> Sin sazonar</label>
            </div>
            <div class="muted">Si ya elegiste en el menú, viene preseleccionado.</div>
          </div>

          <div class="field">
            <label>Comentarios</label>
            <textarea id="inpComentarios" placeholder="Ej: Sin mayonesa, agregar servilletas"></textarea>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" id="btnCancelar">Cancelar</button>
            <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
          </div>
          <p class="muted" id="status" style="margin-top:8px"></p>
        </div>

        <!-- Columna derecha: resumen -->
        <div class="card">
          <h3>Resumen</h3>
          <div id="items"></div>
          <div class="total"><span>Total</span><span id="total">$0</span></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /*************** CART ROBUSTO: lee storage + ?cart= ***************/
    const CART_KEYS = ["rhodes_cart_v3","rhodes_cart","cart","pending_cart"];
    const money = n => n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function decodeUrlCart() {
      try {
        const qs = new URLSearchParams(location.search);
        if (!qs.has("cart")) return null;
        const decoded = atob(decodeURIComponent(qs.get("cart")));
        return JSON.parse(decoded);
      } catch (e) { return null; }
    }
    function normalizeCart(raw){
      const blank = { burger:{}, drink:{}, fries:null };
      if(!raw) return blank;
      if (Array.isArray(raw)) {
        const out = structuredClone(blank);
        for (const it of raw) {
          const type = it.type === "drink" ? "drink" : "burger";
          const item = it.item || { id: it.id, name: it.name, price: it.price };
          if (!item?.id) continue;
          out[type][item.id] = { qty: it.qty||1, item, extras: it.extras||{patty:0,cheddar:0}, notes: it.notes||"" };
        }
        out.fries = raw.fries ?? null;
        return out;
      }
      const out = structuredClone(blank);
      for (const [id,obj] of Object.entries(raw.burger||{})) {
        const item = obj.item || { id, name: obj.name, price: obj.price };
        out.burger[item.id] = { qty: obj.qty||1, item, extras: obj.extras||{patty:0,cheddar:0}, notes: obj.notes||"" };
      }
      for (const [id,obj] of Object.entries(raw.drink||{})) {
        const item = obj.item || { id, name: obj.name, price: obj.price };
        out.drink[item.id] = { qty: obj.qty||1, item };
      }
      out.fries = raw.fries ?? null;
      return out;
    }
    function mergeCarts(a,b){
      if(!a) return normalizeCart(b);
      if(!b) return normalizeCart(a);
      a = normalizeCart(a); b = normalizeCart(b);
      const out = normalizeCart({});
      out.burger = {...a.burger};
      for (const [k,v] of Object.entries(b.burger)) if(!out.burger[k]) out.burger[k]=v;
      out.drink = {...a.drink};
      for (const [k,v] of Object.entries(b.drink)) if(!out.drink[k]) out.drink[k]=v;
      out.fries = a.fries || b.fries || null;
      return out;
    }
    function loadCartRobusto(){
      let cart = normalizeCart({});
      for (const store of [localStorage, sessionStorage]) {
        for (const key of CART_KEYS) {
          try { const v = store.getItem(key); if(v) cart = mergeCarts(cart, JSON.parse(v)); } catch{}
        }
      }
      const urlCart = decodeUrlCart();
      if (urlCart) cart = mergeCarts(cart, urlCart);
      return cart;
    }

    let cart = loadCartRobusto();

    /*************** RENDER RESUMEN ***************/
    const itemsEl = document.getElementById("items");
    const totalEl = document.getElementById("total");
    function calcTotal(c){
      let t=0;
      for(const o of Object.values(c.burger)) t += (o.item?.price||0)*o.qty;
      for(const d of Object.values(c.drink))  t += (d.item?.price||0)*d.qty;
      return t;
    }
    function renderResumen(){
      const rows=[];
      for(const obj of Object.values(cart.burger)){
        const extrasTxt=[];
        if(obj.extras){
          if(obj.extras.patty) extrasTxt.push(`+${obj.extras.patty} medallón(es)`);
          if(obj.extras.cheddar) extrasTxt.push(`+${obj.extras.cheddar} cheddar`);
        }
        rows.push(`<div class="item">
          <div><strong>${obj.item.name}</strong>
            ${extrasTxt.length?`<div class="muted">${extrasTxt.join(" · ")}</div>`:""}
            ${obj.notes?`<div class="muted">Notas: ${obj.notes}</div>`:""}
            <div class="muted">${money(obj.item.price)} x ${obj.qty}</div>
          </div>
          <div>${money(obj.item.price*obj.qty)}</div>
        </div>`);
      }
      for(const obj of Object.values(cart.drink)){
        rows.push(`<div class="item">
          <div><strong>${obj.item.name}</strong><div class="muted">${money(obj.item.price)} x ${obj.qty}</div></div>
          <div>${money(obj.item.price*obj.qty)}</div>
        </div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal(cart));

      // Preseleccionar papas si venía del menú
      if(cart.fries){
        const r = document.querySelector(\`input[name="papas"][value="\${cart.fries}"]\`);
        if(r) r.checked = true;
      }
    }

    /*************** UI / BOTONES ***************/
    const statusEl = document.getElementById("status");
    document.getElementById("btnCancelar").onclick = ()=> location.href="index.html";

    document.getElementById("btnConfirmar").onclick = async ()=>{
      if(Object.keys(cart.burger||{}).length===0 && Object.keys(cart.drink||{}).length===0){
        alert("Tu carrito está vacío.");
        return;
      }
      const nro = (document.getElementById("inpNumero").value||"").trim();
      const nombre = (document.getElementById("inpNombre").value||"").trim();
      if(!nro){ alert("Ingresá el número de pedido."); return; }
      if(!nombre){ alert("Ingresá tu nombre y apellido."); return; }

      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Elegí un método de pago."); return; }
      const papasEl = document.querySelector('input[name="papas"]:checked');
      if(!papasEl){ alert("Elegí una opción de papas (obligatorio)."); return; }

      // Persistimos las papas en el carrito
      cart.fries = papasEl.value;
      try{
        localStorage.setItem("rhodes_cart_v3", JSON.stringify(cart));
        sessionStorage.setItem("rhodes_cart_v3", JSON.stringify(cart));
      }catch{}

      const comentarios = (document.getElementById("inpComentarios").value||"").trim();

      // Si es efectivo -> WhatsApp (ejemplo)
      if(pagoEl.value==="efectivo"){
        const lineas=[];
        lineas.push(`*Pedido #${nro}*`);
        lineas.push(`Cliente: ${nombre}`);
        lineas.push(`Papas: ${papasEl.value==="con_sazon"?"Con sazón":"Sin sazonar"}`);
        lineas.push(``);
        for(const o of Object.values(cart.burger||{})){ lineas.push(`• ${o.qty}× ${o.item.name}`); }
        for(const d of Object.values(cart.drink||{})){  lineas.push(`• ${d.qty}× ${d.item.name}`); }
        if(comentarios) lineas.push(`\nComentarios: ${comentarios}`);
        lineas.push(`\nTotal: ${document.getElementById("total").textContent}`);
        const msg = encodeURIComponent(lineas.join("\n"));
        // Reemplaza con el nro del local
        const phone = "541170596483";
        location.href = `https://wa.me/${phone}?text=${msg}`;
        return;
      }

      // Si es MP -> tu función serverless (opcional)
      try{
        statusEl.textContent = "Creando pago en Mercado Pago...";
        const payload = {
          numero: nro,
          nombre,
          fries: cart.fries,
          items: [
            ...Object.values(cart.burger||{}).map(o=>({title:o.item.name, quantity:o.qty, unit_price:o.item.price})),
            ...Object.values(cart.drink||{}).map(o=>({title:o.item.name, quantity:o.qty, unit_price:o.item.price}))
          ],
          total: Object.values(cart.burger||{}).reduce((a,o)=>a+o.item.price*o.qty,0) + Object.values(cart.drink||{}).reduce((a,o)=>a+o.item.price*o.qty,0)
        };
        const res = await fetch("/.netlify/functions/createPreference",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!res.ok){
          const t = await res.text();
          throw new Error("createPreference "+res.status+" "+t);
        }
        const data = await res.json();
        const url = data.init_point || data.sandbox_init_point || data.preference?.init_point;
        if(!url) throw new Error("Respuesta sin init_point");
        window.location.href = url;
      }catch(err){
        console.error(err);
        alert("No se pudo iniciar el pago. Verificá tu función de Netlify.");
        statusEl.textContent = "No se pudo iniciar el pago.";
      }
    };

    // Render
    renderResumen();

    // DEBUG opcional
    (function debugPanel(){
      const qs = new URLSearchParams(location.search);
      if (!qs.has("debug")) return;
      const pre = document.createElement("pre");
      pre.style.cssText="white-space:pre-wrap;background:#fff7d6;border:1px solid #ffe08a;padding:10px;border-radius:12px; margin:12px 0";
      pre.textContent =
        "DEBUG CART >>>\n" +
        JSON.stringify(cart, null, 2) + "\n\n" +
        "localStorage[rhodes_cart_v3]: " + (localStorage.getItem("rhodes_cart_v3")||"null") + "\n" +
        "sessionStorage[rhodes_cart_v3]: " + (sessionStorage.getItem("rhodes_cart_v3")||"null");
      (document.querySelector(".container")||document.body).prepend(pre);
    })();
  </script>
</body>
</html>
