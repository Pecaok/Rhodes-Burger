<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="/images/logo.png" />
  <link rel="preload" as="image" href="/images/logo.png">
  <link rel="stylesheet" href="css/theme.css" />
  <style>
    /* ——— Pequeños ajustes visuales para los chips de selección ——— */
    .chip-group{display:flex;gap:12px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:10px;cursor:pointer;
      border:1px solid #e7e7e7;border-radius:999px;padding:12px 16px;
      background:#fff; user-select:none; transition:.15s ease;
    }
    .chip input{appearance:none;width:14px;height:14px;border:2px solid #bbb;border-radius:50%}
    .chip:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .chip input:checked{border-color:#2ecc71;background:#2ecc71}
    .muted{color:#666}
    .card{background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px}
    .grid2{display:grid;grid-template-columns:1.1fr .9fr;gap:20px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f0f0f0}
    .total-row{display:flex;justify-content:space-between;font-weight:800;font-size:18px;margin-top:10px}
    .btn{display:inline-flex;align-items:center;gap:10px;border:2px solid #2ecc71;padding:10px 16px;border-radius:999px;color:#2ecc71;background:#fff;font-weight:700;text-decoration:none;cursor:pointer}
    .btn.primary{background:#2ecc71;color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .field{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
    input[type="text"], textarea{
      width:100%;padding:12px 14px;border:1px solid #e7e7e7;border-radius:12px;
      font:inherit;outline:none
    }
    textarea{min-height:90px;resize:vertical}
    header{position:sticky;top:0;z-index:5;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1000px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand img{width:40px;height:40px;object-fit:contain;border-radius:10px;background:#fff}
    .spacer{flex:1}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand">
        <img src="/images/logo.png" alt="Rhodes Burgers" onerror="this.src='/images/logo.jpg'">
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">← Editar pedido</a>
    </div>
  </header>

  <main class="container" style="max-width:1000px;margin:24px auto;padding:0 12px">
    <h1 style="font-size:34px;margin:14px 4px 18px">Confirmar pedido</h1>

    <div class="grid2">
      <!-- ===== Columna izquierda ===== -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" placeholder="Ej: Juan Pérez" autocomplete="name" />
        </div>

        <div class="field">
          <label>Teléfono (opcional)</label>
          <input id="inpTel" placeholder="Ej: 11 2345 6789" inputmode="tel" />
        </div>

        <div class="field">
          <label>Medio de pago</label>
          <div class="chip-group" id="grupoPago">
            <label class="chip"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
            <label class="chip"><input type="radio" name="pago" value="efectivo"> Efectivo</label>
          </div>
        </div>

        <div class="field">
          <label>Tipo de entrega</label>
          <div class="chip-group">
            <label class="chip"><input type="radio" name="entrega" value="take_away" checked> Take Away</label>
          </div>
          <div class="muted" style="margin-top:4px">* Solo retiro por el local.</div>
        </div>

        <div class="field">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
          <a class="btn ghost" href="index.html">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>
        <p class="muted" id="status" style="margin-top:8px"></p>
      </section>

      <!-- ===== Columna derecha (resumen) ===== -->
      <aside class="card">
        <h2 style="margin:0 0 10px">Resumen</h2>
        <div id="items"></div>
        <div id="friesLine" class="muted" style="margin-top:6px"></div>
        <div class="total-row"><span>Total</span><span id="total">$0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (sin tocar tu conexión) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    // ===== Helpers / carrito =====
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const CART_KEY = "rhodes_cart_v3";

    function loadCart(){
      try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{},fries:null}; }
      catch{ return {burger:{},drink:{},fries:null}; }
    }
    function calcTotal(c){
      let t=0;
      for(const b of Object.values(c.burger)) t += (Number(b.item?.price)||0) * (Number(b.qty)||0);
      for(const d of Object.values(c.drink))  t += (Number(d.item?.price)||0) * (Number(d.qty)||0);
      return t;
    }

    let cart = loadCart();

    // ===== Render resumen =====
    const itemsEl = $("#items"), totalEl = $("#total"), friesLine = $("#friesLine");
    function renderResumen(){
      const rows=[];
      for(const o of Object.values(cart.burger)){
        rows.push(`
          <div class="row">
            <div>
              <div><strong>${o.item.name}</strong></div>
              <div class="muted">${money(o.item.price)} x ${o.qty}</div>
              ${o.notes?`<div class="muted">Notas: ${o.notes}</div>`:""}
              ${o.fries?`<div class="muted">Papas: ${o.fries==='con_sazon'?'Con sazón':'Sin sazonar'}</div>`:""}
            </div>
            <div>${money((Number(o.item.price)||0) * (o.qty||0))}</div>
          </div>`);
      }
      for(const o of Object.values(cart.drink)){
        rows.push(`
          <div class="row">
            <div><strong>${o.item.name}</strong><div class="muted">${money(o.item.price)} x ${o.qty}</div></div>
            <div>${money((Number(o.item.price)||0) * (o.qty||0))}</div>
          </div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;

      // Línea de papas global si existe (para compatibilidad)
      friesLine.textContent = cart.fries
        ? `Papas: ${cart.fries==='con_sazon'?'Con sazón':'Sin sazonar'}`
        : "";

      totalEl.textContent = money(calcTotal(cart));
    }
    renderResumen();

    // ===== Confirmar =====
    const btn = $("#btnConfirmar"), statusEl = $("#status");
    btn.onclick = async () => {
      // Validaciones básicas
      if(Object.keys(cart.burger||{}).length===0 && Object.keys(cart.drink||{}).length===0){
        alert("Tu carrito está vacío."); return;
      }
      const nombre = $("#inpNombre").value.trim();
      const tel     = $("#inpTel").value.trim();
      const notas   = $("#inpNotas").value.trim();

      if(!nombre){ alert("Ingresá tu nombre y apellido."); return; }

      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Elegí un medio de pago."); return; }
      const pago = pagoEl.value;

      const entrega = "take_away"; // único

      // Si usás papas globales obligatorias, controlá acá
      // (si migraste a papas por producto, esto no aplica)
      // Ejemplo leve (dejo comentado):
      // if(!cart.fries){ alert("Elegí una opción de papas en el paso anterior."); return; }

      // Ítems para guardar / MP
      const itemsFS=[], mpItems=[];
      for(const o of Object.values(cart.burger)){
        itemsFS.push({
          type:"burger", id:o.item.id, name:o.item.name,
          qty:Number(o.qty)||0, price:Number(o.item.price)||0,
          ...(o.notes?{notes:o.notes}:{})
        });
        mpItems.push({
          title:o.item.name, quantity:Number(o.qty)||1,
          unit_price:Number(o.item.price)||0, currency_id:"ARS"
        });
      }
      for(const o of Object.values(cart.drink)){
        itemsFS.push({
          type:"drink", id:o.item.id, name:o.item.name,
          qty:Number(o.qty)||0, price:Number(o.item.price)||0
        });
        mpItems.push({
          title:o.item.name, quantity:Number(o.qty)||1,
          unit_price:Number(o.item.price)||0, currency_id:"ARS"
        });
      }

      const order = {
        nombre, telefono: tel || "", pago, entrega,
        fries: cart.fries || null,
        items: itemsFS,
        notas: notas || "",
        total: calcTotal(cart),
        // efectivo se guarda ahora; MP se guarda en webhook de éxito
        status: pago === "efectivo" ? "accepted" : "pending"
      };

      btn.disabled = true; statusEl.textContent = "Procesando...";

      try{
        if (pago === "mercado_pago") {
          const total = Number(order.total)||0;
          if (total <= 0) {
            alert("Para pagar con Mercado Pago el total debe ser mayor a $0.");
            btn.disabled = false; statusEl.textContent = ""; return;
          }

          // Filtramos > 0; si da vacío, hacemos fallback con un ítem resumen
          let payloadItems = mpItems.filter(i => i.quantity>0 && Number(i.unit_price)>0);
          if (payloadItems.length === 0) {
            payloadItems = [{ title:"Pedido Rhodes Burgers", quantity:1, unit_price: total, currency_id:"ARS" }];
          }

          // Empaquetamos la orden (base64) para que la reciba el backend de createPreference
          const orderB64 = (()=>{
            const bytes = new TextEncoder().encode(JSON.stringify(order));
            let bin=""; bytes.forEach(b=>bin += String.fromCharCode(b));
            return btoa(bin);
          })();

          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderB64, items: payloadItems, total })
          });

          const raw = await resp.text(); let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }
          if (!resp.ok || !data.init_point) {
            console.error("MP error", resp.status, data);
            alert(`No se pudo iniciar el pago (HTTP ${resp.status}).`);
            btn.disabled = false; statusEl.textContent = "";
            return;
          }

          // Redirigimos a Mercado Pago. El guardado en Firestore se hace
          // en la función 'mp-success' cuando el pago queda 'approved'.
          location.href = data.init_point;
          return;
        }

        // === EFECTIVO: se guarda ahora mismo ===
        await db.collection("orders").add({
          ...order,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // podés limpiar el carrito si querés:
        localStorage.removeItem(CART_KEY);
        alert("¡Pedido enviado! ✅");
        location.href = "index.html";

      } catch (err) {
        console.error(err);
        statusEl.textContent = "No pudimos procesar el pedido.";
        alert("Ocurrió un error. Probá nuevamente.");
      } finally {
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
