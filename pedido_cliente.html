<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />

  <!-- ESTILOS (solo UI; no se toca la lógica) -->
  <style>
    :root{
      --primary:#2ecc71;
      --primary-600:#22c55e;
      --primary-700:#16a34a;
      --text:#111;
      --muted:#6b7280;
      --bg:#f6f7f8;
      --card:#fff;
      --radius:20px;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --ring:rgba(34,197,94,.2);
      --opt:#f8fafc;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;
      font-family:system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--bg)
    }
    body::before{
      content:"";
      position:fixed; inset:0;
      background:url("images/logo.png") center 120px/320px no-repeat;
      opacity:.06; pointer-events:none; filter:grayscale(100%)
    }

    /* Top bar */
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px; margin:0 auto; padding:12px 14px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; color:inherit; text-decoration:none; font-weight:800}
    .brand img{width:40px; height:40px; object-fit:contain; border-radius:10px}
    .spacer{flex:1}

    /* Botones */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      border:2px solid var(--primary-600);
      padding:10px 16px; border-radius:999px;
      font-weight:700; cursor:pointer; text-decoration:none;
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease, color .15s ease, border-color .15s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{
      color:#fff;
      background:linear-gradient(135deg,var(--primary-700),var(--primary));
      border-color:var(--primary-700);
      box-shadow:0 6px 18px rgba(34,197,94,.25);
    }
    .btn.primary:hover{box-shadow:0 8px 22px rgba(34,197,94,.32)}
    .btn.primary:active{transform:translateY(0); box-shadow:0 4px 14px rgba(34,197,94,.22)}
    .btn.ghost{
      border-color:#e5e7eb; color:#111; background:#fff;
    }
    .btn.ghost:hover{background:#f9fafb; border-color:#d1d5db}

    /* Layout */
    .container{max-width:1100px; margin:26px auto; padding:0 14px}
    h1{font-size:36px; margin:12px 4px 20px}
    .grid{display:grid; grid-template-columns:2fr 1.25fr; gap:20px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px}
    .muted{color:var(--muted)}

    /* Inputs mejorados */
    .field{display:flex; flex-direction:column; gap:8px; margin:12px 0}
    label{font-weight:700}
    input[type="text"], textarea{
      width:100%;
      padding:14px 16px;
      border:1.8px solid #e5e7eb;
      border-radius:14px;
      background:#fff;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input[type="text"]::placeholder, textarea::placeholder{color:#9ca3af}
    input[type="text"]:hover, textarea:hover{border-color:#d1d5db}
    input[type="text"]:focus, textarea:focus{
      border-color:var(--primary-600);
      box-shadow:0 0 0 4px var(--ring);
      background:#fff;
    }

    /* Selectores con icono (píldoras) */
    .selector{display:flex; gap:12px; flex-wrap:wrap}
    .selector input{position:absolute; opacity:0; pointer-events:none}
    .option{
      display:flex; align-items:center; gap:10px;
      padding:12px 16px; border:1.5px solid #e7e7e7; border-radius:14px;
      background:var(--opt); cursor:pointer; user-select:none;
      transition:all .15s ease;
    }
    .option svg{width:20px; height:20px; flex:0 0 auto}
    .option:hover{border-color:#d1d5db; background:#fff}
    .selector input:focus + .option{box-shadow:0 0 0 4px var(--ring)}
    .selector input:checked + .option{
      border-color:var(--primary-600); background:#ecfdf5;
      box-shadow:0 0 0 3px rgba(34,197,94,.15) inset; color:#065f46;
    }

    .help{font-size:13px; margin-top:-4px; color:var(--muted)}

    /* Resumen */
    .item{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px solid #efefef}
    .item .name{font-weight:700}
    .total{display:flex; align-items:center; justify-content:space-between; gap:12px; font-weight:900; font-size:18px; margin-top:12px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .status{margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand">
        <img src="images/logo.png" alt="Rhodes Burgers" />
        <span>Rhodes Burgers</span>
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">← Editar pedido</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>

    <div class="grid">
      <!-- Columna izquierda: datos -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" type="text" placeholder="Ej: Juan Pérez" autocomplete="name" />
        </div>

        <div class="field">
          <label>Teléfono (opcional)</label>
          <input id="inpTel" type="text" placeholder="Ej: 11 2345 6789" autocomplete="tel" />
        </div>

        <div class="field">
          <label>Medio de pago</label>
          <div class="selector">
            <label>
              <input type="radio" name="pago" value="mercado_pago">
              <span class="option">
                <!-- tarjeta -->
                <svg viewBox="0 0 24 24" fill="none"><path d="M3 7h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" stroke="currentColor" stroke-width="1.8"/><path d="M3 10h18" stroke="currentColor" stroke-width="1.8"/></svg>
                Mercado Pago
              </span>
            </label>
            <label>
              <input type="radio" name="pago" value="efectivo">
              <span class="option">
                <!-- billete -->
                <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.8"/><circle cx="12" cy="12" r="2.5" stroke="currentColor" stroke-width="1.6"/></svg>
                Efectivo
              </span>
            </label>
          </div>
        </div>

        <div class="field">
          <label>Tipo de entrega</label>
          <div class="selector">
            <label title="Solo retiro por el local">
              <input type="radio" name="entrega" value="take_away" checked>
              <span class="option">
                <!-- bolsa -->
                <svg viewBox="0 0 24 24" fill="none"><path d="M7 7h10l1.3 12.1A2 2 0 0 1 16.3 21H7.7a2 2 0 0 1-1.99-1.9L7 7Z" stroke="currentColor" stroke-width="1.8"/><path d="M9 7V6a3 3 0 1 1 6 0v1" stroke="currentColor" stroke-width="1.8"/></svg>
                Take Away
              </span>
            </label>
          </div>
          <div class="help">* Solo retiro por el local.</div>
        </div>

        <div class="field">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" rows="4" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div class="actions">
          <a class="btn ghost" href="index.html">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>

        <p class="muted status" id="status"></p>
      </section>

      <!-- Columna derecha: resumen -->
      <aside class="card">
        <h2>Resumen</h2>
        <div id="items"></div>
        <div class="muted" id="friesInfo" style="margin-top:8px"></div>
        <div class="total"><span>Total</span><span id="total">$0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (compat, como venías usando) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    /*************** UTIL ***************/
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const CART_KEY = "rhodes_cart_v3";

    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{},fries:null}; }catch{ return {burger:{},drink:{},fries:null}; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function clearCart(){ saveCart({burger:{},drink:{},fries:null}); }
    function cartCount(c){ let n=0; for(const b of Object.values(c.burger)) n+=b.qty; for(const d of Object.values(c.drink)) n+=d.qty; return n; }
    function calcTotal(c){ let t=0; for(const b of Object.values(c.burger)) t+=(Number(b.item?.price)||0)*b.qty; for(const d of Object.values(c.drink)) t+=(Number(d.item?.price)||0)*d.qty; return t; }

    let cart = loadCart();

    /* ====== Render resumen ====== */
    const itemsEl = $("#items");
    const totalEl = $("#total");
    const friesInfo = $("#friesInfo");
    const statusEl = $("#status");
    const inpNombre = $("#inpNombre");
    const inpTel = $("#inpTel");
    const inpNotas = $("#inpNotas");
    const btnConfirmar = $("#btnConfirmar");

    function renderResumen(){
      const rows=[];
      for(const obj of Object.values(cart.burger)){
        rows.push(`<div class="item">
          <div>
            <div class="name">${obj.item.name}</div>
            ${obj.notes?`<div class="muted">${obj.notes}</div>`:""}
            <div class="muted">${money(obj.item.price)} x ${obj.qty}</div>
          </div>
          <div>${money((Number(obj.item.price)||0)*obj.qty)}</div>
        </div>`);
      }
      for(const obj of Object.values(cart.drink)){
        rows.push(`<div class="item">
          <div>
            <div class="name">${obj.item.name}</div>
            <div class="muted">${money(obj.item.price)} x ${obj.qty}</div>
          </div>
          <div>${money((Number(obj.item.price)||0)*obj.qty)}</div>
        </div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal(cart));
      // Mostrar la selección global de papas (si la hay)
      friesInfo.textContent = cart.fries
        ? `Papas: ${cart.fries==="con_sazon" ? "Con sazón" : "Sin sazonar"}`
        : "";
    }

    /* ====== Confirmar ====== */
    btnConfirmar.onclick = async () => {
      if(cartCount(cart)===0){ alert("Tu carrito está vacío."); return; }

      const nombre = inpNombre.value.trim();
      if(!nombre){ alert("Ingresá tu nombre y apellido."); return; }
      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Elegí un medio de pago."); return; }

      const entrega = "take_away"; // único modo
      const telefono = inpTel.value.trim();
      const notas = inpNotas.value.trim();

      // Armar ítems para guardar y para MP
      const itemsFS=[], mpItems=[];
      for(const o of Object.values(cart.burger)){
        itemsFS.push({type:"burger", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0, ...(o.notes?{notes:o.notes}:{})});
        mpItems.push({title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0});
      }
      for(const o of Object.values(cart.drink)){
        itemsFS.push({type:"drink", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0});
        mpItems.push({title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0});
      }

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nombre,
        telefono: telefono || null,
        pago: pagoEl.value,
        entrega,
        direccion: "",           // sin delivery
        fries: cart.fries,       // global (según index)
        items: itemsFS,
        total: calcTotal(cart),
        status: "accepted",      // mismo comportamiento que ya tenías
        notes: notas || null
      };

      try{
        btnConfirmar.disabled = true;
        statusEl.textContent = "Guardando pedido...";

        // Guardar en Firestore (igual que antes)
        const docRef = await db.collection("orders").add(order);

        // Si es MP, crear preferencia y redirigir
        if (order.pago === "mercado_pago") {
          const valid = mpItems.filter(x => x.quantity>0 && Number.isFinite(x.unit_price) && x.unit_price>0);
          const payloadItems = valid.length ? valid : [{ title:"Pedido Rhodes Burgers", quantity:1, currency_id:"ARS", unit_price:Number(order.total)||0 }];

          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId: docRef.id, total: Number(order.total)||0, nombre: order.nombre, items: payloadItems })
          });

          const raw = await resp.text(); let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }
          if(!resp.ok){
            console.error("MP error", resp.status, data);
            alert(`Error Mercado Pago (${resp.status}).`);
            btnConfirmar.disabled=false; statusEl.textContent="";
            return;
          }

          const url = data.init_point || data.sandbox_init_point;
          if(!url){
            alert("Preferencia creada sin URL. Revisá el Access Token en Netlify.");
            btnConfirmar.disabled=false; statusEl.textContent="";
            return;
          }

          clearCart();
          window.location.href = url;
          return;
        }

        // Efectivo: finalizar
        clearCart();
        alert("¡Pedido enviado! ✅");
        window.location.href = "index.html";
      }catch(err){
        console.error(err);
        statusEl.textContent = "No se pudo guardar el pedido.";
        alert("No pudimos guardar el pedido o iniciar el pago.");
      }finally{
        btnConfirmar.disabled = false;
      }
    };

    // Inicio
    (function init(){ renderResumen(); })();
  </script>
</body>
</html>
