<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#22c55e;     /* verde */
      --primary-700:#16a34a;
      --text:#111827;
      --muted:#6b7280;
      --bg:#f5f7f6;
      --card:#ffffff;
      --ring:#e5e7eb;
      --shadow:0 12px 30px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{ box-sizing:border-box }
    html,body{ margin:0; color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg) }

    /* Marca de agua a pantalla completa */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(ellipse at center, rgba(255,255,255,.55), rgba(255,255,255,.75)),
        url("images/logo.png") center/ min(90vmin, 880px) no-repeat;
      opacity:.11;
      filter:grayscale(100%);
    }

    header{ position:sticky; top:0; z-index:5; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{
      max-width:1100px; margin:0 auto; padding:10px 14px; display:flex; align-items:center; gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; text-decoration:none; color:var(--text) }
    .brand img{ width:34px; height:34px; border-radius:8px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{
      display:inline-flex; align-items:center; gap:10px; border:2px solid var(--ring);
      padding:10px 16px; border-radius:999px; color:#374151; background:#fff; font-weight:700; text-decoration:none; cursor:pointer
    }
    .btn.ghost{ border-color:#e5e7eb; }
    .btn.primary{ background:var(--primary); border-color:var(--primary); color:#fff }
    .btn.primary:hover{ background:var(--primary-700); border-color:var(--primary-700) }

    .container{ max-width:1100px; margin:26px auto; padding:0 14px; position:relative; z-index:1 }
    h1{ font-size:36px; margin:10px 6px 22px }

    .grid-2{ display:grid; grid-template-columns: 1.1fr .9fr; gap:20px }
    @media (max-width:940px){ .grid-2{ grid-template-columns:1fr } }

    .card{
      background:var(--card); border-radius:calc(var(--radius) + 4px);
      box-shadow:var(--shadow); padding:18px; overflow:hidden
    }

    .field{ margin:10px 0 14px }
    .field label{ display:block; font-weight:700; margin:0 0 6px; }

    /* Inputs ‚Äúpill‚Äù */
    .input-pill{
      width:100%;
      padding:14px 16px;
      border:2px solid var(--ring);
      border-radius:16px;
      background:#fff;
      font-size:15px;
      line-height:1;
      outline:none;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
      transition: border-color .15s, box-shadow .15s, transform .15s;
    }
    .input-pill::placeholder{ color:#9ca3af; }
    .input-pill:hover{ transform: translateY(-1px); }
    .input-pill:focus{
      border-color:#d1d5db;
      box-shadow: 0 0 0 4px rgba(34,197,94,.12), inset 0 1px 2px rgba(0,0,0,.04);
    }
    textarea.input-pill{ min-height:104px; resize:vertical }

    /* Pills (radios) */
    .pillrow{ display:flex; flex-wrap:wrap; gap:12px }
    .pill{
      display:flex; align-items:center; gap:10px; border:2px solid var(--ring);
      padding:12px 14px; border-radius:16px; cursor:pointer; user-select:none; background:#fff;
      transition: transform .15s;
    }
    .pill:hover{ transform:translateY(-1px) }
    .pill input{ width:18px; height:18px }
    .pill .ico{ width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center }
    .pill.active{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(34,197,94,.12) }

    .muted{ color:var(--muted) }
    .total{ display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; margin-top:10px }

    .footer-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .status{ color:#ef4444; margin-top:8px; min-height:24px }

    /* Resumen items */
    .item{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; padding:10px 0; border-bottom:1px solid #f1f2f4 }
    .item .left{max-width:75%}
    .item .muted{ font-size:13px }

    @media (max-width:520px){
      .input-pill{ padding:12px 14px; font-size:14.5px }
      .pill{ padding:10px 12px }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html" aria-label="Rhodes Burgers">
        <img src="images/logo.png" alt="" onerror="this.src='images/logo.jpg'">
        <span style="display:none">Rhodes Burgers</span>
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>

    <div class="grid-2">
      <!-- Columna izquierda -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" class="input-pill" placeholder="Ej: Juan P√©rez" autocomplete="name" />
        </div>

        <div class="field">
          <label>Tel√©fono (opcional)</label>
          <input id="inpTelefono" class="input-pill" placeholder="Ej: 11 2345 6789" inputmode="tel" autocomplete="tel" />
        </div>

        <div class="field">
          <label>Medio de pago</label>
          <div class="pillrow" id="payRow">
            <label class="pill"><input type="radio" name="pago" value="mercado_pago">
              <span class="ico">üí≥</span><span>Mercado Pago</span></label>

            <label class="pill"><input type="radio" name="pago" value="efectivo">
              <span class="ico">üíµ</span><span>Efectivo</span></label>
          </div>
        </div>

        <div class="field">
          <label>Tipo de entrega</label>
          <div class="pillrow" id="shipRow">
            <label class="pill"><input type="radio" name="entrega" value="take_away">
              <span class="ico">üõçÔ∏è</span><span>Take Away</span></label>
          </div>
          <div class="muted" style="margin-top:6px">* Solo retiro por el local.</div>
        </div>

        <div class="field">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" class="input-pill" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div class="footer-actions">
          <a class="btn ghost" href="index.html">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>

        <p class="status" id="status"></p>
      </section>

      <!-- Columna derecha -->
      <aside class="card">
        <h2 style="margin:4px 0 14px">Resumen</h2>
        <div id="items"></div>
        <div class="total"><span>Total</span><span id="total">$ 0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase compat (sin tocar tu conexi√≥n) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    /* ====== Carrito / Util ====== */
    const CART_KEY = "rhodes_cart_v3";
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{},fries:null}; }catch{ return {burger:{},drink:{},fries:null}; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function clearCart(){ saveCart({burger:{},drink:{},fries:null}); }
    function cartCount(c){ let n=0; for(const b of Object.values(c.burger)) n+=b.qty; for(const d of Object.values(c.drink)) n+=d.qty; return n; }
    function calcTotal(c){
      let t=0;
      for(const b of Object.values(c.burger)) t+=(Number(b.item?.price)||0)*b.qty;
      for(const d of Object.values(c.drink)) t+=(Number(d.item?.price)||0)*d.qty;
      return t;
    }

    // Helpers PAPAS por hamburguesa
    function friesLabelFromValue(v){
      if(!v) return null;
      return v === 'con_sazon' ? 'Con saz√≥n' : 'Sin sazonar';
    }
    function computeFriesLineForBurger(o, globalFries){
      if (o?.friesByQty && typeof o.friesByQty === 'object') {
        const parts=[];
        if (o.friesByQty.con_sazon) parts.push(`Con saz√≥n x ${o.friesByQty.con_sazon}`);
        if (o.friesByQty.sin_sazon) parts.push(`Sin sazonar x ${o.friesByQty.sin_sazon}`);
        if (parts.length) return "Papas: " + parts.join(", ");
      }
      if (Array.isArray(o?.friesPerUnit)) {
        const count = { con_sazon:0, sin_sazon:0 };
        o.friesPerUnit.forEach(v => { if(v==='con_sazon') count.con_sazon++; if(v==='sin_sazon') count.sin_sazon++; });
        const parts=[];
        if (count.con_sazon) parts.push(`Con saz√≥n x ${count.con_sazon}`);
        if (count.sin_sazon) parts.push(`Sin sazonar x ${count.sin_sazon}`);
        if (parts.length) return "Papas: " + parts.join(", ");
      }
      if (o?.fries) {
        const lbl = friesLabelFromValue(o.fries);
        if (lbl) return "Papas: " + lbl;
      }
      if (globalFries) {
        const lbl = friesLabelFromValue(globalFries);
        if (lbl) return "Papas: " + lbl;
      }
      return null;
    }

    let cart = loadCart();

    // Marcar pill seleccionada
    document.querySelectorAll('.pillrow .pill input').forEach(r=>{
      r.addEventListener('change', ()=>{
        r.closest('.pillrow').querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
        r.closest('.pill').classList.add('active');
      });
    });

    const itemsEl = $("#items");
    const totalEl = $("#total");
    const statusEl = $("#status");
    const btnConfirmar = $("#btnConfirmar");

    function renderResumen(){
      itemsEl.innerHTML = "";
      const rows=[];
      for(const o of Object.values(cart.burger)){
        const friesLine = computeFriesLineForBurger(o, cart.fries);
        const extrasParts=[];
        if (o?.extras) {
          if (o.extras.patty)   extrasParts.push(`+${o.extras.patty} medall√≥n(es)`);
          if (o.extras.cheddar) extrasParts.push(`+${o.extras.cheddar} cheddar`);
        }
        const extrasLine = extrasParts.length ? `Extras: ${extrasParts.join(" ¬∑ ")}` : "";

        rows.push(`<div class="item">
          <div class="left">
            <strong>${o.item.name}</strong>
            <div class="muted">$ ${Number(o.item.price).toLocaleString('es-AR')} x ${o.qty}</div>
            ${friesLine ? `<div class="muted">${friesLine}</div>` : ``}
            ${extrasLine ? `<div class="muted">${extrasLine}</div>` : ``}
            ${o.notes ? `<div class="muted">Notas: ${o.notes}</div>` : ``}
          </div>
          <div>${money((Number(o.item.price)||0)*o.qty)}</div>
        </div>`);
      }
      for(const o of Object.values(cart.drink)){
        rows.push(`<div class="item">
          <div class="left">
            <strong>${o.item.name}</strong>
            <div class="muted">$ ${Number(o.item.price).toLocaleString('es-AR')} x ${o.qty}</div>
          </div>
          <div>${money((Number(o.item.price)||0)*o.qty)}</div>
        </div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal(cart));
    }

    /* ====== Confirmar ====== */
    btnConfirmar.onclick = async ()=>{
      if(cartCount(cart)===0){ alert("Tu carrito est√° vac√≠o."); return; }

      const nombre = $("#inpNombre").value.trim();
      if(!nombre){ alert("Ingres√° tu nombre y apellido."); return; }

      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Eleg√≠ un medio de pago."); return; }

      const entregaEl = document.querySelector('input[name="entrega"]:checked');
      if(!entregaEl){ alert("Eleg√≠ el tipo de entrega."); return; }

      const telefono = $("#inpTelefono").value.trim();
      const notas = $("#inpNotas").value.trim();

      // √çtems para Firestore y para MP (incluimos detalle de papas y extras)
      const itemsFS=[], mpItems=[];
      for(const o of Object.values(cart.burger)){
        const friesInfo = computeFriesLineForBurger(o, cart.fries);
        const extras = (o?.extras && (o.extras.patty || o.extras.cheddar))
          ? { patty: Number(o.extras.patty)||0, cheddar: Number(o.extras.cheddar)||0 }
          : null;

        itemsFS.push({
          type:"burger",
          id:o.item.id,
          name:o.item.name,
          qty:o.qty,
          price:Number(o.item.price)||0,
          ...(o.notes?{notes:o.notes}:{ }),
          ...(friesInfo?{friesInfo}:{ }),
          ...(extras?{extras}:{ })
        });

        mpItems.push({title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0});
      }
      for(const o of Object.values(cart.drink)){
        itemsFS.push({type:"drink", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0});
        mpItems.push({title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0});
      }

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nombre,
        telefono: telefono || null,
        pago: pagoEl.value,
        entrega: entregaEl.value,      // "take_away"
        direccion: "",                 // no se usa en take away
        fries: cart.fries || null,     // global si lo hubiere
        notes: notas || null,
        items: itemsFS,
        total: calcTotal(cart),
        status: "accepted"
      };

      try{
        statusEl.textContent = "";
        btnConfirmar.disabled = true;

        // Guardar pedido
        const docRef = await db.collection("orders").add(order);

        if (order.pago === "mercado_pago") {
          const valid = mpItems.filter(x => x.quantity>0 && Number.isFinite(x.unit_price) && x.unit_price>0);
          const payloadItems = valid.length ? valid : [{ title:"Pedido Rhodes Burgers", quantity:1, currency_id:"ARS", unit_price:Number(order.total)||0 }];

          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              orderId: docRef.id,
              total: Number(order.total)||0,
              nombre: order.nombre,
              items: payloadItems
            })
          });

          const raw = await resp.text(); let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }
          if(!resp.ok){
            console.error("MP error", resp.status, data);
            statusEl.textContent = `No se pudo iniciar Mercado Pago (HTTP ${resp.status}).`;
            btnConfirmar.disabled=false;
            return;
          }

          const url = data.init_point || data.sandbox_init_point;
          if(!url){
            statusEl.textContent = "Preferencia de pago creada sin URL. Revis√° el Access Token del servidor.";
            btnConfirmar.disabled=false;
            return;
          }

          clearCart();
          window.location.href = url;    // Redirecci√≥n a MP
          return;
        }

        // Efectivo
        clearCart();
        alert("¬°Pedido enviado! ‚úÖ");
        window.location.href = "index.html";

      }catch(err){
        console.error(err);
        statusEl.textContent = "No se pudo guardar el pedido. " + (err?.message||"");
      }finally{
        btnConfirmar.disabled = false;
      }
    };

    // Init
    renderResumen();
  </script>
</body>
</html>
