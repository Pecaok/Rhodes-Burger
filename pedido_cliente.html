<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mi Pedido - Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 4px 12px rgba(0,0,0,.08);
      --logo-url:url("images/logo.png");
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--text); background:var(--bg) }
    body::before{
      content:""; position:fixed; inset:0; z-index:0; pointer-events:none;
      background-image:var(--logo-url); background-repeat:no-repeat;
      background-position:center 120px; background-size:clamp(260px,45vw,560px);
      opacity:.08; filter:grayscale(100%);
    }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1000px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ height:48px; width:auto; object-fit:contain; display:block }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:999px; cursor:pointer; border:2px solid var(--primary); background:#fff; color:var(--primary); font-weight:700; text-decoration:none }
    .btn.primary{ background:var(--primary); color:#fff }
    .container{ max-width:1000px; margin:24px auto; padding:0 12px; position:relative; z-index:1 }
    .layout{ display:grid; grid-template-columns:1fr 1fr; gap:20px }
    @media (max-width:900px){ .layout{ grid-template-columns:1fr } }
    .card{ background:#fff; border-radius:18px; box-shadow:var(--shadow); padding:16px }
    .card h2{ margin:0 0 10px; font-size:22px }
    .muted{ color:var(--muted); font-size:14px }
    ul{ list-style:none; padding:0; margin:0 }
    li{ padding:10px 0; border-bottom:1px solid #eee }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px }
    .total{ font-weight:800; font-size:18px; margin-top:10px }
    form .field{ margin:10px 0 }
    form label{ display:block; font-weight:700; margin-bottom:6px }
    form input[type="text"], form input[type="tel"]{ width:100%; padding:10px; border:1px solid #e7e7e7; border-radius:12px; font-size:15px; background:#fff }
    .radio-row{ display:flex; gap:12px; flex-wrap:wrap }
    .radio-row label{ display:inline-flex; align-items:center; gap:8px; border:1px solid #e7e7e7; border-radius:999px; padding:8px 12px; cursor:pointer }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px }
    .ok,.err{ padding:10px; border-radius:12px; margin:10px 0; display:none }
    .ok{ background:#e7f8ef; border:1px solid #c7efda; color:#0c6b3f }
    .err{ background:#fde7e7; border:1px solid #ffc1c1; color:#8a1c1c }
    .small{ font-size:13px; color:#777 }
    .right{ text-align:right }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img id="logo" src="" alt="Rhodes Burgers"></a>
      <div class="spacer"></div>
      <a class="btn" href="index.html">‚¨ÖÔ∏è Editar pedido</a>
    </div>
  </header>

  <main class="container">
    <h1>Mi Pedido</h1>
    <div class="layout">
      <section class="card">
        <h2>Resumen</h2>
        <div id="friesLine" class="muted" style="display:none"></div>
        <ul id="lista-pedido"></ul>
        <div class="total row"><span>Total</span><span id="total">$0</span></div>
        <div class="small right" id="itemsCount"></div>
      </section>

      <section class="card">
        <h2>Datos para confirmar</h2>
        <form id="formPedido">
          <div class="field"><label for="nombre">Nombre</label><input id="nombre" type="text" required></div>
          <div class="field"><label for="apellido">Apellido</label><input id="apellido" type="text" required></div>
          <div class="field"><label for="telefono">Tel√©fono (opcional)</label><input id="telefono" type="tel" inputmode="tel"></div>

          <div class="field">
            <label>M√©todo de pago</label>
            <div class="radio-row">
              <label><input type="radio" name="pago" value="Efectivo" required> Efectivo</label>
              <label><input type="radio" name="pago" value="Mercado Pago" required> Mercado Pago</label>
              <label><input type="radio" name="pago" value="Transferencia" required> Transferencia</label>
            </div>
          </div>

          <div class="field">
            <label>Entrega</label>
            <div class="radio-row" id="entregaRow">
              <label><input type="radio" name="entrega" value="Delivery" required> Delivery</label>
              <label><input type="radio" name="entrega" value="Take Away" required> Take Away</label>
            </div>
          </div>

          <div class="field" id="direccionField" style="display:none">
            <label for="direccion">Direcci√≥n</label>
            <input id="direccion" type="text" placeholder="Calle y altura, piso/depto">
          </div>

          <div class="field">
            <label for="notas">Notas (opcional)</label>
            <input id="notas" type="text" placeholder="Timbre roto, etc.">
          </div>

          <div class="err" id="errMsg"></div>
          <div class="ok" id="okMsg"></div>

          <div class="actions">
            <button type="button" class="btn" id="btnVolver">‚¨ÖÔ∏è Volver</button>
            <button type="submit" class="btn primary" id="btnConfirmar">Confirmar pedido</button>
          </div>
        </form>
      </section>
    </div>
  </main>

  <!-- Resolver de logo -->
  <script>
    (function resolveLogo(){
      const candidates = [
        "images/logo.png","images/logo.jpg",
        "/images/logo.png","/images/logo.jpg",
        "images/Logo.png","images/Logo.jpg"
      ];
      function findFirstExisting(list){
        return new Promise(resolve=>{
          let i=0;
          const next=()=>{
            if(i>=list.length) return resolve(null);
            const img=new Image();
            img.onload=()=>resolve(list[i]);
            img.onerror=()=>{ i++; next(); };
            img.src=list[i]+"?v="+Date.now();
          };
          next();
        });
      }
      findFirstExisting(candidates).then(src=>{
        const finalSrc = src || "images/logo.png";
        console.log("[logo] candidato encontrado:", finalSrc);
        const logoEl = document.getElementById("logo");
        if(logoEl) logoEl.src = finalSrc;
        document.documentElement.style.setProperty("--logo-url", `url("${finalSrc}")`);
        let link = document.querySelector('link[rel="icon"]');
        if(!link){ link = document.createElement("link"); link.rel = "icon"; document.head.appendChild(link); }
        link.href = finalSrc;
      });
    })();
  </script>

  <!-- Firebase + Pedido (long-polling + ping + timeout) -->
  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { initializeFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Tu config:
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5Y0WDE0ouLn-Ib_iD1yUesok5SEh88",
      authDomain: "rhodes-burgers.firebaseapp.com",
      projectId: "rhodes-burgers",
      storageBucket: "rhodes-burgers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e",
      measurementId: "G-LQVYTJWHSM"
    };

    const app = getApps()[0] || initializeApp(firebaseConfig);
    console.log("[firebase] app options:", app.options);

    // üëá Forzamos long-polling para evitar bloqueos del transport
    const db = initializeFirestore(app, {
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });

    const CART_KEY = "rhodes_cart_v3";
    const $ = s=>document.querySelector(s);
    const money = n=>n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const lista = $("#lista-pedido"), totalSpan = $("#total"), friesLine = $("#friesLine"), itemsCount=$("#itemsCount");

    function getCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([$?*|{}\(\)\[\]\\\/\+^])/g,'\\$1') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }
    function decodeCartBase64(b64){
      try{ const bin = atob(b64); const bytes = Uint8Array.from(bin, c => c.charCodeAt(0)); const json = new TextDecoder().decode(bytes); return JSON.parse(json); }
      catch(e){ return null; }
    }
    function parseCartFromAnywhere(){
      const p = new URLSearchParams(location.search);
      if(p.has("cart")){ const c = decodeCartBase64(p.get("cart")); if(c) return c; }
      try{ const raw = sessionStorage.getItem(CART_KEY); if(raw){ const c = JSON.parse(raw); if(c) return c; } }catch{}
      const ck = getCookie("cart"); if(ck){ const c = decodeCartBase64(ck); if(c) return c; }
      return { burger:{}, drink:{}, fries:null };
    }
    const cart = parseCartFromAnywhere();

    function renderResumen(){
      lista.innerHTML=""; let total=0; let count=0;
      if(cart.fries){ friesLine.style.display="block"; friesLine.textContent = `Papas: ${cart.fries==="con_sazon"?"Con saz√≥n":"Sin sazonar"}`; }
      else { friesLine.style.display="none"; }
      if(cart.burger){
        for(const o of Object.values(cart.burger)){
          const ex=[]; if(o.extras?.patty) ex.push(`+${o.extras.patty} medall√≥n(es)`); if(o.extras?.cheddar) ex.push(`+${o.extras.cheddar} cheddar`);
          const li=document.createElement("li");
          li.innerHTML=`<div class="row"><div><strong>${o.item?.name||"Producto"}</strong>${ex.length?`<div class="muted">${ex.join(" ¬∑ ")}</div>`:""}${o.notes?`<div class="muted">Notas: ${o.notes}</div>`:""}</div><div>${money((o.item?.price||0)*(o.qty||0))}</div></div>`;
          lista.appendChild(li);
          total+=(o.item?.price||0)*(o.qty||0); count+=(o.qty||0);
        }
      }
      if(cart.drink){
        for(const o of Object.values(cart.drink)){
          const li=document.createElement("li");
          li.innerHTML=`<div class="row"><div><strong>${o.item?.name||"Bebida"}</strong></div><div>${money((o.item?.price||0)*(o.qty||0))}</div></div>`;
          lista.appendChild(li);
          total+=(o.item?.price||0)*(o.qty||0); count+=(o.qty||0);
        }
      }
      totalSpan.textContent=money(total);
      itemsCount.textContent = count ? `${count} √≠tem(s)` : "No hay productos en tu pedido.";
    }
    renderResumen();

    const form = $("#formPedido");
    const direccionField=$("#direccionField");
    const errMsg=$("#errMsg"), okMsg=$("#okMsg");

    $("#entregaRow").addEventListener("change", ()=>{
      const val = (new FormData(form).get("entrega")) || "";
      direccionField.style.display = (val==="Delivery") ? "block" : "none";
      if(val!=="Delivery") $("#direccion").value="";
    });
    $("#btnVolver").addEventListener("click", ()=>{ location.href="index.html"; });

    // --- helpers UI + timeout ---
    function showError(msg){ errMsg.style.display="block"; errMsg.textContent=msg; }
    function showOK(msg){ okMsg.style.display="block"; okMsg.textContent=msg; }
    function withTimeout(promise, ms=15000){
      return Promise.race([
        promise,
        new Promise((_,rej)=>setTimeout(()=>rej(new Error("TIMEOUT: No se pudo contactar a Firestore")), ms))
      ]);
    }
    async function pingFirestore(){
      return addDoc(collection(db, "_healthchecks"), { t: serverTimestamp(), src: "pedido_cliente" });
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault(); errMsg.style.display="none"; okMsg.style.display="none";

      const nombre=$("#nombre").value.trim();
      const apellido=$("#apellido").value.trim();
      const telefono=$("#telefono").value.trim();
      const pago=form.querySelector('input[name="pago"]:checked')?.value||"";
      const entrega=form.querySelector('input[name="entrega"]:checked')?.value||"";
      const direccion=$("#direccion")?.value.trim()||"";
      const notas=$("#notas")?.value.trim()||"";

      if(!nombre || !apellido) return showError("Complet√° nombre y apellido.");
      if(!pago) return showError("Eleg√≠ un m√©todo de pago.");
      if(!entrega) return showError("Indic√° si es Delivery o Take Away.");
      if(entrega==="Delivery" && !direccion) return showError("Ingres√° la direcci√≥n para el Delivery.");

      const hasItems = (cart && (Object.keys(cart.burger||{}).length || Object.keys(cart.drink||{}).length));
      if(!hasItems) return showError("Tu pedido est√° vac√≠o. Volv√© al men√∫ para agregar productos.");

      const btn=$("#btnConfirmar"); btn.disabled=true; btn.textContent="Confirmando...";

      try{
        // 1) Ping r√°pido (detecta reglas/config/transporte)
        await withTimeout(pingFirestore(), 8000);

        // 2) Crear pedido
        const payload = {
          cliente:{ nombre, apellido, telefono: telefono||null },
          pago, entrega, direccion: entrega==="Delivery"?direccion:null,
          notas: notas||null, fries: cart.fries||null,
          items:{
            burgers: mapBurgers(cart.burger),
            drinks: mapDrinks(cart.drink)
          },
          total: calcTotal(cart),
          createdAt: serverTimestamp(),
          status:"pendiente"
        };

        const ref = await withTimeout(addDoc(collection(db,"pedidos"), payload), 15000);
        showOK(`¬°Listo! Tu pedido fue creado. C√≥digo: ${ref.id}`);
        try{ sessionStorage.removeItem(CART_KEY); }catch{}
        document.cookie = "cart=; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/; SameSite=Lax";
      }catch(errAny){
        console.error("[firestore] error:", errAny);
        const code = errAny?.code ? `(${errAny.code}) ` : "";
        showError(`${code}${errAny?.message || errAny}`);
      }finally{
        btn.disabled=false; btn.textContent="Confirmar pedido";
      }
    });

    function calcTotal(c){ let t=0; if(c?.burger){ for(const o of Object.values(c.burger)){ t+=(o.item?.price||0)*(o.qty||0); } } if(c?.drink){ for(const o of Object.values(c.drink)){ t+=(o.item?.price||0)*(o.qty||0); } } return t; }
    function mapBurgers(b){ if(!b) return []; return Object.values(b).map(o=>({ id:o.item?.id||null, name:o.item?.name||null, price:o.item?.price||0, qty:o.qty||0, extras:o.extras||{}, notes:o.notes||null })); }
    function mapDrinks(d){ if(!d) return []; return Object.values(d).map(o=>({ id:o.item?.id||null, name:o.item?.name||null, price:o.item?.price||0, qty:o.qty||0 })); }
  </script>
</body>
</html>
