<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f1f1f1; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.09);
      --pill:#f8f8f8; --pill-border:#e8e8e8;
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }

    /* Fondo marca de agua grande */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:url("images/logo.png") center 20vh/720px no-repeat; opacity:.05; filter:grayscale(100%)
    }

    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1150px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit; font-weight:800 }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }
    .container{ max-width:1150px; margin:28px auto; padding:0 12px }
    h1{ font-size:36px; margin:14px 4px 22px }

    .grid-2{ display:grid; grid-template-columns:1.1fr .9fr; gap:20px }
    @media (max-width:960px){ .grid-2{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border-radius:22px; box-shadow:var(--shadow); padding:16px; }
    .field{ display:flex; flex-direction:column; gap:6px; margin:12px 0 }
    .field input, .field textarea{
      width:100%; padding:14px 14px; border-radius:12px; border:1px solid #ddd; outline:none;
      font-size:15px; background:#fff;
    }
    .field textarea{ min-height:120px; resize:vertical }

    .group-title{ font-weight:800; margin:14px 0 8px }
    .pills{ display:flex; gap:12px; flex-wrap:wrap }
    .pill{
      display:flex; align-items:center; gap:10px; background:var(--pill); border:2px solid var(--pill-border);
      padding:12px 14px; border-radius:14px; cursor:pointer; user-select:none;
    }
    .pill input{ width:18px; height:18px }
    .pill.active{ border-color:var(--primary); background:#eafff1 }
    .muted{ color:var(--muted); font-size:14px }
    .actions{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap }

    /* Resumen */
    .line{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 0; border-bottom:1px solid #f0f0f0 }
    .total{ display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:900; font-size:20px; padding-top:14px }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img src="images/logo.png" alt="Rhodes Burgers"><span>Rhodes Burgers</span></a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>
    <div class="grid-2">
      <!-- IZQUIERDA: formulario -->
      <section class="card">
        <div class="field">
          <label><strong>Nombre y apellido</strong></label>
          <input id="inpNombre" placeholder="Ej: Juan P√©rez" autocomplete="name" />
        </div>

        <div class="field">
          <label><strong>Tel√©fono (opcional)</strong></label>
          <input id="inpTel" placeholder="Ej: 11 2345 6789" inputmode="tel" />
        </div>

        <div class="group-title">Medio de pago</div>
        <div class="pills" id="pagoWrap">
          <label class="pill"><input type="radio" name="pago" value="mercado_pago"> <span>üí≥ Mercado Pago</span></label>
          <label class="pill"><input type="radio" name="pago" value="efectivo"> <span>üíµ Efectivo</span></label>
        </div>

        <div class="group-title">Tipo de entrega</div>
        <div class="pills" id="entregaWrap">
          <label class="pill"><input type="radio" name="entrega" value="take_away"> <span>üõçÔ∏è Take Away</span></label>
        </div>
        <div class="muted">* Solo retiro por el local.</div>

        <div class="field">
          <label><strong>Notas (opcional)</strong></label>
          <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div class="actions">
          <a class="btn ghost" href="index.html">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>
        <p class="muted" id="status" style="margin-top:8px"></p>
      </section>

      <!-- DERECHA: resumen -->
      <aside class="card">
        <h2 style="margin:6px 0 10px">Resumen</h2>
        <div id="resumen"></div>
        <div class="total"><span>Total</span><span id="totalTxt">$ 0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (no tocar) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Tu config tal cual
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    /*************** UTIL ***************/
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const friesLabel = v => v==='con_sazon' ? 'Con saz√≥n' : 'Sin sazonar';

    /*************** CARRITO ***************/
    const CART_KEY = "rhodes_cart_v3";
    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{}}; }catch{ return {burger:{},drink:{}}; } }
    function cartCount(c){ let n=0; for(const b of Object.values(c.burger||{})) n+=b.qty; for(const d of Object.values(c.drink||{})) n+=d.qty; return n; }
    function calcTotal(c){
      let t=0;
      for(const obj of Object.values(c.burger||{})){
        const base=(obj.item?.price||0);
        const extras=(obj.extras?.patty||0)*0 + (obj.extras?.cheddar||0)*0; // si sum√°s precio, ponelo ac√°
        t += (base+extras)*obj.qty;
      }
      for(const d of Object.values(c.drink||{})) t += (d.item?.price||0)*d.qty;
      return t;
    }

    let cart = loadCart();

    /*************** UI: selecci√≥n estilo pills ***************/
    function wirePills(container){
      const box = $(container);
      box.addEventListener('change', ()=>{
        box.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
        const sel = box.querySelector('input:checked');
        if(sel) sel.closest('.pill').classList.add('active');
      });
    }
    wirePills('#pagoWrap');
    wirePills('#entregaWrap');

    /*************** RENDER RESUMEN ***************/
    const resumen = $("#resumen"), totalTxt=$("#totalTxt");
    function renderResumen(){
      const rows=[];
      const burgers = Object.values(cart.burger||{});
      if(!burgers.length && !Object.keys(cart.drink||{}).length){
        rows.push(`<p class="muted">No hay productos en el carrito.</p>`);
      }
      for(const obj of burgers){
        const extrasTxt=[];
        if(obj.extras){
          if(obj.extras.patty) extrasTxt.push(`+${obj.extras.patty} medall√≥n(es)`);
          if(obj.extras.cheddar) extrasTxt.push(`+${obj.extras.cheddar} cheddar`);
        }
        const unit = (obj.item?.price||0); // si sum√°s precio de extras, ajust√° aqu√≠
        rows.push(`
          <div class="line">
            <div>
              <div><strong>${obj.item?.name||'Producto'}</strong> <span class="muted">¬∑ ${money(unit)} x ${obj.qty}</span></div>
              <div class="muted">Papas: ${friesLabel(obj.fries)}</div>
              ${extrasTxt.length?`<div class="muted">${extrasTxt.join(" ¬∑ ")}</div>`:""}
              ${obj.notes?`<div class="muted">Notas: ${obj.notes}</div>`:""}
            </div>
            <div>${money(unit*obj.qty)}</div>
          </div>
        `);
      }
      for(const obj of Object.values(cart.drink||{})){
        rows.push(`
          <div class="line">
            <div>
              <div><strong>${obj.item?.name||'Bebida'}</strong> <span class="muted">¬∑ ${money(obj.item?.price||0)} x ${obj.qty}</span></div>
            </div>
            <div>${money((obj.item?.price||0)*obj.qty)}</div>
          </div>
        `);
      }
      resumen.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalTxt.textContent = money(calcTotal(cart));
    }
    renderResumen();

    /*************** CONFIRMAR ***************/
    const btnConfirmar = $("#btnConfirmar");
    const statusEl = $("#status");
    const inpNombre = $("#inpNombre");
    const inpTel = $("#inpTel");
    const inpNotas = $("#inpNotas");

    btnConfirmar.onclick = async ()=>{
      try{
        if(cartCount(cart)===0){ alert("Tu carrito est√° vac√≠o."); return; }
        const nombre = inpNombre.value.trim();
        if(!nombre){ alert("Ingres√° tu nombre y apellido."); return; }

        const pagoEl = document.querySelector('input[name="pago"]:checked');
        if(!pagoEl){ alert("Eleg√≠ un medio de pago."); return; }

        const entregaEl = document.querySelector('input[name="entrega"]:checked');
        if(!entregaEl){ alert("Eleg√≠ el tipo de entrega."); return; }

        const itemsFS=[], mpItems=[];
        // Hamburguesas con fries por √≠tem
        for(const obj of Object.values(cart.burger||{})){
          const base = Number(obj.item?.price)||0;
          itemsFS.push({
            type:"burger",
            id: obj.item?.id || "",
            name: obj.item?.name || "Producto",
            qty: Number(obj.qty)||1,
            price: base,
            fries: obj.fries || null,
            ...(obj.extras ? { extras: obj.extras } : {}),
            ...(obj.notes  ? { notes:  obj.notes  } : {})
          });
          mpItems.push({ title: obj.item?.name || "Producto", quantity: Number(obj.qty)||1, currency_id:"ARS", unit_price: base });
        }
        // Bebidas
        for(const obj of Object.values(cart.drink||{})){
          const base = Number(obj.item?.price)||0;
          itemsFS.push({
            type:"drink",
            id: obj.item?.id || "",
            name: obj.item?.name || "Bebida",
            qty: Number(obj.qty)||1,
            price: base
          });
          if(base>0) mpItems.push({ title: obj.item?.name || "Bebida", quantity: Number(obj.qty)||1, currency_id:"ARS", unit_price: base });
        }

        const order = {
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          nombre,
          telefono: inpTel.value.trim() || "",
          pago: pagoEl.value,
          entrega: entregaEl.value, // take_away
          items: itemsFS,
          total: calcTotal(cart),
          status: "accepted" // (como lo ven√≠as usando)
        };

        btnConfirmar.disabled = true;
        statusEl.textContent = "Guardando pedido...";

        // 1) Guardar pedido
        const docRef = await db.collection("orders").add(order);

        // 2) Si es MP, crear preferencia y redirigir
        if (order.pago === "mercado_pago") {
          // Si todas las l√≠neas dan $0, mandamos 1 √≠tem con el total
          let payloadItems = mpItems.filter(x => x.quantity>0 && Number.isFinite(x.unit_price) && x.unit_price>0);
          if(!payloadItems.length){
            payloadItems = [{ title:"Pedido Rhodes Burgers", quantity:1, currency_id:"ARS", unit_price:Number(order.total)||0 }];
          }

          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId: docRef.id, total: Number(order.total)||0, nombre: order.nombre, items: payloadItems })
          });

          const raw = await resp.text(); let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }
          if(!resp.ok){ console.error("MP error", resp.status, data); alert(`Error MP ${resp.status}: ${data.error||data.raw||"sin detalle"}`); btnConfirmar.disabled=false; return; }

          const url = data.init_point || data.sandbox_init_point;
          if(!url){ alert("Preferencia creada sin URL. Revis√° el Access Token en Netlify."); btnConfirmar.disabled=false; return; }

          // Limpio carrito y a MP
          localStorage.removeItem(CART_KEY);
          window.location.href = url;
          return;
        }

        // Efectivo
        localStorage.removeItem(CART_KEY);
        alert("¬°Pedido enviado! ‚úÖ");
        window.location.href = "index.html";
      }catch(err){
        console.error(err);
        statusEl.textContent = "Error guardando el pedido.";
        alert("No pudimos guardar el pedido o iniciar el pago.");
      }finally{
        btnConfirmar.disabled = false;
      }
    };
  </script>
</body>
</html>
