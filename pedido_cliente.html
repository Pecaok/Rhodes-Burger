<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{--primary:#625A45;--text:#111;--muted:#666;--bg:#f6f6f6;--card:#fff;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.08);--ring:#eaeaea}
    *{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .btn.disabled, .btn[disabled]{ opacity:.6; pointer-events:none; }
    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h1{font-size:32px;margin:10px 0 18px}
    label{font-weight:600;margin:6px 0;display:block}
    input[type="text"]{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    .group{margin:14px 0}
    .chips{display:flex;gap:12px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:999px;padding:10px 14px}
    .chip input{accent-color:var(--primary)}
    .muted{color:var(--muted)}
    .muted-small{color:var(--muted); font-size:13px; margin-top:6px;}
    .pay-hint{font-size:13px;color:var(--muted);margin-top:6px}
    .chip-col{display:flex;flex-direction:column;align-items:flex-start;gap:6px}
    .right .row{display:flex;align-items:center;justify-content:space-between;margin:10px 0}
    .total{font-weight:800;font-size:18px}
    textarea{width:100%;min-height:90px;border:1px solid var(--ring);border-radius:12px;padding:10px}
    .actions{display:flex;gap:10px;margin-top:12px}.actions .btn{flex:1}
    .statusHint{font-size:13px;color:var(--muted);margin-top:10px}
    html,body{min-height:100%} body{position:relative}
    body::before{content:"";position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:clamp(240px,48vmin,560px);background:url("images/logo.png") center/contain no-repeat;opacity:.08;pointer-events:none;z-index:5}
    .cupon-ok{color:green;font-weight:700}
    .cupon-err{color:#b00020;font-weight:700}
    .payment-hint-box{margin-top:8px;font-weight:700;color:var(--primary)}
    /* slots UI */
    .slots-row{display:flex;gap:8px;align-items:center}
    .slot-select{padding:10px;border-radius:12px;border:1px solid var(--ring);background:#fff}
    .slot-full{color:#b00020;font-weight:800}
    .slot-ok{color:var(--primary);font-weight:800}
    .slot-meta{font-size:13px;color:#666;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>Confirmar pedido</h1>

      <div class="group">
        <label>Nombre y apellido</label>
        <input id="inpNombre" type="text" placeholder="Ej: Juan P√©rez">
      </div>

      <div class="group">
        <label>Tel√©fono (opcional)</label>
        <input id="inpTelefono" type="text" placeholder="Ej: 11 2345 6789">
      </div>

      <div class="group">
        <label>Medio de pago</label>
        <div class="chips">
          <div class="chip-col">
            <label class="chip"><input id="payTransfer" type="radio" name="pago" value="mercado_pago"> Transferencia</label>
            <div class="muted-small"></div>
          </div>
          <div class="chip-col">
            <label class="chip"><input id="payLocal" type="radio" name="pago" value="efectivo"> En Local</label>
            <div class="muted-small"></div>
          </div>
        </div>
        <div id="paymentHint" class="payment-hint-box" aria-live="polite"></div>
      </div>

      <div class="group">
        <label>Tipo de entrega</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="entrega" value="take_away" checked> Take Away</label>
        </div>
        <div class="muted" style="margin-top:6px">* Solo retiro por el local.</div>
      </div>

      <!-- SLOTS: Solo hoy (intervalo base 15m). Adicionales seg√∫n cantidad de hamburguesas -->
      <div class="group">
        <label>Horario de retiro</label>
        <div class="slots-row">
          <select id="slotTime" class="slot-select" aria-label="Seleccionar horario"></select>
          <button id="btnRefreshSlots" class="btn ghost" title="Actualizar turnos">üîÅ</button>
        </div>
        <div id="slotNote" class="slot-meta">Cargando turnos...</div>
      </div>

      <div class="group">
        <label>¬øTen√©s un cup√≥n de descuento?</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="inpCupon" type="text" placeholder="C√≥digo del cup√≥n" style="flex:1">
          <button id="btnAplicarCupon" class="btn ghost">Aplicar</button>
        </div>
        <div id="cuponMsg" class="muted-small" style="margin-top:8px"></div>
      </div>

      <div class="group">
        <label>Notas (opcional)</label>
        <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        <div class="muted-small"></div>
      </div>

      <div class="actions">
        <a class="btn ghost" href="index.html">Cancelar</a>
        <button class="btn primary" id="btnConfirmar">Confirmar Pedido</button>
      </div>

      <div class="statusHint">Te redirigimos a WhatsApp con el detalle y un link para seguir el estado.</div>
    </section>

    <aside class="card right">
      <h3>Resumen</h3>
      <div id="resumen"></div>
      <div class="row total">
        <div>Total</div><div id="resTotal">$ 0</div>
      </div>
    </aside>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* === FIREBASE === */
    var firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebaseapp.com",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var db = firebase.firestore();

    /* === DEFAULT SLOTS CONFIG (puede ser sobreescrito por config/slots) ===
         openTime, closeTime en "HH:mm"
         baseInterval = 15 (minutos) -> slots base (siempre)
         capacity = 4
    */
    var SLOTS_CONFIG = { openTime: "12:00", closeTime: "23:00", baseInterval: 15, capacity: 4 };

    /* === CART / CUPON / PRECIOS === */
    var CART_KEY="rhodes_cart_v3";
    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{}} } catch(e){ return {burger:{},drink:{}} } }
    var cart = loadCart();

    var appliedCoupon = null;
    var appliedDiscount = 0;

    const EXTRA_PRICE_PATTY = 2400, EXTRA_PRICE_CHEDDAR = 300;
    function unitWithExtras(it){
      var base=(it.item&&it.item.price)?it.item.price:(it.price||0);
      var pz=((it.extras&&it.extras.patty)?it.extras.patty:0)*((it.extras&&it.extras.EXTRA_PRICE_PATTY)?it.extras.EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY);
      var ch=((it.extras&&it.extras.cheddar)?it.extras.cheddar:0)*((it.extras&&it.extras.EXTRA_PRICE_CHEDDAR)?it.extras.EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR);
      return base+pz+ch;
    }
    function calcRawTotal(){ var t=0; for(var k in cart.burger){ var o=cart.burger[k]; t += unitWithExtras(o)*(o.qty||0) } for(var k in cart.drink){ var d=cart.drink[k]; t += ((d.item&&d.item.price)||0)*(d.qty||0) } return t; }
    function calcTotalWithDiscount(){ var raw=calcRawTotal(); if(appliedDiscount && appliedDiscount>0) return Math.round(raw*(1-(appliedDiscount/100))); return raw; }

    function money(n){ return (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}); }

    // contar hamburguesas totales en cart
    function totalBurgersInCart(){
      var s=0; for(var k in cart.burger){ s += Number(cart.burger[k].qty||0); } return s;
    }

    /* === RENDER RESUMEN (muestra slot seleccionado) === */
    function renderResumen(){
      var resumen=document.getElementById('resumen'); resumen.innerHTML='';
      function esc(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      for(var k in cart.burger){
        var o=cart.burger[k];
        var extras=[];
        if(o.extras && o.extras.patty) extras.push("+"+o.extras.patty+" medall√≥n(es)");
        if(o.extras && o.extras.cheddar) extras.push("+"+o.extras.cheddar+" cheddar");
        var unit = unitWithExtras(o);
        var line = unit * (o.qty||0);
        resumen.insertAdjacentHTML('beforeend', '<div style="margin-bottom:8px"><strong>'+ (o.qty||0) +'√ó '+ esc(o.item?o.item.name:'') +'</strong><div class="muted">Papas: '+ esc(o.fries || '‚Äî') + (extras.length?(' ¬∑ '+extras.join(' ¬∑ ')) : '') + '</div><div>'+ money(line) +'</div></div>');
      }
      for(var k in cart.drink){
        var d=cart.drink[k];
        resumen.insertAdjacentHTML('beforeend', '<div style="margin-bottom:8px"><strong>'+ (d.qty||0) +'√ó '+ esc(d.item?d.item.name:'') +'</strong><div>'+ money((d.item&&d.item.price||0)*(d.qty||0)) +'</div></div>');
      }

      var nota = (document.getElementById('inpNotas').value||'').trim();
      if(nota) resumen.insertAdjacentHTML('beforeend','<div style="margin-top:8px"><strong>Nota del pedido</strong><div class="muted">'+esc(nota)+'</div></div>');

      if(appliedCoupon){
        resumen.insertAdjacentHTML('beforeend','<div style="margin-top:8px"><strong>Cup√≥n</strong><div class="muted">C√≥digo: '+esc(appliedCoupon.codigo)+' ‚Äî '+esc(String(appliedCoupon.descuento))+'% off</div></div>');
      }

      // slot selected
      var slotSel = document.getElementById('slotTime');
      if(slotSel && slotSel.value){
        var opt = slotSel.selectedOptions[0];
        var pretty = opt ? (opt.dataset.pretty || opt.textContent) : '';
        if(pretty) resumen.insertAdjacentHTML('beforeend','<div style="margin-top:8px"><strong>Horario de retiro</strong><div class="muted">'+esc(pretty)+'</div></div>');
      }

      document.getElementById('resTotal').textContent = money(calcTotalWithDiscount());
    }

    /* === CUP√ìN (igual que antes) === */
    async function applyCouponCode(){
      var code = (document.getElementById('inpCupon').value||'').trim().toUpperCase();
      var msg = document.getElementById('cuponMsg');
      msg.textContent=''; msg.className='muted-small';
      appliedCoupon = null; appliedDiscount = 0;
      if(!code){ msg.textContent='Ingres√° un c√≥digo de cup√≥n.'; msg.classList.add('cupon-err'); renderResumen(); return; }
      try{
        const docRef = db.collection('coupons').doc(code);
        const snap = await docRef.get();
        if(!snap.exists){
          const q = await db.collection('coupons').where('codigo','==',code).limit(1).get();
          if(q.empty){ msg.textContent='Cup√≥n inv√°lido.'; msg.classList.add('cupon-err'); renderResumen(); return; }
          var d = q.docs[0].data(); var id = q.docs[0].id;
          if(d.active===false || d.activo===false){ msg.textContent='Cup√≥n inactivo.'; msg.classList.add('cupon-err'); renderResumen(); return; }
          if(d.expiresAt||d.expireAt){ var exp = d.expiresAt||d.expireAt; var expDate = exp.toDate ? exp.toDate() : new Date(exp); if(Date.now()>expDate.getTime()){ msg.textContent='Cup√≥n vencido.'; msg.classList.add('cupon-err'); renderResumen(); return; } }
          var discount = Number(d.discount||d.descuento||0)||0;
          appliedCoupon = { id:id, codigo:d.codigo||code, descuento:discount, raw:d }; appliedDiscount = discount; msg.textContent='Cup√≥n aplicado: '+appliedDiscount+'%'; msg.classList.add('cupon-ok'); renderResumen(); return;
        } else {
          var d2 = snap.data();
          if(d2.active===false || d2.activo===false){ msg.textContent='Cup√≥n inactivo.'; msg.classList.add('cupon-err'); renderResumen(); return; }
          if(d2.expiresAt||d2.expireAt){ var exp = d2.expiresAt||d2.expireAt; var expDate = exp.toDate ? exp.toDate() : new Date(exp); if(Date.now()>expDate.getTime()){ msg.textContent='Cup√≥n vencido.'; msg.classList.add('cupon-err'); renderResumen(); return; } }
          var discount2 = Number(d2.discount||d2.descuento||0)||0;
          appliedCoupon = { id:snap.id, codigo:d2.codigo||code, descuento:discount2, raw:d2 }; appliedDiscount = discount2; msg.textContent='Cup√≥n aplicado: '+appliedDiscount+'%'; msg.classList.add('cupon-ok'); renderResumen(); return;
        }
      }catch(e){ console.error(e); msg.textContent='Error al validar el cup√≥n.'; msg.classList.add('cupon-err'); renderResumen(); }
    }
    document.getElementById('btnAplicarCupon').addEventListener('click', applyCouponCode);

    /* === PAYMENT HINT === */
    function updatePaymentHint(){ var hint = document.getElementById('paymentHint'); var pago = (document.querySelector('input[name="pago"]:checked')||{}).value||''; if(pago==='mercado_pago') hint.textContent='Enviar comprobante por WhatsApp (alias: rhodesburgers)'; else if(pago==='efectivo') hint.textContent='Lo pag√°s cuando retiras'; else hint.textContent=''; }
    document.querySelectorAll('input[name="pago"]').forEach(r=>r.addEventListener('change', updatePaymentHint));
    updatePaymentHint();

    /* === SLOTS: generaci√≥n y UI === */

    // parse "HH:mm" -> {h,m}
    function parseHHMM(s){ if(!s) return null; var p=s.split(':'); if(p.length<2) return null; return {h:parseInt(p[0],10), m:parseInt(p[1],10)}; }
    // format slot key YYYYMMDD_HHMM
    function pad(n){ return String(n).padStart(2,'0'); }
    function slotKeyFromDate(d){ return ''+d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+'_'+pad(d.getHours())+pad(d.getMinutes()); }
    function slotPretty(d){ return d.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false}); }

    // generate base 15-min slots for today
    function genBaseSlotsForToday(openHHMM, closeHHMM, interval){
      var today = new Date();
      var base = new Date(today.getFullYear(), today.getMonth(), today.getDate(), openHHMM.h, openHHMM.m, 0,0);
      var end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), closeHHMM.h, closeHHMM.m, 0,0);
      var slots=[];
      if(end.getTime() <= base.getTime()) return slots;
      var cur = new Date(base.getTime());
      while(cur.getTime() <= end.getTime() - interval*60*1000){
        slots.push(new Date(cur.getTime()));
        cur = new Date(cur.getTime() + interval*60*1000);
      }
      return slots;
    }

    // generate extra slots from a start time every step minutes until close
    function genExtraSlotsFrom(startHHMM, step, closeHHMM){
      var today = new Date();
      var start = new Date(today.getFullYear(), today.getMonth(), today.getDate(), startHHMM.h, startHHMM.m,0,0);
      var end = new Date(today.getFullYear(), today.getMonth(), today.getDate(), closeHHMM.h, closeHHMM.m,0,0);
      var slots=[];
      if(end.getTime() <= start.getTime()) return slots;
      var cur = new Date(start.getTime());
      while(cur.getTime() <= end.getTime() - 1){ // include last start <= end-1ms
        slots.push(new Date(cur.getTime()));
        cur = new Date(cur.getTime() + step*60*1000);
      }
      return slots;
    }

    // fetch uses for many slot keys (returns map key->uses)
    async function fetchUsesFor(slotKeys){
      const out = {};
      await Promise.all(slotKeys.map(async k=>{
        try{
          const s = await db.collection('slots').doc(k).get();
          out[k] = s.exists ? (Number(s.data().uses)||0) : 0;
        }catch(e){ out[k] = 0; }
      }));
      return out;
    }

    // load config from Firestore (optional)
    async function loadSlotsConfig(){
      try{
        const snap = await db.collection('config').doc('slots').get();
        if(snap.exists){
          const d = snap.data();
          SLOTS_CONFIG.openTime = d.openTime || SLOTS_CONFIG.openTime;
          SLOTS_CONFIG.closeTime = d.closeTime || SLOTS_CONFIG.closeTime;
          SLOTS_CONFIG.baseInterval = Number(d.baseInterval) || SLOTS_CONFIG.baseInterval;
          SLOTS_CONFIG.capacity = Number(d.capacity) || SLOTS_CONFIG.capacity;
        }
      }catch(e){
        console.warn('loadSlotsConfig failed', e);
      }
    }

    // main function to compute union of slots and populate select
    async function refreshSlotsUI(){
      document.getElementById('slotNote').textContent = 'Cargando turnos...';
      document.getElementById('slotTime').innerHTML = '';
      await loadSlotsConfig();
      const open = parseHHMM(SLOTS_CONFIG.openTime);
      const close = parseHHMM(SLOTS_CONFIG.closeTime);
      const baseInterval = Number(SLOTS_CONFIG.baseInterval) || 15;
      const capacity = Number(SLOTS_CONFIG.capacity) || 4;

      if(!open || !close){ document.getElementById('slotNote').textContent = 'Horario de apertura/cierre mal configurado.'; return; }

      // base slots (cada 15m)
      const baseSlots = genBaseSlotsForToday(open, close, baseInterval);

      // extras seg√∫n cantidad de hamburguesas
      const burgers = totalBurgersInCart();
      let extraSlots = [];
      if(burgers <= 2){
        // cada 10 minutos desde 19:10
        const start = parseHHMM('19:10');
        if(start) extraSlots = genExtraSlotsFrom(start, 10, close);
      } else {
        // mas de 2 hamburguesas: cada 20m desde 19:20
        const start = parseHHMM('19:20');
        if(start) extraSlots = genExtraSlotsFrom(start, 20, close);
      }

      // union de slots (usamos key) -> Date
      const map = new Map();
      baseSlots.forEach(d=> map.set(slotKeyFromDate(d), d));
      extraSlots.forEach(d=> map.set(slotKeyFromDate(d), d)); // si ya exist√≠a no duplica

      // ordenar por hora
      const entries = Array.from(map.entries()).sort((a,b)=> a[1].getTime() - b[1].getTime());

      // fetch uses
      const keys = entries.map(e=>e[0]);
      const usesMap = await fetchUsesFor(keys);

      // populate select with info: text = HH:MM (remaining e.g. 2/4) and disable if uses>=capacity or time < now+5min
      const sel = document.getElementById('slotTime');
      const now = new Date();
      entries.forEach(([k,d])=>{
        const uses = usesMap[k] || 0;
        const remaining = Math.max(0, capacity - uses);
        const opt = document.createElement('option');
        opt.value = k;
        opt.dataset.pretty = slotPretty(d);
        opt.dataset.timeIso = d.toISOString();
        // show remaining and if it's an "extra" slot (10/20) mark with star
        const isExtra = !baseSlots.find(b=> b.getTime() === d.getTime());
        opt.textContent = slotPretty(d) + ' ‚Äî ' + remaining + '/' + capacity + (isExtra? ' (slot especial)':'');
        if(uses >= capacity) { opt.disabled = true; opt.className='slot-full'; }
        else opt.className='slot-ok';

        // also block if slot time is in the past or less than 5 minutes away
        if(d.getTime() <= now.getTime() + (5*60*1000)){ opt.disabled = true; opt.textContent += ' ‚Äî no disponible'; }

        sel.appendChild(opt);
      });

      // auto-select first available
      const first = sel.querySelector('option:not([disabled])');
      if(first) sel.value = first.value;
      else if(sel.options.length === 0) sel.appendChild(new Option('No hay turnos disponibles', ''));
      // note text
      document.getElementById('slotNote').textContent = 'Capacidad por horario: ' + capacity + ' pedidos. Los slots especiales (si aplica) se muestran marcados.';
      renderResumen();
    }

    document.getElementById('btnRefreshSlots').addEventListener('click', function(){ refreshSlotsUI(); });

    /* === RESERVA + CREACION ORDEN (transacci√≥n segura) === */

    // helper para obtener siguiente orderNumber en transacci√≥n y crear orden
    function countersRef(){ return db.collection('config').doc('counters'); }

    function buildOrderObject(orderNumber, slotKey, slotIso){
      var items=[],k;
      for(k in cart.burger){
        var b = cart.burger[k];
        items.push({
          id: b.item?b.item.id:'',
          name: b.item?b.item.name:'',
          qty: b.qty||0,
          price: b.item?(b.item.price||0):0,
          fries: b.fries || '',
          notes: b.notes || '',
          extras: { patty: b.extras?.patty||0, cheddar: b.extras?.cheddar||0, EXTRA_PRICE_PATTY: b.extras?.EXTRA_PRICE_PATTY||EXTRA_PRICE_PATTY, EXTRA_PRICE_CHEDDAR: b.extras?.EXTRA_PRICE_CHEDDAR||EXTRA_PRICE_CHEDDAR }
        });
      }
      for(k in cart.drink){
        var d = cart.drink[k];
        items.push({ id: d.item?d.item.id:'', name:d.item?d.item.name:'', qty:d.qty||0, price:d.item?(d.item.price||0):0, fries:'', notes:'', extras:{} });
      }
      var pago = (document.querySelector('input[name="pago"]:checked')||{}).value||'';
      var rawTotal = calcRawTotal();
      var totalWithDiscount = calcTotalWithDiscount();
      var order = {
        orderNumber: orderNumber,
        number: orderNumber,
        nombre: (document.getElementById('inpNombre').value||'').trim(),
        telefono: (document.getElementById('inpTelefono').value||'').trim(),
        entrega: 'take_away',
        pago: pago,
        notes: (document.getElementById('inpNotas').value||'').trim(),
        pickup_slot: slotKey || null,
        pickup_time: slotIso || null,
        status: (pago==='mercado_pago' ? 'pending_payment' : 'accepted'),
        payment_status: (pago==='mercado_pago' ? 'pending_payment' : 'paid'),
        items: items,
        total: totalWithDiscount,
        rawTotal: rawTotal,
        source: 'web',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      if(appliedCoupon){ order.cupon = appliedCoupon.codigo; order.discount = appliedDiscount; order.cuponId = appliedCoupon.id; }
      return order;
    }

    async function createOrder(){
      // basic validations
      if(Object.keys(cart.burger||{}).length === 0 && Object.keys(cart.drink||{}).length === 0){ alert('Tu carrito est√° vac√≠o.'); return null; }
      var nombre = (document.getElementById('inpNombre').value||'').trim();
      if(!nombre){ alert('Ingres√° tu nombre.'); return null; }
      var pago = (document.querySelector('input[name="pago"]:checked')||{}).value||'';
      if(!pago){ alert('Eleg√≠ un medio de pago.'); return null; }

      var slotSel = document.getElementById('slotTime');
      if(!slotSel || !slotSel.value){ alert('Eleg√≠ un horario de retiro.'); return null; }
      var slotKey = slotSel.value;
      var slotIso = slotSel.selectedOptions[0].dataset.timeIso || null;

      // reload config and capacity
      await loadSlotsConfig();
      var capacity = Number(SLOTS_CONFIG.capacity)||4;

      // transaction
      try{
        var trackToken = (function(len=22){ var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789", s=''; for(var i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; })();
        const res = await db.runTransaction(async tx=>{
          const slotRef = db.collection('slots').doc(slotKey);
          const slotSnap = await tx.get(slotRef);
          const cur = slotSnap.exists ? (Number(slotSnap.data().uses)||0) : 0;
          if(cur >= capacity) throw new Error('SLOT_FULL');

          // increment slot
          tx.set(slotRef, { uses: cur + 1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

          // bump counter
          const cntRef = countersRef();
          const cntSnap = await tx.get(cntRef);
          const curCnt = cntSnap.exists ? (Number(cntSnap.data().orderNumber)||0) : 0;
          const next = curCnt + 1;
          tx.set(cntRef, { orderNumber: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

          // create order
          const orderRef = db.collection('orders').doc();
          const orderObj = buildOrderObject(next, slotKey, slotIso);
          orderObj.trackToken = trackToken;
          tx.set(orderRef, orderObj);

          // order_public
          const pubRef = db.collection('order_public').doc(trackToken);
          tx.set(pubRef, {
            orderId: orderRef.id,
            orderNumber: next,
            status: orderObj.status === 'pending_payment' ? 'pending_payment' : 'accepted',
            entrega: orderObj.entrega || 'take_away',
            pago: orderObj.pago || '',
            nombre: (orderObj.nombre||'Cliente').split(' ')[0],
            total: orderObj.total || calcTotalWithDiscount(),
            pickup_time: orderObj.pickup_time || null,
            pickup_slot: orderObj.pickup_slot || null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          return { orderId: orderRef.id, orderNumber: next, trackToken: trackToken };
        }); // tx end
        return res;
      }catch(e){
        if(e && e.message === 'SLOT_FULL'){
          alert('El turno seleccionado se llen√≥ en este momento. Eleg√≠ otro turno.');
          await refreshSlotsUI();
          return null;
        }
        console.error('createOrder tx failed', e);
        alert('Error al confirmar el pedido. Reintent√°.');
        return null;
      }
    }

    /* === WHATSAPP + FLOW final === */
    function buildWhatsappText(order){
      var lines=[];
      var pagoLabel = (order.pago==='efectivo'?'Efectivo': (order.pago==='mercado_pago' ? 'Transferencia' : order.pago));
      lines.push('Hola! Quiero confirmar el pedido #' + order.orderNumber);
      lines.push('Nombre: ' + order.nombre + (order.telefono ? (' ‚Äî Tel: '+order.telefono) : ''));
      lines.push('Retiro: Take Away');
      if(order.pickup_time){
        try{ lines.push('Horario de retiro: ' + (new Date(order.pickup_time)).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false})); }catch(e){}
      }
      lines.push('Medio de pago: ' + pagoLabel);
      if(order.cupon){ lines.push('Cup√≥n: '+order.cupon+' ‚Äî '+(order.discount||0)+'% off'); }
      lines.push('------------------------------');
      for(var i=0;i<order.items.length;i++){
        var it = order.items[i];
        if(it.name){
          if(it.extras && (it.extras.patty || it.extras.cheddar)){
            var extras = [];
            if(it.extras.patty) extras.push('+'+it.extras.patty+' med');
            if(it.extras.cheddar) extras.push('+'+it.extras.cheddar+' ched');
            lines.push((it.qty||0) + '√ó ' + it.name + ' (' + (it.fries || '‚Äî') + (extras.length ? ' ¬∑ ' + extras.join(' ¬∑ ') : '') + ')');
          } else {
            lines.push((it.qty||0) + '√ó ' + it.name + (it.fries ? (' (Papas: '+it.fries+')') : ''));
          }
          if(it.notes) lines.push('  Notas: '+it.notes);
        }
      }
      lines.push('------------------------------');
      lines.push('Total: ' + (Number(order.total)||0).toLocaleString('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}));
      if(order.notes) lines.push('Notas del pedido: '+order.notes);
      if(order.trackToken){
        var base = location.origin;
        lines.push('Seguimiento: ' + base + '/gracias.html?id='+encodeURIComponent(order.id||'')+'&t='+encodeURIComponent(order.trackToken));
      }
      return encodeURIComponent(lines.join('\n'));
    }

    function openWhatsApp(order){
      var PHONE_NUMBER = '5491170596483';
      var txt = buildWhatsappText(order);
      var url = 'https://wa.me/' + PHONE_NUMBER + '?text=' + txt;
      window.open(url, '_blank');
    }

    // confirm button handler
    document.getElementById('btnConfirmar').addEventListener('click', async function(){
      var btn = this;
      if(btn.disabled) return;
      btn.disabled = true; btn.classList.add('disabled');

      try{
        // attempt create order (transaction reserves slot)
        const res = await createOrder();
        btn.disabled = false; btn.classList.remove('disabled');
        if(!res) return;
        localStorage.setItem('last_order_id', res.orderId);
        // read order and open whatsapp if needed
        try{
          const doc = await db.collection('orders').doc(res.orderId).get();
          var order = { id: res.orderId };
          if(doc.exists) Object.assign(order, doc.data());
          order.trackToken = order.trackToken || res.trackToken;
          if(order.pago==='efectivo' || order.pago==='mercado_pago') openWhatsApp(order);
          // clear cart & redirect
          try{ localStorage.setItem(CART_KEY, JSON.stringify({burger:{},drink:{}})); }catch(_){}
          window.location.href = 'gracias.html?id=' + encodeURIComponent(res.orderId) + '&t=' + encodeURIComponent(res.trackToken);
        }catch(e){
          console.warn('could not read created order', e);
          try{ localStorage.setItem(CART_KEY, JSON.stringify({burger:{},drink:{}})); }catch(_){}
          window.location.href = 'gracias.html?id=' + encodeURIComponent(res.orderId) + '&t=' + encodeURIComponent(res.trackToken);
        }
      }catch(e){
        console.error(e);
        btn.disabled = false; btn.classList.remove('disabled');
        alert('Ocurri√≥ un error al confirmar el pedido. Prob√° nuevamente.');
      }
    });

    /* === refresh slots cuando cambie el carrito (para recalcular si <=2 o >2 hamburguesas) === */
    window.addEventListener('storage', function(e){
      if(e.key === CART_KEY || e.key === null){
        cart = loadCart();
        refreshSlotsUI().catch(()=>{});
        renderResumen();
      }
    });

    // init
    (function init(){
      // ensure cart loaded
      cart = loadCart();
      refreshSlotsUI().catch(err=>{ console.warn(err); document.getElementById('slotNote').textContent = 'No se pudieron cargar turnos.'; });
      renderResumen();
      // update resumen when user changes selects
      document.getElementById('slotTime').addEventListener('change', renderResumen);
      document.getElementById('btnRefreshSlots').addEventListener('click', refreshSlotsUI);
    })();

  </script>
</body>
</html>
