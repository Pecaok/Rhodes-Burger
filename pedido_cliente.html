<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --bg:#f5f6f7;
      --card:#fff;
      --text:#1e1e1e;
      --muted:#80848a;
      --brand:#22c55e;
      --brand-600:#18a64d;
      --line:#e9ecef;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:18px;
      --radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}

    /* ---------- Marca de agua (fondo) ---------- */
    .wm{
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .wm::before{
      content:"";
      position:absolute;
      inset:0;
      /* degrad√© suave para oscurecer apenas el fondo de la UI */
      background: radial-gradient(ellipse at center,
                  rgba(0,0,0,.05) 0%,
                  rgba(0,0,0,.12) 100%);
    }
    .wm img{
      /* tama√±o controlado y sin ‚Äúzoom‚Äù de cover */
      width:85vmin;     /* pod√©s subir/bajar para ajustar */
      height:auto;
      object-fit:contain;

      /* m√°s oscuro y con contraste para que se note mejor */
      filter:grayscale(100%) brightness(0.40) contrast(160%);
      opacity:.30;      /* sub√≠ a .35 si quer√©s que se note m√°s */
    }
    @media (max-width:640px){
      .wm img{ width:105vmin; opacity:.32; }
    }

    /* ---------- Header ---------- */
    header{
      position:sticky; top:0; z-index:5;
      background:rgba(255,255,255,.85);
      backdrop-filter:saturate(180%) blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{ max-width:1200px; margin:0 auto; padding:10px 16px; display:flex; align-items:center; gap:12px }
    .brand{ display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit }
    .brand img{ width:36px; height:36px; border-radius:10px; background:#fff; object-fit:contain; display:block }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--line); padding:10px 16px; border-radius:999px; color:#333; background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.ghost{ border-color:var(--line) }
    .btn.primary{ border-color:var(--brand); background:var(--brand); color:#fff }
    .btn.primary:hover{ background:var(--brand-600); border-color:var(--brand-600) }

    /* ---------- Layout ---------- */
    main{ position:relative; z-index:1 }
    .container{ max-width:1200px; margin:18px auto 64px; padding:0 16px }
    h1{ font-size:34px; margin:18px 6px 20px }
    .grid-2{ display:grid; grid-template-columns: 1.08fr .92fr; gap:20px }
    @media (max-width:900px){ .grid-2{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:0; overflow:hidden; display:flex; flex-direction:column }
    .pad{ padding:18px 18px 12px 18px }

    /* ---------- Form ---------- */
    .field{ display:flex; flex-direction:column; gap:8px; margin-bottom:12px }
    .field label{ font-weight:700 }
    input[type="text"], textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px 14px;
      font-size:16px;
      outline:none;
      background:#fff;
    }
    input[type="text"]:focus, textarea:focus{ border-color:#cfd5db; box-shadow:0 0 0 4px rgba(34,197,94,.08) }
    textarea{ min-height:110px; resize:vertical }

    .inline{ display:flex; flex-wrap:wrap; gap:12px; margin-top:6px }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      border:2px solid var(--line);
      border-radius:999px; padding:12px 16px; background:#fff; cursor:pointer;
      user-select:none;
    }
    .pill input{ margin:0 4px 0 0 }
    .pill .ico{ width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center }
    .pill.active{ border-color:var(--brand); box-shadow:0 0 0 6px rgba(34,197,94,.08) }

    .muted{ color:var(--muted); font-size:14px }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px }

    /* ---------- Summary ---------- */
    .summary .row{ display:flex; align-items:center; justify-content:space-between; padding:12px 18px; border-bottom:1px solid var(--line) }
    .summary .title{ font-weight:800 }
    .summary .item{ padding:16px 18px; border-bottom:1px solid var(--line) }
    .summary .item h4{ margin:0 0 6px; font-size:16px }
    .summary .tiny{ color:var(--muted); font-size:13px; }
    .summary .total{ display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; padding:18px }

    /* Buttons row bottom on mobile */
    .sticky-actions{ display:none; }
    @media (max-width:900px){
      .sticky-actions{
        display:flex; position:sticky; bottom:0; z-index:3; background:rgba(255,255,255,.9);
        backdrop-filter:saturate(180%) blur(8px); border-top:1px solid var(--line); padding:10px 14px; gap:10px; justify-content:flex-end;
      }
    }
  </style>
</head>
<body>

  <!-- Marca de agua / fondo -->
  <div class="wm"><img src="images/logo.png" alt=""></div>

  <header>
    <div class="topbar">
      <a class="brand" href="index.html" aria-label="Inicio">
        <img src="images/logo.png" alt="Rhodes Burgers" />
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Confirmar pedido</h1>

      <div class="grid-2">
        <!-- Columna izquierda: formulario -->
        <section class="card">
          <div class="pad">
            <div class="field">
              <label>Nombre y apellido</label>
              <input id="inpNombre" type="text" placeholder="Ej: Juan P√©rez" autocomplete="name" />
            </div>

            <div class="field">
              <label>Tel√©fono (opcional)</label>
              <input id="inpTel" type="text" placeholder="Ej: 11 2345 6789" inputmode="tel" />
            </div>

            <div class="field">
              <label>Medio de pago</label>
              <div class="inline" id="grpPago">
                <label class="pill"><input type="radio" name="pago" value="mercado_pago" /> <span class="ico">üí≥</span> Mercado Pago</label>
                <label class="pill"><input type="radio" name="pago" value="efectivo" /> <span class="ico">üíµ</span> Efectivo</label>
              </div>
            </div>

            <div class="field">
              <label>Tipo de entrega</label>
              <div class="inline" id="grpEntrega">
                <!-- S√≥lo Take Away (Delivery deshabilitado por pedido tuyo) -->
                <label class="pill"><input type="radio" name="entrega" value="take_away" /> <span class="ico">üß∫</span> Take Away</label>
              </div>
              <div class="muted" style="margin-top:6px">* Solo retiro por el local.</div>
            </div>

            <div class="field">
              <label>Notas (opcional)</label>
              <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
            </div>

            <div class="actions">
              <a class="btn ghost" href="index.html">Cancelar</a>
              <button id="btnConfirmar" class="btn primary">Ir a pagar</button>
            </div>
          </div>
        </section>

        <!-- Columna derecha: resumen -->
        <aside class="card summary">
          <div class="row"><div class="title">Resumen</div><div></div></div>
          <div id="itemsBox"></div>
          <div class="total"><span>Total</span><span id="totalBox">$ 0</span></div>
        </aside>
      </div>
    </div>

    <!-- Acciones sticky en mobile -->
    <div class="sticky-actions">
      <a class="btn ghost" href="index.html">Cancelar</a>
      <button id="btnConfirmarMb" class="btn primary">Ir a pagar</button>
    </div>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Tu config original (sin tocar)
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    // ============ util =============
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const CART_KEY = "rhodes_cart_v3";

    function loadCart(){
      try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{},fries:null}; }
      catch{ return {burger:{},drink:{},fries:null}; }
    }
    function calcTotal(c){
      let t=0;
      // hamburguesas
      for(const o of Object.values(c.burger||{})){
        const base=(Number(o.item?.price)||0);
        const patties=(o.extras?.patty||0);
        const cheddar=(o.extras?.cheddar||0);
        // En index pod√©s estar sumando extras a price; si no, hacelo ac√°:
        const EXTRA_PRICE_PATTY = o.extras?.EXTRA_PRICE_PATTY || 0;
        const EXTRA_PRICE_CHEDDAR = o.extras?.EXTRA_PRICE_CHEDDAR || 0;
        const extraCost = patties*EXTRA_PRICE_PATTY + cheddar*EXTRA_PRICE_CHEDDAR;
        t += (base + extraCost) * (o.qty||1);
      }
      // bebidas
      for(const o of Object.values(c.drink||{})){
        t += (Number(o.item?.price)||0) * (o.qty||1);
      }
      return t;
    }

    // ============ render resumen =============
    let cart = loadCart();
    const itemsBox = $("#itemsBox");
    const totalBox = $("#totalBox");

    function friesLabel(obj){
      // Prioridad: por-item -> cart.fries -> "Sin sazonar"
      const f = obj?.fries || cart.fries || "sin_sazon";
      return (f==="con_sazon") ? "Con saz√≥n" : "Sin sazonar";
    }

    function renderResumen(){
      itemsBox.innerHTML = "";

      // Burgers
      for(const o of Object.values(cart.burger||{})){
        const qty = o.qty||1;
        const name = o.item?.name || "Hamburguesa";
        const price = Number(o.item?.price)||0;

        // texto extras (si existieran)
        const ext = [];
        if(o.extras?.patty){ ext.push(`+${o.extras.patty} medall√≥n(es)`) }
        if(o.extras?.cheddar){ ext.push(`+${o.extras.cheddar} cheddar`) }

        const unit = price +
          ( (o.extras?.patty||0)*(o.extras?.EXTRA_PRICE_PATTY||0) ) +
          ( (o.extras?.cheddar||0)*(o.extras?.EXTRA_PRICE_CHEDDAR||0) );

        itemsBox.innerHTML += `
          <div class="item">
            <h4>${name}</h4>
            <div class="tiny">Papas: ${friesLabel(o)}</div>
            ${ext.length ? `<div class="tiny">${ext.join(" ¬∑ ")}</div>` : ""}
            <div class="tiny">${money(unit)} x ${qty}</div>
          </div>`;
      }

      // Drinks
      for(const o of Object.values(cart.drink||{})){
        const qty = o.qty||1;
        const name = o.item?.name || "Bebida";
        const price = Number(o.item?.price)||0;
        itemsBox.innerHTML += `
          <div class="item">
            <h4>${name}</h4>
            <div class="tiny">${money(price)} x ${qty}</div>
          </div>`;
      }

      totalBox.textContent = money(calcTotal(cart));
    }
    renderResumen();

    // ============ selecci√≥n de radios (estilo ‚Äúpill‚Äù activo) ============
    function wireGroup(groupEl){
      groupEl.addEventListener("change", ()=>{
        groupEl.querySelectorAll(".pill").forEach(p=>p.classList.remove("active"));
        const sel = groupEl.querySelector("input:checked");
        if(sel) sel.closest(".pill").classList.add("active");
      });
    }
    wireGroup($("#grpPago"));
    wireGroup($("#grpEntrega"));

    // ============ Confirmar ============
    async function onConfirmar(){
      const nombre = $("#inpNombre").value.trim();
      const tel = $("#inpTel").value.trim();
      const pagoEl = document.querySelector('input[name="pago"]:checked');
      const entregaEl = document.querySelector('input[name="entrega"]:checked');
      const notas = $("#inpNotas").value.trim();

      if(!nombre){ alert("Ingres√° tu nombre y apellido."); return; }
      if(!pagoEl){ alert("Eleg√≠ un medio de pago."); return; }
      if(!entregaEl){ alert("Eleg√≠ el tipo de entrega."); return; }

      // Items para Firestore y MP
      const itemsFS = [];
      const mpItems = [];
      for(const o of Object.values(cart.burger||{})){
        const base = Number(o.item?.price)||0;
        const patties=(o.extras?.patty||0);
        const cheddar=(o.extras?.cheddar||0);
        const Pp=(o.extras?.EXTRA_PRICE_PATTY||0);
        const Pc=(o.extras?.EXTRA_PRICE_CHEDDAR||0);
        const extraCost = patties*Pp + cheddar*Pc;
        const unit = base + extraCost;

        itemsFS.push({
          type:"burger",
          id:o.item?.id||"",
          name:o.item?.name||"Hamburguesa",
          qty:o.qty||1,
          price: base,
          extras:{patty:patties, cheddar:cheddar, EXTRA_PRICE_PATTY:Pp, EXTRA_PRICE_CHEDDAR:Pc},
          fries: friesLabel(o),
          ...(o.notes?{notes:o.notes}:{})
        });
        mpItems.push({
          title:o.item?.name||"Hamburguesa",
          quantity: Number(o.qty||1),
          currency_id:"ARS",
          unit_price: Number(unit)
        });
      }
      for(const o of Object.values(cart.drink||{})){
        itemsFS.push({type:"drink", id:o.item?.id||"", name:o.item?.name||"Bebida", qty:o.qty||1, price:Number(o.item?.price)||0});
        mpItems.push({
          title:o.item?.name||"Bebida",
          quantity: Number(o.qty||1),
          currency_id:"ARS",
          unit_price: Number(o.item?.price)||0
        });
      }

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nombre,
        telefono: tel || null,
        pago: pagoEl.value,               // "mercado_pago" | "efectivo"
        entrega: entregaEl.value,         // "take_away"
        items: itemsFS,
        total: calcTotal(cart),
        status: "accepted",
        notas: notas || null
      };

      const btns = [$("#btnConfirmar"), $("#btnConfirmarMb")];
      btns.forEach(b=>b && (b.disabled=true));

      try{
        // Guardamos en Firestore
        const docRef = await db.collection("orders").add(order);

        if (order.pago === "mercado_pago"){
          // Preferencia de MP v√≠a Netlify Function
          const payload = {
            orderId: docRef.id,
            total: Number(order.total)||0,
            nombre: order.nombre,
            items: mpItems.length ? mpItems : [{title:"Pedido Rhodes Burgers", quantity:1, currency_id:"ARS", unit_price:Number(order.total)||0}]
          };

          const resp = await fetch("/.netlify/functions/createPreference", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          const raw = await resp.text();
          let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }

          if(!resp.ok){
            console.error("MP error", resp.status, data);
            alert(`No se pudo crear el pago (MP ${resp.status}).`);
            btns.forEach(b=>b && (b.disabled=false));
            return;
          }

          const url = data.init_point || data.sandbox_init_point;
          if(!url){ alert("Preferencia creada sin URL. Revis√° el Access Token en Netlify."); btns.forEach(b=>b && (b.disabled=false)); return; }

          // listo ‚Üí limpio y redirijo
          localStorage.removeItem(CART_KEY);
          window.location.href = url;
          return;
        }

        // Efectivo
        localStorage.removeItem(CART_KEY);
        alert("¬°Pedido enviado! ‚úÖ");
        window.location.href = "index.html";
      }catch(err){
        console.error(err);
        alert("No pudimos guardar el pedido o iniciar el pago.");
        btns.forEach(b=>b && (b.disabled=false));
      }
    }

    $("#btnConfirmar").addEventListener("click", onConfirmar);
    $("#btnConfirmarMb").addEventListener("click", onConfirmar);
  </script>
</body>
</html>
