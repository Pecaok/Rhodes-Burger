<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{--primary:#625A45;--text:#111;--muted:#666;--bg:#f6f6f6;--card:#fff;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.08);--ring:#eaeaea}
    *{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .btn.disabled, .btn[disabled]{ opacity:.6; pointer-events:none; }
    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h1{font-size:32px;margin:10px 0 18px}
    label{font-weight:600;margin:6px 0;display:block}
    input[type="text"]{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    .group{margin:14px 0}
    .chips{display:flex;gap:12px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:999px;padding:10px 14px}
    .chip input{accent-color:var(--primary)}
    .muted{color:var(--muted)}
    .muted-small{color:var(--muted); font-size:13px; margin-top:6px;}
    .pay-hint{font-size:13px;color:var(--muted);margin-top:6px}
    .chip-col{display:flex;flex-direction:column;align-items:flex-start;gap:6px}
    .right .row{display:flex;align-items:center;justify-content:space-between;margin:10px 0}
    .total{font-weight:800;font-size:18px}
    textarea{width:100%;min-height:90px;border:1px solid var(--ring);border-radius:12px;padding:10px}
    .actions{display:flex;gap:10px;margin-top:12px}.actions .btn{flex:1}
    .statusHint{font-size:13px;color:var(--muted);margin-top:10px}
    html,body{min-height:100%} body{position:relative}
    body::before{content:"";position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:clamp(240px,48vmin,560px);background:url("images/logo.png") center/contain no-repeat;opacity:.08;pointer-events:none;z-index:5}
    .cupon-ok{color:green;font-weight:700}
    .cupon-err{color:#b00020;font-weight:700}
    .payment-hint-box{margin-top:8px;font-weight:700;color:var(--primary)}
    /* slots UI */
    .slots-row{display:flex;gap:8px;align-items:center}
    .slot-select{padding:10px;border-radius:12px;border:1px solid var(--ring);background:#fff}
    .slot-full{color:#b00020;font-weight:800}
    .slot-ok{color:var(--primary);font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>Confirmar pedido</h1>

      <div class="group">
        <label>Nombre y apellido</label>
        <input id="inpNombre" type="text" placeholder="Ej: Juan P√©rez">
      </div>

      <div class="group">
        <label>Tel√©fono (opcional)</label>
        <input id="inpTelefono" type="text" placeholder="Ej: 11 2345 6789">
      </div>

      <div class="group">
        <label>Medio de pago</label>
        <div class="chips">
          <div class="chip-col">
            <label class="chip"><input id="payTransfer" type="radio" name="pago" value="mercado_pago"> Transferencia</label>
            <div class="muted-small"></div>
          </div>
          <div class="chip-col">
            <label class="chip"><input id="payLocal" type="radio" name="pago" value="efectivo"> En Local</label>
            <div class="muted-small"></div>
          </div>
        </div>
        <div id="paymentHint" class="payment-hint-box" aria-live="polite"></div>
      </div>

      <div class="group">
        <label>Tipo de entrega</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="entrega" value="take_away" checked> Take Away</label>
        </div>
        <div class="muted" style="margin-top:6px">* Solo retiro por el local.</div>
      </div>

      <!-- NUEVO: Selector de slots (fecha+hora con intervalos) -->
      <div class="group">
        <label>Horario de retiro</label>
        <div class="slots-row" id="slotsUI">
          <!-- Se llenar√° din√°micamente: select de d√≠as y select de turnos -->
          <select id="slotDay" class="slot-select"></select>
          <select id="slotTime" class="slot-select"></select>
          <button id="btnRefreshSlots" class="btn ghost" title="Actualizar turnos">üîÅ</button>
        </div>
        <div id="slotNote" class="muted-small">Cargando turnos disponibles...</div>
      </div>

      <!-- CUP√ìN -->
      <div class="group">
        <label>¬øTen√©s un cup√≥n de descuento?</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="inpCupon" type="text" placeholder="C√≥digo del cup√≥n" style="flex:1">
          <button id="btnAplicarCupon" class="btn ghost">Aplicar</button>
        </div>
        <div id="cuponMsg" class="muted-small" style="margin-top:8px"></div>
      </div>

      <div class="group">
        <label>Notas (opcional)</label>
        <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        <div class="muted-small"></div>
      </div>

      <div class="actions">
        <a class="btn ghost" href="index.html">Cancelar</a>
        <button class="btn primary" id="btnConfirmar">Confirmar Pedido</button>
      </div>

      <div class="statusHint">Te redirigimos a WhatsApp con el detalle y un link para seguir el estado.</div>
    </section>

    <aside class="card right">
      <h3>Resumen</h3>
      <div id="resumen"></div>
      <div class="row total">
        <div>Total</div><div id="resTotal">$ 0</div>
      </div>
    </aside>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* === FIREBASE === */
    var firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebaseapp.com",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var db = firebase.firestore();

    /* === ESTADO CUP√ìN === */
    var appliedCoupon = null; // objeto cup√≥n le√≠do desde Firestore (o null)
    var appliedDiscount = 0;  // porcentaje (ej 10)

    /* === CONFIG SLOTS (cargado desde Firestore) ===
       doc: config/slots
       {
         openTime: "12:00",
         closeTime: "23:00",
         interval: 15,
         daysAhead: 7,
         capacity: 6
       }
    */
    var SLOTS_CONFIG = { openTime: "12:00", closeTime: "23:00", interval:15, daysAhead:7, capacity:6 };

    /* === CONTADOR UNIFICADO === (usado en la transacci√≥n principal) */
    function countersRef(){ return db.collection('config').doc('counters'); }

    /* === UTIL & ESTADO === */
    var CART_KEY="rhodes_cart_v3";
    function $(s){return document.querySelector(s)}
    function money(n){return (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0})}
    function genTrackToken(len=22){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s="";for(var i=0;i<len;i++)s+=c[Math.floor(Math.random()*c.length)];return s;}
    function loadCart(){try{return JSON.parse(localStorage.getItem(CART_KEY))||{burger:{},drink:{}}}catch(e){return {burger:{},drink:{}}}}
    var cart=loadCart();

    /* === (mantengo tus funciones de precio y resumen) === */
    const EXTRA_PRICE_PATTY = 2400, EXTRA_PRICE_CHEDDAR = 300;
    function unitWithExtras(it){
      var base=(it.item&&it.item.price)?it.item.price:(it.price||0);
      var pz=((it.extras&&it.extras.patty)?it.extras.patty:0)*((it.extras&&it.extras.EXTRA_PRICE_PATTY)?it.extras.EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY);
      var ch=((it.extras&&it.extras.cheddar)?it.extras.cheddar:0)*((it.extras&&it.extras.EXTRA_PRICE_CHEDDAR)?it.extras.EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR);
      return base+pz+ch;
    }
    function calcRawTotal(){
      var t=0,k,obj;
      for(k in cart.burger){obj=cart.burger[k]; t += unitWithExtras(obj)*(obj.qty||0)}
      for(k in cart.drink){obj=cart.drink[k]; t += ((obj.item&&obj.item.price)||0)*(obj.qty||0)}
      return t;
    }
    function calcTotalWithDiscount(){
      var raw = calcRawTotal();
      if(appliedDiscount && appliedDiscount>0){
        return Math.round(raw * (1 - (appliedDiscount/100)));
      }
      return raw;
    }

    function friesName(v){
      if(!v) return "‚Äî";
      if(v === "con_sazon") return "Sazonadas";
      if(v === "con_sal") return "Con sal";
      if(v === "sin_sal") return "Sin sal";
      var s = String(v||'').toLowerCase();
      if(s.includes("sazon") && !s.includes("sin")) return "Sazonadas";
      if(s.includes("sin") && (s.includes("sal")||s.includes("sazon"))) return "Sin sal";
      if(s.includes("sal")) return "Con sal";
      return v;
    }

    /* === RENDER RESUMEN === */
    function renderResumen(){
      var resumen=$("#resumen"),resTotal=$("#resTotal");resumen.innerHTML="";
      var k,obj,extras,unit,line,html;
      function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      for(k in cart.burger){
        obj=cart.burger[k];
        extras=[];
        if(obj.extras && obj.extras.patty){ extras.push("+"+obj.extras.patty+" medall√≥n(es)"); }
        if(obj.extras && obj.extras.cheddar){ extras.push("+"+obj.extras.cheddar+" cheddar"); }
        unit = unitWithExtras(obj);
        line = unit * (obj.qty||0);

        var notesEsc = obj.notes ? escapeHtml(obj.notes) : "";

        html = '<div class="row" style="align-items:flex-start"><div><div><strong>' +
          (obj.qty||0) + '√ó ' + (obj.item?escapeHtml(obj.item.name):"") + '</strong></div>' +
          '<div class="muted">Papas: ' + friesName(obj.fries) + (extras.length?(' ¬∑ '+extras.join(' ¬∑ ')):'') + '</div>' +
          (notesEsc ? ('<div class="muted">Notas: ' + notesEsc + '</div>') : '') +
          '</div><div>' + money(line) + '</div></div>';
        resumen.insertAdjacentHTML("beforeend", html);
      }

      for(k in cart.drink){
        obj = cart.drink[k];
        line = ((obj.item && obj.item.price) || 0) * (obj.qty||0);
        html = '<div class="row"><div><strong>' + (obj.qty||0) + '√ó ' + (obj.item?escapeHtml(obj.item.name):"") + '</strong></div><div>' + money(line) + '</div></div>';
        resumen.insertAdjacentHTML("beforeend", html);
      }

      var notaGeneral = $("#inpNotas").value ? $("#inpNotas").value.trim() : "";
      if(notaGeneral){
        var notaEsc = escapeHtml(notaGeneral);
        resumen.insertAdjacentHTML("beforeend", '<div style="margin-top:8px"><strong>Nota del pedido</strong><div class="muted">' + notaEsc + '</div></div>');
      }

      // mostrar cup√≥n (si aplica)
      if(appliedCoupon){
        resumen.insertAdjacentHTML("beforeend", '<div style="margin-top:8px"><strong>Cupon</strong><div class="muted">C√≥digo: '+escapeHtml(appliedCoupon.codigo)+' ‚Äî '+escapeHtml(String(appliedCoupon.descuento))+'% off</div></div>');
      }

      // mostrar slot seleccionado si hay
      var selSlot = (document.getElementById("slotTime") && document.getElementById("slotTime").value) ? document.getElementById("slotTime").selectedOptions[0].dataset.pretty : "";
      if(selSlot){
        resumen.insertAdjacentHTML("beforeend", '<div style="margin-top:8px"><strong>Horario de retiro</strong><div class="muted">' + escapeHtml(selSlot) + '</div></div>');
      }

      resTotal.textContent = money(calcTotalWithDiscount());
    }

    /* === APLICAR CUP√ìN === (id√©ntico al anterior) */
    async function applyCouponCode(){
      var code = $("#inpCupon") ? $("#inpCupon").value.trim().toUpperCase() : "";
      var msg = $("#cuponMsg");
      msg.textContent = "";
      msg.className = "muted-small";
      appliedCoupon = null;
      appliedDiscount = 0;

      if(!code){ msg.textContent = "Ingres√° un c√≥digo de cup√≥n."; msg.classList.add("cupon-err"); renderResumen(); return; }

      try{
        const docRef = db.collection("coupons").doc(code);
        const docSnap = await docRef.get();

        if(!docSnap.exists){
          const q = await db.collection("coupons").where("codigo","==", code).limit(1).get();
          if(q.empty){
            msg.textContent = "Cup√≥n inv√°lido.";
            msg.classList.add("cupon-err");
            renderResumen();
            return;
          } else {
            var data = q.docs[0].data();
            var docId = q.docs[0].id;
            if(data.active === false || data.activo === false){ msg.textContent = "Cup√≥n inactivo."; msg.classList.add("cupon-err"); renderResumen(); return; }
            if(data.expiresAt || data.expireAt){
              let exp = data.expiresAt || data.expireAt;
              let expDate = exp.toDate ? exp.toDate() : new Date(exp);
              if(Date.now() > expDate.getTime()){ msg.textContent = "Cup√≥n vencido."; msg.classList.add("cupon-err"); renderResumen(); return; }
            }
            var discount = Number(data.discount || data.descuento || 0) || 0;
            appliedCoupon = { id: docId, codigo: data.codigo||code, descuento: discount, raw: data };
            appliedDiscount = discount;
            msg.textContent = "Cup√≥n aplicado: " + appliedDiscount + "%";
            msg.classList.add("cupon-ok");
            renderResumen();
            return;
          }
        } else {
          var data2 = docSnap.data();
          if((data2.active === false) || (data2.activo === false)){ msg.textContent = "Cup√≥n inactivo."; msg.classList.add("cupon-err"); renderResumen(); return; }
          if(data2.expiresAt || data2.expireAt){
            let exp = data2.expiresAt || data2.expireAt;
            let expDate = exp.toDate ? exp.toDate() : new Date(exp);
            if(Date.now() > expDate.getTime()){ msg.textContent = "Cup√≥n vencido."; msg.classList.add("cupon-err"); renderResumen(); return; }
          }
          var discount2 = Number(data2.discount || data2.descuento || 0) || 0;
          appliedCoupon = { id: docSnap.id, codigo: data2.codigo || code, descuento: discount2, raw: data2 };
          appliedDiscount = discount2;
          msg.textContent = "Cup√≥n aplicado: " + appliedDiscount + "%";
          msg.classList.add("cupon-ok");
          renderResumen();
          return;
        }
      }catch(err){
        console.error("Error al validar cup√≥n:", err);
        msg.textContent = "Error al validar el cup√≥n.";
        msg.classList.add("cupon-err");
        renderResumen();
      }
    }
    $("#btnAplicarCupon").addEventListener("click", applyCouponCode);

    /* === HANDLER: Mensaje din√°mico para el pago === */
    function updatePaymentHint(){
      var hint = $("#paymentHint");
      var pago = (document.querySelector('input[name="pago"]:checked')||{}).value || "";
      if(pago === "mercado_pago"){
        hint.textContent = "Enviar comprobante por WhatsApp (alias: rhodesburgers)";
      } else if(pago === "efectivo"){
        hint.textContent = "Lo pag√°s cuando retiras";
      } else {
        hint.textContent = "";
      }
    }
    document.querySelectorAll('input[name="pago"]').forEach(r => r.addEventListener('change', updatePaymentHint));

    /* === SLOTS: utilidades para generar y reservar slots === */

    // parse "HH:mm" to {hour,minute}
    function parseHHMM(s){
      if(!s || typeof s !== 'string') return null;
      var parts = s.split(':');
      if(parts.length<2) return null;
      return { h: parseInt(parts[0],10), m: parseInt(parts[1],10) };
    }

    // formato para id de slot: YYYYMMDD_HHMM
    function slotKeyFromDate(d){
      const pad = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}`;
    }
    // formato legible
    function slotPretty(d){
      return d.toLocaleDateString('es-AR') +' '+ d.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false});
    }

    // genera array de d√≠as (Date at midnight local) para daysAhead
    function genDaysArray(daysAhead){
      var arr=[];
      var now=new Date();
      for(var i=0;i<=daysAhead;i++){
        var dd=new Date(now.getFullYear(), now.getMonth(), now.getDate()+i, 0,0,0,0);
        arr.push(dd);
      }
      return arr;
    }

    // generar slots para un d√≠a dado seg√∫n open/close/interval
    function genSlotsForDay(dayDate, openHHMM, closeHHMM, interval){
      // dayDate is local midnight
      var open = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate(), openHHMM.h, openHHMM.m, 0,0);
      var close = new Date(dayDate.getFullYear(), dayDate.getMonth(), dayDate.getDate(), closeHHMM.h, closeHHMM.m, 0,0);
      var slots=[];
      // si close <= open -> no slots
      if(close.getTime() <= open.getTime()) return slots;
      var cur = new Date(open.getTime());
      while(cur.getTime() <= close.getTime() - (interval*60*1000)){
        slots.push(new Date(cur.getTime()));
        cur = new Date(cur.getTime() + interval*60*1000);
      }
      return slots;
    }

    // cargar config/slots desde Firestore
    async function loadSlotsConfig(){
      try{
        const snap = await db.collection('config').doc('slots').get();
        if(snap.exists){
          const d = snap.data();
          SLOTS_CONFIG.openTime = d.openTime || SLOTS_CONFIG.openTime;
          SLOTS_CONFIG.closeTime = d.closeTime || SLOTS_CONFIG.closeTime;
          SLOTS_CONFIG.interval = Number(d.interval) || SLOTS_CONFIG.interval;
          SLOTS_CONFIG.daysAhead = Number(d.daysAhead) || SLOTS_CONFIG.daysAhead;
          SLOTS_CONFIG.capacity = Number(d.capacity) || SLOTS_CONFIG.capacity;
        }
      }catch(e){
        console.warn('loadSlotsConfig error', e);
      }
    }

    // devuelve mapa { slotKey: uses }
    async function fetchSlotsUsage(slotKeys){
      // slotKeys: array of ids
      const res = {};
      await Promise.all(slotKeys.map(async k=>{
        try{
          const s = await db.collection('slots').doc(k).get();
          res[k] = s.exists ? (Number(s.data().uses)||0) : 0;
        }catch(e){
          res[k] = 0;
        }
      }));
      return res;
    }

    // build UI: populate day select and time select, mark full slots
    async function refreshSlotsUI(){
      $("#slotNote").textContent = "Cargando turnos disponibles...";
      $("#slotDay").innerHTML = ""; $("#slotTime").innerHTML = "";
      await loadSlotsConfig();

      const openHHMM = parseHHMM(SLOTS_CONFIG.openTime);
      const closeHHMM = parseHHMM(SLOTS_CONFIG.closeTime);
      const interval = Number(SLOTS_CONFIG.interval) || 15;
      const daysAhead = Number(SLOTS_CONFIG.daysAhead) || 0;
      const capacity = Number(SLOTS_CONFIG.capacity) || 1;

      if(!openHHMM || !closeHHMM){
        $("#slotNote").textContent = "Configuraci√≥n de horarios inv√°lida. Contact√° al local.";
        return;
      }

      const days = genDaysArray(daysAhead);
      // build mapping day -> slots (Date objects)
      const daySlotsMap = {};
      days.forEach(d=>{
        const slots = genSlotsForDay(d, openHHMM, closeHHMM, interval);
        daySlotsMap[d.toISOString().slice(0,10)] = slots; // key yyyy-mm-dd
      });

      // flatten keys to fetch usage
      const allSlotDates = [];
      for(const arr of Object.values(daySlotsMap)) arr.forEach(x=> allSlotDates.push(x));
      const slotKeys = allSlotDates.map(slotKeyFromDate);

      const usages = await fetchSlotsUsage(slotKeys);

      // populate day select
      const slotDay = $("#slotDay");
      const slotTime = $("#slotTime");
      days.forEach(d=>{
        const opt = document.createElement('option');
        const label = d.toLocaleDateString('es-AR', { weekday: 'short', day: '2-digit', month: '2-digit' });
        opt.value = d.toISOString().slice(0,10); // yyyy-mm-dd
        opt.textContent = label;
        slotDay.appendChild(opt);
      });

      // onchange -> fill times
      function fillTimesForSelectedDay(){
        slotTime.innerHTML = "";
        const selectedDay = slotDay.value; // yyyy-mm-dd
        const slots = daySlotsMap[selectedDay] || [];
        if(slots.length === 0){
          const opt = document.createElement('option');
          opt.value = "";
          opt.textContent = "No hay turnos en este d√≠a";
          slotTime.appendChild(opt);
          $("#slotNote").textContent = "Sin turnos disponibles en el d√≠a seleccionado.";
          renderResumen();
          return;
        }
        slots.forEach(sd=>{
          const key = slotKeyFromDate(sd);
          const uses = usages[key] || 0;
          const opt = document.createElement('option');
          opt.value = key; // slot id
          opt.dataset.timeIso = sd.toISOString();
          opt.dataset.pretty = slotPretty(sd);
          opt.textContent = sd.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false}) + (uses >= capacity ? " ‚Äî COMPLETO" : "");
          if(uses >= capacity){
            opt.disabled = true;
            opt.className = 'slot-full';
          } else {
            opt.className = 'slot-ok';
          }
          slotTime.appendChild(opt);
        });
        const selectedAny = slotTime.querySelector('option:not([disabled])');
        if(selectedAny) { slotTime.value = selectedAny.value; $("#slotNote").textContent = ""; }
        else { $("#slotNote").textContent = "No quedan turnos con cupos libres en este d√≠a."; }
        renderResumen();
      }

      slotDay.onchange = fillTimesForSelectedDay;
      slotTime.onchange = renderResumen;
      // select today if exists
      slotDay.value = days[0].toISOString().slice(0,10);
      fillTimesForSelectedDay();
    }

    $("#btnRefreshSlots").addEventListener('click', ()=>{ refreshSlotsUI(); });

    /* === Resto: buildOrder, WhatsApp y creaci√≥n (adaptado para usar slot reservation) === */

    function selectedPago(){var el=document.querySelector('input[name="pago"]:checked');return el?el.value:"";}

    // build order object (without committing to Firestore)
    function buildOrderObject(orderNumber, slotKey, slotIso){
      var items=[],k,b,d;
      for(k in cart.burger){
        b=cart.burger[k];
        items.push({
          type:"burger",
          id:b.item?b.item.id:"",
          name:b.item?b.item.name:"",
          qty:b.qty||0,
          price:b.item?(b.item.price||0):0,
          fries: b.fries || "",
          extras:{
            patty:(b.extras&&b.extras.patty)?b.extras.patty:0,
            cheddar:(b.extras&&b.extras.cheddar)?b.extras.cheddar:0,
            EXTRA_PRICE_PATTY:(b.extras&&b.extras.EXTRA_PRICE_PATTY)?b.extras.EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY,
            EXTRA_PRICE_CHEDDAR:(b.extras&&b.extras.EXTRA_PRICE_CHEDDAR)?b.extras.EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR
          },
          notes: b.notes || ""
        });
      }
      for(k in cart.drink){d=cart.drink[k];items.push({type:"drink",id:d.item?d.item.id:"",name:d.item?d.item.name:"",qty:d.qty||0,price:d.item?(d.item.price||0):0});}
      var pago=selectedPago();
      var rawTotal = calcRawTotal();
      var totalWithDiscount = calcTotalWithDiscount();

      var order = {
        orderNumber:orderNumber, number:orderNumber,
        nombre:$("#inpNombre").value.trim(),
        telefono:$("#inpTelefono").value.trim(),
        entrega:"take_away",
        pago:pago,
        notes:$("#inpNotas").value.trim(),
        pickup_slot: slotKey || null,    // ej: 20251024_2015
        pickup_time: slotIso || null,    // ISO time for readability
        status:(pago==="mercado_pago"?"pending_payment":"accepted"),
        payment_status:(pago==="mercado_pago"?"pending_payment":"paid"),
        items:items,
        total: totalWithDiscount,
        rawTotal: rawTotal,
        source:"web",
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      };

      if(appliedCoupon){
        order.cupon = appliedCoupon.codigo;
        order.discount = appliedDiscount;
        order.cuponId = appliedCoupon.id;
      }

      return order;
    }

    function moneyFmt(n){return (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0})}
    function buildWhatsappText(order){
      var lines=[];
      var pagoLabel = (order.pago==='efectivo'?'Efectivo': (order.pago==='mercado_pago' ? 'Transferencia' : order.pago));
      lines.push("Hola! Quiero confirmar el pedido #"+order.orderNumber);
      lines.push("Nombre: "+order.nombre+(order.telefono?(" ‚Äî Tel: "+order.telefono):""));
      lines.push("Retiro: Take Away");
      if(order.pickup_time){
        // si viene ISO -> mostrar legible
        try{ lines.push("Horario de retiro: " + (new Date(order.pickup_time)).toLocaleString('es-AR',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit',hour12:false})); }catch(e){}
      }
      lines.push("Medio de pago: "+pagoLabel);
      if(order.cupon){ lines.push("Cup√≥n: "+order.cupon+" ‚Äî "+(order.discount||0)+"% off"); }
      lines.push("------------------------------");
      for(var i=0;i<order.items.length;i++){
        var it=order.items[i];
        if(it.type==='burger'){
          var extras=[]; if(it.extras&&it.extras.patty){extras.push("+"+it.extras.patty+" med")} if(it.extras&&it.extras.cheddar){extras.push("+"+it.extras.cheddar+" cheddar")}
          var friesLabel = friesName(it.fries);
          lines.push((it.qty||0)+"√ó "+(it.name||"")+" (Papas: "+friesLabel+(extras.length?(" ¬∑ "+extras.join(" ¬∑ ")):"")+")");
          if(it.notes){lines.push("  Notas: "+it.notes);}
        }else{ lines.push((it.qty||0)+"√ó "+(it.name||"")); }
      }
      lines.push("------------------------------");
      lines.push("Total: "+moneyFmt(order.total));
      if(order.notes){lines.push("Notas del pedido: "+order.notes);}
      if(order.trackToken){
        var base=location.origin;
        var trackUrl=base+"/gracias.html?id="+encodeURIComponent(order.id||"")+"&t="+encodeURIComponent(order.trackToken);
        lines.push("Seguimiento: "+trackUrl);
      }
      return encodeURIComponent(lines.join("\n"));
    }
    function openWhatsApp(order){
      var PHONE_NUMBER="5491170596483";
      var txt=buildWhatsappText(order);
      var url="https://wa.me/"+PHONE_NUMBER+"?text="+txt;
      window.open(url,"_blank");
    }

    /* === CREAR ORDEN + RESERVA DE SLOT (TRANSACCI√ìN √öNICA) ===
       - Reservamos el slot incrementando slots/{slotKey}.uses
       - Leemos/actualizamos counters.orderNumber
       - Creamos orders/{newDoc} con orderNumber
       - Creamos order_public/{trackToken}
    */
    async function createOrder(){
      if(!Object.keys(cart.burger||{}).length && !Object.keys(cart.drink||{}).length){alert("Tu carrito est√° vac√≠o.");return Promise.resolve(null);}
      var nombre=$("#inpNombre").value.trim(); if(!nombre){alert("Ingres√° tu nombre.");return Promise.resolve(null);}
      var pago=selectedPago(); if(!pago){alert("Eleg√≠ un medio de pago.");return Promise.resolve(null);}

      // slot seleccionado
      var sel = (document.getElementById("slotTime") && document.getElementById("slotTime").value) ? document.getElementById("slotTime").value : "";
      if(!sel){ alert("Eleg√≠ un horario de retiro."); return Promise.resolve(null); }

      // reload config just before reserving
      await loadSlotsConfig();
      const capacity = Number(SLOTS_CONFIG.capacity) || 1;

      // prepare values
      var slotKey = sel; // id
      var slotIso = document.getElementById("slotTime").selectedOptions[0].dataset.timeIso;

      var trackToken = genTrackToken();

      // run a single transaction that:
      // - increments slots/{slotKey}.uses if below capacity
      // - reads and increments config/counters.orderNumber to get orderNumber
      // - creates orders/{doc} with orderNumber and pickup info
      // - creates order_public/{trackToken} summary
      try{
        const result = await db.runTransaction(async tx=>{
          const slotRef = db.collection('slots').doc(slotKey);
          const countersRef = countersRef();
          const slotSnap = await tx.get(slotRef);
          const curUses = slotSnap.exists ? (Number(slotSnap.data().uses)||0) : 0;
          if(curUses >= capacity){
            throw new Error('SLOT_FULL');
          }
          // increment slot uses
          tx.set(slotRef, { uses: curUses + 1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

          // read & bump counter
          const cSnap = await tx.get(countersRef);
          const curCounter = cSnap.exists ? (Number(cSnap.data().orderNumber)||0) : 0;
          const nextOrderNumber = curCounter + 1;
          tx.set(countersRef, { orderNumber: nextOrderNumber, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });

          // create order doc
          const orderRef = db.collection('orders').doc();
          const orderObj = buildOrderObject(nextOrderNumber, slotKey, slotIso);
          orderObj.trackToken = trackToken;
          // createdAt will be serverTimestamp inside transaction
          tx.set(orderRef, orderObj);

          // create public summary doc under order_public (id = trackToken)
          const publicRef = db.collection('order_public').doc(trackToken);
          tx.set(publicRef, {
            orderId: orderRef.id,
            orderNumber: nextOrderNumber,
            status: orderObj.status==='pending_payment' ? 'pending_payment' : 'accepted',
            entrega: orderObj.entrega || "take_away",
            pago: orderObj.pago || "",
            nombre: (orderObj.nombre||"Cliente").split(" ")[0],
            total: orderObj.total || calcTotalWithDiscount(),
            pickup_time: orderObj.pickup_time || null,
            pickup_slot: orderObj.pickup_slot || null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });

          return { orderId: orderRef.id, orderNumber: nextOrderNumber, trackToken: trackToken };
        }); // end transaction

        return result; // {orderId, orderNumber, trackToken}
      }catch(err){
        if(err && err.message === 'SLOT_FULL'){
          alert('El turno seleccionado se llen√≥ en este momento. Eleg√≠ otro turno.');
          // refrescar los slots UI para reflejar el cambio
          await refreshSlotsUI();
          return null;
        }
        console.error('Transaction failed', err);
        alert('Error al confirmar el pedido. Reintent√°.');
        return null;
      }
    }

    // Evitar doble click: deshabilitar mientras se procesa
    document.getElementById("btnConfirmar").onclick = async function(){
      var btn = this;
      if(btn.disabled) return;
      btn.disabled = true;
      btn.classList.add('disabled');

      try {
        const res = await createOrder();
        btn.disabled = false;
        btn.classList.remove('disabled');
        if(!res) return;
        var pago = selectedPago();
        localStorage.setItem("last_order_id",res.orderId);
        try {
          const doc = await db.collection("orders").doc(res.orderId).get();
          var order={id:res.orderId}; if(doc.exists){order=Object.assign(order,doc.data());}
          order.trackToken=order.trackToken||res.trackToken;
          if(pago==="efectivo"||pago==="mercado_pago"){ openWhatsApp(order); }
          clearCart();
          window.location.href="gracias.html?id="+encodeURIComponent(res.orderId)+"&t="+encodeURIComponent(res.trackToken);
        } catch(e) {
          console.error(e);
          clearCart();
          window.location.href="gracias.html?id="+encodeURIComponent(res.orderId)+"&t="+encodeURIComponent(res.trackToken);
        }
      } catch(e) {
        console.error(e);
        btn.disabled = false;
        btn.classList.remove('disabled');
        alert("Ocurri√≥ un error al confirmar el pedido. Prob√° nuevamente.");
      }
    };

    // Copiar alias al portapapeles si corresponde (Transferencia) - mantenido
    async function copyAliasIfNeeded() {
      var pago = selectedPago();
      if (pago !== "mercado_pago") return false;
      var alias = "rhodesburgers";
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(alias);
          try {
            const hint = document.getElementById("paymentHint");
            if (hint) {
              const prev = hint.textContent;
              hint.textContent = prev + " ‚Äî Alias copiado al portapapeles";
              setTimeout(()=> { hint.textContent = prev; }, 2500);
            }
          } catch(_) {}
          return true;
        }
      } catch (err) {}
      try {
        const ta = document.createElement("textarea");
        ta.value = alias;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        if (ok) {
          try {
            const hint = document.getElementById("paymentHint");
            if (hint) {
              const prev = hint.textContent;
              hint.textContent = prev + " ‚Äî Alias copiado al portapapeles";
              setTimeout(()=> { hint.textContent = prev; }, 2500);
            }
          } catch(_) {}
          return true;
        }
      } catch (err) {
        console.warn("No se pudo copiar el alias al portapapeles.", err);
      }
      return false;
    }

    // refrescar resumen si cambian cosas en otra pesta√±a
    window.addEventListener('storage', function(e){
      if(e.key===CART_KEY || e.key===null){
        cart = loadCart();
        renderResumen();
      }
    }, false);

    // inicializaci√≥n
    (function init(){
      // load slots UI and render resumen
      refreshSlotsUI().catch(e=>{ console.warn('refreshSlotsUI failed', e); $("#slotNote").textContent = "No se pudieron cargar los turnos."; });
      updatePaymentHint();
      renderResumen();
    })();

  </script>
</body>
</html>
