<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --radius:22px;
      --shadow:0 12px 34px rgba(0,0,0,.10);
      --ring:#e9e9e9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    /* Marca de agua full screen */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:0; pointer-events:none;
      background:
        radial-gradient(transparent 40%, rgba(246,246,246,.82) 60%) center/100% 100%,
        url("images/logo.png") center/ min(70vw,820px) no-repeat;
      opacity:.15; filter:grayscale(100%);
    }
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none}
    .brand img{width:40px;height:40px;border-radius:10px;background:#fff;object-fit:contain}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:10px;border:2px solid var(--primary);padding:10px 16px;border-radius:999px;color:var(--primary);background:#fff;font-weight:700;text-decoration:none;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .container{max-width:1100px;margin:24px auto;padding:0 12px;position:relative;z-index:1}
    h1{font-size:34px;margin:14px 4px 18px}
    .grid-2{display:grid;grid-template-columns:1fr 460px;gap:22px}
    @media (max-width: 980px){ .grid-2{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .field{display:flex;flex-direction:column;gap:6px;margin:12px 0}
    .field input, .field textarea{
      width:100%; padding:12px 14px; border:1px solid var(--ring); border-radius:12px; outline:none;
    }
    .inline{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
    .pill{
      display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);
      border-radius:999px;padding:10px 14px 10px 14px;background:#fff;min-width:160px;justify-content:flex-start
    }
    .pill input{accent-color:var(--primary)}
    .muted{color:var(--muted)}
    .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .summary-line{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #efefef}
    .summary-name{font-weight:600}
    .total{display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:18px;margin-top:12px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand">
        <img src="images/logo.png" alt="Rhodes Burgers" />
      </a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>

    <div class="grid-2">
      <!-- Columna izquierda -->
      <section class="card">
        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" placeholder="Ej: Juan P√©rez" autocomplete="name" />
        </div>

        <div class="field">
          <label>Tel√©fono (opcional)</label>
          <input id="inpTel" placeholder="Ej: 11 2345 6789" autocomplete="tel" />
        </div>

        <!-- Medio de pago: Mercado Pago (redirige a WhatsApp) / Efectivo -->
        <div class="field">
          <label>Medio de pago</label>
          <div class="inline">
            <label class="pill"><input type="radio" name="pago" value="mercado_pago"> üí≥ Mercado Pago</label>
            <label class="pill"><input type="radio" name="pago" value="efectivo"> üíµ Efectivo</label>
          </div>
        </div>

        <!-- Tipo de entrega -->
        <div class="field">
          <label>Tipo de entrega</label>
          <div class="inline">
            <label class="pill"><input type="radio" name="entrega" value="take_away"> üëú Take Away</label>
          </div>
          <div class="muted">* Solo retiro por el local.</div>
        </div>

        <div class="field">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div class="actions">
          <a class="btn ghost" href="index.html">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>

        <p class="muted" id="status" style="margin-top:8px"></p>
      </section>

      <!-- Columna derecha: resumen -->
      <aside class="card">
        <h3>Resumen</h3>
        <div id="resumen"></div>
        <div class="total"><span>Total</span><span id="total">$ 0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // === Config Firebase (igual a la que ya ten√≠as funcionando) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // === Carrito (mismo formato que index) ===
    const CART_KEY = "rhodes_cart_v3";
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{}}; }catch{ return {burger:{},drink:{}}; } }
    function clearCart(){ localStorage.setItem(CART_KEY, JSON.stringify({burger:{},drink:{}})); }

    function lineUnit(obj){
      const base = obj.item?.price || 0;
      const pat  = (obj.extras?.patty||0)   * (obj.extras?.EXTRA_PRICE_PATTY??0);
      const che  = (obj.extras?.cheddar||0) * (obj.extras?.EXTRA_PRICE_CHEDDAR??0);
      return base + pat + che;
    }
    function cartTotal(cart){
      let t=0;
      for(const b of Object.values(cart.burger)){
        t += lineUnit(b) * (b.qty||0);
      }
      for(const d of Object.values(cart.drink)){
        t += (d.item?.price||0) * (d.qty||0);
      }
      return t;
    }

    let cart = loadCart();
    const resumenEl = $("#resumen"), totalEl = $("#total");
    function renderResumen(){
      const rows=[];
      const burgers = Object.values(cart.burger);
      const drinks  = Object.values(cart.drink);

      if(burgers.length===0 && drinks.length===0){
        resumenEl.innerHTML = `<p class="muted">No hay productos en el carrito.</p>`;
        totalEl.textContent = money(0);
        return;
      }

      for(const b of burgers){
        const extrasTxt=[];
        if(b.extras){
          if(b.extras.patty) extrasTxt.push(`+${b.extras.patty} medall√≥n(es)`);
          if(b.extras.cheddar) extrasTxt.push(`+${b.extras.cheddar} cheddar`);
        }
        rows.push(`
          <div class="summary-line">
            <div>
              <div class="summary-name">${b.item.name}</div>
              <div class="muted">
                Papas: ${b.fries==="con_sazon"?"Con saz√≥n":"Sin sazonar"}
                ${extrasTxt.length?` ¬∑ ${extrasTxt.join(" ¬∑ ")}`:""}
                ${b.notes?` ¬∑ Notas: ${b.notes}`:""}
                <div class="muted">
                  ${money(b.item.price)}
                  ${ (b.extras?.patty||0)   ? ` + ${b.extras.patty}√ó${money(b.extras.EXTRA_PRICE_PATTY)}` : "" }
                  ${ (b.extras?.cheddar||0) ? ` + ${b.extras.cheddar}√ó${money(b.extras.EXTRA_PRICE_CHEDDAR)}` : "" }
                </div>
              </div>
            </div>
            <div style="text-align:right">
              <div>${money(lineUnit(b))}</div>
              <div class="muted">${b.qty} x</div>
              <div><strong>${money(lineUnit(b)*(b.qty||0))}</strong></div>
            </div>
          </div>
        `);
      }

      for(const d of drinks){
        rows.push(`
          <div class="summary-line">
            <div><div class="summary-name">${d.item.name}</div></div>
            <div style="text-align:right">
              <div>${money(d.item.price)}</div>
              <div class="muted">${d.qty} x</div>
              <div><strong>${money(d.item.price*(d.qty||0))}</strong></div>
            </div>
          </div>
        `);
      }

      resumenEl.innerHTML = rows.join("");
      totalEl.textContent  = money(cartTotal(cart));
    }
    renderResumen();

    // Helpers
    async function takeOrderNumber(){
      try{
        const ref = db.collection("config").doc("counters");
        let next = null;
        await db.runTransaction(async (tx)=>{
          const snap = await tx.get(ref);
          const cur = (snap.exists && snap.data().orderLast) ? Number(snap.data().orderLast) : 0;
          next = cur + 1;
          tx.set(ref, { orderLast: next }, { merge:true });
        });
        return next;
      }catch(e){
        console.warn("No pude tomar contador:", e);
        return null;
      }
    }

    function buildItemsForFS(){
      const items = [];
      for(const b of Object.values(cart.burger)){
        items.push({
          type:"burger",
          id:b.item.id,
          name:b.item.name,
          qty:b.qty,
          price:Number(b.item.price)||0,
          fries:b.fries,
          extras:{
            patty:b.extras?.patty||0,
            cheddar:b.extras?.cheddar||0,
            EXTRA_PRICE_PATTY:b.extras?.EXTRA_PRICE_PATTY||0,
            EXTRA_PRICE_CHEDDAR:b.extras?.EXTRA_PRICE_CHEDDAR||0
          },
          ...(b.notes?{notes:b.notes}:{})
        });
      }
      for(const d of Object.values(cart.drink)){
        items.push({
          type:"drink",
          id:d.item.id,
          name:d.item.name,
          qty:d.qty,
          price:Number(d.item.price)||0
        });
      }
      return items;
    }

    // Mensaje para WhatsApp (se usa cuando eligen "Mercado Pago")
    function buildWhatsappText(order, orderNumber){
      let lines = [];
      lines.push(`*Nuevo pedido Rhodes Burgers*`);
      if(orderNumber) lines.push(`Pedido N¬∫ *${orderNumber}*`);
      lines.push(`Cliente: *${order.nombre}*`);
      if(order.telefono) lines.push(`Tel: ${order.telefono}`);
      lines.push(`Pago: *Mercado Pago*`);
      lines.push(`Entrega: *Take Away*`);
      lines.push(``);
      lines.push(`*Detalle:*`);

      for(const it of order.items){
        if(it.type==="burger"){
          const extras=[];
          if(it.extras?.patty)   extras.push(`+${it.extras.patty} med`);
          if(it.extras?.cheddar) extras.push(`+${it.extras.cheddar} cheddar`);
          const unit = (it.price||0)
            + (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0)
            + (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
          lines.push(`‚Ä¢ ${it.qty}√ó ${it.name} ‚Äî ${money(unit)} c/u`);
          lines.push(`   Papas: ${it.fries==="con_sazon"?"Con saz√≥n":"Sin sazonar"}${extras.length?` ¬∑ ${extras.join(" ¬∑ ")}`:""}`);
          if(it.notes) lines.push(`   Notas: ${it.notes}`);
        }else{
          lines.push(`‚Ä¢ ${it.qty}√ó ${it.name} ‚Äî ${money(it.price)} c/u`);
        }
      }

      lines.push(``);
      lines.push(`*Total:* ${money(order.total)}`);
      if(order.notas) { lines.push(``); lines.push(`Notas del cliente: ${order.notas}`); }
      lines.push(``);
      lines.push(`¬°Gracias!`);

      return encodeURIComponent(lines.join("\n"));
    }

    const btnConfirmar = $("#btnConfirmar");
    btnConfirmar.onclick = async ()=>{
      const nombre = $("#inpNombre").value.trim();
      const telefono = $("#inpTel").value.trim();
      const pagoEl = document.querySelector('input[name="pago"]:checked');
      const entregaEl = document.querySelector('input[name="entrega"]:checked');
      const notas = $("#inpNotas").value.trim();

      if(Object.keys(cart.burger).length===0 && Object.keys(cart.drink).length===0){
        alert("Tu carrito est√° vac√≠o.");
        return;
      }
      if(!nombre){ alert("Ingres√° tu nombre y apellido."); return; }
      if(!pagoEl){ alert("Eleg√≠ un medio de pago."); return; }
      if(!entregaEl){ alert("Confirm√° el tipo de entrega."); return; }

      const itemsFS = buildItemsForFS();
      const total = cartTotal(cart);

      btnConfirmar.disabled = true;
      $("#status").textContent = "Guardando pedido...";

      // N√∫mero de pedido
      const orderNumber = await takeOrderNumber();

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        orderNumber: orderNumber || null,
        nombre,
        telefono: telefono || null,
        pago: pagoEl.value,           // 'mercado_pago' | 'efectivo'
        entrega: "take_away",
        items: itemsFS,
        total,
        notas: notas || null,
        status: "accepted"
      };

      try{
        await db.collection("orders").add(order);

        if(pagoEl.value === "mercado_pago"){
          // Tel√©fono del local (aj√∫stalo si hace falta)
          const LOCAL_WA = "5491170596483";
          const text = buildWhatsappText(order, orderNumber);
          const url  = `https://wa.me/${LOCAL_WA}?text=${text}`;
          clearCart();
          window.location.href = url;     // redirige a WhatsApp con el detalle
        }else{
          // Efectivo ‚Üí pantalla de gracias
          clearCart();
          window.location.href = "gracias.html";
        }
      }catch(err){
        console.error(err);
        alert("No pudimos guardar el pedido. Reintent√° en unos minutos.");
        btnConfirmar.disabled = false;
        $("#status").textContent = "";
      }
    };
  </script>
</body>
</html>
