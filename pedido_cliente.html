<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{--primary:#625A45;--text:#111;--muted:#666;--bg:#f6f6f6;--card:#fff;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.08);--ring:#eaeaea}
    *{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .btn.small{padding:6px 10px;border-radius:8px;font-size:14px}
    .btn.disabled, .btn[disabled]{ opacity:.6; pointer-events:none; }
    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h1{font-size:32px;margin:10px 0 18px}
    label{font-weight:600;margin:6px 0;display:block}
    input[type="text"]{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    .group{margin:14px 0}
    .chips{display:flex;gap:12px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:999px;padding:10px 14px}
    .chip input{accent-color:var(--primary)}
    .muted{color:var(--muted)}
    .muted-small{color:var(--muted); font-size:13px; margin-top:6px;}
    .pay-hint{font-size:13px;color:var(--muted);margin-top:6px}
    .chip-col{display:flex;flex-direction:column;align-items:flex-start;gap:6px}
    .right .row{display:flex;align-items:center;justify-content:space-between;margin:10px 0}
    .total{font-weight:800;font-size:18px}
    textarea{width:100%;min-height:90px;border:1px solid var(--ring);border-radius:12px;padding:10px}
    .actions{display:flex;gap:10px;margin-top:12px}.actions .btn{flex:1}
    .statusHint{font-size:13px;color:var(--muted);margin-top:10px}
    html,body{min-height:100%} body{position:relative}
    body::before{content:"";position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:clamp(240px,48vmin,560px);background:url("images/logo.png") center/contain no-repeat;opacity:.08;pointer-events:none;z-index:5}
    .cupon-ok{color:green;font-weight:700}
    .cupon-err{color:#b00020;font-weight:700}
    .payment-hint-box{margin-top:8px;font-weight:700;color:var(--primary)}
    .discount-row{font-weight:800}

    /* carousel UI */
    .carousel{display:flex;align-items:center;gap:12px;margin-top:8px}
    .arrow{width:44px;height:44px;border-radius:10px;border:1px solid var(--ring);display:inline-grid;place-items:center;cursor:pointer;background:#fff}
    .arrow.disabled{opacity:.5;cursor:not-allowed}
    .slot-display{min-width:180px;padding:10px 14px;border-radius:10px;background:#fff;border:1px solid var(--ring);text-align:center;font-weight:800}
    .slot-sub{font-size:13px;color:var(--muted);margin-top:6px}
    .no-slots{color:#b00020;font-weight:700}
    .slot-meta{font-size:13px;color:#666;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>Confirmar pedido</h1>

      <div class="group">
        <label>Nombre y apellido</label>
        <input id="inpNombre" type="text" placeholder="Ej: Juan P√©rez">
      </div>

      <div class="group">
        <label>Tel√©fono (opcional)</label>
        <input id="inpTelefono" type="text" placeholder="Ej: 11 2345 6789">
      </div>

      <div class="group">
        <label>Medio de pago</label>
        <div class="chips">
          <div class="chip-col">
            <label class="chip"><input id="payTransfer" type="radio" name="pago" value="mercado_pago"> Transferencia</label>
            <div class="muted-small"></div>
          </div>
          <div class="chip-col">
            <label class="chip"><input id="payLocal" type="radio" name="pago" value="efectivo"> En Local</label>
            <div class="muted-small"></div>
          </div>
        </div>
        <div id="paymentHint" class="payment-hint-box" aria-live="polite"></div>
      </div>

      <div class="group">
        <label>Tipo de entrega</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="entrega" value="take_away" checked> Take Away</label>
        </div>
        <div class="muted" style="margin-top:6px">* Solo retiro por el local.</div>
      </div>

      <!-- CAROUSEL DE SLOTS -->
      <div class="group">
        <label>Horario de retiro (solo hoy)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="carousel" id="slotsCarousel">
            <div class="arrow" id="slotPrev" title="Anterior">‚óÄ</div>
            <div class="slot-display" id="slotLabel">Cargando...</div>
            <div class="arrow" id="slotNext" title="Siguiente">‚ñ∂</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px">
            <button id="btnRefreshSlots" class="btn ghost small" title="Actualizar turnos">üîÅ</button>
            <div id="slotCount" class="slot-sub"></div>
          </div>
        </div>
        <div id="slotNote" class="slot-meta">Cargando turnos...</div>
      </div>

      <!-- CUP√ìN -->
      <div class="group">
        <label>¬øTen√©s un cup√≥n de descuento?</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="inpCupon" type="text" placeholder="C√≥digo del cup√≥n" style="flex:1">
          <button id="btnAplicarCupon" class="btn ghost">Aplicar</button>
        </div>
        <div id="cuponMsg" class="muted-small" style="margin-top:8px"></div>
      </div>

      <div class="group">
        <label>Notas (opcional)</label>
        <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        <div class="muted-small"></div>
      </div>

      <div class="actions">
        <a class="btn ghost" href="index.html">Cancelar</a>
        <button class="btn primary" id="btnConfirmar">Confirmar Pedido</button>
      </div>

      <div class="statusHint">Te redirigimos a WhatsApp con el detalle y un link para seguir el estado.</div>
    </section>

    <aside class="card right">
      <h3>Resumen</h3>
      <div id="resumen"></div>
      <div class="row total">
        <div>Total</div><div id="resTotal">$ 0</div>
      </div>
    </aside>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* === FIREBASE === */
    var firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var db = firebase.firestore();

    /* === CONSTANTES / ESTADO === */
    var MAX_PER_SLOT = 4;            // m√°ximo pedidos por slot
    var MINUTES_AHEAD = 5;           // no mostrar slots dentro de los pr√≥ximos X minutos
    var OPEN_TIME = "12:00";         // horario apertura (fallback)
    var CLOSE_TIME = "23:59";        // horario cierre (fallback)
    var START_10 = "19:10";          // start para serie 10'
    var START_20 = "19:20";          // start para serie 20'
    var CART_KEY="rhodes_cart_v3";

    function $(s){return document.querySelector(s)}
    function money(n){return (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0})}
    function loadCart(){try{return JSON.parse(localStorage.getItem(CART_KEY))||{burger:{},drink:{}}}catch(e){return {burger:{},drink:{}}}}
    var cart = loadCart();

    const EXTRA_PRICE_PATTY = 2400, EXTRA_PRICE_CHEDDAR = 300;

    function totalBurgersInCart(){
      var s=0;
      for(var k in cart.burger) s += Number(cart.burger[k].qty||0);
      return s;
    }

    /* === utilidades de tiempo / slots === */
    function parseHHMM(s){
      if(!s) return null;
      var parts = s.split(':'); if(parts.length<2) return null;
      return { h: parseInt(parts[0],10), m: parseInt(parts[1],10) };
    }
    function pad(n){ return String(n).padStart(2,'0'); }
    function slotKeyFromDate(d){ return ''+d.getFullYear()+pad(d.getMonth()+1)+pad(d.getDate())+'_'+pad(d.getHours())+pad(d.getMinutes()); }
    function slotPretty(d){ return d.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false}); }
    function dateTodayAt(hhmm){
      var p = parseHHMM(hhmm);
      var now = new Date();
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), p.h, p.m, 0, 0);
    }
    function genSlots(startAt, intervalMin){
      var open = dateTodayAt(OPEN_TIME), close = dateTodayAt(CLOSE_TIME);
      var start = startAt > open ? startAt : open;
      var slots = [];
      var cur = new Date(start.getTime());
      while(cur.getTime() <= close.getTime() - intervalMin*60*1000){
        slots.push(new Date(cur.getTime()));
        cur = new Date(cur.getTime() + intervalMin*60*1000);
      }
      return slots;
    }

    /* === SUSCRIPCI√ìN EN VIVO A DOCS DE SLOTS (carousel + hide full) === */
    var slotListeners = []; // unsub functions
    var allSlots = [];      // array of slotObj { date, key, count, full, tooSoon, unsub }
    var visibleSlots = [];  // filtered (not full && not tooSoon) sorted

    function clearSlotListeners(){
      allSlots.forEach(s => { try{ if(s.unsub) s.unsub(); }catch(e){} });
      slotListeners = [];
      allSlots = [];
      visibleSlots = [];
    }

    async function subscribeAndRenderSlots(){
      clearSlotListeners();

      cart = loadCart();
      var burgers = totalBurgersInCart();
      var interval = (burgers <= 2) ? 10 : 20;
      var startStr = (burgers <= 2) ? START_10 : START_20;
      var startAt = dateTodayAt(startStr);
      var slots = genSlots(startAt, interval);

      // prepare slot objects
      allSlots = slots.map(d => ({ date: d, key: slotKeyFromDate(d), count: 0, full: false, tooSoon: false, unsub: null }));

      // render placeholder UI while we subscribe
      $("#slotLabel").textContent = 'Cargando...';
      $("#slotCount").textContent = '';
      $("#slotNote").textContent = 'Mostrando turnos cada ' + interval + ' minutos, desde ' + startStr + '. (Max ' + MAX_PER_SLOT + ' pedidos/turno)';

      // attach snapshot to each slot doc
      allSlots.forEach(slotObj=>{
        (function(sObj){
          var ref = db.collection('slots').doc(sObj.key);
          var unsub = ref.onSnapshot(snap=>{
            try{
              var count = snap.exists ? Number(snap.data().count||0) : 0;
              sObj.count = count;
              sObj.full = count >= MAX_PER_SLOT;
              var now = Date.now();
              sObj.tooSoon = (new Date(sObj.date)).getTime() <= (now + MINUTES_AHEAD*60*1000);

              rebuildVisibleSlotsAndKeepSelection();
            }catch(e){
              console.warn('slot snap err', e);
            }
          }, err=>{ console.warn('slot snap err', err); });
          sObj.unsub = unsub;
          slotListeners.push(unsub);
        })(slotObj);
      });

      // initial rebuild
      setTimeout(rebuildVisibleSlotsAndKeepSelection, 200);
    }

    // recompute visibleSlots and keep selection
    var currentVisibleIndex = 0;
    function rebuildVisibleSlotsAndKeepSelection(){
      var prevSelectedKey = null;
      var container = $("#slotsCarousel");
      if(container && container.selectedSlot) prevSelectedKey = container.selectedSlot.key;

      visibleSlots = allSlots.filter(s => !s.full && !s.tooSoon).sort((a,b)=>a.date - b.date);

      if(visibleSlots.length === 0){
        currentVisibleIndex = -1;
        updateCarouselUI();
        return;
      }

      var idx = visibleSlots.findIndex(s => s.key === prevSelectedKey);
      if(idx >= 0){
        currentVisibleIndex = idx;
      } else {
        var now = Date.now();
        var nearIdx = visibleSlots.findIndex(s => s.date.getTime() >= now);
        currentVisibleIndex = (nearIdx >= 0) ? nearIdx : 0;
      }

      updateCarouselUI();
    }

    function updateCarouselUI(){
      var label = $('#slotLabel');
      var countEl = $('#slotCount');
      var prevBtn = $('#slotPrev');
      var nextBtn = $('#slotNext');
      var carousel = $('#slotsCarousel');

      if(!visibleSlots || visibleSlots.length === 0){
        label.innerHTML = '<div class="no-slots">No hay horarios disponibles</div>';
        countEl.textContent = '';
        prevBtn.classList.add('disabled');
        nextBtn.classList.add('disabled');
        if(carousel) delete carousel.selectedSlot;
        return;
      }

      if(currentVisibleIndex < 0) currentVisibleIndex = 0;
      if(currentVisibleIndex >= visibleSlots.length) currentVisibleIndex = visibleSlots.length - 1;

      var s = visibleSlots[currentVisibleIndex];
      label.textContent = slotPretty(s.date);
      var remaining = Math.max(0, MAX_PER_SLOT - (Number(s.count||0)));
      countEl.textContent = remaining > 0 ? (remaining + ' cupo' + (remaining>1?'s':'')) : '√∫ltimo cupo';

      if(currentVisibleIndex <= 0) prevBtn.classList.add('disabled'); else prevBtn.classList.remove('disabled');
      if(currentVisibleIndex >= visibleSlots.length - 1) nextBtn.classList.add('disabled'); else nextBtn.classList.remove('disabled');

      carousel.selectedSlot = { key: s.key, iso: s.date.toISOString(), pretty: slotPretty(s.date) };
    }

    // arrows
    function goPrevSlot(){ if(!visibleSlots.length) return; if(currentVisibleIndex>0){ currentVisibleIndex--; updateCarouselUI(); renderResumen(); } }
    function goNextSlot(){ if(!visibleSlots.length) return; if(currentVisibleIndex<visibleSlots.length-1){ currentVisibleIndex++; updateCarouselUI(); renderResumen(); } }

    async function refreshSlotsUI(){
      try{ await subscribeAndRenderSlots(); }
      catch(e){ console.warn('refreshSlotsUI error', e); $("#slotNote").textContent = 'Error al cargar turnos.'; }
    }

    /* === Reserva de slot (transacci√≥n) === */
    function reserveSlotTransactional(slotKey){
      var ref = db.collection('slots').doc(slotKey);
      return db.runTransaction(async function(tx){
        var snap = await tx.get(ref);
        var cur = snap.exists ? (Number(snap.data().count||0)) : 0;
        if(cur >= MAX_PER_SLOT){ throw new Error('FULL'); }
        tx.set(ref, { count: cur+1, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
        return true;
      });
    }
    function decrementSlot(slotKey){
      var ref = db.collection('slots').doc(slotKey);
      return db.runTransaction(async function(tx){
        var snap = await tx.get(ref);
        if(!snap.exists) return;
        var cur = Number(snap.data().count||0);
        var next = Math.max(0,cur-1);
        tx.set(ref, { count: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      });
    }

    /* === resto de l√≥gica (cupones, resumen, order creation) === */
    var appliedCoupon = null; // {id, code, type, value}
    var appliedDiscount = 0;  // number (percent or fixed)

    function friesName(v){
      if(!v) return "‚Äî";
      if(v === "con_sazon") return "Sazonadas";
      if(v === "con_sal") return "Con sal";
      if(v === "sin_sal") return "Sin sal";
      var s = String(v||'').toLowerCase();
      if(s.includes("sazon") && !s.includes("sin")) return "Sazonadas";
      if(s.includes("sin") && (s.includes("sal")||s.includes("sazon"))) return "Sin sal";
      if(s.includes("sal")) return "Con sal";
      return v;
    }
    function unitWithExtras(it){
      var base=(it.item&&it.item.price)?it.item.price:(it.price||0);
      var pz=((it.extras&&it.extras.patty)?it.extras.patty:0)*((it.extras&&it.extras.EXTRA_PRICE_PATTY)?it.extras.EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY);
      var ch=((it.extras&&it.extras.cheddar)?it.extras.cheddar:0)*((it.extras&&it.extras.EXTRA_PRICE_CHEDDAR)?it.extras.EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR);
      return base+pz+ch;
    }
    function calcRawTotal(){
      var t=0,k,obj;
      for(k in cart.burger){obj=cart.burger[k]; t += unitWithExtras(obj)*(obj.qty||0)}
      for(k in cart.drink){obj=cart.drink[k]; t += ((obj.item&&obj.item.price)||0)*(obj.qty||0)}
      return t;
    }

    /* === TOTAL con descuento desde admin (percent | fixed) === */
    function calcTotalWithDiscount(){
      const raw = calcRawTotal();
      if (!appliedCoupon) return raw;

      if (appliedCoupon.type === "percent"){
        const p = Math.min(Math.max(Number(appliedCoupon.value)||0, 0), 100);
        return Math.round(raw * (1 - p/100));
      } else if (appliedCoupon.type === "fixed"){
        const f = Math.max(Number(appliedCoupon.value)||0, 0);
        return Math.max(0, raw - f);
      }
      return raw;
    }

    function renderResumen(){
      var resumen=$("#resumen"),resTotal=$("#resTotal");resumen.innerHTML="";
      function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      // items
      for(var k in cart.burger){
        var obj=cart.burger[k];
        var extras=[];
        if(obj.extras && obj.extras.patty){ extras.push("+"+obj.extras.patty+" medall√≥n(es)"); }
        if(obj.extras && obj.extras.cheddar){ extras.push("+"+obj.extras.cheddar+" cheddar"); }
        var unit = unitWithExtras(obj);
        var line = unit * (obj.qty||0);
        var notesEsc = obj.notes ? escapeHtml(obj.notes) : "";
        var html = '<div class="row" style="align-items:flex-start"><div><div><strong>' +
          (obj.qty||0) + '√ó ' + (obj.item?escapeHtml(obj.item.name):"") + '</strong></div>' +
          '<div class="muted">Papas: ' + friesName(obj.fries) + (extras.length?(' ¬∑ '+extras.join(' ¬∑ ')):'') + '</div>' +
          (notesEsc ? ('<div class="muted">Notas: ' + notesEsc + '</div>') : '') +
          '</div><div>' + money(line) + '</div></div>';
        resumen.insertAdjacentHTML("beforeend", html);
      }
      for(var k2 in cart.drink){
        var obj2 = cart.drink[k2];
        var line2 = ((obj2.item && obj2.item.price) || 0) * (obj2.qty||0);
        var html2 = '<div class="row"><div><strong>' + (obj2.qty||0) + '√ó ' + (obj2.item?escapeHtml(obj2.item.name):"") + '</strong></div><div>' + money(line2) + '</div></div>';
        resumen.insertAdjacentHTML("beforeend", html2);
      }

      // nota general
      var notaGeneral = $("#inpNotas").value ? $("#inpNotas").value.trim() : "";
      if(notaGeneral){
        var notaEsc = escapeHtml(notaGeneral);
        resumen.insertAdjacentHTML("beforeend", '<div style="margin-top:8px"><strong>Nota del pedido</strong><div class="muted">' + notaEsc + '</div></div>');
      }

      // cup√≥n (desde admin)
      if (appliedCoupon){
        const label = appliedCoupon.type === "percent" ? (appliedCoupon.value + "% off") : ("$" + appliedCoupon.value + " descuento");
        resumen.insertAdjacentHTML("beforeend",
          `<div style="margin-top:8px">
            <strong>Cup√≥n</strong>
            <div class="muted">C√≥digo: ${escapeHtml(appliedCoupon.code)} ‚Äî ${escapeHtml(label)}</div>
          </div>`);
      }

      // horario seleccionado
      var carousel = $("#slotsCarousel");
      if(carousel && carousel.selectedSlot){
        resumen.insertAdjacentHTML("beforeend", '<div style="margin-top:8px"><strong>Horario de retiro</strong><div class="muted">' +
          escapeHtml(carousel.selectedSlot.pretty || carousel.selectedSlot.iso || '') + '</div></div>');
      }

      // Totales
      const raw = calcRawTotal();
      const tot = calcTotalWithDiscount();
      if (appliedCoupon && tot !== raw){
        resumen.insertAdjacentHTML("beforeend",
          `<div class="row discount-row"><div>Subtotal</div><div>${money(raw)}</div></div>`);
      }
      resTotal.textContent = money(tot);
    }

    /* === CUP√ìN (lee estructura de admin: code, type, value, enabled, validFrom, validTo) === */
    async function applyCouponCode(){
      const code = $("#inpCupon")?.value.trim().toUpperCase() || "";
      const msg = $("#cuponMsg");
      msg.textContent = "";
      msg.className = "muted-small";
      appliedCoupon = null;
      appliedDiscount = 0;

      if (!code){
        msg.textContent = "Ingres√° un c√≥digo de cup√≥n.";
        msg.classList.add("cupon-err");
        renderResumen();
        return;
      }

      try{
        const ref = db.collection("coupons").doc(code);
        const snap = await ref.get();

        if (!snap.exists){
          msg.textContent = "Cup√≥n inv√°lido.";
          msg.classList.add("cupon-err");
          renderResumen();
          return;
        }

        const c = snap.data();

        if (!c.enabled){
          msg.textContent = "Cup√≥n inactivo.";
          msg.classList.add("cupon-err");
          renderResumen();
          return;
        }

        // Validar vigencia
        const now = new Date();
        if (c.validFrom){
          const fromDate = c.validFrom.toDate ? c.validFrom.toDate() : new Date(c.validFrom);
          if (now < fromDate){
            msg.textContent = "Cup√≥n a√∫n no vigente.";
            msg.classList.add("cupon-err");
            renderResumen();
            return;
          }
        }
        if (c.validTo){
          const toDate = c.validTo.toDate ? c.validTo.toDate() : new Date(c.validTo);
          if (now > toDate){
            msg.textContent = "Cup√≥n vencido.";
            msg.classList.add("cupon-err");
            renderResumen();
            return;
          }
        }

        // Aplicar descuento desde admin
        appliedCoupon = {
          id: snap.id,
          code: c.code,
          type: c.type,      // "percent" | "fixed"
          value: Number(c.value)||0
        };

        appliedDiscount = appliedCoupon.value;

        msg.textContent = `Cup√≥n aplicado: ${c.type === "percent" ? appliedDiscount + "% off" : "$" + appliedDiscount + " de descuento"}`;
        msg.classList.add("cupon-ok");
        renderResumen();
      }catch(err){
        console.error("Error al validar cup√≥n:", err);
        msg.textContent = "Error al validar el cup√≥n.";
        msg.classList.add("cupon-err");
        renderResumen();
      }
    }
    $("#btnAplicarCupon").addEventListener("click", applyCouponCode);

    /* === Payment hint === */
    function updatePaymentHint(){
      var hint = $("#paymentHint");
      var pago = (document.querySelector('input[name="pago"]:checked')||{}).value || "";
      if(pago === "mercado_pago"){ hint.textContent = "Enviar comprobante por WhatsApp (alias: rhodesburgers)"; }
      else if(pago === "efectivo"){ hint.textContent = "Lo pag√°s cuando retiras"; }
      else { hint.textContent = ""; }
    }
    document.querySelectorAll('input[name="pago"]').forEach(r => r.addEventListener('change', updatePaymentHint));
    updatePaymentHint();

    /* === Crear orden (reserva slot + write order) === */
    async function getNextOrderNumber(){
      let lastKnown = 0;
      try {
        const qs = await db.collection('orders').orderBy('orderNumber','desc').limit(1).get();
        if(!qs.empty) lastKnown = Number(qs.docs[0].data().orderNumber)||0;
      } catch(_){}
      const ref = db.collection('config').doc('counters');
      const next = await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        const cur  = snap.exists ? (Number(snap.data().orderNumber)||0) : 0;
        const base = Math.max(cur,lastKnown);
        const nxt  = base + 1;
        tx.set(ref,{orderNumber:nxt,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
        return nxt;
      });
      return next;
    }

    function buildOrderObject(orderNumber){
      var items=[],k,b,d;
      for(k in cart.burger){
        b=cart.burger[k];
        items.push({
          type:"burger",
          id:b.item?b.item.id:"",
          name:b.item?b.item.name:"",
          qty:b.qty||0,
          price:b.item?(b.item.price||0):0,
          fries: b.fries || "",
          extras:{
            patty:(b.extras&&b.extras.patty)?b.extras.patty:0,
            cheddar:(b.extras&&b.extras.cheddar)?b.extras.cheddar:0,
            EXTRA_PRICE_PATTY:(b.extras&&b.extras.EXTRA_PRICE_PATTY)?b.extras.EXTRA_PRICE_PATTY:EXTRA_PRICE_PATTY,
            EXTRA_PRICE_CHEDDAR:(b.extras&&b.extras.EXTRA_PRICE_CHEDDAR)?b.extras.EXTRA_PRICE_CHEDDAR:EXTRA_PRICE_CHEDDAR
          },
          notes: b.notes || ""
        });
      }
      for(k in cart.drink){d=cart.drink[k];items.push({type:"drink",id:d.item?d.item.id:"",name:d.item?d.item.name:"",qty:d.qty||0,price:d.item?(d.item.price||0):0});}
      var pago = (document.querySelector('input[name="pago"]:checked')||{}).value || "";
      var carousel = $("#slotsCarousel");
      var sel = carousel && carousel.selectedSlot ? carousel.selectedSlot : null;
      var slotKey = sel ? sel.key : null;
      var slotIso = sel ? sel.iso : null;
      var rawTotal = calcRawTotal();
      var totalWithDiscount = calcTotalWithDiscount();

      var order = {
        orderNumber: orderNumber,
        number: orderNumber,
        nombre: $("#inpNombre").value.trim(),
        telefono: $("#inpTelefono").value.trim(),
        entrega: "take_away",
        pago: pago,
        notes: $("#inpNotas").value.trim(),
        pickup_slot: slotKey,
        pickup_time: slotIso,
        status: (pago==="mercado_pago"?"pending_payment":"accepted"),
        payment_status: (pago==="mercado_pago"?"pending_payment":"paid"),
        items: items,
        total: totalWithDiscount,
        rawTotal: rawTotal,
        source: "web",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // adjuntar cup√≥n aplicado (si hay)
      if(appliedCoupon){
        order.cupon   = appliedCoupon.code;
        order.discount = appliedCoupon.type === "percent" ? appliedCoupon.value : { type:"fixed", value: appliedCoupon.value };
        order.cuponId = appliedCoupon.id;
      }
      return order;
    }

    async function reserveAndCreateOrder(orderObj){
      var slotKey = orderObj.pickup_slot;
      if(!slotKey) throw new Error('NO_SLOT');
      // reservar slot
      try{
        await reserveSlotTransactional(slotKey);
      }catch(e){
        if(e && e.message === 'FULL') throw new Error('SLOT_FULL');
        throw e;
      }
      // guardar orden
      try{
        var ref = db.collection('orders').doc();
        await ref.set(orderObj);
        return { id: ref.id };
      }catch(err){
        // revertir slot si falla
        try{ await decrementSlot(slotKey); }catch(_){}
        throw err;
      }
    }

    /* === Handler Confirmar === */
    document.getElementById("btnConfirmar").addEventListener("click", async function(){
      var btn = this;
      if(btn.disabled) return;
      btn.disabled = true; btn.classList.add('disabled');

      try{
        cart = loadCart();
        if(!Object.keys(cart.burger||{}).length && !Object.keys(cart.drink||{}).length){ alert("Tu carrito est√° vac√≠o."); btn.disabled=false; btn.classList.remove('disabled'); return; }
        var nombre = $("#inpNombre").value.trim(); if(!nombre){ alert("Ingres√° tu nombre."); btn.disabled=false; btn.classList.remove('disabled'); return; }
        var carousel = $("#slotsCarousel");
        if(!carousel || !carousel.selectedSlot){ alert("Eleg√≠ un horario de retiro."); btn.disabled=false; btn.classList.remove('disabled'); return; }

        // verify selected slot still available
        var selKey = carousel.selectedSlot.key;
        var selObj = visibleSlots.find(s => s.key === selKey);
        if(!selObj){ alert("El horario elegido ya no est√° disponible. Eleg√≠ otro."); await refreshSlotsUI(); btn.disabled=false; btn.classList.remove('disabled'); return; }

        var nextNum = await getNextOrderNumber();
        var orderObj = buildOrderObject(nextNum);

        // copiar alias si transferencia
        if(orderObj.pago === "mercado_pago"){
          try{ if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText("rhodesburgers"); } }catch(_){}
        }

        try{
          const res = await reserveAndCreateOrder(orderObj);
          // crear order_public
          var trackToken = (Math.random().toString(36).slice(2,10) + Date.now().toString(36)).slice(0,22);
          try{
            await db.collection('order_public').doc(trackToken).set({
              orderId: res.id, orderNumber: orderObj.orderNumber,
              status: orderObj.status==='pending_payment' ? 'pending_payment' : 'accepted',
              entrega: orderObj.entrega, pago: orderObj.pago,
              nombre: (orderObj.nombre||'Cliente').split(' ')[0],
              total: orderObj.total, pickup_slot: orderObj.pickup_slot, pickup_time: orderObj.pickup_time,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge:true });
          }catch(_){}

          // WhatsApp
          if(orderObj.pago==="efectivo"||orderObj.pago==="mercado_pago"){
            var txt = (function buildWhatsappText(order){
              try{
                var lines=[]; var pagoLabel = (order.pago==='efectivo'?'Efectivo': (order.pago==='mercado_pago' ? 'Transferencia' : order.pago));
                lines.push("Hola! Quiero confirmar el pedido #"+order.orderNumber);
                lines.push("Nombre: "+order.nombre+(order.telefono?(" ‚Äî Tel: "+order.telefono):""));
                lines.push("Retiro: Take Away");
                if(order.pickup_time) lines.push("Horario de retiro: " + (new Date(order.pickup_time)).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',hour12:false}));
                lines.push("Medio de pago: "+pagoLabel);
                if(order.cupon){ 
                  if(typeof order.discount === 'object' && order.discount && order.discount.type === 'fixed'){
                    lines.push("Cup√≥n: "+order.cupon+" ‚Äî $"+(order.discount.value||0)+" off");
                  }else{
                    lines.push("Cup√≥n: "+order.cupon+" ‚Äî "+(order.discount||0)+"% off");
                  }
                }
                lines.push("------------------------------");
                for(var i=0;i<order.items.length;i++){
                  var it=order.items[i];
                  if(it.type==='burger'){
                    var extras=[]; if(it.extras&&it.extras.patty){extras.push("+"+it.extras.patty+" med")} if(it.extras&&it.extras.cheddar){extras.push("+"+it.extras.cheddar+" cheddar")}
                    var friesLabel = it.fries || '';
                    lines.push((it.qty||0)+"√ó "+(it.name||"")+" (Papas: "+friesLabel+(extras.length?(" ¬∑ "+extras.join(" ¬∑ ")):"")+")");
                    if(it.notes){lines.push("  Notas: "+it.notes);}
                  }else{ lines.push((it.qty||0)+"√ó "+(it.name||"")); }
                }
                lines.push("------------------------------");
                lines.push("Total: "+(Number(order.total)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0}));
                if(order.notes){lines.push("Notas del pedido: "+order.notes);}
                return encodeURIComponent(lines.join("\n"));
              }catch(e){ return ''; }
            })(orderObj);
            if(txt) window.open("https://wa.me/5491170596483?text="+txt, "_blank");
          }

          // limpiar carrito y redirigir
          try{ localStorage.setItem(CART_KEY, JSON.stringify({burger:{},drink:{}})); }catch(_){}
          window.location.href = "gracias.html?id="+encodeURIComponent(res.id)+"&t="+encodeURIComponent(trackToken);
        }catch(e){
          if(e && e.message === 'SLOT_FULL'){
            alert('El horario seleccionado se llen√≥ mientras intentabas confirmar. Por favor eleg√≠ otro horario.');
            await refreshSlotsUI();
            btn.disabled=false; btn.classList.remove('disabled');
            return;
          } else {
            console.error('Error reservando o creando orden', e);
            alert('Ocurri√≥ un error al confirmar el pedido. Intent√° nuevamente.');
            btn.disabled=false; btn.classList.remove('disabled');
            return;
          }
        }

      }catch(err){
        console.error(err);
        btn.disabled=false; btn.classList.remove('disabled');
      }
    });

    /* === inicializaci√≥n y listeners cross-tab === */
    window.addEventListener('DOMContentLoaded', function(){
      cart = loadCart();
      refreshSlotsUI().then(()=>{ renderResumen(); }).catch(e=>{ console.warn(e); renderResumen(); });

      // arrows
      $('#slotPrev').addEventListener('click', function(){ if(!this.classList.contains('disabled')){ goPrevSlot(); renderResumen(); } });
      $('#slotNext').addEventListener('click', function(){ if(!this.classList.contains('disabled')){ goNextSlot(); renderResumen(); } });
      $('#btnRefreshSlots').addEventListener('click', function(){ refreshSlotsUI().then(()=>renderResumen()); });

      // actualizar resumen si el usuario hace cambios en otras pesta√±as
      window.addEventListener('storage', function(e){
        if(e.key === CART_KEY || e.key === null){
          cart = loadCart();
          refreshSlotsUI().then(()=>renderResumen()).catch(()=>renderResumen());
        }
      });
    });

    // limpiar listeners si el usuario se va de la p√°gina
    window.addEventListener('beforeunload', function(){ clearSlotListeners(); });
  </script>
</body>
</html>
