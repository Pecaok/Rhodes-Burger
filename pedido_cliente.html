<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h1{font-size:32px;margin:10px 0 18px}
    label{font-weight:600;margin:6px 0;display:block}
    input[type="text"]{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    .group{margin:14px 0}
    .chips{display:flex;gap:12px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:999px;padding:10px 14px}
    .chip input{accent-color:var(--primary)}
    .muted{color:var(--muted)}
    .right .row{display:flex;align-items:center;justify-content:space-between;margin:10px 0}
    .total{font-weight:800;font-size:18px}
    textarea{width:100%;min-height:90px;border:1px solid var(--ring);border-radius:12px;padding:10px}
    .actions{display:flex;gap:10px;margin-top:12px}
    .actions .btn{flex:1}
    .statusHint{font-size:13px;color:var(--muted);margin-top:10px}

    html, body { min-height: 100%; }
    body { position: relative; }
    body::before{
      content: "";
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: clamp(240px, 48vmin, 560px);
      background: url("images/logo.png") center / contain no-repeat;
      opacity: 0.08; pointer-events: none; z-index: 5;
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>Confirmar pedido</h1>

      <div class="group">
        <label>Nombre y apellido</label>
        <input id="inpNombre" type="text" placeholder="Ej: Juan P√©rez">
      </div>

      <div class="group">
        <label>Tel√©fono (opcional)</label>
        <input id="inpTelefono" type="text" placeholder="Ej: 11 2345 6789">
      </div>

      <div class="group">
        <label>Medio de pago</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
          <label class="chip"><input type="radio" name="pago" value="efectivo"> En Local</label>
        </div>
      </div>

      <div class="group">
        <label>Tipo de entrega</label>
        <div class="chips">
          <label class="chip"><input type="radio" name="entrega" value="take_away" checked> Take Away</label>
        </div>
        <div class="muted" style="margin-top:6px">* Solo retiro por el local.</div>
      </div>

      <div class="group">
        <label>Notas (opcional)</label>
        <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
      </div>

      <div class="actions">
        <a class="btn ghost" href="index.html">Cancelar</a>
        <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
      </div>

      <div class="statusHint">Te redirigimos a WhatsApp con el detalle y un link para seguir el estado.</div>
    </section>

    <aside class="card right">
      <h3>Resumen</h3>
      <div id="resumen"></div>
      <div class="row total">
        <div>Total</div>
        <div id="resTotal">$ 0</div>
      </div>
    </aside>
  </main>

  <!-- ===== Firebase (SDK MODULAR) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      runTransaction, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ---------- Utils & cart ----------
    const CART_KEY = "rhodes_cart_v3";
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const genOrderCode = () => Math.random().toString(36).slice(2,8).toUpperCase();

    function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{}}; } catch(e){ return {burger:{},drink:{}}; } }
    const cart = loadCart();

    function unitWithExtras(it){
      const base = (it.item && it.item.price) ? it.item.price : (it.price||0);
      const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY   ?? 2400);
      const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR ?? 300);
      return base + pz + ch;
    }
    function calcTotal(){
      let t=0;
      for(const k in cart.burger){ const obj=cart.burger[k]; t += unitWithExtras(obj) * (obj.qty||0); }
      for(const k in cart.drink){  const obj=cart.drink[k];  t += ((obj.item && obj.item.price)||0) * (obj.qty||0); }
      return t;
    }
    function friesName(v){ return v==="con_sazon" ? "Con saz√≥n" : "Sin sazonar"; }

    // Resumen
    const resumen = $("#resumen"), resTotal = $("#resTotal");
    function renderResumen(){
      resumen.innerHTML = "";
      for(const k in cart.burger){
        const o = cart.burger[k];
        const extras=[];
        if(o.extras?.patty)   extras.push("+"+o.extras.patty+" medall√≥n(es)");
        if(o.extras?.cheddar) extras.push("+"+o.extras.cheddar+" cheddar");
        const line = unitWithExtras(o)*(o.qty||0);
        resumen.insertAdjacentHTML("beforeend", `
          <div class="row" style="align-items:flex-start">
            <div>
              <div><strong>${o.qty||0}√ó ${o.item?.name||""}</strong></div>
              <div class="muted">Papas: ${friesName(o.fries)}${extras.length?(' ¬∑ '+extras.join(' ¬∑ ')):""}</div>
              ${o.notes?`<div class="muted">Notas: ${o.notes}</div>`:""}
            </div>
            <div>${money(line)}</div>
          </div>
        `);
      }
      for(const k in cart.drink){
        const d = cart.drink[k];
        const line = (d.item?.price||0)*(d.qty||0);
        resumen.insertAdjacentHTML("beforeend", `
          <div class="row">
            <div><strong>${d.qty||0}√ó ${d.item?.name||""}</strong></div>
            <div>${money(line)}</div>
          </div>
        `);
      }
      resTotal.textContent = money(calcTotal());
    }
    renderResumen();

    // Helpers
    function selectedPago(){ const el=document.querySelector('input[name="pago"]:checked'); return el?el.value:""; }
    function cartToItems(){
      const items=[];
      for(const k in cart.burger){
        const b=cart.burger[k];
        items.push({
          type:"burger", id:b.item?.id||"", name:b.item?.name||"",
          qty:b.qty||0, price:b.item?.price||0,
          fries:b.fries||"sin_sazon",
          extras:{ patty:b.extras?.patty||0, cheddar:b.extras?.cheddar||0 },
          notes:b.notes||""
        });
      }
      for(const k in cart.drink){
        const d=cart.drink[k];
        items.push({ type:"drink", id:d.item?.id||"", name:d.item?.name||"", qty:d.qty||0, price:d.item?.price||0 });
      }
      return items;
    }

    // üî¢ Contador global: /counters/orders_global.seq
    const counterRef = doc(db, 'counters', 'orders_global');
    async function nextOrderNumber(){
      return await runTransaction(db, async (tx)=>{
        const snap = await tx.get(counterRef);
        const cur  = snap.exists() ? (Number(snap.data().seq)||0) : 0;
        const nxt  = cur + 1;
        tx.set(counterRef, { seq: nxt, updatedAt: serverTimestamp() }, { merge:true });
        return nxt;
      });
    }

    // WhatsApp
    function buildWhatsappText(order){
      const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
      const lines=[];
      const pagoLabel = (order.payment.method==='efectivo')? 'Efectivo':'Mercado Pago';
      lines.push(`Hola! Quiero confirmar el pedido #${order.orderNumber}`);
      lines.push(`Nombre: ${order.customer.name}${order.customer.phone?` ‚Äî Tel: ${order.customer.phone}`:''}`);
      lines.push(`Retiro: ${order.delivery.type==='take_away'?'Take Away':order.delivery.type}`);
      lines.push(`Medio de pago: ${pagoLabel}`);
      lines.push(`------------------------------`);
      for(const it of order.items){
        if(it.type==='burger'){
          const extras=[];
          if(it.extras?.patty) extras.push(`+${it.extras.patty} med`);
          if(it.extras?.cheddar) extras.push(`+${it.extras.cheddar} cheddar`);
          lines.push(`${it.qty}√ó ${it.name} (Papas: ${it.fries==='con_sazon'?'Con saz√≥n':'Sin sazonar'}${extras.length?` ¬∑ ${extras.join(' ¬∑ ')}`:''})`);
          if(it.notes) lines.push(`  Notas: ${it.notes}`);
        } else {
          lines.push(`${it.qty}√ó ${it.name}`);
        }
      }
      lines.push(`------------------------------`);
      lines.push(`Total: ${money(order.total)}`);
      if(order.comment) lines.push(`Notas del pedido: ${order.comment}`);
      const base = location.origin;
      const trackUrl = `${base}/gracias.html?id=${encodeURIComponent(order._id)}&code=${encodeURIComponent(order.orderCode)}`;
      lines.push(`Seguimiento: ${trackUrl}`);
      return encodeURIComponent(lines.join("\n"));
    }
    function openWhatsApp(order){
      const PHONE_NUMBER = "5491170596483"; // ‚Üê tu n√∫mero (sin +, sin espacios)
      const url = `https://wa.me/${PHONE_NUMBER}?text=${buildWhatsappText(order)}`;
      window.open(url, "_blank");
    }
    function clearCart(){ try { localStorage.setItem(CART_KEY, JSON.stringify({burger:{},drink:{}})); } catch(e){} }

    // Confirmar
    document.getElementById("btnConfirmar").addEventListener("click", async ()=>{
      const nombre = $("#inpNombre").value.trim();
      if(!nombre){ alert("Ingres√° tu nombre."); return; }
      const pago = selectedPago();
      if(!pago){ alert("Eleg√≠ un medio de pago."); return; }

      try{
        // 1) Obtener n√∫mero secuencial
        const orderNumber = await nextOrderNumber();

        // 2) Armar pedido
        const orderCode = genOrderCode(); // sigue existiendo por seguridad
        const order = {
          // campos toplevel (para tu panel)
          orderNumber, number: orderNumber, nombre,
          // estructura detallada
          customer:{ name:nombre, phone: $("#inpTelefono").value.trim() || null },
          payment:{ method:pago, status: (pago==='efectivo'?'pending':'pending') },
          delivery:{ type:'take_away' },
          comment: $("#inpNotas").value.trim() || null,
          items: cartToItems(),
          total: calcTotal(),
          status: (pago==='mercado_pago' ? 'pending_payment' : 'accepted'),
          orderCode,
          createdAt: serverTimestamp(),
          source:'web'
        };

        // 3) Guardar
        const ref = await addDoc(collection(db,'orders'), order);

        // 4) WhatsApp + redirect
        const enriched = {...order, _id: ref.id};
        openWhatsApp(enriched);
        clearCart();
        localStorage.setItem('lastOrderId', ref.id);
        localStorage.setItem('lastOrderCode', orderCode);
        window.location.href = `gracias.html?id=${encodeURIComponent(ref.id)}&code=${encodeURIComponent(orderCode)}`;
      }catch(err){
        console.error(err);
        alert("No pudimos crear el pedido. Revis√° las Reglas de Firestore para /counters y /orders.");
      }
    });
  </script>
</body>
</html>
