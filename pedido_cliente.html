<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{--primary:#2ecc71;--text:#111;--muted:#666;--bg:#f6f6f6;--card:#fff;--radius:18px;--shadow:0 10px 30px rgba(0,0,0,.08);--ring:#eaeaea}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none}
    .brand img{width:32px;height:32px;border-radius:8px;background:#fff;object-fit:contain}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:10px;border:2px solid var(--primary);padding:10px 16px;border-radius:999px;color:var(--primary);background:#fff;font-weight:700;text-decoration:none;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:34px;margin:16px 4px 24px}
    .grid-2{display:grid;grid-template-columns:1.1fr .9fr;gap:20px}
    @media (max-width:900px){.grid-2{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    label{font-weight:600;margin-bottom:6px;display:block}
    input,textarea{width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px;outline:none}
    textarea{min-height:100px}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:999px;padding:10px 16px;margin:6px 8px 0 0}
    .pill input{accent-color:var(--primary)}
    .row{display:flex;align-items:center;justify-content:space-between}
    .item{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #eee;padding:10px 0}
    .total{display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:18px;margin-top:10px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img src="images/logo.png" alt="Rhodes Burgers"></a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">‚Üê Seguir comprando</a>
    </div>
  </header>

  <main class="container">
    <h1>Confirmar pedido</h1>
    <div class="grid-2">
      <!-- IZQUIERDA -->
      <section class="card">
        <div style="margin-bottom:14px">
          <label>Nombre y apellido</label>
          <input id="inpNombre" placeholder="Ej: Juan P√©rez" autocomplete="name" />
        </div>

        <div style="margin-bottom:14px">
          <label>Tel√©fono (opcional)</label>
          <input id="inpTelefono" placeholder="Ej: 11 2345 6789" inputmode="tel" />
        </div>

        <div style="margin-bottom:10px">
          <label>Medio de pago</label>
          <label class="pill"><input type="radio" name="pago" value="mercado_pago" /> <span>Mercado Pago</span></label>
          <label class="pill"><input type="radio" name="pago" value="efectivo" /> <span>Efectivo</span></label>
        </div>

        <!-- ENTREGA: s√≥lo Take Away, preseleccionado y deshabilitado -->
        <div style="margin:16px 0 6px">
          <label>Tipo de entrega</label>
          <label class="pill">
            <input type="radio" name="entrega" value="take_away" id="radioTakeAway" checked disabled />
            <span>Take Away</span>
          </label>
          <div class="muted" style="margin-top:6px">* Solo retiro por el local.</div>
        </div>

        <div style="margin:16px 0 10px">
          <label>Notas (opcional)</label>
          <textarea id="inpNotas" placeholder="Ej: pasar a las 20:30, sin cebolla, etc."></textarea>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px">
          <a class="btn ghost" href="index.html">Cancelar</a>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>
      </section>

      <!-- DERECHA: resumen -->
      <aside class="card">
        <h3>Resumen</h3>
        <div id="items"></div>
        <div id="friesLine" class="muted" style="margin-top:8px;display:none"></div>
        <div class="total"><span>Total</span> <span id="total">$0</span></div>
      </aside>
    </div>
  </main>

  <!-- Firebase compat (no toco la conexi√≥n) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // ‚ö†Ô∏è Usa tu config actual; no la toco.
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    /*************** UTIL ***************/
    const $ = s => document.querySelector(s);
    const CART_KEY = "rhodes_cart_v3";
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{}}; }catch{ return {burger:{},drink:{}}; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function clearCart(){ saveCart({burger:{},drink:{}}); }
    function calcTotal(c){
      let t=0;
      for(const b of Object.values(c.burger)){
        const base  = (b.item?.price||0);
        const epat  = (b.extras?.patty||0)   * (b.extras?.EXTRA_PRICE_PATTY||0);
        const eche  = (b.extras?.cheddar||0) * (b.extras?.EXTRA_PRICE_CHEDDAR||0);
        t += (base + epat + eche) * b.qty;
      }
      for(const d of Object.values(c.drink)) t += (d.item?.price||0)*d.qty;
      return t;
    }

    /*************** ESTADO / RENDER ***************/
    let cart = loadCart();

    const itemsEl = $("#items");
    const totalEl = $("#total");
    const friesLine = $("#friesLine");

    function renderResumen(){
      const rows=[];
      let anyFries = false;

      for(const obj of Object.values(cart.burger)){
        const extrasTxt=[];
        if(obj.extras){
          if(obj.extras.patty) extrasTxt.push(`+${obj.extras.patty} medall√≥n(es)`);
          if(obj.extras.cheddar) extrasTxt.push(`+${obj.extras.cheddar} cheddar`);
        }
        rows.push(`<div class="item">
          <div>
            <strong>${obj.item.name}</strong>
            <div class="muted">Papas: ${obj.fries==="con_sazon"?"Con saz√≥n":"Sin sazonar"}</div>
            ${extrasTxt.length?`<div class="muted">${extrasTxt.join(" ¬∑ ")}</div>`:""}
          </div>
          <div>${money((obj.item.price + (obj.extras?.patty||0)*(obj.extras?.EXTRA_PRICE_PATTY||0) + (obj.extras?.cheddar||0)*(obj.extras?.EXTRA_PRICE_CHEDDAR||0)) * obj.qty)}</div>
        </div>`);
        anyFries = true;
      }
      for(const obj of Object.values(cart.drink)){
        rows.push(`<div class="item"><div><strong>${obj.item.name}</strong></div><div>${money(obj.item.price*obj.qty)}</div></div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal(cart));
      friesLine.style.display = anyFries ? "block":"none";
    }
    renderResumen();

    /*************** CONFIRMAR ***************/
    const btnConfirmar = $("#btnConfirmar");
    btnConfirmar.onclick = async ()=>{
      // Validaciones b√°sicas
      if(Object.keys(cart.burger).length===0 && Object.keys(cart.drink).length===0){
        alert("Tu carrito est√° vac√≠o."); return;
      }
      const nombre = $("#inpNombre").value.trim();
      if(!nombre){ alert("Ingres√° tu nombre y apellido."); return; }

      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Eleg√≠ un medio de pago."); return; }

      // üîí Entrega SIEMPRE forzada a Take Away
      const entrega = "take_away";

      const telefono = $("#inpTelefono").value.trim();
      const notas = $("#inpNotas").value.trim();

      // Construyo items para guardar/mostrar
      const itemsFS=[];
      for(const o of Object.values(cart.burger)){
        itemsFS.push({type:"burger", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0,
                      fries:o.fries, extras:o.extras||{}, ...(o.notes?{notes:o.notes}:{})});
      }
      for(const o of Object.values(cart.drink)){
        itemsFS.push({type:"drink", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0});
      }

      const order = {
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nombre, telefono,
        pago: pagoEl.value,
        entrega, direccion: "", // ya no se usa
        items: itemsFS,
        total: calcTotal(cart),
        notes: notas || "",
        status: "accepted"
      };

      try{
        btnConfirmar.disabled = true;

        // ‚¨áÔ∏è Si us√°s WhatsApp para ‚ÄúMercado Pago‚Äù, arm√° el mensaje ac√° (opcional)
        if (order.pago === "mercado_pago") {
          // üëâ Cambi√° por el tel√©fono del local (c√≥digo pa√≠s sin +)
          const phone = "541170596483"; // ejemplo
          const lines = [];
          lines.push(`*Nuevo pedido*`);
          lines.push(`Nombre: ${order.nombre}`);
          if(order.telefono) lines.push(`Tel: ${order.telefono}`);
          lines.push(`Entrega: Take Away`);
          lines.push(`---------------------`);
          for(const it of order.items){
            if(it.type==="burger"){
              const ex = [];
              if(it.extras?.patty) ex.push(`+${it.extras.patty} med.`);
              if(it.extras?.cheddar) ex.push(`+${it.extras.cheddar} cheddar`);
              lines.push(`‚Ä¢ ${it.qty}√ó ${it.name} ‚Äî Papas: ${it.fries==="con_sazon"?"Con saz√≥n":"Sin sazonar"}${ex.length?` ‚Äî ${ex.join(" / ")}`:""}`);
            }else{
              lines.push(`‚Ä¢ ${it.qty}√ó ${it.name}`);
            }
          }
          lines.push(`---------------------`);
          lines.push(`Total: ${money(order.total)}`);
          if(order.notes) lines.push(`Notas: ${order.notes}`);
          const txt = encodeURIComponent(lines.join("\n"));
          clearCart();
          window.location.href = `https://wa.me/${phone}?text=${txt}`;
          return;
        }

        // Efectivo: guardo y vuelvo
        await db.collection("orders").add(order);
        clearCart();
        alert("¬°Pedido enviado! ‚úÖ");
        window.location.href = "index.html";
      }catch(err){
        console.error(err);
        alert("No pudimos guardar tu pedido. Intent√° nuevamente.");
      }finally{
        btnConfirmar.disabled = false;
      }
    };
  </script>
</body>
</html>
