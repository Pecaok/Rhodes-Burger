<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:900px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }
    .container{ max-width:900px; margin:24px auto; padding:0 12px }
    h1{ font-size:34px; margin:14px 4px 18px }
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:16px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px }
    .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0 }
    .field input,.field textarea{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px }
    .inline{ display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 }
    .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid #e7e7e7; border-radius:999px; padding:8px 12px }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid #efefef }
    .muted{ color:var(--muted); font-size:14px }
    .total{ display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; margin-top:10px }
    .warn{ background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:12px; color:#856404; margin-bottom:10px }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <a href="index.html" class="brand"><img src="images/logo.png" onerror="this.src='images/logo.jpg'" alt="Rhodes Burgers"></a>
    <div class="spacer"></div>
    <a class="btn ghost" href="index.html">← Seguir comprando</a>
  </div>
</header>

<main>
  <div class="container">
    <h1>Confirmar pedido</h1>
    <div id="warnBox" class="warn" style="display:none"></div>

    <div class="grid">
      <div class="card">
        <div class="field">
          <label>Número de pedido</label>
          <input id="inpNumero" placeholder="Ej: 1" inputmode="numeric"/>
        </div>

        <div class="field">
          <label>Nombre y apellido</label>
          <input id="inpNombre" placeholder="Ej: Juan Pérez" autocomplete="name"/>
        </div>

        <div class="inline">
          <label class="pill"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
          <label class="pill"><input type="radio" name="pago" value="efectivo" checked> Efectivo</label>
        </div>

        <div class="field">
          <label>Retiro</label>
          <div class="muted">Modalidad: <b>Take Away</b> (retira en el local).</div>
        </div>

        <div class="field" style="margin-top:10px">
          <label>Papas fritas (obligatorio)</label>
          <div class="inline">
            <label class="pill"><input type="radio" name="papas" value="con_sazon"> Con sazón</label>
            <label class="pill"><input type="radio" name="papas" value="sin_sazon"> Sin sazonar</label>
          </div>
          <div class="muted">Si ya elegiste en el menú, viene preseleccionado.</div>
        </div>

        <div class="field">
          <label>Comentarios</label>
          <textarea id="inpComentarios" placeholder="Ej: Sin mayonesa, agregar servilletas"></textarea>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn" id="btnCancelar">Cancelar</button>
          <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
        </div>
        <p class="muted" id="status" style="margin-top:8px"></p>
      </div>

      <div class="card">
        <h3>Resumen</h3>
        <div id="items"></div>
        <div class="total"><span>Total</span><span id="total">$0</span></div>
      </div>
    </div>
  </div>
</main>

<script>
const CART_KEYS=["rhodes_cart_v3","rhodes_cart","cart","pending_cart"];
const money=n=>n.toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
const warnBox=document.getElementById("warnBox");

function parseCookie(name){
  const m=document.cookie.match(new RegExp("(?:^|; )"+name.replace(/([.$?*|{}()\\[\\]\\\\/+^])/g,"\\$1")+"=([^;]*)"));
  return m?decodeURIComponent(m[1]):null;
}
function fromUrl(){
  try{const q=new URLSearchParams(location.search); if(!q.has("cart")) return null; return JSON.parse(atob(q.get("cart")));}catch{return null}
}
function normalize(raw){
  const blank={burger:{},drink:{},fries:null};
  if(!raw) return blank;
  if(Array.isArray(raw)){ const out=structuredClone(blank); for(const it of raw){const type=it.type==="drink"?"drink":"burger"; const item=it.item||{id:it.id,name:it.name,price:+it.price||0}; if(!item?.id) continue; out[type][item.id]={qty:+(it.qty||1),item,extras:it.extras||{patty:0,cheddar:0},notes:it.notes||""};} out.fries=raw.fries??null; return out; }
  const out=structuredClone(blank);
  for(const [id,o] of Object.entries(raw.burger||{})){ const item=o.item||{id,name:o.name,price:+o.price||0}; out.burger[item.id]={qty:+(o.qty||1),item,extras:o.extras||{patty:0,cheddar:0},notes:o.notes||""}; }
  for(const [id,o] of Object.entries(raw.drink||{})){ const item=o.item||{id,name:o.name,price:+o.price||0}; out.drink[item.id]={qty:+(o.qty||1),item}; }
  out.fries=raw.fries??null; return out;
}
function merge(a,b){
  if(!a) return normalize(b); if(!b) return normalize(a);
  a=normalize(a); b=normalize(b);
  const out=normalize({});
  out.burger={...a.burger,...b.burger};
  out.drink={...a.drink,...b.drink};
  out.fries=a.fries||b.fries||null;
  return out;
}
function loadCart(){
  let c=normalize({});
  for(const s of [localStorage,sessionStorage]){
    for(const k of CART_KEYS){ try{const v=s.getItem(k); if(v) c=merge(c,JSON.parse(v))}catch{} }
  }
  const u=fromUrl(); if(u) c=merge(c,u);
  const ck=parseCookie("cart"); if(ck){ try{ c=merge(c,JSON.parse(atob(ck))) }catch{} }
  return c;
}

let cart=loadCart();

const itemsEl=document.getElementById("items"), totalEl=document.getElementById("total");
function calcTotal(c){ let t=0; for(const o of Object.values(c.burger)) t+=(+o.item.price||0)*o.qty; for(const d of Object.values(c.drink)) t+=(+d.item.price||0)*d.qty; return t; }
function render(){
  const rows=[];
  for(const o of Object.values(cart.burger)){
    const extras=[]; if(o.extras?.patty) extras.push(`+${o.extras.patty} medallón(es)`); if(o.extras?.cheddar) extras.push(`+${o.extras.cheddar} cheddar`);
    rows.push(`<div class="item"><div><strong>${o.item.name}</strong>${extras.length?`<div class="muted">${extras.join(" · ")}</div>`:""}${o.notes?`<div class="muted">Notas: ${o.notes}</div>`:""}<div class="muted">${money(+o.item.price||0)} x ${o.qty}</div></div><div>${money((+o.item.price||0)*o.qty)}</div></div>`);
  }
  for(const d of Object.values(cart.drink)){
    rows.push(`<div class="item"><div><strong>${d.item.name}</strong><div class="muted">${money(+d.item.price||0)} x ${d.qty}</div></div><div>${money((+d.item.price||0)*d.qty)}</div></div>`);
  }
  itemsEl.innerHTML=rows.join("")||`<p class="muted">No hay productos en el carrito.</p>`;
  totalEl.textContent=money(calcTotal(cart));
  if(cart.fries){ const r=document.querySelector(`input[name="papas"][value="${cart.fries}"]`); if(r) r.checked=true; }
  if(Object.keys(cart.burger).length===0 && Object.keys(cart.drink).length===0){
    warnBox.style.display="block";
    warnBox.textContent="No recibí el carrito. Volvé al menú, agregá productos y tocá “Ir a pagar”.";
  }
}

document.getElementById("btnCancelar").onclick=()=>location.href="index.html";

document.getElementById("btnConfirmar").onclick=()=>{
  if(Object.keys(cart.burger).length===0 && Object.keys(cart.drink).length===0){ alert("Tu carrito está vacío."); return; }
  const nro=(document.getElementById("inpNumero").value||"").trim();
  const nombre=(document.getElementById("inpNombre").value||"").trim();
  if(!nro){ alert("Ingresá el número de pedido."); return; }
  if(!nombre){ alert("Ingresá tu nombre y apellido."); return; }
  const pago=document.querySelector('input[name="pago"]:checked')?.value;
  const fries=document.querySelector('input[name="papas"]:checked')?.value;
  if(!fries){ alert("Elegí una opción de papas."); return; }
  cart.fries=fries; try{ localStorage.setItem("rhodes_cart_v3",JSON.stringify(cart)); sessionStorage.setItem("rhodes_cart_v3",JSON.stringify(cart)); document.cookie=`cart=${btoa(JSON.stringify(cart))}; Max-Age=1800; Path=/; SameSite=Lax`; }catch{}
  const comentarios=(document.getElementById("inpComentarios").value||"").trim();

  if(pago==="efectivo"){
    const lines=[`*Pedido #${nro}*`,`Cliente: ${nombre}`,`Papas: ${fries==="con_sazon"?"Con sazón":"Sin sazonar"}`,""];
    for(const o of Object.values(cart.burger)) lines.push(`• ${o.qty}× ${o.item.name}`);
    for(const d of Object.values(cart.drink))  lines.push(`• ${d.qty}× ${d.item.name}`);
    if(comentarios) lines.push("",`Comentarios: ${comentarios}`);
    lines.push("",`Total: ${totalEl.textContent}`);
    const phone="541170596483";
    location.href=`https://wa.me/${phone}?text=${encodeURIComponent(lines.join("\n"))}`;
    return;
  }

  // MP (mismo flujo que ya tenías)
  alert("Flujo de Mercado Pago: verificar función createPreference en Netlify (usa init_point).");
};

render();
</script>
</body>
</html>
