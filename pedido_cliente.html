<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirmar pedido ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{ --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea; }
    *{box-sizing:border-box}
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    
    #pageLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000000; z-index: 99999; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease, visibility 0.5s; }
    #pageLoader.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    #pageLoader video { width: 250px; max-width: 90%; height: auto; object-fit: contain; mix-blend-mode: screen; }
    
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:1100px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand{ display:flex; align-items:center; text-decoration:none; color:inherit; font-weight:700 }
    .brand img{ width:36px;height:36px; border-radius:10px; background:#fff; object-fit:contain;margin-right:8px }
    .spacer{flex:1}
    
    .btn{ display:inline-flex; align-items:center; gap:8px; border:2px solid var(--primary); background:#fff; color:var(--primary); padding:10px 16px; border-radius:999px; font-weight:700; cursor:pointer; text-decoration:none }
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .btn.small{padding:6px 10px;border-radius:8px;font-size:14px}
    .btn:disabled{opacity:0.6; cursor:not-allowed}

    main{ max-width:1100px; margin:24px auto; padding:0 12px; display:grid; grid-template-columns:1fr 420px; gap:18px }
    @media(max-width:900px){main{grid-template-columns:1fr}}
    
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px }
    h1{font-size:32px;margin:10px 0 18px}
    label{font-weight:600;margin:6px 0;display:block}
    input[type=text], textarea { width:100%; padding:12px; border:1px solid var(--ring); border-radius:12px; font-size: 15px; background: #fff; font-family: inherit; }
    .group{margin:14px 0}
    
    /* SLOTS */
    .carousel{display:flex;align-items:center;gap:12px;margin-top:8px}
    .arrow{ width:44px;height:44px; border-radius:10px; border:1px solid var(--ring); display:inline-grid; place-items:center; cursor:pointer; background:#fff }
    .slot-display{ min-width:200px; padding:10px 14px; border-radius:10px; background:#fff; border:1px solid var(--ring); text-align:center; font-weight:800 }
    .slot-sub{font-size:13px;color:var(--muted);margin-top:6px}
    .no-slots{color:#b00020;font-weight:700}
    
    .resumen-item { border-bottom: 1px dashed #eee; padding: 10px 0; font-size: 14px; }
    .resumen-item:last-child { border-bottom: none; }
  </style>
</head>

<body>

<div id="pageLoader"><video autoplay loop muted playsinline><source src="images/loader.mp4" type="video/mp4"><img src="images/logo.png" alt="Cargando..." style="width:100px;"></video></div>

<header>
  <div class="topbar">
    <a class="brand" href="index.html"><img src="images/logo.png"/>Rhodes Burgers</a>
    <div class="spacer"></div>
    <a class="btn ghost" href="index.html">‚Üê Volver</a>
  </div>
</header>

<main>
<section class="card">
  <h1>Confirmar pedido</h1>
  
  <div class="group"><label>Nombre y apellido</label><input id="inpNombre" type="text" placeholder="Ej: Juan P√©rez"/></div>
  <div class="group"><label>Tel√©fono (opcional)</label><input id="inpTelefono" type="text" placeholder="Para contactarte si es necesario"/></div>
  
  <div class="group">
    <label>Medio de pago</label>
    <div style="background-color: #fff8e1; border: 1px solid #ffe0b2; color: #e65100; padding: 14px; border-radius: 12px; text-align: center; font-weight: 800; font-size: 15px;">
      üíµ Abon√°s en el local al retirar
    </div>
  </div>

  <div class="group">
    <label>Horario de retiro (hoy)</label>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="carousel" id="slotsCarousel">
        <div id="slotPrev" class="arrow">‚óÄ</div>
        <div id="slotLabel" class="slot-display">Cargando‚Ä¶</div>
        <div id="slotNext" class="arrow">‚ñ∂</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;margin-left:8px">
        <button id="btnRefreshSlots" class="btn ghost small">üîÅ</button>
      </div>
    </div>
    <div id="slotNote" class="slot-sub">Cargando turnos...</div>
  </div>

  <div class="group"><label>Notas (opcional)</label><textarea id="inpNotas" placeholder="Aclaraciones..."></textarea></div>
  
  <div class="group" style="border-top: 1px dashed var(--ring); padding-top: 14px;">
    <label>Cup√≥n de descuento</label>
    <div style="display:flex; gap:8px;">
        <input id="inpCupon" type="text" placeholder="C√ìDIGO" style="text-transform:uppercase; letter-spacing:1px; font-weight:700;">
        <button id="btnAplicarCupon" class="btn ghost small">Aplicar</button>
    </div>
    <div id="msgCupon" style="font-size:13px; margin-top:5px; color:#666"></div>
  </div>

  <div style="margin-top:20px; text-align:right">
      <button id="btnConfirmar" class="btn primary" style="width:100%; justify-content:center; padding:15px; font-size:16px">Confirmar y Enviar</button>
  </div>
</section>

<aside class="card">
    <h3>Resumen</h3>
    <div id="resumenList"></div>
    <div style="display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:1px solid #eee;font-size:18px">
        <strong>Total</strong><strong id="resTotal">$0</strong>
    </div>
</aside>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// CONFIG
const firebaseConfig={apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const CART_KEY = "rhodes_cart_v5";
const WHATSAPP_NUMBER = "543484346113"; 

// Configuraci√≥n de Slots
const GRAMOS_POR_BLOQUE = 1500;
const G_POR_BURGER = 200;
const G_POR_SIDE = 350; 
const SLOT_START = "19:15"; 
const SLOT_END = "23:45"; 
const SLOT_INTERVAL_MIN = 15;

// Variables Globales
let activeDiscount = 0; 
let activeCouponCode = "";
let slotObjects=[], visibles=[], currentIndex=0;
let listeners=[];

// Helpers
const $ = s => document.querySelector(s);
const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});
function parseHHMM(str){ const [h,m]=str.split(":").map(Number); const now=new Date(); return new Date(now.getFullYear(),now.getMonth(),now.getDate(),h,m,0); }
function slotKey(date){ const y=date.getFullYear(); const M=String(date.getMonth()+1).padStart(2,"0"); const d=String(date.getDate()).padStart(2,"0"); const H=String(date.getHours()).padStart(2,"0"); const m=String(date.getMinutes()).padStart(2,"0"); return `${y}${M}${d}_${H}${m}`; }
function formatHHMM(date){ return date.toLocaleTimeString("es-AR",{hour:"2-digit",minute:"2-digit",hour12:false}); }
function generateToken() { return Math.random().toString(36).substr(2) + Date.now().toString(36); }

// --- 1. CARGA DEL CARRITO (ADAPTADO AL FORMATO MOSTRADOR) ---
function loadCart() { 
    try { 
        const raw = JSON.parse(localStorage.getItem(CART_KEY));
        if(!raw) return { items: [] };

        // Si ya es un array plano (formato viejo)
        if(Array.isArray(raw.items)) return raw;

        // Si viene del nuevo formato dividido (burger, side, drink) lo aplanamos
        let flatItems = [];
        const processCategory = (categoryObj, typeStr) => {
            if(!categoryObj) return;
            for(let id in categoryObj) {
                const item = categoryObj[id];
                flatItems.push({
                    id: item.item.id,
                    name: item.item.name,
                    price: Number(item.item.price),
                    category: item.item.category,
                    qty: item.qty,
                    fries: item.fries,
                    friesRaw: item.friesRaw,
                    sideType: item.sideType,
                    extras: item.extras || {},
                    notes: item.notes,
                    finalPrice: item.finalPrice,
                    type: typeStr
                });
            }
        };

        processCategory(raw.burger, 'burger');
        processCategory(raw.side, 'side');
        processCategory(raw.drink, 'drink');

        return { items: flatItems };
    } catch { 
        return { items: [] }; 
    } 
}

function renderResumen() {
    const cart = loadCart();
    const div = $("#resumenList");
    div.innerHTML = "";
    let subtotal = 0;

    if(cart.items.length === 0) {
        div.innerHTML = "<div class='muted'>Carrito vac√≠o</div>";
        $("#resTotal").textContent = "$0";
        return;
    }

    cart.items.forEach(item => {
        const itemTotal = item.finalPrice * item.qty;
        subtotal += itemTotal;
        
        let details = [];
        
        // Mostrar la guarnici√≥n 
        if (item.fries) {
            details.push("üçü " + item.fries);
        }
        
        // Mostrar extras si existen
        if(item.extras) {
            if(item.extras.patty) details.push(`+${item.extras.patty} Carne`);
            if(item.extras.cheddar) details.push(`+${item.extras.cheddar} Cheddar`);
        }
        
        if (item.type === 'drink') details.push("Bebida");
        
        div.innerHTML += `
            <div class="resumen-item">
                <div style="font-weight:700">${item.qty}x ${item.name}</div>
                <div style="font-size:12px; color:#666">${details.join(" ‚Ä¢ ")}</div>
                <div style="text-align:right">${money(itemTotal)}</div>
            </div>
        `;
    });

    let final = subtotal - activeDiscount;
    if(final < 0) final = 0;

    if(activeDiscount > 0) {
        div.innerHTML += `<div style="color:#16a34a; font-weight:700; margin-top:5px">Descuento (${activeCouponCode}): -${money(activeDiscount)}</div>`;
    }

    $("#resTotal").textContent = money(final);
    return final;
}

// --- 2. C√ÅLCULO DE PESO PARA SLOTS ---
function calculateWeight() {
    const cart = loadCart();
    let grams = 0;
    cart.items.forEach(item => {
        //
        const cat = (item.category || "").toLowerCase();
        if (cat.includes('burger') || cat.includes('hamburguesa') || cat.includes('sandwich')) {
            grams += (item.qty * G_POR_BURGER);
        } else if (cat.includes('guarnicion') || cat.includes('side') || cat.includes('papas')) {
            grams += (item.qty * G_POR_SIDE);
        }
    });
    return grams;
}

// --- 3. L√ìGICA DE TURNOS (SLOTS) ---
function limpiarListeners(){ listeners.forEach(u=>{try{u()}catch{}}); listeners=[]; }

async function cargarSlots(){
  limpiarListeners();
  const slots=[]; let cur=new Date(parseHHMM(SLOT_START)); const end=parseHHMM(SLOT_END);
  while(cur<=end){ slots.push(new Date(cur)); cur=new Date(cur.getTime()+SLOT_INTERVAL_MIN*60000); }
  
  slotObjects=slots.map(d=>({date:d, key:slotKey(d), gramsUsed:0, full:false}));
  $("#slotLabel").textContent="Cargando‚Ä¶";
  
  slotObjects.forEach(s=>{
    const ref=db.collection("slots_grams").doc(s.key);
    const unsub=ref.onSnapshot(doc=>{
      if(!doc.exists) ref.set({gramsUsed:0},{merge:true});
      const data=doc.data()||{}; 
      s.gramsUsed=Number(data.gramsUsed||0); 
      reconstruirVisibles();
    });
    listeners.push(unsub);
  });
}

function reconstruirVisibles(){
  const pedidoGramos = calculateWeight();
  const now = new Date();
  // Solo mostramos turnos desde dentro de 20 min
  const cutoff = new Date(now.getTime() + 20*60000);

  visibles = slotObjects.filter(s => {
    // 1. Que sea futuro
    if(s.date < cutoff) return false;
    // 2. Que tenga espacio
    const restante = GRAMOS_POR_BLOQUE - s.gramsUsed;
    if(pedidoGramos > GRAMOS_POR_BLOQUE) return true; // Si el pedido es gigante, lo dejamos pasar (excepci√≥n)
    return restante >= pedidoGramos;
  });

  if(visibles.length===0) currentIndex=-1; 
  else if(currentIndex >= visibles.length) currentIndex=0;
  
  actualizarUI();
}

function actualizarUI(){
  const label=$("#slotLabel"), car=$("#slotsCarousel");
  if(visibles.length===0){ 
      label.innerHTML="<div class='no-slots'>Lleno / Cerrado</div>"; 
      car.selectedSlot=null; 
      return; 
  }
  const s=visibles[currentIndex];
  label.textContent = formatHHMM(s.date); 
  $("#slotNote").textContent = "Turnos disponibles";
  car.selectedSlot = { key:s.key, pretty:formatHHMM(s.date) };
}

$("#slotPrev").onclick=()=>{if(currentIndex>0){currentIndex--;actualizarUI()}};
$("#slotNext").onclick=()=>{if(currentIndex<visibles.length-1){currentIndex++;actualizarUI()}};
$("#btnRefreshSlots").onclick=cargarSlots;

// --- 4. CUPONES ---
$("#btnAplicarCupon").onclick = async () => {
    const code = $("#inpCupon").value.trim().toUpperCase();
    const msg = $("#msgCupon");
    if(!code) return;
    
    $("#btnAplicarCupon").textContent = "...";
    try {
        const snap = await db.collection('coupons').where('code', '==', code).where('enabled', '==', true).get();
        if(snap.empty) {
            msg.textContent = "‚ùå Cup√≥n no v√°lido"; msg.style.color = "red";
            activeDiscount = 0; activeCouponCode = "";
        } else {
            const d = snap.docs[0].data();
            activeDiscount = Number(d.value);
            activeCouponCode = code;
            msg.textContent = `‚úÖ Cup√≥n aplicado: -$${activeDiscount}`; msg.style.color = "green";
        }
    } catch(e) { console.error(e); }
    $("#btnAplicarCupon").textContent = "Aplicar";
    renderResumen();
};

// --- 5. CONFIRMAR Y ENVIAR ---
async function reservarSlot(horaKey, peso) {
    // Transacci√≥n simple para sumar peso al slot
    const ref = db.collection("slots_grams").doc(horaKey);
    await db.runTransaction(async (t) => {
        const doc = await t.get(ref);
        const actual = doc.exists ? (doc.data().gramsUsed || 0) : 0;
        if (actual + peso > GRAMOS_POR_BLOQUE && peso < GRAMOS_POR_BLOQUE) {
            throw "El turno se acaba de llenar. Por favor eleg√≠ otro.";
        }
        t.set(ref, { gramsUsed: actual + peso }, { merge: true });
    });
}

async function getNextOrderNumber() {
    const ref = db.collection("config").doc("counters");
    let next = 1;
    await db.runTransaction(async (t) => {
        const doc = await t.get(ref);
        const current = doc.exists ? (doc.data().orderNumber || 0) : 0;
        next = current + 1;
        t.set(ref, { orderNumber: next }, { merge: true });
    });
    return next;
}

$("#btnConfirmar").onclick = async () => {
    const btn = $("#btnConfirmar");
    const nombre = $("#inpNombre").value.trim();
    const tel = $("#inpTelefono").value.trim();
    const notas = $("#inpNotas").value.trim();
    const slot = $("#slotsCarousel").selectedSlot;
    const cart = loadCart();

    if(cart.items.length === 0) return alert("El carrito est√° vac√≠o");
    if(!nombre) return alert("Por favor escrib√≠ tu nombre");
    if(!slot) return alert("Por favor eleg√≠ un horario de retiro");

    btn.disabled = true; btn.textContent = "Procesando...";

    try {
        // 1. Reservar Slot
        await reservarSlot(slot.key, calculateWeight());
        
        // 2. Obtener numero de orden
        const orderNum = await getNextOrderNumber();
        const trackToken = generateToken();
        const finalTotal = renderResumen(); // Recalcula el total final con descuento
        
        // 3. Crear Objeto Pedido (Compatible con Gerencia)
        const now = new Date();
        const localDate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)); 
        const localISO = localDate.toISOString().slice(0, -1);

        const orderData = {
            orderNumber: orderNum,
            nombre: nombre,
            telefono: tel,
            source: "web", // Para que Gerencia sepa que es web
            entrega: "take_away",
            pago: "local", // A abonar en el local
            payment_status: "pending",
            status: "accepted",
            createdAt: localISO,
            total: finalTotal,
            subtotal: finalTotal + activeDiscount,
            discount: activeDiscount,
            coupon: activeCouponCode,
            pickup_slot: slot.key,
            pickup_time_pretty: slot.pretty,
            trackToken: trackToken,
            items: cart.items // Guardamos la lista aplanada para compatibilidad
        };

        // 4. Guardar en Firebase
        const docRef = await db.collection("orders").add(orderData);
        
        // 5. Guardar tracking p√∫blico
        await db.collection("order_public").doc(trackToken).set({
            orderNumber: orderNum, nombre, status: "accepted", updatedAt: localISO
        });

        // 6. Generar Texto WhatsApp
        let msg = `*NUEVO PEDIDO WEB #${orderNum}*\n`;
        msg += `üë§ Cliente: ${nombre}\n`;
        msg += `üïí Retiro: ${slot.pretty}\n`;
        msg += `--------------------------------\n`;
        
        cart.items.forEach(i => {
            msg += `${i.qty}x *${i.name}*\n`;
            
            if (i.fries) msg += `   üçü ${i.fries}\n`;
            
            if(i.extras) {
                if(i.extras.patty) msg += `   ü•© +${i.extras.patty} Carne\n`;
                if(i.extras.cheddar) msg += `   üßÄ +${i.extras.cheddar} Cheddar\n`;
            }
            if(i.notes) msg += `   üìù ${i.notes}\n`;
        });
        
        if(activeDiscount > 0) msg += `üè∑Ô∏è Cup√≥n: -$${activeDiscount}\n`;
        msg += `--------------------------------\n`;
        msg += `*TOTAL A PAGAR: $${money(finalTotal)}*\n`;
        msg += `(Abona en el local)\n\n`;
        
        // Link de seguimiento
        let baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
        const trackLink = `${baseUrl}/gracias.html?id=${docRef.id}&t=${trackToken}`;
        msg += `üîó Segu√≠ tu pedido aqu√≠:\n${trackLink}`;

        // 7. Finalizar
        localStorage.removeItem(CART_KEY); // Borrar carrito
        localStorage.setItem('rb_user_name', nombre); // Recordar usuario
        if(tel) localStorage.setItem('rb_user_phone', tel);

        // Abrir WhatsApp y redirigir
        window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
        setTimeout(() => { window.location.href = trackLink; }, 1000);

    } catch (err) {
        console.error(err);
        alert("Error al procesar: " + err);
        btn.disabled = false; btn.textContent = "Confirmar Pedido";
        cargarSlots(); // Recargar por si el slot se llen√≥
    }
};

// INICIO
window.addEventListener("DOMContentLoaded", () => {
    cargarSlots();
    renderResumen();
    // Autocompletar datos guardados
    const savedName = localStorage.getItem('rb_user_name');
    const savedPhone = localStorage.getItem('rb_user_phone');
    if(savedName) $("#inpNombre").value = savedName;
    if(savedPhone) $("#inpTelefono").value = savedPhone;
    
    // Quitar loader
    setTimeout(() => { 
        const l = document.getElementById("pageLoader");
        if(l) { l.classList.add("hidden"); setTimeout(()=>l.remove(), 500); } 
    }, 1000);
});
</script>
</body>
</html>
