<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rhodes Burgers - Confirmar pedido</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08) }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif }
    body::before{ content:""; position:fixed; inset:0; background:url("images/logo.png") center 120px/320px no-repeat; opacity:.06; pointer-events:none; z-index:0; filter:grayscale(100%) }
    header{ position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06) }
    .topbar{ max-width:900px; margin:0 auto; padding:10px 12px; display:flex; align-items:center; gap:12px }
    .brand img{ width:40px; height:40px; border-radius:10px; background:#fff; object-fit:contain }
    .spacer{ flex:1 }
    .btn{ display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary); padding:10px 16px; border-radius:999px; color:var(--primary); background:#fff; font-weight:700; text-decoration:none; cursor:pointer }
    .btn.primary{ background:var(--primary); color:#fff }
    .btn.ghost{ border-color:#e7e7e7; color:#333 }
    .container{ max-width:900px; margin:24px auto; padding:0 12px }
    h1{ font-size:34px; margin:14px 4px 18px }
    .grid{ display:grid; grid-template-columns:2fr 1fr; gap:16px }
    .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px }
    .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0 }
    .field input{ padding:10px 12px; border:1px solid #e7e7e7; border-radius:12px }
    .inline{ display:flex; gap:12px; flex-wrap:wrap; margin:8px 0 }
    .pill{ display:inline-flex; align-items:center; gap:8px; border:1px solid #e7e7e7; border-radius:999px; padding:8px 12px }
    .item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid #efefef }
    .muted{ color:var(--muted); font-size:14px }
    .total{ display:flex; align-items:center; justify-content:space-between; font-weight:800; font-size:18px; margin-top:10px }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a href="index.html" class="brand"><img src="images/logo.png" alt="Rhodes Burgers"></a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">← Seguir comprando</a>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Confirmar pedido</h1>
      <div class="grid">
        <!-- Columna izquierda: datos -->
        <div class="card">
          <div class="field">
            <label>Nombre y apellido</label>
            <input id="inpNombre" placeholder="Ej: Juan Pérez" autocomplete="name" />
          </div>

          <div class="inline">
            <label class="pill"><input type="radio" name="pago" value="mercado_pago"> Mercado Pago</label>
            <label class="pill"><input type="radio" name="pago" value="efectivo"> Efectivo</label>
          </div>

          <!-- Sin Delivery: solo Take Away -->
          <div class="inline" style="margin-top:8px">
            <label class="pill"><input type="radio" name="entrega" value="take_away" checked> Take Away</label>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Papas (obligatorio)</label>
            <div class="inline">
              <label class="pill"><input type="radio" name="papas" value="con_sazon"> Con sazón</label>
              <label class="pill"><input type="radio" name="papas" value="sin_sazon"> Sin sazonar</label>
            </div>
            <div class="muted">Se toma lo que elegiste en el menú; si querés, podés cambiarlo acá.</div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn" id="btnCancelar">Cancelar</button>
            <button class="btn primary" id="btnConfirmar">Ir a pagar</button>
          </div>
          <p class="muted" id="status" style="margin-top:8px"></p>
        </div>

        <!-- Columna derecha: resumen -->
        <div class="card">
          <h3>Resumen</h3>
          <div id="items"></div>
          <div class="total"><span>Total</span><span id="total">$0</span></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script>
    // ===== CARRITO / UI =====
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const CART_KEY = "rhodes_cart_v3";

    function loadCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)) || {burger:{},drink:{},fries:null}; }catch{ return {burger:{},drink:{},fries:null}; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); }
    function clearCart(){ saveCart({burger:{},drink:{},fries:null}); }
    function cartCount(c){ let n=0; for(const b of Object.values(c.burger)) n+=b.qty; for(const d of Object.values(c.drink)) n+=d.qty; return n; }
    function calcTotal(c){ let t=0; for(const b of Object.values(c.burger)) t+=(Number(b.item?.price)||0)*b.qty; for(const d of Object.values(c.drink)) t+=(Number(d.item?.price)||0)*d.qty; return t; }

    let cart = loadCart();

    const itemsEl = $("#items");
    const totalEl = $("#total");
    const statusEl = $("#status");
    const inpNombre = $("#inpNombre");
    const btnConfirmar = $("#btnConfirmar");

    // Preseleccionar papas si venía de index
    (function preselectFries(){
      if(cart.fries){
        const r = document.querySelector(`input[name="papas"][value="${cart.fries}"]`);
        if(r) r.checked = true;
      }
    })();

    function renderResumen(){
      const rows=[];
      for(const obj of Object.values(cart.burger)){
        rows.push(`<div class="item"><div><strong>${obj.item.name}</strong>${obj.notes?`<div class="muted">Notas: ${obj.notes}</div>`:""}<div class="muted">${money(obj.item.price)} x ${obj.qty}</div></div><div>${money((Number(obj.item.price)||0)*obj.qty)}</div></div>`);
      }
      for(const obj of Object.values(cart.drink)){
        rows.push(`<div class="item"><div><strong>${obj.item.name}</strong><div class="muted">${money(obj.item.price)} x ${obj.qty}</div></div><div>${money((Number(obj.item.price)||0)*obj.qty)}</div></div>`);
      }
      itemsEl.innerHTML = rows.join("") || `<p class="muted">No hay productos en el carrito.</p>`;
      totalEl.textContent = money(calcTotal(cart));
    }

    // Etiquetas
    const friesLabel = v => v==="con_sazon" ? "Con sazón" : v==="sin_sazon" ? "Sin sazonar" : "—";

    // Mensaje WhatsApp
    function buildWhatsappMessage(orderNumber, nombre, fries, items, total){
      const lines = [];
      lines.push(`*Rhodes Burgers*`);
      lines.push(`*Pedido #${orderNumber}*`);
      lines.push(`Nombre: ${nombre}`);
      lines.push(`Retiro: Take Away`);
      lines.push(`Papas: ${friesLabel(fries)}`);
      lines.push(``);
      lines.push(`*Items:*`);
      for(const it of items){
        const unit = Number(it.price)||0;
        lines.push(`- ${it.qty}× ${it.name}${it.notes?` — ${it.notes}`:""} (${money(unit)})`);
      }
      lines.push(``);
      lines.push(`*Total:* ${money(total)}`);
      lines.push(`*Pago:* Efectivo`);
      lines.push(``);
      lines.push(`¡Gracias!`);
      return lines.join("\n");
    }

    // Contador atómico para orderNumber
    async function getNextOrderNumber(){
      const ref = db.collection("meta").doc("order_counter");
      const next = await db.runTransaction(async tx=>{
        const snap = await tx.get(ref);
        const cur = snap.exists ? (snap.data().value||0) : 0;
        const n = cur + 1;
        tx.set(ref, { value: n }, { merge: true });
        return n;
      });
      return next;
    }

    $("#btnCancelar").onclick = ()=> { window.location.href = "index.html"; };

    btnConfirmar.onclick = async ()=>{
      if(cartCount(cart)===0){ alert("Tu carrito está vacío."); return; }
      const nombre = inpNombre.value.trim();
      if(!nombre){ alert("Ingresá tu nombre y apellido."); return; }
      const pagoEl = document.querySelector('input[name="pago"]:checked');
      if(!pagoEl){ alert("Elegí un método de pago."); return; }
      const papasEl = document.querySelector('input[name="papas"]:checked');
      if(!papasEl){ alert("Elegí una opción de papas (obligatorio)."); return; }

      // Guardamos papas si se cambió acá
      cart.fries = papasEl.value;
      saveCart(cart);

      // Ítems para guardar / MP
      const itemsFS=[], mpItems=[];
      for(const o of Object.values(cart.burger)){
        itemsFS.push({type:"burger", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0, ...(o.notes?{notes:o.notes}:{})});
        mpItems.push({title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0});
      }
      for(const o of Object.values(cart.drink)){
        itemsFS.push({type:"drink", id:o.item.id, name:o.item.name, qty:o.qty, price:Number(o.item.price)||0});
        mpItems.push({title:o.item.name, quantity:Number(o.qty)||1, currency_id:"ARS", unit_price:Number(o.item.price)||0});
      }

      const total = calcTotal(cart);

      try{
        btnConfirmar.disabled = true;
        statusEl.textContent = "Generando número de pedido...";
        const orderNumber = await getNextOrderNumber();

        const order = {
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          orderNumber,          // Número de pedido
          nombre,
          pago: pagoEl.value,   // campo original
          metodoPago: pagoEl.value, // alias para el panel
          entrega: "take_away", // sin delivery
          direccion: "",
          fries: cart.fries,
          items: itemsFS,
          total,
          status: "accepted"
        };

        statusEl.textContent = "Guardando pedido...";
        const docRef = await db.collection("pedidos").add(order); // <<< colección 'pedidos'

        if (order.pago === "mercado_pago") {
          // Mercado Pago (Netlify Function)
          const valid = mpItems.filter(x => x.quantity>0 && Number.isFinite(x.unit_price) && x.unit_price>0);
          const payloadItems = valid.length ? valid : [{ title:`Pedido #${orderNumber}`, quantity:1, currency_id:"ARS", unit_price:Number(order.total)||0 }];

          const resp = await fetch("/.netlify/functions/createPreference", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ orderId: docRef.id, orderNumber, total: Number(order.total)||0, nombre: order.nombre, items: payloadItems })
          });

          const raw = await resp.text(); let data={}; try{ data=JSON.parse(raw) }catch{ data={raw} }
          if(!resp.ok){ console.error("MP error", resp.status, data); alert(`Error MP ${resp.status}: ${data.error||data.raw||"sin detalle"}`); btnConfirmar.disabled=false; return; }

          const url = data.init_point || data.sandbox_init_point;
          if(!url){ alert("Preferencia MP creada sin URL. Revisá el Access Token en Netlify."); btnConfirmar.disabled=false; return; }

          clearCart();
          window.location.href = url;
          return;
        }

        // EFECTIVO → WhatsApp
        const phone = "541170596483"; // número de la hamburguesería
        const msg = buildWhatsappMessage(orderNumber, nombre, cart.fries, itemsFS, total);
        const wa = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;

        clearCart();
        window.location.href = wa;

      }catch(err){
        console.error(err);
        alert("No pudimos guardar el pedido. Revisá Firestore o la conexión.");
      }finally{
        btnConfirmar.disabled = false;
      }
    };

    // Inicio
    (function init(){ renderResumen(); })();
  </script>
</body>
</html>
