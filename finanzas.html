<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Finanzas ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; 
      --text: #1f2937; 
      --bg: #f3f4f6; 
      --card: #ffffff;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --ring: #e5e7eb;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 40px; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--ring); position: sticky; top: 0; z-index: 10; }
    .topbar { max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-btn { padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #4b5563; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .nav-btn:hover { background: #f9fafb; }
    .nav-btn.active { background: var(--primary); color: #fff; }

    /* LAYOUT */
    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
    
    /* FILTROS */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    select, input[type=month] { padding: 10px; border-radius: 8px; border: 1px solid var(--ring); font-size: 14px; background: #fff; }
    
    /* KPI CARDS */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .kpi-card { background: var(--card); padding: 20px; border-radius: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid var(--ring); }
    .kpi-title { font-size: 13px; color: #6b7280; font-weight: 600; text-transform: uppercase; margin-bottom: 5px; }
    .kpi-value { font-size: 28px; font-weight: 800; color: var(--text); }
    .kpi-sub { font-size: 13px; margin-top: 5px; font-weight: 500; }
    .text-green { color: var(--success); }
    .text-red { color: var(--danger); }
    .text-blue { color: #3b82f6; }

    /* SECCIONES PRINCIPALES */
    .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
    @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

    .section-card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid var(--ring); margin-bottom: 20px; }
    h2 { margin-top: 0; font-size: 18px; color: var(--primary); border-bottom: 1px solid var(--ring); padding-bottom: 10px; margin-bottom: 15px; }

    /* FORMULARIOS */
    .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
    input[type=text], input[type=number] { flex: 1; padding: 10px; border: 1px solid var(--ring); border-radius: 8px; }
    .btn { border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-danger { background: #fee2e2; color: #ef4444; padding: 4px 10px; font-size: 12px; }
    
    /* TABLA GASTOS */
    .expense-list { max-height: 300px; overflow-y: auto; }
    .expense-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--ring); }
    .expense-info { display: flex; flex-direction: column; }
    .expense-date { font-size: 11px; color: #9ca3af; }

    /* SETTINGS BOX */
    .settings-box { background: #f9fafb; padding: 15px; border-radius: 12px; border: 1px solid var(--ring); margin-bottom: 20px; }
    .settings-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .settings-row label { font-size: 14px; font-weight: 600; color: #4b5563; }
    .settings-row input { width: 80px; text-align: right; }

  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <header>
    <div class="topbar">
      <a class="brand" href="index.html">Rhodes Burgers</a>
      <div style="display:flex; gap:10px">
        <a href="pedido_local.html" class="nav-btn">üì¶ Pedidos</a>
        <a href="#" class="nav-btn active">üìà Finanzas</a>
        <a href="admin.html" class="nav-btn">‚öôÔ∏è Admin</a>
      </div>
    </div>
  </header>

  <div class="container">
    
    <div class="filter-bar">
      <h1 style="margin:0; margin-right:20px;">Balance</h1>
      <input type="month" id="monthFilter">
      <button onclick="loadFinances()" class="btn btn-primary">Actualizar</button>
    </div>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-title">Ventas Brutas</div>
        <div class="kpi-value text-blue" id="kpiGross">$ 0</div>
        <div class="kpi-sub" id="kpiOrders">0 pedidos</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Costos Totales</div>
        <div class="kpi-value text-red" id="kpiCosts">$ 0</div>
        <div class="kpi-sub">Comisiones + Insumos + Gastos</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-title">Ganancia Neta</div>
        <div class="kpi-value text-green" id="kpiNet">$ 0</div>
        <div class="kpi-sub" id="kpiMargin">0% Margen</div>
      </div>
    </div>

    <div class="main-grid">
      
      <div>
        <div class="section-card">
          <h2>Distribuci√≥n de Ingresos</h2>
          <div style="height: 250px; position: relative;">
            <canvas id="financeChart"></canvas>
          </div>
        </div>

        <div class="section-card">
          <h2>Historial de Gastos Fijos</h2>
          <div class="form-row">
            <input type="text" id="exDesc" placeholder="Descripci√≥n (ej: Monotributo)">
            <input type="number" id="exAmount" placeholder="Monto ($)">
            <button onclick="addManualExpense()" class="btn btn-primary">+</button>
          </div>
          <div id="expensesList" class="expense-list">
            </div>
        </div>
      </div>

      <div>
        <div class="section-card">
          <h2>Costos Variables (Autom√°ticos)</h2>
          <p style="font-size:13px; color:#666; margin-bottom:15px">
            El sistema calcular√° estos costos autom√°ticamente bas√°ndose en tus pedidos cargados.
          </p>

          <div class="settings-box">
            <div class="settings-row">
              <label>Comisi√≥n PedidosYa (%)</label>
              <input type="number" id="confPyPercent" value="30">
            </div>
            <div style="font-size:11px; color:#ef4444; margin-bottom:15px; text-align:right">
              Se descuenta solo de pedidos con origen "PedidosYa".
            </div>

            <div class="settings-row">
              <label>Costo Packaging ($/u)</label>
              <input type="number" id="confPackCost" value="400">
            </div>
            <div style="font-size:11px; color:#ef4444; margin-bottom:10px; text-align:right">
              Se multiplica por la cantidad total de pedidos.
            </div>

            <button onclick="saveConfig()" class="btn btn-primary" style="width:100%">Guardar Configuraci√≥n</button>
          </div>

          <div class="section-card" style="background:#f0fdf4; border-color:#bbf7d0">
            <h3 style="margin:0; font-size:16px; color:#166534">Resumen Costos</h3>
            <div style="margin-top:10px; font-size:14px;">
              <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                <span>Comisiones PY:</span>
                <strong id="sumPyCom">$ 0</strong>
              </div>
              <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                <span>Packaging Total:</span>
                <strong id="sumPackaging">$ 0</strong>
              </div>
              <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                <span>Gastos Fijos:</span>
                <strong id="sumFixed">$ 0</strong>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});

    // --- VARIABLES ---
    let myChart = null;
    let currentOrders = [];
    let currentExpenses = [];
    
    // Config Default
    let config = { pyPercent: 30, packCost: 400 };

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        document.getElementById('monthFilter').value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
        
        loadConfig(); // Cargar % y Costos fijos
    });

    function loadConfig() {
        db.collection('config').doc('financials').get().then(doc => {
            if(doc.exists) {
                config = doc.data();
                document.getElementById('confPyPercent').value = config.pyPercent || 30;
                document.getElementById('confPackCost').value = config.packCost || 400;
            }
            loadFinances();
        });
    }

    function saveConfig() {
        const py = Number(document.getElementById('confPyPercent').value);
        const pack = Number(document.getElementById('confPackCost').value);
        
        db.collection('config').doc('financials').set({
            pyPercent: py,
            packCost: pack
        }, {merge:true}).then(() => {
            config = { pyPercent: py, packCost: pack };
            alert("‚úÖ Configuraci√≥n guardada. Recalculando...");
            calculateData();
        });
    }

    function loadFinances() {
        const monthInput = document.getElementById('monthFilter').value;
        if(!monthInput) return;
        
        const [year, month] = monthInput.split('-');
        const start = new Date(year, month - 1, 1).toISOString();
        const end = new Date(year, month, 1).toISOString();

        // 1. Cargar Pedidos del Mes (Solo entregados o pagados)
        // Nota: Para simplificar y ver todo, traemos todos y filtramos en JS si queremos
        db.collection('orders')
          .where('createdAt', '>=', start)
          .where('createdAt', '<', end)
          .get().then(snap => {
              currentOrders = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled');
              
              // 2. Cargar Gastos Manuales del Mes
              db.collection('expenses')
                .where('date', '>=', start)
                .where('date', '<', end)
                .onSnapshot(expSnap => {
                    currentExpenses = expSnap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderExpensesList();
                    calculateData();
                });
          });
    }

    function calculateData() {
        // A. INGRESOS BRUTOS
        let grossIncome = 0;
        let pyIncome = 0;
        let totalOrdersCount = currentOrders.length;

        currentOrders.forEach(o => {
            const total = Number(o.total) || 0;
            grossIncome += total;
            // Detectar si es de PedidosYa
            if(o.source === 'pedidosya') {
                pyIncome += total;
            }
        });

        // B. COSTOS VARIABLES (Autom√°ticos)
        const pyCommissionRate = (config.pyPercent || 0) / 100;
        const pyCost = pyIncome * pyCommissionRate;
        const packagingCost = totalOrdersCount * (config.packCost || 0);

        // C. GASTOS FIJOS (Manuales)
        let fixedCosts = 0;
        currentExpenses.forEach(e => fixedCosts += (Number(e.amount)||0));

        // D. TOTALES
        const totalCosts = pyCost + packagingCost + fixedCosts;
        const netProfit = grossIncome - totalCosts;
        const margin = grossIncome > 0 ? ((netProfit / grossIncome) * 100).toFixed(1) : 0;

        // E. RENDER UI
        document.getElementById('kpiGross').innerText = money(grossIncome);
        document.getElementById('kpiCosts').innerText = `-${money(totalCosts)}`;
        document.getElementById('kpiNet').innerText = money(netProfit);
        
        document.getElementById('kpiOrders').innerText = `${totalOrdersCount} pedidos`;
        document.getElementById('kpiMargin').innerText = `${margin}% Margen`;

        // Resumen lateral
        document.getElementById('sumPyCom').innerText = money(pyCost);
        document.getElementById('sumPackaging').innerText = money(packagingCost);
        document.getElementById('sumFixed').innerText = money(fixedCosts);

        renderChart(grossIncome, netProfit, pyCost, packagingCost, fixedCosts);
    }

    function renderExpensesList() {
        const container = document.getElementById('expensesList');
        container.innerHTML = "";
        
        currentExpenses.sort((a,b) => new Date(b.date) - new Date(a.date));

        currentExpenses.forEach(e => {
            const date = new Date(e.date).toLocaleDateString();
            container.innerHTML += `
                <div class="expense-item">
                    <div class="expense-info">
                        <strong>${e.description}</strong>
                        <span class="expense-date">${date}</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px">
                        <span class="text-red" style="font-weight:700">-${money(e.amount)}</span>
                        <button onclick="deleteExpense('${e.id}')" class="btn btn-danger">X</button>
                    </div>
                </div>
            `;
        });
    }

    function addManualExpense() {
        const desc = document.getElementById('exDesc').value;
        const amount = Number(document.getElementById('exAmount').value);
        const dateInput = document.getElementById('monthFilter').value; // Usar mes seleccionado o hoy
        
        if(!desc || !amount) return alert("Complet√° descripci√≥n y monto");

        // Usar fecha actual si coincide con el mes, sino dia 1 del mes seleccionado
        let date = new Date().toISOString(); 
        
        db.collection('expenses').add({
            description: desc,
            amount: amount,
            date: date
        }).then(() => {
            document.getElementById('exDesc').value = "";
            document.getElementById('exAmount').value = "";
        });
    }

    function deleteExpense(id) {
        if(confirm("¬øBorrar gasto?")) {
            db.collection('expenses').doc(id).delete();
        }
    }

    function renderChart(gross, net, py, pack, fixed) {
        const ctx = document.getElementById('financeChart').getContext('2d');
        
        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Ganancia Neta', 'Comisiones PY', 'Packaging', 'Gastos Fijos'],
                datasets: [{
                    data: [net, py, pack, fixed],
                    backgroundColor: ['#10b981', '#f59e0b', '#3b82f6', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
  </script>
</body>
</html>
