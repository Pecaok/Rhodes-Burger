<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas Master ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --primary-dark:#4a4434;
      --text:#111; --muted:#666; --bg:#f4f6f8; --card:#fff;
      --radius:16px; --shadow:0 4px 20px rgba(0,0,0,0.05); --ring:#e0e0e0;
      --danger:#d32f2f; --warn:#f57c00; --success:#2e7d32;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif}
    
    /* LAYOUT & UTILS */
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .grid { display: grid; gap: 20px; }
    .card { background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding: 20px; border:1px solid rgba(0,0,0,0.02); }
    .row { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .spacer { flex:1; }
    .text-muted { color:var(--muted); font-size:0.9em; }
    h1, h2, h3 { margin:0 0 15px 0; color:#2c3e50; }
    
    /* HEADER */
    header { position:sticky; top:0; z-index:100; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-bottom:1px solid var(--ring); padding:10px 20px; }
    .topbar { max-width:1400px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; }
    .brand { font-weight:800; font-size:18px; display:flex; align-items:center; gap:10px; text-decoration:none; color:var(--text); }
    .brand img { width:32px; height:32px; border-radius:6px; }

    /* CONTROLS */
    .btn { border:none; background:#fff; border:1px solid var(--ring); padding:8px 16px; border-radius:8px; font-weight:600; cursor:pointer; transition:all .2s; color:#444; display:inline-flex; align-items:center; gap:6px; text-decoration:none;}
    .btn:hover { background:#f9f9f9; transform:translateY(-1px); }
    .btn.primary { background:var(--primary); color:#fff; border-color:var(--primary); }
    .btn.primary:hover { background:var(--primary-dark); }
    .btn.danger { background:#ffebee; color:var(--danger); border-color:#ffcdd2; }
    
    input, select { padding:8px 12px; border:1px solid var(--ring); border-radius:8px; font-family:inherit; outline:none; }
    input:focus { border-color:var(--primary); box-shadow:0 0 0 3px rgba(98,90,69,0.1); }
    label { font-size:12px; font-weight:700; color:var(--muted); display:block; margin-bottom:4px; }

    /* KPIs */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .kpi-card { background:#fff; border:1px solid var(--ring); padding:15px; border-radius:12px; display:flex; flex-direction:column; }
    .kpi-label { font-size:13px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
    .kpi-value { font-size:24px; font-weight:800; margin-top:5px; color:#2c3e50; }
    .kpi-sub { font-size:12px; margin-top:auto; padding-top:8px; color:var(--success); font-weight:600; }

    /* CHARTS */
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
    .chart-container { height: 300px; position:relative; }
    .chart-tall { height: 350px; }

    /* CALENDARIO (Estilo "Viejo" Mejorado) */
    .calendar-wrapper { overflow-x: auto; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(100px, 1fr)); gap: 8px; margin-top: 15px; }
    .cal-head { text-align:center; font-weight:bold; color:var(--muted); padding-bottom:5px; font-size:13px; }
    .cal-day { 
        background:#fff; border:1px solid var(--ring); border-radius:12px; 
        min-height:100px; padding:8px; display:flex; flex-direction:column; 
        transition:all .2s; position:relative;
    }
    .cal-day:hover:not(.empty) { transform:translateY(-3px); box-shadow:0 5px 15px rgba(0,0,0,0.08); border-color:var(--primary); z-index:2; }
    .cal-day.empty { background:transparent; border:none; }
    .cal-num { font-weight:700; color:#ccc; font-size:14px; margin-bottom:4px; text-align:right; }
    .cal-content { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; }
    .cal-hero { font-size:16px; font-weight:800; color:#333; display:flex; align-items:center; gap:4px; }
    .cal-pill { background:rgba(46,125,50,0.1); color:var(--success); font-size:11px; font-weight:700; padding:2px 8px; border-radius:10px; }
    .cal-zero { opacity:0.3; filter:grayscale(1); }

    /* HEATMAP */
    .heatmap { display:grid; grid-template-columns: 50px repeat(7, 1fr); gap:2px; margin-top:10px; }
    .hm-cell { aspect-ratio: 1.5; display:flex; align-items:center; justify-content:center; font-size:12px; border-radius:4px; font-weight:600; }
    .hm-label { font-weight:bold; color:var(--muted); background:transparent; }
    
    /* TABLES */
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th { text-align:left; color:var(--muted); font-size:12px; text-transform:uppercase; padding:10px; border-bottom:2px solid var(--ring); }
    td { padding:10px; border-bottom:1px solid #eee; }
    .num { text-align:right; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>

  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      if(qs.get('auth')==='1'){
        localStorage.setItem('rb_admin_ok','true');
        localStorage.setItem('rb_admin_ts', Date.now());
      }
      const ok = localStorage.getItem('rb_admin_ok');
      const ts = localStorage.getItem('rb_admin_ts');
      // Caduca en 24h
      if(!ok || (Date.now() - Number(ts) > 86400000)){
        window.location.href = 'login.html?msg=expired'; 
      }
    })();
  </script>

  <header>
    <div class="topbar">
      <a href="#" class="brand">
        <img src="images/logo.png" alt="RB"> Rhodes Finanzas
      </a>
      <nav style="display:flex; gap:10px;">
        <a href="pedido_local.html" class="btn">üì¶ Pedidos</a>
        <a href="finanzas.html" class="btn primary">üìà Finanzas</a>
        <a href="admin.html" class="btn">‚öôÔ∏è Admin</a>
        <button id="btnLogout" class="btn danger">Salir</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <div class="row" style="margin-bottom:20px; justify-content:space-between;">
      <div>
        <h1>Panel de Control</h1>
        <p class="text-muted">Visualizaci√≥n unificada de historial antiguo y nuevo.</p>
      </div>
      <div class="card row" style="padding:10px;">
        <div>
           <label>Mes</label>
           <input type="month" id="monthPicker">
        </div>
        <span class="text-muted" style="font-size:10px; font-weight:700">O RANGO:</span>
        <div>
           <label>Desde</label>
           <input type="date" id="dateFrom">
        </div>
        <div>
           <label>Hasta</label>
           <input type="date" id="dateTo">
        </div>
        <button id="btnLoad" class="btn primary">üîÑ Actualizar</button>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Pedidos Totales</div>
        <div class="kpi-value" id="kpiCount">...</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ingresos Brutos</div>
        <div class="kpi-value" id="kpiRevenue">...</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Ticket Promedio</div>
        <div class="kpi-value" id="kpiTicket">...</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Productos Vendidos</div>
        <div class="kpi-value" id="kpiProducts">...</div>
      </div>
    </div>

    <div class="card">
      <h3>Evoluci√≥n de Ventas</h3>
      <div class="chart-container chart-tall">
        <canvas id="mainChart"></canvas>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card">
        <h3>Medios de Pago</h3>
        <div class="chart-container"><canvas id="payChart"></canvas></div>
      </div>
      <div class="card">
        <h3>Origen (Canal)</h3>
        <div class="chart-container"><canvas id="sourceChart"></canvas></div>
      </div>
      <div class="card">
        <h3>Estado de Pedidos</h3>
        <div class="chart-container"><canvas id="statusChart"></canvas></div>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="row" style="justify-content:space-between;">
        <h3>Calendario de Rendimiento</h3>
        <div class="row">
           <span class="swatch" style="background:#e8f5e9; width:12px; height:12px; border-radius:2px;"></span> <small>Bajo</small>
           <span class="swatch" style="background:#2e7d32; width:12px; height:12px; border-radius:2px;"></span> <small>Alto</small>
        </div>
      </div>
      <div class="calendar-wrapper">
        <div class="calendar-grid" style="margin-bottom:5px;">
           <div class="cal-head">Dom</div><div class="cal-head">Lun</div><div class="cal-head">Mar</div>
           <div class="cal-head">Mi√©</div><div class="cal-head">Jue</div><div class="cal-head">Vie</div><div class="cal-head">S√°b</div>
        </div>
        <div id="calendarBody" class="calendar-grid" style="margin-top:0;"></div>
      </div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr 1fr; margin-top:20px;">
        
        <div class="card">
            <h3>Mapa de Calor (D√≠a x Hora)</h3>
            <p class="text-muted" style="font-size:11px">Intensidad de ventas seg√∫n d√≠a de la semana y hora.</p>
            <div id="heatmap" class="heatmap"></div>
        </div>

        <div class="card">
            <h3>Top 5 Productos</h3>
            <table>
                <thead><tr><th>Producto</th><th class="num">Cant.</th><th class="num">Total</th></tr></thead>
                <tbody id="topProductsBody"></tbody>
            </table>
        </div>
    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // 1. CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    // 2. HELPERS
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});
    
    // Funci√≥n robusta de fechas (para manejar el caos de datos viejos/nuevos)
    function parseDateAny(val){
        if(!val) return null;
        if(val.toDate) return val.toDate(); // Firestore Timestamp
        if(val instanceof Date) return val;
        if(typeof val === 'string'){
            // Intentar arreglar strings comunes
            if(val.length === 10) return new Date(val + 'T12:00:00'); 
            return new Date(val);
        }
        return new Date(val);
    }

    // 3. CORE: HYBRID FETCH (La Magia de la Fusi√≥n)
    async function fetchUnifiedOrders(start, end){
        const startStr = start.toISOString().split('T')[0];
        const endStr = end.toISOString().split('T')[0];

        // Disparamos dos consultas simult√°neas:
        // 1. Busca fechas guardadas como TEXTO (datos viejos)
        const p1 = db.collection('orders')
                     .where('createdAt', '>=', startStr)
                     .where('createdAt', '<=', endStr)
                     .get();

        // 2. Busca fechas guardadas como TIMESTAMP (datos nuevos)
        const p2 = db.collection('orders')
                     .where('createdAt', '>=', start)
                     .where('createdAt', '<=', end)
                     .get();

        const [snapStr, snapTime] = await Promise.all([p1, p2]);

        const mergedMap = new Map();
        const addToMap = (doc) => {
            const d = doc.data();
            // Filtro de seguridad: ignorar cancelados si no lo est√°n ya
            if(!(d.status && d.status.includes('cancel'))) {
                mergedMap.set(doc.id, d);
            }
        };

        snapStr.forEach(addToMap);
        snapTime.forEach(addToMap);

        console.log(`Pedidos cargados: ${mergedMap.size} (Fusi√≥n de queries)`);
        return Array.from(mergedMap.values());
    }

    // 4. MAIN CONTROLLER
    let charts = {}; // Store chart instances

    async function loadDashboard(){
        const btn = $('#btnLoad');
        btn.textContent = "‚è≥ Cargando..."; btn.disabled = true;

        try {
            // Determine Dates
            let start, end;
            const mVal = $('#monthPicker').value;
            const dFrom = $('#dateFrom').value;
            const dTo = $('#dateTo').value;

            if(dFrom && dTo){
                start = new Date(dFrom + 'T00:00:00');
                end = new Date(dTo + 'T23:59:59');
            } else {
                // Default to Month Picker
                const now = mVal ? new Date(mVal + '-02') : new Date();
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                // Sync inputs if empty
                if(!mVal) $('#monthPicker').value = now.toISOString().slice(0,7);
            }

            // Fetch Data
            const orders = await fetchUnifiedOrders(start, end);

            // Process Data
            const stats = processData(orders, start, end);

            // Render All
            renderKPI(stats);
            renderMainChart(stats);
            renderDoughnuts(stats);
            renderCalendar(stats, start, end);
            renderHeatmap(stats);
            renderTopProducts(orders);

        } catch(e) {
            console.error(e);
            alert("Error cargando datos. Revisa la consola.");
        } finally {
            btn.textContent = "üîÑ Actualizar"; btn.disabled = false;
        }
    }

    function processData(orders, start, end){
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
        const data = {
            totalRevenue: 0, totalCount: 0, totalItems: 0,
            byDay: {}, // 'YYYY-MM-DD': { revenue:0, count:0 }
            byPay: {}, bySource: {}, byStatus: {},
            heatmap: Array(7).fill(0).map(()=>Array(24).fill(0)) // 7 days x 24 hours
        };

        orders.forEach(o => {
            const d = parseDateAny(o.createdAt);
            if(!d || d < start || d > end) return;

            const total = Number(o.total || o.rawTotal || 0);
            const dateKey = d.toISOString().split('T')[0];
            
            // KPIs
            data.totalRevenue += total;
            data.totalCount++;
            
            // Daily Stats
            if(!data.byDay[dateKey]) data.byDay[dateKey] = { revenue:0, count:0 };
            data.byDay[dateKey].revenue += total;
            data.byDay[dateKey].count++;

            // Dimensions
            const pay = (o.pago || 'Desconocido').toLowerCase().replace('_',' ');
            data.byPay[pay] = (data.byPay[pay]||0) + total; // Sumamos $$ por medio de pago

            const src = (o.source || 'web').toLowerCase();
            data.bySource[src] = (data.bySource[src]||0) + 1; // Sumamos cantidad por origen

            const st = (o.status || 'accepted');
            data.byStatus[st] = (data.byStatus[st]||0) + 1;

            // Heatmap
            const dayIdx = d.getDay(); // 0=Sun
            const hourIdx = d.getHours();
            data.heatmap[dayIdx][hourIdx]++;

            // Products Count
            if(o.items && Array.isArray(o.items)){
                o.items.forEach(i => data.totalItems += Number(i.qty||1));
            }
        });

        return data;
    }

    // 5. RENDERERS
    function renderKPI(stats){
        $('#kpiCount').textContent = stats.totalCount;
        $('#kpiRevenue').textContent = money(stats.totalRevenue);
        const ticket = stats.totalCount ? stats.totalRevenue / stats.totalCount : 0;
        $('#kpiTicket').textContent = money(ticket);
        $('#kpiProducts').textContent = stats.totalItems;
    }

    function renderMainChart(stats){
        const ctx = $('#mainChart').getContext('2d');
        const dates = Object.keys(stats.byDay).sort();
        const revs = dates.map(d => stats.byDay[d].revenue);
        const counts = dates.map(d => stats.byDay[d].count);
        
        // Simpler labels DD/MM
        const labels = dates.map(d => d.split('-').slice(1).reverse().join('/'));

        if(charts.main) charts.main.destroy();
        charts.main = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label:'Ingresos', data:revs, type:'line', borderColor:'#2e7d32', backgroundColor:'rgba(46,125,50,0.1)', tension:0.3, yAxisID:'y', borderWidth:2, pointRadius:3 },
                    { label:'Pedidos', data:counts, type:'bar', backgroundColor:'rgba(98,90,69,0.7)', yAxisID:'y1' }
                ]
            },
            options: {
                responsive:true, maintainAspectRatio:false,
                scales: {
                    y: { beginAtZero:true, position:'left', grid:{color:'#f0f0f0'} },
                    y1: { beginAtZero:true, position:'right', grid:{display:false} }
                }
            }
        });
    }

    function renderDoughnuts(stats){
        const colors = ['#625A45', '#8D6E63', '#A1887F', '#D7CCC8', '#2E7D32', '#66BB6A'];
        
        const createDoughnut = (id, obj, labelType) => {
            const ctx = $(id).getContext('2d');
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(obj),
                    datasets: [{ data: Object.values(obj), backgroundColor: colors, borderWidth:2, borderColor:'#fff' }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{font:{size:10}, boxWidth:10}}} }
            });
        }

        createDoughnut('#payChart', stats.byPay);
        createDoughnut('#sourceChart', stats.bySource);
        createDoughnut('#statusChart', stats.byStatus);
    }

    function renderCalendar(stats, start, end){
        const grid = $('#calendarBody');
        grid.innerHTML = '';
        
        // Fill empty days at start
        const startDay = start.getDay(); // 0=Sun
        for(let i=0; i<startDay; i++){
            grid.insertAdjacentHTML('beforeend', `<div class="cal-day empty"></div>`);
        }

        const daysInMonth = new Date(start.getFullYear(), start.getMonth()+1, 0).getDate();
        let maxRev = 0;
        Object.values(stats.byDay).forEach(v => maxRev = Math.max(maxRev, v.revenue));

        // Iterate days
        // Note: Logic simplified for single month view. For ranges, iteration differs.
        for(let i=1; i<=daysInMonth; i++){
            const dateKey = `${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
            const data = stats.byDay[dateKey] || { count:0, revenue:0 };
            
            // Heat color logic
            let bg = '#fff';
            if(data.revenue > 0) {
                const alpha = Math.max(0.1, (data.revenue / maxRev) * 0.4);
                bg = `rgba(46, 125, 50, ${alpha})`;
            }

            const html = `
                <div class="cal-day ${data.count===0?'cal-zero':''}" style="background:${bg}">
                    <div class="cal-num">${i}</div>
                    ${data.count > 0 ? `
                        <div class="cal-content">
                            <div class="cal-hero">üçî ${data.count}</div>
                            <div class="cal-pill">${money(data.revenue)}</div>
                        </div>
                    ` : ''}
                </div>
            `;
            grid.insertAdjacentHTML('beforeend', html);
        }
    }

    function renderHeatmap(stats){
        const hm = $('#heatmap');
        hm.innerHTML = '';
        // Headers
        hm.insertAdjacentHTML('beforeend', `<div></div>`); // Corner
        for(let d=0; d<7; d++) hm.insertAdjacentHTML('beforeend', `<div style="text-align:center; font-size:10px; font-weight:bold;">${['Do','Lu','Ma','Mi','Ju','Vi','Sa'][d]}</div>`);

        const hours = [12,13,19,20,21,22,23,0]; // Focus hours
        // Or full 24h? Let's do focus range for better UI or full range compressed.
        // Let's do simple 19-00 range + 12-14 range if needed. For now: All hours where data exists.
        
        // Let's simplify: 18:00 to 01:00
        for(let h=18; h<=25; h++){
            const realH = h >= 24 ? h-24 : h;
            hm.insertAdjacentHTML('beforeend', `<div style="text-align:right; font-size:10px; padding-right:5px; color:#999">${realH}:00</div>`);
            
            for(let d=0; d<7; d++){
                const val = stats.heatmap[d][realH];
                // Color scale
                let color = '#f5f5f5';
                if(val > 0) color = val > 5 ? '#2e7d32' : val > 2 ? '#66bb6a' : '#a5d6a7';
                const txt = val > 0 ? val : '';
                const style = val > 0 ? `color:#fff;` : `color:transparent;`;
                hm.insertAdjacentHTML('beforeend', `<div class="hm-cell" style="background:${color}; ${style}">${txt}</div>`);
            }
        }
    }

    function renderTopProducts(orders){
        const prodMap = {};
        orders.forEach(o => {
            if(!o.items) return;
            o.items.forEach(i => {
                const n = (i.name||'Item').trim();
                if(!prodMap[n]) prodMap[n] = { qty:0, total:0 };
                prodMap[n].qty += Number(i.qty||1);
                prodMap[n].total += (Number(i.price||0) * Number(i.qty||1));
            });
        });

        const sorted = Object.entries(prodMap).sort((a,b) => b[1].qty - a[1].qty).slice(0, 5);
        const tbody = $('#topProductsBody');
        tbody.innerHTML = sorted.map(([name, d]) => `
            <tr>
                <td>${name}</td>
                <td class="num"><b>${d.qty}</b></td>
                <td class="num text-muted">${money(d.total)}</td>
            </tr>
        `).join('');
    }

    // INIT
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        $('#monthPicker').value = today.toISOString().slice(0,7);
        loadDashboard();

        $('#btnLogout').onclick = () => {
            localStorage.removeItem('rb_admin_ok');
            window.location.reload();
        }
    });

  </script>
</body>
</html>
