<!doctype html>
<html lang="es">
  <script>
  /* ======== SESI√ìN COMPARTIDA ======== */
  const TTL_HOURS = 20;
  const TTL_MS    = TTL_HOURS * 60 * 60 * 1000;

  function sessionValid(){
    const ok = localStorage.getItem('rb_admin_ok') === 'true';
    const ts = Number(localStorage.getItem('rb_admin_t') || 0);
    return ok && (Date.now() - ts) < TTL_MS;
  }
  function bumpSession(){
    if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
  }
  function logout(){
    localStorage.removeItem('rb_admin_ok');
    localStorage.removeItem('rb_admin_t');
    localStorage.removeItem('rb_auth_v2');
    sessionStorage.removeItem('rb_auth_v2');
    location.replace('login.html');
  }

  (function requireSession(){
    if (!sessionValid()){
      const next = encodeURIComponent(
        (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
        (location.search || '') + (location.hash || '')
      );
      location.replace('login.html?next=' + next);
    } else bumpSession();
  })();

  ['click','keydown','focus','mousemove','touchstart','scroll']
    .forEach(evt => window.addEventListener(evt, bumpSession, {passive:true}));
  </script>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
      --danger:#d32f2f; --warn:#ff9800;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}

    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    .grid{display:grid;grid-template-columns:1fr;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kbadge{min-width:160px;background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:10px 14px}
    .klabel{font-size:12px;color:var(--muted)}
    .kvalue{font-weight:800;font-size:20px}

    .chartWrap{height:280px}
    .chartWrapTall{height:320px}
    canvas{width:100% !important; height:100% !important; display:block}

    label{font-weight:600;display:block;margin:8px 0 6px}
    select, input[type="number"], input[type="datetime-local"], input[type="date"], input[type="month"], textarea{
      width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px
    }
    .inline{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;background:#fff;font-weight:700}

    /* Heatmaps */
    .heatmap{
      display:grid;
      border:1px solid var(--ring);
      border-radius:12px;
      overflow:hidden
    }
    .hm-cell{padding:8px;text-align:center;border-top:1px solid var(--ring);border-left:1px solid var(--ring);font-size:12px}
    .hm-head{background:#fafafa;font-weight:700}
    .hm-day{background:#fafafa;text-align:left;font-weight:700}
    .hm-legend{display:flex;gap:8px;align-items:center;margin-top:8px}
    .swatch{width:18px;height:18px;border-radius:4px;border:1px solid var(--ring)}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{font-size:13px;text-transform:uppercase;color:#666;letter-spacing:.02em}
  </style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png">Finanzas</a>
    <div class="spacer"></div>

    <nav style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <a href="pedido_local.html" class="btn">üì¶ Pedidos</a>
      <a href="finanzas.html" class="btn primary">üìà Finanzas</a>
      <a href="mostrador.html" class="btn">üßæ Mostrador</a>
      <a href="admin.html" class="btn">‚öôÔ∏è Admin</a>
    </nav>

    <button id="btnLogout" class="btn danger">‚èª Cerrar sesi√≥n</button>
  </div>
</header>

<main class="container">
  <h1>Resumen & Control</h1>

  <div class="grid">
    <section class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <strong>Resumen</strong>
            <div class="inline">
              <div>
                <label>Mes</label>
                <input type="month" id="monthPicker" />
              </div>
              <div>
                <label>Desde</label>
                <input type="date" id="fromDate" />
              </div>
              <div>
                <label>Hasta</label>
                <input type="date" id="toDate" />
              </div>
            </div>
            <button id="btnReload" class="btn">Actualizar</button>
          </div>

          <div class="kpi">
            <div class="kbadge">
              <div class="klabel">Pedidos</div>
              <div class="kvalue" id="kpiCount">‚Äî</div>
            </div>
            <div class="kbadge">
              <div class="klabel">Ingresos</div>
              <div class="kvalue" id="kpiRevenue">‚Äî</div>
            </div>
            <div class="kbadge">
              <div class="klabel">Ticket Prom.</div>
              <div class="kvalue" id="kpiATV">‚Äî</div>
            </div>
            <div class="kbadge">
              <div class="klabel">Margen Est.</div>
              <div class="kvalue" id="kpiMargin">‚Äî</div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="chartWrapTall">
            <canvas id="ordersChart"></canvas>
          </div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="card" style="flex:1; padding:12px">
            <strong>Medios de pago</strong>
            <div class="chartWrap">
              <canvas id="payChart"></canvas>
            </div>
          </div>

          <div class="card" style="flex:1; padding:12px">
            <strong>Estados</strong>
            <div class="chartWrap">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>

        <!-- HEATMAP semana √ó d√≠a del mes -->
        <div class="card" style="margin-top:12px">
          <strong>Heatmap de demanda (semana √ó d√≠a del mes)</strong>
          <div id="heatmap" class="heatmap" style="margin-top:8px"></div>

          <div class="hm-legend">
            <span class="muted">Bajo</span>
            <span class="swatch" style="background:#e8f5e9"></span>
            <span class="swatch" style="background:#a5d6a7"></span>
            <span class="swatch" style="background:#66bb6a"></span>
            <span class="swatch" style="background:#2e7d32"></span>
            <span class="muted">Alto</span>
          </div>
        </div>

        <!-- HEATMAP por horas -->
        <div class="card" style="margin-top:12px">
          <strong>Heatmap por horas (19 ‚Üí 00)</strong>

          <div id="hourmap" class="heatmap" style="margin-top:8px"></div>

          <div class="hm-legend">
            <span class="muted">Bajo</span>
            <span class="swatch" style="background:#e8f5e9"></span>
            <span class="swatch" style="background:#a5d6a7"></span>
            <span class="swatch" style="background:#66bb6a"></span>
            <span class="swatch" style="background:#2e7d32"></span>
            <span class="muted">Alto</span>
          </div>

          <div id="hourSummary" class="muted" style="margin-top:8px">‚Äî</div>
        </div>

        <!-- PROYECCI√ìN -->
        <div class="card" style="margin-top:12px">
          <strong>Proyecci√≥n del mes</strong>
          <div id="projText" class="muted" style="margin-top:6px">‚Äî</div>
          <div id="pendingAlert" style="margin-top:8px"></div>
        </div>

        <div id="kpiError" class="err" style="display:none;margin-top:8px"></div>

        <!-- HAMBURGUESAS POR MES -->
        <div class="card" style="margin-top:12px">
          <strong>Hamburguesas por mes</strong>

          <div class="inline" style="margin:8px 0">
            <label class="badge">Mes <input type="month" id="burgMonth" /></label>
            <button id="bmPrev" class="btn">‚óÄ</button>
            <button id="bmNext" class="btn">‚ñ∂</button>
            <button id="bmGo" class="btn">Ver</button>
            <span id="bmRange" class="badge muted">‚Äî</span>
          </div>

          <div id="bmErr" class="err" style="display:none;margin-bottom:6px"></div>

          <table>
            <thead>
              <tr>
                <th>Hamburguesa</th>
                <th>Cantidad</th>
                <th>Precio unitario</th>
                <th>Total</th>
              </tr>
            </thead>

            <tbody id="bmBody">
              <tr><td class="muted" colspan="4">Sin datos‚Ä¶</td></tr>
            </tbody>

            <tfoot>
              <tr>
                <th>Total hamburguesas</th><th id="bmTotal">0</th>
                <th>Ingresos del mes</th><th id="bmRevenue">$0</th>
              </tr>
            </tfoot>
          </table>
        </div>
        <!-- FIN hamburguesas por mes -->

      <!-- CALENDARIO HAMBURGUESAS POR D√çA (CORREGIDO) -->
<section class="card" style="margin-top:12px">
  <strong>Calendario de hamburguesas por d√≠a</strong>

  <div class="inline" style="margin:8px 0">
    <label class="badge">
      Mes <input type="month" id="calBurgerMonth" />
    </label>

    <button id="calPrev" class="btn">‚óÄ</button>
    <button id="calNext" class="btn">‚ñ∂</button>
    <button id="calGo" class="btn">Ver</button>

    <span id="calRange" class="badge muted">‚Äî</span>
  </div>

  <!-- Tabla estilo heatmap pero SOLO fila -->
  <div id="calGrid"
       style="
         display:grid;
         grid-template-columns: 70px repeat(31, 1fr);
         border:1px solid var(--ring);
         border-radius:12px;
         overflow:hidden;
       ">
  </div>

  <div class="hm-legend" style="margin-top:8px">
    <span class="muted">Bajo</span>
    <span class="swatch" style="background:#e8f5e9"></span>
    <span class="swatch" style="background:#a5d6a7"></span>
    <span class="swatch" style="background:#66bb6a"></span>
    <span class="swatch" style="background:#2e7d32"></span>
    <span class="muted">Alto</span>
  </div>

  <div id="calError"
       class="err"
       style="margin-top:8px;display:none"></div>
</section>
    </div>
  </main>

  <!-- LIBRER√çAS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const btn=document.getElementById('btnLogout');
      if(btn) btn.onclick=()=>{
        localStorage.removeItem('rb_auth_v2');
        localStorage.removeItem('rb_admin_ok');
        localStorage.removeItem('rb_admin_t');
        sessionStorage.removeItem('rb_auth_v2');
        location.replace('login.html?next=pedido_local.html');
      };
    });
  </script>
  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig);}catch(e){}
    const db = firebase.firestore();

    const $ = s=>document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function pickDocDate(obj){
      const cand=['createdAt','created_at','timestamp','date','fecha','time'];
      for(const k of cand){
        const v=obj[k];
        if(v?.toDate) return v.toDate();
        if(typeof v==="number") return new Date(v);
        if(typeof v==="string"){ const d=new Date(v); if(!isNaN(d)) return d; }
      }
      return null;
    }

    function monthKey(){
      const d = $("#monthPicker").value ? new Date($("#monthPicker").value + "-01") : new Date();
      return {
        y: d.getFullYear(),
        m: d.getMonth()+1,
        days: new Date(d.getFullYear(), d.getMonth()+1, 0).getDate()
      };
    }

    function dateRange(){
      const from = $("#fromDate").value ? new Date($("#fromDate").value+"T00:00:00") : null;
      const to   = $("#toDate").value   ? new Date($("#toDate").value+"T23:59:59") : null;
      return {from, to};
    }

    (function initMonth(){
      const d=new Date(), m=String(d.getMonth()+1).padStart(2,'0');
      $("#monthPicker").value=`${d.getFullYear()}-${m}`;
      $("#burgMonth").value =`${d.getFullYear()}-${m}`;
      $("#calBurgerMonth").value =`${d.getFullYear()}-${m}`;
    })();

    function colorFor(val,max){
      if(max<=0) return "#e8f5e9";
      const r=val/max;
      if(r<0.25) return "#e8f5e9";
      if(r<0.50) return "#a5d6a7";
      if(r<0.75) return "#66bb6a";
      return "#2e7d32";
    }

    /* ============== CHARTS ============== */
    let ordersChart,payChart,statusChart;

    function ensureOrdersChart(labels,orders,revenue){
      const ctx=$("#ordersChart").getContext("2d");
      if(ordersChart) ordersChart.destroy();
      ordersChart=new Chart(ctx,{
        type:"bar",
        data:{
          labels,
          datasets:[
            {
              type:"bar",
              label:"Pedidos",
              data: orders,
              backgroundColor:"rgba(98,90,69,.35)",
              borderColor:"#625A45",
              borderWidth:1,
              yAxisID:'y'
            },
            {
              type:"line",
              label:"Ingresos ($)",
              data: revenue,
              borderColor:"#625A45",
              backgroundColor:"rgba(98,90,69,.10)",
              tension:.25,
              borderWidth:2,
              yAxisID:'y2'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            y:{beginAtZero:true},
            y2:{beginAtZero:true,position:"right"},
            x:{grid:{display:false}}
          }
        }
      });
    }

    const PAY_COLOR_MAP = {
      efectivo:"#625A45",
      mercado_pago:"#1E88E5",
      credito:"#8E24AA",
      debito:"#43A047",
      transferencia:"#26A69A",
      otro:"#FFA000"
    };

    const STATUS_COLOR_MAP = {
      accepted:"#FBC02D",
      pending_payment:"#FFA000",
      in_prep:"#FB8C00",
      ready:"#00ACC1",
      delivered:"#2E7D32",
      cancelled:"#D32F2F"
    };

    function ensurePayChart(labels,vals){
      const ctx=$("#payChart").getContext("2d");
      if(payChart) payChart.destroy();
      const colors = labels.map(l => PAY_COLOR_MAP[l] || "#9E9E9E");

      payChart=new Chart(ctx,{
        type:"doughnut",
        data:{
          labels, datasets:[{
            data:vals,
            backgroundColor:colors,
            borderColor:colors,
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          cutout:"55%",
          plugins:{legend:{position:"bottom"}}
        }
      });
    }

    function ensureStatusChart(labels,vals){
      const ctx=$("#statusChart").getContext("2d");
      if(statusChart) statusChart.destroy();
      const colors = labels.map(l => STATUS_COLOR_MAP[l] || "#9E9E9E");

      statusChart=new Chart(ctx,{
        type:"doughnut",
        data:{
          labels, datasets:[{
            data:vals,
            backgroundColor:colors,
            borderColor:colors,
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          cutout:"55%",
          plugins:{legend:{position:"bottom"}}
        }
      });
    }

    /* ============== HEATMAP WEEK √ó DAY ============== */
    function renderHeatmapWeekByDay(matrix,labels){
      const host=$("#heatmap");
      host.innerHTML="";
      host.style.gridTemplateColumns = `90px repeat(${labels.length},1fr)`;

      host.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-head"></div>`);
      labels.forEach(l=>{
        host.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-head">${l}</div>`);
      });

      const weekNames=["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];

      let max=0;
      matrix.forEach(r=>r.forEach(v=>{ if(v>max) max=v; }));

      for(let r=0;r<7;r++){
        host.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-day">${weekNames[r]}</div>`);
        for(let c=0;c<labels.length;c++){
          const v=matrix[r][c]||0;
          const bg=colorFor(v,max);
          host.insertAdjacentHTML("beforeend",
            `<div class="hm-cell" style="background:${bg}" title="${v} pedidos">${v||""}</div>`
          );
        }
      }
    }

    /* ============== HEATMAP HOURS ============== */
    const HOUR_START=19,HOUR_END=24,HOUR_COUNT=HOUR_END-HOUR_START;

    function renderHourHeatmap(matrix,labels){
      const host=$("#hourmap");
      host.innerHTML="";
      host.style.gridTemplateColumns = `72px repeat(${labels.length},1fr)`;

      host.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-head"></div>`);
      labels.forEach(l=>{
        host.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-head">${l}</div>`);
      });

      let max=0;
      matrix.forEach(r=>r.forEach(v=>{ if(v>max) max=v; }));

      for(let h=HOUR_START;h<HOUR_END;h++){
        const label = `${String(h).padStart(2,'0')}:00`;
        host.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-day">${label}</div>`);

        for(let c=0;c<labels.length;c++){
          const v=matrix[h-HOUR_START][c]||0;
          const bg=colorFor(v,max);
          host.insertAdjacentHTML(
            "beforeend",
            `<div class="hm-cell" style="background:${bg}" title="${v} pedidos">${v||""}</div>`
          );
        }
      }
    }

    function summarizeHourMatrix(matrix, days){
      const cols=matrix[0]?.length||0;
      const effective = Math.max(1,days||cols);
      const avgs = matrix.map(row=>{
        const sum=row.reduce((a,b)=>a+(b||0),0);
        return sum/effective;
      });

      let peakVal=-1, peakIdx=0;
      avgs.forEach((v,i)=>{ if(v>peakVal){ peakVal=v; peakIdx=i; }});

      return {peakHour:HOUR_START+peakIdx, peakVal};
    }

    function printHourSummary(matrix, labels){
      const {peakHour,peakVal} = summarizeHourMatrix(matrix,labels.length);
      $("#hourSummary").innerHTML =
        `Hora pico: <strong>${String(peakHour).padStart(2,'0')}:00</strong> (${peakVal.toFixed(2)} pedidos de promedio)`;
    }

    /* =======================================================================
       NUEVO: CALENDARIO HAMBURGUESAS POR D√çA
       ======================================================================= */
    function addMonths(ym,delta){
      const [y,m]=ym.split("-").map(Number);
      const d=new Date(y,m-1+delta,1);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    }

    async function loadBurgerCalendar(){
      const err=$("#calError");
      err.style.display="none";

      const ym = $("#calBurgerMonth").value;
      const [y,m] = ym.split("-").map(Number);
      const start = new Date(y, m-1, 1);
      const end   = new Date(y, m,   1);
      const days  = new Date(y, m, 0).getDate();

      $("#calRange").textContent =
        `${start.toLocaleDateString("es-AR")} ‚Üí ${(new Date(end-1)).toLocaleDateString("es-AR")}`;

      const grid=$("#calGrid");
      grid.innerHTML="";
      grid.style.gridTemplateColumns = `60px repeat(${days},1fr)`;

      grid.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-head"></div>`);
      for(let d=1;d<=days;d++){
        grid.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-head">${d}</div>`);
      }

      let counts = Array(days).fill(0);
      let max=0;

      try{
        const snap = await db.collection("orders")
          .where("createdAt",">=",start)
          .where("createdAt","<",end)
          .get();

        snap.forEach(doc=>{
          const o=doc.data();
          const dt=pickDocDate(o);
          if(!dt) return;
          if(dt.getMonth()+1!==m) return;

          const dIdx=dt.getDate()-1;
          const items=o.items||[];
          items.forEach(it=>{
            if(typeof it.type==="string" && it.type.toLowerCase()==="burger"){
              counts[dIdx]++;
            }
          });
        });

        max = Math.max(...counts);

        grid.insertAdjacentHTML("beforeend",`<div class="hm-cell hm-day">Burgs</div>`);
        for(let i=0;i<days;i++){
          const v=counts[i];
          const bg=colorFor(v,max);
          grid.insertAdjacentHTML("beforeend",
            `<div class="hm-cell" style="background:${bg}" title="${v} hamburguesas">${v||""}</div>`
          );
        }

      }catch(e){
        console.error("cal error:",e);
        err.textContent="No se pudo cargar el calendario.";
        err.style.display="block";
      }
    }

    $("#calPrev").onclick = ()=>{
      const cur=$("#calBurgerMonth").value;
      $("#calBurgerMonth").value=addMonths(cur,-1);
      loadBurgerCalendar();
    };

    $("#calNext").onclick = ()=>{
      const cur=$("#calBurgerMonth").value;
      $("#calBurgerMonth").value=addMonths(cur,1);
      loadBurgerCalendar();
    };

    $("#calGo").onclick = loadBurgerCalendar;

    document.addEventListener("DOMContentLoaded", loadBurgerCalendar);

    /* =======================================================================
       KPI + HEATMAP + HOURMAP + PROYECCI√ìN (EXISTENTE)
       ======================================================================= */

    async function loadKPI(){
      const err=$("#kpiError");
      err.style.display="none";

      try{
        const probe=await db.collection("orders").limit(1).get();
        let dateField=null;

        if(!probe.empty){
          const d=probe.docs[0].data();
          for(const k of ['createdAt','created_at','timestamp','date','fecha','time']){
            if(d[k]!=null){ dateField=k; break; }
          }
        }
        if(!dateField) dateField="createdAt";

        let q=db.collection("orders").orderBy(dateField,"desc").limit(2000);
        const snap=await q.get();

        const {from,to}=dateRange();
        const useRange=!!(from||to);

        const mk=monthKey();
        const {y,m,days}=mk;

        const labels = !useRange ? Array.from({length:days},(_,i)=>String(i+1)) : [];

        const dayOrders = !useRange ? Array(days).fill(0) : [];
        const dayRevenue= !useRange ? Array(days).fill(0) : [];

        const hmMatrix = Array.from({length:7},()=> Array(!useRange?days:0).fill(0));
        const hmLabels = !useRange ? Array.from({length:days},(_,i)=>String(i+1).padStart(2,'0')) : [];

        let hourLabels, hourMatrix, dateKeyIndex;

        if(!useRange){
          hourLabels = Array.from({length:days},(_,i)=>String(i+1).padStart(2,'0'));
          hourMatrix=Array.from({length:HOUR_COUNT},()=>Array(days).fill(0));
        }else{
          const fromD=from?new Date(from.getFullYear(),from.getMonth(),from.getDate()):null;
          const toD=to?new Date(to.getFullYear(),to.getMonth(),to.getDate()):null;
          const lbls=[];
          const d2=new Date(fromD);
          while(d2<=toD){
            lbls.push(String(d2.getDate()).padStart(2,'0'));
            d2.setDate(d2.getDate()+1);
          }
          hourLabels=lbls;
          dateKeyIndex=new Map(lbls.map((lbl,i)=>[lbl,i]));
          hourMatrix=Array.from({length:HOUR_COUNT},()=>Array(lbls.length).fill(0));
        }

        let count=0,revenue=0,pending=0;
        const payCount=new Map();
        const stCount=new Map();

        const inMonth = dt => dt.getFullYear()===y && dt.getMonth()+1===m;

        snap.forEach(doc=>{
          const o=doc.data();
          const dt=pickDocDate(o);
          if(!dt) return;

          if(useRange){
            if(from && dt<from) return;
            if(to && dt>to) return;
          }else if(!inMonth(dt)) return;

          count++;
          const tot=Number(o.total)||0;
          revenue+=tot;

          if(o.payment_status!=="paid") pending+=tot;

          const p=(o.pago||"otro");
          payCount.set(p,(payCount.get(p)||0)+1);

          const st=(o.status||"accepted");
          stCount.set(st,(stCount.get(st)||0)+1);

          if(!useRange){
            const di=dt.getDate()-1;
            const wr=dt.getDay();
            if(di>=0 && di<days){
              dayOrders[di]++;
              dayRevenue[di]+=tot;
              hmMatrix[wr][di] = (hmMatrix[wr][di]||0)+1;
            }
          }

          const hr=dt.getHours();
          if(hr>=HOUR_START && hr<HOUR_END){
            if(!useRange){
              const di=dt.getDate()-1;
              if(di>=0 && di<days) hourMatrix[hr-HOUR_START][di]++;
            }else{
              const key=String(dt.getDate()).padStart(2,'0');
              const col=dateKeyIndex.get(key);
              if(col!=null) hourMatrix[hr-HOUR_START][col]++;
            }
          }
        });

        $("#kpiCount").textContent=count;
        $("#kpiRevenue").textContent=money(revenue);
        $("#kpiATV").textContent=count? money(revenue/count):"‚Äî";
        $("#kpiMargin").textContent="‚Äî";

        if(!useRange) ensureOrdersChart(labels,dayOrders,dayRevenue);
        else ensureOrdersChart([],[],[]);

        ensurePayChart(Array.from(payCount.keys()), Array.from(payCount.values()));
        ensureStatusChart(Array.from(stCount.keys()), Array.from(stCount.values()));

        if(!useRange) renderHeatmapWeekByDay(hmMatrix,hmLabels);
        renderHourHeatmap(hourMatrix,hourLabels);
        printHourSummary(hourMatrix,hourLabels);

        // PROYECCI√ìN
        const proj=$("#projText");
        if(!useRange){
          const today=new Date();
          const isSame=(today.getFullYear()===y && today.getMonth()+1===m);
          const dayOfMonth=isSame? today.getDate(): days;
          const revToDate = dayRevenue.slice(0,dayOfMonth).reduce((a,b)=>a+b,0);
          const avg=revToDate/dayOfMonth;
          const projected=avg*days;

          proj.innerHTML =
            `Ingresos a la fecha: <strong>${money(revToDate)}</strong><br>
             Ingresos diarios prom.: <strong>${money(avg)}</strong><br>
             Proyecci√≥n fin de mes: <strong>${money(projected)}</strong>`;

          const pendBox=$("#pendingAlert");
          pendBox.innerHTML="";
          if(pending>0){
            const cls=pending>=80000?"danger":"warn";
            const msg=pending>=80000?
              `Pendientes elevados: ${money(pending)}` :
              `Pendientes: ${money(pending)}`;
            pendBox.innerHTML=`<span class="warn-pill ${cls}">${msg}</span>`;
          }
        }else{
          proj.textContent="Proyecci√≥n disponible s√≥lo al seleccionar un mes entero.";
        }

      }catch(e){
        console.error(e);
        const err=$("#kpiError");
        err.textContent="Error cargando KPI";
        err.style.display="block";
      }
    }

    $("#btnReload").onclick = loadKPI;
    document.addEventListener("DOMContentLoaded", loadKPI);
  </script>
</body>
</html>
