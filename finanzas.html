<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b00000}
    main{max-width:1200px;margin:22px auto;padding:0 12px}
    .filters{display:flex;gap:10px;align-items:center;margin-bottom:14px}
    input[type="month"]{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;outline:none}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px}
    .kpi{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    .kpi .label{font-size:13px;color:var(--muted)}
    .kpi .value{font-size:28px;font-weight:900;margin-top:6px}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px}
    h2{font-size:18px;margin:0 0 10px}
    .chartbox{width:100%;height:360px} /* reserva espacio para evitar saltos */
    .err{color:#b00020;font-weight:600;margin-top:8px}

    /* Ancla para auto-scroll (compensa header sticky) */
    #chartsTop{height:1px}
    #chartsTop{scroll-margin-top:88px;} /* ~altura de la cabecera */
    @media (max-width:960px){
      .kpis{grid-template-columns:1fr}
      .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Guardia de acceso (sesión 20 hs) -->
  <script>
    (function guard(){
      const exp = parseInt(localStorage.getItem('rb_auth_expires')||'0',10);
      const now = Date.now();
      if (!exp || now > exp) {
        localStorage.removeItem('rb_auth_token');
        localStorage.removeItem('rb_auth_expires');
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=expired&next=' + next);
        return;
      }
      setTimeout(()=>{
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=expired&next=' + next);
      }, Math.min(exp-now, 2147483647));
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn" href="pedido_local.html">← Volver a pedidos</a>
      <button id="btnLogout" class="btn danger">⏻ Cerrar sesión</button>
    </div>
  </header>

  <main>
    <div class="filters">
      <strong>Mes</strong>
      <input type="month" id="monthPicker">
      <button class="btn" id="btnReload">Actualizar</button>
      <div class="spacer"></div>
    </div>

    <section class="kpis">
      <div class="kpi"><div class="label">Pedidos</div><div id="kpiOrders" class="value">—</div></div>
      <div class="kpi"><div class="label">Ingresos</div><div id="kpiRevenue" class="value">—</div></div>
      <div class="kpi"><div class="label">Ticket promedio</div><div id="kpiAvg" class="value">—</div></div>
    </section>

    <!-- ANCLA: acá queremos que queden visibles -->
    <div id="chartsTop"></div>

    <section class="row">
      <div class="card" id="dailyCard">
        <h2>Evolución diaria</h2>
        <canvas id="dailyChart" class="chartbox"></canvas>
        <div id="errDaily" class="err" style="display:none"></div>
      </div>
      <div class="card" id="payCard">
        <h2>Distribución</h2>
        <div style="font-size:13px;color:#666;margin-bottom:6px">Medios de pago</div>
        <canvas id="payChart" class="chartbox"></canvas>
        <div id="errPay" class="err" style="display:none"></div>
      </div>
    </section>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ======= Firebase =======
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(_){}
    const db = firebase.firestore();

    // ======= Utils =======
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    (function setDefaultMonth(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      $("#monthPicker").value = `${d.getFullYear()}-${m}`;
    })();

    function pickDocDate(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){
        const v = obj?.[k]; if (v==null) continue;
        try{
          if (v?.toDate) return v.toDate();
          if (typeof v === 'number') return new Date(v);
          if (typeof v === 'string') { const d = new Date(v); if(!isNaN(d)) return d; }
        }catch(_){}
      }
      return null;
    }

    // ======= Charts holders =======
    const charts = { daily:null, pay:null };

    const fmtInt = v => v.toLocaleString('es-AR');
    const fmtCurrency = v => (Number(v)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    function drawDaily(labels, ordersArr, revenueArr){
      const ctx = document.getElementById('dailyChart').getContext('2d');
      if (charts.daily) charts.daily.destroy();
      charts.daily = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { type:'bar', label:'Pedidos', data:ordersArr,
              backgroundColor:'rgba(46,204,113,.60)', borderColor:'#22b266', borderWidth:1.5, yAxisID:'y', order:1 },
            { type:'line', label:'Ingresos', data:revenueArr, yAxisID:'y2', order:2,
              borderColor:'#1b6a3c', borderWidth:3, pointRadius:3, pointHoverRadius:5, fill:false, tension:.25 }
          ]
        },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          plugins:{
            legend:{labels:{usePointStyle:true}},
            tooltip:{callbacks:{
              label:(ctx)=>{
                if (ctx.dataset.yAxisID==='y2') return `Ingresos: ${fmtCurrency(ctx.parsed.y)}`;
                return `Pedidos: ${fmtInt(ctx.parsed.y)}`;
              }
            }}
          },
          scales:{
            y:{beginAtZero:true, ticks:{callback:v=>fmtInt(v)}},
            y2:{beginAtZero:true, position:'right', grid:{drawOnChartArea:false}, ticks:{callback:v=>fmtCurrency(v)}},
            x:{grid:{display:false}}
          }
        }
      });
    }

    function drawPay(labels, values){
      const ctx = document.getElementById('payChart').getContext('2d');
      if (charts.pay) charts.pay.destroy();
      charts.pay = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label:'Pedidos', data:values,
            backgroundColor:['#22b266','#2ecc71','#9adfb8'],
            borderColor:['#1b8e52','#22b266','#78c79b'],
            borderWidth:1.5
          }]
        },
        options: {
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            tooltip:{callbacks:{label:(ctx)=>` ${fmtInt(ctx.parsed.x)} pedidos`}}
          },
          scales:{
            x:{beginAtZero:true, ticks:{callback:v=>fmtInt(v)}},
            y:{grid:{display:false}}
          }
        }
      });
    }

    // === Auto-scroll si los charts no quedaron en pantalla ===
    function ensureChartsVisible(){
      const anchor = document.getElementById('chartsTop');
      if (!anchor) return;
      const r = anchor.getBoundingClientRect();
      const vh = window.innerHeight || document.documentElement.clientHeight;
      const visible = r.top >= 0 && r.top <= vh; // ancla cerca del viewport
      if (!visible) anchor.scrollIntoView({behavior:'auto', block:'start'});
    }

    // ======= Carga de datos + render =======
    async function loadFinance(){
      const monthStr = $("#monthPicker").value; // yyyy-mm
      const d = new Date(monthStr + '-01T00:00:00');
      const Y = d.getFullYear(), M = d.getMonth();
      const daysInMonth = new Date(Y, M+1, 0).getDate();
      const labels = Array.from({length:daysInMonth}, (_,i)=> String(i+1));
      const dayOrders = Array(daysInMonth).fill(0);
      const dayRevenue = Array(daysInMonth).fill(0);
      const payDist = { efectivo:0, mercado_pago:0, otro:0 };

      $("#errDaily").style.display = "none";
      $("#errPay").style.display = "none";

      try{
        const probe = await db.collection('orders').limit(1).get();
        let dateField = null;
        if (!probe.empty) {
          const sample = probe.docs[0].data();
          for (const k of ['createdAt','created_at','timestamp','date','fecha','time']) {
            if (sample[k] != null) { dateField = k; break; }
          }
        }
        let q = db.collection('orders');
        if (dateField) q = q.orderBy(dateField, 'desc'); else q = q.orderBy(firebase.firestore.FieldPath.documentId());
        const snap = await q.limit(2000).get();

        let totalOrders = 0, totalRevenue = 0;

        snap.forEach(doc=>{
          const o = doc.data();
          const dt = pickDocDate(o); if (!dt) return;
          if (dt.getFullYear() !== Y || dt.getMonth() !== M) return;

          const idx = dt.getDate() - 1;
          const items = Array.isArray(o.items) ? o.items : [];
          const tot = (typeof o.total === 'number') ? o.total : items.reduce((t,it)=>{
            const base = it.price||0;
            const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0);
            const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
            const unit = (it.type==='burger') ? (base+pz+ch) : base;
            return t + unit*(it.qty||0);
          },0);

          dayOrders[idx] += 1;
          dayRevenue[idx] += tot;
          totalOrders += 1;
          totalRevenue += tot;

          const mp = (o.pago||'otro').toLowerCase();
          if (mp.includes('efectivo')) payDist.efectivo += 1;
          else if (mp.includes('mercado')) payDist.mercado_pago += 1;
          else payDist.otro += 1;
        });

        // KPIs
        $("#kpiOrders").textContent = totalOrders.toLocaleString('es-AR');
        $("#kpiRevenue").textContent = money(totalRevenue);
        $("#kpiAvg").textContent = totalOrders ? money(totalRevenue/totalOrders) : money(0);

        // Gráficos
        const hasDaily = dayOrders.some(v=>v>0) || dayRevenue.some(v=>v>0);
        if (hasDaily) drawDaily(labels, dayOrders, dayRevenue);
        else{
          if (charts.daily) charts.daily.destroy();
          $("#errDaily").textContent = "Sin datos para el mes seleccionado.";
          $("#errDaily").style.display = "block";
        }

        const payLabels = ['Mercado Pago','Efectivo','Otro'];
        const payValues = [payDist.mercado_pago, payDist.efectivo, payDist.otro];
        const hasPay = payValues.some(v=>v>0);
        if (hasPay) drawPay(payLabels, payValues);
        else{
          if (charts.pay) charts.pay.destroy();
          $("#errPay").textContent = "Sin datos de medios de pago.";
          $("#errPay").style.display = "block";
        }

        // Asegurar que queden a la vista al entrar/actualizar
        ensureChartsVisible();

      }catch(err){
        console.error(err);
        $("#errDaily").textContent = "No se pudieron cargar los datos.";
        $("#errDaily").style.display = "block";
      }
    }

    // Eventos
    $("#btnReload").addEventListener('click', loadFinance);
    $("#monthPicker").addEventListener('change', loadFinance);
    $("#btnLogout").addEventListener('click', ()=>{
      localStorage.removeItem('rb_auth_token');
      localStorage.removeItem('rb_auth_expires');
      location.replace('login.html?reason=logout');
    });

    // Cargar una sola vez al entrar
    document.addEventListener('DOMContentLoaded', loadFinance);
  </script>
</body>
</html>
