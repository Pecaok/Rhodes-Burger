<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finanzas • Rhodes Burgers</title>
<link rel="icon" href="/images/icon-32.png" />
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2ecc71">
<link rel="apple-touch-icon" href="/images/icon-192.png">
<style>
  :root{
    --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --ring:#eaeaea;
    --shadow:0 12px 34px rgba(0,0,0,.10); --danger:#b00020; --warn:#ffb74d; --warnText:#8a4b00;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
  .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
  .brand img{width:36px;height:36px;border-radius:10px;object-fit:contain;margin-right:8px}
  .spacer{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
  .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b00000}
  main{max-width:1100px;margin:22px auto;padding:0 12px}

  .board{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;margin-bottom:16px}
  .board-head{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .board-kpis{display:flex;gap:12px;flex-wrap:wrap;margin-left:auto}
  .kbadge{min-width:150px;background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:10px 14px}
  .klabel{font-size:12px;color:var(--muted)}
  .kvalue{font-weight:800;font-size:20px}
  input[type="month"]{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;outline:none}
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  .chartwrap{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:8px}
  .chartbox{width:100%;height:260px}
  .err{color:#b00020;font-weight:600;margin-top:8px}
  .toast{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);opacity:0;transform:translateY(20px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.success{background:#2ecc71}.toast.error{background:#d32f2f}.toast.info{background:#444}
  @media (max-width:900px){ .charts{grid-template-columns:1fr} }

  /* ===== Venta presencial ===== */
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:800px){ .grid2{grid-template-columns:1fr} }
  .form{display:grid;gap:10px}
  label{font-weight:700}
  input[type="text"],input[type="number"],select,textarea{
    width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px;outline:none;background:#fff
  }
  textarea{min-height:80px}
  .rows{border:1px solid var(--ring);border-radius:12px;overflow:hidden}
  .rowHead,.row{display:grid;grid-template-columns:2fr 100px 140px 80px;gap:8px;align-items:center;padding:8px}
  .rowHead{background:#f8f8f8;font-weight:700}
  .row input{width:100%}
  .row .qty{ text-align:right }
  .row .price{ text-align:right }
  .row .subtotal{ text-align:right; font-weight:700 }
  .addline{margin-top:8px}
  .summary{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
  .total{font-weight:800;font-size:18px}
  .hint{font-size:12px;color:var(--muted)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--ring);background:#f7f7f7;font-size:12px}
  .payBadge{font-weight:800;font-size:14px;padding:6px 12px;border-radius:999px;border:2px solid;line-height:1;white-space:nowrap;}
  .payBadge.paid{ background:#e8f8ef; color:#0b7a3a; border-color:#2ecc71; }
  .payBadge.unpaid{ background:#fff3e0; color:var(--warnText); border-color:var(--warn); box-shadow:0 0 0 4px rgba(255,183,77,.18); }

  /* Celda producto: select + input alternativo */
  .prodCell{display:flex;gap:6px;align-items:center}
  .prodCell .name{display:none}
  .prodCell.showName .name{display:block}
  .prodCell.showName .prod{display:none}
  .mini{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="/images/logo.png" alt="">Rhodes Burgers</a>
    <div class="spacer"></div>
    <a class="btn" href="pedido_local.html">← Volver a pedidos</a>
    <button id="btnLogout" class="btn danger">⏻ Cerrar sesión</button>
  </div>
</header>

<main>
  <!-- Resumen + Gráficos -->
  <section class="board">
    <div class="board-head">
      <strong>Resumen mensual</strong>
      <input type="month" id="monthPicker">
      <button class="btn" id="btnReload">Actualizar</button>
      <button class="btn" id="btnExport">Exportar CSV</button>
      <div class="board-kpis">
        <div class="kbadge"><div class="klabel">Pedidos</div><div class="kvalue" id="kpiCount">—</div></div>
        <div class="kbadge"><div class="klabel">Ingresos</div><div class="kvalue" id="kpiRevenue">—</div></div>
        <div class="kbadge"><div class="klabel">Ticket promedio</div><div class="kvalue" id="kpiAvg">—</div></div>
      </div>
    </div>
    <div class="charts">
      <div class="chartwrap"><canvas id="monthChart" class="chartbox"></canvas></div>
      <div class="chartwrap"><canvas id="payChart" class="chartbox"></canvas></div>
    </div>
    <div id="kpiError" class="err" style="display:none;margin-top:6px"></div>
  </section>

  <!-- Venta presencial -->
  <section class="board">
    <div class="board-head" style="margin-bottom:8px">
      <strong>Agregar venta presencial</strong>
      <span class="badge">Se registra como pedido en /orders</span>
      <div class="spacer"></div>
      <button id="btnRefreshMenu" class="btn">Refrescar menú</button>
      <span id="menuInfo" class="mini">—</span>
    </div>

    <div class="grid2">
      <!-- Columna izquierda: Items -->
      <div>
        <div class="rows">
          <div class="rowHead">
            <div>Producto</div>
            <div style="text-align:right">Cant.</div>
            <div style="text-align:right">Precio unit.</div>
            <div style="text-align:right">Subtotal</div>
          </div>
          <div id="rowsHost"></div>
        </div>
        <button id="btnAddLine" class="btn addline">+ Agregar ítem</button>

        <div class="summary">
          <div class="hint">Elegí del menú o “Otro (especificar)”. Doble click en “Precio” copia el último precio usado.</div>
          <div class="total">Total: <span id="manualTotal">$ 0</span></div>
        </div>
      </div>

      <!-- Columna derecha: Datos del pedido -->
      <div class="form">
        <div>
          <label>Nombre del cliente (opcional)</label>
          <input id="mNombre" type="text" placeholder="Ej: Juan Perez">
        </div>

        <div>
          <label>Notas (opcional)</label>
          <textarea id="mNotas" placeholder="Ej: sin cebolla, entregar ya, etc."></textarea>
        </div>

        <div>
          <label>Medio de pago</label>
          <select id="mPago">
            <option value="efectivo">Efectivo</option>
            <option value="mercado_pago">Mercado Pago</option>
            <option value="otro">Otro</option>
          </select>
        </div>

        <div style="display:flex;align-items:center;gap:10px">
          <input id="mPagado" type="checkbox" checked>
          <label for="mPagado" style="margin:0">Pagado</label>
          <span id="mPayBadge" class="payBadge paid">Pago: PAGADO</span>
        </div>

        <div style="display:flex;align-items:center;gap:10px">
          <input id="mEntregado" type="checkbox" checked>
          <label for="mEntregado" style="margin:0">Entregado ahora</label>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="btnGuardar" class="btn primary">Guardar venta</button>
          <button id="btnLimpiar" class="btn">Limpiar</button>
        </div>

        <div id="manualError" class="err" style="display:none"></div>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // SW
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js'); }

  // Guardia local (20 hs)
  (function guard(){
    const exp = parseInt(localStorage.getItem('rb_auth_expires')||'0',10);
    const tok = localStorage.getItem('rb_auth_token');
    if (!exp || Date.now() > exp || !tok) {
      const next = encodeURIComponent(location.pathname + location.search);
      location.replace('login.html?reason=expired&next='+next);
      return;
    }
    setTimeout(()=>location.replace('login.html?reason=expired'), Math.min(exp - Date.now(), 2147483647));
  })();

  // Toasts
  const toastEl = document.getElementById('toast');
  function showToast(msg,type='success',ms=2000){
    toastEl.textContent = msg; toastEl.className = 'toast '+type;
    requestAnimationFrame(()=>{ toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); });
  }

  // Firebase
  const firebaseConfig = {
    apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain:"rhodes-burguers.firebaseapp.com",
    projectId:"rhodes-burguers",
    storageBucket:"rhodes-burguers.firebasestorage.app",
    messagingSenderId:"951646688091",
    appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig);}catch(_){}
  const db = firebase.firestore();

  // Helpers
  const $ = s => document.querySelector(s);
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  (function setDefaultMonth(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,"0"); $("#monthPicker").value=`${d.getFullYear()}-${m}`; })();
  function pickDocDate(obj){
    const cand=['createdAt','created_at','timestamp','date','fecha','time'];
    for(const k of cand){ const v=obj?.[k]; if(v==null) continue;
      try{ if(v?.toDate) return v.toDate(); if(typeof v==='number') return new Date(v); if(typeof v==='string'){ const d=new Date(v); if(!isNaN(d)) return d; } }catch(_){}
    } return null;
  }
  function unitWithExtras(it){ const base=it.price||0; const pz=(it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0); const ch=(it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0); return base+pz+ch; }
  function computeOrderTotal(o){ if(typeof o.total==='number') return o.total; const items=Array.isArray(o.items)?o.items:[]; return items.reduce((t,it)=>t+ (it.type==='burger'?unitWithExtras(it):(it.price||0))*(it.qty||0),0); }

  // ======= CHARTS / KPI =======
  let monthChart, payChart, lastRows=[];
  function ensureMonthChart(labels, orders, revenue){
    const ctx=document.getElementById("monthChart").getContext("2d");
    if(monthChart) monthChart.destroy();
    monthChart=new Chart(ctx,{type:'bar',data:{labels,
      datasets:[
        {type:'bar',label:'Pedidos',data:orders,backgroundColor:'rgba(46,204,113,.55)',borderColor:'#22b266',borderWidth:1.5,yAxisID:'y'},
        {type:'line',label:'Ingresos ($)',data:revenue,borderColor:'#1b6a3c',backgroundColor:'rgba(46,204,113,.10)',borderWidth:3,tension:.25,pointRadius:3,fill:false,yAxisID:'y2'}
      ]},
      options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
        scales:{y:{beginAtZero:true},y2:{beginAtZero:true,position:'right',grid:{drawOnChartArea:false}},x:{grid:{display:false}}}}
    });
  }
  function ensurePayChart(labels, values){
    const ctx=document.getElementById('payChart').getContext('2d');
    if(payChart) payChart.destroy();
    payChart = new Chart(ctx, {type:'bar', data:{labels,datasets:[{label:'Pedidos',data:values,backgroundColor:['#22b266','#2ecc71','#9adfb8'],borderColor:['#1b8e52','#22b266','#78c79b'],borderWidth:1.5}]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true},y:{grid:{display:false}}}}
    });
  }

  async function loadFinance(){
    const kpiErr = document.getElementById('kpiError');
    kpiErr.style.display="none"; kpiErr.textContent="";
    try{
      const probe=await db.collection('orders').limit(1).get();
      let dateField=null;
      if(!probe.empty){ const sample=probe.docs[0].data(); for(const k of ['createdAt','created_at','timestamp','date','fecha','time']){ if(sample[k]!=null){ dateField=k; break; } } }
      let q=db.collection('orders'); q=dateField? q.orderBy(dateField,'desc') : q.orderBy(firebase.firestore.FieldPath.documentId());
      const snap=await q.limit(2000).get();

      const d = new Date(document.getElementById('monthPicker').value + '-01T00:00:00');
      const Y=d.getFullYear(), M=d.getMonth();
      const days=new Date(Y,M+1,0).getDate();
      const labels=Array.from({length:days},(_,i)=>`${i+1}`);
      const dayOrders=Array(days).fill(0);
      const dayRevenue=Array(days).fill(0);
      const payDist = { mercado_pago:0, efectivo:0, otro:0 };

      let count=0, revenue=0; lastRows=[];

      snap.forEach(doc=>{
        const o=doc.data(); const dt=pickDocDate(o); if(!dt) return;
        if (dt.getFullYear()!==Y || dt.getMonth()!==M) return;
        const idx=dt.getDate()-1;
        const tot=computeOrderTotal(o);
        dayOrders[idx]+=1; dayRevenue[idx]+=tot; count++; revenue+=tot;

        const mp=(o.pago||'otro').toLowerCase();
        if (mp.includes('mercado')) payDist.mercado_pago++; else if (mp.includes('efectivo')) payDist.efectivo++; else payDist.otro++;

        lastRows.push({ id:doc.id, orderNumber:o.orderNumber||'', fecha:dt.toISOString(), nombre:o.nombre||'', pago:o.pago||'', paymentStatus:o.paymentStatus||'', estado:o.status||'', total:tot });
      });

      document.getElementById('kpiCount').textContent = count.toLocaleString("es-AR");
      document.getElementById('kpiRevenue').textContent = money(revenue);
      document.getElementById('kpiAvg').textContent = count ? money(revenue/count) : money(0);

      ensureMonthChart(labels, dayOrders, dayRevenue);
      ensurePayChart(['Mercado Pago','Efectivo','Otro'], [payDist.mercado_pago, payDist.efectivo, payDist.otro]);
    }catch(e){ console.error(e); kpiErr.textContent="No se pudo cargar el resumen."; kpiErr.style.display="block"; }
  }

  function exportCSV(){
    if (!lastRows.length){ showToast('No hay datos para exportar','info'); return; }
    const headers = ['id','orderNumber','fecha','nombre','pago','paymentStatus','estado','total'];
    const lines = [headers.join(',')].concat(
      lastRows.map(r=> headers.map(h=>{
        const v = (r[h] ?? '');
        if (typeof v === 'string' && (v.includes(',') || v.includes('"') || v.includes('\n'))) {
          return '"' + v.replace(/"/g,'""') + '"';
        }
        return v;
      }).join(','))
    );
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const m = document.getElementById('monthPicker').value || 'mes';
    a.href = url; a.download = `finanzas_${m}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('CSV exportado','success');
  }

  document.getElementById('btnReload').addEventListener('click', loadFinance);
  document.getElementById('monthPicker').addEventListener('change', loadFinance);
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('btnLogout').addEventListener('click', ()=>{
    localStorage.removeItem('rb_auth_expires');
    localStorage.removeItem('rb_auth_token');
    localStorage.removeItem('rb_auth_user');
    location.replace('login.html?reason=logout');
  });

  // ======= Venta Presencial + MENÚ =======
  const rowsHost = document.getElementById('rowsHost');
  const manualTotalEl = document.getElementById('manualTotal');
  const mPago = document.getElementById('mPago');
  const mPagado = document.getElementById('mPagado');
  const mPayBadge = document.getElementById('mPayBadge');
  const manualErr = document.getElementById('manualError');
  const btnRefreshMenu = document.getElementById('btnRefreshMenu');
  const menuInfo = document.getElementById('menuInfo');

  // Fallback estático editable (por si no hay nada en Firestore ni pedidos aún)
  const STATIC_MENU = [
    { id: 'big_john_simple', name: 'Big John Simple', price: 10900 },
    { id: 'big_john_doble',  name: 'Big John Doble',  price: 13900 }
    // ← agregá acá si querés
  ];

  // Catálogo en memoria
  let MENU_BURGERS = []; // {id,name,price}

  function payBadgeUpdate(){
    const paid = mPagado.checked || mPago.value!=='efectivo';
    mPayBadge.textContent = 'Pago: ' + (paid ? 'PAGADO' : 'PENDIENTE');
    mPayBadge.classList.toggle('paid', paid);
    mPayBadge.classList.toggle('unpaid', !paid);
  }
  mPago.addEventListener('change', payBadgeUpdate);
  mPagado.addEventListener('change', payBadgeUpdate);

  async function tryFetchCollection(coll){
    try{
      const snap = await db.collection(coll).limit(300).get();
      const out=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        const type = (x.type||x.tipo||x.category||x.categoria||'').toString().toLowerCase();
        const name = (x.name || x.title || x.nombre || '').toString();
        const price= Number(x.price || x.precio || 0);
        const looksBurger = ['burger','hamburguesa','hamburguesas'].some(t=> type.includes(t)) || coll.toLowerCase().includes('burger');
        if (name && (looksBurger || !type)) out.push({ id:d.id, name, price: price>0?price:0 });
      });
      return out;
    }catch(_){ return []; }
  }

  async function tryFetchSubcollection(root, doc, sub){
    try{
      const snap = await db.collection(root).doc(doc).collection(sub).limit(300).get();
      const out=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        const name = (x.name || x.title || x.nombre || '').toString();
        const price= Number(x.price || x.precio || 0);
        if (name) out.push({ id:d.id, name, price: price>0?price:0 });
      });
      return out;
    }catch(_){ return []; }
  }

  async function inferMenuFromOrders(){
    try{
      let q = db.collection('orders').orderBy('createdAt','desc').limit(500);
      const snap = await q.get();
      const map = new Map(); // nameLower -> {name, price}
      snap.forEach(doc=>{
        const it = Array.isArray(doc.data().items) ? doc.data().items : [];
        it.forEach(x=>{
          const nm = (x.name||'').toString().trim();
          if (!nm) return;
          const key = nm.toLowerCase();
          const pr  = Number(x.price||0);
          if (!map.has(key)) map.set(key,{name:nm, price: pr>0?pr:0});
          else if (pr>0) map.set(key,{name:nm,price:pr}); // preferir último con precio
        });
      });
      return Array.from(map.values());
    }catch(_){ return []; }
  }

  async function loadMenuBurgers(){
    menuInfo.textContent = 'Cargando menú...';
    const found = new Map(); // k=nameLower -> obj

    function pushArr(arr, tag){
      arr.forEach(it=>{
        const k=it.name.trim().toLowerCase(); if(!k) return;
        const prev = found.get(k);
        if (!prev || (it.price||0) > (prev.price||0)) found.set(k,{...it,__source:tag});
      });
    }

    // 1) Colecciones típicas
    const cands = ['menu','products','burgers','menu_burgers'];
    for (const coll of cands){
      const arr = await tryFetchCollection(coll);
      pushArr(arr, coll);
    }
    // 2) Subcolecciones conocidas
    const subcands = [
      ['menu','burgers','items'],
      ['menu','hamburguesas','items'],
      ['catalog','burgers','items']
    ];
    for (const [root,doc,sub] of subcands){
      const arr = await tryFetchSubcollection(root,doc,sub);
      pushArr(arr, `${root}/${doc}/${sub}`);
    }
    // 3) Inferir desde pedidos si no hay nada
    if (found.size===0){
      const fromOrders = await inferMenuFromOrders();
      pushArr(fromOrders,'orders');
    }
    // 4) Fallback estático
    if (found.size===0){
      pushArr(STATIC_MENU,'static');
    }

    MENU_BURGERS = Array.from(found.values()).sort((a,b)=> a.name.localeCompare(b.name,'es'));
    menuInfo.textContent = MENU_BURGERS.length
      ? `Menú cargado: ${MENU_BURGERS.length} hamburguesas`
      : 'No se encontraron hamburguesas (usá “Otro”).';

    // Actualizar selects existentes
    document.querySelectorAll('.prod').forEach(sel => fillSelectOptions(sel));
  }

  function fillSelectOptions(selectEl){
    const cur = selectEl.value;
    selectEl.innerHTML = '<option value="">Seleccionar...</option>' +
      MENU_BURGERS.map(m => `<option value="${m.id||m.name}" data-price="${m.price||0}">${m.name}${(m.price>0?` — ${money(m.price)}`:'')}</option>`).join('') +
      '<option value="__other">Otro (especificar)</option>';
    if (cur) {
      const opt = Array.from(selectEl.options).find(o=>o.value===cur);
      if (opt) selectEl.value = cur;
    }
  }

  function addRow(pref={name:'', qty:1, price:0, id:''}){
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `
      <div class="prodCell">
        <select class="prod"></select>
        <input class="name" type="text" placeholder="Producto" value="${pref.name||''}">
      </div>
      <input class="qty" type="number" step="1" min="0" value="${pref.qty||1}">
      <input class="price" type="number" step="1" min="0" value="${pref.price||0}">
      <div class="subtotal">$ 0</div>
    `;
    rowsHost.appendChild(row);

    const prodSel = row.querySelector('.prod');
    const nameI   = row.querySelector('.name');
    const qtyI    = row.querySelector('.qty');
    const priceI  = row.querySelector('.price');
    const subEl   = row.querySelector('.subtotal');
    const cell    = row.querySelector('.prodCell');

    fillSelectOptions(prodSel);

    if (pref.id){
      prodSel.value = pref.id; cell.classList.remove('showName');
    } else if (pref.name){
      prodSel.value = '__other'; cell.classList.add('showName');
    }

    function recalc(){
      const q = Math.max(0, parseInt(qtyI.value||'0',10));
      const p = Math.max(0, Math.round(parseFloat(priceI.value||'0')));
      subEl.textContent = money(q*p);
      updateTotal();
    }
    [qtyI, priceI, nameI, prodSel].forEach(i=> i.addEventListener('input', recalc));

    prodSel.addEventListener('change', ()=>{
      const val = prodSel.value;
      if (!val) return;
      if (val === '__other'){
        cell.classList.add('showName');
        if (!nameI.value.trim()) nameI.focus();
      } else {
        cell.classList.remove('showName');
        const opt = prodSel.selectedOptions[0];
        const price = Number(opt?.dataset?.price||0);
        priceI.value = price>0 ? price : priceI.value;
        const label = (opt?.textContent||'').split(' — ')[0];
        nameI.value = label;
        if (!qtyI.value || +qtyI.value===0) qtyI.value = 1;
      }
      recalc();
    });

    priceI.addEventListener('dblclick', ()=>{
      const prev = Array.from(rowsHost.querySelectorAll('.price')).slice(0,-1).reverse().find(x=>+x.value>0);
      if(prev){ priceI.value = prev.value; priceI.dispatchEvent(new Event('input')); }
    });

    recalc();
  }

  function getManualItems(){
    const items=[];
    rowsHost.querySelectorAll('.row').forEach(r=>{
      const prodSel = r.querySelector('.prod');
      const nameI   = r.querySelector('.name');
      const qtyI    = r.querySelector('.qty');
      const priceI  = r.querySelector('.price');

      const sel = prodSel.value;
      let name = '';
      if (sel && sel !== '__other'){
        const label = (prodSel.selectedOptions[0]?.textContent||'').split(' — ')[0];
        name = label || '';
      } else {
        name = nameI.value.trim();
      }

      const qty   = Math.max(0, parseInt(qtyI.value||'0',10));
      const price = Math.max(0, Math.round(parseFloat(priceI.value||'0')));

      if (name && qty>0){
        items.push({ type:'manual', id:'', name, qty, price });
      }
    });
    return items;
  }

  function updateTotal(){
    const total = getManualItems().reduce((t,it)=> t + it.qty*it.price, 0);
    manualTotalEl.textContent = money(total);
    return total;
  }

  function clearManualForm(){
    rowsHost.innerHTML='';
    addRow(); addRow();
    document.getElementById('mNombre').value='';
    document.getElementById('mNotas').value='';
    mPago.value='efectivo';
    mPagado.checked=true;
    document.getElementById('mEntregado').checked=true;
    payBadgeUpdate();
    manualErr.style.display='none';
    updateTotal();
  }

  clearManualForm();
  document.getElementById('btnAddLine').addEventListener('click', ()=> addRow());
  btnRefreshMenu.addEventListener('click', loadMenuBurgers);

  // Cargar menú al abrir
  loadMenuBurgers();

  function takeNextOrderNumber(tx){
    const ref = db.collection('config').doc('counters');
    return tx.get(ref).then(snap=>{
      const prev = snap.exists ? (snap.data().orderNumber||0) : 0;
      const next = prev + 1;
      tx.set(ref, { orderNumber: next }, { merge:true });
      return next;
    });
  }

  async function guardarVenta(){
    manualErr.style.display='none'; manualErr.textContent='';
    const items = getManualItems();
    if (!items.length){ manualErr.textContent='Agregá al menos un ítem válido.'; manualErr.style.display='block'; return; }
    const total = items.reduce((t,it)=> t + it.qty*it.price, 0);
    if (total<=0){ manualErr.textContent='El total debe ser mayor que 0.'; manualErr.style.display='block'; return; }

    const pago = mPago.value;
    const paid = (pago==='efectivo') ? !!mPagado.checked : true;
    const paymentStatus = paid ? 'paid' : 'unpaid';
    const status = document.getElementById('mEntregado').checked ? 'delivered' : 'accepted';

    const nombre = document.getElementById('mNombre').value.trim();
    const notas  = document.getElementById('mNotas').value.trim();

    const btnGuardar = document.getElementById('btnGuardar');
    btnGuardar.disabled = true; btnGuardar.textContent = 'Guardando...';

    try{
      let orderNumber=null;
      await db.runTransaction(async (tx)=>{
        orderNumber = await takeNextOrderNumber(tx);
        const order = {
          orderNumber,
          nombre,
          telefono: "",
          entrega: "take_away",
          pago,
          paymentStatus,
          notes: notas,
          status,
          items,
          total,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          source: "manual_finanzas"
        };
        const ref = db.collection('orders').doc();
        tx.set(ref, order);
      });

      showToast(`Venta registrada (Pedido #${orderNumber})`,'success');
      clearManualForm();
      await loadFinance();

    }catch(e){
      console.error(e);
      manualErr.textContent='No se pudo guardar la venta. Probá de nuevo.';
      manualErr.style.display='block';
    }finally{
      btnGuardar.disabled = false; btnGuardar.textContent = 'Guardar venta';
    }
  }

  document.getElementById('btnGuardar').addEventListener('click', guardarVenta);

  // Cargar datos al abrir
  document.addEventListener('DOMContentLoaded', loadFinance);
</script>
</body>
</html>
