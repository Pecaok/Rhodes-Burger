<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Finanzas • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png"/>
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:22px; --shadow:0 12px 34px rgba(0,0,0,.10); --ring:#eaeaea;
      --danger:#b00020;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:800}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--primary);color:#fff;border-color:#2ecc71}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b00000}
    .container{max-width:1200px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}
    .controls{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .controls .group{display:flex;align-items:center;gap:8px}
    input[type="month"]{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;outline:none}
    label{font-weight:600}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
    .kpi{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .klabel{font-size:12px;color:var(--muted)}
    .kvalue{font-weight:800;font-size:26px;margin-top:6px}
    .grid{display:grid;grid-template-columns:1.3fr .7fr;gap:12px;margin-top:16px}
    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    .chartbox{width:100%;height:320px}
    .twocol{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--ring);text-align:left}
    th{font-size:13px;color:var(--muted);font-weight:700}
    .muted{color:var(--muted)}
    .err{color:var(--danger);font-weight:600;margin-top:8px;display:none}
    .loading{font-size:14px;color:var(--muted)}
    @media (max-width:1000px){
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr}
      .twocol{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Guardia de acceso: requiere sesión activa (20 hs desde login.html) -->
  <script>
    (function guard(){
      const exp = parseInt(localStorage.getItem('rb_auth_expires')||'0',10);
      const now = Date.now();
      if (!exp || now > exp) {
        localStorage.removeItem('rb_auth_token');
        localStorage.removeItem('rb_auth_expires');
        localStorage.removeItem('rb_auth_v2');
        localStorage.removeItem('rb_admin_ok');
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=expired&next=' + next);
        return;
      }
      const msLeft = exp - now;
      setTimeout(()=>{
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=expired&next=' + next);
      }, Math.min(msLeft, 2147483647));
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="pedido_local.html"><img src="images/logo.png" alt="">Rhodes Burgers • Finanzas</a>
      <div class="spacer"></div>
      <button id="btnExport" class="btn">⬇️ Exportar CSV</button>
      <button id="btnLogout" class="btn danger">⏻ Cerrar sesión</button>
    </div>
  </header>

  <main class="container">
    <h1>Panel de finanzas</h1>

    <section class="controls">
      <div class="group">
        <label>Desde</label>
        <input type="month" id="mFrom">
      </div>
      <div class="group">
        <label>Hasta</label>
        <input type="month" id="mTo">
      </div>
      <div class="group">
        <label><input type="checkbox" id="chkExcludeCancelled" checked> Excluir cancelados</label>
      </div>
      <div class="group">
        <button id="btnApply" class="btn primary">Aplicar</button>
      </div>
      <div class="group">
        <button class="btn" data-q="this">Este mes</button>
        <button class="btn" data-q="prev">Mes pasado</button>
        <button class="btn" data-q="ytd">YTD</button>
      </div>
      <div class="group loading" id="loading" style="display:none">Cargando…</div>
      <div class="err" id="errBox"></div>
    </section>

    <section class="kpis">
      <div class="kpi">
        <div class="klabel">Pedidos</div>
        <div class="kvalue" id="kpiOrders">—</div>
      </div>
      <div class="kpi">
        <div class="klabel">Ingresos</div>
        <div class="kvalue" id="kpiRevenue">—</div>
      </div>
      <div class="kpi">
        <div class="klabel">Ticket promedio</div>
        <div class="kvalue" id="kpiATV">—</div>
      </div>
    </section>

    <section class="grid">
      <div class="card">
        <h3 style="margin:0 0 8px">Evolución diaria</h3>
        <canvas id="ordersChart" class="chartbox"></canvas>
        <canvas id="revenueChart" class="chartbox" style="margin-top:14px"></canvas>
      </div>
      <div class="card">
        <h3 style="margin:0 0 8px">Distribución</h3>
        <div class="twocol">
          <div>
            <div class="muted" style="margin-bottom:6px">Medios de pago</div>
            <canvas id="payChart" class="chartbox" style="height:240px"></canvas>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Estados</div>
            <canvas id="statusChart" class="chartbox" style="height:240px"></canvas>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3 style="margin:0 0 8px">Top productos (por cantidad)</h3>
      <div class="muted" id="topInfo" style="margin-bottom:6px">—</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr><th>Producto</th><th>Cantidad</th><th>Ingresos estimados</th></tr>
          </thead>
          <tbody id="topBody"><tr><td colspan="3" class="muted">Sin datos.</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ========= Firebase =========
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  const db = firebase.firestore();

  // ========= Helpers =========
  const $ = s => document.querySelector(s);
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  const mFrom = $("#mFrom"), mTo = $("#mTo");
  const chkExcludeCancelled = $("#chkExcludeCancelled");
  const kpiOrders=$("#kpiOrders"), kpiRevenue=$("#kpiRevenue"), kpiATV=$("#kpiATV");
  const loading=$("#loading"), errBox=$("#errBox");
  const topBody=$("#topBody"), topInfo=$("#topInfo");

  (function setDefaultMonths(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    mFrom.value = `${y}-${m}`;
    mTo.value   = `${y}-${m}`;
    // restaurar de localStorage si había
    const saved = JSON.parse(localStorage.getItem("rb_finanzas_filter")||"null");
    if (saved){
      if (saved.from) mFrom.value = saved.from;
      if (saved.to) mTo.value = saved.to;
      chkExcludeCancelled.checked = saved.excl !== false;
    }
  })();

  $("#btnLogout").onclick = ()=>{
    localStorage.removeItem('rb_auth_token');
    localStorage.removeItem('rb_auth_expires');
    localStorage.removeItem("rb_auth_v2");
    localStorage.removeItem("rb_admin_ok");
    location.replace('login.html?reason=guard');
  };

  // fecha utilidades
  function startOfMonthStr(yyyy_mm){ const [y,m]=yyyy_mm.split("-").map(Number); return new Date(y,m-1,1,0,0,0,0); }
  function endOfMonthStr(yyyy_mm){ const [y,m]=yyyy_mm.split("-").map(Number); return new Date(y,m,0,23,59,59,999); } // último día
  function dateKey(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,"0"); const da=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${da}`; }

  // detectar campo de fecha y transformarlo a Date
  function pickDocDate(obj){
    const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
    for (const k of cand){
      const v = obj?.[k]; if (v==null) continue;
      try{
        if (v?.toDate) return v.toDate();           // Firestore Timestamp
        if (typeof v === 'number') return new Date(v);
        if (typeof v === 'string') {
          const d = new Date(v); if (!isNaN(d.getTime())) return d;
          const m = v.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?/);
          if (m){ const day=+m[1], mon=+m[2]-1, yr=+m[3]<100?2000+(+m[3]):+m[3]; const hh=+m[4]||0, mm=+m[5]||0; const d2=new Date(yr,mon,day,hh,mm,0,0); if(!isNaN(d2.getTime())) return d2; }
        }
      }catch(e){}
    }
    return null;
  }
  function chooseDateField(obj){
    const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
    for (const k of cand){ if (obj && obj[k]!=null) return k; }
    return null;
  }
  function unitWithExtras(it){
    const base = it.price || 0;
    const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0);
    const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
    return base + pz + ch;
  }
  function computeOrderTotal(o){
    if (typeof o.total === "number") return o.total;
    const items = Array.isArray(o.items) ? o.items : [];
    return items.reduce((t,it)=> t + (it.type==="burger" ? unitWithExtras(it) : (it.price||0)) * (it.qty||0), 0);
  }

  // ========= Charts =========
  let ordersChart, revenueChart, payChart, statusChart;
  function ensureLineChart(canvasId, label, labels, data){
    const ctx = document.getElementById(canvasId).getContext("2d");
    if (canvasId==="ordersChart" && ordersChart) ordersChart.destroy();
    if (canvasId==="revenueChart" && revenueChart) revenueChart.destroy();
    const inst = new Chart(ctx,{
      type:'line',
      data:{labels, datasets:[{label, data, borderColor:'#2ecc71', backgroundColor:'rgba(46,204,113,.12)', tension:.25, fill:true, borderWidth:2}]},
      options:{responsive:true,maintainAspectRatio:false, scales:{x:{grid:{display:false}}, y:{beginAtZero:true}}}
    });
    if (canvasId==="ordersChart") ordersChart = inst; else revenueChart = inst;
  }
  function ensureDoughnut(canvasId, labels, data){
    const ctx = document.getElementById(canvasId).getContext("2d");
    if (canvasId==="payChart" && payChart) payChart.destroy();
    if (canvasId==="statusChart" && statusChart) statusChart.destroy();
    const inst = new Chart(ctx,{type:'doughnut', data:{labels, datasets:[{data}]}, options:{responsive:true,maintainAspectRatio:false}});
    if (canvasId==="payChart") payChart = inst; else statusChart = inst;
  }

  // ========= Carga y cálculo =========
  async function loadAndRender(){
    const from = mFrom.value, to = mTo.value;
    if (!from || !to) return;
    // guardar filtro
    localStorage.setItem("rb_finanzas_filter", JSON.stringify({from, to, excl: chkExcludeCancelled.checked}));

    loading.style.display="inline"; errBox.style.display="none"; errBox.textContent="";
    try{
      // Estrategia: intentar ordenar por campo de fecha y traer “muchos” (hasta 5000) y filtrar client-side
      const probe = await db.collection("orders").limit(1).get();
      let dateField = null;
      if (!probe.empty) dateField = chooseDateField(probe.docs[0].data());

      let q = db.collection("orders");
      if (dateField) q = q.orderBy(dateField, 'desc'); else q = q.orderBy(firebase.firestore.FieldPath.documentId());

      // Si existe dateField Timestamp => podemos limitar por rango aproximado para reducir tráfico
      let snap;
      const fromDate = startOfMonthStr(from);
      const toDate   = endOfMonthStr(to);

      if (dateField && (probe.docs[0].data()[dateField]?.toDate)){
        snap = await db.collection("orders")
          .orderBy(dateField, 'asc')
          .startAt(fromDate)
          .endAt(toDate)
          .limit(5000)
          .get();
      }else{
        // fallback: traemos mucho y filtramos
        snap = await q.limit(5000).get();
      }

      // Normalizar, filtrar rango y cancelados
      const rows = [];
      snap.forEach(doc=>{
        const o = doc.data();
        const d = pickDocDate(o); if(!d) return;
        if (d < fromDate || d > toDate) return;
        if (chkExcludeCancelled.checked && (o.status||"") === "cancelled") return;
        const total = computeOrderTotal(o);
        rows.push({id:doc.id, date:d, status:o.status||"", pago:o.pago||"", total, items:o.items||[]});
      });

      // KPIs
      const count = rows.length;
      const revenue = rows.reduce((a,b)=>a+(b.total||0),0);
      const atv = count? (revenue/count) : 0;
      kpiOrders.textContent = count.toLocaleString("es-AR");
      kpiRevenue.textContent = money(revenue);
      kpiATV.textContent = money(atv);

      // Series diarias
      const labels = [];
      const dayOrders = [];
      const dayRevenue = [];
      // construir rango día a día
      const d0 = new Date(fromDate.getFullYear(), fromDate.getMonth(), 1);
      const d1 = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate());
      const accOrders={}, accRevenue={};
      rows.forEach(r=>{
        const k = dateKey(r.date);
        accOrders[k] = (accOrders[k]||0)+1;
        accRevenue[k] = (accRevenue[k]||0)+(r.total||0);
      });
      for (let d = new Date(d0); d <= d1; d.setDate(d.getDate()+1)){
        const k = dateKey(d);
        labels.push(k);
        dayOrders.push(accOrders[k]||0);
        dayRevenue.push(accRevenue[k]||0);
      }
      ensureLineChart("ordersChart","Pedidos por día",labels,dayOrders);
      ensureLineChart("revenueChart","Ingresos por día",labels,dayRevenue.map(n=>Math.round(n)));

      // Distribución pagos
      const payCount = rows.reduce((m,r)=>{ const k=r.pago||'—'; m[k]=(m[k]||0)+1; return m; },{});
      const payLabels = Object.keys(payCount);
      const payData = payLabels.map(k=>payCount[k]);
      ensureDoughnut("payChart", payLabels, payData);

      // Distribución estados
      const stCount = rows.reduce((m,r)=>{ const k=r.status||'—'; m[k]=(m[k]||0)+1; return m; },{});
      const stLabels = Object.keys(stCount);
      const stData = stLabels.map(k=>stCount[k]);
      ensureDoughnut("statusChart", stLabels, stData);

      // Top productos (por qty) + ingresos estimados por item
      const prod = {};
      rows.forEach(r=>{
        (r.items||[]).forEach(it=>{
          const name = it.name || it.id || '—';
          const qty = it.qty||0;
          const unit = it.type==="burger" ? unitWithExtras(it) : (it.price||0);
          if (!prod[name]) prod[name] = {qty:0, revenue:0};
          prod[name].qty += qty;
          prod[name].revenue += unit * qty;
        });
      });
      const top = Object.entries(prod).sort((a,b)=>b[1].qty-a[1].qty).slice(0,50);
      topBody.innerHTML = top.length
        ? top.map(([name,info])=>`<tr><td>${name}</td><td>${info.qty.toLocaleString("es-AR")}</td><td>${money(info.revenue)}</td></tr>`).join("")
        : `<tr><td colspan="3" class="muted">Sin datos.</td></tr>`;
      topInfo.textContent = `${top.length} productos en el top (máx. 50 mostrados)`;

      // Guardar dataset para export
      window.__FIN_ROWS__ = rows;
    }catch(err){
      console.error(err);
      errBox.textContent = "No se pudieron cargar los datos.";
      errBox.style.display = "block";
    }finally{
      loading.style.display="none";
    }
  }

  // ========= Export CSV =========
  function exportCSV(){
    const rows = window.__FIN_ROWS__||[];
    const hdr = ["id","fecha","estado","pago","total"];
    const csv = [hdr.join(",")].concat(rows.map(r=>{
      const d = r.date; const ds = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
      const esc = v => (String(v).includes(",")||String(v).includes("\"")) ? `"${String(v).replace(/"/g,'""')}"` : String(v);
      return [r.id, ds, r.status, r.pago, Math.round(r.total)].map(esc).join(",");
    })).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "finanzas.csv"; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  // ========= Eventos =========
  $("#btnApply").onclick = loadAndRender;
  document.querySelectorAll('[data-q]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const q = btn.getAttribute('data-q');
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth()+1;
      function setMonth(inp, Y, M){ inp.value = `${Y}-${String(M).padStart(2,"0")}`; }
      if (q==='this'){ setMonth(mFrom,y,m); setMonth(mTo,y,m); }
      if (q==='prev'){ const d=new Date(y, m-2,1); setMonth(mFrom,d.getFullYear(),d.getMonth()+1); setMonth(mTo,d.getFullYear(),d.getMonth()+1); }
      if (q==='ytd'){ setMonth(mFrom,y,1); setMonth(mTo,y,m); }
      loadAndRender();
    });
  });
  $("#btnExport").onclick = exportCSV;

  // carga inicial
  loadAndRender();
  </script>
</body>
</html>
