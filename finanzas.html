<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root {
      --primary: #625A45;
      --text: #111;
      --muted: #666;
      --bg: #f8f9fa;
      --card: #ffffff;
      --radius: 16px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --green: #2e7d32;
      --red: #c62828;
      --gold: #f57f17;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, sans-serif;
    }

    /* HEADER */
    header {
      background: #fff;
      height: 70px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      padding: 0 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 800;
      font-size: 18px;
      color: var(--text);
      text-decoration: none;
    }

    .brand img {
      width: 38px;
      height: 38px;
      border-radius: 8px;
    }

    .nav-right {
      margin-left: auto;
      display: flex;
      gap: 15px;
    }

    .nav-link {
      text-decoration: none;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      padding: 8px 12px;
    }
    .nav-link.active { color: var(--primary); background: #f0f0f0; border-radius: 8px; }

    /* MAIN */
    main {
      max-width: 1000px;
      margin: 30px auto;
      padding: 0 20px;
    }

    h1, h2 { margin: 0; }
    h2 { font-size: 18px; margin-bottom: 15px; }

    /* DASHBOARD CARDS */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card);
      padding: 24px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stat-label { font-size: 13px; color: var(--muted); font-weight: 700; text-transform: uppercase; }
    .stat-value { font-size: 32px; font-weight: 800; }
    
    .income .stat-value { color: var(--green); }
    .expense .stat-value { color: var(--red); }
    .profit .stat-value { color: var(--gold); }

    /* FORMULARIO DE GASTOS */
    .expense-form {
      background: #fff0f0; /* Un rojo muy clarito para diferenciar */
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid #ffcdd2;
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    
    .form-group { flex: 1; min-width: 200px; }
    .form-group label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 5px; color: #b71c1c; }
    
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      font-size: 14px;
    }

    .btn-add {
      background: var(--red);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      height: 40px;
    }
    .btn-add:hover { background: #b71c1c; }

    /* TABLAS */
    .tables-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    @media (max-width: 800px) { .tables-grid { grid-template-columns: 1fr; } }

    .list-container {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; font-size: 12px; color: var(--muted); padding: 8px 0; border-bottom: 2px solid #eee; }
    td { padding: 12px 0; border-bottom: 1px solid #eee; font-size: 14px; }
    
    .money { font-weight: 700; text-align: right; }
    .money.in { color: var(--green); }
    .money.out { color: var(--red); }

    .date-small { font-size: 11px; color: #999; display: block; margin-top: 2px; }
    .btn-del { 
        background: none; border: none; color: #ccc; cursor: pointer; font-size: 16px; margin-left: 10px;
    }
    .btn-del:hover { color: var(--red); }
  </style>
</head>

<body>

<header>
  <a class="brand" href="#">
    <img src="images/logo.png" alt="Logo">
    <span>Rhodes Finanzas</span>
  </a>
  <nav class="nav-right">
    <a class="nav-link" href="admin.html">← Volver al Admin</a>
  </nav>
</header>

<main>
  
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h1>Balance General</h1>
    <select id="filterMonth" style="width:auto; font-weight:bold;">
        <option value="all">Todo el historial</option>
        <option value="current" selected>Este Mes</option>
    </select>
  </div>

  <div class="dashboard-grid">
    <div class="stat-card income">
      <span class="stat-label">Ingresos (Ventas)</span>
      <span class="stat-value" id="valIngresos">$0</span>
    </div>
    <div class="stat-card expense">
      <span class="stat-label">Gastos (Egresos)</span>
      <span class="stat-value" id="valGastos">$0</span>
    </div>
    <div class="stat-card profit">
      <span class="stat-label">Ganancia Neta</span>
      <span class="stat-value" id="valGanancia">$0</span>
    </div>
  </div>

  <div class="expense-form">
    <div class="form-group">
      <label>Motivo del Gasto</label>
      <input type="text" id="exDesc" placeholder="Ej: Compra de Carne, Pago Luz...">
    </div>
    <div class="form-group">
      <label>Monto ($)</label>
      <input type="number" id="exAmount" placeholder="0">
    </div>
    <div class="form-group">
        <label>Fecha</label>
        <input type="date" id="exDate">
    </div>
    <button class="btn-add" id="btnAddExpense">Registrar Gasto</button>
  </div>

  <div class="tables-grid">
    
    <div class="list-container">
      <h2>Últimas Ventas</h2>
      <table>
        <thead>
          <tr>
            <th>Pedido</th>
            <th>Detalle</th>
            <th style="text-align:right">Total</th>
          </tr>
        </thead>
        <tbody id="salesTable">
          </tbody>
      </table>
    </div>

    <div class="list-container">
      <h2>Últimos Gastos</h2>
      <table>
        <thead>
          <tr>
            <th>Motivo</th>
            <th style="text-align:right">Monto</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="expensesTable">
          </tbody>
      </table>
    </div>

  </div>

</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Poner fecha de hoy por defecto
document.getElementById('exDate').valueAsDate = new Date();

let ALL_ORDERS = [];
let ALL_EXPENSES = [];

/* =========================================
   1. CARGAR DATOS
   ========================================= */
function loadData() {
    // Escuchar Ventas
    db.collection('orders').orderBy('createdAt', 'desc').limit(100).onSnapshot(snap => {
        ALL_ORDERS = snap.docs.map(d => ({id: d.id, ...d.data()}));
        recalc();
    });

    // Escuchar Gastos (Nueva Colección)
    db.collection('expenses').orderBy('date', 'desc').limit(100).onSnapshot(snap => {
        ALL_EXPENSES = snap.docs.map(d => ({id: d.id, ...d.data()}));
        recalc();
    });
}

/* =========================================
   2. CALCULAR Y RENDERIZAR
   ========================================= */
function recalc() {
    const filter = document.getElementById('filterMonth').value;
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    // Filtros
    let orders = ALL_ORDERS.filter(o => o.status !== 'cancelled'); // Ignorar cancelados
    let expenses = ALL_EXPENSES;

    if (filter === 'current') {
        orders = orders.filter(o => {
            const d = new Date(o.createdAt);
            return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
        });
        expenses = expenses.filter(e => {
            // Manejar fecha de Firestore o String
            let d;
            if (e.date && e.date.toDate) d = e.date.toDate();
            else d = new Date(e.date);
            return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
        });
    }

    // Sumatorias
    const totalVentas = orders.reduce((acc, o) => acc + (Number(o.total) || 0), 0);
    const totalGastos = expenses.reduce((acc, e) => acc + (Number(e.amount) || 0), 0);
    const ganancia = totalVentas - totalGastos;

    // Render Dashboard
    animateValue("valIngresos", totalVentas);
    animateValue("valGastos", totalGastos);
    animateValue("valGanancia", ganancia);

    // Render Tabla Ventas
    const salesTbody = document.getElementById('salesTable');
    salesTbody.innerHTML = orders.slice(0, 10).map(o => `
        <tr>
            <td>
                #${o.orderNumber || '?'} <br>
                <span class="date-small">${new Date(o.createdAt).toLocaleDateString()}</span>
            </td>
            <td>${o.nombre || 'Cliente'}</td>
            <td class="money in">+$${(o.total||0).toLocaleString()}</td>
        </tr>
    `).join('');

    // Render Tabla Gastos
    const exTbody = document.getElementById('expensesTable');
    exTbody.innerHTML = expenses.slice(0, 10).map(e => {
        let d;
        if(e.date && e.date.toDate) d = e.date.toDate();
        else d = new Date(e.date);

        return `
        <tr>
            <td>
                ${e.description} <br>
                <span class="date-small">${d.toLocaleDateString()}</span>
            </td>
            <td class="money out">-$${(e.amount||0).toLocaleString()}</td>
            <td><button class="btn-del" onclick="deleteExpense('${e.id}')">&times;</button></td>
        </tr>
    `}).join('');
}

/* =========================================
   3. REGISTRAR GASTO
   ========================================= */
document.getElementById('btnAddExpense').onclick = async () => {
    const desc = document.getElementById('exDesc').value.trim();
    const amount = Number(document.getElementById('exAmount').value);
    const dateVal = document.getElementById('exDate').value;

    if (!desc || amount <= 0 || !dateVal) {
        alert("Completá todos los datos del gasto.");
        return;
    }

    // Corrección de fecha para que no reste un día por zona horaria
    const dateObj = new Date(dateVal + "T12:00:00"); 

    try {
        await db.collection('expenses').add({
            description: desc,
            amount: amount,
            date: firebase.firestore.Timestamp.fromDate(dateObj),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Limpiar
        document.getElementById('exDesc').value = '';
        document.getElementById('exAmount').value = '';
        alert("Gasto guardado.");
    } catch (e) {
        console.error(e);
        alert("Error al guardar.");
    }
};

/* =========================================
   4. ELIMINAR GASTO
   ========================================= */
window.deleteExpense = async (id) => {
    if(confirm("¿Borrar este gasto?")) {
        await db.collection('expenses').doc(id).delete();
    }
};

/* Helper animación números */
function animateValue(id, end) {
    const obj = document.getElementById(id);
    obj.innerHTML = (end < 0 ? "-$" : "$") + Math.abs(end).toLocaleString("es-AR");
    obj.style.color = end >= 0 ? (id === 'valGastos' ? 'var(--red)' : (id==='valGanancia'?'var(--gold)':'var(--green)')) : 'var(--red)';
}

document.getElementById('filterMonth').onchange = recalc;

// Iniciar
loadData();

</script>
</body>
</html>
