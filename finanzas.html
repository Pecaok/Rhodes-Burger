<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .danger{border-color:#ffdddd;background:#fff5f5;color:#b00000}
    main{max-width:1100px;margin:22px auto;padding:0 12px}

    /* ===== tablero estilo pedido_local ===== */
    .board{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;margin-bottom:16px}
    .board-head{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .board-kpis{display:flex;gap:12px;flex-wrap:wrap;margin-left:auto}
    .kbadge{min-width:150px;background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:10px 14px}
    .klabel{font-size:12px;color:var(--muted)}
    .kvalue{font-weight:800;font-size:20px}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    .chartwrap{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:8px}
    .chartbox{width:100%;height:260px} /* fijo como pedido_local */
    input[type="month"]{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;outline:none}
    .err{color:#b00020;font-weight:600;margin-top:8px}

    /* ===== card para pedidos presenciales ===== */
    .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px;margin-top:16px}
    .row{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    .row .col-2{grid-column:span 2}
    .row .col-3{grid-column:span 3}
    .row .col-6{grid-column:span 6}
    label{font-size:13px;font-weight:700;display:block;margin-bottom:6px}
    input[type="text"], input[type="number"], select{
      width:100%;border:1px solid var(--ring);border-radius:10px;padding:10px;outline:none
    }
    .muted{color:var(--muted);font-size:13px}
    .ok{color:#0b7a3a;font-weight:700}
    @media (max-width:900px){
      .charts{grid-template-columns:1fr}
      .row{grid-template-columns:1fr 1fr}
      .row .col-2,.row .col-3,.row .col-6{grid-column:span 2}
    }
  </style>
</head>
<body>
  <!-- Guardia de acceso (sesión 20 hs) -->
  <script>
    (function guard(){
      const exp = parseInt(localStorage.getItem('rb_auth_expires')||'0',10);
      const now = Date.now();
      if (!exp || now > exp) {
        localStorage.removeItem('rb_auth_token');
        localStorage.removeItem('rb_auth_expires');
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=expired&next=' + next);
        return;
      }
      setTimeout(()=>{
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=expired&next=' + next);
      }, Math.min(exp-now, 2147483647));
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn" href="pedido_local.html">← Volver a pedidos</a>
      <button id="btnLogout" class="btn danger">⏻ Cerrar sesión</button>
    </div>
  </header>

  <main>
    <!-- ====== tablero superior con KPIs + dos gráficos fijos -->
    <section class="board">
      <div class="board-head">
        <strong>Resumen mensual</strong>
        <input type="month" id="monthPicker">
        <button id="btnReload" class="btn">Actualizar</button>

        <div class="board-kpis">
          <div class="kbadge"><div class="klabel">Pedidos</div><div class="kvalue" id="kpiCount">—</div></div>
          <div class="kbadge"><div class="klabel">Ingresos</div><div class="kvalue" id="kpiRevenue">—</div></div>
          <div class="kbadge"><div class="klabel">Ticket promedio</div><div class="kvalue" id="kpiAvg">—</div></div>
        </div>
      </div>

      <div class="charts">
        <div class="chartwrap">
          <canvas id="monthChart" class="chartbox"></canvas>
        </div>
        <div class="chartwrap">
          <canvas id="payChart" class="chartbox"></canvas>
        </div>
      </div>

      <div id="kpiError" class="err" style="display:none;margin-top:6px"></div>
    </section>

    <!-- ====== Alta rápida de pedidos presenciales ====== -->
    <section class="card">
      <h2 style="margin-top:0">Agregar pedido presencial</h2>
      <div class="row">
        <div class="col-3">
          <label>Nombre (opcional)</label>
          <input type="text" id="mpNombre" placeholder="Ej: Juan Pérez">
        </div>
        <div class="col-2">
          <label>Total</label>
          <input type="number" id="mpTotal" placeholder="Ej: 10900" min="0" step="1">
          <div class="muted">En ARS, sin puntos ni comas.</div>
        </div>
        <div class="col-2">
          <label>Medio de pago</label>
          <select id="mpPago">
            <option value="efectivo">Efectivo</option>
            <option value="mercado_pago">Mercado Pago</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        <div class="col-2">
          <label>Estado</label>
          <select id="mpEstado">
            <option value="delivered">Entregado</option>
            <option value="ready">Listo para retirar</option>
            <option value="in_prep">En preparación</option>
            <option value="accepted">Recibido</option>
          </select>
        </div>
        <div class="col-6">
          <label>Notas (opcional)</label>
          <input type="text" id="mpNotas" placeholder="Ej: sin cebolla, pasó 20:30, etc.">
        </div>
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <div class="col-3">
          <label style="display:flex;gap:8px;align-items:center;font-weight:600">
            <input type="checkbox" id="mpPagado" checked> Marcar como PAGADO
          </label>
          <div class="muted">Si es efectivo y no pagó, destildá.</div>
        </div>
        <div class="col-3">
          <button id="btnCrearManual" class="btn">➕ Crear pedido</button>
          <span id="mpMsg" class="muted" style="margin-left:8px"></span>
        </div>
      </div>
    </section>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    /* ===================== FIREBASE ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(_){}
    const db = firebase.firestore();

    /* ===================== HELPERS ===================== */
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    (function setDefaultMonth(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      $("#monthPicker").value = `${d.getFullYear()}-${m}`;
    })();

    function pickDocDate(obj){
      const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
      for (const k of cand){
        const v = obj?.[k]; if (v==null) continue;
        try{
          if (v?.toDate) return v.toDate();
          if (typeof v === 'number') return new Date(v);
          if (typeof v === 'string') { const d = new Date(v); if(!isNaN(d)) return d; }
        }catch(_){}
      }
      return null;
    }
    function unitWithExtras(it){
      const base = it.price || 0;
      const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0);
      const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
      return base + pz + ch;
    }
    function computeOrderTotal(o){
      if (typeof o.total === "number") return o.total;
      const items = Array.isArray(o.items) ? o.items : [];
      return items.reduce((t,it)=> t + (it.type==="burger" ? unitWithExtras(it) : (it.price||0)) * (it.qty||0), 0);
    }

    /* ===================== CHARTS ===================== */
    let monthChart, payChart;

    function ensureMonthChart(labels, orders, revenue){
      const ctx = document.getElementById("monthChart").getContext("2d");
      if(monthChart) monthChart.destroy();
      monthChart = new Chart(ctx,{type:'bar',data:{labels,
        datasets:[
          {type:'bar',label:'Pedidos',data:orders,backgroundColor:'rgba(46,204,113,.55)',borderColor:'#22b266',borderWidth:1.5,yAxisID:'y'},
          {type:'line',label:'Ingresos ($)',data:revenue,borderColor:'#1b6a3c',backgroundColor:'rgba(46,204,113,.10)',borderWidth:3,tension:.25,pointRadius:3,fill:false,yAxisID:'y2'}
        ]},
        options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
          scales:{y:{beginAtZero:true},y2:{beginAtZero:true,position:'right',grid:{drawOnChartArea:false}},x:{grid:{display:false}}}}
      });
    }
    function ensurePayChart(labels, values){
      const ctx = document.getElementById('payChart').getContext('2d');
      if (payChart) payChart.destroy();
      payChart = new Chart(ctx, {
        type:'bar',
        data:{labels,datasets:[{label:'Pedidos',data:values,backgroundColor:['#22b266','#2ecc71','#9adfb8'],borderColor:['#1b8e52','#22b266','#78c79b'],borderWidth:1.5}]},
        options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true},y:{grid:{display:false}}}}
      });
    }

    /* ===================== CARGA DE DATOS ===================== */
    async function loadFinance(){
      $("#kpiError").style.display="none"; $("#kpiError").textContent="";
      try{
        // ordenar por campo fecha si existe
        const probe = await db.collection('orders').limit(1).get();
        let dateField = null;
        if (!probe.empty) {
          const sample = probe.docs[0].data();
          for (const k of ['createdAt','created_at','timestamp','date','fecha','time']) { if (sample[k]!=null){ dateField=k; break; } }
        }
        let q = db.collection('orders');
        if (dateField) q = q.orderBy(dateField,'desc'); else q = q.orderBy(firebase.firestore.FieldPath.documentId());
        const snap = await q.limit(2000).get();

        // mes elegido
        const d = new Date($("#monthPicker").value + '-01T00:00:00');
        const y=d.getFullYear(), m=d.getMonth();
        const days=new Date(y,m+1,0).getDate();
        const labels = Array.from({length:days},(_,i)=>`${i+1}`);
        const dayOrders = Array(days).fill(0);
        const dayRevenue = Array(days).fill(0);
        const payDist = { efectivo:0, mercado_pago:0, otro:0 };
        let count=0, revenue=0;

        snap.forEach(doc=>{
          const o=doc.data(); const dt=pickDocDate(o); if(!dt) return;
          if (dt.getFullYear()!==y || dt.getMonth()!==m) return;
          const i=dt.getDate()-1;
          const tot=computeOrderTotal(o);
          dayOrders[i]+=1; dayRevenue[i]+=tot; count++; revenue+=tot;

          const mp=(o.pago||'otro').toLowerCase();
          if (mp.includes('efectivo')) payDist.efectivo++;
          else if (mp.includes('mercado')) payDist.mercado_pago++;
          else payDist.otro++;
        });

        // KPIs
        $("#kpiCount").textContent = count.toLocaleString("es-AR");
        $("#kpiRevenue").textContent = money(revenue);
        $("#kpiAvg").textContent = count ? money(revenue/count) : money(0);

        // Gráficos fijos
        ensureMonthChart(labels, dayOrders, dayRevenue);
        ensurePayChart(['Mercado Pago','Efectivo','Otro'], [payDist.mercado_pago, payDist.efectivo, payDist.otro]);

      }catch(err){
        console.error(err);
        $("#kpiError").textContent = "No se pudo cargar el resumen.";
        $("#kpiError").style.display="block";
      }
    }

    // ===== Contador y creación de pedidos presenciales =====
    async function takeNextOrderNumber(tx){
      const ref = db.collection("config").doc("counters");
      const snap = await tx.get(ref);
      const prev = snap.exists ? (snap.data().orderNumber||0) : 0;
      const next = prev + 1;
      tx.set(ref,{orderNumber:next},{merge:true});
      return next;
    }
    async function createManualOrder(){
      const nombre = $("#mpNombre").value.trim();
      const total  = parseInt($("#mpTotal").value, 10);
      const pago   = $("#mpPago").value;
      const estado = $("#mpEstado").value;
      const notas  = $("#mpNotas").value.trim();
      const pagado = $("#mpPagado").checked;

      const msg = $("#mpMsg"); msg.textContent=""; msg.className="muted";

      if (!Number.isFinite(total) || total<=0){
        msg.textContent = "Ingresá un total válido."; return;
      }

      try{
        let newId=null, orderNumber=null;
        await db.runTransaction(async (tx)=>{
          const next = await takeNextOrderNumber(tx);
          orderNumber = next;
          const ref = db.collection("orders").doc();
          const order = {
            orderNumber,
            nombre,
            telefono: "",
            entrega: "take_away",
            pago,
            paymentStatus: (pago==='efectivo' ? (pagado?'paid':'unpaid') : 'paid'),
            notes: notas,
            status: estado,
            items: [],                // sin ítems: usamos 'total' directo
            total: total,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          tx.set(ref, order, {merge:false});
          newId = ref.id;
        });

        msg.textContent = `Pedido #${orderNumber} creado.`;
        msg.className = "ok";
        // limpiar
        $("#mpNombre").value=""; $("#mpTotal").value=""; $("#mpNotas").value="";
        $("#mpPago").value="efectivo"; $("#mpEstado").value="delivered"; $("#mpPagado").checked=true;

        // refrescar tablero
        await loadFinance();
      }catch(e){
        console.error(e);
        msg.textContent = "No se pudo crear el pedido. Probá de nuevo.";
        msg.className = "err";
      }
    }

    // Eventos
    $("#btnReload").addEventListener('click', loadFinance);
    $("#monthPicker").addEventListener('change', loadFinance);
    $("#btnCrearManual").addEventListener('click', createManualOrder);
    $("#btnLogout").addEventListener('click', ()=>{
      localStorage.removeItem('rb_auth_token');
      localStorage.removeItem('rb_auth_expires');
      location.replace('login.html?reason=logout');
    });

    // Cargar al entrar
    document.addEventListener('DOMContentLoaded', loadFinance);
  </script>
</body>
</html>
