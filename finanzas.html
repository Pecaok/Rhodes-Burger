<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Paleta de Colores */
      --primary: #625A45; 
      --primary-dark: #4a4434;
      --text: #1f2937; 
      --muted: #6b7280; 
      --bg: #f3f4f6; 
      --card: #ffffff;
      --ring: #e5e7eb; 
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --font: 'Inter', sans-serif;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gold: #d97706; 
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      -webkit-font-smoothing: antialiased;
    }
    
    /* HEADER */
    header { 
      position: sticky; top: 0; z-index: 1000; background: #fff; 
      border-bottom: 1px solid var(--ring); 
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    .topbar { 
      max-width: 1200px; margin: 0 auto; height: 64px; padding: 0 16px; 
      display: flex; align-items: center; gap: 8px; 
    }
    .brand { 
      font-weight: 800; font-size: 18px; color: var(--primary); 
      display: flex; align-items: center; text-decoration: none; margin-right: 12px; 
    }
    .brand img { width: 32px; height: 32px; border-radius: 8px; margin-right: 10px; }
    .spacer { flex: 1; }
    
    /* NAV BUTTONS */
    .nav-btn { 
      padding: 8px 12px; border-radius: 8px; text-decoration: none; 
      color: #4b5563; font-weight: 600; font-size: 14px; transition: all 0.2s; 
      border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px; 
      cursor: pointer; background: transparent; 
    }
    .nav-btn:hover { background: #f9fafb; color: #111; }
    .nav-btn.active { background: var(--primary); color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .btn-danger { color: #d32f2f; background: #ffebee; border: 1px solid #ffcdd2; }

    /* DROPDOWN */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { 
      display: none; position: absolute; background-color: #fff; min-width: 180px; 
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-radius: 12px; 
      border: 1px solid var(--ring); z-index: 2000; top: 120%; right: 0; padding: 6px; 
    }
    .dropdown.show .dropdown-content { display: block; animation: slideDown 0.15s ease-out; }
    .dropdown-content a { 
      display: block; padding: 10px 12px; text-decoration: none; color: #374151; 
      font-size: 14px; font-weight: 500; border-radius: 6px; 
    }
    .dropdown-content a:hover { background: #f3f4f6; color: var(--primary); }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

    /* LAYOUT MAIN */
    .container { max-width: 1200px; margin: 32px auto; padding: 0 16px; }
    h1 { font-size: 28px; font-weight: 800; margin: 0 0 24px; color: #111; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
    .card { background: var(--card); border-radius: 16px; box-shadow: var(--shadow); padding: 24px; border: 1px solid var(--ring); }
    
    /* CONTROLS AREA */
    .controls-row { display: flex; justify-content: space-between; align-items: flex-end; gap: 20px; margin-bottom: 24px; flex-wrap: wrap; }
    .inline-inputs { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    label { font-weight: 600; display: block; margin: 0 0 6px; font-size: 13px; color: var(--muted); }
    select, input { padding: 9px 12px; border: 1px solid var(--ring); border-radius: 8px; font-family: inherit; font-size: 14px; background: #fff; min-width: 140px; }
    
    .btn-dash { 
      display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--ring); 
      background: #fff; padding: 9px 16px; border-radius: 8px; cursor: pointer; 
      font-weight: 600; color: #374151; font-size: 14px; transition: all 0.2s; 
    }
    .btn-dash:hover { background: #f9fafb; }
    .btn-dash.primary { background: var(--primary); color: #fff; border-color: var(--primary); }
    .btn-dash.success { background: #ecfdf5; color: #047857; border-color: #a7f3d0; }
    .btn-dash.danger { background: #fef2f2; color: #dc2626; border-color: #fecaca; } 
    .btn-dash.danger:hover { background: #fee2e2; }

    /* KPIs GRID */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .kpi-card { background: #f9fafb; border: 1px solid var(--ring); border-radius: 12px; padding: 16px; }
    .klabel { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; margin-bottom: 4px; }
    .kvalue { font-weight: 800; font-size: 28px; color: #111; }
    .kvalue.green { color: var(--success); }
    .kvalue.red { color: var(--danger); }
    .kvalue.gold { color: var(--gold); }

    /* EXPENSE FORM STYLE */
    .expense-box { background: #fffbf0; border: 1px solid #fde68a; padding: 20px; border-radius: 12px; margin-bottom: 24px; }
    .expense-header { font-size: 15px; font-weight: 700; color: #92400e; margin-bottom: 15px; display:flex; align-items:center; gap:8px;}

    /* TABLES & CHARTS */
    .panel { border: 1px solid var(--ring); background: #fafafa; border-radius: 12px; padding: 20px; }
    .panel h3 { font-size: 16px; font-weight: 700; margin: 0 0 16px; color: #111; }
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th { text-align: left; font-size: 12px; text-transform: uppercase; color: var(--muted); font-weight: 700; padding: 10px 12px; border-bottom: 2px solid #eee; }
    td { padding: 12px; border-bottom: 1px solid #f3f4f6; color: #374151; font-weight: 500; }
    .num-cell { text-align: right; font-variant-numeric: tabular-nums; }
    
    .chartWrap { height: 300px; position: relative; }
    .chartWrapTall { height: 380px; position: relative; }
    .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 24px; margin-top: 24px; }
    .chart-card { background: #fff; border: 1px solid var(--ring); border-radius: 12px; padding: 16px; }
    .chart-title { font-size: 15px; font-weight: 700; color: #374151; margin-bottom: 12px; display: block; }
    
    /* CALENDARS */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 16px; }
    .cal-day { background: #fff; border-radius: 12px; height: 100px; padding: 8px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #e5e7eb; }
    .cal-empty { background: #f9fafb; border-style: dashed; }
    .cal-num { font-size: 12px; font-weight: 700; color: #9ca3af; text-align: right; }
    .cal-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; }
    .cal-pill { background: #ecfdf5; color: #047857; border-radius: 99px; padding: 2px 8px; font-size: 11px; font-weight: 700; }
    .cal-burger-hero { font-size: 13px; font-weight: 800; color: #333; }

    /* SUPPLY */
    .supply-card { border-top: 4px solid var(--warning); }
    .supply-pill-meat { color:#795548; font-weight:800; font-size:13px; background: #efebe9; padding: 2px 6px; border-radius: 4px; }
    .supply-pill-fries { color:#F57F17; font-weight:800; font-size:13px; background: #fffde7; padding: 2px 6px; border-radius: 4px; }
    
    @media (max-width: 768px) {
      .brand span, .nav-btn span { display: none; }
      .nav-btn { padding: 8px; }
      .controls-row, .inline-inputs { flex-direction: column; align-items: stretch; }
      .kpi-grid { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  
  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      if (qs.get('auth')==='1') {
        localStorage.setItem('rb_admin_ok','true');
        localStorage.setItem('rb_admin_t', String(Date.now()));
      }
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      if (!(ok && (Date.now()-ts < 72000000))){ location.replace('login.html'); }
      localStorage.setItem('rb_admin_t', String(Date.now()));
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png"><span>Finanzas</span></a>
      <div class="spacer"></div>
      
      <a href="pedido_local.html" class="nav-btn">üì¶ <span>Pedidos</span></a>
      <a href="finanzas.html" class="nav-btn active">üìà <span>Finanzas</span></a>
      <div class="dropdown">
        <button onclick="document.querySelector('.dropdown').classList.toggle('show')" class="nav-btn">üìã <span>Stock ‚ñæ</span></button>
        <div class="dropdown-content">
            <a href="stock.html">üì¶ Stock</a>
            <a href="ingresos.html">üì• Ingresos</a>
        </div>
      </div>
      <a href="mostrador.html" class="nav-btn">üßæ <span>Mostrador</span></a>
      <a href="admin.html" class="nav-btn">‚öôÔ∏è <span>Admin</span></a>
      <button id="btnLogout" class="nav-btn btn-danger">Salir</button>
    </div>
  </header>

  <main class="container">
    <h1>Resumen & Control</h1>

    <div class="grid">
      <section class="card">
        
        <div class="controls-row">
          <div class="inline-inputs">
             <div><label>Mes</label><input type="month" id="monthPicker" /></div>
             <div><label>Desde</label><input type="date" id="fromDate" /></div>
             <div><label>Hasta</label><input type="date" id="toDate" /></div>
             <button id="btnReload" class="btn-dash primary">Actualizar</button>
          </div>
          <div><button id="btnExport" class="btn-dash success">üì• Excel</button></div>
        </div>

        <div class="kpi-grid">
           <div class="kpi-card">
              <div class="klabel">Ingresos (Ventas)</div>
              <div class="kvalue green" id="kpiRevenue">‚Äî</div>
           </div>
           <div class="kpi-card">
              <div class="klabel">Gastos (Egresos)</div>
              <div class="kvalue red" id="kpiExpenses">‚Äî</div>
           </div>
           <div class="kpi-card">
              <div class="klabel">Ganancia Neta</div>
              <div class="kvalue gold" id="kpiProfit">‚Äî</div>
           </div>
           <div class="kpi-card">
              <div class="klabel">Pedidos Totales</div>
              <div class="kvalue" id="kpiCount">‚Äî</div>
           </div>
        </div>

        <div class="expense-box">
            <div class="expense-header">
                <span style="font-size:20px">üí∏</span> Registrar Nuevo Gasto
            </div>
            <div class="inline-inputs">
                <div style="flex:2">
                    <label>Motivo del Gasto</label>
                    <input type="text" id="exDesc" placeholder="Ej: Compra de Carne, Pago Luz...">
                </div>
                <div style="flex:1">
                    <label>Monto ($)</label>
                    <input type="number" id="exAmount" placeholder="0">
                </div>
                <div style="flex:1">
                    <label>Fecha</label>
                    <input type="date" id="exDate">
                </div>
                <button id="btnAddExpense" class="btn-dash primary" style="height:40px; margin-bottom:1px">Registrar</button>
            </div>
        </div>

        <div class="data-row">
            <div class="panel">
                <h3>üí∞ Cierre de Caja (Ventas)</h3>
                <div id="cashBreakdown">
                    <div class="text-muted">Cargando...</div>
                </div>
            </div>

            <div class="panel">
                <h3>üìã √öltimos Gastos Registrados</h3>
                <div class="table-responsive" style="max-height:250px; overflow-y:auto">
                    <table id="expensesTable">
                        <thead><tr><th>Fecha</th><th>Motivo</th><th class="num-cell">Monto</th><th></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div style="margin-top:32px">
            <h3 class="chart-title">üìä Evoluci√≥n Mensual (Dinero y Cantidad)</h3>
            <div class="chartWrapTall"><canvas id="monthlyChart"></canvas></div>
        </div>

        <div style="margin-top:32px">
          <h3 class="chart-title">Evoluci√≥n Diaria (Mes Seleccionado)</h3>
          <div class="chartWrapTall"><canvas id="ordersChart"></canvas></div>
        </div>

        <div class="charts-row">
          <div class="chart-card"><span class="chart-title">Medios de pago</span><div class="chartWrap"><canvas id="payChart"></canvas></div></div>
          <div class="chart-card"><span class="chart-title">Origen (Canal $)</span><div class="chartWrap"><canvas id="sourceChart"></canvas></div></div>
          <div class="chart-card"><span class="chart-title">Top 5 Clientes</span>
             <div class="table-responsive" style="margin-top:10px">
                <table id="topClientsTable">
                    <thead><tr><th>Cliente</th><th class="num-cell">$ Total</th></tr></thead>
                    <tbody></tbody>
                </table>
             </div>
          </div>
        </div>

        <div class="card" style="margin-top:32px; border:1px solid var(--ring); box-shadow:none; background:#fafafa;">
          <div class="controls-row" style="margin-bottom:10px;">
            <strong>Calendario de Ventas</strong>
            <div class="inline-inputs" style="gap:5px;">
              <input type="month" id="calMonth" style="border:none; background:transparent; font-weight:bold; cursor:pointer;">
              <button id="calPrev" class="btn-dash" style="padding:4px 10px;">‚óÄ</button>
              <button id="calNext" class="btn-dash" style="padding:4px 10px;">‚ñ∂</button>
              <span id="calRange" class="text-muted" style="font-size:14px; margin-left:10px; font-weight:600;">‚Äî</span>
            </div>
          </div>
          <div id="calendarGrid" class="calendar-grid"></div>
        </div>

        <div class="card supply-card" style="margin-top:24px; border:1px solid var(--ring); box-shadow:none; background:#fff;">
          <div style="display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:15px;">
              <strong>ü•© Control de Insumos (Estimado)</strong>
              <span id="supplyRange" style="font-size:13px; font-weight:600; color:#555;">‚Äî</span>
          </div>
          <div style="display:flex; gap:15px; margin-bottom:10px; font-size:12px;">
            <span class="supply-pill-meat">ü•© = Medallones</span>
            <span class="supply-pill-fries">üçü = Papas (kg)</span>
          </div>
          <div id="supplyGrid" class="calendar-grid"></div>
        </div>

      </section>
    </div>
  </main>

 <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // 1. VARIABLES GLOBALES
    let CURRENT_ORDERS = [];
    let ALL_EXPENSES = [];
    let mainChart, d1, d2, monthlyChartInstance; 

    document.addEventListener('DOMContentLoaded', () => {
        
        // 2. CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
          authDomain: "rhodes-burguers.firebaseapp.com",
          projectId: "rhodes-burguers",
          storageBucket: "rhodes-burguers.firebasestorage.app",
          messagingSenderId: "951646688091",
          appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.firestore();

        // 3. HELPERS
        const $ = s => document.getElementById(s);
        const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
        
        function parseDateAny(val){
            if(!val) return null;
            if(val.toDate) return val.toDate();
            if(typeof val === 'string') return new Date(val);
            return new Date(val);
        }

        // LOGOUT
        if($('btnLogout')){
            $('btnLogout').onclick = ()=>{
                localStorage.removeItem('rb_auth_v2'); 
                localStorage.removeItem('rb_admin_ok');
                location.replace('login.html');
            };
        }

        // 4. INICIALIZACI√ìN DE FECHAS
        const now = new Date();
        const ym = now.toISOString().slice(0,7);
        if($('monthPicker')) $('monthPicker').value = ym;
        if($('calMonth')) $('calMonth').value = ym;
        if($('exDate')) $('exDate').valueAsDate = now;

        // 5. EVENTOS
        if($('btnReload')) $('btnReload').onclick = loadKPI;
        if($('calPrev')) $('calPrev').onclick = () => { stepMonth(-1); renderCalendar(); };
        if($('calNext')) $('calNext').onclick = () => { stepMonth(1); renderCalendar(); };
        if($('btnExport')) $('btnExport').onclick = exportExcel;
        if($('btnAddExpense')) $('btnAddExpense').onclick = addExpense;

        // 6. CARGA DE DATOS AUTOM√ÅTICA
        loadData();

        function loadData() {
            // üî• AUMENTADO L√çMITE A 1000 PARA VER HISTORIA MES A MES
            db.collection('orders').orderBy('createdAt', 'desc').limit(1000).onSnapshot(snap => {
                CURRENT_ORDERS = snap.docs.map(d => ({id: d.id, ...d.data()}));
                loadKPI(); 
                renderCalendar();
                renderMonthlyChart(CURRENT_ORDERS); 
            });
            // Escuchar Gastos
            db.collection('expenses').orderBy('date', 'desc').limit(50).onSnapshot(snap => {
                ALL_EXPENSES = snap.docs.map(d => ({id: d.id, ...d.data()}));
                loadKPI(); 
            });
        }

        // =========================================
        // L√ìGICA PRINCIPAL (KPIs + Tablas + Gr√°ficos)
        // =========================================
        async function loadKPI(){
            const fromInp = $('fromDate').value;
            const toInp = $('toDate').value;
            const monthInp = $('monthPicker').value;
            
            let start, end, isRange = false;
            if(fromInp && toInp){
               isRange = true;
               start = new Date(fromInp + 'T00:00:00');
               end = new Date(toInp + 'T23:59:59');
            } else {
               const d = monthInp ? new Date(monthInp + '-01T00:00:00') : new Date();
               start = new Date(d.getFullYear(), d.getMonth(), 1, 0, 0, 0);
               end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59);
            }

            // Filtrar en Memoria
            const filteredOrders = CURRENT_ORDERS.filter(o => {
                const dt = parseDateAny(o.createdAt);
                if(!dt) return false;
                if(o.status?.includes('cancel')) return false; // Ignorar cancelados
                return dt >= start && dt <= end;
            });

            const filteredExpenses = ALL_EXPENSES.filter(e => {
                const dt = parseDateAny(e.date);
                if(!dt) return false;
                return dt >= start && dt <= end;
            });

            // C√°lculos
            let totalRevenue = 0, totalOrders = 0;
            const payStats = {}, sourceStats = {}, clientStats = {};
            
            filteredOrders.forEach(o => {
                const total = Number(o.total || o.rawTotal || 0);
                totalOrders++;
                totalRevenue += total;

                // Stats Pago
                let pay = (o.pago || 'otro').toLowerCase();
                if(pay.includes('efectivo')) pay = 'Efectivo';
                else if(pay.includes('mercado')||pay.includes('mp')) pay = 'Mercado Pago';
                else if(pay.includes('debito')) pay = 'D√©bito';
                else if(pay.includes('transfer')) pay = 'Transferencia';
                payStats[pay] = (payStats[pay]||0) + total;

                // Stats Source ($)
                let src = (o.source || 'web').toLowerCase();
                sourceStats[src] = (sourceStats[src]||0) + total; 

                // Stats Cliente
                const cli = (o.nombre||'An√≥nimo').trim();
                if(!clientStats[cli]) clientStats[cli]={total:0};
                clientStats[cli].total+=total;
            });

            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + (Number(e.amount)||0), 0);
            const netProfit = totalRevenue - totalExpenses;

            // Renderizar DOM
            $('kpiCount').textContent = totalOrders;
            $('kpiRevenue').textContent = money(totalRevenue);
            $('kpiExpenses').textContent = money(totalExpenses);
            $('kpiProfit').textContent = money(netProfit);
            $('kpiProfit').className = 'kvalue ' + (netProfit >= 0 ? 'gold' : 'red');

            // Render Caja
            let cashHTML = '';
            for(const [k,v] of Object.entries(payStats)) cashHTML += `<div class="cash-row"><span>${k}</span><span>${money(v)}</span></div>`;
            cashHTML += `<div class="cash-row cash-total"><span>TOTAL VENTAS</span><span>${money(totalRevenue)}</span></div>`;
            
            cashHTML += '<hr style="margin:8px 0; border:0; border-top:1px dashed #ddd">';
            for(const [src, total] of Object.entries(sourceStats)) {
                cashHTML += `<div class="cash-row" style="font-size:13px; color:#555"><span>Canal: ${src.toUpperCase()}</span><span>${money(total)}</span></div>`;
            }

            $('cashBreakdown').innerHTML = cashHTML;

            // Render Tabla Gastos
            const expBody = $('expensesTable').querySelector('tbody');
            expBody.innerHTML = filteredExpenses.map(e => {
                const d = parseDateAny(e.date).toLocaleDateString();
                return `<tr>
                    <td>${d}</td>
                    <td>${e.description}</td>
                    <td class="num-cell" style="color:var(--danger)">-$${(e.amount||0).toLocaleString()}</td>
                    <td style="text-align:right"><button class="btn-dash danger" onclick="deleteExpense('${e.id}')" style="padding:4px 8px; font-size:12px">X</button></td>
                </tr>`;
            }).join('');

            // Top Clientes
            const topCli = Object.entries(clientStats).sort((a,b)=>b[1].total - a[1].total).slice(0,5);
            $('topClientsTable').querySelector('tbody').innerHTML = topCli.map(([n,d])=>`<tr><td>${n}</td><td class="num-cell">${money(d.total)}</td></tr>`).join('');

            // Gr√°ficos
            if(!isRange) renderMixedChart(filteredOrders, filteredExpenses, end.getDate());
            renderDoughnut("payChart", Object.keys(payStats), Object.values(payStats));
            renderDoughnut("sourceChart", Object.keys(sourceStats), Object.values(sourceStats));
        }

        // =========================================
        // FUNCIONES DE GASTOS
        // =========================================
        async function addExpense() {
            const desc = $('exDesc').value.trim();
            const amount = Number($('exAmount').value);
            const dateVal = $('exDate').value;

            if (!desc || amount <= 0 || !dateVal) return alert("Complet√° todos los datos.");

            const dateObj = new Date(dateVal + "T12:00:00"); 
            try {
                await db.collection('expenses').add({
                    description: desc,
                    amount: amount,
                    date: firebase.firestore.Timestamp.fromDate(dateObj),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                $('exDesc').value = ''; $('exAmount').value = '';
                alert("Gasto guardado.");
            } catch (e) { alert("Error al guardar."); }
        }

        window.deleteExpense = async (id) => {
            if(confirm("¬øBorrar este gasto?")) await db.collection('expenses').doc(id).delete();
        };

        function exportExcel(){
            if(!CURRENT_ORDERS.length) return alert("Sin datos para exportar.");
            let csv = "Fecha,Pedido,Cliente,Pago,Total,Estado,Canal\n";
            CURRENT_ORDERS.forEach(o=>{
                const d = parseDateAny(o.createdAt)?.toLocaleDateString()||'';
                csv += `${d},${o.orderNumber},"${(o.nombre||'').replace(/"/g,'')}",${o.pago},${o.total},${o.status},${o.source||'web'}\n`;
            });
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "ventas_rhodes.csv";
            link.click();
        }

        // =========================================
        // üî• NUEVO GR√ÅFICO MES A MES "PREMIUM"
        // =========================================
        function renderMonthlyChart(orders) {
            const groups = {};
            orders.forEach(o => {
                const d = parseDateAny(o.createdAt);
                if(!d || o.status?.includes('cancel')) return;
                const key = `${d.getMonth()+1}/${d.getFullYear()}`; 
                const sortKey = d.getFullYear()*100 + (d.getMonth()+1); 
                if(!groups[sortKey]) groups[sortKey] = { label: key, money: 0, count: 0 };
                groups[sortKey].money += Number(o.total||0);
                groups[sortKey].count += 1;
            });

            const sortedKeys = Object.keys(groups).sort((a,b) => a - b);
            const labels = sortedKeys.map(k => groups[k].label);
            const dataMoney = sortedKeys.map(k => groups[k].money);
            const dataCount = sortedKeys.map(k => groups[k].count);

            const ctx = $('monthlyChart').getContext('2d');
            if(monthlyChartInstance) monthlyChartInstance.destroy();

            // üî• DEGRADADO DORADO PARA BARRAS
            let gradGold = ctx.createLinearGradient(0, 0, 0, 400);
            gradGold.addColorStop(0, '#d97706'); // Dorado oscuro arriba
            gradGold.addColorStop(1, '#78350f'); // Marr√≥n abajo

            monthlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ventas ($)',
                            data: dataMoney,
                            backgroundColor: gradGold,
                            borderRadius: 8,
                            barPercentage: 0.6,
                            yAxisID: 'y',
                            order: 2
                        },
                        {
                            label: 'Cant. Pedidos',
                            data: dataCount,
                            type: 'line',
                            borderColor: '#fbbf24', // Amarillo Brillante
                            backgroundColor: '#fff',
                            borderWidth: 4,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointBackgroundColor: '#fbbf24',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top', labels: { usePointStyle: true, font: { weight: '700' } } },
                        tooltip: {
                            backgroundColor: '#fff',
                            titleColor: '#111',
                            bodyColor: '#333',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true,
                            usePointStyle: true
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            grid: { borderDash: [5, 5], color: '#e5e7eb' },
                            ticks: { callback: function(value) { return '$' + value.toLocaleString(); } }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: { drawOnChartArea: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // =========================================
        // CALENDARIO E INSUMOS
        // =========================================
        async function renderCalendar(){
            const ym = $('calMonth').value;
            if(!ym) return;
            const [y, m] = ym.split('-').map(Number);
            const start = new Date(y, m-1, 1);
            const end = new Date(y, m, 0, 23, 59, 59);
            
            const orders = CURRENT_ORDERS.filter(o => {
                const dt = parseDateAny(o.createdAt);
                return dt && dt >= start && dt <= end && !o.status?.includes('cancel');
            });
            
            const days = end.getDate();
            const totals = Array(days).fill(0);
            const counts = Array(days).fill(0); 
            const meatCounts = Array(days).fill(0); 
            const friesKilos = Array(days).fill(0); 

            orders.forEach(o=>{
                const dt = parseDateAny(o.createdAt);
                const d = dt.getDate()-1;
                totals[d]+=Number(o.total||0);
                
                (o.items||[]).forEach(item => {
                    const name = (item.name || '').toLowerCase();
                    const qty = Number(item.qty || 1);
                    
                    const bebidas = ['agua', 'cola', 'cerveza', 'andes', 'aquarius', 'pepsi', '7up', 'heineken', 'corona', 'patagonia', 'brahma', 'quilmes', 'stella', 'imperial', 'sprite', 'levite', 'paso de los toros'];
                    const esBebida = bebidas.some(b => name.includes(b)) || item.type === 'drink';
                    
                    const guarniciones = ['papas', 'fritas', 'nugget', 'aros', 'bastones', 'guarnicion'];
                    const esPapas = guarniciones.some(g => name.includes(g)) || item.type === 'side';

                    const esBurger = !esBebida && !esPapas;

                    if (esBurger) {
                        counts[d] += qty; 

                        let patties = 1; 
                        if(name.includes('doble')) patties = 2;
                        if(name.includes('triple')) patties = 3;
                        if(name.includes('cuadruple')) patties = 4;

                        if(item.extras && item.extras.patty){
                            patties += Number(item.extras.patty);
                        }
                        meatCounts[d] += (patties * qty);
                        friesKilos[d] += (0.200 * qty);
                    }
                });
            });

            // Render Calendario
            const grid = $('calendarGrid');
            grid.innerHTML = '';
            const startDay = new Date(y, m-1, 1).getDay(); 
            for(let i=0; i<startDay; i++) grid.insertAdjacentHTML('beforeend', '<div></div>');
            
            totals.forEach((t, i)=>{
                const c = counts[i];
                const html = `<div class="cal-day ${c?'':'cal-empty'}"><div class="cal-num">${i+1}</div>${c?`<div class="cal-content"><div class="cal-burger-hero">üçî ${c}</div><div class="cal-pill">${money(t)}</div></div>`:''}</div>`;
                grid.insertAdjacentHTML('beforeend', html);
            });
            $('calRange').textContent = `Total: ${money(totals.reduce((a,b)=>a+b,0))}`;

            // Render Insumos
            const supplyGrid = $('supplyGrid');
            if(supplyGrid){
                supplyGrid.innerHTML = '';
                for(let i=0; i<startDay; i++) supplyGrid.insertAdjacentHTML('beforeend', '<div></div>');
                meatCounts.forEach((mCount, i)=>{
                    const fCount = friesKilos[i]; 
                    const active = mCount > 0 || fCount > 0;
                    const html = `<div class="cal-day ${active?'':'cal-empty'}" style="${active?'border-color:#f59e0b':''}"><div class="cal-num">${i+1}</div>${active ? `<div class="cal-content" style="gap:4px;"><span class="supply-pill-meat">ü•© ${mCount}</span><span class="supply-pill-fries">üçü ${fCount.toFixed(1)}kg</span></div>` : ''}</div>`;
                    supplyGrid.insertAdjacentHTML('beforeend', html);
                });
                const totalMeat = meatCounts.reduce((a,b)=>a+b, 0);
                const totalFries = friesKilos.reduce((a,b)=>a+b, 0);
                $('supplyRange').textContent = `Total Mes: ü•© ${totalMeat} Medallones | üçü ${totalFries.toFixed(1)} kg Papas`;
            }
        }
        function stepMonth(n){
            const [y, m] = $('calMonth').value.split('-');
            const d = new Date(y, m-1+n, 1);
            $('calMonth').value = d.toISOString().slice(0,7);
        }

        // --- GR√ÅFICOS ---
        const DONUT_COLORS = ['#625A45', '#d97706', '#dc2626', '#2563eb', '#16a34a', '#9333ea'];
        
        function renderMixedChart(orders, expenses, daysInMonth){
            const ctx = $('ordersChart').getContext('2d');
            if(mainChart) mainChart.destroy();

            const dataIncome = Array(daysInMonth).fill(0);
            const dataExpense = Array(daysInMonth).fill(0);

            orders.forEach(o => {
                const d = parseDateAny(o.createdAt).getDate()-1;
                if(d>=0 && d<daysInMonth) dataIncome[d] += Number(o.total||0);
            });
            expenses.forEach(e => {
                const d = parseDateAny(e.date).getDate()-1;
                if(d>=0 && d<daysInMonth) dataExpense[d] += Number(e.amount||0);
            });

            let gradGreen = ctx.createLinearGradient(0, 0, 0, 300);
            gradGreen.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
            gradGreen.addColorStop(1, 'rgba(16, 185, 129, 0.0)');

            mainChart = new Chart(ctx, {
                type:'line',
                data:{
                    labels: Array.from({length:daysInMonth},(_,i)=>i+1),
                    datasets: [
                        { 
                            label:'Ingresos', data:dataIncome, 
                            borderColor:'#10b981', backgroundColor: gradGreen,
                            fill: true, tension: 0.3, order: 2
                        },
                        { 
                            label:'Gastos', data:dataExpense, 
                            borderColor:'#ef4444', backgroundColor: 'transparent',
                            borderDash: [5, 5], tension: 0.3, order: 1
                        }
                    ]
                },
                options:{ 
                    responsive:true, maintainAspectRatio:false, 
                    interaction: { mode: 'index', intersect: false },
                    plugins:{ legend:{ position:'top' } },
                    scales:{ y:{ beginAtZero:true } }
                }
            });
        }

        function renderDoughnut(id, l, d){
            const ctx = $(id).getContext('2d');
            const map = {payChart:d1, sourceChart:d2};
            if(map[id]) map[id].destroy();
            const chart = new Chart(ctx, {
                type:'doughnut',
                data:{ labels:l, datasets:[{ data:d, backgroundColor:DONUT_COLORS, borderWidth:0 }] },
                options:{ 
                    responsive:true, maintainAspectRatio:false, cutout:'70%', 
                    plugins:{ legend:{ position:'bottom', labels:{ boxWidth:10, font:{size:11} } } } 
                }
            });
            if(id==='payChart') d1=chart;
            if(id==='sourceChart') d2=chart;
        }
    });
</script>
</body>
</html>
