<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Finanzas ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #625A45; 
      --text: #1f2937; 
      --muted: #6b7280; 
      --bg: #f3f4f6; 
      --card: #ffffff;
      --ring: #e5e7eb; 
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --font: 'Inter', sans-serif;
      
      --danger: #ef4444; 
      --warn: #f59e0b; 
      --success: #10b981;
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font); -webkit-tap-highlight-color: transparent;}
    
    /* --- HEADER UNIFICADO (Igual a Pedidos) --- */
    header { position: sticky; top: 0; z-index: 1000; background: #fff; border-bottom: 1px solid var(--ring); }
    
    .topbar {
        max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 12px;
        display: flex; align-items: center; gap: 6px;
        overflow: visible; /* Para que el dropdown se vea */
    }

    .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; text-decoration: none; margin-right: 5px; flex-shrink: 0; }
    .brand img { width: 32px; height: 32px; border-radius: 6px; margin-right: 8px; }
    
    .spacer { flex: 1; }

    .nav-btn {
        padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #4b5563; font-weight: 600; font-size: 14px; 
        transition: all 0.2s; border: 1px solid transparent; flex-shrink: 0; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; background: transparent;
    }
    .nav-btn:hover { background: #f9fafb; }
    .nav-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 5px rgba(98, 90, 69, 0.3); }
    
    .btn-danger { color: #d32f2f; background: #ffebee; border: 1px solid #ffcdd2; }
    .btn-danger:hover { background: #ffcdd2; }

    /* DROPDOWN MENU */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { 
        display: none; position: absolute; background-color: #fff; min-width: 160px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-radius: 12px; border: 1px solid var(--ring); 
        z-index: 2000; top: 115%; right: 0; 
        padding: 5px; 
    }
    .dropdown.show .dropdown-content { display: block; animation: slideDown 0.2s ease; }
    .dropdown-content a { display: block; padding: 10px; text-decoration: none; color: #374151; font-size: 14px; font-weight: 500; border-radius: 8px; }
    .dropdown-content a:hover { background: #f3f4f6; color: var(--primary); }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- LAYOUT DASHBOARD --- */
    .container { max-width: 1200px; margin: 24px auto; padding: 0 12px; padding-bottom: 80px; }
    h1 { font-size: 24px; margin: 10px 0 20px; font-weight: 800; color: #111; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .card { background: var(--card); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; border: 1px solid var(--ring); }
    
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    
    /* BOTONES INTERNOS */
    .btn { display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--ring); background: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; color: inherit; font-size: 14px; transition: all 0.2s; }
    .btn:hover { background: #f9fafb; }
    
    /* KPIs */
    .kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; width: 100%; margin-top: 15px; }
    .kbadge { background: #f9fafb; border: 1px solid var(--ring); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
    .klabel { font-size: 12px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .kvalue { font-weight: 800; font-size: 24px; margin-top: 5px; color: #111; }

    /* INPUTS */
    label { font-weight: 600; display: block; margin: 0 0 4px; font-size: 12px; color: var(--muted); }
    select, input[type="number"], input[type="date"], input[type="month"] {
      width: 100%; padding: 10px; border: 1px solid var(--ring); border-radius: 8px; font-family: inherit; font-size: 14px; outline: none; background: #fff;
    }
    .inline { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }

    /* CHARTS */
    .chartWrap { height: 280px; position: relative; }
    .chartWrapTall { height: 320px; position: relative; }
    .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 12px; }
    canvas { width: 100% !important; height: 100% !important; display: block; }

    /* HEATMAPS */
    .heatmap { display: grid; border: 1px solid var(--ring); border-radius: 12px; overflow: hidden; margin-top: 10px; }
    .hm-cell { padding: 8px; text-align: center; border-top: 1px solid var(--ring); border-left: 1px solid var(--ring); font-size: 12px; }
    .hm-head { background: #f9fafb; font-weight: 700; color: var(--muted); }
    .hm-day { background: #f9fafb; text-align: left; font-weight: 700; color: var(--muted); }
    .hm-legend { display: flex; gap: 8px; align-items: center; margin-top: 8px; font-size: 12px; }
    .swatch { width: 16px; height: 16px; border-radius: 4px; border: 1px solid var(--ring); }

    /* TABLAS */
    .table-responsive { overflow-x: auto; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px; border-bottom: 1px solid var(--ring); text-align: left; }
    th { font-size: 12px; text-transform: uppercase; color: var(--muted); font-weight: 700; background: #f9fafb; }
    td.muted { color: var(--muted); text-align: center; padding: 20px; }
    tfoot th { border-top: 2px solid var(--ring); font-size: 16px; color: #111; }

    /* CALENDARIO */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 16px; }
    .cal-day { background: #fff; border-radius: 12px; height: 90px; padding: 6px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid var(--ring); transition: all 0.2s; position: relative; }
    .cal-day:hover:not(.cal-empty-day) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: var(--primary); z-index: 2; }
    .cal-empty-day { background: #fafafa !important; border: 1px dashed #e5e7eb; box-shadow: none; }
    .cal-day-header { text-align: right; font-size: 12px; font-weight: 700; color: #9ca3af; }
    .cal-data-wrap { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; }
    .cal-burger-hero { font-weight: 800; font-size: 14px; color: #374151; display: flex; align-items: center; gap: 4px; }
    .cal-revenue-pill { background: #ecfdf5; color: #047857; border-radius: 99px; padding: 2px 8px; font-size: 10px; font-weight: 700; border: 1px solid #a7f3d0; }
    .no-sales-icon { font-size: 20px; opacity: 0.1; margin-top: -10px; }

    /* RESPONSIVE HEADER FIX */
    @media (max-width: 768px) {
        .brand span { display: none; } /* Ocultar texto "Finanzas" logo si falta espacio */
        .nav-btn { padding: 8px; font-size: 12px; }
        .calendar-grid { grid-template-columns: repeat(7, minmax(40px, 1fr)); gap: 4px; }
        .cal-day { height: 70px; padding: 4px; }
        .cal-burger-hero { font-size: 12px; }
        .cal-revenue-pill { font-size: 9px; padding: 1px 4px; }
        .kpi { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <script>
    // AUTH GUARD
    (function(){
      const TTL_MS = 20*60*60*1000;
      const qs = new URLSearchParams(location.search);
      if (qs.get('auth')==='1') {
        try{
          const now = Date.now();
          localStorage.setItem('rb_admin_ok','true');
          localStorage.setItem('rb_admin_t', String(now));
          localStorage.setItem('rb_auth_v2','ok');
        }catch(_){}
        try{ history.replaceState(null,'',location.pathname); }catch(_){}
      }
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      if (!(ok && (Date.now()-ts) < TTL_MS)){
        location.replace('login.html');
      }
      try{ localStorage.setItem('rb_admin_t', String(Date.now())); }catch(_){}
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt=""><span>Finanzas</span></a>
      
      <div class="spacer"></div>

      <a href="pedido_local.html" class="nav-btn">üì¶ Pedidos</a>
      <a href="finanzas.html" class="nav-btn active">üìà Finanzas</a>
      
      <div class="dropdown">
            <button onclick="document.querySelector('.dropdown').classList.toggle('show')" class="nav-btn">üìã Stock ‚ñæ</button>
            <div class="dropdown-content">
                <a href="stock.html">üì¶ Stock</a>
                <a href="ingresos.html">üì• Ingresos</a>
            </div>
      </div>
      
      <a href="mostrador.html" class="nav-btn">üßæ Mostrador</a>
      <a href="admin.html" class="nav-btn">‚öôÔ∏è Admin</a>
      
      <button onclick="window.logout()" class="nav-btn btn-danger">Salir</button>
    </div>
  </header>

  <main class="container">
    <h1>Resumen & Control</h1>

    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-end; margin-bottom: 20px;">
          <div class="inline">
             <div><label>Mes</label><input type="month" id="monthPicker" /></div>
             <div style="font-size:12px; color:#999; padding-bottom:10px">O RANGO:</div>
             <div><label>Desde</label><input type="date" id="fromDate" /></div>
             <div><label>Hasta</label><input type="date" id="toDate" /></div>
             <button id="btnReload" class="btn">Actualizar</button>
          </div>
        </div>

        <div class="kpi">
            <div class="kbadge"><div class="klabel">Pedidos</div><div class="kvalue" id="kpiCount">‚Äî</div></div>
            <div class="kbadge"><div class="klabel">Ingresos</div><div class="kvalue" id="kpiRevenue">‚Äî</div></div>
            <div class="kbadge"><div class="klabel">Ticket Prom.</div><div class="kvalue" id="kpiATV">‚Äî</div></div>
        </div>

        <div style="margin-top:25px">
          <div class="chartWrapTall"><canvas id="ordersChart"></canvas></div>
        </div>

        <div class="charts-row">
          <div class="card" style="box-shadow:none; border:1px solid #eee">
            <strong>Medios de pago</strong>
            <div class="chartWrap"><canvas id="payChart"></canvas></div>
          </div>
          <div class="card" style="box-shadow:none; border:1px solid #eee">
            <strong>Origen (Canal)</strong>
            <div class="chartWrap"><canvas id="sourceChart"></canvas></div>
          </div>
          <div class="card" style="box-shadow:none; border:1px solid #eee">
            <strong>Estados</strong>
            <div class="chartWrap"><canvas id="statusChart"></canvas></div>
          </div>
        </div>

        <div class="card" style="margin-top:20px; border:1px solid #e5e7eb; box-shadow:none">
          <div class="row" style="justify-content:space-between">
              <strong>Calendario de Ventas</strong>
              <div class="inline">
                <button id="calPrev" class="btn">‚óÄ</button>
                <input type="month" id="calMonth" style="width:auto">
                <button id="calNext" class="btn">‚ñ∂</button>
                <button id="calGo" class="btn">Ver</button>
              </div>
          </div>
          <div style="margin-top:10px; font-weight:bold; color:var(--primary)" id="calRange">‚Äî</div>
          <div id="calendarGrid" class="calendar-grid"></div>
          
          <div class="hm-legend" style="margin-top:10px; justify-content:flex-end">
             <span class="muted">Intensidad:</span> 
             <span class="swatch" style="background:#e8f5e9"></span>
             <span class="swatch" style="background:#a5d6a7"></span>
             <span class="swatch" style="background:#4caf50"></span>
             <span class="swatch" style="background:#2e7d32"></span>
          </div>
        </div>

        <div class="card" style="margin-top:20px; border:1px solid #e5e7eb; box-shadow:none">
          <strong>Heatmap Semanal (D√≠a x Hora)</strong>
          <div id="heatmap" class="heatmap"></div>
        </div>

        <div class="card" style="margin-top:20px; border:1px solid #e5e7eb; box-shadow:none">
          <strong>Heatmap Horario (19:00 - 00:00)</strong>
          <div id="hourmap" class="heatmap"></div>
          <div id="hourSummary" class="muted" style="margin-top:8px; font-size:13px">‚Äî</div>
        </div>

        <div class="card" style="margin-top:20px">
          <strong>Detalle Hamburguesas (Mes)</strong>
          <div class="inline" style="margin:10px 0">
            <input type="month" id="burgMonth" style="width:auto" />
            <button id="bmPrev" class="btn">‚óÄ</button>
            <button id="bmNext" class="btn">‚ñ∂</button>
            <button id="bmGo" class="btn">Ver</button>
            <span id="bmRange" class="badge muted" style="margin-left:10px">‚Äî</span>
          </div>
          <div id="bmErr" class="err" style="display:none;margin-bottom:6px"></div>
          <div class="table-responsive">
              <table>
                <thead><tr><th>Producto</th><th>Cantidad</th><th>Precio Prom.</th><th>Total</th></tr></thead>
                <tbody id="bmBody"><tr><td class="muted" colspan="4">Sin datos‚Ä¶</td></tr></tbody>
                <tfoot><tr><th>Total</th><th id="bmTotal">0</th><th>Ingresos</th><th id="bmRevenue">$0</th></tr></tfoot>
              </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const escapeHtml = s => (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

    // Global Logout
    window.logout = () => { localStorage.removeItem('rb_admin_ok'); location.replace('login.html'); };

    // --- FUNCI√ìN H√çBRIDA (La clave para ver pedidos viejos y nuevos) ---
    function parseDateAny(val){
        if(!val) return null;
        if(val instanceof Date) return val;
        if(val.toDate) return val.toDate(); // Timestamp de Firebase
        if(typeof val === 'string') { 
            const d = new Date(val); 
            if(!isNaN(d.getTime())) return d; 
            if(val.length === 10) return new Date(val + 'T12:00:00');
        }
        if(typeof val === 'number') return new Date(val);
        return null;
    }

    async function fetchUnifiedOrders(startObj, endObj){
        const startStr = startObj.toISOString().split('T')[0]; 
        const endStr   = endObj.toISOString().split('T')[0];
        
        const p1 = db.collection('orders').where('createdAt', '>=', startStr).where('createdAt', '<', endStr).get();
        const p2 = db.collection('orders').where('createdAt', '>=', startObj).where('createdAt', '<', endObj).get();
        const [snapStr, snapTime] = await Promise.all([p1, p2]);
        const merged = new Map();
        const processDoc = (doc) => {
            const d = doc.data();
            if(!(d.status||'').includes('cancel')) merged.set(doc.id, d);
        };
        snapStr.forEach(processDoc);
        snapTime.forEach(processDoc);
        return Array.from(merged.values());
    }

    // --- HELPERS L√ìGICA ---
    function isBurgerItem(it){
      if(!it) return false;
      if(it.type === 'burger') return true;
      const name = (it.name || it.item?.name || '').toLowerCase();
      return /(burger|hamburguesa|doble|simple|crispy)/i.test(name);
    }

    /* --- HEATMAPS --- */
    const colorFor = (val, max) => {
        if(max<=0) return '#ffffff';
        const r = val/max;
        if (r < 0.20) return '#dcedc8'; 
        if (r < 0.40) return '#aed581';
        if (r < 0.60) return '#81c784';
        if (r < 0.80) return '#4caf50';
        return '#2e7d32';
    };

    function renderHeatmapWeekByDay(matrix, colLabels){
        const host = document.getElementById("heatmap"); if(!host) return;
        host.innerHTML = '';
        host.style.gridTemplateColumns = `90px repeat(${colLabels.length}, 1fr)`;
        host.insertAdjacentHTML('beforeend', `<div class="hm-cell hm-head"></div>`);
        for(let c=0;c<colLabels.length;c++){ host.insertAdjacentHTML('beforeend', `<div class="hm-cell hm-head">${colLabels[c]}</div>`); }
        const weekNames = ['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
        let max=0; matrix.forEach(row=> row.forEach(v=>{ if(v>max) max=v; }));
        for(let r=0;r<7;r++){
          host.insertAdjacentHTML('beforeend', `<div class="hm-cell hm-day">${weekNames[r]}</div>`);
          for(let c=0;c<colLabels.length;c++){
            const v = matrix[r][c] || 0;
            const bg = v > 0 ? colorFor(v, max) : '#fafafa';
            host.insertAdjacentHTML('beforeend', `<div class="hm-cell" title="${v}" style="background:${bg}">${v?v:''}</div>`);
          }
        }
    }

    const HOUR_START = 19; const HOUR_END = 24; 
    function renderHourHeatmap(matrix, colLabels){
        const host=document.getElementById("hourmap"); if(!host) return;
        host.innerHTML='';
        host.style.gridTemplateColumns=`72px repeat(${colLabels.length},1fr)`;
        host.insertAdjacentHTML('beforeend','<div class="hm-cell hm-head"></div>');
        for(const lbl of colLabels){ host.insertAdjacentHTML('beforeend',`<div class="hm-cell hm-head">${lbl}</div>`); }
        let max=0; matrix.forEach(r=>r.forEach(v=>{if(v>max)max=v;}));
        for(let hr=HOUR_START; hr<HOUR_END; hr++){
          const label=`${String(hr).padStart(2,'0')}:00`;
          host.insertAdjacentHTML('beforeend',`<div class="hm-cell hm-day">${label}</div>`);
          for(let c=0;c<colLabels.length;c++){
            const v=matrix[hr-HOUR_START][c]||0;
            const bg = v > 0 ? colorFor(v, max) : '#fafafa';
            host.insertAdjacentHTML('beforeend',`<div class="hm-cell" title="${v}" style="background:${bg}">${v?v:''}</div>`);
          }
        }
    }
    
    function printHourSummary(matrix){
        const cols = matrix[0]?.length || 1;
        const avgs = matrix.map(row => row.reduce((a,b)=>a+(b||0),0) / cols);
        let peakIdx=0, peakVal=-1;
        avgs.forEach((v,i)=>{ if(v>peakVal){ peakVal=v; peakIdx=i; } });
        const el = document.getElementById('hourSummary');
        if(el) el.innerHTML = `Hora pico: <strong>${HOUR_START+peakIdx}:00</strong> (prom. ${peakVal.toFixed(1)})`;
    }

    /* --- CHARTS --- */
    let ordersChart, payChart, statusChart, sourceChart;
    const PAY_COLOR_MAP = {efectivo:'#625A45', mercado_pago:'#009ee3', debito:'#43A047', transferencia:'#26A69A'};
    const STATUS_COLOR_MAP = {accepted:'#FBC02D', pending_payment:'#FFA000', in_prep:'#FB8C00', ready:'#00ACC1', delivered:'#2E7D32', cancelled:'#D32F2F'};
    const SOURCE_COLOR_MAP = {mostrador:'#FF7043', web:'#5C6BC0', app:'#AB47BC'};
    const colorsFrom = (labels, map, def='#9E9E9E') => labels.map(l => map[l] || def);

    function ensureOrdersChart(labels, orders, revenue){
      const ctx = document.getElementById("ordersChart").getContext("2d");
      if(ordersChart) ordersChart.destroy();
      ordersChart = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{type:'bar',label:'Pedidos',data:orders,backgroundColor:'rgba(98,90,69,.65)',borderColor:'#625A45',borderWidth:1,yAxisID:'y'},{type:'line',label:'Ingresos ($)',data:revenue,borderColor:'#2e7d32',backgroundColor:'rgba(46, 125, 50, 0.1)',borderWidth:2,tension:.25,yAxisID:'y2', pointRadius:3}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true},y2:{beginAtZero:true,position:'right'},x:{grid:{display:false}}}}
      });
    }

    function ensureDoughnut(id, labels, vals, map){
        const ctx = document.getElementById(id).getContext("2d");
        if(ctx.canvas.chart) ctx.canvas.chart.destroy();
        ctx.canvas.chart = new Chart(ctx,{ 
            type:'doughnut', 
            data:{ labels, datasets:[{ data: vals, backgroundColor: colorsFrom(labels, map), borderWidth: 2, hoverOffset: 6 }] }, 
            options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom'}}} 
        });
    }

    async function loadKPI(){
      try{
        const fromInp = document.getElementById("fromDate").value;
        const toInp   = document.getElementById("toDate").value;
        const monthInp = document.getElementById("monthPicker").value;
        let start, end, isRange = false;

        if(fromInp && toInp){
           isRange = true;
           start = new Date(fromInp + 'T00:00:00');
           end   = new Date(toInp   + 'T23:59:59');
        } else {
           const d = monthInp ? new Date(monthInp + '-01T00:00:00') : new Date();
           start = new Date(d.getFullYear(), d.getMonth(), 1, 0, 0, 0);
           end   = new Date(d.getFullYear(), d.getMonth() + 1, 1, 0, 0, 0);
        }

        const orders = await fetchUnifiedOrders(start, end);
        let count=0, revenue=0;
        const payCount = new Map(), statusCount = new Map(), sourceCount = new Map();
        const daysInMonth = new Date(start.getFullYear(), start.getMonth()+1, 0).getDate();
        const labels = isRange ? [] : Array.from({length:daysInMonth},(_,i)=>`${i+1}`);
        const dayOrders = Array(daysInMonth).fill(0);
        const dayRevenue = Array(daysInMonth).fill(0);
        const hmMatrix = Array.from({length:7}, ()=> Array(isRange?0:daysInMonth).fill(0));
        const hourMatrix = Array.from({length:(HOUR_END-HOUR_START)},()=>Array(isRange?0:daysInMonth).fill(0)); 
        const dayLabels = Array.from({length:daysInMonth},(_,i)=>String(i+1).padStart(2,'0'));

        orders.forEach(d => {
            const dt = parseDateAny(d.createdAt);
            if(!dt || dt < start || dt >= end) return;
            const tot = Number(d.total || d.rawTotal || 0);
            count++; revenue += tot;
            payCount.set(d.pago||'otro', (payCount.get(d.pago||'otro')||0)+1);
            statusCount.set(d.status||'accepted', (statusCount.get(d.status||'accepted')||0)+1);
            sourceCount.set((d.source||'web').toLowerCase(), (sourceCount.get((d.source||'web').toLowerCase())||0)+1);

            if(!isRange){
               const dayIdx = dt.getDate() - 1;
               if(dayIdx >= 0 && dayIdx < daysInMonth){
                  dayOrders[dayIdx]++;
                  dayRevenue[dayIdx] += tot;
                  hmMatrix[dt.getDay()][dayIdx]++;
                  const hr = dt.getHours();
                  if(hr >= HOUR_START && hr < HOUR_END) hourMatrix[hr - HOUR_START][dayIdx]++;
               }
            }
        });

        document.getElementById("kpiCount").textContent = count;
        document.getElementById("kpiRevenue").textContent = money(revenue);
        document.getElementById("kpiATV").textContent = count ? money(revenue/count) : '‚Äî';
        if(!isRange){
           ensureOrdersChart(labels, dayOrders, dayRevenue);
           renderHeatmapWeekByDay(hmMatrix, dayLabels);
           renderHourHeatmap(hourMatrix, dayLabels);
           printHourSummary(hourMatrix);
        }
        ensureDoughnut("payChart", Array.from(payCount.keys()), Array.from(payCount.values()), PAY_COLOR_MAP);
        ensureDoughnut("statusChart", Array.from(statusCount.keys()), Array.from(statusCount.values()), STATUS_COLOR_MAP);
        ensureDoughnut("sourceChart", Array.from(sourceCount.keys()), Array.from(sourceCount.values()), SOURCE_COLOR_MAP);

      }catch(e){ console.error("KPI Error:", e); }
    }


    // --- TABLA Y CALENDARIO ---
    async function loadBurgersByMonth(){
      const tbody = document.getElementById("bmBody"); 
      const totalEl = document.getElementById("bmTotal"); 
      const revenueEl = document.getElementById("bmRevenue");
      const rangeEl = document.getElementById("bmRange");
      if(!tbody) return;
      tbody.innerHTML = `<tr><td colspan="4" class="muted">Cargando...</td></tr>`;

      try {
        const ym = document.getElementById("burgMonth").value || new Date().toISOString().slice(0,7);
        const [year, month] = ym.split('-').map(Number);
        const start = new Date(year, month - 1, 1);
        const end   = new Date(year, month, 1);
        rangeEl.textContent = `Mes: ${month}/${year}`;

        const orders = await fetchUnifiedOrders(start, end);
        const counter = new Map();
        let totalQty = 0; let totalRevenue = 0;

        orders.forEach(o => {
            const dt = parseDateAny(o.createdAt);
            if(!dt || dt.getMonth() + 1 !== month) return;
            const items = Array.isArray(o.items) ? o.items : [];
            items.forEach(it => {
                const qty = Number(it.qty || 1);
                if(isBurgerItem(it)){
                    const name = (it.name || 'Hamburguesa').toString().trim();
                    const lineTotal = (Number(it.price)||0) * qty;
                    const prev = counter.get(name) || { qty:0, revenue:0 };
                    prev.qty += qty; prev.revenue += lineTotal;
                    counter.set(name, prev);
                    totalQty += qty; totalRevenue += lineTotal;
                }
            });
        });

        const rows = Array.from(counter.entries())
            .sort((a,b)=> b[1].qty - a[1].qty)
            .map(([name, data])=>{
                const avg = data.qty ? data.revenue/data.qty : 0;
                return `<tr><td>${escapeHtml(name)}</td><td>${data.qty}</td><td>${money(avg)}</td><td>${money(data.revenue)}</td></tr>`;
            }).join('');
        tbody.innerHTML = rows || `<tr><td colspan="4" class="muted">Sin datos.</td></tr>`;
        totalEl.textContent = totalQty;
        revenueEl.textContent = money(totalRevenue);
      } catch(e){ console.error(e); }
    }

    async function renderCalendar(monthStr){
        const grid = document.getElementById("calendarGrid");
        const totalBadge = document.getElementById("calRange"); 
        if(!grid) return;
        grid.innerHTML = "";
        
        if(!monthStr) return;
        const [y, m] = monthStr.split("-").map(Number);
        const daysInMonth = new Date(y, m, 0).getDate();
        const start = new Date(y, m - 1, 1);
        const end   = new Date(y, m, 1);

        try {
            const orders = await fetchUnifiedOrders(start, end);
            const counts = Array(daysInMonth).fill(0);
            const totals = Array(daysInMonth).fill(0);

            orders.forEach(data => {
                const dt = parseDateAny(data.createdAt);
                if(!dt || dt.getMonth() + 1 !== m) return;
                const idx = dt.getDate() - 1;
                if(idx >= 0 && idx < daysInMonth){
                    totals[idx] += Number(data.total || 0);
                    let bCount = 0;
                    const items = Array.isArray(data.items) ? data.items : [];
                    items.forEach(it => { if(isBurgerItem(it)) bCount += (Number(it.qty||1)); });
                    counts[idx] += bCount;
                }
            });

            const totalBurgersMonth = counts.reduce((a, b) => a + b, 0);
            const totalMoneyMonth   = totals.reduce((a, b) => a + b, 0);
            if(totalBadge) {
                totalBadge.innerHTML = `Total Mes: üíµ ${money(totalMoneyMonth)} (${totalBurgersMonth} burgers)`;
            }

            const startDay = start.getDay(); 
            for(let i=0; i<startDay; i++){ grid.insertAdjacentHTML("beforeend", `<div class="cal-day cal-empty-day"></div>`); }
            const maxVal = Math.max(...counts, 1);
            for(let d=1; d<=daysInMonth; d++){
                const c = counts[d-1]; const t = totals[d-1];
                const bg = c > 0 ? '' : 'cal-empty-day';
                const contentHTML = c > 0 
                  ? `<div class="cal-burger-hero">üçî ${c}</div><div class="cal-revenue-pill">${money(t)}</div>`
                  : `<div class="no-sales-icon">üçî</div>`;
                
                // Color intensity logic
                let style = '';
                if(c > 0) {
                    const intense = Math.min(1, c / (maxVal*0.8)); // 80% of max is fully green
                    style = `border-color: rgba(16, 185, 129, ${intense}); background-color: rgba(16, 185, 129, ${intense * 0.1})`;
                }

                grid.insertAdjacentHTML("beforeend", `
                    <div class="cal-day ${bg}" style="${style}" title="D√≠a ${d}: ${money(t)}">
                        <div class="cal-day-header">${d}</div>
                        <div class="cal-data-wrap">${contentHTML}</div>
                    </div>
                `);
            }
        } catch(e) { console.error("Cal Error:", e); }
    }

    // --- INICIALIZACI√ìN ---
    document.addEventListener('DOMContentLoaded', ()=>{
      const now = new Date();
      const currentYM = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      ['monthPicker','burgMonth','calMonth'].forEach(id=>{
        const el = document.getElementById(id);
        if(el && !el.value) el.value = currentYM;
      });

      document.getElementById("btnReload").onclick = loadKPI;
      loadKPI();

      const addM = (ym, d) => {
         const [y,m] = ym.split('-').map(Number);
         const dt = new Date(y, m-1+d, 1);
         return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
      };

      const mTable = document.getElementById("burgMonth");
      if(mTable){
         const loadT = ()=>loadBurgersByMonth();
         document.getElementById("bmPrev").onclick=()=>{ mTable.value=addM(mTable.value, -1); loadT(); };
         document.getElementById("bmNext").onclick=()=>{ mTable.value=addM(mTable.value, 1); loadT(); };
         document.getElementById("bmGo").onclick=loadT;
         mTable.addEventListener('change', loadT);
         loadT();
      }

      const mCal = document.getElementById("calMonth");
      if(mCal){
         const loadC = ()=>renderCalendar(mCal.value);
         document.getElementById("calPrev").onclick=()=>{ mCal.value=addM(mCal.value, -1); loadC(); };
         document.getElementById("calNext").onclick=()=>{ mCal.value=addM(mCal.value, 1); loadC(); };
         document.getElementById("calGo").onclick=loadC;
         setTimeout(loadC, 500);
      }
    });
  </script>
</body>
</html>
