<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finanzas • Rhodes Burgers</title>
<link rel="icon" href="images/logo.png" />
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2ecc71">
<link rel="apple-touch-icon" href="/images/icon-192.png">
<style>
  :root{--primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10)}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
  .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
  .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
  .brand img{width:36px;height:36px;border-radius:10px;object-fit:contain;margin-right:8px}
  .spacer{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
  .danger{border-color:#ffdddd;background:#fff5f5;color:#b00000}
  main{max-width:1100px;margin:22px auto;padding:0 12px}

  .board{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:14px 16px;margin-bottom:16px}
  .board-head{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .board-kpis{display:flex;gap:12px;flex-wrap:wrap;margin-left:auto}
  .kbadge{min-width:150px;background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:10px 14px}
  .klabel{font-size:12px;color:var(--muted)}
  .kvalue{font-weight:800;font-size:20px}
  input[type="month"]{border:1px solid var(--ring);border-radius:10px;padding:8px 10px;outline:none}
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
  .chartwrap{background:#fff;border:1px solid var(--ring);border-radius:12px;padding:8px}
  .chartbox{width:100%;height:260px}
  .card{background:var(--card);border-radius:14px;box-shadow:var(--shadow);padding:16px;margin-top:16px}
  .err{color:#b00020;font-weight:600;margin-top:8px}

  /* Toast */
  .toast{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);opacity:0;transform:translateY(20px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.success{background:#2ecc71}.toast.error{background:#d32f2f}.toast.info{background:#444}
  @media (max-width:900px){ .charts{grid-template-columns:1fr} }
</style>
</head>
<body>
<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png" alt="">Rhodes Burgers</a>
    <div class="spacer"></div>
    <a class="btn" href="pedido_local.html">← Volver a pedidos</a>
    <button id="btnLogout" class="btn danger">⏻ Cerrar sesión</button>
  </div>
</header>

<main>
  <section class="board">
    <div class="board-head">
      <strong>Resumen mensual</strong>
      <input type="month" id="monthPicker">
      <button class="btn" id="btnReload">Actualizar</button>
      <button class="btn" id="btnExport">Exportar CSV</button>
      <div class="board-kpis">
        <div class="kbadge"><div class="klabel">Pedidos</div><div class="kvalue" id="kpiCount">—</div></div>
        <div class="kbadge"><div class="klabel">Ingresos</div><div class="kvalue" id="kpiRevenue">—</div></div>
        <div class="kbadge"><div class="klabel">Ticket promedio</div><div class="kvalue" id="kpiAvg">—</div></div>
      </div>
    </div>

    <div class="charts">
      <div class="chartwrap"><canvas id="monthChart" class="chartbox"></canvas></div>
      <div class="chartwrap"><canvas id="payChart" class="chartbox"></canvas></div>
    </div>

    <div id="kpiError" class="err" style="display:none;margin-top:6px"></div>
  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // SW
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js'); }

  // Toasts
  const toastEl = document.getElementById('toast');
  function showToast(msg,type='success',ms=2000){
    toastEl.textContent = msg; toastEl.className = 'toast '+type;
    requestAnimationFrame(()=>{ toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); });
  }

  // Firebase
  const firebaseConfig = {
    apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain:"rhodes-burguers.firebaseapp.com",
    projectId:"rhodes-burguers",
    storageBucket:"rhodes-burguers.firebasestorage.app",
    messagingSenderId:"951646688091",
    appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig);}catch(_){}
  const auth = firebase.auth(); const db = firebase.firestore();

  // Guardia Auth + admin + 20 hs
  (function guard(){
    const exp = parseInt(localStorage.getItem('rb_auth_expires')||'0',10);
    if (!exp || Date.now() > exp) {
      const next = encodeURIComponent(location.pathname + location.search);
      location.replace('login.html?reason=expired&next='+next);
    }
  })();
  auth.onAuthStateChanged(async user=>{
    if (!user){ location.replace('login.html?reason=guard'); return; }
    const adm = await db.collection('admins').doc(user.uid).get();
    if (!adm.exists || adm.data().enabled!==true){
      await auth.signOut();
      location.replace('login.html?reason=perm');
      return;
    }
  });
  document.getElementById('btnLogout').onclick = async ()=>{
    await auth.signOut(); localStorage.removeItem('rb_auth_expires'); location.replace('login.html?reason=logout');
  };

  // Helpers
  const $ = s => document.querySelector(s);
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  (function setDefaultMonth(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,"0"); $("#monthPicker").value=`${d.getFullYear()}-${m}`; })();
  function pickDocDate(obj){
    const cand=['createdAt','created_at','timestamp','date','fecha','time'];
    for(const k of cand){ const v=obj?.[k]; if(v==null) continue;
      try{ if(v?.toDate) return v.toDate(); if(typeof v==='number') return new Date(v); if(typeof v==='string'){ const d=new Date(v); if(!isNaN(d)) return d; } }catch(_){}
    } return null;
  }
  function unitWithExtras(it){ const base=it.price||0; const pz=(it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0); const ch=(it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0); return base+pz+ch; }
  function computeOrderTotal(o){ if(typeof o.total==='number') return o.total; const items=Array.isArray(o.items)?o.items:[]; return items.reduce((t,it)=>t+ (it.type==='burger'?unitWithExtras(it):(it.price||0))*(it.qty||0),0); }

  let monthChart, payChart, lastRows=[];

  function ensureMonthChart(labels, orders, revenue){
    const ctx=document.getElementById("monthChart").getContext("2d");
    if(monthChart) monthChart.destroy();
    monthChart=new Chart(ctx,{type:'bar',data:{labels,
      datasets:[
        {type:'bar',label:'Pedidos',data:orders,backgroundColor:'rgba(46,204,113,.55)',borderColor:'#22b266',borderWidth:1.5,yAxisID:'y'},
        {type:'line',label:'Ingresos ($)',data:revenue,borderColor:'#1b6a3c',backgroundColor:'rgba(46,204,113,.10)',borderWidth:3,tension:.25,pointRadius:3,fill:false,yAxisID:'y2'}
      ]},
      options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
        scales:{y:{beginAtZero:true},y2:{beginAtZero:true,position:'right',grid:{drawOnChartArea:false}},x:{grid:{display:false}}}}
    });
  }
  function ensurePayChart(labels, values){
    const ctx=document.getElementById('payChart').getContext('2d');
    if(payChart) payChart.destroy();
    payChart = new Chart(ctx, {type:'bar', data:{labels,datasets:[{label:'Pedidos',data:values,backgroundColor:['#22b266','#2ecc71','#9adfb8'],borderColor:['#1b8e52','#22b266','#78c79b'],borderWidth:1.5}]},
      options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true},y:{grid:{display:false}}}}
    });
  }

  async function loadFinance(){
    $("#kpiError").style.display="none"; $("#kpiError").textContent="";
    try{
      const probe=await db.collection('orders').limit(1).get();
      let dateField=null;
      if(!probe.empty){ const sample=probe.docs[0].data(); for(const k of ['createdAt','created_at','timestamp','date','fecha','time']){ if(sample[k]!=null){ dateField=k; break; } } }
      let q=db.collection('orders'); q=dateField? q.orderBy(dateField,'desc') : q.orderBy(firebase.firestore.FieldPath.documentId());
      const snap=await q.limit(2000).get();

      const d = new Date($("#monthPicker").value + '-01T00:00:00');
      const Y=d.getFullYear(), M=d.getMonth();
      const days=new Date(Y,M+1,0).getDate();
      const labels=Array.from({length:days},(_,i)=>`${i+1}`);
      const dayOrders=Array(days).fill(0);
      const dayRevenue=Array(days).fill(0);
      const payDist = { mercado_pago:0, efectivo:0, otro:0 };

      let count=0, revenue=0; lastRows=[];

      snap.forEach(doc=>{
        const o=doc.data(); const dt=pickDocDate(o); if(!dt) return;
        if (dt.getFullYear()!==Y || dt.getMonth()!==M) return;
        const idx=dt.getDate()-1;
        const tot=computeOrderTotal(o);
        dayOrders[idx]+=1; dayRevenue[idx]+=tot; count++; revenue+=tot;

        const mp=(o.pago||'otro').toLowerCase();
        if (mp.includes('mercado')) payDist.mercado_pago++; else if (mp.includes('efectivo')) payDist.efectivo++; else payDist.otro++;

        // Para exportar
        lastRows.push({
          id: doc.id,
          orderNumber: o.orderNumber || '',
          fecha: dt.toISOString(),
          nombre: o.nombre || '',
          pago: o.pago || '',
          paymentStatus: o.paymentStatus || '',
          estado: o.status || '',
          total: tot
        });
      });

      // KPIs
      $("#kpiCount").textContent = count.toLocaleString("es-AR");
      $("#kpiRevenue").textContent = money(revenue);
      $("#kpiAvg").textContent = count ? money(revenue/count) : money(0);

      // Charts
      ensureMonthChart(labels, dayOrders, dayRevenue);
      ensurePayChart(['Mercado Pago','Efectivo','Otro'], [payDist.mercado_pago, payDist.efectivo, payDist.otro]);
    }catch(e){
      console.error(e); $("#kpiError").textContent="No se pudo cargar el resumen."; $("#kpiError").style.display="block";
    }
  }

  function exportCSV(){
    if (!lastRows.length){ showToast('No hay datos para exportar','info'); return; }
    const headers = ['id','orderNumber','fecha','nombre','pago','paymentStatus','estado','total'];
    const lines = [headers.join(',')].concat(
      lastRows.map(r=> headers.map(h=>{
        const v = (r[h] ?? '');
        if (typeof v === 'string' && (v.includes(',') || v.includes('"') || v.includes('\n'))) {
          return '"' + v.replace(/"/g,'""') + '"';
        }
        return v;
      }).join(','))
    );
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const m = $("#monthPicker").value || 'mes';
    a.href = url; a.download = `finanzas_${m}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('CSV exportado','success');
  }

  $("#btnReload").addEventListener('click', loadFinance);
  $("#monthPicker").addEventListener('change', loadFinance);
  $("#btnExport").addEventListener('click', exportCSV);

  document.addEventListener('DOMContentLoaded', loadFinance);
</script>
</body>
</html>
