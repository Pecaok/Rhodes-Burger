<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Finanzas ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #625A45; --text: #1f2937; --muted: #6b7280; --bg: #f3f4f6; --card: #ffffff;
      --ring: #e5e7eb; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --font: 'Inter', sans-serif;
      --danger: #ef4444; --warn: #f59e0b; --success: #10b981;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font); -webkit-tap-highlight-color: transparent;}
    
    /* HEADER */
    header { position: sticky; top: 0; z-index: 1000; background: #fff; border-bottom: 1px solid var(--ring); }
    .topbar { max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 12px; display: flex; align-items: center; gap: 6px; overflow: visible; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; align-items: center; text-decoration: none; margin-right: 5px; flex-shrink: 0; }
    .brand img { width: 32px; height: 32px; border-radius: 6px; margin-right: 8px; }
    .spacer { flex: 1; }
    .nav-btn { padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #4b5563; font-weight: 600; font-size: 14px; transition: all 0.2s; border: 1px solid transparent; flex-shrink: 0; display: inline-flex; align-items: center; gap: 6px; cursor: pointer; background: transparent; }
    .nav-btn:hover { background: #f9fafb; }
    .nav-btn.active { background: var(--primary); color: #fff; box-shadow: 0 2px 5px rgba(98, 90, 69, 0.3); }
    .btn-danger { color: #d32f2f; background: #ffebee; border: 1px solid #ffcdd2; }
    
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 160px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border-radius: 12px; border: 1px solid var(--ring); z-index: 2000; top: 115%; right: 0; padding: 5px; }
    .dropdown.show .dropdown-content { display: block; animation: slideDown 0.2s ease; }
    .dropdown-content a { display: block; padding: 10px; text-decoration: none; color: #374151; font-size: 14px; font-weight: 500; border-radius: 8px; }
    .dropdown-content a:hover { background: #f3f4f6; color: var(--primary); }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    /* LAYOUT */
    .container { max-width: 1200px; margin: 24px auto; padding: 0 12px; padding-bottom: 80px; }
    h1 { font-size: 24px; margin: 10px 0 20px; font-weight: 800; color: #111; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .card { background: var(--card); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; border: 1px solid var(--ring); }
    .row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .btn { display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--ring); background: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; text-decoration: none; color: inherit; font-size: 14px; transition: all 0.2s; }
    .btn:hover { background: #f9fafb; }

    /* KPIs */
    .kpi { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; width: 100%; margin-top: 15px; }
    .kbadge { background: #f9fafb; border: 1px solid var(--ring); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; }
    .klabel { font-size: 12px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .kvalue { font-weight: 800; font-size: 24px; margin-top: 5px; color: #111; }

    /* INPUTS */
    label { font-weight: 600; display: block; margin: 0 0 4px; font-size: 12px; color: var(--muted); }
    select, input[type="number"], input[type="date"], input[type="month"] { width: 100%; padding: 10px; border: 1px solid var(--ring); border-radius: 8px; font-family: inherit; font-size: 14px; outline: none; background: #fff; }
    .inline { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }

    /* CHARTS */
    .chartWrap { height: 280px; position: relative; }
    .chartWrapTall { height: 320px; position: relative; }
    .charts-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 12px; }
    canvas { width: 100% !important; height: 100% !important; display: block; }

    /* HEATMAPS */
    .heatmap { display: grid; border: 1px solid var(--ring); border-radius: 12px; overflow: hidden; margin-top: 10px; }
    .hm-cell { padding: 8px; text-align: center; border-top: 1px solid var(--ring); border-left: 1px solid var(--ring); font-size: 12px; }
    .hm-head { background: #f9fafb; font-weight: 700; color: var(--muted); }
    .hm-day { background: #f9fafb; text-align: left; font-weight: 700; color: var(--muted); }
    .hm-legend { display: flex; gap: 8px; align-items: center; margin-top: 8px; font-size: 12px; }
    .swatch { width: 16px; height: 16px; border-radius: 4px; border: 1px solid var(--ring); }

    /* TABLAS */
    .table-responsive { overflow-x: auto; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 12px; border-bottom: 1px solid var(--ring); text-align: left; }
    th { font-size: 12px; text-transform: uppercase; color: var(--muted); font-weight: 700; background: #f9fafb; }
    td.muted { color: var(--muted); text-align: center; padding: 20px; }
    tfoot th { border-top: 2px solid var(--ring); font-size: 16px; color: #111; }

    /* CALENDARIO */
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 16px; }
    .cal-day { background: #fff; border-radius: 12px; min-height: 100px; padding: 6px; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid var(--ring); transition: all 0.2s; position: relative; }
    .cal-day:hover:not(.cal-empty-day) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: var(--primary); z-index: 2; }
    .cal-empty-day { background: #fafafa !important; border: 1px dashed #e5e7eb; box-shadow: none; }
    .cal-day-header { text-align: right; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 4px; }
    .cal-data-wrap { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; }
    .cal-burger-hero { font-weight: 800; font-size: 14px; color: #374151; display: flex; align-items: center; gap: 4px; }
    .cal-revenue-pill { background: #ecfdf5; color: #047857; border-radius: 99px; padding: 2px 8px; font-size: 10px; font-weight: 700; border: 1px solid #a7f3d0; margin-bottom: 4px; }
    .no-sales-icon { font-size: 20px; opacity: 0.1; margin-top: -10px; }

    /* Insumos en Calendario */
    .cal-ing-row { font-size: 10px; font-weight: 700; display:flex; gap:4px; align-items:center; margin-top:2px; }
    .meat { color: #8d6e63; } 
    .fries { color: #f59e0b; }

    /* Metricas Totales */
    .cal-metrics { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; background: #fdfdfd; border: 1px solid #eee; padding: 10px; border-radius: 10px; }
    .metric-item { display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; color: #444; }
    .metric-item b { font-size: 15px; color: #111; }

    @media (max-width: 768px) {
        .brand span { display: none; } 
        .nav-btn { padding: 8px; font-size: 12px; }
        .calendar-grid { grid-template-columns: repeat(7, minmax(45px, 1fr)); gap: 4px; }
        .cal-day { min-height: 80px; padding: 4px; }
        .cal-burger-hero { font-size: 12px; }
        .cal-revenue-pill { font-size: 9px; padding: 1px 4px; }
        .kpi { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <script>
    (function guard(){
      const TTL_MS = 20*60*60*1000;
      const qs = new URLSearchParams(location.search);
      if (qs.get('auth')==='1') {
        try{ localStorage.setItem('rb_admin_ok','true'); localStorage.setItem('rb_admin_t', String(Date.now())); localStorage.setItem('rb_auth_v2','ok'); }catch(_){}
        try{ history.replaceState(null,'',location.pathname); }catch(_){}
      }
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      if (!(ok && (Date.now()-Number(localStorage.getItem('rb_admin_t')||0)) < TTL_MS)) location.replace('login.html');
      try{ localStorage.setItem('rb_admin_t', String(Date.now())); }catch(_){}
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt=""><span>Finanzas</span></a>
      <div class="spacer"></div>
      
      <a href="pedido_local.html" class="nav-btn">üì¶ Pedidos</a>
      <a href="finanzas.html" class="nav-btn active">üìà Finanzas</a>
      <div class="dropdown">
            <button onclick="document.querySelector('.dropdown').classList.toggle('show')" class="nav-btn">üìã Stock ‚ñæ</button>
            <div class="dropdown-content">
                <a href="stock.html">üì¶ Stock</a>
                <a href="ingresos.html">üì• Ingresos</a>
            </div>
      </div>
      <a href="mostrador.html" class="nav-btn">üßæ Mostrador</a>
      <a href="admin.html" class="nav-btn">‚öôÔ∏è Admin</a>
      <button onclick="window.logout()" class="nav-btn btn-danger">Salir</button>
    </div>
  </header>

  <main class="container">
    <h1>Resumen & Control</h1>

    <div class="grid">
      <section class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-end; margin-bottom: 20px;">
          <div class="inline">
             <div><label>Mes</label><input type="month" id="monthPicker" /></div>
             <div style="font-size:12px; color:#999; padding-bottom:10px">O RANGO:</div>
             <div><label>Desde</label><input type="date" id="fromDate" /></div>
             <div><label>Hasta</label><input type="date" id="toDate" /></div>
             <button id="btnReload" class="btn">Actualizar</button>
          </div>
        </div>

        <div class="kpi">
            <div class="kbadge"><div class="klabel">Pedidos</div><div class="kvalue" id="kpiCount">...</div></div>
            <div class="kbadge"><div class="klabel">Ingresos</div><div class="kvalue" id="kpiRevenue">...</div></div>
            <div class="kbadge"><div class="klabel">Ticket Prom.</div><div class="kvalue" id="kpiATV">...</div></div>
        </div>

        <div style="margin-top:25px">
          <div class="chartWrapTall"><canvas id="ordersChart"></canvas></div>
        </div>

        <div class="card" style="margin-top:20px; border:1px solid #e5e7eb; box-shadow:none">
          <div class="row" style="justify-content:space-between">
              <strong>Calendario de Ventas & Consumo</strong>
              <div class="inline">
                <button id="calPrev" class="btn">‚óÄ</button>
                <input type="month" id="calMonth" style="width:auto">
                <button id="calNext" class="btn">‚ñ∂</button>
                <button id="calGo" class="btn">Ver</button>
              </div>
          </div>
          
          <div id="calRange" class="cal-metrics">Cargando...</div>

          <div class="calendar-grid" style="margin-bottom:0; margin-top:10px">
               <div style="text-align:center; font-weight:bold; font-size:12px; color:#999">DOM</div>
               <div style="text-align:center; font-weight:bold; font-size:12px; color:#999">LUN</div>
               <div style="text-align:center; font-weight:bold; font-size:12px; color:#999">MAR</div>
               <div style="text-align:center; font-weight:bold; font-size:12px; color:#999">MIE</div>
               <div style="text-align:center; font-weight:bold; font-size:12px; color:#999">JUE</div>
               <div style="text-align:center; font-weight:bold; font-size:12px; color:#999">VIE</div>
               <div style="text-align:center; font-weight:bold; font-size:12px; color:#999">SAB</div>
          </div>
          <div id="calendarGrid" class="calendar-grid" style="margin-top:5px"></div>
          
          <div class="hm-legend" style="margin-top:10px; justify-content:flex-end">
             <span class="muted">Ref:</span> 
             <span class="swatch" style="background:#ecfdf5; border:1px solid #a7f3d0"></span><span style="font-size:11px">Venta</span>
             <span class="swatch" style="background:#fff; border:1px solid #ddd"></span><span style="font-size:11px">Insumos (Carne/Papa)</span>
          </div>
        </div>

        <div class="charts-row">
          <div class="card" style="box-shadow:none; border:1px solid #eee"><strong>Medios de pago</strong><div class="chartWrap"><canvas id="payChart"></canvas></div></div>
          <div class="card" style="box-shadow:none; border:1px solid #eee"><strong>Origen</strong><div class="chartWrap"><canvas id="sourceChart"></canvas></div></div>
          <div class="card" style="box-shadow:none; border:1px solid #eee"><strong>Estados</strong><div class="chartWrap"><canvas id="statusChart"></canvas></div></div>
        </div>

        <div class="charts-row">
            <div class="card" style="box-shadow:none; border:1px solid #eee">
              <strong>Semanal (D√≠a x Hora)</strong>
              <div id="heatmap" class="heatmap"></div>
            </div>
            <div class="card" style="box-shadow:none; border:1px solid #eee">
              <strong>Horario (19:00 - 00:00)</strong>
              <div id="hourmap" class="heatmap"></div>
              <div id="hourSummary" class="muted" style="margin-top:8px; font-size:13px">‚Äî</div>
            </div>
        </div>

        <div class="card" style="margin-top:20px">
          <strong>Detalle Hamburguesas (Mes)</strong>
          <div class="inline" style="margin:10px 0">
            <input type="month" id="burgMonth" style="width:auto" />
            <button id="bmGo" class="btn">Ver</button>
          </div>
          <div class="table-responsive">
              <table>
                <thead><tr><th>Producto</th><th>Cantidad</th><th>Total</th></tr></thead>
                <tbody id="bmBody"><tr><td class="muted" colspan="3">Sin datos‚Ä¶</td></tr></tbody>
                <tfoot><tr><th>Total</th><th id="bmTotal">0</th><th id="bmRevenue">$0</th></tr></tfoot>
              </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8", authDomain: "rhodes-burguers.firebaseapp.com", projectId: "rhodes-burguers", storageBucket: "rhodes-burguers.firebasestorage.app", messagingSenderId: "951646688091", appId: "1:951646688091:web:05db5fadb4150d1fa9c07e" };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    window.logout = () => { localStorage.removeItem('rb_admin_ok'); location.replace('login.html'); };

    // --- FUNCIONES CORE ---
    function parseDateAny(val){
        if(!val) return null;
        if(val instanceof Date) return val;
        if(val.toDate) return val.toDate();
        if(typeof val === 'string') { const d = new Date(val); if(!isNaN(d.getTime())) return d; if(val.length===10) return new Date(val+'T12:00:00'); }
        return null;
    }

    async function fetchUnifiedOrders(startObj, endObj){
        const startStr = startObj.toISOString().split('T')[0]; 
        const endStr   = endObj.toISOString().split('T')[0];
        const p1 = db.collection('orders').where('createdAt', '>=', startStr).where('createdAt', '<', endStr).get();
        const p2 = db.collection('orders').where('createdAt', '>=', startObj).where('createdAt', '<', endObj).get();
        const [snapStr, snapTime] = await Promise.all([p1, p2]);
        const merged = new Map();
        [...sn1.docs, ...sn2.docs].forEach(d => {
            const data = d.data();
            if(!(data.status||'').includes('cancel')) merged.set(d.id, data);
        });
        return Array.from(merged.values());
    }

    function isBurgerItem(it){
      const t = (it.type||'').toLowerCase();
      const n = (it.name||'').toLowerCase();
      return t==='burger' || /(burger|hamburguesa|doble|simple|crispy|cuarto|royal)/i.test(n);
    }

    let charts = {}; 
    function renderChart(id, type, data, options){
        const ctx = document.getElementById(id).getContext("2d");
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, { type, data, options });
    }

    // --- CARGA DE DATOS ---
    async function loadKPI(){
      try{
        const now = new Date();
        let ym = $('#monthPicker').value;
        if(!ym) { ym = now.toISOString().slice(0,7); $('#monthPicker').value = ym; }

        let start, end, isRange = false;
        const fromInp = $('#fromDate').value;
        const toInp   = $('#toDate').value;

        if(fromInp && toInp){
           isRange = true;
           start = new Date(fromInp + 'T00:00:00');
           end   = new Date(toInp   + 'T23:59:59');
        } else {
           const d = new Date(ym + '-02T00:00:00'); 
           start = new Date(d.getFullYear(), d.getMonth(), 1, 0, 0, 0);
           end   = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59);
        }

        const orders = await fetchUnifiedOrders(start, end);
        
        let count=0, revenue=0;
        const payCount = new Map(), statusCount = new Map(), sourceCount = new Map();
        
        const daysInPeriod = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        const labels = Array.from({length: daysInPeriod}, (_, i) => {
            const d = new Date(start); d.setDate(d.getDate() + i);
            return d.getDate(); 
        });
        
        const dayOrders = Array(daysInPeriod).fill(0);
        const dayRevenue = Array(daysInPeriod).fill(0);
        const hmMatrix = Array.from({length:7}, ()=> Array(daysInPeriod).fill(0));
        const hourMatrix = Array.from({length:6},()=>Array(daysInPeriod).fill(0));

        orders.forEach(d => {
            const dt = parseDateAny(d.createdAt);
            if(!dt || dt < start || dt > end) return;
            
            const tot = Number(d.total || 0);
            count++; revenue += tot;
            
            payCount.set(d.pago||'otro', (payCount.get(d.pago||'otro')||0)+1);
            statusCount.set(d.status||'accepted', (statusCount.get(d.status||'accepted')||0)+1);
            sourceCount.set((d.source||'web').toLowerCase(), (sourceCount.get((d.source||'web').toLowerCase())||0)+1);

            const dayIdx = Math.floor((dt - start) / (1000 * 60 * 60 * 24));
            if(dayIdx >= 0 && dayIdx < daysInPeriod){
                dayOrders[dayIdx]++;
                dayRevenue[dayIdx] += tot;
                hmMatrix[dt.getDay()][dayIdx]++;
                const h = dt.getHours();
                if(h >= 19 && h <= 23) hourMatrix[h-19][dayIdx]++;
                if(h === 0) hourMatrix[5][dayIdx]++;
            }
        });

        $('#kpiCount').textContent = count;
        $('#kpiRevenue').textContent = money(revenue);
        $('#kpiATV').textContent = count ? money(revenue/count) : '‚Äî';

        renderChart("ordersChart", "bar", {
            labels: labels,
            datasets: [
                { label:'Pedidos', data: dayOrders, backgroundColor:'rgba(98,90,69,0.7)', yAxisID:'y' },
                { label:'Ingresos', data: dayRevenue, type:'line', borderColor:'#2e7d32', backgroundColor:'rgba(46,125,50,0.1)', yAxisID:'y1', tension:0.3 }
            ]
        }, { responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}, y1:{beginAtZero:true, position:'right'}} });

        const dOpts = { responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{legend:{position:'bottom'}} };
        const dCols = ['#625A45', '#009ee3', '#43A047', '#D32F2F', '#f57c00'];
        renderChart("payChart", "doughnut", { labels:[...payCount.keys()], datasets:[{data:[...payCount.values()], backgroundColor:dCols}] }, dOpts);
        renderChart("sourceChart", "doughnut", { labels:[...sourceCount.keys()], datasets:[{data:[...sourceCount.values()], backgroundColor:dCols}] }, dOpts);
        renderChart("statusChart", "doughnut", { labels:[...statusCount.keys()], datasets:[{data:[...statusCount.values()], backgroundColor:dCols}] }, dOpts);

        renderHeatmapWeekByDay(hmMatrix, labels);
        renderHourHeatmap(hourMatrix, labels);
        printHourSummary(hourMatrix);

        if(!isRange && $('#calMonth').value === ym) renderCalendar(ym);

      }catch(e){ console.error("KPI Error:", e); }
    }

    async function renderCalendar(monthStr){
        const grid = $('#calendarGrid');
        const badge = $('#calRange');
        if(!grid) return;
        if(!monthStr) monthStr = new Date().toISOString().slice(0,7);
        
        const [y, m] = monthStr.split("-").map(Number);
        const start = new Date(y, m-1, 1);
        const end = new Date(y, m, 0, 23, 59, 59);
        const days = end.getDate();

        const orders = await fetchUnifiedOrders(start, end);
        
        const dayStats = Array.from({length: days}, () => ({ rev:0, count:0, pat:0, fries:0 }));
        let totRev=0, totCount=0, totPat=0, totFries=0;

        orders.forEach(d => {
            const dt = parseDateAny(d.createdAt);
            if(!dt) return;
            const i = dt.getDate() - 1;
            
            const total = Number(d.total || 0);
            dayStats[i].rev += total;
            totRev += total;
            
            (d.items||[]).forEach(it => {
                const qty = Number(it.qty||1);
                if(isBurgerItem(it)){
                    dayStats[i].count += qty;
                    totCount += qty;
                    
                    const fKg = 0.2 * qty;
                    dayStats[i].fries += fKg;
                    totFries += fKg;

                    let p = 1;
                    const n = (it.name||'').toLowerCase();
                    if(n.includes('doble')) p=2; if(n.includes('triple')) p=3;
                    if(it.extras?.patty) p += Number(it.extras.patty);
                    dayStats[i].pat += (p*qty);
                    totPat += (p*qty);
                }
            });
        });

        badge.innerHTML = `
            <div class="metric-item">üíµ <b>${money(totRev)}</b></div>
            <div class="metric-item">üçî <b>${totCount}</b></div>
            <div class="metric-item meat">ü•© <b>${totPat}</b> Med.</div>
            <div class="metric-item fries">üçü <b>${totFries.toFixed(1)}kg</b></div>
        `;

        grid.innerHTML = '';
        for(let i=0; i<start.getDay(); i++) grid.insertAdjacentHTML('beforeend', '<div class="cal-day cal-empty-day"></div>');
        
        dayStats.forEach((s, i) => {
            const hasData = s.rev > 0;
            const content = hasData 
                ? `<div class="cal-revenue-pill">${money(s.rev)}</div>
                   <div class="cal-ing-row meat">ü•© ${s.pat}</div>
                   <div class="cal-ing-row fries">üçü ${s.fries.toFixed(1)}kg</div>`
                : `<div class="no-sales-icon">üçî</div>`;
            
            grid.insertAdjacentHTML('beforeend', `
                <div class="cal-day ${hasData?'':'cal-empty-day'}" style="height:auto; min-height:90px; justify-content:flex-start">
                    <div class="cal-day-header">${i+1}</div>
                    <div class="cal-data-wrap">${content}</div>
                </div>
            `);
        });
    }

    function renderHeatmapWeekByDay(matrix, labels){
        const el = $('#heatmap'); el.innerHTML=''; 
        el.style.gridTemplateColumns = `50px repeat(${labels.length}, 1fr)`;
        el.insertAdjacentHTML('beforeend', '<div></div>');
        labels.forEach(l => el.insertAdjacentHTML('beforeend', `<div class="hm-head">${l}</div>`));
        const days = ['D','L','M','M','J','V','S'];
        let max=0; matrix.forEach(r=>r.forEach(v=>max=Math.max(max,v)));
        
        matrix.forEach((row, r) => {
            el.insertAdjacentHTML('beforeend', `<div class="hm-day">${days[r]}</div>`);
            row.forEach(v => {
                const a = v>0 ? (v/max)*0.8+0.2 : 0;
                const bg = v>0 ? `rgba(46,125,50,${a})` : '#f9fafb';
                el.insertAdjacentHTML('beforeend', `<div class="hm-cell" style="background:${bg}" title="${v}">${v||''}</div>`);
            });
        });
    }

    function renderHourHeatmap(matrix, labels){
        const el = $('#hourmap'); el.innerHTML='';
        el.style.gridTemplateColumns = `50px repeat(${labels.length}, 1fr)`;
        el.insertAdjacentHTML('beforeend', '<div></div>');
        labels.forEach(l => el.insertAdjacentHTML('beforeend', `<div class="hm-head">${l}</div>`));
        const hrs = ['19','20','21','22','23','00'];
        let max=0; matrix.forEach(r=>r.forEach(v=>max=Math.max(max,v)));
        
        matrix.forEach((row, r) => {
            el.insertAdjacentHTML('beforeend', `<div class="hm-day">${hrs[r]}</div>`);
            row.forEach(v => {
                const a = v>0 ? (v/max)*0.8+0.2 : 0;
                const bg = v>0 ? `rgba(33,150,243,${a})` : '#f9fafb';
                el.insertAdjacentHTML('beforeend', `<div class="hm-cell" style="background:${bg}" title="${v}">${v||''}</div>`);
            });
        });
    }

    function printHourSummary(m){ /* ... */ }

    document.addEventListener('DOMContentLoaded', ()=>{
        const now = new Date();
        const ym = now.toISOString().slice(0,7);
        const setVal = (id)=>{ const el=$(id); if(el) el.value=ym; };
        ['monthPicker','burgMonth','calMonth'].forEach(setVal);

        $('#btnReload').onclick = ()=>{ loadKPI(); renderCalendar($('#calMonth').value); };
        $('#calGo').onclick = () => renderCalendar($('#calMonth').value);
        $('#calPrev').onclick = () => stepCal(-1);
        $('#calNext').onclick = () => stepCal(1);
        $('#bmGo').onclick = loadBurgersByMonth;

        loadKPI();
        renderCalendar(ym);
        loadBurgersByMonth();
    });

    function stepCal(n){
        const [y,m] = $('#calMonth').value.split('-').map(Number);
        const d = new Date(y, m-1+n, 1);
        const nextYM = d.toISOString().slice(0,7);
        $('#calMonth').value = nextYM;
        renderCalendar(nextYM);
    }
  </script>
</body>
</html>
