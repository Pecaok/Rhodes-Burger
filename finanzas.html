<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finanzas • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
      --danger:#d32f2f; --warn:#ff9800;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky; top:0; z-index:10; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}

    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}

    .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kbadge{min-width:160px;background:#f7f7f7;border:1px solid var(--ring);border-radius:14px;padding:10px 14px}
    .klabel{font-size:12px;color:var(--muted)}
    .kvalue{font-weight:800;font-size:20px}

    .chartWrap{height:280px}
    .chartWrapTall{height:320px}
    canvas{width:100% !important; height:100% !important; display:block}

    label{font-weight:600;display:block;margin:8px 0 6px}
    select, input[type="number"], input[type="datetime-local"], input[type="date"], textarea{
      width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px
    }
    .inline{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:8px 12px;cursor:pointer}
    .pill input{accent-color:var(--primary)}
    .qtybox{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px}
    .qtybox button{width:28px;height:28px;border:1px solid #e5e5e5;background:#fff;border-radius:999px;font-weight:900;cursor:pointer}
    .muted{color:var(--muted)}
    .list{border:1px dashed #e5e5e5;border-radius:12px;padding:10px}

    .totalBox{display:flex;align-items:center;justify-content:space-between;margin-top:12px;font-weight:800}
    .err{color:#b00020;font-weight:600}
    .ok{color:#2e7d32;font-weight:700}

    /* Heatmap */
    .heatmap{display:grid;grid-template-columns:90px repeat(24,1fr);border:1px solid var(--ring);border-radius:12px;overflow:hidden}
    .hm-cell{padding:8px;text-align:center;border-top:1px solid var(--ring);border-left:1px solid var(--ring);font-size:12px}
    .hm-head{background:#fafafa;font-weight:700}
    .hm-day{background:#fafafa;text-align:left;font-weight:700}
    .hm-legend{display:flex;gap:8px;align-items:center;margin-top:8px}
    .swatch{width:18px;height:18px;border-radius:4px;border:1px solid var(--ring)}
    .warn-pill{display:inline-block;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
    .warn{background:#fff3cd;border:1px solid #ffe58f;color:#8a6d3b}
    .danger{background:#fdecea;border:1px solid #f5c6cb;color:#8a1c1c}
  </style>
</head>
<body>
  <!-- Guardia -->
  <script>
    (function guard(){
      const TTL_MS = 20*60*60*1000;
      const qs = new URLSearchParams(location.search);
      if (qs.get('auth')==='1') {
        try{
          const now = Date.now();
          localStorage.setItem('rb_admin_ok','true');
          localStorage.setItem('rb_admin_t', String(now));
          localStorage.setItem('rb_auth_v2','ok');
          sessionStorage.setItem('rb_auth_v2','ok');
        }catch(_){}
        try{ history.replaceState(null,'',location.pathname); }catch(_){}
      }
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      const live = (Date.now()-ts) < TTL_MS;
      if (!(ok && live)){
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=guard&next='+next);
        return;
      }
      try{ localStorage.setItem('rb_admin_t', String(Date.now())); }catch(_){}
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Finanzas</a>
      <div class="spacer"></div>
      <a href="pedido_local.html" class="btn" title="Volver a pedidos">← Pedidos</a>
      <button id="btnLogout" class="btn danger" title="Cerrar sesión">⏻ Cerrar sesión</button>
    </div>
  </header>

  <main class="container">
    <h1>Resumen & Control</h1>

    <div class="grid">
      <!-- Columna izquierda -->
      <section class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <strong>Resumen</strong>

            <div class="inline">
              <div>
                <label>Mes</label>
                <input type="month" id="monthPicker" />
              </div>
              <div>
                <label>Desde</label>
                <input type="date" id="fromDate" />
              </div>
              <div>
                <label>Hasta</label>
                <input type="date" id="toDate" />
              </div>
            </div>

            <button id="btnReload" class="btn">Actualizar</button>
          </div>

          <div class="kpi">
            <div class="kbadge"><div class="klabel">Pedidos</div><div class="kvalue" id="kpiCount">—</div></div>
            <div class="kbadge"><div class="klabel">Ingresos</div><div class="kvalue" id="kpiRevenue">—</div></div>
            <div class="kbadge"><div class="klabel">Ticket Prom.</div><div class="kvalue" id="kpiATV">—</div></div>
            <div class="kbadge"><div class="klabel">Margen Est.</div><div class="kvalue" id="kpiMargin">—</div></div>
          </div>
        </div>

        <div style="margin-top:12px">
          <div class="chartWrapTall"><canvas id="ordersChart"></canvas></div>
        </div>

        <div style="margin-top:12px" class="row">
          <div class="card" style="flex:1; padding:12px">
            <strong>Medios de pago</strong>
            <div class="chartWrap"><canvas id="payChart"></canvas></div>
          </div>
          <div class="card" style="flex:1; padding:12px">
            <strong>Estados</strong>
            <div class="chartWrap"><canvas id="statusChart"></canvas></div>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="card" style="margin-top:12px">
          <strong>Heatmap de demanda (día del mes × hora)</strong>
          <div id="heatmap" class="heatmap" style="margin-top:8px"></div>
          <div class="hm-legend">
            <span class="muted">Bajo</span>
            <span class="swatch" style="background:#e8f5e9"></span>
            <span class="swatch" style="background:#a5d6a7"></span>
            <span class="swatch" style="background:#66bb6a"></span>
            <span class="swatch" style="background:#2e7d32"></span>
            <span class="muted">Alto</span>
          </div>
        </div>

        <!-- Proyección -->
        <div class="card" style="margin-top:12px">
          <strong>Proyección del mes</strong>
          <div id="projText" class="muted" style="margin-top:6px">—</div>
          <div id="pendingAlert" style="margin-top:8px"></div>
        </div>

        <div id="kpiError" class="err" style="display:none;margin-top:8px"></div>
      </section>

      <!-- Columna derecha: Alta manual -->
      <aside class="card">
        <h3>Alta manual (presencial)</h3>
        <p class="muted" style="margin-top:-6px">Usá esto cuando el cliente compra en el local.</p>

        <label>Fecha y hora</label>
        <input id="dtWhen" type="datetime-local"/>

        <label style="margin-top:10px">Producto</label>
        <select id="selBurger"></select>

        <div class="inline" style="margin-top:8px">
          <div>
            <div class="muted" style="font-weight:600">Papas (obligatorio)</div>
            <label class="pill"><input type="radio" name="fries" value="con_sazon"> Con sazón</label>
            <label class="pill"><input type="radio" name="fries" value="sin_sazon"> Sin sazonar</label>
          </div>
        </div>

        <div class="inline" style="margin-top:8px">
          <div>
            <div>Medallones extra <span class="muted" id="pattiesInfo"></span></div>
            <div class="qtybox"><button id="patDec">-</button><span id="patVal">0</span><button id="patInc">+</button></div>
          </div>
          <div>
            <div>Fetas de cheddar extra <span class="muted" id="cheInfo"></span></div>
            <div class="qtybox"><button id="cheDec">-</button><span id="cheVal">0</span><button id="cheInc">+</button></div>
          </div>
          <div>
            <div>Cantidad</div>
            <div class="qtybox"><button id="qtyDec">-</button><span id="qtyVal">1</span><button id="qtyInc">+</button></div>
          </div>
        </div>

        <label style="margin-top:10px">Bebida (opcional)</label>
        <select id="selDrink">
          <option value="">— Sin bebida —</option>
        </select>

        <label>Medio de pago</label>
        <select id="selPay">
          <option value="efectivo">Efectivo</option>
          <option value="mercado_pago">Mercado Pago</option>
        </select>

        <div class="inline" style="margin-top:6px">
          <label class="pill"><input type="checkbox" id="chkPaid"> Marcar como pagado</label>
        </div>

        <label>Notas (opcional)</label>
        <textarea id="notes" placeholder="Sin cebolla, extra salsa, etc."></textarea>

        <div class="list" id="preview" style="margin-top:10px;display:none"></div>
        <div class="totalBox"><span>Total</span><span id="manualTotal">$ 0</span></div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="btnAdd" class="btn">Agregar a la previsualización</button>
          <button id="btnSave" class="btn primary">Guardar pedido</button>
        </div>
        <div id="formMsg" class="ok" style="display:none;margin-top:8px"></div>
        <div id="formErr" class="err" style="display:none;margin-top:8px"></div>
      </aside>
    </div>
  </main>

  <!-- Catálogo -->
  <script id="menu-data" type="application/json">
  {
    "burgers": [
      { "id":"bigjohn_simple","name":"Big John Simple","price":10900,"kind":"simple" },
      { "id":"bigjohn_doble","name":"Big John Doble","price":13900,"kind":"double" },
      { "id":"burguesa_simple","name":"Burguesa Simple","price":11900,"kind":"simple" },
      { "id":"burguesa_doble","name":"Burguesa Doble","price":14900,"kind":"double" },
      { "id":"cheesebacon_spl","name":"CheeseBacon Simple","price":10500,"kind":"simple" },
      { "id":"cheesebacon_dbl","name":"CheeseBacon Doble","price":13500,"kind":"double" },
      { "id":"cheese_simple","name":"Cheeseburger Simple","price":9500,"kind":"simple" },
      { "id":"cheese_doble","name":"Cheeseburger Doble","price":12500,"kind":"double" },
      { "id":"rhodes_simple","name":"Rhodes Simple","price":11900,"kind":"simple" },
      { "id":"rhodes_doble","name":"Rhodes Doble","price":14900,"kind":"double" },
      { "id":"morgan_simple","name":"Morgan Simple","price":10900,"kind":"simple" },
      { "id":"morgan_doble","name":"Morgan Doble","price":14500,"kind":"double" },
      { "id":"pollo_crispy","name":"Pollo Crispy","price":8900,"kind":"chicken" }
    ],
    "drinks": [
      { "id":"coca_org","name":"Coca-Cola Original 500ml","price":3000 },
      { "id":"coca_zero","name":"Coca-Cola Zero 500ml","price":3000 },
      { "id":"sprite","name":"Sprite 500ml","price":3000 },
      { "id":"aquarius_pera","name":"Aquarius Pera 500ml","price":3000 },
      { "id":"aquarius_pomelo","name":"Aquarius Pomelo","price":3000 }
    ]
  }
  </script>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ===== Logout
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnLogout');
    if(btn) btn.onclick = ()=>{
      localStorage.removeItem('rb_auth_v2');
      localStorage.removeItem('rb_admin_ok');
      localStorage.removeItem('rb_admin_t');
      sessionStorage.removeItem('rb_auth_v2');
      location.replace('login.html?reason=logout&next=pedido_local.html');
    };
  });
  </script>

  <script>
  // ================= FIREBASE =================
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig); }catch(e){}
  const db = firebase.firestore();

  // ================= HELPERS =================
  const $ = s=>document.querySelector(s);
  const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
  const friesName = f => f==="con_sazon" ? "Con sazón" : "Sin sazonar";
  const EXTRA_PRICE_PATTY   = 1600;
  const EXTRA_PRICE_CHEDDAR = 300;

  // Costos estimados (ajustá libremente)
  const COSTO_ITEM = {
    bigjohn_simple:5200, bigjohn_doble:7800, burguesa_simple:5600, burguesa_doble:8300,
    cheesebacon_spl:5000, cheesebacon_dbl:7500, cheese_simple:4600, cheese_doble:7000,
    rhodes_simple:5700, rhodes_doble:8400, morgan_simple:5200, morgan_doble:8000,
    pollo_crispy:4200,
    coca_org:900, coca_zero:900, sprite:900, aquarius_pera:900, aquarius_pomelo:900
  };
  const COSTO_EXTRA_PATTY = 1000;
  const COSTO_EXTRA_CHEDDAR = 150;

  function unitWithExtras(it){
    const base = it.price || 0;
    const pz = (it.extras?.patty||0)   * (it.extras?.EXTRA_PRICE_PATTY||0);
    const ch = (it.extras?.cheddar||0) * (it.extras?.EXTRA_PRICE_CHEDDAR||0);
    return base + pz + ch;
  }
  function computeOrderTotal(o){
    if (typeof o.total === "number") return o.total;
    const items = Array.isArray(o.items) ? o.items : [];
    return items.reduce((t,it)=> t + (it.type==="burger" ? unitWithExtras(it) : (it.price||0)) * (it.qty||0), 0);
  }
  function orderCOGS(o){
    const items = Array.isArray(o.items) ? o.items : [];
    return items.reduce((t,it)=>{
      if(it.type==='burger'){
        const id = it.id || it.item?.id;
        const base = COSTO_ITEM[id] || 0;
        const ex = it.extras || {};
        const unit = base + (ex.patty||0)*COSTO_EXTRA_PATTY + (ex.cheddar||0)*COSTO_EXTRA_CHEDDAR;
        return t + unit*(it.qty||0);
      }else{
        const id = it.id || it.item?.id;
        return t + (COSTO_ITEM[id]||0)*(it.qty||0);
      }
    },0);
  }
  function pickDocDate(obj){
    const cand = ['createdAt','created_at','timestamp','date','fecha','time'];
    for (const k of cand){
      const v = obj[k];
      if (v?.toDate) return v.toDate();
      if (typeof v === 'number') return new Date(v);
      if (typeof v === 'string'){ const d=new Date(v); if(!isNaN(d)) return d; }
    }
    return null;
  }
  function monthKey(){
    const d = $("#monthPicker").value ? new Date($("#monthPicker").value+'-01T00:00:00') : new Date();
    return {y:d.getFullYear(), m:d.getMonth()+1, days:new Date(d.getFullYear(), d.getMonth()+1, 0).getDate()};
  }
  function dateRange(){
    const from = $("#fromDate").value ? new Date($("#fromDate").value+'T00:00:00') : null;
    const to   = $("#toDate").value   ? new Date($("#toDate").value  +'T23:59:59') : null;
    return {from, to};
  }

  // Init mes por defecto
  (function initMonth(){
    const d = new Date(); const m = String(d.getMonth()+1).padStart(2,'0');
    try{ $("#monthPicker").value = `${d.getFullYear()}-${m}`; }catch(_){}
  })();

  // ==== Heatmap helpers (día del mes × hora) ====
  function colorFor(val, max){
    if(max<=0) return '#e8f5e9';
    const r = val/max;
    if (r < 0.25) return '#e8f5e9';
    if (r < 0.50) return '#a5d6a7';
    if (r < 0.75) return '#66bb6a';
    return '#2e7d32';
  }
  function renderHeatmapMonth(matrix, dayLabels){
    const host = document.getElementById("heatmap");
    host.innerHTML = '';
    // header
    host.insertAdjacentHTML('beforeend', `<div class="hm-cell hm-head"></div>`);
    for(let h=0; h<24; h++) host.insertAdjacentHTML('beforeend', `<div class="hm-cell hm-head">${h}</div>`);
    // body
    let max=0; matrix.forEach(row=> row.forEach(v=>{ if(v>max) max=v; }));
    for(let d=0; d<matrix.length; d++){
      host.insertAdjacentHTML('beforeend', `<div class="hm-cell hm-day">${dayLabels[d]}</div>`);
      for(let h=0; h<24; h++){
        const v = matrix[d][h];
        const bg = colorFor(v, max);
        host.insertAdjacentHTML('beforeend', `<div class="hm-cell" title="${v||0} pedidos" style="background:${bg}">${v? v : ''}</div>`);
      }
    }
  }

  // CHARTS
  let ordersChart, payChart, statusChart;
  function ensureOrdersChart(labels, orders, revenue){
    const ctx = document.getElementById("ordersChart").getContext("2d");
    if(ordersChart) ordersChart.destroy();
    ordersChart = new Chart(ctx,{
      type:'bar',
      data:{ labels,
        datasets:[
          {type:'bar',label:'Pedidos',data:orders,backgroundColor:'rgba(46,204,113,.35)',borderColor:'#2ecc71',borderWidth:1,yAxisID:'y'},
          {type:'line',label:'Ingresos ($)',data:revenue,borderColor:'#2ecc71',backgroundColor:'rgba(46,204,113,.10)',borderWidth:2,tension:.25,yAxisID:'y2'}
        ]
      },
      options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
        scales:{y:{beginAtZero:true},y2:{beginAtZero:true,position:'right'},x:{grid:{display:false}}}}
    });
  }
  const PAY_COLOR_MAP = {efectivo:'#2ECC71', mercado_pago:'#1E88E5', credito:'#8E24AA', debito:'#43A047', transferencia:'#26A69A', otro:'#FFA000'};
  const STATUS_COLOR_MAP = {accepted:'#FBC02D', pending_payment:'#FFA000', in_prep:'#FB8C00', ready:'#00ACC1', delivered:'#2E7D32', cancelled:'#D32F2F'};
  const colorsFrom = (labels, map) => labels.map(l => map[l] || '#9E9E9E');
  function ensurePayChart(labels, vals){
    const ctx = document.getElementById("payChart").getContext("2d");
    if(payChart) payChart.destroy();
    payChart = new Chart(ctx,{ type:'doughnut',
      data:{labels, datasets:[{ data: vals, backgroundColor: colorsFrom(labels, PAY_COLOR_MAP), borderColor: colorsFrom(labels, PAY_COLOR_MAP), borderWidth: 2, hoverOffset: 6 }]},
      options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom'}}}
    });
  }
  function ensureStatusChart(labels, vals){
    const ctx = document.getElementById("statusChart").getContext("2d");
    if(statusChart) statusChart.destroy();
    statusChart = new Chart(ctx,{ type:'doughnut',
      data:{labels, datasets:[{ data: vals, backgroundColor: colorsFrom(labels, STATUS_COLOR_MAP), borderColor: colorsFrom(labels, STATUS_COLOR_MAP), borderWidth: 2, hoverOffset: 6 }]},
      options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom'}}}
    });
  }

  // LOAD KPI + filtros + proyección + heatmap mensual
  async function loadKPI(){
    const err = $("#kpiError"); err.style.display='none'; err.textContent='';
    try{
      const probe = await db.collection('orders').limit(1).get();
      let dateField = null;
      if (!probe.empty){
        const d = probe.docs[0].data();
        for (const k of ['createdAt','created_at','timestamp','date','fecha','time']){ if (d[k]!=null){ dateField=k; break; } }
      }
      let q = db.collection('orders');
      if (dateField) q = q.orderBy(dateField,'desc'); else q = q.orderBy(firebase.firestore.FieldPath.documentId());
      const snap = await q.limit(2000).get();

      // rango: prioridad a from/to; si no, usa mes
      const {from,to} = dateRange();
      const useRange = !!(from || to);

      const mk = monthKey();
      const {y,m,days} = mk;
      const labels = useRange ? [] : Array.from({length:days},(_,i)=>`${i+1}`);
      const dayOrders = useRange ? [] : Array(days).fill(0);
      const dayRevenue = useRange ? [] : Array(days).fill(0);

      // Heatmap mensual (día del mes × hora)
      const hmMatrix = Array.from({length: days}, () => Array(24).fill(0));
      const hmLabels = Array.from({length: days}, (_,i) => String(i+1).padStart(2,'0'));

      let count=0, revenue=0, cogsTotal=0;
      let pendingTotal=0;

      const payCount = new Map();
      const statusCount = new Map();

      const inMonth = (d)=> d.getFullYear()===y && (d.getMonth()+1)===m;

      snap.forEach(doc=>{
        const data=doc.data();
        const dt = pickDocDate(data); if(!dt) return;

        if(useRange){
          if (from && dt<from) return;
          if (to   && dt>to)   return;
        }else{
          if (!inMonth(dt)) return;
        }

        const tot = computeOrderTotal(data);
        const cogs = orderCOGS(data);
        count++; revenue += tot; cogsTotal += cogs;

        const paid = (data.payment_status==='paid') || !!data.paid;
        if (!paid) pendingTotal += tot;

        const p = (data.pago||'otro'); payCount.set(p, (payCount.get(p)||0)+1);
        const st= (data.status||'accepted'); statusCount.set(st, (statusCount.get(st)||0)+1);

        if(!useRange){
          const dIdx = dt.getDate()-1;
          dayOrders[dIdx] += 1;
          dayRevenue[dIdx] += tot;
          if (dIdx>=0 && dIdx<days) hmMatrix[dIdx][dt.getHours()] += 1;
        }
      });

      // KPIs
      $("#kpiCount").textContent = count.toLocaleString("es-AR");
      $("#kpiRevenue").textContent = money(revenue);
      $("#kpiATV").textContent = count? money(revenue/count) : '—';
      $("#kpiMargin").textContent = money(revenue - cogsTotal);

      // Charts
      if(!useRange){ ensureOrdersChart(labels, dayOrders, dayRevenue); }
      else{ ensureOrdersChart([], [], []); }

      const pLabels = Array.from(payCount.keys());
      const pVals   = pLabels.map(k=>payCount.get(k));
      ensurePayChart(pLabels, pVals.length? pVals : [0]);

      const sLabels = Array.from(statusCount.keys());
      const sVals   = sLabels.map(k=>statusCount.get(k));
      ensureStatusChart(sLabels, sVals.length? sVals : [0]);

      // Heatmap mensual
      renderHeatmapMonth(hmMatrix, hmLabels);

      // Proyección (sólo mensual)
      const projBox = $("#projText");
      const alertBox = $("#pendingAlert");
      alertBox.innerHTML = '';
      if(!useRange){
        const today = new Date();
        const [yy,mm] = ($("#monthPicker").value||"").split('-').map(Number);
        const isSameYM = (today.getFullYear()===yy && (today.getMonth()+1)===mm);
        const dayOfMonth = isSameYM ? today.getDate() : Math.max(1, dayRevenue.findLastIndex ? dayRevenue.findLastIndex(v=>v>0)+1 : dayRevenue.length);
        const revToDate = dayRevenue.slice(0, dayOfMonth).reduce((a,b)=>a+b,0);
        const avg = dayOfMonth? (revToDate/dayOfMonth) : 0;
        const projected = avg * days;

        projBox.innerHTML = `Ingresos a la fecha: <strong>${money(revToDate)}</strong> • Ingresos diarios prom.: <strong>${money(avg)}</strong><br>
        Proyección fin de mes: <strong>${money(projected)}</strong> (sobre ${days} días)`;

        // Alerta por pendientes
        const PENDING_THRESHOLD = 80000; // ajustable
        if(pendingTotal > 0){
          const cls = pendingTotal >= PENDING_THRESHOLD ? 'danger' : 'warn';
          const msg = pendingTotal >= PENDING_THRESHOLD
            ? `Pendientes elevados: ${money(pendingTotal)}`
            : `Pendientes: ${money(pendingTotal)}`;
          alertBox.innerHTML = `<span class="warn-pill ${cls}">${msg}</span>`;
        }
      }else{
        projBox.textContent = 'Proyección disponible sólo con selección mensual.';
      }

    }catch(e){
      console.error(e);
      err.textContent = "No se pudo cargar el resumen.";
      err.style.display='block';
    }
  }
  document.getElementById("btnReload").onclick = loadKPI;
  </script>

  <script>
  // ====== Alta manual
  const $q = s=>document.querySelector(s);
  const menuData = (()=>{ try{ return JSON.parse(document.getElementById('menu-data').textContent); }catch(_){ return {burgers:[],drinks:[]}; } })();
  const BURGERS = menuData.burgers||[];
  const DRINKS  = menuData.drinks||[];
  const selBurger = $q("#selBurger"), selDrink = $q("#selDrink");
  const qtyVal=$q("#qtyVal"), qtyInc=$q("#qtyInc"), qtyDec=$q("#qtyDec");
  const patVal=$q("#patVal"), patInc=$q("#patInc"), patDec=$q("#patDec");
  const cheVal=$q("#cheVal"), cheInc=$q("#cheInc"), cheDec=$q("#cheDec");
  const pattiesInfo=$q("#pattiesInfo"), cheInfo=$q("#cheInfo");
  const dtWhen = $q("#dtWhen");
  const manualTotal = $q("#manualTotal");
  const preview = $q("#preview");
  const formMsg = $q("#formMsg"), formErr=$q("#formErr");

  function mountSelects(){
    selBurger.innerHTML = `<option value="">— Seleccionar —</option>` + BURGERS.map(b=>`<option value="${b.id}">${b.name} — ${money(b.price)}</option>`).join("");
    selDrink.innerHTML  += DRINKS.map(d=>`<option value="${d.id}">${d.name} — ${money(d.price)}</option>`).join("");
  }
  function setNow(){
    const d = new Date();
    const iso = new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);
    try{ dtWhen.value = iso; }catch(_){}
  }

  if(qtyInc) qtyInc.onclick = ()=> qtyVal.textContent = String(Math.min(99,(+qtyVal.textContent||1)+1));
  if(qtyDec) qtyDec.onclick = ()=> qtyVal.textContent = String(Math.max(1,(+qtyVal.textContent||1)-1));
  if(patInc) patInc.onclick = ()=> { const v=+patVal.textContent||0; if(v<2) patVal.textContent = v+1; };
  if(patDec) patDec.onclick = ()=> { const v=+patVal.textContent||0; if(v>0) patVal.textContent = v-1; };
  if(cheInc) cheInc.onclick = ()=> { const v=+cheVal.textContent||0; if(v<3) cheVal.textContent = v+1; };
  if(cheDec) cheDec.onclick = ()=> { const v=+cheVal.textContent||0; if(v>0) cheVal.textContent = v-1; };

  function updateExtrasHints(){
    if(pattiesInfo) pattiesInfo.textContent = `( + ${money(EXTRA_PRICE_PATTY)} c/u, máx. +2 )`;
    if(cheInfo)     cheInfo.textContent     = `( + ${money(EXTRA_PRICE_CHEDDAR)} c/u, máx. +3 )`;
  }

  function findBurger(id){ return (menuData.burgers||[]).find(b=>b.id===id); }
  function findDrink(id){ return (menuData.drinks||[]).find(d=>d.id===id); }

  function calcPreview(){
    const burger = findBurger(selBurger.value);
    if(!burger) return 0;
    const qty = +qtyVal.textContent||1;
    const friesEl = document.querySelector('input[name="fries"]:checked');
    if(!friesEl) return 0;

    const ex = {
      patty:+patVal.textContent||0,
      cheddar:+cheVal.textContent||0,
      EXTRA_PRICE_PATTY: EXTRA_PRICE_PATTY,
      EXTRA_PRICE_CHEDDAR: EXTRA_PRICE_CHEDDAR
    };
    const unit = burger.price + ex.patty*EXTRA_PRICE_PATTY + ex.cheddar*EXTRA_PRICE_CHEDDAR;
    let tot = unit*qty;

    const dsel = selDrink.value ? findDrink(selDrink.value) : null;
    if(dsel) tot += dsel.price;

    preview.style.display = 'block';
    preview.innerHTML = `
      <div><strong>${qty}× ${burger.name}</strong></div>
      <div class="muted">Papas: ${friesName(friesEl.value)}${ex.patty?` · +${ex.patty} med`:''}${ex.cheddar?` · +${ex.cheddar} cheddar`:''}</div>
      ${selDrink.value? `<div>Bebida: ${dsel.name}</div>` : ``}
    `;
    manualTotal.textContent = money(tot);
    return tot;
  }

  ["change","click","keyup"].forEach(ev=>{
    document.addEventListener(ev, (e)=>{
      if (e.target && (e.target.id==="selBurger" || e.target.name==="fries" || e.target.id==="selDrink")) calcPreview();
    });
  });
  [qtyInc,qtyDec,patInc,patDec,cheInc,cheDec].forEach(b=> b && b.addEventListener('click', calcPreview));

  document.getElementById("btnAdd").onclick = ()=>{
    formMsg.style.display='none'; formErr.style.display='none';
    const burger = findBurger(selBurger.value);
    if(!burger){ formErr.textContent="Elegí una hamburguesa."; formErr.style.display='block'; return; }
    const friesEl = document.querySelector('input[name="fries"]:checked');
    if(!friesEl){ formErr.textContent="Elegí el tipo de papas (obligatorio)."; formErr.style.display='block'; return; }
    calcPreview();
  };

  document.getElementById("btnSave").onclick = async ()=>{
    formMsg.style.display='none'; formErr.style.display='none';
    try{
      const burger = findBurger(selBurger.value);
      if(!burger){ throw new Error("Elegí una hamburguesa."); }
      const friesEl = document.querySelector('input[name="fries"]:checked');
      if(!friesEl){ throw new Error("Elegí el tipo de papas (obligatorio)."); }

      const qty = +qtyVal.textContent||1;
      const extras = {
        patty:+patVal.textContent||0,
        cheddar:+cheVal.textContent||0,
        EXTRA_PRICE_PATTY: EXTRA_PRICE_PATTY,
        EXTRA_PRICE_CHEDDAR: EXTRA_PRICE_CHEDDAR
      };
      const drink = selDrink.value ? findDrink(selDrink.value) : null;

      const when = dtWhen.value ? new Date(dtWhen.value) : new Date();
      const pay  = document.getElementById("selPay").value;
      const paid = document.getElementById("chkPaid").checked;
      const notes= (document.getElementById("notes").value||"").trim();

      const items = [{
        type:"burger", id: burger.id, name: burger.name, qty, price: burger.price, fries: friesEl.value, extras, ...(notes?{notes}:{})
      }];
      if(drink){ items.push({ type:"drink", id: drink.id, name: drink.name, qty: 1, price: drink.price }); }

      const total = items.reduce((t,it)=>
        t + (it.type==="burger"
              ? (it.price + extras.patty*EXTRA_PRICE_PATTY + extras.cheddar*EXTRA_PRICE_CHEDDAR)*qty
              : it.price),
        0
      );

      const ref = db.collection("orders").doc();
      await ref.set({
        orderNumber: null, nombre: "Mostrador", telefono: "", entrega: "take_away",
        pago: pay, paid: paid, payment_status: paid ? "paid" : "pending",
        notes, status: "accepted", items, total, source: "manual", createdAt: when
      });

      formMsg.textContent = "Pedido guardado correctamente.";
      formMsg.style.display='block';

      selBurger.value=""; selDrink.value="";
      document.querySelectorAll('input[name="fries"]').forEach(r=>r.checked=false);
      qtyVal.textContent="1"; patVal.textContent="0"; cheVal.textContent="0";
      document.getElementById("chkPaid").checked=false; document.getElementById("notes").value="";
      preview.style.display='none'; manualTotal.textContent = money(0);

      loadKPI(); // refrescar resumen
    }catch(e){
      formErr.textContent = e?.message || "No se pudo guardar el pedido.";
      formErr.style.display='block';
    }
  };

  // START
  document.addEventListener('DOMContentLoaded', ()=>{
    mountSelects(); setNow(); updateExtrasHints(); calcPreview(); loadKPI();
  });
  </script>
</body>
</html>
