<!doctype html>
<html lang="es">

<!-- ============================================================
      SESI√ìN COMPARTIDA (igual que login.html)
=============================================================== -->
<script>
const TTL_HOURS = 20;
const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

function sessionValid(){
  const ok = localStorage.getItem('rb_admin_ok') === 'true';
  const ts = Number(localStorage.getItem('rb_admin_t') || 0);
  return ok && (Date.now() - ts) < TTL_MS;
}
function bumpSession(){
  if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
}
function logout(){
  localStorage.removeItem('rb_admin_ok');
  localStorage.removeItem('rb_admin_t');
  localStorage.removeItem('rb_auth_v2');
  sessionStorage.removeItem('rb_auth_v2');
  location.replace('login.html');
}
(function requireSession(){
  if (!sessionValid()){
    const next = encodeURIComponent(
      (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
      (location.search || '') + (location.hash || '')
    );
    location.replace('login.html?next=' + next);
  } else bumpSession();
})();
['click','keydown','focus','mousemove','touchstart','scroll']
  .forEach(e => window.addEventListener(e, bumpSession, {passive:true}));
</script>

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Ä¢ Rhodes Burgers</title>
<link rel="icon" href="images/logo.png" />

<style>
:root{
  --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6;
  --card:#fff; --ring:#eaeaea; --shadow:0 10px 28px rgba(0,0,0,.08);
  --good:#2e7d32; --warn:#fb8c00; --bad:#d32f2f; --radius:18px;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
}

header{
  position:sticky;
  top:0;
  z-index:20;
  background:#fff;
  box-shadow:0 2px 12px rgba(0,0,0,.06);
}
.topbar{
  max-width:1200px;
  margin:0 auto;
  padding:10px 12px;
  display:flex;
  align-items:center;
  gap:12px;
}
.brand{
  display:flex;
  align-items:center;
  font-weight:800;
  color:inherit;
  text-decoration:none;
}
.brand img{
  width:36px;height:36px;
  border-radius:10px;
  margin-right:8px;
  object-fit:contain;
  background:#fff;
}
.spacer{flex:1}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}
.card.featured{
  border:2px solid var(--primary);
  background:#fff8f0;
  padding:22px;
}

.btn{
  display:inline-flex;
  gap:8px;
  padding:8px 12px;
  border-radius:12px;
  border:1.5px solid var(--ring);
  background:#fff;
  cursor:pointer;
  font-weight:700;
}
.btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.btn.good{background:#e9f6eb;border-color:#cfead3}
.btn.warn{background:#fff6e8;border-color:#ffe1b8}
.btn.bad{background:#fff1f1;border-color:#ffd7d7}

.img-preview{
  width:80px;height:80px;
  object-fit:cover;
  border-radius:12px;
  border:1px solid #ddd;
  background:#fafafa;
}

table{width:100%;border-collapse:separate;border-spacing:0 8px}
td,th{padding:10px 12px;background:#fff;text-align:left}
th{
  color:#555;
  font-size:13px;
  background:#fafafa;
  border-bottom:1px solid #eee;
}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png">Rhodes Burgers ‚Ä¢ Admin</a>
    <div class="spacer"></div>

    <div class="store-controls" id="storeControls">
      <div style="display:flex;flex-direction:column">
        <div id="storePill" class="pill off">Estado: ‚Äî</div>
        <div class="small" id="storeSub" style="margin-top:4px">‚Äî</div>
      </div>

      <div style="min-width:220px;display:flex;gap:8px;align-items:center">
        <button class="btn good" id="btnForceOpen">Forzar abierto</button>
        <button class="btn bad" id="btnForceClose">Desactivar</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <input id="forceUntil" type="datetime-local" style="width:220px"/>
        <button class="btn primary" id="btnSaveUntil">Guardar</button>
      </div>
    </div>

    <div style="margin-left:12px">
      <a class="btn" href="index.html">Ir al Men√∫</a>
      <button class="btn" onclick="logout()">Salir</button>
    </div>
  </div>
</header>

<main>
<section class="card featured">
  <h2 style="margin-bottom:6px">Gesti√≥n del Men√∫ (CRUD + Orden Visual)</h2>
  <p class="muted" style="margin-bottom:14px">
    Agreg√°, edit√°, elimin√°, ocult√° del men√∫ y orden√° visualmente los productos.
  </p>

  <!-- FORMULARIO CRUD -->
  <div class="form-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:14px;">
    <div>
      <label><strong>ID (√∫nico)</strong></label>
      <input id="prdId" type="text" placeholder="Ej: bigjohn_simple">
    </div>

    <div>
      <label><strong>Nombre</strong></label>
      <input id="prdName" type="text" placeholder="Nombre del producto">
    </div>

    <div>
      <label><strong>Categor√≠a</strong></label>
      <select id="prdCategory">
        <option value="hamburguesas">Hamburguesas</option>
        <option value="bebidas">Bebidas</option>
        <option value="guarniciones">Guarniciones</option>
      </select>
    </div>

    <div>
      <label><strong>Precio</strong></label>
      <input id="prdPrice" type="number" placeholder="Ej: 4800">
    </div>

    <div>
      <label><strong>Imagen (URL o archivo)</strong></label>
      <input id="prdImg" type="text" placeholder="https://...">
      <input id="prdImgFile" type="file" accept="image/*" style="margin-top:8px">
    </div>

    <div style="grid-column:1/-1">
      <label><strong>Descripci√≥n</strong></label>
      <textarea id="prdDesc" rows="3" placeholder="Descripci√≥n corta‚Ä¶"></textarea>
    </div>
  </div>

  <div class="row" style="margin-top:14px">
    <button class="btn primary" id="btnSaveProduct">Guardar / Actualizar</button>
    <button class="btn bad" id="btnClearProduct">Limpiar Formulario</button>
  </div>

  <div style="height:1px;background:#ddd;margin:18px 0"></div>

  <h3>Lista de productos</h3>

  <div style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>IMG</th>
          <th>Nombre</th>
          <th>Categor√≠a</th>
          <th>Precio</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="prdTable"></tbody>
    </table>
  </div>
</section>
<!-- ============================================================
     FIREBASE
=============================================================== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};

try { firebase.initializeApp(firebaseConfig); } catch(e){}
try {
  firebase.firestore().settings({ experimentalForceLongPolling:true });
} catch(e){}

const db = firebase.firestore();
const productsCol = db.collection("products");

/* ============================================================
     DETECTAR kind AUTOM√ÅTICAMENTE
=============================================================== */
function autoDetectKind(id, name="", desc="") {
  id = id.toLowerCase();
  name = name.toLowerCase();
  desc = desc.toLowerCase();

  if(id.includes("_doble"))  return "doble";
  if(id.includes("_simple")) return "simple";
  if(id.includes("_pollo"))  return "pollo";

  if(name.includes("doble")) return "doble";
  if(name.includes("pollo")) return "pollo";
  if(desc.includes("doble")) return "doble";
  if(desc.includes("pollo")) return "pollo";

  return "simple";
}

/* ============================================================
     ARCHIVO ‚Üí BASE64
=============================================================== */
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* ============================================================
     GUARDAR / ACTUALIZAR PRODUCTO
=============================================================== */
async function saveProduct(){
  const id   = document.querySelector("#prdId").value.trim();
  const name = document.querySelector("#prdName").value.trim();
  const cat  = document.querySelector("#prdCategory").value;
  const price = Number(document.querySelector("#prdPrice").value || 0);
  const urlImg = document.querySelector("#prdImg").value.trim();
  const desc = document.querySelector("#prdDesc").value.trim();
  const file = document.querySelector("#prdImgFile").files[0];

  if(!id){ alert("Ingres√° ID"); return; }
  if(!name){ alert("Ingres√° nombre"); return; }
  if(!(price > 0)){ alert("Precio inv√°lido"); return; }

  let finalImg = urlImg || null;
  if(file) finalImg = await fileToBase64(file);

  const payload = {
    name,
    category: cat,
    price,
    img: finalImg,
    description: desc || null,
    available: true,
    hidden: false,
    kind: autoDetectKind(id, name, desc),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    await productsCol.doc(id).set(payload, { merge:true });
    alert("Guardado correctamente");
    clearProductForm();
  } catch(e){
    console.error(e);
    alert("Error guardando.");
  }
}

/* ============================================================
     LIMPIAR FORMULARIO
=============================================================== */
function clearProductForm(){
  document.querySelector("#prdId").value = "";
  document.querySelector("#prdName").value = "";
  document.querySelector("#prdCategory").value = "hamburguesas";
  document.querySelector("#prdPrice").value = "";
  document.querySelector("#prdImg").value = "";
  document.querySelector("#prdImgFile").value = "";
  document.querySelector("#prdDesc").value = "";
}

/* ============================================================
     CARGAR PARA EDITAR
=============================================================== */
async function loadProductIntoForm(data, id){
  document.querySelector("#prdId").value = id;
  document.querySelector("#prdName").value = data.name || "";
  document.querySelector("#prdCategory").value = data.category || "hamburguesas";
  document.querySelector("#prdPrice").value = data.price || "";
  document.querySelector("#prdImg").value = (data.img && !data.img.startsWith("data:")) ? data.img : "";
  document.querySelector("#prdImgFile").value = "";
  document.querySelector("#prdDesc").value = data.description || "";
}

/* ============================================================
     ELIMINAR
=============================================================== */
async function deleteProduct(id){
  if(!confirm("¬øEliminar "+id+"?")) return;
  await productsCol.doc(id).delete();
}

/* ============================================================
     CAMBIAR available
=============================================================== */
async function toggleAvailable(id, current){
  await productsCol.doc(id).set({
    available: !current,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
}

/* ============================================================
     CAMBIAR hidden (Quitar del men√∫)
=============================================================== */
async function toggleHidden(id, current){
  await productsCol.doc(id).set({
    hidden: !current,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });
}

/* ============================================================
     RENDER TABLA
=============================================================== */
function renderProductsTable(snapshot){
  const tbody = document.querySelector("#prdTable");
  tbody.innerHTML = "";

  snapshot.forEach(doc=>{
    const p = doc.data();

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${doc.id}</td>
      <td>${p.img ? `<img src="${p.img}" class="img-preview">` : `<div class="img-preview"></div>`}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>$${p.price}</td>
      <td>
        <span class="pill ${p.available ? 'ok' : 'off'}">${p.available ? 'Activo' : 'Pausado'}</span>
        <br>
        <span class="pill ${p.hidden ? 'off' : 'ok'}" style="margin-top:4px">
          ${p.hidden ? 'Oculto' : 'Visible'}
        </span>
      </td>

      <td class="row">
        <button class="btn good" data-act="edit" data-id="${doc.id}">Editar</button>
        <button class="btn warn" data-act="avail" data-id="${doc.id}" data-av="${p.available}">
          ${p.available ? "Desactivar" : "Activar"}
        </button>
        <button class="btn primary" data-act="hide" data-id="${doc.id}" data-hid="${p.hidden}">
          ${p.hidden ? "Volver a mostrar" : "Quitar del men√∫"}
        </button>
        <button class="btn bad" data-act="delete" data-id="${doc.id}">Eliminar</button>
      </td>
    `;

    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button").forEach(btn=>{
    btn.onclick = async ()=>{
      const id  = btn.dataset.id;
      const act = btn.dataset.act;

      if(act==="edit"){
        const snap = await productsCol.doc(id).get();
        loadProductIntoForm(snap.data(), id);

      } else if(act==="avail"){
        toggleAvailable(id, btn.dataset.av === "true");

      } else if(act==="hide"){
        toggleHidden(id, btn.dataset.hid === "true");

      } else if(act==="delete"){
        deleteProduct(id);
      }
    };
  });
}

productsCol.onSnapshot(renderProductsTable);
</script>
<!-- ============================================================
     ORDEN VISUAL DEL MEN√ö ‚Äî DRAG & DROP
=============================================================== -->
<script>
let ORDER_PRODUCTS = [];
let CURRENT_CAT = "hamburguesas";

const menuOrderRef = db.collection("config").doc("menuOrder");
const orderGrid = document.querySelector("#orderGrid");
const orderCatButtons = document.querySelector("#orderCatButtons");

window.addEventListener("DOMContentLoaded", () => {
  if(orderCatButtons){
    orderCatButtons.querySelectorAll("button").forEach(btn=>{
      btn.onclick = ()=>{
        orderCatButtons.querySelectorAll("button").forEach(b=> b.classList.remove("primary"));
        btn.classList.add("primary");
        CURRENT_CAT = btn.dataset.cat;
        renderOrderGrid();
      };
    });
  }
});

/* ============================================================
   Escuchar cambios en menuOrder
=============================================================== */
let MENU_ORDER = {};

menuOrderRef.onSnapshot(snap=>{
  MENU_ORDER = snap.exists ? snap.data() : {};
  renderOrderGrid();
});

/* ============================================================
   Render del grid respetando el orden guardado
=============================================================== */
function renderOrderGrid(){
  if(!orderGrid) return;

  orderGrid.innerHTML = "";

  const list = ORDER_PRODUCTS.filter(p => p.category === CURRENT_CAT);
  const orderIds = MENU_ORDER[CURRENT_CAT] || [];

  list.sort((a,b)=>{
    const ia = orderIds.indexOf(a.id);
    const ib = orderIds.indexOf(b.id);

    if(ia === -1 && ib === -1) return a.name.localeCompare(b.name);
    if(ia === -1) return 1;
    if(ib === -1) return -1;
    return ia - ib;
  });

  list.forEach(p=>{
    const card = document.createElement("div");
    card.className = "orderCard";
    card.draggable = true;
    card.dataset.id = p.id;

    card.innerHTML = `
      <div style="border:1px solid #ddd;border-radius:12px;overflow:hidden;background:#fff">
        <img src="${p.img || ""}" style="width:100%;height:110px;object-fit:cover">
        <div style="padding:10px;font-weight:700;font-size:14px">${p.name}</div>
      </div>
    `;

    card.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("id", p.id);
      card.classList.add("dragging");
    });

    card.addEventListener("dragend", ()=>{
      card.classList.remove("dragging");
    });

    card.addEventListener("dragover", e=>{
      e.preventDefault();
      const dragging = orderGrid.querySelector(".dragging");
      if(!dragging || dragging === card) return;
      orderGrid.insertBefore(dragging, card);
    });

    orderGrid.appendChild(card);
  });
}

/* ============================================================
   Suscripci√≥n a productos
=============================================================== */
productsCol.onSnapshot(snap=>{
  ORDER_PRODUCTS = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  renderOrderGrid();
});
</script>

<!-- ============================================================
     BOT√ìN GUARDAR ORDEN
=============================================================== -->
<script>
window.addEventListener("DOMContentLoaded", ()=>{
  const btnSaveOrder = document.querySelector("#btnSaveOrder");

  if(btnSaveOrder){
    btnSaveOrder.onclick = async ()=>{
      const ids = [...orderGrid.querySelectorAll(".orderCard")].map(c => c.dataset.id);

      await menuOrderRef.set({
        ...MENU_ORDER,
        [CURRENT_CAT]: ids
      }, { merge:true });

      alert("Orden guardada.");
    };
  }
});
</script>

<!-- ============================================================
      CONFIGURACI√ìN DE PAPAS (SIDES)
=============================================================== -->
<script>
const SIDES_META = [
  { key:"con_sazon", label:"Con saz√≥n" },
  { key:"con_sal",   label:"Con sal" },
  { key:"sin_sal",   label:"Sin sal" }
];

const sidesRef = () => db.collection("config").doc("sides");
const sidesContainer = document.querySelector("#sidesContainer");

function renderSidesUI(data){
  if(!sidesContainer) return;
  sidesContainer.innerHTML = "";

  SIDES_META.forEach(s=>{
    const enabled = data ? !!data[s.key] : true;

    const el = document.createElement("div");
    el.className = "side-pill " + (enabled ? "on" : "off");

    el.innerHTML = `
      <div>
        <div style="font-weight:800">${s.label}</div>
        <div class="muted" style="font-size:13px">
          ${enabled ? "Visible" : "Bloqueada"} en web y mostrador
        </div>
      </div>

      <button class="btn ${enabled?'bad':'good'}"
              data-key="${s.key}"
              data-next="${enabled?0:1}">
        ${enabled ? "Deshabilitar" : "Habilitar"}
      </button>
    `;

    sidesContainer.appendChild(el);
  });

  sidesContainer.querySelectorAll("button[data-key]").forEach(btn=>{
    btn.onclick = async ()=>{
      const key = btn.dataset.key;
      const next = btn.dataset.next === "1";

      btn.disabled = true;

      await sidesRef().set({
        [key]: next,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      btn.disabled = false;
    };
  });
}

sidesRef().onSnapshot(snap=>{
  renderSidesUI(snap.exists ? snap.data() : {});
});
</script>
<!-- ============================================================
      üî• INVENTARIO
=============================================================== -->
<script>
const invList = document.querySelector('#invList');

function renderInventory(snapshot){
  if(!invList) return;
  invList.innerHTML = '';

  snapshot.forEach(doc=>{
    const p = doc.data();
    const available = !!p.available;

    const el = document.createElement('div');
    el.className = "tile";
    el.innerHTML = `
      <div>
        <div style="font-weight:800">${p.name}</div>
        <div class="muted" style="font-size:13px">${p.category}</div>
      </div>

      <div class="row">
        <span class="pill ${available?'ok':'off'}">
          ${available ? 'Disponible' : 'Sin stock'}
        </span>

        <button class="btn ${available?'warn':'good'}"
                data-id="${doc.id}" data-next="${available?0:1}">
          ${available ? 'Desactivar' : 'Activar'}
        </button>
      </div>
    `;
    invList.appendChild(el);
  });

  invList.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = async()=>{
      const id = btn.dataset.id;
      const next = btn.dataset.next === "1";

      try{
        await productsCol.doc(id).set({
          available: next,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        },{merge:true});
      }catch(e){
        alert("Error cambiando disponibilidad.");
      }
    };
  });
}

productsCol.onSnapshot(renderInventory);
</script>

<!-- ============================================================
      üî• STORE OVERRIDE (Horarios y forzar abierto)
=============================================================== -->
<script>
const storeRef = () => db.collection("config").doc("store");

const storePill        = document.querySelector("#storePill");
const storeSub         = document.querySelector("#storeSub");
const btnOpen          = document.querySelector("#btnForceOpen");
const btnClose         = document.querySelector("#btnForceClose");
const forceUntilInput  = document.querySelector("#forceUntil");
const btnSaveUntil     = document.querySelector("#btnSaveUntil");

function applyStoreDocToUI(d){
  const on = !!d.forceOpen;
  let until = null;

  if(d.forceOpenUntil){
    try{
      if(typeof d.forceOpenUntil.toDate === "function"){
        until = d.forceOpenUntil.toDate();
      } else if(d.forceOpenUntil.seconds){
        until = new Date(d.forceOpenUntil.seconds * 1000);
      } else {
        until = new Date(d.forceOpenUntil);
      }
    }catch(e){}
  }

  const active = on || (until && until.getTime() > Date.now());

  storePill.className = "pill " + (active ? "ok" : "off");
  storePill.textContent = "Estado: " + (active ? "Forzado ABIERTO" : "Normal");

  if(until && until.getTime() > Date.now()){
    storeSub.textContent =
      "Hasta: " +
      String(until.getHours()).padStart(2,"0") + ":" +
      String(until.getMinutes()).padStart(2,"0");

    const local = new Date(until.getTime() - until.getTimezoneOffset()*60000);
    forceUntilInput.value = local.toISOString().slice(0,16);
  } else {
    storeSub.textContent = d.forceOpenMessage || "Normal";
    forceUntilInput.value = "";
  }
}

storeRef().onSnapshot(snap=>{
  applyStoreDocToUI(snap.exists ? snap.data() : {});
});

btnOpen.onclick = async()=>{
  await storeRef().set({
    forceOpen:true,
    updatedAt:firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
};

btnClose.onclick = async()=>{
  await storeRef().set({
    forceOpen:false,
    forceOpenMessage: firebase.firestore.FieldValue.delete(),
    forceOpenUntil: firebase.firestore.FieldValue.delete(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
};

btnSaveUntil.onclick = async()=>{
  const v = forceUntilInput.value;
  if(!v){ alert("Eleg√≠ fecha y hora"); return; }

  const local = new Date(v);
  if(isNaN(local.getTime())){
    alert("Fecha inv√°lida");
    return;
  }

  await storeRef().set({
    forceOpen:true,
    forceOpenUntil: firebase.firestore.Timestamp.fromDate(local),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});

  alert("Guardado correctamente.");
};
</script>

<!-- ============================================================
      üî• CUPONES (CRUD COMPLETO)
=============================================================== -->
<script>
const cpTbody = document.querySelector("#cpTable");

function upsertCouponFromForm(){
  const code = (document.querySelector("#cpCode").value||"").trim().toUpperCase();
  if(!code){ alert("Ingres√° c√≥digo"); return; }

  const type = document.querySelector("#cpType").value;
  const value = Number(document.querySelector("#cpValue").value||0);
  if(!(value>0)){ alert("Valor inv√°lido"); return; }

  const maxUses = Number(document.querySelector("#cpMaxUses").value||0);
  const note    = (document.querySelector("#cpNote").value||"").trim();
  const from    = document.querySelector("#cpFrom").value ? new Date(document.querySelector("#cpFrom").value) : null;
  const to      = document.querySelector("#cpTo").value   ? new Date(document.querySelector("#cpTo").value)   : null;

  const payload = {
    code, type, value,
    enabled:true,
    note: note || null,
    validFrom: from ? firebase.firestore.Timestamp.fromDate(from) : null,
    validTo:   to   ? firebase.firestore.Timestamp.fromDate(to)   : null,
    maxUses: maxUses > 0 ? maxUses : null,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  db.collection("coupons").doc(code)
    .set({
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      uses:0,
      ...payload
    },{merge:true})
    .then(()=>{
      alert("Cup√≥n guardado");
      loadCoupons();
    })
    .catch(()=>{
      alert("Error guardando cup√≥n");
    });
}

document.querySelector("#btnCreateCp").onclick = upsertCouponFromForm;

function renderCoupons(list){
  cpTbody.innerHTML = "";

  list.forEach(doc=>{
    const c = doc.data();
    const uses = `${c.uses||0}${c.maxUses?` / ${c.maxUses}`:''}`;

    const vf = c.validFrom ? fmtDate(c.validFrom) : null;
    const vt = c.validTo   ? fmtDate(c.validTo)   : null;

    const vig =
      (vf ? vf.toLocaleDateString("es-AR") + " " : "") +
      (vt ? "‚Üí " + vt.toLocaleDateString("es-AR") : "");

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${c.code}</td>
      <td>${c.type === "percent" ? "%" : "$"}</td>
      <td>${c.value}</td>
      <td>${uses}</td>
      <td>${vig || "-"}</td>
      <td>${c.enabled ? "<span class='pill ok'>HABILITADO</span>" : "<span class='pill off'>PAUSADO</span>"}</td>
      <td class="row">
        <button class="btn ${c.enabled?'warn':'good'}" data-act="toggle" data-id="${doc.id}">
          ${c.enabled ? "Deshabilitar" : "Habilitar"}
        </button>
        <button class="btn bad" data-act="delete" data-id="${doc.id}">
          Eliminar
        </button>
      </td>
    `;

    cpTbody.appendChild(tr);
  });

  cpTbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.onclick = async()=>{
      const id  = btn.dataset.id;
      const act = btn.dataset.act;

      if(act === "toggle"){
        const snap = await db.collection("coupons").doc(id).get();
        const enabled = !!snap.data()?.enabled;

        await db.collection("coupons")
          .doc(id)
          .set({ enabled:!enabled, updatedAt:new Date() },{merge:true});

        loadCoupons();

      } else if(act === "delete"){
        if(confirm("¬øEliminar "+id+"?")){
          await db.collection("coupons").doc(id).delete();
          loadCoupons();
        }
      }
    };
  });
}

async function loadCoupons(){
  const q = await db.collection("coupons").orderBy("code").get();
  renderCoupons(q.docs);
}
</script>

<!-- ============================================================
      üî• BOOT FINAL
=============================================================== -->
<script>
(async function boot(){
  loadCoupons();
})();
</script>

<!-- ============================================================
      üî• BOTONES FINAL CRUD
=============================================================== -->
<script>
window.addEventListener("DOMContentLoaded", ()=>{
  const btnSaveProduct = document.querySelector("#btnSaveProduct");
  if(btnSaveProduct){
    btnSaveProduct.onclick = saveProduct;
  }

  const btnClearProduct = document.querySelector("#btnClearProduct");
  if(btnClearProduct){
    btnClearProduct.onclick = clearProductForm;
  }
});
</script>
