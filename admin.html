<main>

  <!-- ===================================================== -->
  <!-- üî•üî• NUEVO M√ìDULO COMPLETO: PRODUCTOS (CRUD + IM√ÅGENES) -->
  <!-- ===================================================== -->
  <section class="card">
    <h2>Productos (crear / editar / ordenar / fotos)</h2>
    <p class="muted">
      Administr√° todos los productos que aparecen en la web y mostrador.
      Pod√©s agregar, editar, borrar, subir im√°genes y ordenar arrastrando.
    </p>

    <div class="row" style="margin-bottom:12px">
      <button class="btn primary" id="btnNewProduct">‚ûï Nuevo producto</button>
      <button class="btn" id="btnMigrateImages">Migrar im√°genes desde GitHub ‚Üí Firebase</button>
      <span id="migrateStatus" style="font-weight:800;color:#625A45;margin-left:10px"></span>
    </div>

    <!-- Grilla de productos -->
    <div id="productGrid" class="grid" style="margin-top:16px"></div>
  </section>

  <!-- ============================================================== -->
  <!-- üî• MODAL PARA CREAR / EDITAR PRODUCTO (NUEVO COMPLETO)        -->
  <!-- ============================================================== -->
  <div class="modal-backdrop" id="productModalBackdrop" style="display:none">
    <div class="modal" id="productModalBox">

      <h2 id="productModalTitle">Nuevo producto</h2>

      <label><strong>Nombre</strong></label>
      <input id="prod_name" type="text">

      <label style="margin-top:10px"><strong>Precio</strong></label>
      <input id="prod_price" type="number" min="0">

      <label style="margin-top:10px"><strong>Categor√≠a</strong></label>
      <select id="prod_category">
        <option value="hamburguesas">Hamburguesas</option>
        <option value="bebidas">Bebidas</option>
        <option value="papas">Papas</option>
      </select>

      <label style="margin-top:10px"><strong>Descripci√≥n</strong></label>
      <textarea id="prod_description"></textarea>

      <label style="margin-top:10px"><strong>Imagen</strong></label>
      <input id="prod_image" type="file" accept="image/*">

      <img id="prod_img_preview"
           style="width:100%;height:200px;object-fit:cover;border-radius:14px;margin-top:8px;display:none">

      <label style="margin-top:10px"><strong>Disponible</strong></label>
      <input id="prod_available" type="checkbox">

      <div class="row" style="margin-top:18px;justify-content:flex-end">
        <button class="btn" id="btnCancelProduct">Cancelar</button>
        <button class="btn primary" id="btnSaveProduct">Guardar</button>
      </div>

    </div>
  </div>

  <!-- ======================================================== -->
  <!-- üî∏ PAPAS / SIDES (TU M√ìDULO ORIGINAL, NO TOCADO)        -->
  <!-- ======================================================== -->
  <section class="card">
    <h2>Papas (habilitar / deshabilitar variantes)</h2>
    <p class="muted">Aqu√≠ pod√©s activar o desactivar las variantes de papas que quer√©s ofrecer en la web y en mostrador. El estado se guarda en <code>config/sides</code>.</p>

    <div id="sidesContainer" style="margin-top:12px" class="side-config">
      <!-- Render din√°mico -->
    </div>
  </section>

  <!-- ======================================================== -->
  <!-- üî∏ INVENTARIO LEGACY (lo mantenemos intacto)            -->
  <!-- ======================================================== -->
  <section class="card">
    <h2>Inventario (activar / desactivar productos)</h2>
    <p class="muted">Toc√° el switch para sacar un producto sin stock. La web lee <code>products/{id}.available</code> para ocultar el bot√≥n de compra.</p>
    <div id="invList" class="grid"></div>
  </section>

  <!-- ======================================================== -->
  <!-- üî∏ CUPONES (NO TOCADO)                                   -->
  <!-- ======================================================== -->
  <section class="card">
    <h2>Cupones de descuento</h2>

    <div class="form-grid">
      <div>
        <label><strong>C√≥digo</strong></label>
        <input id="cpCode" type="text" placeholder="Ej: BURGERS10">
      </div>
      <div>
        <label><strong>Tipo</strong></label>
        <select id="cpType">
          <option value="percent">Porcentaje (%)</option>
          <option value="fixed">Monto fijo ($)</option>
        </select>
      </div>
      <div>
        <label><strong>Valor</strong></label>
        <input id="cpValue" type="number" min="0" step="1" placeholder="Ej: 10 o 1500">
      </div>
      <div>
        <label><strong>M√°x. usos (opcional)</strong></label>
        <input id="cpMaxUses" type="number" min="0" step="1" placeholder="0 = ilimitado">
      </div>
      <div>
        <label><strong>V√°lido desde (opcional)</strong></label>
        <input id="cpFrom" type="datetime-local">
      </div>
      <div>
        <label><strong>V√°lido hasta (opcional)</strong></label>
        <input id="cpTo" type="datetime-local">
      </div>
      <div style="grid-column:1/-1">
        <label><strong>Nota (opcional)</strong></label>
        <input id="cpNote" type="text" placeholder="Texto interno de referencia">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnCreateCp">Crear / Actualizar cup√≥n</button>
      <span class="muted">Los c√≥digos se guardan en may√∫sculas.</span>
    </div>

    <div class="sep"></div>

    <h3 style="margin:0 0 6px">Cupones activos</h3>
    <div class="muted" style="margin-bottom:6px">Pod√©s habilitar/deshabilitar o eliminar un cup√≥n.</div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th><th>Tipo</th><th>Valor</th><th>Usos</th><th>Vigencia</th><th>Estado</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="cpTable"></tbody>
      </table>
    </div>
  </section>

</main>
<script>
/* ============================================================
    üî• PRODUCTOS DIN√ÅMICOS ‚Äî CRUD + RENDER + DRAG & DROP
    Firestore: colecci√≥n "products"
============================================================ */

const productGrid = document.getElementById("productGrid");

let productModalBackdrop, productModalBox;
let editingProduct = null;  // null = creando, sino id del producto

/* ============================================================
    üî• Abrir modal
============================================================ */
function openProductModal(edit = false, data = null) {
  editingProduct = edit ? data.id : null;

  productModalBackdrop.style.display = "flex";
  document.getElementById("productModalTitle").textContent =
    edit ? "Editar producto" : "Nuevo producto";

  // Cargar datos si edita
  document.getElementById("prod_name").value = data?.name || "";
  document.getElementById("prod_price").value = data?.price || "";
  document.getElementById("prod_category").value = data?.category || "hamburguesas";
  document.getElementById("prod_description").value = data?.description || "";
  document.getElementById("prod_available").checked = data?.available ?? true;

  // Im√°gen
  const prev = document.getElementById("prod_img_preview");
  prev.src = data?.imageUrl || "";
  prev.style.display = data?.imageUrl ? "block" : "none";

  document.getElementById("prod_image").value = "";
}

/* ============================================================
    üî• Cerrar modal
============================================================ */
function closeProductModal() {
  productModalBackdrop.style.display = "none";
  editingProduct = null;
}

/* ============================================================
    üî• Render de tarjeta de producto
============================================================ */
function renderProductCard(p) {
  const el = document.createElement("div");
  el.className = "tile";
  el.style.cursor = "grab";
  el.draggable = true;
  el.dataset.id = p.id;

  el.innerHTML = `
    <div style="display:flex;gap:12px;width:100%">
      <img src="${p.imageUrl}" style="width:90px;height:90px;object-fit:cover;border-radius:12px;background:#eee">
      <div style="flex:1">
        <div style="font-weight:800;font-size:17px">${p.name}</div>
        <div class="muted" style="font-size:13px">${p.category}</div>
        <div class="muted" style="font-size:13px">${p.description || ""}</div>
        <div style="margin-top:6px;font-weight:800">$${p.price}</div>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;justify-content:space-between;align-items:flex-end;min-width:90px">
      <span class="pill ${p.available ? 'ok' : 'off'}">${p.available ? 'Activo' : 'Pausado'}</span>

      <div style="display:flex;gap:6px;margin-top:6px">
        <button class="btn" style="padding:6px 10px" onclick="editProduct('${p.id}')">Editar</button>
        <button class="btn bad" style="padding:6px 10px" onclick="deleteProduct('${p.id}')">Borrar</button>
      </div>
    </div>
  `;

  // DRAG EVENTS
  el.addEventListener("dragstart", productDragStart);
  el.addEventListener("dragover", productDragOver);
  el.addEventListener("drop", productDragDrop);
  el.addEventListener("dragend", productDragEnd);

  return el;
}

/* ============================================================
    üî• Cargar todos los productos con orden
============================================================ */
async function loadProducts() {
  const snap = await db.collection("products")
    .orderBy("order", "asc")
    .get();

  productGrid.innerHTML = "";

  snap.forEach(doc => {
    const p = { id: doc.id, ...doc.data() };
    productGrid.appendChild(renderProductCard(p));
  });
}

/* ============================================================
    üî• Guardar producto (crear o actualizar)
============================================================ */
async function saveProduct() {
  const name = document.getElementById("prod_name").value.trim();
  const price = Number(document.getElementById("prod_price").value);
  const category = document.getElementById("prod_category").value;
  const description = document.getElementById("prod_description").value;
  const available = document.getElementById("prod_available").checked;

  const file = document.getElementById("prod_image").files[0];
  let imageUrl = null;

  // Si est√° editando, recuperar data previa
  if (editingProduct) {
    const snap = await db.collection("products").doc(editingProduct).get();
    imageUrl = snap.data().imageUrl;
  }

  // Si seleccion√≥ nueva imagen
  if (file) {
    imageUrl = await uploadImageToFirebase(file); // (PARTE 3)
  }

  // Modo crear
  if (!editingProduct) {
    // Obtener √∫ltimo "order"
    const last = await db.collection("products")
      .orderBy("order", "desc")
      .limit(1)
      .get();

    let nextOrder = last.empty ? 1 : last.docs[0].data().order + 1;

    await db.collection("products").add({
      name,
      price,
      category,
      description,
      imageUrl: imageUrl || "",
      available,
      order: nextOrder,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  // Modo editar
  else {
    await db.collection("products").doc(editingProduct).set({
      name,
      price,
      category,
      description,
      imageUrl: imageUrl || "",
      available,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  }

  closeProductModal();
  loadProducts();
}

/* ============================================================
    üî• Editar
============================================================ */
async function editProduct(id) {
  const snap = await db.collection("products").doc(id).get();
  const p = { id, ...snap.data() };
  openProductModal(true, p);
}

/* ============================================================
    üî• Borrar
============================================================ */
async function deleteProduct(id) {
  if (!confirm("¬øEliminar producto?")) return;

  await db.collection("products").doc(id).delete();
  loadProducts();
}

/* ============================================================
    üî• DRAG & DROP
============================================================ */
let dragSrc = null;

function productDragStart() {
  dragSrc = this;
  this.style.opacity = "0.4";
}
function productDragOver(e) {
  e.preventDefault();
}
function productDragDrop(e) {
  if (dragSrc !== this) {
    const items = Array.from(productGrid.children);
    const srcIndex = items.indexOf(dragSrc);
    const destIndex = items.indexOf(this);

    if (srcIndex > destIndex)
      productGrid.insertBefore(dragSrc, this);
    else
      productGrid.insertBefore(dragSrc, this.nextSibling);

    saveProductOrder();
  }
}
function productDragEnd() {
  this.style.opacity = "1";
}

/* ============================================================
    üî• Guardar el nuevo orden
============================================================ */
async function saveProductOrder() {
  const cards = Array.from(productGrid.children);
  const batch = db.batch();

  cards.forEach((c, i) => {
    batch.update(
      db.collection("products").doc(c.dataset.id),
      { order: i + 1 }
    );
  });

  await batch.commit();
}

/* ============================================================
    üî• INIT
============================================================ */
document.addEventListener("DOMContentLoaded", () => {
  productModalBackdrop = document.getElementById("productModalBackdrop");
  productModalBox = document.getElementById("productModalBox");

  document.getElementById("btnNewProduct").onclick = () => openProductModal(false);
  document.getElementById("btnCancelProduct").onclick = closeProductModal;
  document.getElementById("btnSaveProduct").onclick = saveProduct;

  loadProducts();
});
</script>
<!-- ===============================================
      üî• PARTE 3 ‚Äî SUBIDA A FIREBASE STORAGE
      + PREVIEW
      + MIGRADOR GITHUB ‚Üí STORAGE
================================================ -->
<script>

const storage = firebase.storage();
const storageRoot = storage.ref();

/* ============================================================
    üî• Subir imagen a Firebase Storage y obtener URL p√∫blica
============================================================ */
function uploadImageToFirebase(file) {
  return new Promise((resolve, reject) => {

    // Nombre √∫nico: products/timestamp_filename.jpg
    const finalName = `products/${Date.now()}_${file.name}`;
    const ref = storageRoot.child(finalName);

    const uploadTask = ref.put(file);

    uploadTask.on(
      "state_changed",
      null,
      (err) => {
        console.error("Error subiendo imagen:", err);
        reject(err);
      },
      async () => {
        const url = await ref.getDownloadURL();
        resolve(url);
      }
    );
  });
}

/* ============================================================
    üî• Previsualizaci√≥n de imagen antes de guardar
============================================================ */
document.addEventListener("change", (e) => {
  if (e.target.id === "prod_image") {
    const file = e.target.files[0];
    if (!file) return;

    const prev = document.getElementById("prod_img_preview");
    prev.style.display = "block";
    prev.src = URL.createObjectURL(file);
  }
});


/* ============================================================
    üî• MIGRADOR AUTOM√ÅTICO GITHUB ‚Üí STORAGE
============================================================ */
/*
   Convierte todas tus im√°genes actuales (GitHub)
   a Firebase Storage autom√°ticamente.

   üîó Carpeta origen GitHub:
   https://raw.githubusercontent.com/Pecaok/Rhodes-Burger/main/images/
*/
const GITHUB_IMG_BASE =
  "https://raw.githubusercontent.com/Pecaok/Rhodes-Burger/main/images/";

/* Descargar imagen desde GitHub */
async function downloadGitHubImage(filename) {
  const url = GITHUB_IMG_BASE + filename;
  const res = await fetch(url);

  if (!res.ok) throw new Error("No se pudo descargar: " + filename);

  return await res.blob();
}

/* Subir blob descargado */
async function uploadMigratedImage(filename, blob) {
  const ref = storageRoot.child("products/" + filename);
  await ref.put(blob);
  return await ref.getDownloadURL();
}

/* Ejecutar migraci√≥n */
async function migrateImagesFromGitHub() {
  const status = document.getElementById("migrateStatus");
  status.style.display = "block";
  status.textContent = "Buscando productos...";

  const snap = await db.collection("products").get();
  if (snap.empty) {
    status.textContent = "No hay productos en Firestore.";
    return;
  }

  let total = snap.size;
  let done = 0;

  for (const doc of snap.docs) {
    const p = doc.data();

    const oldUrl = p.imageUrl || "";
    if (!oldUrl) {
      done++;
      continue;
    }

    // Extraer nombre original
    const fileName = oldUrl.split("/").pop();

    try {
      status.textContent = `Migrando ${done + 1}/${total}: ${fileName}`;

      // 1) Descargar desde GitHub
      const blob = await downloadGitHubImage(fileName);

      // 2) Subir a Storage
      const newURL = await uploadMigratedImage(fileName, blob);

      // 3) Guardar nueva URL
      await db.collection("products").doc(doc.id).update({
        imageUrl: newURL
      });
    } catch (e) {
      console.error("Error migrando", fileName, e);
    }

    done++;
  }

  status.textContent = `‚úî Migraci√≥n finalizada (${done}/${total})`;
}

/* Bot√≥n migrar */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnMigrateImages").onclick = () => {
    if (!confirm("¬øMigrar TODAS las im√°genes desde GitHub ‚Üí Firebase Storage?")) return;
    migrateImagesFromGitHub();
  };
});

</script>
