<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
      --success:#2e7d32; --danger:#d32f2f; --warn:#f57c00;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:34px;height:34px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}
    .btn.ghost{background:#fff}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-weight:800}
    .badge.ok{color:var(--success);border-color:#cde9d2;background:#f3fbf4}
    .badge.err{color:var(--danger);border-color:#f4c7c7;background:#fdecec}
    .badge.warn{color:#8a6d3b;border-color:#ffe58f;background:#fff8da}
    .container{max-width:1100px;margin:20px auto;padding:0 12px;display:grid;grid-template-columns:1fr;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h1{font-size:28px;margin:0 0 6px}
    h2{font-size:18px;margin:0 0 8px}
    .muted{color:var(--muted)}
    label{font-weight:600}
    input[type="text"], textarea{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px}
    .switch{appearance:none;width:38px;height:22px;background:#ddd;border-radius:999px;position:relative;outline:none;cursor:pointer;vertical-align:middle}
    .switch:after{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:left .15s}
    .switch:checked{background:#8BC34A}
    .switch:checked:after{left:19px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .item{border:1px solid var(--ring);border-radius:14px;padding:12px;background:#fff;display:flex;justify-content:space-between;gap:12px}
    .item small{display:block;color:var(--muted)}
    .hr{height:1px;background:#eee;margin:10px 0}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.2);opacity:0;pointer-events:none;transition:opacity .15s}
    .toast.show{opacity:1}
    .err{color:var(--danger)}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="">Admin</a>
      <div class="spacer"></div>
      <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
      <a class="btn" href="finanzas.html">üìä Finanzas</a>
      <a class="btn" href="mostrador.html">üßæ Mostrador</a>
      <button id="btnLogout" class="btn danger">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <!-- Estado del local -->
    <section class="card">
      <h1>Panel de administraci√≥n</h1>

      <div class="row" style="justify-content:space-between">
        <div>
          <h2>Estado del local</h2>
          <div id="stateBadge" class="badge warn">Cargando‚Ä¶</div>
        </div>
        <div class="row">
          <button id="btnOpen"  class="btn">‚úÖ Abrir</button>
          <button id="btnClose" class="btn">‚õî Cerrar</button>
        </div>
      </div>

      <div class="hr"></div>
      <div>
        <label>Mensaje (opcional, visible cuando est√° cerrado/abierto)</label>
        <textarea id="stateMsg" placeholder="Ej: Abrimos por evento especial hasta las 00:30."></textarea>
        <div class="row" style="margin-top:8px">
          <button id="btnSaveMsg" class="btn primary">Guardar mensaje</button>
          <button id="btnClearMsg" class="btn ghost">Limpiar</button>
          <span id="stateInfo" class="muted"></span>
        </div>
        <div id="stateError" class="err" style="margin-top:6px"></div>
      </div>
      <div class="muted" style="margin-top:8px">
        Este estado lo usan <strong>index</strong> y <strong>mostrador</strong> para mostrar ‚ÄúAbierto/Cerrado‚Äù.
      </div>
    </section>

    <!-- Disponibilidad de √≠tems -->
    <section class="card">
      <h2>Disponibilidad de √≠tems</h2>
      <div class="muted" style="margin-bottom:8px">
        Desact√≠valos cuando no haya stock. Impacta en <strong>index</strong> y <strong>mostrador</strong> (oculta/bloquea el bot√≥n).
      </div>

      <div id="itemsGrid" class="grid"></div>
      <div id="itemsError" class="err" style="margin-top:8px"></div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(_){}
    const db = firebase.firestore();

    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),1500); };

    // ===== Nav: cerrar sesi√≥n =====
    document.getElementById("btnLogout").onclick = ()=>{
      try{
        localStorage.removeItem('rb_admin_ok');
        localStorage.removeItem('rb_admin_t');
        localStorage.removeItem('rb_auth_v2');
        sessionStorage.removeItem('rb_auth_v2');
      }catch(_){}
      location.href = 'login.html?reason=logout&next=admin.html';
    };

    // ======== OPEN/CLOSE ========
    const openRef  = db.collection('settings').doc('open_state');

    function renderOpenState(data){
      const isOpen = !!(data && data.isOpen);
      const msg    = (data && data.message) ? String(data.message) : '';
      const badge  = $("#stateBadge");
      badge.className = 'badge ' + (isOpen ? 'ok' : 'err');
      badge.textContent = isOpen ? 'ABIERTO' : 'CERRADO';
      $("#stateMsg").value = msg;
      $("#stateInfo").textContent = data && data.updatedAt && data.updatedAt.toDate
        ? 'Actualizado: ' + data.updatedAt.toDate().toLocaleString('es-AR') : '';
    }

    function setOpenState(isOpen){
      $("#stateError").textContent = '';
      return openRef.set({
        isOpen: !!isOpen,
        message: $("#stateMsg").value || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true}).then(()=> toast(isOpen ? 'Local ABIERTO' : 'Local CERRADO'))
       .catch(e=> $("#stateError").textContent = 'No se pudo actualizar el estado: ' + (e && e.message ? e.message : e));
    }

    $("#btnOpen").onclick  = ()=> setOpenState(true);
    $("#btnClose").onclick = ()=> setOpenState(false);
    $("#btnSaveMsg").onclick = ()=> setOpenState(undefined); // solo mensaje (isOpen se preserva)
    $("#btnClearMsg").onclick= ()=> { $("#stateMsg").value=''; setOpenState(undefined); };

    // Listener realtime
    openRef.onSnapshot(snap=>{
      if(snap.exists) renderOpenState(snap.data());
      else renderOpenState({isOpen:false,message:''});
    }, err=>{
      $("#stateError").textContent = 'Error de conexi√≥n: ' + (err && err.message ? err.message : err);
    });

    // ======== MENU FLAGS ========
    const flagsRef = db.collection('settings').doc('menu_flags');
    let disabledMap = {}; // { productId: true }
    let productList = []; // [{id,name}]

    // Fallback por si no hay colecci√≥n products
    const FALLBACK = [
      {id:"bigjohn_simple", name:"Big John Simple"},
      {id:"bigjohn_doble",  name:"Big John Doble"},
      {id:"burguesa_simple", name:"Burguesa Simple"},
      {id:"burguesa_doble",  name:"Burguesa Doble"},
      {id:"cheesebacon_simple", name:"CheeseBacon Simple"},
      {id:"cheesebacon_doble",  name:"CheeseBacon Doble"},
      {id:"cheese_simple", name:"Cheeseburger Simple"},
      {id:"cheese_doble",  name:"Cheeseburger Doble"},
      {id:"rhodes_simple", name:"Rhodes Simple"},
      {id:"rhodes_doble",  name:"Rhodes Doble"},
      {id:"morgan_simple", name:"Morgan Simple"},
      {id:"morgan_doble",  name:"Morgan Doble"},
      {id:"pollo_crispy",  name:"Pollo Crispy"},
      {id:"andes_rubia", name:"Andes Rubia 473ml"},
      {id:"andes_roja",  name:"Andes Roja 473ml"},
      {id:"coca_org",    name:"Coca-Cola Original 500ml"},
      {id:"coca_zero",   name:"Coca-Cola Zero 500ml"},
      {id:"sprite",      name:"Sprite 500ml"},
      {id:"aq_pomelo",   name:"Aquarius Pomelo 500ml"},
      {id:"aq_pera",     name:"Aquarius Pera 500ml"},
      {id:"aq_manzana",  name:"Aquarius Manzana 500ml"},
      {id:"agua_sg",     name:"Agua sin gas 500ml"}
    ];

    function renderItems(){
      const host = $("#itemsGrid");
      host.innerHTML = '';
      const list = productList.length ? productList : FALLBACK;
      list.forEach(p=>{
        const active = !disabledMap[p.id];
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div>
            <strong>${p.name}</strong>
            <small>ID: ${p.id}</small>
          </div>
          <label class="pill">
            <span class="muted">${active? 'Activo' : 'Inactivo'}</span>
            <input type="checkbox" class="switch" ${active?'checked':''} data-id="${p.id}">
          </label>
        `;
        host.appendChild(el);
      });

      // Bind switches
      host.querySelectorAll('.switch').forEach(sw=>{
        sw.addEventListener('change', (e)=>{
          const id = e.target.getAttribute('data-id');
          const isActive = e.target.checked;
          // Escribimos: disabled[id] = !isActive
          const patch = Object.assign({}, disabledMap);
          if(!isActive) patch[id] = true; else delete patch[id];

          // Escribimos SOLO los campos permitidos por reglas
          flagsRef.set({
            disabled: patch,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, {merge:false})
          .then(()=>{ disabledMap = patch; toast(isActive? 'Activado' : 'Desactivado'); renderItems(); })
          .catch(err=>{
            $("#itemsError").textContent = 'No se pudo cambiar el estado de "'+id+'": ' + (err && err.message ? err.message : err);
            // revertir visual
            e.target.checked = !e.target.checked;
          });
        });
      });
    }

    // Cargamos productos (solo lectura)
    (async function loadProducts(){
      try{
        const snap = await db.collection('products').orderBy('name','asc').get();
        productList = snap.docs.map(d=>({ id:d.id, name:(d.data().name||d.id) }));
      }catch(_){
        productList = []; // caer√° a FALLBACK
      }
      renderItems();
    })();

    // Escuchamos flags en tiempo real
    flagsRef.onSnapshot(snap=>{
      if(snap.exists){
        const data = snap.data();
        disabledMap = (data && data.disabled) ? data.disabled : {};
      }else{
        disabledMap = {};
      }
      renderItems();
      $("#itemsError").textContent = '';
    }, err=>{
      $("#itemsError").textContent = 'Error al escuchar disponibilidad: ' + (err && err.message ? err.message : err);
    });
  </script>
</body>
</html>
