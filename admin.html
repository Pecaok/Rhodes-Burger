<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#625A45;
      --bg:#f6f6f6;
      --card:#fff;
      --text:#222;
      --muted:#666;
      --ring:#e2e2e2;
      --shadow:0 4px 14px rgba(0,0,0,.08);
      --radius:16px;
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    header{
      background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
      padding:12px 16px;
      position:sticky;
      top:0;
      z-index:20;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
      gap:8px;
    }
    .brand img{ width:36px;height:36px;border-radius:10px }

    .spacer{ flex:1 }

    .btn{
      padding:10px 16px;
      border-radius:999px;
      border:1px solid var(--primary);
      background:#fff;
      font-weight:700;
      color:var(--primary);
      cursor:pointer;
    }
    .btn.primary{
      background:var(--primary);
      color:#fff;
    }

    /* CONTENIDO */
    .container{
      max-width:1100px;
      margin:24px auto;
      padding:0 16px;
    }

    h1{ margin:0 0 20px }

    /* CATEGOR√çAS */
    .catRow{
      display:flex;
      gap:10px;
      margin-bottom:20px;
      flex-wrap:wrap;
    }

    .catBtn{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 16px;
      border-radius:14px;
      border:1px solid var(--ring);
      background:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .catBtn.active{
      border-color:var(--primary);
      background:#efeae2;
    }
    .catToggle{
      width:38px;
      height:20px;
      background:#ddd;
      border-radius:999px;
      position:relative;
      transition:.25s;
    }
    .catToggle::after{
      content:"";
      width:16px;height:16px;
      background:#fff;
      border-radius:50%;
      position:absolute;
      top:2px;left:2px;
      transition:.25s;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    .catBtn.off .catToggle{
      background:#ccc;
    }
    .catBtn.off .catToggle::after{
      left:2px;
    }
    .catBtn.on .catToggle{
      background:var(--primary);
    }
    .catBtn.on .catToggle::after{
      left:20px;
    }

    /* GRID DE PRODUCTOS */
    #productsGrid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:18px;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      cursor:grab;
      user-select:none;
      position:relative;
      display:flex;
      flex-direction:column;
    }

    .card.dragging{
      opacity:.4;
      transform:scale(.95);
    }

    .card img{
      width:100%;
      height:160px;
      object-fit:cover;
    }

    .card .body{
      padding:12px;
    }

    .card h3{
      margin:0 0 6px;
      font-size:18px;
    }

    .muted{ color:var(--muted); font-size:14px }

    .price{
      font-weight:800;
      font-size:18px;
      margin-top:6px;
    }

    .actions{
      display:flex;
      justify-content:space-between;
      margin-top:10px;
    }

    .btnSmall{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--ring);
      cursor:pointer;
      font-weight:600;
      background:#fff;
    }

    .btnSmall.del{
      background:#ffe5e5;
      color:#b30000;
      border-color:#ffb3b3;
    }

    /* MODAL */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .overlay.open{ display:flex }

    .modal{
      width:520px;
      max-width:90%;
      background:#fff;
      padding:20px;
      border-radius:20px;
      box-shadow:var(--shadow);
    }

    .modal h2{
      margin:0 0 16px;
      font-size:22px;
    }

    label{
      font-weight:600;
      margin-top:10px;
      display:block;
    }
    input, textarea, select{
      width:100%;
      padding:10px;
      border:1px solid var(--ring);
      border-radius:12px;
      margin-top:4px;
    }
    textarea{ min-height:80px }

    .modalActions{
      text-align:right;
      margin-top:14px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .previewImg{
      width:100%;
      height:180px;
      object-fit:cover;
      border-radius:12px;
      background:#eee;
      margin-top:8px;
    }

  </style>
</head>

<body>
<header>
  <div class="topbar">
    <a class="brand" href="admin.html">
      <img src="images/logo.png" />
      Rhodes Admin
    </a>

    <div class="spacer"></div>

    <button id="btnLogout" class="btn">Cerrar sesi√≥n</button>
  </div>
</header>

<main class="container">
  <h1>Productos</h1>

  <!-- CATEGOR√çAS -->
  <div class="catRow" id="categoriesRow">
    <!-- botones insertados por JS -->
  </div>

  <!-- BOT√ìN CREAR -->
  <button id="btnNew" class="btn primary" style="margin-bottom:20px">
    + Nuevo producto
  </button>

  <!-- GRID -->
  <div id="productsGrid"></div>
</main>

<!-- MODAL CREAR / EDITAR -->
<div class="overlay" id="modalOverlay">
  <div class="modal">
    <h2 id="modalTitle">Nuevo producto</h2>

    <label>Nombre</label>
    <input id="prodName">

    <label>Precio</label>
    <input type="number" id="prodPrice">

    <label>Descripci√≥n</label>
    <textarea id="prodDesc"></textarea>

    <label>Categor√≠a</label>
    <select id="prodCategory">
      <option value="hamburguesas">Hamburguesas</option>
      <option value="bebidas">Bebidas</option>
      <option value="papas">Papas</option>
    </select>

    <label>Imagen</label>
    <input type="file" id="prodImg">
    <img id="preview" class="previewImg">

    <div class="modalActions">
      <button class="btnSmall" id="btnCancel">Cancelar</button>
      <button class="btn primary" id="btnSave">Guardar</button>
    </div>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* ============================
   CONFIG FIREBASE
============================= */
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

/* ============================
   VARIABLES
============================= */
let products = []; 
let categoriesState = {
  hamburguesas: true,
  bebidas: true,
  papas: true
};

let editingId = null;

/* ============================
   REFERENCIAS DOM
============================= */
const grid = document.getElementById("productsGrid");
const categoriesRow = document.getElementById("categoriesRow");
const modal = document.getElementById("modalOverlay");

const modalTitle = document.getElementById("modalTitle");
const prodName = document.getElementById("prodName");
const prodPrice = document.getElementById("prodPrice");
const prodDesc = document.getElementById("prodDesc");
const prodCategory = document.getElementById("prodCategory");
const prodImg = document.getElementById("prodImg");
const preview = document.getElementById("preview");

const btnNew = document.getElementById("btnNew");
const btnCancel = document.getElementById("btnCancel");
const btnSave = document.getElementById("btnSave");

/* ============================
   CATEGOR√çAS
============================= */
const CATEGORY_LIST = ["hamburguesas","bebidas","papas"];

function renderCategories(){
  categoriesRow.innerHTML = "";

  CATEGORY_LIST.forEach(cat => {
    const state = categoriesState[cat] ? "on" : "off";
    const active = categoriesState[cat] ? "active" : "";

    categoriesRow.innerHTML += `
      <div class="catBtn ${active} ${state}" data-cat="${cat}">
        <span style="text-transform:capitalize">${cat}</span>
        <div class="catToggle"></div>
      </div>`;
  });

  document.querySelectorAll(".catBtn").forEach(btn=>{
    btn.onclick = () => {
      const cat = btn.dataset.cat;
      categoriesState[cat] = !categoriesState[cat];
      saveCategoriesState();
      renderCategories();
      renderProducts();
    };
  });
}

async function saveCategoriesState(){
  await db.collection("config").doc("categories").set(categoriesState,{merge:true});
}

/* ============================
   CARGAR CATEGOR√çAS DESDE FIREBASE
============================= */
async function loadCategories(){
  const snap = await db.collection("config").doc("categories").get();
  if(snap.exists){
    const d = snap.data();
    categoriesState = {...categoriesState, ...d};
  }
  renderCategories();
}

/* ============================
   CARGAR PRODUCTOS
============================= */
function loadProductsRealtime(){
  db.collection("products")
    .orderBy("order","asc")
    .onSnapshot(snap=>{
      products = [];
      snap.forEach(doc=>{
        const d = doc.data();
        products.push({
          id: doc.id,
          ...d
        });
      });

      renderProducts();
    });
}

/* ============================
   RENDER MOSAICO
============================= */
function renderProducts(){
  grid.innerHTML = "";

  const filtered = products.filter(p => categoriesState[p.category] !== false);

  filtered.forEach(prod => {
    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute("draggable","true");
    card.dataset.id = prod.id;

    card.innerHTML = `
      <img src="${prod.img}" onerror="this.src='images/logo.png'">
      <div class="body">
        <h3>${prod.name}</h3>
        <div class="muted">${prod.desc || ""}</div>
        <div class="price">$${prod.price}</div>

        <div class="actions">
          <button class="btnSmall" onclick="openEdit('${prod.id}')">Editar</button>
          <button class="btnSmall del" onclick="deleteProduct('${prod.id}')">Borrar</button>
        </div>
      </div>
    `;

    addDragEvents(card);
    grid.appendChild(card);
  });
}

/* ============================
   DRAG & DROP
============================= */
let dragItem = null;

function addDragEvents(card){
  card.addEventListener("dragstart", ()=> {
    dragItem = card;
    card.classList.add("dragging");
  });
  card.addEventListener("dragend", ()=> {
    card.classList.remove("dragging");
    reorderProductsOnDrop();
  });

  card.addEventListener("dragover", (e)=>{
    e.preventDefault();
    const dragging = document.querySelector(".dragging");
    if(!dragging) return;

    const cards = [...grid.querySelectorAll(".card:not(.dragging)")];
    const after = cards.find(c => e.clientY < c.getBoundingClientRect().top + c.offsetHeight/2);

    if(after){
      grid.insertBefore(dragging, after);
    }else{
      grid.appendChild(dragging);
    }
  });
}

async function reorderProductsOnDrop(){
  const cards = [...grid.querySelectorAll(".card")];
  for(let i=0;i<cards.length;i++){
    const id = cards[i].dataset.id;
    await db.collection("products").doc(id).update({
      order: i
    });
  }
}

/* ============================
   MODAL
============================= */
function resetModal(){
  editingId = null;
  prodName.value = "";
  prodPrice.value = "";
  prodDesc.value = "";
  prodCategory.value = "hamburguesas";
  preview.src = "";
  prodImg.value = "";
}

btnNew.onclick = ()=>{
  resetModal();
  modalTitle.textContent = "Nuevo producto";
  modal.classList.add("open");
};

btnCancel.onclick = ()=> modal.classList.remove("open");

/* ============================
   EDITAR PRODUCTO
============================= */
function openEdit(id){
  const p = products.find(x=>x.id === id);
  if(!p) return;

  editingId = id;
  modalTitle.textContent = "Editar producto";
  prodName.value = p.name;
  prodPrice.value = p.price;
  prodDesc.value = p.desc || "";
  prodCategory.value = p.category;
  preview.src = p.img;

  modal.classList.add("open");
}

/* ============================
   SUBIR IMAGEN A STORAGE
============================= */
async function uploadImage(file){
  const path = `products/${Date.now()}_${file.name}`;
  const ref = storage.ref().child(path);
  const snap = await ref.put(file);
  return await snap.ref.getDownloadURL();
}

/* ============================
   GUARDAR PRODUCTO
============================= */
btnSave.onclick = async ()=>{

  const name = prodName.value.trim();
  const price = Number(prodPrice.value);
  const desc = prodDesc.value.trim();
  const category = prodCategory.value;

  if(!name || !price){
    alert("Nombre y precio obligatorios");
    return;
  }

  let imgURL = preview.src || "";

  if(prodImg.files.length > 0){
    imgURL = await uploadImage(prodImg.files[0]);
  }

  const data = {
    name,
    price,
    desc,
    category,
    img: imgURL,
  };

  if(editingId){
    await db.collection("products").doc(editingId).update(data);
  }else{
    const order = products.length;
    await db.collection("products").add({...data, order});
  }

  modal.classList.remove("open");
};

/* ============================
   BORRAR PRODUCTO
============================= */
async function deleteProduct(id){
  if(!confirm("¬øEliminar producto?")) return;
  await db.collection("products").doc(id).delete();
}

/* ============================
   PREVIEW DE IMAGEN
============================= */
prodImg.onchange = ()=>{
  if(prodImg.files.length > 0){
    preview.src = URL.createObjectURL(prodImg.files[0]);
  }
};

/* ============================
   INICIO
============================= */
loadCategories();
loadProductsRealtime();
renderCategories();

</script>
<!-- ============================
      PANEL DE CONFIGURACIONES
============================= -->
<hr style="margin:50px 0; opacity:0.3">

<h2>‚öôÔ∏è Configuraciones generales</h2>

<div id="configPanel" style="display:flex; flex-direction:column; gap:30px; max-width:700px">

  <!-- HORARIOS -->
  <div class="configCard">
    <h3>üïí Horarios del local</h3>
    <p class="muted">Configur√° los horarios normales de apertura del local para cada d√≠a.</p>

    <table style="width:100%; border-collapse:collapse; margin-top:10px">
      <thead>
        <tr>
          <th>D√≠a</th>
          <th>Apertura</th>
          <th>Cierre</th>
        </tr>
      </thead>
      <tbody id="openHoursTable"></tbody>
    </table>

    <button class="btn primary" id="saveHours">Guardar horarios</button>
  </div>

  <!-- FORCE OPEN -->
  <div class="configCard">
    <h3>üì¢ Forzar estado del local</h3>

    <label>
      <input type="checkbox" id="forceOpenChk">
      <strong>Forzar local abierto</strong>
    </label>

    <label>
      Mensaje opcional:
      <input type="text" id="forceMsg" placeholder="Ej: Hasta agotar stock, horario especial‚Ä¶">
    </label>

    <label>
      Forzar hasta:
      <input type="datetime-local" id="forceUntil">
    </label>

    <button class="btn primary" id="saveForceOpen">Guardar estado</button>
  </div>

  <!-- PAPAS -->
  <div class="configCard">
    <h3>üçü Disponibilidad de papas</h3>

    <label>
      <input type="checkbox" id="side_sazon"> Sazonadas
    </label>
    <label>
      <input type="checkbox" id="side_sal"> Con sal
    </label>
    <label>
      <input type="checkbox" id="side_sinsal"> Sin sal
    </label>

    <button class="btn primary" id="saveSides">Guardar variantes</button>
  </div>

  <!-- EXTRAS -->
  <div class="configCard">
    <h3>‚ûï Precios extras</h3>

    <label>
      Medall√≥n extra:
      <input type="number" id="extraPatty" min="0">
    </label>

    <label>
      Cheddar extra:
      <input type="number" id="extraCheddar" min="0">
    </label>

    <button class="btn primary" id="saveExtras">Guardar extras</button>
  </div>
</div>

<style>
.configCard {
  background:#fff;
  padding:20px;
  border-radius:18px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
  border:1px solid #eaeaea;
}
.configCard h3 {
  margin-top:0;
}
.configCard label {
  display:flex;
  flex-direction:column;
  margin-bottom:10px;
  font-weight:600;
}
.configCard input[type="checkbox"]{
  width:auto;
  margin-right:10px;
}
</style>

<script>
/* ============================================
   PARTE 3 ‚Äî FIREBASE CONFIGS
============================================ */

const DAYS = ["Domingo","Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado"];
let localHours = {};   // { 0: {open:"19:00", close:"23:00"} ... }

/* ================== CARGAR HORARIOS ================== */
async function loadHours(){
  const ref = db.collection("config").doc("store_hours");
  const snap = await ref.get();
  if(snap.exists){
    localHours = snap.data();
  } else {
    // si no existe, default
    localHours = {
      0:{open:"19:00", close:"23:59"},
      1:{open:"-", close:"-"},
      2:{open:"-", close:"-"},
      3:{open:"19:00", close:"23:59"},
      4:{open:"19:00", close:"23:59"},
      5:{open:"19:00", close:"23:59"},
      6:{open:"19:00", close:"23:59"},
    };
  }

  renderHoursTable();
}

function renderHoursTable(){
  const t = document.getElementById("openHoursTable");
  t.innerHTML = "";

  for(let d=0; d<7; d++){
    const row = localHours[d] || {open:"-", close:"-"};

    t.innerHTML += `
      <tr>
        <td>${DAYS[d]}</td>
        <td><input data-day="${d}" data-field="open" type="time" value="${row.open !== "-" ? row.open : ""}"></td>
        <td><input data-day="${d}" data-field="close" type="time" value="${row.close !== "-" ? row.close : ""}"></td>
      </tr>
    `;
  }
}

document.getElementById("saveHours").onclick = async ()=>{
  const rows = document.querySelectorAll('#openHoursTable input');

  rows.forEach(input=>{
    const day = input.dataset.day;
    const field = input.dataset.field;
    if(!localHours[day]) localHours[day] = {};
    localHours[day][field] = input.value || "-";
  });

  await db.collection("config").doc("store_hours").set(localHours,{merge:true});
  alert("Horarios guardados");
};

/* ================== FORZAR OPEN ================== */
async function loadForced(){
  const snap = await db.collection("config").doc("store").get();
  if(snap.exists){
    const d = snap.data();
    document.getElementById("forceOpenChk").checked = !!d.forceOpen;
    document.getElementById("forceMsg").value = d.forceOpenMessage || "";
    if(d.forceOpenUntil){
      const dt = d.forceOpenUntil.toDate ? d.forceOpenUntil.toDate() : new Date(d.forceOpenUntil);
      document.getElementById("forceUntil").value = dt.toISOString().slice(0,16);
    }
  }
}

document.getElementById("saveForceOpen").onclick = async ()=>{
  const chk = document.getElementById("forceOpenChk").checked;
  const msg = document.getElementById("forceMsg").value;
  const until = document.getElementById("forceUntil").value;

  const data = {
    forceOpen: chk,
    forceOpenMessage: msg,
    forceOpenUntil: until ? new Date(until) : null
  };

  await db.collection("config").doc("store").set(data,{merge:true});
  alert("Estado guardado");
};

/* ================== PAPAS ================== */
async function loadSides(){
  const snap = await db.collection("config").doc("sides").get();
  const d = snap.exists ? snap.data() : {};

  document.getElementById("side_sazon").checked = d.con_sazon !== false;
  document.getElementById("side_sal").checked = d.con_sal !== false;
  document.getElementById("side_sinsal").checked = d.sin_sal !== false;
}

document.getElementById("saveSides").onclick = async ()=>{
  const d = {
    con_sazon: document.getElementById("side_sazon").checked,
    con_sal:   document.getElementById("side_sal").checked,
    sin_sal:   document.getElementById("side_sinsal").checked
  };

  await db.collection("config").doc("sides").set(d,{merge:true});
  alert("Variantes guardadas");
};

/* ================== EXTRAS ================== */
async function loadExtras(){
  const snap = await db.collection("config").doc("extras").get();
  const d = snap.exists ? snap.data() : {};

  document.getElementById("extraPatty").value = d.price_paty || 0;
  document.getElementById("extraCheddar").value = d.price_cheddar || 0;
}

document.getElementById("saveExtras").onclick = async ()=>{
  const d = {
    price_paty: Number(document.getElementById("extraPatty").value),
    price_cheddar: Number(document.getElementById("extraCheddar").value),
  };

  await db.collection("config").doc("extras").set(d,{merge:true});
  alert("Extras guardados");
};

/* ================== INIT ================== */
loadHours();
loadForced();
loadSides();
loadExtras();
</script>
