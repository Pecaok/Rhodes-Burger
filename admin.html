<!doctype html>
<html lang="es">

<script>
const TTL_HOURS = 20;
const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

function sessionValid(){
  const ok = localStorage.getItem('rb_admin_ok') === 'true';
  const ts = Number(localStorage.getItem('rb_admin_t') || 0);
  return ok && (Date.now() - ts) < TTL_MS;
}
function bumpSession(){
  if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
}
function logout(){
  localStorage.removeItem('rb_admin_ok');
  localStorage.removeItem('rb_admin_t');
  location.replace('login.html');
}
(function requireSession(){
  if (!sessionValid()){
    location.replace('login.html');
  } else bumpSession();
})();
['click','keydown','focus','mousemove','touchstart','scroll']
  .forEach(e => window.addEventListener(e, bumpSession, {passive:true}));
</script>

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Ä¢ Rhodes Burgers</title>
<link rel="icon" href="images/logo.png" />

<style>
/* ... (ESTILOS ANTERIORES IGUALES) ... */
:root{ --primary: #625A45; --text: #111; --muted: #666; --bg: #f8f9fa; --card: #ffffff; --ring: #e0e0e0; --shadow: 0 4px 20px rgba(0,0,0,0.05); --header-h: 70px; --good: #2e7d32; --warn: #f57c00; --bad: #d32f2f; --radius: 16px; }
*{box-sizing:border-box}
html,body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif; }

/* HEADER */
header { position: sticky; top: 0; z-index: 100; background: #fff; height: var(--header-h); border-bottom: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
.topbar { max-width: 1200px; margin: 0 auto; height: 100%; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
.brand { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--text); font-weight: 800; font-size: 18px; }
.brand img { width: 38px; height: 38px; border-radius: 8px; object-fit: cover; }
.nav-right { display: flex; align-items: center; gap: 8px; }
.nav-link { text-decoration: none; color: var(--muted); font-weight: 600; font-size: 14px; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; }
.nav-link:hover { background: #f0f0f0; color: var(--text); }
.nav-link.active { background: var(--bg); color: var(--text); box-shadow: inset 0 0 0 1px #eee; }
.btn-logout { background: #ffebee; color: var(--bad); border: 1px solid #ffcdd2; padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 13px; margin-left: 10px; }

/* MAIN & CARDS */
main { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; gap: 24px; }
.card { background: var(--card); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--ring); }
.card.featured { border: 2px solid var(--primary); background: #fffcf8; }

/* COMPONENTS */
.pill { padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 800; text-transform: uppercase; }
.pill.ok { background: #e8f5e9; color: var(--good); border: 1px solid #c8e6c9; }
.pill.off { background: #f5f5f5; color: #777; border: 1px solid #e0e0e0; }
.pill.blue { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }

.mini-btn { border: none; padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
.mini-btn:hover { opacity: 0.9; }
.mini-btn.good { background: var(--good); color: white; }
.mini-btn.bad { background: #ffebee; color: var(--bad); border:1px solid #ffcdd2; }
.mini-btn.primary { background: var(--primary); color: white; }

.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 20px; }
label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 700; color: #444; }
input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--ring); background: #fff; font-size: 14px; font-family: inherit; }
.check-row { display: flex; align-items: center; gap: 8px; background: #f9f9f9; padding: 8px 12px; border-radius: 8px; border: 1px solid #eee; cursor: pointer; font-size: 13px; font-weight: 600; }
.check-row input { width: auto; margin: 0; cursor: pointer; accent-color: var(--primary); }

.row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 18px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.2s; }
.btn.primary { background: var(--primary); color: #fff; }
.btn.good { background: #e8f5e9; color: var(--good); border-color: #c8e6c9; }
.btn.warn { background: #fff3e0; color: #e65100; border-color: #ffe0b2; }
.btn.bad { background: #ffebee; color: var(--bad); border-color: #ffcdd2; }

/* Switch */
.switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--bad); } /* Rojo para cerrado */
input:checked + .slider:before { transform: translateX(20px); }

/* Table */
.table-container { overflow-x: auto; margin-top: 15px; }
table { width: 100%; border-collapse: collapse; min-width: 600px; }
th { text-align: left; padding: 12px; font-size: 12px; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid #eee; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 14px; }
.img-preview { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; }

h2 { font-size: 20px; margin: 0 0 10px 0; color: var(--text); }
.muted { color: var(--muted); }
.text-small { font-size: 13px; }

/* Drag Grid & Tile */
#orderGrid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap: 16px; margin-top: 20px; }
.orderCard { background: #fff; border: 1px solid #eee; border-radius: 12px; overflow: hidden; cursor: grab; transition: transform 0.2s; }
.orderCard:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.orderCard.dragging { opacity: 0.5; border: 2px dashed var(--primary); }

.tile { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border-bottom: 1px solid #eee; }
.side-pill { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: #fff; border-radius: 10px; border: 1px solid #eee; }
.side-pill.off { opacity: 0.6; background: #f5f5f5; }

@media (max-width: 900px) {
  .topbar { padding: 0 15px; }
  .nav-right { display: none; } 
}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#">
      <img src="images/logo.png" alt="Logo">
      <span>Rhodes Admin</span>
    </a>
    <nav class="nav-right">
      <a class="nav-link active" href="admin.html">Admin</a>
      <a class="nav-link" href="stock.html">Stock</a>
      <a class="nav-link" href="finanzas.html">Finanzas</a>
      <a class="nav-link" href="pedido_local.html">Pedidos</a>
      <a class="nav-link" href="mostrador.html">Mostrador</a>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </nav>
  </div>
</header>

<main>

<section class="card" style="border-left: 4px solid var(--primary);">
  <h2>Estado de la Tienda</h2>
  
  <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <strong>üïë Apertura / Cierre Manual</strong>
          <div id="storePill" class="pill off">AUTO</div>
      </div>
      <div style="display:flex; gap:10px;">
          <button class="mini-btn good" id="btnForceOpen">Forzar Abierto</button>
          <button class="mini-btn bad" id="btnForceClose">Forzar Cerrado</button>
      </div>
  </div>

  <div style="border:1px solid #ffcdd2; background:#fff5f5; padding:15px; border-radius:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <strong style="color:var(--bad)">‚õî Cierre Total (Cartel Pantalla Completa)</strong>
          <label class="switch">
              <input type="checkbox" id="swFullClose">
              <span class="slider"></span>
          </label>
      </div>
      <p class="muted" style="font-size:12px; margin-bottom:10px;">Activa esto para vacaciones o mantenimiento. Tapa toda la web.</p>
      
      <div class="form-grid">
          <div>
              <label>Mensaje del Cartel</label>
              <input type="text" id="inpCloseMsg" placeholder="Ej: Cerrado por Vacaciones üå¥">
          </div>
          <div>
              <label>Imagen de Fondo/Cartel</label>
              <input type="file" id="inpCloseImgFile" accept="image/*">
              <input type="hidden" id="inpCloseImgUrl"> </div>
      </div>
      <button class="btn bad" style="width:100%" onclick="saveFullCloseConfig()">Guardar Configuraci√≥n de Cierre</button>
  </div>
</section>

<section class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Configuraci√≥n de Precios (Extras)</h2>
        <div class="pill blue">Globales</div>
    </div>
    <div class="form-grid" style="grid-template-columns: 1fr 1fr auto; margin-top:15px">
        <div><label>Carne ($)</label><input id="pricePatty" type="number"></div>
        <div><label>Cheddar ($)</label><input id="priceCheddar" type="number"></div>
        <div style="display:flex; align-items:flex-end;"><button id="btnSaveExtras" class="btn primary">Guardar</button></div>
    </div>
</section>

<section class="card featured">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
    <h2>Gesti√≥n de Productos</h2>
    <div class="pill off" style="font-weight:normal; background:#fff; border:1px solid #ddd">Modo Editor</div>
  </div>
  
  <div class="form-grid">
    <div><label>ID</label><input id="prdId" type="text" placeholder="Ej: burger_doble"></div>
    <div><label>Nombre</label><input id="prdName" type="text"></div>
    <div><label>Categor√≠a</label>
      <select id="prdCategory">
        <option value="hamburguesas">Hamburguesas</option>
        <option value="bebidas">Bebidas</option>
        <option value="guarniciones">Guarniciones</option>
      </select>
    </div>
    <div><label>Precio</label><input id="prdPrice" type="number"></div>
    <div><label>Imagen</label><input id="prdImg" type="text" placeholder="URL"><input id="prdImgFile" type="file" accept="image/*" style="margin-top:5px"></div>
    <div>
        <label>Extras</label>
        <div style="display:flex; gap:10px; margin-top:5px">
            <label class="check-row"><input type="checkbox" id="prdExPatty"> ü•©</label>
            <label class="check-row"><input type="checkbox" id="prdExCheddar"> üßÄ</label>
        </div>
    </div>
    <div style="grid-column:1/-1"><label>Descripci√≥n</label><textarea id="prdDesc" rows="2"></textarea></div>
  </div>

  <div class="row">
    <button class="btn primary" id="btnSaveProduct">Guardar / Actualizar</button>
    <button class="btn bad" id="btnClearProduct" style="background:transparent; color:#d32f2f; border:1px solid #ffcdd2">Limpiar</button>
  </div>

  <div style="height:1px; background:#eee; margin:25px 0"></div>

  <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap">
      <input type="text" id="prdSearch" style="flex:1; min-width:200px" placeholder="üîç Buscar...">
      <select id="prdFilterCat" style="width:auto"><option value="all">Todas</option><option value="hamburguesas">Burgers</option><option value="bebidas">Bebidas</option><option value="guarniciones">Papas</option></select>
  </div>

  <div class="table-container">
    <table>
      <thead><tr><th>ID</th><th>IMG</th><th>Nombre</th><th>Precio</th><th>Estado</th><th>Acciones</th></tr></thead>
      <tbody id="prdTable"></tbody>
    </table>
  </div>
</section>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:24px;">

  <section class="card">
    <h2>Orden Visual</h2>
    <div class="row" id="orderCatButtons" style="margin-bottom:15px; background:#f5f5f5; padding:4px; border-radius:10px; display:inline-flex;">
      <button class="mini-btn primary" data-cat="hamburguesas">Burgers</button>
      <button class="mini-btn" data-cat="bebidas" style="color:#555; background:transparent">Bebidas</button>
      <button class="mini-btn" data-cat="guarniciones" style="color:#555; background:transparent">Papas</button>
    </div>
    <div id="orderGrid"></div>
    <div style="margin-top:20px; text-align:right"><button class="btn primary" id="btnSaveOrder">Guardar Orden</button></div>
  </section>

  <section class="card">
    <h2>Control Stock R√°pido</h2>
    <div id="invList" style="border:1px solid #eee; border-radius:12px; overflow:hidden;"></div>
  </section>

</div>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:24px;">

  <section class="card">
    <h2>Configuraci√≥n de Papas</h2>
    <div id="sidesContainer"></div>
  </section>

  <section class="card">
    <h2>Cupones</h2>
    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
      <div><label>C√≥digo</label><input id="cpCode" type="text" style="text-transform:uppercase"></div>
      <div><label>Monto ($)</label><input id="cpValue" type="number"></div>
    </div>
    <button class="btn primary" id="btnCreateCp" style="width:100%">Crear Cup√≥n</button>
    <div class="table-container">
      <table><thead><tr><th>C√≥digo</th><th>Valor</th><th>Estado</th><th>Acci√≥n</th></tr></thead><tbody id="cpTable"></tbody></table>
    </div>
  </section>

</div>

</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// --- VARS GLOBALES ---
let editingProductImg = null;
let ALL_PRODUCTS_DATA = []; 
let FILTER_CAT = "all";
let FILTER_TXT = "";
let ORDER_PRODUCTS = [];
let CURRENT_CAT = "hamburguesas";
let MENU_ORDER = {};
let STORE_CONFIG = {};

// --- FIREBASE INIT ---
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
try{ firebase.initializeApp(firebaseConfig); } catch(e){}
const db = firebase.firestore();
const productsCol = db.collection('products');

// --- HELPERS ---
const $ = s => document.querySelector(s);
async function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// --- 1. STORE CONFIG & CIERRE TOTAL ---
db.collection("config").doc("store").onSnapshot(doc => {
    STORE_CONFIG = doc.data() || {};
    applyStoreUI();
});

function applyStoreUI() {
    // Apertura normal
    const open = !!STORE_CONFIG.forceOpen;
    const pill = $('#storePill');
    if (open) {
        pill.className = "pill ok"; pill.textContent = "ABIERTO (Forzado)";
    } else {
        pill.className = "pill off"; pill.textContent = "CERRADO / AUTO";
    }

    // Cierre Total
    $('#swFullClose').checked = !!STORE_CONFIG.forceClose;
    if(document.activeElement !== $('#inpCloseMsg')) $('#inpCloseMsg').value = STORE_CONFIG.closedMessage || '';
    $('#inpCloseImgUrl').value = STORE_CONFIG.closedImage || '';
}

$('#btnForceOpen').onclick = async () => {
    await db.collection("config").doc("store").set({ forceOpen: true }, {merge:true});
};
$('#btnForceClose').onclick = async () => {
    await db.collection("config").doc("store").set({ forceOpen: false }, {merge:true});
};

window.saveFullCloseConfig = async () => {
    const isClosed = $('#swFullClose').checked;
    const msg = $('#inpCloseMsg').value;
    const file = $('#inpCloseImgFile').files[0];
    
    let imgBase64 = $('#inpCloseImgUrl').value;
    if(file) imgBase64 = await fileToBase64(file);

    await db.collection("config").doc("store").set({
        forceClose: isClosed,
        closedMessage: msg,
        closedImage: imgBase64
    }, {merge:true});
    
    alert("‚úÖ Configuraci√≥n de cierre guardada.");
};

// --- 2. PRECIOS EXTRAS ---
const pricesRef = db.collection("config").doc("prices");
pricesRef.onSnapshot(doc => {
    const d = doc.data() || {};
    if(document.activeElement !== $('#pricePatty')) $('#pricePatty').value = d.patty || 2500;
    if(document.activeElement !== $('#priceCheddar')) $('#priceCheddar').value = d.cheddar || 300;
});
$('#btnSaveExtras').onclick = async () => {
    await pricesRef.set({
        patty: Number($('#pricePatty').value),
        cheddar: Number($('#priceCheddar').value)
    }, {merge:true});
    alert("‚úÖ Precios actualizados");
};

// --- 3. PRODUCTOS ---
async function saveProduct(){
    const id = $('#prdId').value.trim();
    const name = $('#prdName').value.trim();
    const cat = $('#prdCategory').value;
    const price = Number($('#prdPrice').value);
    
    if(!id || !name || price <= 0) return alert("Datos incompletos");

    let img = $('#prdImg').value;
    const file = $('#prdImgFile').files[0];
    if(file) img = await fileToBase64(file);
    else if(editingProductImg && !img) img = editingProductImg;

    await productsCol.doc(id).set({
        name, category:cat, price, img,
        description: $('#prdDesc').value,
        allowedExtras: {
            patty: $('#prdExPatty').checked,
            cheddar: $('#prdExCheddar').checked
        },
        available: true,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
    
    alert("Producto guardado");
    clearForm();
}

function clearForm(){
    $('#prdId').value=''; $('#prdName').value=''; $('#prdPrice').value=''; 
    $('#prdImg').value=''; $('#prdImgFile').value=''; $('#prdDesc').value='';
    $('#prdExPatty').checked=false; $('#prdExCheddar').checked=false;
    editingProductImg=null;
}

function loadForm(p, id){
    $('#prdId').value=id; $('#prdName').value=p.name; $('#prdCategory').value=p.category;
    $('#prdPrice').value=p.price; $('#prdDesc').value=p.description||'';
    editingProductImg=p.img;
    $('#prdExPatty').checked=p.allowedExtras?.patty;
    $('#prdExCheddar').checked=p.allowedExtras?.cheddar;
    window.scrollTo({top:0,behavior:'smooth'});
}

async function deleteProduct(id){
    if(confirm("¬øEliminar "+id+"?")) await productsCol.doc(id).delete();
}

async function toggleAvail(id, current){
    await productsCol.doc(id).update({available: !current});
}

// Render Products Table
productsCol.onSnapshot(snap => {
    ALL_PRODUCTS_DATA = snap.docs.map(d=>({id:d.id, ...d.data()}));
    renderInventory(ALL_PRODUCTS_DATA); // Update fast stock list too
    renderTable();
});

function renderTable(){
    const tbody = $('#prdTable');
    tbody.innerHTML = '';
    const filtered = ALL_PRODUCTS_DATA.filter(p => {
        const matchCat = FILTER_CAT==='all' || p.category===FILTER_CAT;
        const matchTxt = !FILTER_TXT || p.name.toLowerCase().includes(FILTER_TXT.toLowerCase());
        return matchCat && matchTxt;
    });

    filtered.forEach(p => {
        const tr = document.createElement('tr');
        const imgHTML = p.img ? `<img src="${p.img}" class="img-preview">` : '';
        const badge = p.available!==false ? `<span class="pill ok">ON</span>` : `<span class="pill off">OFF</span>`;
        
        tr.innerHTML = `
            <td><b>${p.id}</b></td>
            <td>${imgHTML}</td>
            <td>${p.name}</td>
            <td>$${p.price}</td>
            <td>${badge}</td>
            <td class="row">
                <button class="mini-btn good" onclick="editPrd('${p.id}')">‚úèÔ∏è</button>
                <button class="mini-btn warn" onclick="togglePrd('${p.id}', ${p.available!==false})">üëÅÔ∏è</button>
                <button class="mini-btn bad" onclick="delPrd('${p.id}')">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Global scope helpers for onclick
window.editPrd = (id) => loadForm(ALL_PRODUCTS_DATA.find(p=>p.id===id), id);
window.togglePrd = (id, st) => toggleAvail(id, st);
window.delPrd = (id) => deleteProduct(id);

$('#btnSaveProduct').onclick = saveProduct;
$('#btnClearProduct').onclick = clearForm;
$('#prdSearch').oninput = (e) => { FILTER_TXT = e.target.value; renderTable(); };
$('#prdFilterCat').onchange = (e) => { FILTER_CAT = e.target.value; renderTable(); };

// --- 4. ORDEN VISUAL ---
db.collection("config").doc("menuOrder").onSnapshot(s => {
    MENU_ORDER = s.exists ? s.data() : {};
    renderOrderGrid();
});

function renderOrderGrid(){
    const grid = $('#orderGrid');
    grid.innerHTML = '';
    const list = ALL_PRODUCTS_DATA.filter(p=>p.category === CURRENT_CAT);
    const order = MENU_ORDER[CURRENT_CAT] || [];
    
    list.sort((a,b)=>{
        const ia = order.indexOf(a.id); const ib = order.indexOf(b.id);
        if(ia===-1) return 1; if(ib===-1) return -1;
        return ia - ib;
    });

    list.forEach(p => {
        const d = document.createElement('div');
        d.className = 'orderCard';
        d.draggable = true;
        d.dataset.id = p.id;
        d.innerHTML = `<div style="padding:10px; font-size:12px; font-weight:bold; text-align:center">${p.name}</div>`;
        
        d.addEventListener('dragstart', () => d.classList.add('dragging'));
        d.addEventListener('dragend', () => d.classList.remove('dragging'));
        grid.appendChild(d);
    });
}
$('#orderGrid').addEventListener('dragover', e => {
    e.preventDefault();
    const dragging = document.querySelector('.dragging');
    const siblings = [...document.querySelectorAll('.orderCard:not(.dragging)')];
    const next = siblings.find(s => e.clientY <= s.getBoundingClientRect().top + s.offsetHeight/2);
    $('#orderGrid').insertBefore(dragging, next);
});
$('#btnSaveOrder').onclick = async () => {
    const ids = [...document.querySelectorAll('.orderCard')].map(c => c.dataset.id);
    await db.collection("config").doc("menuOrder").set({[CURRENT_CAT]: ids}, {merge:true});
    alert("Orden guardada");
};
document.querySelectorAll('#orderCatButtons button').forEach(btn => {
    btn.onclick = () => {
        CURRENT_CAT = btn.dataset.cat;
        document.querySelectorAll('#orderCatButtons button').forEach(b=>b.style.opacity=0.6);
        btn.style.opacity=1;
        renderOrderGrid();
    }
});

// --- 5. STOCK R√ÅPIDO & PAPAS & CUPONES ---
function renderInventory(list){
    const c = $('#invList');
    c.innerHTML = '';
    list.forEach(p => {
        const on = p.available!==false;
        const d = document.createElement('div');
        d.className = 'tile';
        d.innerHTML = `<span>${p.name}</span> <button class="mini-btn ${on?'bad':'good'}" onclick="togglePrd('${p.id}', ${on})">${on?'Quitar':'Poner'}</button>`;
        c.appendChild(d);
    });
}

// Papas
const sidesRef = db.collection("config").doc("sides");
sidesRef.onSnapshot(doc => {
    const d = doc.data() || {};
    const c = $('#sidesContainer');
    c.innerHTML = '';
    const map = {con_sazon:"Sazonadas", con_sal:"Con Sal", sin_sal:"Sin Sal"};
    for(const [k, label] of Object.entries(map)){
        const on = d[k] !== false;
        c.innerHTML += `<div class="side-pill ${on?'':'off'}">
            <b>${label}</b>
            <button class="mini-btn ${on?'bad':'good'}" onclick="toggleSide('${k}', ${on})">${on?'Desactivar':'Activar'}</button>
        </div>`;
    }
});
window.toggleSide = async (k, current) => {
    await sidesRef.set({[k]: !current}, {merge:true});
}

// Cupones
db.collection("coupons").onSnapshot(snap => {
    const t = $('#cpTable');
    t.innerHTML = '';
    snap.forEach(doc => {
        const c = doc.data();
        t.innerHTML += `<tr>
            <td>${c.code}</td><td>$${c.amount}</td>
            <td><span class="pill ${c.active?'ok':'off'}">${c.active?'ON':'OFF'}</span></td>
            <td>
                <button class="mini-btn warn" onclick="toggleCoupon('${doc.id}', ${c.active})">I/O</button>
                <button class="mini-btn bad" onclick="delCoupon('${doc.id}')">X</button>
            </td>
        </tr>`;
    });
});
$('#btnCreateCp').onclick = async () => {
    const code = $('#cpCode').value.toUpperCase();
    const amount = Number($('#cpValue').value);
    if(!code || !amount) return alert("Faltan datos");
    await db.collection("coupons").add({code, amount, active:true});
    $('#cpCode').value=''; $('#cpValue').value='';
};
window.toggleCoupon = async (id, st) => await db.collection("coupons").doc(id).update({active:!st});
window.delCoupon = async (id) => { if(confirm("Borrar?")) await db.collection("coupons").doc(id).delete(); };

</script>
</body>
</html>
