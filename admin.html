<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 10px 30px rgba(0,0,0,.08); --radius:18px;
      --ok:#2e7d32; --warn:#fb8c00; --danger:#d32f2f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}

    .container{max-width:1100px;margin:24px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}
    h2{font-size:20px;margin:18px 0 10px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:18px}

    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:8px 12px;background:#fff;font-weight:700}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--ring);border-radius:14px;background:#fff;padding:10px 12px}
    .item .name{font-weight:700}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:var(--primary)}

    .ok{color:var(--ok)}
    .warn{color:var(--warn)}
    .danger{color:var(--danger)}
  </style>
</head>
<body>
  <script>
    /* Guard r√°pido: ?auth=1 refresca credencial local por ~20h */
    (function guard(){
      const TTL_MS = 20*60*60*1000;
      const qs = new URLSearchParams(location.search);
      if (qs.get('auth')==='1') {
        try{
          const now = Date.now();
          localStorage.setItem('rb_admin_ok','true');
          localStorage.setItem('rb_admin_t', String(now));
          localStorage.setItem('rb_auth_v2','ok');
          sessionStorage.setItem('rb_auth_v2','ok');
        }catch(_){}
        try{ history.replaceState(null,'',location.pathname); }catch(_){}
      }
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      const live = (Date.now()-ts) < TTL_MS;
      if (!(ok && live)){
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=guard&next='+next);
        return;
      }
      try{ localStorage.setItem('rb_admin_t', String(Date.now())); }catch(_){}
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Admin</a>
      <div class="spacer"></div>

      <!-- Navegaci√≥n cruzada -->
      <a href="pedido_local.html" class="btn" title="Ver pedidos">üì¶ Pedidos</a>
      <a href="finanzas.html" class="btn" title="Ver finanzas">üìà Finanzas</a>
      <a href="admin.html" class="btn primary" title="Admin (est√°s aqu√≠)">‚öôÔ∏è Admin</a>
      <a href="mostrador.html" class="btn" title="Abrir mostrador">üßæ Mostrador</a>

      <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <h1>Panel de administraci√≥n</h1>

    <!-- Estado del local -->
    <section class="card">
      <h2>Estado del local</h2>
      <div class="row">
        <span id="openBadge" class="pill muted">Cargando‚Ä¶</span>
        <button id="btnOpen" class="btn">üü¢ Abrir</button>
        <button id="btnClose" class="btn">üî¥ Cerrar</button>
        <span id="openMsg" class="muted"></span>
      </div>
      <div class="muted" style="margin-top:8px">Este estado lo usa <strong>index.html</strong> para mostrar Abierto/Cerrado y habilitar el pago.</div>
    </section>

    <!-- Disponibilidad de items -->
    <section class="card">
      <h2>Disponibilidad de √≠tems</h2>
      <div class="muted" style="margin-bottom:8px">Desactivalos cuando no haya stock. Impacta en <strong>index</strong> y <strong>mostrador</strong> (oculta/bloquea el bot√≥n).</div>
      <div id="itemsGrid" class="grid"></div>
      <div id="itemsMsg" class="muted" style="margin-top:8px"></div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(_){}
    const db = firebase.firestore();

    const $ = s=>document.querySelector(s);

    // Dataset (IDs deben coincidir con index/mostrador)
    const BURGERS = [
      { id:"bigjohn_simple", name:"Big John Simple" },
      { id:"bigjohn_doble",  name:"Big John Doble"  },
      { id:"burguesa_simple", name:"Burguesa Simple" },
      { id:"burguesa_doble",  name:"Burguesa Doble"  },
      { id:"cheesebacon_spl", name:"CheeseBacon Simple" },
      { id:"cheesebacon_dbl", name:"CheeseBacon Doble"  },
      { id:"cheese_simple",   name:"Cheeseburger Simple" },
      { id:"cheese_doble",    name:"Cheeseburger Doble"  },
      { id:"rhodes_simple",   name:"Rhodes Simple" },
      { id:"rhodes_doble",    name:"Rhodes Doble"  },
      { id:"morgan_simple",   name:"Morgan Simple" },
      { id:"morgan_doble",    name:"Morgan Doble"  },
      { id:"pollo_crispy",    name:"Pollo Crispy"  }
    ];
    const DRINKS = [
      { id:"coca_org",   name:"Coca-Cola Original 500ml" },
      { id:"coca_zero",  name:"Coca-Cola Zero 500ml"     },
      { id:"sprite",     name:"Sprite 500ml"             },
      { id:"aquarius_pera",   name:"Aquarius Pera 500ml"   },
      { id:"aquarius_pomelo", name:"Aquarius Pomelo 500ml" }
    ];

    /* ==================== Logout ==================== */
    const btnLogout = $("#btnLogout");
    if(btnLogout){
      btnLogout.onclick = ()=>{
        localStorage.removeItem('rb_auth_v2');
        localStorage.removeItem('rb_admin_ok');
        localStorage.removeItem('rb_admin_t');
        sessionStorage.removeItem('rb_auth_v2');
        location.replace('login.html?reason=logout&next=pedido_local.html');
      };
    }

    /* ==================== Abrir/Cerrar ==================== */
    const openDocRef = db.collection('settings').doc('open_state');
    async function setOpenState(isOpen){
      try{
        await openDocRef.set({
          isOpen: !!isOpen,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      }catch(e){
        console.error(e);
        $("#openMsg").textContent = "No se pudo actualizar el estado.";
        return;
      }
    }
    function updateOpenUI(d){
      const badge = $("#openBadge");
      if(!d){ badge.textContent = "‚Äî"; badge.className="pill muted"; return; }
      const isOpen = !!d.isOpen;
      badge.textContent = isOpen ? "ABIERTO" : "CERRADO";
      badge.className = "pill " + (isOpen ? "ok" : "danger");
      $("#openMsg").textContent = d.updatedAt ? ("Actualizado: " + (d.updatedAt.toDate? d.updatedAt.toDate().toLocaleString('es-AR') : '')) : '';
    }
    $("#btnOpen").onclick = ()=> setOpenState(true);
    $("#btnClose").onclick = ()=> setOpenState(false);
    openDocRef.onSnapshot(s=> updateOpenUI(s.data()));

    /* ==================== Men√∫: desactivar √≠tems ==================== */
    const flagsDocRef = db.collection('settings').doc('menu_flags');

    // Pintar grilla
    function renderItems(flags){
      const disabled = (flags && flags.disabled) || {};
      const items = [
        {title:"Hamburguesas", list: BURGERS},
        {title:"Bebidas",      list: DRINKS}
      ];

      const host = $("#itemsGrid");
      host.innerHTML = items.map(group=>{
        const inner = group.list.map(it=>{
          const off = !!disabled[it.id];
          return `
            <div class="item" data-id="${it.id}">
              <div class="name">${it.name}</div>
              <label class="switch">
                <input type="checkbox" ${off?'':'checked'}>
                <span>${off?'Agotado':'Disponible'}</span>
              </label>
            </div>`;
        }).join('');
        return `<div class="card" style="grid-column:1/-1"><strong>${group.title}</strong><div class="grid" style="margin-top:8px">${inner}</div></div>`;
      }).join('');

      host.querySelectorAll('.item input[type="checkbox"]').forEach(inp=>{
        inp.addEventListener('change', async (ev)=>{
          const card = ev.target.closest('.item');
          const id   = card.dataset.id;
          const available = ev.target.checked; // true => Disponible
          try{
            const snap = await flagsDocRef.get();
            const cur  = snap.exists ? (snap.data().disabled || {}) : {};
            if(available){ delete cur[id]; } else { cur[id] = true; }
            await flagsDocRef.set({ disabled: cur, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
            card.querySelector('span').textContent = available? 'Disponible' : 'Agotado';
            $("#itemsMsg").textContent = "Guardado.";
            setTimeout(()=> $("#itemsMsg").textContent="", 1400);
          }catch(e){
            console.error(e);
            $("#itemsMsg").textContent = "No se pudo guardar. Reintent√°.";
          }
        });
      });
    }

    flagsDocRef.onSnapshot(snap=>{
      renderItems(snap.exists ? snap.data() : {disabled:{}});
    });
  </script>
</body>
</html>
