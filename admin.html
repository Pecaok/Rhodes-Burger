<!doctype html>
<html lang="es">

<script>
const TTL_HOURS = 20;
const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

function sessionValid(){
  const ok = localStorage.getItem('rb_admin_ok') === 'true';
  const ts = Number(localStorage.getItem('rb_admin_t') || 0);
  return ok && (Date.now() - ts) < TTL_MS;
}
function bumpSession(){
  if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
}
function logout(){
  localStorage.removeItem('rb_admin_ok');
  localStorage.removeItem('rb_admin_t');
  localStorage.removeItem('rb_auth_v2');
  sessionStorage.removeItem('rb_auth_v2');
  location.replace('login.html');
}
(function requireSession(){
  if (!sessionValid()){
    const next = encodeURIComponent(
      (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
      (location.search || '') + (location.hash || '')
    );
    location.replace('login.html?next=' + next);
  } else bumpSession();
})();
['click','keydown','focus','mousemove','touchstart','scroll']
  .forEach(e => window.addEventListener(e, bumpSession, {passive:true}));
</script>

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stock • Rhodes Burgers</title>
<link rel="icon" href="images/logo.png" />

<style>
/* ============================================================
   ESTILOS GLOBALES
=============================================================== */
:root{
  --primary: #625A45; 
  --text: #111; 
  --muted: #666; 
  --bg: #f8f9fa; 
  --card: #ffffff; 
  --ring: #e0e0e0; 
  --shadow: 0 4px 20px rgba(0,0,0,0.05);
  --header-h: 70px;
  --good: #2e7d32; 
  --warn: #f57c00; 
  --bad: #d32f2f; 
  --radius: 16px;
}
*{box-sizing:border-box}

html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  -webkit-font-smoothing: antialiased;
}

/* ============================================================
   HEADER (LIMPIO - IGUAL A FINANZAS)
=============================================================== */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: #fff;
  height: var(--header-h);
  border-bottom: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 2px 10px rgba(0,0,0,0.03);
}

.topbar {
  max-width: 1200px;
  margin: 0 auto;
  height: 100%;
  padding: 0 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
  text-decoration: none;
  color: var(--text);
  font-weight: 800;
  font-size: 18px;
  letter-spacing: -0.5px;
}
.brand img {
  width: 38px;
  height: 38px;
  border-radius: 8px;
  object-fit: cover;
}

/* NAVEGACIÓN PRINCIPAL */
.nav-right {
  display: flex;
  align-items: center;
  gap: 8px;
}
.nav-link {
  text-decoration: none;
  color: var(--muted);
  font-weight: 600;
  font-size: 14px;
  padding: 8px 12px;
  border-radius: 8px;
  transition: all 0.2s;
}
.nav-link:hover { background: #f0f0f0; color: var(--text); }
.nav-link.active { background: var(--bg); color: var(--text); box-shadow: inset 0 0 0 1px #eee; }

.btn-logout {
  background: #ffebee;
  color: var(--bad);
  border: 1px solid #ffcdd2;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  font-size: 13px;
  margin-left: 10px;
  transition: 0.2s;
}
.btn-logout:hover { background: #ffcdd2; }

/* ============================================================
   MAIN & CARDS
=============================================================== */
main {
  max-width: 1200px;
  margin: 30px auto;
  padding: 0 20px;
  display: grid;
  gap: 24px;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--ring);
}
.card.featured {
  border: 2px solid var(--primary);
  background: #fffcf8;
}

/* ESTILOS DE CONTROL DE TIENDA (Moved here) */
.store-bar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
}
.pill {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.pill.ok { background: #e8f5e9; color: var(--good); border: 1px solid #c8e6c9; }
.pill.off { background: #f5f5f5; color: #777; border: 1px solid #e0e0e0; }

.mini-btn {
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.2s;
}
.mini-btn:hover { opacity: 0.9; }
.mini-btn.good { background: var(--good); color: white; }
.mini-btn.bad { background: #ffebee; color: var(--bad); border:1px solid #ffcdd2; }
.mini-btn.primary { background: var(--primary); color: white; }

/* Form Elements */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}
label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 700; color: #444; }
input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--ring);
  background: #fff;
  font-size: 14px;
  font-family: inherit;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(98,90,69, 0.1);
}

.row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 18px;
  border-radius: 10px;
  border: 1px solid transparent;
  cursor: pointer;
  font-weight: 700;
  font-size: 14px;
  transition: all 0.2s;
}
.btn.primary { background: var(--primary); color: #fff; }
.btn.good { background: #e8f5e9; color: var(--good); border-color: #c8e6c9; }
.btn.warn { background: #fff3e0; color: #e65100; border-color: #ffe0b2; }
.btn.bad { background: #ffebee; color: var(--bad); border-color: #ffcdd2; }

/* Table */
.table-container { overflow-x: auto; margin-top: 15px; }
table { width: 100%; border-collapse: collapse; min-width: 600px; }
th { text-align: left; padding: 12px; font-size: 12px; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid #eee; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 14px; }
.img-preview { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; }

/* Grid & Utilities */
h2 { font-size: 20px; margin: 0 0 10px 0; color: var(--text); }
.muted { color: var(--muted); }
.text-small { font-size: 13px; }

/* Drag Grid */
#orderGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
  gap: 16px;
  margin-top: 20px;
}
.orderCard {
  background: #fff;
  border: 1px solid #eee;
  border-radius: 12px;
  overflow: hidden;
  cursor: grab;
  transition: transform 0.2s;
}
.orderCard:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.orderCard.dragging { opacity: 0.5; border: 2px dashed var(--primary); }

/* Tile Inventory */
.tile {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #fff;
  border-bottom: 1px solid #eee;
}
.tile:last-child { border-bottom: none; }
.side-pill {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  background: #fff;
  border-radius: 10px;
  border: 1px solid #eee;
}
.side-pill.off { opacity: 0.6; background: #f5f5f5; }

/* Responsive adjustments */
@media (max-width: 900px) {
  .topbar { padding: 0 15px; }
  .nav-right { display: none; } /* En móvil se podría poner un menú, pero por ahora ocultamos para simplificar */
}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#">
      <img src="images/logo.png" alt="Logo">
      <span>Rhodes Admin</span>
    </a>

    <nav class="nav-right">
      <a class="nav-link" href="finanzas.html">Finanzas</a>
      <a class="nav-link active" href="admin.html">Stock</a>
      <a class="nav-link" href="pedidos.html">Pedidos</a>
      <a class="nav-link" href="pedido_local.html">Mostrador</a>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </nav>
  </div>
</header>

<main>

<section class="card" style="border-left: 4px solid var(--primary);">
  <div class="store-bar">
    <div>
      <h2>Estado de la Tienda</h2>
      <div id="storeSub" class="text-small muted">—</div>
    </div>

    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap">
      <div id="storePill" class="pill off">CERRADO</div>

      <div style="display:flex; gap:8px">
        <button class="mini-btn good" id="btnForceOpen">Abrir Tienda</button>
        <button class="mini-btn bad" id="btnForceClose">Cerrar Tienda</button>
      </div>

      <div style="width:1px; height:24px; background:#ddd; margin:0 4px"></div>

      <div style="display:flex; align-items:center; gap:6px;">
        <input id="forceUntil" type="datetime-local" style="padding:6px; font-size:12px; width:auto"/>
        <button class="mini-btn primary" id="btnSaveUntil">Programar</button>
      </div>
    </div>
  </div>
</section>


<section class="card featured">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
    <h2>Gestión de Productos</h2>
    <div class="pill off" style="font-weight:normal; background:#fff; border:1px solid #ddd">Modo Editor</div>
  </div>
  
  <p class="muted" style="margin-bottom:20px">
    Agregá, editá y gestioná el catálogo completo.
  </p>

  <div class="form-grid">
    <div>
      <label>ID (único)</label>
      <input id="prdId" type="text" placeholder="Ej: bigjohn_simple">
    </div>

    <div>
      <label>Nombre</label>
      <input id="prdName" type="text" placeholder="Nombre del producto">
    </div>

    <div>
      <label>Categoría</label>
      <select id="prdCategory">
        <option value="hamburguesas">Hamburguesas</option>
        <option value="bebidas">Bebidas</option>
        <option value="guarniciones">Guarniciones</option>
      </select>
    </div>

    <div>
      <label>Precio</label>
      <input id="prdPrice" type="number" min="0" step="1" placeholder="Ej: 4800">
    </div>

    <div>
      <label>Imagen (URL o archivo)</label>
      <input id="prdImg" type="text" placeholder="https://...">
      <input id="prdImgFile" type="file" accept="image/*" style="margin-top:8px; font-size:12px">
    </div>

    <div style="grid-column:1/-1">
      <label>Descripción</label>
      <textarea id="prdDesc" rows="3" placeholder="Descripción corta…"></textarea>
    </div>
  </div>

  <div class="row">
    <button class="btn primary" id="btnSaveProduct">Guardar / Actualizar</button>
    <button class="btn bad" id="btnClearProduct" style="background:transparent; color:#d32f2f; border:1px solid #ffcdd2">Limpiar</button>
  </div>

  <div style="height:1px; background:#eee; margin:25px 0"></div>

  <h3>Listado Actual</h3>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>IMG</th>
          <th>Nombre</th>
          <th>Categoría</th>
          <th>Precio</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="prdTable"></tbody>
    </table>
  </div>
</section>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:24px;">

  <section class="card">
    <h2>Orden Visual</h2>
    <p class="muted">Arrastrá las tarjetas para ordenar en el menú.</p>

    <div class="row" id="orderCatButtons" style="margin-bottom:15px; background:#f5f5f5; padding:4px; border-radius:10px; display:inline-flex;">
      <button class="mini-btn primary" data-cat="hamburguesas">Burgers</button>
      <button class="mini-btn" data-cat="bebidas" style="color:#555; background:transparent">Bebidas</button>
      <button class="mini-btn" data-cat="guarniciones" style="color:#555; background:transparent">Papas</button>
    </div>

    <div id="orderGrid"></div>

    <div style="margin-top:20px; text-align:right">
      <button class="btn primary" id="btnSaveOrder">Guardar Nuevo Orden</button>
    </div>
  </section>

  <section class="card">
    <h2>Control de Stock Rápido</h2>
    <p class="muted">Activar/Desactivar disponibilidad inmediata.</p>
    
    <div id="invList" style="border:1px solid #eee; border-radius:12px; overflow:hidden;">
      </div>
  </section>

</div>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:24px;">

  <section class="card">
    <h2>Configuración de Papas</h2>
    <p class="muted">Opciones visibles al cliente.</p>
    <div id="sidesContainer"></div>
  </section>

  <section class="card">
    <h2>Cupones de Descuento</h2>
    
    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
      <div><label>Código</label><input id="cpCode" type="text" style="text-transform:uppercase"></div>
      <div>
        <label>Tipo</label>
        <select id="cpType">
          <option value="percent">% Porcentaje</option>
          <option value="fixed">$ Monto Fijo</option>
        </select>
      </div>
      <div><label>Valor</label><input id="cpValue" type="number"></div>
      <div><label>Max Usos</label><input id="cpMaxUses" type="number"></div>
      <div><label>Desde</label><input id="cpFrom" type="date"></div>
      <div><label>Hasta</label><input id="cpTo" type="date"></div>
      <div style="grid-column:1/-1"><label>Nota interna</label><input id="cpNote" type="text"></div>
    </div>
    <button class="btn primary" id="btnCreateCp" style="width:100%">Crear Cupón</button>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="cpTable"></tbody>
      </table>
    </div>
  </section>

</div>

</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
try{ firebase.initializeApp(firebaseConfig); } catch(e){}
try{
  firebase.firestore().settings({ experimentalForceLongPolling:true, useFetchStreams:false });
}catch(e){}

const db = firebase.firestore();
const productsCol = db.collection('products');

/* Helpers */
const $ = s => document.querySelector(s);

/* 1. AUTO DETECT KIND */
function autoDetectKind(id, name = "", desc = "") {
  id    = id.toLowerCase();
  name = (name || "").toLowerCase();
  desc = (desc || "").toLowerCase();
  if (id.includes("_doble"))  return "doble";
  if (id.includes("_simple")) return "simple";
  if (id.includes("_pollo"))  return "pollo";
  if (name.includes("doble")) return "doble";
  if (name.includes("pollo")) return "pollo";
  if (desc.includes("doble")) return "doble";
  if (desc.includes("pollo")) return "pollo";
  return "simple"; 
}

/* 2. File to Base64 */
async function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* 3. SAVE PRODUCT */
async function saveProduct(){
  const id = $('#prdId').value.trim();
  const name = $('#prdName').value.trim();
  const category = $('#prdCategory').value.trim();
  const price = Number($('#prdPrice').value || 0);
  const urlImg = $('#prdImg').value.trim();
  const desc = $('#prdDesc').value.trim();
  const file = $('#prdImgFile').files[0];

  if(!id){ alert("Ingresá un ID"); return; }
  if(!name){ alert("Ingresá un nombre"); return; }
  if(!(price>0)){ alert("Precio inválido"); return; }

  let finalImg = urlImg || null;
  if(file){
    finalImg = await fileToBase64(file);
  }

  const payload = {
    name, category, price,
    img: finalImg,
    description: desc || null,
    available: true,
    kind: autoDetectKind(id, name, desc),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    await productsCol.doc(id).set(payload, {merge:true});
    alert("Producto guardado correctamente.");
    clearProductForm();
  }catch(e){
    console.error(e);
    alert("Error al guardar.");
  }
}

/* 4. CLEAR FORM */
function clearProductForm(){
  $('#prdId').value = '';
  $('#prdName').value = '';
  $('#prdCategory').value = 'hamburguesas';
  $('#prdPrice').value = '';
  $('#prdImg').value = '';
  $('#prdImgFile').value = '';
  $('#prdDesc').value = '';
}

/* 5. LOAD FORM */
function loadProductIntoForm(data, id){
  $('#prdId').value = id;
  $('#prdName').value = data.name || '';
  $('#prdCategory').value = data.category || 'hamburguesas';
  $('#prdPrice').value = data.price || '';
  $('#prdImg').value = (data.img && !data.img.startsWith("data:")) ? data.img : '';
  $('#prdImgFile').value = '';
  $('#prdDesc').value = data.description || '';
  window.scrollTo({top:0, behavior:'smooth'});
}

/* 6. DELETE */
async function deleteProduct(id){
  if(!confirm("¿Eliminar "+id+"?")) return;
  try{ await productsCol.doc(id).delete(); }catch(e){ alert("Error al eliminar."); }
}

/* 7. TOGGLE AVAILABILITY */
async function toggleProductAvailability(id, current){
  try{
    await productsCol.doc(id).set({
      available: !current,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }catch(e){ alert("Error."); }
}

/* 8. RENDER TABLE */
function renderProductsTable(snapshot){
  const tbody = $('#prdTable');
  tbody.innerHTML = '';

  snapshot.forEach(doc=>{
    const p = doc.data();
    const tr = document.createElement('tr');
    
    const imgTag = p.img 
      ? `<img src="${p.img}" class="img-preview">` 
      : `<div class="img-preview"></div>`;

    const availableTag = p.available
      ? `<span class="pill ok">Activo</span>`
      : `<span class="pill off">Pausado</span>`;

    tr.innerHTML = `
      <td><strong>${doc.id}</strong></td>
      <td>${imgTag}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>$${p.price}</td>
      <td>${availableTag}</td>
      <td class="row">
        <button class="mini-btn good" data-act="edit" data-id="${doc.id}">Editar</button>
        <button class="mini-btn warn" data-act="toggle" data-id="${doc.id}" data-av="${p.available}">
          ${p.available ? "Pausar" : "Activar"}
        </button>
        <button class="mini-btn bad" data-act="delete" data-id="${doc.id}">Borrar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button").forEach(btn=>{
    btn.onclick = async()=>{
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if(act === "edit"){
        const d = await productsCol.doc(id).get();
        loadProductIntoForm(d.data(), id);
      } else if(act === "toggle"){
        toggleProductAvailability(id, btn.dataset.av === "true");
      } else if(act === "delete"){
        deleteProduct(id);
      }
    };
  });
}
productsCol.onSnapshot(renderProductsTable);

/* ============================================================
     ORDEN VISUAL
=============================================================== */
let ORDER_PRODUCTS = [];
let CURRENT_CAT = "hamburguesas";
const menuOrderRef = db.collection("config").doc("menuOrder");
const orderGrid = document.querySelector("#orderGrid");
const orderCatButtons = document.querySelector("#orderCatButtons");

if(orderCatButtons){
  orderCatButtons.querySelectorAll("button").forEach(btn=>{
    btn.onclick = ()=>{
      orderCatButtons.querySelectorAll("button").forEach(b=>{
        b.classList.remove("primary");
        b.style.color = "#555";
        b.style.background = "transparent";
      });
      btn.classList.add("primary");
      btn.style.color = "#fff";
      btn.style.background = "var(--primary)";
      CURRENT_CAT = btn.dataset.cat;
      renderOrderGrid();
    };
  });
}

let MENU_ORDER = {};
menuOrderRef.onSnapshot(snap=>{
  MENU_ORDER = snap.exists ? snap.data() : {};
  renderOrderGrid();
});

function renderOrderGrid(){
  if(!orderGrid) return;
  orderGrid.innerHTML = "";
  const list = ORDER_PRODUCTS.filter(p => p.category === CURRENT_CAT);
  const orderedIds = MENU_ORDER[CURRENT_CAT] || [];

  list.sort((a,b)=>{
    const ia = orderedIds.indexOf(a.id);
    const ib = orderedIds.indexOf(b.id);
    if(ia === -1 && ib === -1) return a.name.localeCompare(b.name);
    if(ia === -1) return 1;
    if(ib === -1) return -1;
    return ia - ib;
  });

  list.forEach(p=>{
    const card = document.createElement("div");
    card.className = "orderCard";
    card.draggable = true;
    card.dataset.id = p.id;
    card.innerHTML = `
      <div style="height:100px; background:#f9f9f9; display:flex; align-items:center; justify-content:center; overflow:hidden">
         <img src="${p.img || ""}" style="width:100%; height:100%; object-fit:cover; display:${p.img?'block':'none'}">
         <span style="display:${p.img?'none':'block'}; color:#ccc">Sin img</span>
      </div>
      <div style="padding:8px; font-weight:700; font-size:13px; text-align:center">${p.name}</div>
    `;
    card.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("id", p.id);
      card.classList.add("dragging");
    });
    card.addEventListener("dragend", ()=>{
      card.classList.remove("dragging");
    });
    card.addEventListener("dragover", e=>{
      e.preventDefault();
      const dragging = orderGrid.querySelector(".dragging");
      if(!dragging || dragging === card) return;
      const siblings = [...orderGrid.querySelectorAll(".orderCard:not(.dragging)")];
      let nextSibling = siblings.find(sibling => {
         return e.clientY <= sibling.getBoundingClientRect().top + sibling.getBoundingClientRect().height / 2 &&
                e.clientX <= sibling.getBoundingClientRect().left + sibling.getBoundingClientRect().width / 2; 
      });
      orderGrid.insertBefore(dragging, nextSibling);
    });
    orderGrid.appendChild(card);
  });
}

productsCol.onSnapshot(snap=>{
  ORDER_PRODUCTS = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderOrderGrid();
});

const btnSaveOrder = document.querySelector("#btnSaveOrder");
if(btnSaveOrder){
  btnSaveOrder.onclick = async ()=>{
    const ids = [...orderGrid.querySelectorAll(".orderCard")].map(c => c.dataset.id);
    await menuOrderRef.set({ ...MENU_ORDER, [CURRENT_CAT]: ids }, {merge:true});
    alert("Orden guardada.");
  };
}

/* ============================================================
     INVENTARIO
=============================================================== */
const invList = document.querySelector('#invList');
function renderInventory(snapshot){
  if(!invList) return;
  invList.innerHTML = '';
  snapshot.forEach(doc=>{
    const p = doc.data();
    const available = !!p.available;
    const el = document.createElement('div');
    el.className = "tile";
    el.innerHTML = `
      <div>
        <div style="font-weight:700; font-size:14px">${p.name}</div>
        <div class="muted" style="font-size:12px">${p.category}</div>
      </div>
      <div class="row">
        <span class="pill ${available?'ok':'off'}">${available ? 'OK' : 'X'}</span>
        <button class="mini-btn ${available?'bad':'good'}" data-id="${doc.id}" data-next="${available?0:1}">
          ${available ? 'Bajar' : 'Subir'}
        </button>
      </div>
    `;
    invList.appendChild(el);
  });
  invList.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = async()=>{
      const id = btn.dataset.id;
      const next = btn.dataset.next === "1";
      try{
        await productsCol.doc(id).set({available: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
      }catch(e){}
    };
  });
}
productsCol.onSnapshot(renderInventory);

/* ============================================================
     SIDES (PAPAS)
=============================================================== */
const sidesRef = () => db.collection("config").doc("sides");
const SIDES_META = [
  { key:"con_sazon", label:"Con sazón" },
  { key:"con_sal",   label:"Con sal" },
  { key:"sin_sal",   label:"Sin sal" }
];
const sidesContainer = document.querySelector("#sidesContainer");
function renderSidesUI(state){
  if(!sidesContainer) return;
  sidesContainer.innerHTML = '';
  SIDES_META.forEach(s=>{
    const enabled = state ? !!state[s.key] : true;
    const el = document.createElement("div");
    el.className = "side-pill " + (enabled ? "on" : "off");
    el.innerHTML = `
      <div>
        <div style="font-weight:700">${s.label}</div>
      </div>
      <div>
        <button class="mini-btn ${enabled?'bad':'good'}" data-side="${s.key}" data-next="${enabled?0:1}">
          ${enabled ? "Desactivar" : "Activar"}
        </button>
      </div>
    `;
    sidesContainer.appendChild(el);
  });
  sidesContainer.querySelectorAll("button[data-side]").forEach(btn=>{
    btn.onclick = async()=>{
      const key = btn.dataset.side;
      const next = btn.dataset.next === "1";
      try{ await sidesRef().set({ [key]: next, updatedAt: firebase.firestore.FieldValue.serverTimestamp() },{merge:true}); }catch(e){}
    };
  });
}
sidesRef().onSnapshot(snap=>{ renderSidesUI(snap.exists ? snap.data() : {}); });

/* ============================================================
     STORE OVERRIDE LOGIC
=============================================================== */
const storeRef = () => db.collection("config").doc("store");
const storePill = document.querySelector("#storePill");
const storeSub = document.querySelector("#storeSub");
const btnOpen = document.querySelector("#btnForceOpen");
const btnClose = document.querySelector("#btnForceClose");
const forceUntilInput = document.querySelector("#forceUntil");
const btnSaveUntil = document.querySelector("#btnSaveUntil");

function applyStoreDocToUI(d){
  const on = !!d.forceOpen;
  let until = null;
  if(d.forceOpenUntil){
    try{
      if(typeof d.forceOpenUntil.toDate === "function") until = d.forceOpenUntil.toDate();
      else if(d.forceOpenUntil.seconds) until = new Date(d.forceOpenUntil.seconds * 1000);
      else until = new Date(d.forceOpenUntil);
    }catch(e){}
  }
  const active = on || (until && until.getTime() > Date.now());
  
  if(active){
    storePill.className = "pill ok";
    storePill.textContent = "ABIERTO (Forzado)";
  } else {
    storePill.className = "pill off";
    storePill.textContent = "CERRADO / AUTO";
  }
  
  if(until && until.getTime() > Date.now()){
    const h = String(until.getHours()).padStart(2,"0");
    const m = String(until.getMinutes()).padStart(2,"0");
    storeSub.textContent = `Programado hasta las ${h}:${m}`;
    const local = new Date(until.getTime() - until.getTimezoneOffset()*60000);
    forceUntilInput.value = local.toISOString().slice(0,16);
  } else {
    storeSub.textContent = "Operación normal según horario";
    forceUntilInput.value = "";
  }
}
storeRef().onSnapshot(snap=>{ applyStoreDocToUI(snap.exists ? snap.data() : {}); });

btnOpen.onclick = async()=>{
  await storeRef().set({forceOpen:true, updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
};
btnClose.onclick = async()=>{
  await storeRef().set({
    forceOpen:false,
    forceOpenMessage: firebase.firestore.FieldValue.delete(),
    forceOpenUntil: firebase.firestore.FieldValue.delete(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
};
btnSaveUntil.onclick = async()=>{
  const v = forceUntilInput.value;
  if(!v){ alert("Elegí fecha y hora"); return; }
  const local = new Date(v);
  await storeRef().set({
    forceOpen:true,
    forceOpenUntil: firebase.firestore.Timestamp.fromDate(local),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
  alert("Guardado.");
};

/* ============================================================
     CUPONES LOGIC
=============================================================== */
const cpTbody = document.querySelector("#cpTable");
const btnCreateCp = document.querySelector("#btnCreateCp");

function fmtDate(ts){ 
  if(!ts) return null;
  if(ts.toDate) return ts.toDate();
  return new Date(ts.seconds*1000);
}

if(btnCreateCp){
  btnCreateCp.onclick = () => {
    const code = (document.querySelector("#cpCode").value||"").trim().toUpperCase();
    if(!code){ alert("Ingresá código"); return; }
    const type = document.querySelector("#cpType").value;
    const value = Number(document.querySelector("#cpValue").value||0);
    if(!(value>0)){ alert("Valor inválido"); return; }
    const maxUses = Number(document.querySelector("#cpMaxUses").value||0);
    const note = (document.querySelector("#cpNote").value||"").trim();
    const fromVal = document.querySelector("#cpFrom").value;
    const toVal = document.querySelector("#cpTo").value;
    
    const payload = {
      code, type, value, enabled:true,
      note: note || null,
      validFrom: fromVal ? firebase.firestore.Timestamp.fromDate(new Date(fromVal)) : null,
      validTo:   toVal   ? firebase.firestore.Timestamp.fromDate(new Date(toVal))   : null,
      maxUses: maxUses > 0 ? maxUses : null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    db.collection("coupons").doc(code).set({
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      uses:0, ...payload
    },{merge:true}).then(()=>{ alert("Cupón guardado"); loadCoupons(); });
  };
}

function renderCoupons(list){
  if(!cpTbody) return;
  cpTbody.innerHTML = "";
  list.forEach(doc=>{
    const c = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${c.code}</strong></td>
      <td>${c.type==='percent'?'%':'$'}</td>
      <td>${c.value}</td>
      <td>${c.enabled ? "<span class='pill ok'>ON</span>" : "<span class='pill off'>OFF</span>"}</td>
      <td class="row">
        <button class="mini-btn ${c.enabled?'warn':'good'}" data-act="toggle" data-id="${doc.id}">
          ${c.enabled ? "Pausar" : "Activar"}
        </button>
        <button class="mini-btn bad" data-act="delete" data-id="${doc.id}">X</button>
      </td>
    `;
    cpTbody.appendChild(tr);
  });
  
  cpTbody.querySelectorAll("button").forEach(btn=>{
    btn.onclick = async()=>{
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if(act === "toggle"){
        const snap = await db.collection("coupons").doc(id).get();
        await db.collection("coupons").doc(id).set({ enabled:!snap.data()?.enabled },{merge:true});
        loadCoupons();
      } else if(act === "delete" && confirm("¿Eliminar?")){
        await db.collection("coupons").doc(id).delete();
        loadCoupons();
      }
    };
  });
}
async function loadCoupons(){
  const q = await db.collection("coupons").orderBy("code").get();
  renderCoupons(q.docs);
}
loadCoupons();

/* ============================================================
     SAVE BTNS
=============================================================== */
const btnSaveProduct = document.querySelector("#btnSaveProduct");
if(btnSaveProduct) btnSaveProduct.onclick = saveProduct;
const btnClearProduct = document.querySelector("#btnClearProduct");
if(btnClearProduct) btnClearProduct.onclick = clearProductForm;

</script>
</body>
</html>
