<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
      --ok:#2e7d32; --warn:#ff9800; --danger:#d32f2f;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:800}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700;text-decoration:none;color:inherit}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}
    .container{max-width:1100px;margin:22px auto;padding:0 12px}
    h1{font-size:28px;margin:10px 0 18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:12px 0}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;background:#fff;font-weight:700}
    .state-ok{color:var(--ok);border-color:#cfe9cf;background:#effaf0}
    .state-warn{color:#8a6d3b;border-color:#ffe58f;background:#fffdea}
    .state-danger{color:var(--danger);border-color:#f5c6cb;background:#fdecec}
    .switch{display:inline-flex;gap:6px}
    .switch .btn{min-width:86px;justify-content:center}
    .err{color:#b00020;font-weight:600}
    /* Lista de √≠tems */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .item{border:1px solid var(--ring);border-radius:14px;padding:10px;background:#fff;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .item small{color:var(--muted);display:block}
    .chk{display:flex;align-items:center;gap:8px}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#2e7d32}
    .status-dot.off{background:#d32f2f}
  </style>
</head>
<body>
  <!-- Guard liviano (UI), NO autentica Firestore; las reglas usan ADMIN_SECRET -->
  <script>
    (function guard(){
      const TTL_MS = 20*60*60*1000;
      const qs = new URLSearchParams(location.search);
      if (qs.get('auth')==='1') {
        try{
          const now = Date.now();
          localStorage.setItem('rb_admin_ok','true');
          localStorage.setItem('rb_admin_t', String(now));
          localStorage.setItem('rb_auth_v2','ok');
          sessionStorage.setItem('rb_auth_v2','ok');
        }catch(_){}
        try{ history.replaceState(null,'',location.pathname); }catch(_){}
      }
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      const ts = Number(localStorage.getItem('rb_admin_t')||0);
      const live = (Date.now()-ts) < TTL_MS;
      if (!(ok && live)){
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?reason=guard&next='+next);
        return;
      }
      try{ localStorage.setItem('rb_admin_t', String(Date.now())); }catch(_){}
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="Rhodes Burgers">Admin</a>
      <div class="spacer"></div>
      <a href="pedido_local.html" class="btn" title="Ir a pedidos">üßæ Pedidos</a>
      <a href="finanzas.html" class="btn" title="Ir a finanzas">üìä Finanzas</a>
      <a href="admin.html" class="btn primary" title="Panel actual">‚öôÔ∏è Admin</a>
      <a href="mostrador.html" class="btn" title="Ir al mostrador">üñ• Mostrador</a>
      <button id="btnLogout" class="btn danger" title="Cerrar sesi√≥n">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <h1>Panel de administraci√≥n</h1>

    <!-- Estado del local -->
    <section class="card">
      <h3>Estado del local</h3>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <div class="row">
          <span id="openBadge" class="pill state-warn">Cargando‚Ä¶</span>
          <div class="switch">
            <button id="btnOpen"  class="btn">üîì Abrir</button>
            <button id="btnClose" class="btn">üîí Cerrar</button>
          </div>
        </div>
        <div id="openError" class="err" style="display:none">No se pudo actualizar el estado.</div>
      </div>
      <div class="muted" style="margin-top:6px">Este estado lo usan <strong>index</strong> y <strong>mostrador</strong> para mostrar ‚ÄúAbierto/Cerrado‚Äù y habilitar el pago.</div>
    </section>

    <!-- Disponibilidad de √≠tems -->
    <section class="card">
      <h3>Disponibilidad de √≠tems</h3>
      <div class="muted" style="margin-bottom:8px">Desactivalos cuando no haya stock. Impacta en <strong>index</strong> y <strong>mostrador</strong> (oculta/bloquea el bot√≥n).</div>

      <div id="itemsGrid" class="grid"></div>
      <div id="flagsError" class="err" style="display:none;margin-top:8px">No se pudieron guardar los cambios.</div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ========= CONFIG =========
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(_){}
    const db = firebase.firestore();

    // ========= LLAVE ADMIN (debe coincidir con settings/admin.secret en Firestore Rules) =========
    const ADMIN_SECRET = "REEMPLAZA_ESTE_VALOR_CON_TU_SECRET"; // <-- IMPORTANTE

    // ========= NAV logout =========
    document.addEventListener('DOMContentLoaded', ()=>{
      const btn = document.getElementById('btnLogout');
      if(btn) btn.onclick = ()=>{
        localStorage.removeItem('rb_auth_v2');
        localStorage.removeItem('rb_admin_ok');
        localStorage.removeItem('rb_admin_t');
        sessionStorage.removeItem('rb_auth_v2');
        location.replace('login.html?reason=logout&next=pedido_local.html');
      };
    });

    // ========= Helpers =========
    const $ = s => document.querySelector(s);

    // ========= OPEN STATE =========
    const openDocRef = db.collection('settings').doc('open_state');
    const openBadge = $('#openBadge');
    const openErr   = $('#openError');
    function setBadge(isOpen){
      if(isOpen===true){
        openBadge.textContent = 'ABIERTO';
        openBadge.className = 'pill state-ok';
      }else if(isOpen===false){
        openBadge.textContent = 'CERRADO';
        openBadge.className = 'pill state-danger';
      }else{
        openBadge.textContent = 'Cargando‚Ä¶';
        openBadge.className = 'pill state-warn';
      }
    }
    // Live
    openDocRef.onSnapshot(snap=>{
      openErr.style.display = 'none';
      if(!snap.exists){ setBadge(false); return; }
      const d = snap.data();
      setBadge(!!d.isOpen);
    }, err=>{
      console.error(err);
      openErr.style.display = 'block';
      setBadge(undefined);
    });
    // Actions
    $('#btnOpen').onclick = async ()=>{
      try{
        openErr.style.display='none';
        await openDocRef.set({
          isOpen: true,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          _admin: ADMIN_SECRET
        }, { merge:true });
      }catch(e){
        console.error(e);
        openErr.style.display='block';
      }
    };
    $('#btnClose').onclick = async ()=>{
      try{
        openErr.style.display='none';
        await openDocRef.set({
          isOpen: false,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          _admin: ADMIN_SECRET
        }, { merge:true });
      }catch(e){
        console.error(e);
        openErr.style.display='block';
      }
    };

    // ========= MENU FLAGS (items desactivados) =========
    // Debe alinearse con los IDs que usan index/mostrador
    const CATALOG = [
      // Hamburguesas
      { id:"bigjohn_simple",  name:"Big John Simple" },
      { id:"bigjohn_doble",   name:"Big John Doble"  },
      { id:"burguesa_simple", name:"Burguesa Simple" },
      { id:"burguesa_doble",  name:"Burguesa Doble"  },
      { id:"cheesebacon_simple", name:"CheeseBacon Simple" },
      { id:"cheesebacon_doble",  name:"CheeseBacon Doble"  },
      { id:"cheese_simple",   name:"Cheeseburger Simple" },
      { id:"cheese_doble",    name:"Cheeseburger Doble"  },
      { id:"rhodes_simple",   name:"Rhodes Simple" },
      { id:"rhodes_doble",    name:"Rhodes Doble"  },
      { id:"morgan_simple",   name:"Morgan Simple" },
      { id:"morgan_doble",    name:"Morgan Doble"  },
      { id:"pollo_crispy",    name:"Pollo Crispy"  },
      // Bebidas
      { id:"andes_rubia", name:"Andes Rubia 473ml" },
      { id:"andes_roja",  name:"Andes Roja 473ml"  },
      { id:"coca_org",    name:"Coca-Cola 500ml"   },
      { id:"coca_zero",   name:"Coca Zero 500ml"   },
      { id:"sprite",      name:"Sprite 500ml"      },
      { id:"aq_pomelo",   name:"Aquarius Pomelo"   },
      { id:"aq_pera",     name:"Aquarius Pera"     },
      { id:"aq_manzana",  name:"Aquarius Manzana"  },
      { id:"agua_sg",     name:"Agua sin gas"      },
    ];

    const flagsDocRef = db.collection('settings').doc('menu_flags');
    const flagsErr = $('#flagsError');
    const itemsGrid = $('#itemsGrid');

    function renderItems(disabledSet){
      itemsGrid.innerHTML = '';
      CATALOG.forEach(prod=>{
        const off = disabledSet.has(prod.id);
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div>
            <strong>${prod.name}</strong>
            <small>ID: ${prod.id}</small>
          </div>
          <label class="chk">
            <span class="status-dot ${off?'off':''}" aria-hidden="true"></span>
            <input type="checkbox" ${off?'checked':''} data-id="${prod.id}" />
            <span>${off? 'Desactivado' : 'Activo'}</span>
          </label>
        `;
        itemsGrid.appendChild(el);
      });

      // Bind
      itemsGrid.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
        chk.addEventListener('change', async (e)=>{
          const id = e.target.getAttribute('data-id');
          try{
            flagsErr.style.display='none';
            // Traigo snapshot actual para evitar colisiones simples
            const snap = await flagsDocRef.get();
            const curArr = (snap.exists && Array.isArray(snap.data().disabled)) ? snap.data().disabled : [];
            const set = new Set(curArr);
            if (e.target.checked) set.add(id); else set.delete(id);
            await flagsDocRef.set({
              disabled: Array.from(set),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              _admin: ADMIN_SECRET
            }, { merge:true });
          }catch(err){
            console.error(err);
            flagsErr.style.display='block';
            // revertir UI si fall√≥
            e.target.checked = !e.target.checked;
          }
        });
      });
    }

    // Live update
    flagsDocRef.onSnapshot(snap=>{
      flagsErr.style.display='none';
      const arr = (snap.exists && Array.isArray(snap.data().disabled)) ? snap.data().disabled : [];
      renderItems(new Set(arr));
    }, err=>{
      console.error(err);
      flagsErr.style.display='block';
    });
  </script>
</body>
</html>
