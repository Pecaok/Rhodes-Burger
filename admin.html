<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#625A45;
      --text:#111;
      --muted:#666;
      --bg:#f6f6f6;
      --card:#fff;
      --radius:18px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --ring:#e0e0e0;
      --danger:#d32f2f;
      --success:#2e7d32;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }

    /* ===== Topbar ===== */
    header{
      position:sticky;
      top:0;
      z-index:20;
      background:#fff;
      padding:10px 12px;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .topbar{
      max-width:1250px;
      margin:0 auto;
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      text-decoration:none;
      color:inherit;
      font-weight:800;
      font-size:20px;
    }
    .brand img{
      width:38px;
      height:38px;
      margin-right:10px;
      border-radius:10px;
      object-fit:contain;
    }

    .spacer{flex:1}

    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--ring);
      background:#fff;
      padding:8px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      text-decoration:none;
      color:inherit;
      transition:0.15s;
    }
    .btn:hover{background:#f3f3f3}
    .btn.primary{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary);
    }
    .btn.danger{
      background:#fff5f5;
      border-color:#ffc8c8;
      color:var(--danger);
    }
    .btn.success{
      background:#eaf8ea;
      border-color:#c8eac8;
      color:var(--success);
    }

    /* ===== Layout ===== */
    .container{
      max-width:1250px;
      margin:22px auto;
      padding:0 12px;
    }

    h1{
      font-size:32px;
      margin:0 0 18px;
      font-weight:800;
    }

    /* ===== Mosaic Grid ===== */
    #productGrid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:20px;
      margin-top:22px;
    }

    .productCard{
      background:var(--card);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
      cursor:grab;
      transition:0.15s;
    }
    .productCard.dragging{opacity:0.4}

    .prod-img{
      width:100%;
      height:200px;
      object-fit:cover;
      background:#ddd;
    }

    .prod-body{
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .prod-title{font-size:20px;font-weight:700}
    .prod-price{font-size:17px;font-weight:600;color:var(--primary)}
    .prod-cat{font-size:13px;color:var(--muted);font-weight:600;text-transform:uppercase}
    .prod-desc{font-size:14px;color:#333;line-height:1.35;min-height:40px}

    .prod-actions{
      margin-top:12px;
      display:flex;
      gap:10px;
    }

    /* Switch */
    .switch{
      position:relative;
      width:46px;
      height:24px;
    }
    .switch input{display:none}
    .slider{
      position:absolute;
      cursor:pointer;
      top:0;left:0;
      right:0;bottom:0;
      background:#ccc;
      transition:.3s;
      border-radius:24px;
    }
    .slider:before{
      position:absolute;
      content:"";
      height:20px;width:20px;
      left:2px;bottom:2px;
      background:#fff;
      transition:.3s;
      border-radius:50%;
    }
    input:checked + .slider{
      background:var(--success);
    }
    input:checked + .slider:before{
      transform:translateX(22px);
    }

    /* Modal fondo */
    .modal-backdrop{
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.4);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .modal{
      background:#fff;
      width:95%;
      max-width:500px;
      border-radius:18px;
      padding:22px;
      box-shadow:0 12px 30px rgba(0,0,0,.15);
      animation:pop .25s ease;
    }
    @keyframes pop{
      from{transform:scale(.85);opacity:0}
    }

    .modal h2{
      margin-top:0;font-size:24px;font-weight:800;
    }
    label{font-weight:600;font-size:14px;margin:6px 0}
    input, select, textarea{
      width:100%;
      padding:10px;
      border:1px solid var(--ring);
      border-radius:12px;
      font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}

    .img-preview{
      margin-top:10px;
      width:100%;
      height:200px;
      background:#eee;
      border-radius:12px;
      object-fit:cover;
      display:none;
    }

  </style>
</head>
<script>
// ============================
// CONFIGURACI√ìN
// ============================
const GITHUB_IMG_FOLDER = 
  "https://raw.githubusercontent.com/Pecaok/Rhodes-Burger/main/images/";

const storage = firebase.storage();
const storageRef = storage.ref();

// ============================
// FUNCI√ìN PARA BAJAR UNA IMAGEN DESDE GITHUB
// ============================
async function downloadImage(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("No se pudo descargar " + url);
  return await res.blob(); // devuelve blob listo para subir
}

// ============================
// SUBIR A FIREBASE STORAGE
// ============================
async function uploadToStorage(fileName, blob) {
  const ref = storageRef.child("products/" + fileName);
  await ref.put(blob);
  return await ref.getDownloadURL();
}

// ============================
// MIGRAR TODAS LAS IM√ÅGENES
// ============================
async function migrateAllImages() {
  const status = document.getElementById("migrateStatus");
  status.style.display = "block";
  status.textContent = "Buscando productos‚Ä¶";

  // Leer todos los productos
  const snap = await db.collection("products").get();
  if (snap.empty) {
    status.textContent = "No hay productos cargados.";
    return;
  }

  let total = snap.size;
  let done = 0;

  for (const doc of snap.docs) {
    const data = doc.data();
    const name = data.img || "";  
    if (!name) {
      done++;
      continue;
    }

    // Extraer solo el archivo (ej: ‚Äúcheeseburger simple.jpg‚Äù)
    const fileName = name.split("/").pop();

    try {
      status.textContent = `Migrando (${done + 1}/${total}): ${fileName}`;

      // 1 ‚Äî descargar desde GitHub
      const blob = await downloadImage(GITHUB_IMG_FOLDER + fileName);

      // 2 ‚Äî subir a firebase
      const url = await uploadToStorage(fileName, blob);

      // 3 ‚Äî actualizar producto con la nueva URL
      await db.collection("products").doc(doc.id).update({ img: url });

    } catch (e) {
      console.error("Error al migrar " + fileName, e);
    }

    done++;
  }

  status.textContent = `‚úî Migraci√≥n completa (${done}/${total})`;
}

// ============================
// BOT√ìN
// ============================
document.getElementById("btnMigrateImages").onclick = async () => {
  const ok = confirm("¬øMigrar autom√°ticamente todas las im√°genes a Firebase Storage?");
  if (!ok) return;
  migrateAllImages();
};
</script>

<body>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* ============================
      FIREBASE CONFIG
============================ */
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const storage = firebase.storage();

/* ============================
      ELEMENTOS HTML
============================ */
const grid = document.getElementById("productGrid");

/* MODALES */
let modalBackdrop;
let modal;
let editMode = false;
let currentEditId = null;

/* ============================
         ABRIR MODAL
============================ */
function openModal(edit = false, data = null) {
  editMode = edit;
  currentEditId = edit ? data.id : null;

  modalBackdrop.style.display = "flex";
  modal.querySelector("#modalTitle").textContent = edit ? "Editar producto" : "Nuevo producto";

  /* RESET CAMPOS */
  const fields = ["name","price","category","description"];
  fields.forEach(f => modal.querySelector(`#prod_${f}`).value = data ? data[f] : "");

  /* Imagen */
  const imgPrev = modal.querySelector("#prod_img_preview");
  imgPrev.style.display = data?.imageUrl ? "block" : "none";
  imgPrev.src = data?.imageUrl || "";
  modal.querySelector("#prod_image").value = "";

  /* Disponibilidad */
  modal.querySelector("#prod_available").checked = data?.available ?? true;
}

/* ============================
         CERRAR MODAL
============================ */
function closeModal(){
  modalBackdrop.style.display = "none";
}

/* ============================
     RENDER DE TARJETAS
============================ */
function renderProductCard(prod) {
  const card = document.createElement("div");
  card.className = "productCard";
  card.draggable = true;
  card.dataset.id = prod.id;

  card.innerHTML = `
    <img class="prod-img" src="${prod.imageUrl}" alt="${prod.name}">
    <div class="prod-body">
      <div class="prod-title">${prod.name}</div>
      <div class="prod-price">$${prod.price}</div>
      <div class="prod-cat">${prod.category}</div>
      <div class="prod-desc">${prod.description || ""}</div>

      <label class="switch">
        <input type="checkbox" ${prod.available ? "checked":""} onchange="toggleAvailable('${prod.id}',this.checked)">
        <span class="slider"></span>
      </label>

      <div class="prod-actions">
        <button class="btn" onclick="editProduct('${prod.id}')">Editar</button>
        <button class="btn danger" onclick="deleteProduct('${prod.id}')">Borrar</button>
      </div>
    </div>
  `;

  /* DRAG EVENTS */
  card.addEventListener("dragstart", dragStart);
  card.addEventListener("dragover", dragOver);
  card.addEventListener("drop", dragDrop);
  card.addEventListener("dragend", dragEnd);

  return card;
}

/* ============================
     CARGAR PRODUCTOS
============================ */
async function loadProducts() {
  grid.innerHTML = `<div style="font-size:18px">Cargando productos...</div>`;

  const snap = await db.collection("products")
    .orderBy("order","asc")
    .get();

  grid.innerHTML = "";

  snap.forEach(doc => {
    const prod = { id:doc.id, ...doc.data() };
    grid.appendChild(renderProductCard(prod));
  });
}

/* ============================
   GUARDAR PRODUCTO (CREATE)
============================ */
async function saveProduct() {

  const name = modal.querySelector("#prod_name").value.trim();
  const price = Number(modal.querySelector("#prod_price").value);
  const category = modal.querySelector("#prod_category").value;
  const desc = modal.querySelector("#prod_description").value;
  const available = modal.querySelector("#prod_available").checked;

  let imageFile = modal.querySelector("#prod_image").files[0];
  let imageUrl = "";

  // Si estamos editando y no cambiaron imagen
  if (editMode && !imageFile) {
    const docSnap = await db.collection("products").doc(currentEditId).get();
    imageUrl = docSnap.data().imageUrl;
  }

  // Si hay nueva imagen, subimos (parte 3)
  if (imageFile) {
    imageUrl = await uploadImageToFirebase(imageFile);
  }

  if (!editMode) {
    const max = await db.collection("products").orderBy("order","desc").limit(1).get();
    let nextOrder = 1;
    if (!max.empty) nextOrder = max.docs[0].data().order + 1;

    await db.collection("products").add({
      name, price, category, description:desc,
      imageUrl,
      available,
      order: nextOrder
    });
  } else {
    await db.collection("products").doc(currentEditId).update({
      name, price, category, description:desc,
      imageUrl, available
    });
  }

  closeModal();
  loadProducts();
}

/* ============================
       EDITAR PRODUCTO
============================ */
async function editProduct(id){
  const snap = await db.collection("products").doc(id).get();
  if (!snap.exists) return;

  openModal(true, {id, ...snap.data()});
}

/* ============================
       BORRAR PRODUCTO
============================ */
async function deleteProduct(id){
  if (!confirm("¬øEliminar producto?")) return;

  await db.collection("products").doc(id).delete();
  loadProducts();
}

/* ============================
  CAMBIAR DISPONIBILIDAD
============================ */
async function toggleAvailable(id, val){
  await db.collection("products").doc(id).update({available:val});
}

/* ============================
         DRAG & DROP
============================ */
let dragSrcEl = null;

function dragStart(e){
  dragSrcEl = this;
  this.classList.add("dragging");
}

function dragOver(e){
  e.preventDefault();
}

function dragDrop(e){
  if (dragSrcEl !== this){
    const nodes = Array.from(grid.children);
    const srcIndex = nodes.indexOf(dragSrcEl);
    const destIndex = nodes.indexOf(this);

    if (srcIndex > destIndex) grid.insertBefore(dragSrcEl, this);
    else grid.insertBefore(dragSrcEl, this.nextSibling);

    saveNewOrder();
  }
}

function dragEnd(){
  this.classList.remove("dragging");
}

/* ============================
     GUARDAR NUEVO ORDEN
============================ */
async function saveNewOrder(){
  const cards = Array.from(grid.children);

  const batch = db.batch();
  cards.forEach((card, index)=>{
    const id = card.dataset.id;
    const ref = db.collection("products").doc(id);
    batch.update(ref, { order:index+1 });
  });

  await batch.commit();
}

/* ============================
  INICIALIZACI√ìN DEL ADMIN
============================ */
document.addEventListener("DOMContentLoaded", ()=>{
  modalBackdrop = document.getElementById("modalBackdrop");
  modal = document.getElementById("modalBox");

  document.getElementById("btnNew").onclick = ()=>openModal(false);
  document.getElementById("btnCancel").onclick = closeModal;
  document.getElementById("btnSave").onclick = saveProduct;

  loadProducts();
});
</script>
<script>
/* ============================================
      PARTE 3 ‚Äî SUBIR IM√ÅGENES A FIREBASE
============================================ */

/*
  üî• ACLARACI√ìN IMPORTANTE:
  Vos ten√©s dos situaciones:

  1) La mayor√≠a de tus im√°genes actuales vienen desde GitHub:
     https://raw.githubusercontent.com/Pecaok/Rhodes-Burger/main/images/xxx.png
  
  2) Las nuevas im√°genes que subas desde admin.html
     ‚Üí Las vamos a subir a Firebase Storage.
     ‚Üí Y desde ah√≠ se obtienen autom√°ticamente con un URL p√∫blico.
     
  üí° Resultado: todos los productos funcionan perfecto sin depender del repo.
*/


/* ==========================================================
      FUNCI√ìN QUE SUBE LA IMAGEN Y DEVUELVE LA URL P√öBLICA
========================================================== */
function uploadImageToFirebase(file) {
  return new Promise((resolve, reject) => {
    const fileName = `products/${Date.now()}_${file.name}`;
    const ref = storage.ref().child(fileName);

    const uploadTask = ref.put(file);

    uploadTask.on(
      "state_changed",
      null,
      (error) => {
        console.error("‚ùå Error subiendo imagen", error);
        reject(error);
      },
      async () => {
        const url = await ref.getDownloadURL();
        resolve(url); // devolvemos el link p√∫blico usable
      }
    );
  });
}

/* ==========================================================
    PREVISUALIZACI√ìN INSTANT√ÅNEA ANTES DE SUBIR
========================================================== */
document.addEventListener("change", (e) => {
  if (e.target.id === "prod_image") {
    const file = e.target.files[0];
    if (!file) return;

    const imgPrev = document.getElementById("prod_img_preview");
    imgPrev.style.display = "block";
    imgPrev.src = URL.createObjectURL(file);
  }
});
</script>
<style>

/* ============================================
      ESTILOS NUEVOS PARA PRODUCTOS Y MODAL
============================================ */

:root {
  --primary:#625A45;
  --radius:18px;
  --ring:#e6e6e6;
  --shadow:0 10px 28px rgba(0,0,0,.10);
}

/* -------- CONTENEDOR DE LOS PRODUCTOS -------- */
.prod-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(260px, 1fr));
  gap:16px;
  margin-top:10px;
}

/* -------- TARJETA DE PRODUCTO (MOSAICO) -------- */
.prod-card {
  background:#fff;
  border:1px solid var(--ring);
  border-radius:var(--radius);
  padding:12px;
  display:flex;
  flex-direction:column;
  box-shadow:var(--shadow);
  transition:.15s;
  cursor:grab;
}

.prod-card:active {
  cursor:grabbing;
}

.prod-card:hover {
  transform:scale(1.03);
}

/* Imagen dentro del mosaico */
.prod-card img {
  width:100%;
  height:170px;
  object-fit:cover;
  border-radius:14px;
  margin-bottom:10px;
}

/* T√≠tulo */
.prod-title {
  font-size:18px;
  font-weight:800;
  margin-bottom:4px;
}

/* Categor√≠a */
.prod-cat {
  font-size:13px;
  font-weight:600;
  color:#666;
  margin-bottom:6px;
}

/* Descripci√≥n */
.prod-desc {
  font-size:14px;
  line-height:1.3;
  color:#444;
  margin-bottom:10px;
}

/* Precio */
.prod-price {
  font-size:18px;
  font-weight:800;
  margin-bottom:10px;
}

/* Estado */
.prod-state {
  font-size:13px;
  font-weight:700;
  padding:6px 10px;
  border-radius:10px;
  display:inline-block;
  margin-bottom:10px;
}

.state-on {
  background:#e8f5e9;
  color:#2e7d32;
}

.state-off {
  background:#fdecea;
  color:#d32f2f;
}

/* Botonera de edici√≥n */
.prod-actions {
  display:flex;
  justify-content:space-between;
  gap:8px;
  margin-top:auto;
}

.btn-small {
  padding:8px 12px;
  border-radius:10px;
  border:1.5px solid var(--ring);
  background:#fff;
  cursor:pointer;
  font-weight:700;
  transition:.20s;
}

.btn-small:hover {
  background:#f7f7f7;
}

.btn-edit {
  border-color:#c1c1c1;
}

.btn-delete {
  color:#b30000;
  border-color:#ffcccc;
}

.btn-delete:hover {
  background:#ffefef;
}

/* ============================================
                MODAL DE PRODUCTO
============================================ */

.modal-backdrop {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal {
  background:#fff;
  width:95%;
  max-width:520px;
  padding:20px;
  border-radius:24px;
  box-shadow:0 10px 35px rgba(0,0,0,.25);
  animation:fadeIn .25s ease;
}

@keyframes fadeIn {
  from { transform:translateY(20px); opacity:0; }
  to   { transform:translateY(0); opacity:1; }
}

.modal h2 {
  margin-top:0;
  margin-bottom:14px;
  font-size:24px;
  font-weight:800;
}

.modal label {
  font-weight:700;
  margin-bottom:4px;
  display:block;
}

.modal input,
.modal textarea,
.modal select {
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1.5px solid var(--ring);
  background:#fff;
  font-size:15px;
}

.modal textarea {
  height:90px;
  resize:none;
}

.modal-footer {
  margin-top:18px;
  display:flex;
  justify-content:flex-end;
  gap:10px;
}

.btn-primary {
  background:var(--primary);
  color:#fff;
  border:1.5px solid var(--primary);
  padding:10px 16px;
  border-radius:14px;
  font-weight:800;
  cursor:pointer;
}

.btn-cancel {
  background:#fff;
  border:1.5px solid var(--ring);
  padding:10px 16px;
  border-radius:14px;
  font-weight:700;
  cursor:pointer;
}

.btn-primary:hover {
  opacity:.85;
}

/* Previsualizaci√≥n */
#prod_img_preview {
  width:100%;
  height:200px;
  object-fit:cover;
  border-radius:14px;
  margin-top:8px;
  display:none;
}

/* ============================================
         BOT√ìN "AGREGAR PRODUCTO"
============================================ */

.addProductBtn {
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:18px;
  padding:14px 20px;
  font-size:16px;
  font-weight:800;
  display:inline-flex;
  align-items:center;
  gap:8px;
  cursor:pointer;
  margin-bottom:20px;
  box-shadow:0 4px 18px rgba(0,0,0,.15);
}

.addProductBtn:hover {
  opacity:.90;
}

</style>
