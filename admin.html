<!doctype html>
<html lang="es">

<script>
const TTL_HOURS = 20;
const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

function sessionValid(){
  const ok = localStorage.getItem('rb_admin_ok') === 'true';
  const ts = Number(localStorage.getItem('rb_admin_t') || 0);
  return ok && (Date.now() - ts) < TTL_MS;
}
function bumpSession(){
  if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
}
function logout(){
  localStorage.removeItem('rb_admin_ok');
  localStorage.removeItem('rb_admin_t');
  localStorage.removeItem('rb_auth_v2');
  sessionStorage.removeItem('rb_auth_v2');
  location.replace('login.html');
}
(function requireSession(){
  if (!sessionValid()){
    const next = encodeURIComponent(
      (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
      (location.search || '') + (location.hash || '')
    );
    location.replace('login.html?next=' + next);
  } else bumpSession();
})();
['click','keydown','focus','mousemove','touchstart','scroll']
  .forEach(e => window.addEventListener(e, bumpSession, {passive:true}));
</script>

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Ä¢ Rhodes Burgers</title>
<link rel="icon" href="images/logo.png" />

<style>
/* ============================================================
   ESTILOS GLOBALES
=============================================================== */
:root{
  --primary: #625A45; 
  --text: #111; 
  --muted: #666; 
  --bg: #f8f9fa; 
  --card: #ffffff; 
  --ring: #e0e0e0; 
  --shadow: 0 4px 20px rgba(0,0,0,0.05);
  --header-h: 70px;
  --good: #2e7d32; 
  --warn: #f57c00; 
  --bad: #d32f2f; 
  --radius: 16px;
}
*{box-sizing:border-box}

html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
  -webkit-font-smoothing: antialiased;
}

/* HEADER */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: #fff;
  height: var(--header-h);
  border-bottom: 1px solid rgba(0,0,0,0.08);
  box-shadow: 0 2px 10px rgba(0,0,0,0.03);
}

.topbar {
  max-width: 1200px;
  margin: 0 auto;
  height: 100%;
  padding: 0 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
  text-decoration: none;
  color: var(--text);
  font-weight: 800;
  font-size: 18px;
  letter-spacing: -0.5px;
}
.brand img {
  width: 38px;
  height: 38px;
  border-radius: 8px;
  object-fit: cover;
}

/* NAVEGACI√ìN PRINCIPAL */
.nav-right {
  display: flex;
  align-items: center;
  gap: 8px;
}
.nav-link {
  text-decoration: none;
  color: var(--muted);
  font-weight: 600;
  font-size: 14px;
  padding: 8px 12px;
  border-radius: 8px;
  transition: all 0.2s;
}
.nav-link:hover { background: #f0f0f0; color: var(--text); }
.nav-link.active { background: var(--bg); color: var(--text); box-shadow: inset 0 0 0 1px #eee; }

.btn-logout {
  background: #ffebee;
  color: var(--bad);
  border: 1px solid #ffcdd2;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  font-size: 13px;
  margin-left: 10px;
  transition: 0.2s;
}
.btn-logout:hover { background: #ffcdd2; }

/* MAIN & CARDS */
main {
  max-width: 1200px;
  margin: 30px auto;
  padding: 0 20px;
  display: grid;
  gap: 24px;
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--ring);
}
.card.featured {
  border: 2px solid var(--primary);
  background: #fffcf8;
}

/* ESTILOS DE CONTROL DE TIENDA */
.store-bar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: space-between;
  gap: 15px;
}
.pill {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.pill.ok { background: #e8f5e9; color: var(--good); border: 1px solid #c8e6c9; }
.pill.off { background: #f5f5f5; color: #777; border: 1px solid #e0e0e0; }
.pill.blue { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }

.mini-btn {
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.2s;
}
.mini-btn:hover { opacity: 0.9; }
.mini-btn.good { background: var(--good); color: white; }
.mini-btn.bad { background: #ffebee; color: var(--bad); border:1px solid #ffcdd2; }
.mini-btn.primary { background: var(--primary); color: white; }

/* Form Elements */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}
label { display: block; margin-bottom: 6px; font-size: 13px; font-weight: 700; color: #444; }
input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--ring);
  background: #fff;
  font-size: 14px;
  font-family: inherit;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(98,90,69, 0.1);
}

/* Checkbox bonito */
.check-row {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f9f9f9;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #eee;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: #555;
    transition: all 0.2s;
}
.check-row:hover { background: #fff; border-color: var(--primary); color: var(--primary); }
.check-row input { width: auto; margin: 0; cursor: pointer; accent-color: var(--primary); }

.row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 10px 18px;
  border-radius: 10px;
  border: 1px solid transparent;
  cursor: pointer;
  font-weight: 700;
  font-size: 14px;
  transition: all 0.2s;
}
.btn.primary { background: var(--primary); color: #fff; }
.btn.good { background: #e8f5e9; color: var(--good); border-color: #c8e6c9; }
.btn.warn { background: #fff3e0; color: #e65100; border-color: #ffe0b2; }
.btn.bad { background: #ffebee; color: var(--bad); border-color: #ffcdd2; }

/* Table */
.table-container { overflow-x: auto; margin-top: 15px; }
table { width: 100%; border-collapse: collapse; min-width: 600px; }
th { text-align: left; padding: 12px; font-size: 12px; text-transform: uppercase; color: var(--muted); border-bottom: 2px solid #eee; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; font-size: 14px; }
.img-preview { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; }

h2 { font-size: 20px; margin: 0 0 10px 0; color: var(--text); }
.muted { color: var(--muted); }
.text-small { font-size: 13px; }

/* üî• SEARCH & FILTER BAR */
.search-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.search-input {
    flex: 1;
    min-width: 200px;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid var(--ring);
    background: #fff;
    font-size: 14px;
}
.filter-tabs {
    display: flex;
    gap: 6px;
}
.filter-tab {
    padding: 8px 14px;
    border-radius: 8px;
    background: #fff;
    border: 1px solid var(--ring);
    color: #666;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
}
.filter-tab.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
}

/* Drag Grid */
#orderGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px,1fr));
  gap: 16px;
  margin-top: 20px;
}
.orderCard {
  background: #fff;
  border: 1px solid #eee;
  border-radius: 12px;
  overflow: hidden;
  cursor: grab;
  transition: transform 0.2s;
}
.orderCard:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.orderCard.dragging { opacity: 0.5; border: 2px dashed var(--primary); }

/* Tile Inventory */
.tile {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #fff;
  border-bottom: 1px solid #eee;
}
.tile:last-child { border-bottom: none; }
.side-pill {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  margin-bottom: 8px;
  background: #fff;
  border-radius: 10px;
  border: 1px solid #eee;
}
.side-pill.off { opacity: 0.6; background: #f5f5f5; }

/* SWITCH TOGGLE */
.switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--bad); } /* Rojo para cerrado */
input:checked + .slider:before { transform: translateX(20px); }

@media (max-width: 900px) {
  .topbar { padding: 0 15px; }
  .nav-right { display: none; } 
  .search-bar { flex-direction: column; }
  .filter-tabs { overflow-x: auto; padding-bottom: 5px; }
}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#">
      <img src="images/logo.png" alt="Logo">
      <span>Rhodes Admin</span>
    </a>

    <nav class="nav-right">
      <a class="nav-link active" href="admin.html">Admin</a>
      <a class="nav-link" href="stock.html">Stock</a>
      <a class="nav-link" href="finanzas.html">Finanzas</a>
      <a class="nav-link" href="pedido_local.html">Pedidos</a>
      <a class="nav-link" href="mostrador.html">Mostrador</a>
      <button class="btn-logout" onclick="logout()">Salir</button>
    </nav>
  </div>
</header>

<main>

<section class="card" style="border-left: 4px solid var(--primary);">
  <div class="store-bar">
    <div>
      <h2>Estado de la Tienda</h2>
      <div id="storeSub" class="text-small muted">‚Äî</div>
    </div>

    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap">
      <div id="storePill" class="pill off">CERRADO</div>

      <div style="display:flex; gap:8px">
        <button class="mini-btn good" id="btnForceOpen">Abrir Tienda</button>
        <button class="mini-btn bad" id="btnForceClose">Cerrar Tienda</button>
      </div>
    </div>
  </div>
  
  <div style="margin-top:20px; border:1px solid #ffcdd2; background:#fff5f5; padding:15px; border-radius:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <strong style="color:var(--bad)">‚õî Cierre Total (Cartel Pantalla Completa)</strong>
          <label class="switch">
              <input type="checkbox" id="swFullClose">
              <span class="slider"></span>
          </label>
      </div>
      <p class="muted" style="font-size:12px; margin-bottom:10px;">Activa esto para vacaciones o mantenimiento. Tapa toda la web.</p>
      
      <div class="form-grid">
          <div>
              <label>Mensaje del Cartel</label>
              <input type="text" id="inpCloseMsg" placeholder="Ej: Cerrado por Vacaciones üå¥">
          </div>
          <div>
              <label>Imagen de Fondo/Cartel</label>
              <input type="file" id="inpCloseImgFile" accept="image/*">
              <input type="hidden" id="inpCloseImgUrl"> </div>
      </div>
      <button class="btn bad" style="width:100%" onclick="saveFullCloseConfig()">Guardar Configuraci√≥n de Cierre</button>
  </div>

</section>

<section class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Configuraci√≥n de Precios (Extras)</h2>
        <div class="pill blue">Globales</div>
    </div>
    <p class="muted" style="margin-bottom:15px">Defin√≠ el valor que se suma al agregar estos extras.</p>
    
    <div class="form-grid" style="grid-template-columns: 1fr 1fr auto;">
        <div>
            <label>Precio Extra Carne ($)</label>
            <input id="pricePatty" type="number" placeholder="Ej: 2500">
        </div>
        <div>
            <label>Precio Extra Cheddar ($)</label>
            <input id="priceCheddar" type="number" placeholder="Ej: 300">
        </div>
        <div style="display:flex; align-items:flex-end;">
            <button id="btnSaveExtras" class="btn primary" style="height:42px;">Guardar Precios</button>
        </div>
    </div>
</section>

<section class="card featured">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
    <h2>Gesti√≥n de Productos</h2>
    <div class="pill off" style="font-weight:normal; background:#fff; border:1px solid #ddd">Modo Editor</div>
  </div>
  
  <p class="muted" style="margin-bottom:20px">
    Agreg√°, edit√° y gestion√° el cat√°logo completo.
  </p>

  <div class="form-grid">
    <div>
      <label>ID (√∫nico)</label>
      <input id="prdId" type="text" placeholder="Ej: bigjohn_simple">
    </div>

    <div>
      <label>Nombre</label>
      <input id="prdName" type="text" placeholder="Nombre del producto">
    </div>

    <div>
      <label>Categor√≠a</label>
      <select id="prdCategory">
        <option value="hamburguesas">Hamburguesas</option>
        <option value="bebidas">Bebidas</option>
        <option value="guarniciones">Guarniciones</option>
      </select>
    </div>

    <div>
      <label>Precio</label>
      <input id="prdPrice" type="number" min="0" step="1" placeholder="Ej: 4800">
    </div>

    <div>
      <label>Imagen (URL o archivo)</label>
      <input id="prdImg" type="text" placeholder="https://...">
      <input id="prdImgFile" type="file" accept="image/*" style="margin-top:8px; font-size:12px">
    </div>

    <div>
        <label>Extras Permitidos</label>
        <div style="display:flex; gap:10px; margin-top:5px">
            <label class="check-row">
                <input type="checkbox" id="prdExPatty"> ü•© Carne
            </label>
            <label class="check-row">
                <input type="checkbox" id="prdExCheddar"> üßÄ Cheddar
            </label>
        </div>
    </div>

    <div style="grid-column:1/-1">
      <label>Descripci√≥n</label>
      <textarea id="prdDesc" rows="3" placeholder="Descripci√≥n corta‚Ä¶"></textarea>
    </div>
  </div>

  <div class="row">
    <button class="btn primary" id="btnSaveProduct">Guardar / Actualizar</button>
    <button class="btn bad" id="btnClearProduct" style="background:transparent; color:#d32f2f; border:1px solid #ffcdd2">Limpiar</button>
  </div>

  <div style="height:1px; background:#eee; margin:25px 0"></div>

  <h3>Listado Actual</h3>

  <div class="search-bar">
      <input type="text" id="prdSearch" class="search-input" placeholder="üîç Buscar por nombre o ID...">
      <div class="filter-tabs" id="prdFilters">
          <div class="filter-tab active" data-f="all">Todos</div>
          <div class="filter-tab" data-f="hamburguesas">Burgers</div>
          <div class="filter-tab" data-f="bebidas">Bebidas</div>
          <div class="filter-tab" data-f="guarniciones">Papas</div>
      </div>
  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>IMG</th>
          <th>Nombre</th>
          <th>Cat.</th>
          <th>Precio</th>
          <th>Extras</th> 
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="prdTable"></tbody>
    </table>
  </div>
</section>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:24px;">

  <section class="card">
    <h2>Orden Visual</h2>
    <p class="muted">Arrastr√° las tarjetas para ordenar en el men√∫.</p>

    <div class="row" id="orderCatButtons" style="margin-bottom:15px; background:#f5f5f5; padding:4px; border-radius:10px; display:inline-flex;">
      <button class="mini-btn primary" data-cat="hamburguesas">Burgers</button>
      <button class="mini-btn" data-cat="bebidas" style="color:#555; background:transparent">Bebidas</button>
      <button class="mini-btn" data-cat="guarniciones" style="color:#555; background:transparent">Papas</button>
    </div>

    <div id="orderGrid"></div>

    <div style="margin-top:20px; text-align:right">
      <button class="btn primary" id="btnSaveOrder">Guardar Nuevo Orden</button>
    </div>
  </section>

  <section class="card">
    <h2>Control de Stock R√°pido</h2>
    <p class="muted">Activar/Desactivar disponibilidad inmediata.</p>
    
    <div id="invList" style="border:1px solid #eee; border-radius:12px; overflow:hidden;">
      </div>
  </section>

</div>

<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:24px;">

  <section class="card">
    <h2>Configuraci√≥n de Papas</h2>
    <p class="muted">Opciones visibles al cliente.</p>
    <div id="sidesContainer"></div>
  </section>

  <section class="card">
    <h2>Cupones de Descuento</h2>
    
    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
      <div><label>C√≥digo</label><input id="cpCode" type="text" style="text-transform:uppercase"></div>
      <div>
        <label>Tipo</label>
        <select id="cpType">
          <option value="percent">% Porcentaje</option>
          <option value="fixed">$ Monto Fijo</option>
        </select>
      </div>
      <div><label>Valor</label><input id="cpValue" type="number"></div>
      <div><label>Max Usos</label><input id="cpMaxUses" type="number"></div>
      <div><label>Desde</label><input id="cpFrom" type="date"></div>
      <div><label>Hasta</label><input id="cpTo" type="date"></div>
      <div style="grid-column:1/-1"><label>Nota interna</label><input id="cpNote" type="text"></div>
    </div>
    <button class="btn primary" id="btnCreateCp" style="width:100%">Crear Cup√≥n</button>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>C√≥digo</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Estado</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody id="cpTable"></tbody>
      </table>
    </div>
  </section>

</div>

</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // --- VARIABLES GLOBALES ---
    let editingProductImg = null;
    let ALL_PRODUCTS_DATA = []; 
    let FILTER_CAT = "all";
    let FILTER_TXT = "";
    let ORDER_PRODUCTS = [];
    let CURRENT_CAT = "hamburguesas";
    let MENU_ORDER = {};
    let STORE_CONFIG = {};

    // --- FIREBASE INIT ---
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); } catch(e){}
    const db = firebase.firestore();
    const productsCol = db.collection('products');

    /* ============================================================
       HELPERS & FUNCIONES GENERALES
    =============================================================== */
    const $ = s => document.querySelector(s);
    function fmtHM(h,m){ return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"); }

    /* 1. AUTO DETECT KIND */
    function autoDetectKind(id, name = "", desc = "") {
      id    = id.toLowerCase();
      name = (name || "").toLowerCase();
      desc = (desc || "").toLowerCase();
      if (id.includes("_doble"))  return "doble";
      if (id.includes("_simple")) return "simple";
      if (id.includes("_pollo"))  return "pollo";
      if (name.includes("doble")) return "doble";
      if (name.includes("pollo")) return "pollo";
      if (desc.includes("doble")) return "doble";
      if (desc.includes("pollo")) return "pollo";
      return "simple"; 
    }

    /* 2. File to Base64 */
    async function fileToBase64(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    /* 3. SAVE PRODUCT */
    async function saveProduct(){
      const id = $('#prdId').value.trim();
      const name = $('#prdName').value.trim();
      const category = $('#prdCategory').value.trim();
      const price = Number($('#prdPrice').value || 0);
      const urlImg = $('#prdImg').value.trim();
      const desc = $('#prdDesc').value.trim();
      
      const exPatty = $('#prdExPatty').checked;
      const exCheddar = $('#prdExCheddar').checked;

      const file = $('#prdImgFile').files[0];

      if(!id){ alert("Ingres√° un ID"); return; }
      if(!name){ alert("Ingres√° un nombre"); return; }
      if(!(price>0)){ alert("Precio inv√°lido"); return; }

      let finalImg = urlImg; 
      if(file){
        finalImg = await fileToBase64(file);
      } else if(!finalImg && editingProductImg){
        finalImg = editingProductImg;
      }

      const payload = {
        name, category, price,
        img: finalImg,
        description: desc || null,
        available: true,
        allowedExtras: {
            patty: exPatty,
            cheddar: exCheddar
        },
        kind: autoDetectKind(id, name, desc),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try{
        await productsCol.doc(id).set(payload, {merge:true});
        alert("Producto guardado correctamente.");
        clearProductForm();
      }catch(e){
        console.error(e);
        alert("Error al guardar.");
      }
    }

    /* 4. CLEAR FORM */
    function clearProductForm(){
      $('#prdId').value = '';
      $('#prdName').value = '';
      $('#prdCategory').value = 'hamburguesas';
      $('#prdPrice').value = '';
      $('#prdImg').value = '';
      $('#prdImgFile').value = '';
      $('#prdDesc').value = '';
      $('#prdExPatty').checked = false;
      $('#prdExCheddar').checked = false;
      editingProductImg = null; 
    }

    /* 5. LOAD FORM */
    function loadProductIntoForm(data, id){
      $('#prdId').value = id;
      $('#prdName').value = data.name || '';
      $('#prdCategory').value = data.category || 'hamburguesas';
      $('#prdPrice').value = data.price || '';
      
      editingProductImg = data.img || null;
      $('#prdImg').value = (data.img && !data.img.startsWith("data:")) ? data.img : '';
      $('#prdImgFile').value = '';
      $('#prdDesc').value = data.description || '';
      
      const extras = data.allowedExtras || {};
      $('#prdExPatty').checked = !!extras.patty;
      $('#prdExCheddar').checked = !!extras.cheddar;

      window.scrollTo({top:0, behavior:'smooth'});
    }

    /* 6. DELETE */
    async function deleteProduct(id){
      if(!confirm("¬øEliminar "+id+"?")) return;
      try{ await productsCol.doc(id).delete(); }catch(e){ alert("Error al eliminar."); }
    }

    /* 7. TOGGLE AVAILABILITY */
    async function toggleProductAvailability(id, current){
      try{
        await productsCol.doc(id).set({
          available: !current,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        },{merge:true});
      }catch(e){ alert("Error."); }
    }

    /* 8. RENDER TABLE */
    function renderProductsTable(snapshot){
      ALL_PRODUCTS_DATA = [];
      snapshot.forEach(doc => {
          ALL_PRODUCTS_DATA.push({ id: doc.id, ...doc.data() });
      });
      applyFilters();
    }

    function applyFilters(){
        const tbody = $('#prdTable');
        if(!tbody) return;
        tbody.innerHTML = '';

        const filtered = ALL_PRODUCTS_DATA.filter(p => {
            const matchCat = FILTER_CAT === "all" || p.category === FILTER_CAT;
            const txt = FILTER_TXT.toLowerCase();
            const matchTxt = !txt || p.name.toLowerCase().includes(txt) || p.id.toLowerCase().includes(txt);
            return matchCat && matchTxt;
        });

        filtered.forEach(p=>{
            const tr = document.createElement('tr');
            
            const imgTag = p.img 
              ? `<img src="${p.img}" class="img-preview">` 
              : `<div class="img-preview"></div>`;

            const availableTag = p.available
              ? `<span class="pill ok">Activo</span>`
              : `<span class="pill off">Pausado</span>`;

            let exIcons = "";
            const ex = p.allowedExtras || {};
            if(ex.patty) exIcons += "ü•© ";
            if(ex.cheddar) exIcons += "üßÄ";
            if(!exIcons) exIcons = '<span style="color:#ccc; font-size:12px">-</span>';

            tr.innerHTML = `
              <td><strong>${p.id}</strong></td>
              <td>${imgTag}</td>
              <td>${p.name}</td>
              <td>${p.category}</td>
              <td>$${p.price}</td>
              <td>${exIcons}</td>
              <td>${availableTag}</td>
              <td class="row">
                <button class="mini-btn good" data-act="edit" data-id="${p.id}">Editar</button>
                <button class="mini-btn warn" data-act="toggle" data-id="${p.id}" data-av="${p.available}">
                  ${p.available ? "Pausar" : "Activar"}
                </button>
                <button class="mini-btn bad" data-act="delete" data-id="${p.id}">Borrar</button>
              </td>
            `;
            tbody.appendChild(tr);
        });

        tbody.querySelectorAll("button").forEach(btn=>{
            btn.onclick = async()=>{
              const id = btn.dataset.id;
              const act = btn.dataset.act;
              if(act === "edit"){
                const d = await productsCol.doc(id).get();
                loadProductIntoForm(d.data(), id);
              } else if(act === "toggle"){
                toggleProductAvailability(id, btn.dataset.av === "true");
              } else if(act === "delete"){
                deleteProduct(id);
              }
            };
        });
    }

    /* 9. INVENTORY LIST RENDER */
    function renderInventory(list){
      const c = $('#invList');
      if(!c) return;
      c.innerHTML = '';
      list.forEach(p => {
          const on = p.available!==false;
          const d = document.createElement('div');
          d.className = 'tile';
          d.innerHTML = `<span>${p.name}</span> <button class="mini-btn ${on?'bad':'good'}" onclick="toggleProductAvailability('${p.id}', ${on})">${on?'Quitar':'Poner'}</button>`;
          c.appendChild(d);
      });
    }

    // üî• INICIALIZACI√ìN DE EVENTOS (AL FINAL)
    document.addEventListener("DOMContentLoaded", () => {
        
        // Listeners Products
        productsCol.onSnapshot(snap => {
            renderProductsTable(snap);
            // Also update inventory list
            const list = snap.docs.map(d=>({id:d.id, ...d.data()}));
            renderInventory(list);
        });
        
        $('#btnSaveProduct').onclick = saveProduct;
        $('#btnClearProduct').onclick = clearProductForm;

        // Listeners Search
        $('#prdSearch').addEventListener('input', (e) => {
            FILTER_TXT = e.target.value;
            applyFilters();
        });
        document.querySelectorAll('#prdFilters .filter-tab').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('#prdFilters .filter-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                FILTER_CAT = btn.dataset.f;
                applyFilters();
            };
        });

        // --- STORE CONFIG ---
        const storeRef = db.collection("config").doc("store");
        
        storeRef.onSnapshot(doc => {
            STORE_CONFIG = doc.data() || {};
            
            // Apertura normal
            const open = !!STORE_CONFIG.forceOpen;
            const pill = $('#storePill');
            if (open) {
                pill.className = "pill ok"; pill.textContent = "ABIERTO (Forzado)";
            } else {
                pill.className = "pill off"; pill.textContent = "CERRADO / AUTO";
            }

            // Cierre Total
            $('#swFullClose').checked = !!STORE_CONFIG.forceClose;
            if(document.activeElement !== $('#inpCloseMsg')) $('#inpCloseMsg').value = STORE_CONFIG.closedMessage || '';
            $('#inpCloseImgUrl').value = STORE_CONFIG.closedImage || '';
        });

        $('#btnForceOpen').onclick = async () => {
            await storeRef.set({ forceOpen: true }, {merge:true});
        };
        $('#btnForceClose').onclick = async () => {
            await storeRef.set({ forceOpen: false }, {merge:true});
        };

        window.saveFullCloseConfig = async () => {
            const isClosed = $('#swFullClose').checked;
            const msg = $('#inpCloseMsg').value;
            const file = $('#inpCloseImgFile').files[0];
            
            let imgBase64 = $('#inpCloseImgUrl').value;
            if(file) imgBase64 = await fileToBase64(file);

            await storeRef.set({
                forceClose: isClosed,
                closedMessage: msg,
                closedImage: imgBase64
            }, {merge:true});
            
            alert("‚úÖ Configuraci√≥n de cierre guardada.");
        };

        // --- PRECIOS EXTRAS ---
        const pricesRef = db.collection("config").doc("prices");
        pricesRef.onSnapshot(doc => {
            const d = doc.data() || {};
            if(document.activeElement !== $('#pricePatty')) $('#pricePatty').value = d.patty || 2500;
            if(document.activeElement !== $('#priceCheddar')) $('#priceCheddar').value = d.cheddar || 300;
        });

        $('#btnSaveExtras').onclick = async () => {
            const pPatty = Number($('#pricePatty').value);
            const pCheddar = Number($('#priceCheddar').value);
            if(!pPatty || !pCheddar) { alert("Ingres√° ambos precios"); return; }
            await pricesRef.set({ patty: pPatty, cheddar: pCheddar }, {merge:true});
            alert("Precios actualizados.");
        };

        // --- SIDES (PAPAS) ---
        const sidesRef = db.collection("config").doc("sides");
        sidesRef.onSnapshot(doc => {
            const d = doc.data() || {};
            const c = $('#sidesContainer');
            c.innerHTML = '';
            const map = {con_sazon:"Sazonadas", con_sal:"Con Sal", sin_sal:"Sin Sal"};
            for(const [k, label] of Object.entries(map)){
                const on = d[k] !== false;
                const div = document.createElement('div');
                div.className = `side-pill ${on?'':'off'}`;
                div.innerHTML = `
                    <b>${label}</b>
                    <button class="mini-btn ${on?'bad':'good'}" onclick="toggleSide('${k}', ${on})">${on?'Desactivar':'Activar'}</button>
                `;
                c.appendChild(div);
            }
        });
        window.toggleSide = async (k, current) => {
            await sidesRef.set({[k]: !current}, {merge:true});
        };

        // --- CUPONES ---
        const couponsRef = db.collection("coupons");
        couponsRef.onSnapshot(snap => {
            const t = $('#cpTable');
            t.innerHTML = '';
            snap.forEach(doc => {
                const c = doc.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.code}</td><td>$${c.amount}</td>
                    <td><span class="pill ${c.active?'ok':'off'}">${c.active?'ON':'OFF'}</span></td>
                    <td>
                        <button class="mini-btn warn" onclick="toggleCoupon('${doc.id}', ${c.active})">I/O</button>
                        <button class="mini-btn bad" onclick="delCoupon('${doc.id}')">X</button>
                    </td>
                `;
                t.appendChild(tr);
            });
        });

        $('#btnCreateCp').onclick = async () => {
            const code = $('#cpCode').value.toUpperCase();
            const amount = Number($('#cpValue').value);
            if(!code || !amount) return alert("Faltan datos");
            await couponsRef.add({code, amount, active:true});
            $('#cpCode').value=''; $('#cpValue').value='';
        };
        window.toggleCoupon = async (id, st) => await couponsRef.doc(id).update({active:!st});
        window.delCoupon = async (id) => { if(confirm("Borrar?")) await couponsRef.doc(id).delete(); };

        // --- ORDEN VISUAL ---
        const menuOrderRef = db.collection("config").doc("menuOrder");
        menuOrderRef.onSnapshot(s => {
            MENU_ORDER = s.exists ? s.data() : {};
            renderOrderGrid();
        });

        function renderOrderGrid(){
            const grid = $('#orderGrid');
            grid.innerHTML = '';
            const list = ALL_PRODUCTS_DATA.filter(p=>p.category === CURRENT_CAT);
            const order = MENU_ORDER[CURRENT_CAT] || [];
            
            list.sort((a,b)=>{
                const ia = order.indexOf(a.id); const ib = order.indexOf(b.id);
                if(ia===-1) return 1; if(ib===-1) return -1;
                return ia - ib;
            });

            list.forEach(p => {
                const d = document.createElement('div');
                d.className = 'orderCard';
                d.draggable = true;
                d.dataset.id = p.id;
                d.innerHTML = `<div style="padding:10px; font-size:12px; font-weight:bold; text-align:center">${p.name}</div>`;
                
                d.addEventListener('dragstart', () => d.classList.add('dragging'));
                d.addEventListener('dragend', () => d.classList.remove('dragging'));
                grid.appendChild(d);
            });
        }
        
        $('#orderGrid').addEventListener('dragover', e => {
            e.preventDefault();
            const dragging = document.querySelector('.dragging');
            const siblings = [...document.querySelectorAll('.orderCard:not(.dragging)')];
            const next = siblings.find(s => e.clientY <= s.getBoundingClientRect().top + s.offsetHeight/2);
            $('#orderGrid').insertBefore(dragging, next);
        });

        $('#btnSaveOrder').onclick = async () => {
            const ids = [...document.querySelectorAll('.orderCard')].map(c => c.dataset.id);
            await menuOrderRef.set({[CURRENT_CAT]: ids}, {merge:true});
            alert("Orden guardada");
        };

        document.querySelectorAll('#orderCatButtons button').forEach(btn => {
            btn.onclick = () => {
                CURRENT_CAT = btn.dataset.cat;
                document.querySelectorAll('#orderCatButtons button').forEach(b=>{
                    b.className = 'mini-btn';
                    b.style.color = "#555";
                    b.style.background = "transparent";
                });
                btn.className = 'mini-btn primary';
                btn.style.color = "#fff";
                btn.style.background = "var(--primary)";
                renderOrderGrid();
            }
        });
    });

    // Funciones globales necesarias fuera del DOMContentLoaded
    window.logout = () => {
      localStorage.removeItem('rb_admin_ok');
      location.replace('login.html');
    };
</script>
</body>
</html>
