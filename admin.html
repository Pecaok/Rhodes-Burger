<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#5b5b5b; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 10px 28px rgba(0,0,0,.08);
      --ok:#2e7d32; --warn:#fb8c00; --bad:#d32f2f;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    img{max-width:100%;display:block}

    /* Header */
    header{position:sticky;top:0;z-index:20;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:800;gap:10px}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700;text-decoration:none;color:inherit}
    .btn.primary,.btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .btn.danger{border-color:#ffd7d7;background:#fff5f5;color:#b00020}

    /* Layout */
    .container{max-width:1200px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1.2fr 2fr;gap:18px}
    @media (max-width:980px){ .container{grid-template-columns:1fr} }

    h1{font-size:28px;margin:8px 0 14px}
    h2{font-size:20px;margin:0 0 8px}
    p.muted, .muted{color:var(--muted)}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .row{display:flex;gap:10px;align-items:center}
    .row.stretch{align-items:stretch}
    .spacer{flex:1}

    /* Switch */
    .switch{position:relative;display:inline-block;width:50px;height:28px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;inset:0;background:#ddd;transition:.2s;border-radius:999px}
    .slider:before{content:"";position:absolute;height:22px;width:22px;left:3px;top:3px;background:white;transition:.2s;border-radius:50%}
    input:checked + .slider{background:var(--primary)}
    input:checked + .slider:before{transform:translateX(22px)}

    .field{margin:10px 0}
    input[type="text"], textarea, select{
      width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px;background:#fff
    }
    textarea{min-height:92px;resize:vertical}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);background:#fafafa;border-radius:999px;padding:6px 10px;font-size:12px}
    .tag.ok{border-color:#cfe8d1;background:#edf8ee;color:#1b5e20}
    .tag.warn{border-color:#ffe8c7;background:#fff7e6;color:#6a4200}

    /* Products grid */
    .grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:14px}
    @media (max-width:720px){ .grid{grid-template-columns:1fr} }
    .prod{display:flex;gap:12px;align-items:center;border:1px solid var(--ring);border-radius:16px;padding:10px 12px}
    .prod img{width:72px;height:72px;border-radius:12px;object-fit:cover;background:#f2f2f2}
    .prod .title{font-weight:800}
    .prod .price{font-weight:800}
    .prod .flex{flex:1}

    .hr{height:1px;background:#efefef;margin:12px 0}

    /* Footer note */
    .hint{font-size:12px;color:#818181;margin-top:4px}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="admin.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <nav>
        <a class="btn" href="pedido_local.html" title="Ver pedidos">üì¶ Pedidos</a>
        <a class="btn" href="finanzas.html" title="Ver finanzas">üìà Finanzas</a>
        <a class="btn" href="mostrador.html" title="Abrir mostrador">üßæ Mostrador</a>
        <a class="btn active" href="admin.html" title="Panel admin">‚öôÔ∏è Admin</a>
        <button id="btnLogout" class="btn danger">‚èª Cerrar sesi√≥n</button>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Columna izquierda: Apertura especial -->
    <section class="card">
      <h2>Apertura especial</h2>
      <p class="muted" style="margin-top:2px">
        Permite **forzar** el local como abierto por fuera del horario.
      </p>

      <div class="field">
        <label class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:800">Forzar ‚ÄúAbierto‚Äù</div>
            <div class="hint">Escribe un mensaje corto (opcional) que ver√° el cliente.</div>
          </div>
          <label class="switch">
            <input id="chkForceOpen" type="checkbox">
            <span class="slider"></span>
          </label>
        </label>
      </div>

      <div class="field">
        <input id="txtForceMsg" type="text" placeholder="Ej: apertura especial / partido / feriado, etc.">
      </div>

      <div class="actions">
        <button id="btnSaveOpen" class="btn primary">Guardar</button>
        <span id="saveOpenState" class="tag" style="display:none"></span>
      </div>

      <div class="hr"></div>
      <div class="tag warn">Sugerencia</div>
      <div class="hint">Si lo dejas desactivado, se mostrar√° el estado normal seg√∫n los horarios.</div>
    </section>

    <!-- Columna derecha: Disponibilidad de productos -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <h2>Disponibilidad de productos</h2>
          <div class="hint">Marca en ‚ÄúDisponible‚Äù para que se pueda vender.</div>
        </div>
        <div class="tag ok" id="prodCount">‚Äî</div>
      </div>

      <div id="prodGrid" class="grid" style="margin-top:8px"></div>
      <div class="actions">
        <button id="btnRefresh" class="btn ghost">Actualizar</button>
      </div>
    </section>
  </main>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  /* ======== SESI√ìN simple (igual a login.html) ======== */
  const TTL_HOURS = 20;
  const TTL_MS = TTL_HOURS * 60 * 60 * 1000;
  function sessionValid(){
    const ok = localStorage.getItem('rb_admin_ok')==='true';
    const ts = Number(localStorage.getItem('rb_admin_t')||0);
    return ok && (Date.now()-ts) < TTL_MS;
  }
  function bumpSession(){ if(sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now())); }
  function logout(){ localStorage.clear(); location.replace('login.html?reason=logout&next=admin.html'); }
  if(!sessionValid()){
    const next = encodeURIComponent('admin.html'+(location.search||'')+(location.hash||''));
    location.replace('login.html?next='+next);
  }else{ bumpSession(); }
  ['click','keydown','focus','mousemove','touchstart','scroll'].forEach(e=>addEventListener(e,bumpSession,{passive:true}));
  document.getElementById('btnLogout').onclick = logout;

  /* ======== Firebase ======== */
  const firebaseConfig = {
    apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain: "rhodes-burguers.firebaseapp.com",
    projectId: "rhodes-burguers",
    storageBucket: "rhodes-burguers.firebasestorage.app",
    messagingSenderId: "951646688091",
    appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig) }catch(_){}
  const db = firebase.firestore();

  const $ = s => document.querySelector(s);
  const prodGrid = $('#prodGrid');
  const prodCount = $('#prodCount');
  const saveOpenState = $('#saveOpenState');

  /* ======== Apertura especial (NO cambia la estructura) ======== */
  async function loadStoreFlag(){
    try{
      const snap = await db.collection('config').doc('store').get();
      const d = snap.exists ? (snap.data()||{}) : {};
      $('#chkForceOpen').checked = !!d.forceOpen;
      $('#txtForceMsg').value = d.forceOpenMessage || '';
    }catch(e){ console.warn(e); }
  }
  async function saveStoreFlag(){
    saveOpenState.style.display='inline-flex';
    saveOpenState.textContent = 'Guardando‚Ä¶';
    try{
      await db.collection('config').doc('store').set({
        forceOpen: $('#chkForceOpen').checked,
        forceOpenMessage: $('#txtForceMsg').value.trim()
      }, { merge:true });
      saveOpenState.className='tag ok';
      saveOpenState.textContent='Guardado';
      setTimeout(()=>{ saveOpenState.style.display='none'; }, 1400);
    }catch(e){
      saveOpenState.className='tag';
      saveOpenState.textContent='Error';
      console.error(e);
    }
  }
  $('#btnSaveOpen').onclick = saveStoreFlag;

  /* ======== Productos (NO cambia la estructura) ======== */
  function renderProductCard(id, data){
    const name = data.name || id;
    const price = Number(data.price||0);
    const img = data.img || 'images/logo.png';
    const available = data.available !== false;

    const card = document.createElement('div');
    card.className='prod';
    card.innerHTML = `
      <img src="${img}" alt="">
      <div class="flex">
        <div class="title">${name}</div>
        <div class="muted" style="margin-top:2px">${data.desc ? data.desc : ''}</div>
        <div class="hint" style="margin-top:6px">ID: <code>${id}</code></div>
      </div>
      <div style="text-align:right">
        <div class="price">$ ${price.toLocaleString('es-AR',{maximumFractionDigits:0})}</div>
        <div class="row" style="margin-top:6px;justify-content:flex-end">
          <label class="switch">
            <input type="checkbox" ${available?'checked':''} data-id="${id}">
            <span class="slider"></span>
          </label>
        </div>
      </div>
    `;
    // toggle
    const input = card.querySelector('input[type="checkbox"]');
    input.addEventListener('change', async (e)=>{
      const on = e.target.checked;
      e.target.disabled = true;
      try{
        await db.collection('products').doc(id).set({ available:on }, { merge:true });
      }catch(err){ console.error(err); e.target.checked = !on; }
      finally{ e.target.disabled = false; }
    });
    return card;
  }

  let unsubProds = null;
  function subscribeProducts(){
    if (unsubProds) { try{unsubProds()}catch(_){ } }
    unsubProds = db.collection('products').onSnapshot(snap=>{
      prodGrid.innerHTML='';
      let n=0;
      snap.forEach(doc=>{
        n++;
        prodGrid.appendChild(renderProductCard(doc.id, doc.data()||{}));
      });
      prodCount.textContent = `${n} productos`;
    }, err=>{
      console.error(err);
    });
  }
  $('#btnRefresh').onclick = ()=>subscribeProducts();

  // Init
  loadStoreFlag();
  subscribeProducts();
  </script>
</body>
</html>
