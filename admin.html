<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />

  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6;
      --card:#fff; --ring:#eaeaea; --shadow:0 10px 30px rgba(0,0,0,.08);
      --good:#2e7d32; --warn:#f9a825; --bad:#d32f2f;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    header{
      position:sticky;top:0;z-index:20;background:#fff;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .topbar{
      max-width:1200px;margin:0 auto;padding:10px 12px;
      display:flex;align-items:center;gap:12px;
    }
    .brand{
      display:flex;align-items:center;font-weight:800;
      text-decoration:none;color:inherit
    }
    .brand img{
      width:36px;height:36px;border-radius:10px;
      background:#fff;object-fit:contain;margin-right:8px
    }
    .spacer{flex:1}
    .btn{
      display:inline-flex;align-items:center;gap:8px;
      border:1.5px solid var(--ring);background:#fff;
      padding:8px 12px;border-radius:12px;cursor:pointer;
      font-weight:700;text-decoration:none;color:inherit;
    }
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.bad{background:#ffefef;border-color:#ffdede;color:#a40000}

    main{
      max-width:1200px;margin:22px auto;padding:0 12px;
      display:grid;grid-template-columns:1fr;gap:20px;
    }
    .card{
      background:var(--card);padding:20px;border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    h2{margin:0 0 14px;font-size:22px}

    /* Categor√≠as */
    .cat-item{
      border:1.5px solid var(--ring);padding:12px;
      border-radius:14px;background:#fff;
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:10px;cursor:grab;
    }
    .cat-name{font-weight:700}

    /* Productos */
    .prod-item{
      border:1.5px solid var(--ring);background:#fff;
      padding:12px;border-radius:14px;cursor:grab;
      display:flex;align-items:center;gap:12px;margin-bottom:10px;
    }
    .prod-thumb{width:70px;height:70px;border-radius:12px;object-fit:cover}
    .switch{
      position:relative;width:46px;height:24px;background:#ddd;
      border-radius:20px;cursor:pointer;transition:.25s;
    }
    .switch::after{
      content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;
      background:#fff;border-radius:50%;transition:.25s;
    }
    .switch.on{background:var(--good)}
    .switch.on::after{transform:translateX(22px)}

    /* Modal */
    .modal-bg{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:flex;align-items:center;justify-content:center;
      backdrop-filter:blur(2px);z-index:1000;
    }
    .modal{
      background:#fff;padding:20px;border-radius:16px;
      width:95%;max-width:420px;box-shadow:var(--shadow);
      position:relative;
    }
    .close-x{
      position:absolute;right:14px;top:10px;font-size:22px;
      background:none;border:none;cursor:pointer;
    }
    .input,select{
      width:100%;padding:10px;border-radius:12px;
      border:1.5px solid var(--ring);margin-bottom:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <a class="brand"><img src="images/logo.png">Admin ‚Ä¢ Rhodes Burgers</a>
    <div class="spacer"></div>

    <a href="index.html" class="btn">Ir al men√∫</a>
    <button id="logoutBtn" class="btn bad">Salir</button>
  </div>
</header>

<main>

  <!-- PANEL HORARIO üìÖ (Como mostrador) -->
  <section class="card">
    <h2>Estado del local</h2>
    <div class="row" style="display:flex;gap:16px;align-items:center">

      <button id="forceOpenBtn" class="btn primary">Forzar abierto</button>
      <button id="forceCloseBtn" class="btn bad">Desactivar</button>

      <input type="datetime-local" id="forceUntilInput" class="input" style="max-width:200px">
      <button id="saveUntilBtn" class="btn primary">Guardar</button>

    </div>
    <p id="storeStatus" class="muted" style="margin-top:8px">‚Äî</p>
  </section>

  <!-- CATEGOR√çAS -->
  <section class="card">
    <h2>Categor√≠as</h2>

    <div style="display:flex;gap:10px;margin-bottom:10px">
      <input id="newCategoryInput" class="input" placeholder="Nueva categor√≠a">
      <button id="addCategoryBtn" class="btn primary">Agregar</button>
    </div>

    <div id="catList"></div>
  </section>

  <!-- PRODUCTOS -->
  <section class="card">
    <h2>Productos</h2>
    <button id="addProductBtn" class="btn primary">Crear producto</button>
    <div id="prodList" style="margin-top:14px"></div>
  </section>
  <!-- ================= MODAL: CATEGOR√çA ================= -->
  <div id="modalCategory" class="modal-bg">
    <div class="modal">
      <button class="close-x" onclick="closeCategoryModal()">√ó</button>
      <h3 id="catModalTitle">Categor√≠a</h3>

      <label>Nombre</label>
      <input id="catModalName" class="input" placeholder="Nombre">

      <div style="display:flex;gap:10px;margin-top:10px">
        <button id="catModalDelete" class="btn bad">Eliminar</button>
        <button id="catModalSave" class="btn primary">Guardar</button>
      </div>
    </div>
  </div>


  <!-- ================= MODAL: PRODUCTO ================= -->
  <div id="modalProduct" class="modal-bg">
    <div class="modal">
      <button class="close-x" onclick="closeProductModal()">√ó</button>
      <h3 id="prodModalTitle">Producto</h3>

      <label>Nombre</label>
      <input id="prodName" class="input" placeholder="Nombre">

      <label>Precio</label>
      <input id="prodPrice" class="input" type="number" placeholder="Precio">

      <label>Categor√≠a</label>
      <select id="prodCategory" class="input"></select>

      <label>Imagen</label>
      <input id="prodImg" class="input" type="file" accept="image/*">
      <img id="prodPreview" style="width:100%;height:180px;object-fit:cover;border-radius:14px;margin-top:8px;display:none">

      <label>Estado</label>
      <div id="prodAvailableSwitch" class="switch"></div>

      <div style="display:flex;gap:10px;margin-top:16px">
        <button id="prodModalDelete" class="btn bad">Eliminar</button>
        <button id="prodModalSave" class="btn primary">Guardar</button>
      </div>
    </div>
  </div>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* ===================== FIREBASE ===================== */
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
try { firebase.initializeApp(firebaseConfig); } catch(e){}
const db = firebase.firestore();
const storage = firebase.storage();

/* ===================== HELPERS ===================== */
const $ = s => document.querySelector(s);
const genId = () => Math.random().toString(36).substring(2,10);


/* ==========================================================
   ======================== MODALES ==========================
   ========================================================== */

function openCategoryModal(cat){
  $("#modalCategory").style.display = "flex";

  if(cat){
    window.__editCategory = cat;
    $("#catModalTitle").textContent = "Editar categor√≠a";
    $("#catModalName").value = cat.name;
    $("#catModalDelete").style.display = "inline-flex";
  } else {
    window.__editCategory = null;
    $("#catModalTitle").textContent = "Nueva categor√≠a";
    $("#catModalName").value = "";
    $("#catModalDelete").style.display = "none";
  }
}

function closeCategoryModal(){
  $("#modalCategory").style.display = "none";
}

function openProductModal(prod){
  $("#modalProduct").style.display = "flex";

  loadCategoriesIntoSelect();

  if(prod){
    window.__editProduct = prod;
    $("#prodModalTitle").textContent = "Editar producto";
    $("#prodName").value = prod.name;
    $("#prodPrice").value = prod.price;
    $("#prodCategory").value = prod.category;
    $("#prodPreview").src = prod.img || "";
    $("#prodPreview").style.display = prod.img ? "block":"none";
    $("#prodModalDelete").style.display = "inline-flex";

    renderAvailableSwitch(prod.available);
  } else {
    window.__editProduct = null;
    $("#prodModalTitle").textContent = "Nuevo producto";
    $("#prodName").value = "";
    $("#prodPrice").value = "";
    $("#prodCategory").value = "";
    $("#prodPreview").style.display = "none";
    $("#prodModalDelete").style.display = "none";

    renderAvailableSwitch(true);
  }
}

function closeProductModal(){
  $("#modalProduct").style.display = "none";
}


/* ==========================================================
   ======================== SWITCH STOCK ======================
   ========================================================== */

function renderAvailableSwitch(v){
  $("#prodAvailableSwitch").innerHTML = `
    <label class="switch-wrap">
      <input type="checkbox" id="prodAvailable" ${v ? "checked":""}>
      <span class="switch-slider"></span>
      <span style="margin-left:8px;font-weight:700;">${v ? "Disponible":"Sin stock"}</span>
    </label>
  `;

  $("#prodAvailable").onchange = e=>{
    const lbl = $("#prodAvailableSwitch span:last-child");
    lbl.textContent = e.target.checked ? "Disponible" : "Sin stock";
  };
}


/* ==========================================================
   ======================== CATEGOR√çAS CRUD ==================
   ========================================================== */

async function addCategory(){
  const name = $("#newCategoryName").value.trim();
  if(!name) return alert("Ingres√° un nombre");

  await db.collection("categories").add({
    name,
    order: window.__categories.length,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  $("#newCategoryName").value = "";
}

async function saveCategory(){
  const name = $("#catModalName").value.trim();
  if(!name) return alert("Nombre inv√°lido");

  const cat = window.__editCategory;

  if(!cat){
    await db.collection("categories").add({
      name,
      order: window.__categories.length,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  } else {
    await db.collection("categories").doc(cat.id).set({ name }, {merge:true});
  }

  closeCategoryModal();
}

async function deleteCategory(){
  const cat = window.__editCategory;
  if(!cat) return;
  if(!confirm("¬øEliminar categor√≠a?")) return;

  await db.collection("categories").doc(cat.id).delete();
  closeCategoryModal();
}


/* ==========================================================
   ============== ORDENAR CATEGOR√çAS (DRAG) ==================
   ========================================================== */

let dragCat = null;

function renderCategories(){
  const host = $("#catList");
  host.innerHTML = "";

  window.__categories
    .sort((a,b)=> a.order - b.order)
    .forEach(cat=>{
      const el = document.createElement("div");
      el.className = "cat-item";
      el.draggable = true;

      el.innerHTML = `
        <div>
          <div class="cat-name">${cat.name}</div>
          <div class="cat-id">${cat.id}</div>
        </div>
        <button class="btn" onclick='openCategoryModal(${JSON.stringify(cat)})'>Editar</button>
      `;

      el.addEventListener("dragstart", ()=> dragCat = cat);
      el.addEventListener("dragover", e=> e.preventDefault());
      el.addEventListener("drop", async ()=>{
        if(dragCat && dragCat.id !== cat.id){
          const temp = dragCat.order;
          dragCat.order = cat.order;
          cat.order = temp;

          await db.collection("categories").doc(dragCat.id).set({order: dragCat.order},{merge:true});
          await db.collection("categories").doc(cat.id).set({order: cat.order},{merge:true});
        }
      });

      host.appendChild(el);
    });
}


/* ==========================================================
   ======================== PRODUCTOS CRUD ===================
   ========================================================== */

async function loadCategoriesIntoSelect(){
  const sel = $("#prodCategory");
  sel.innerHTML = "";

  window.__categories
    .sort((a,b)=> a.order - b.order)
    .forEach(cat=>{
      const op = document.createElement("option");
      op.value = cat.id;
      op.textContent = cat.name;
      sel.appendChild(op);
    });
}

async function uploadImg(file){
  if(!file) return null;

  const path = "products/" + Date.now() + "_" + file.name;
  const ref = storage.ref(path);

  await ref.put(file);

  return await ref.getDownloadURL();
}

async function saveProduct(){
  const name = $("#prodName").value.trim();
  const price = Number($("#prodPrice").value);
  const category = $("#prodCategory").value;
  const file = $("#prodImg").files[0];
  const available = $("#prodAvailable").checked;

  if(!name || !price || !category){
    return alert("Complet√° los campos obligatorios");
  }

  let img = null;

  if(file){
    img = await uploadImg(file);
  } else if(window.__editProduct){
    img = window.__editProduct.img || null;
  }

  const prod = window.__editProduct;

  if(!prod){
    await db.collection("products").add({
      name, price, category, img,
      available,
      order: window.__products.length,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  } else {
    await db.collection("products").doc(prod.id).set({
      name, price, category, img, available
    }, {merge:true});
  }

  closeProductModal();
}

async function deleteProduct(){
  const p = window.__editProduct;
  if(!p) return;
  if(!confirm("¬øEliminar producto?")) return;

  await db.collection("products").doc(p.id).delete();
  closeProductModal();
}


/* ==========================================================
   =============== ORDENAR PRODUCTOS (DRAG) ==================
   ========================================================== */

let dragProd = null;

function renderProducts(){
  const host = $("#prodList");
  host.innerHTML = "";

  const cats = window.__categories.sort((a,b)=> a.order - b.order);

  cats.forEach(cat=>{
    const title = document.createElement("h3");
    title.textContent = cat.name;
    title.style.marginTop = "18px";
    host.appendChild(title);

    window.__products
      .filter(p => p.category === cat.id)
      .sort((a,b)=> a.order - b.order)
      .forEach(prod=>{
        const el = document.createElement("div");
        el.className = "prod-card";
        el.draggable = true;

        el.innerHTML = `
          <img src="${prod.img || "images/placeholder.png"}" class="prod-img">
          <div style="font-weight:800">${prod.name}</div>
          <div class="muted">$${prod.price}</div>

          <div style="display:flex;justify-content:space-between;margin-top:6px">
            <span class="tag ${prod.available ? "green" : "gray"}">
              ${prod.available ? "Disponible" : "Sin stock"}
            </span>
            <button class="btn" onclick='openProductModal(${JSON.stringify(prod)})'>Editar</button>
          </div>
        `;

        el.addEventListener("dragstart", ()=> dragProd = prod);
        el.addEventListener("dragover", e=> e.preventDefault());
        el.addEventListener("drop", async ()=>{
          if(dragProd && dragProd.id !== prod.id){
            const temp = dragProd.order;
            dragProd.order = prod.order;
            prod.order = temp;

            await db.collection("products").doc(dragProd.id).set({order: dragProd.order},{merge:true});
            await db.collection("products").doc(prod.id).set({order: prod.order},{merge:true});
          }
        });

        host.appendChild(el);
      });
  });
}


/* ==========================================================
   ===================== SUSCRIPCIONES =======================
   ========================================================== */

function subscribeCategories(){
  db.collection("categories")
    .orderBy("order","asc")
    .onSnapshot(snap=>{
      window.__categories = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderCategories();
      renderProducts();
    });
}

function subscribeProducts(){
  db.collection("products")
    .orderBy("order","asc")
    .onSnapshot(snap=>{
      window.__products = snap.docs.map(d=>({id:d.id,...d.data()}));
      renderProducts();
    });
}


/* ==========================================================
   ====================== PREVIEW IMG ========================
   ========================================================== */

$("#prodImg").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;

  $("#prodPreview").src = URL.createObjectURL(file);
  $("#prodPreview").style.display = "block";
});


/* ==========================================================
   =========================== INIT ==========================
   ========================================================== */

document.addEventListener("DOMContentLoaded", ()=>{

  subscribeCategories();
  subscribeProducts();

  $("#addCategoryBtn").onclick = addCategory;
  $("#catModalSave").onclick = saveCategory;
  $("#catModalDelete").onclick = deleteCategory;

  $("#addProductBtn").onclick = ()=> openProductModal(null);
  $("#prodModalSave").onclick = saveProduct;
  $("#prodModalDelete").onclick = deleteProduct;

});
</script>
