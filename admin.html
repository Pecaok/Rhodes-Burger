<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 12px 34px rgba(0,0,0,.10);
      --ok:#2e7d32; --warn:#ff9800; --bad:#d32f2f;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:800}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .navbtn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;text-decoration:none;color:inherit;font-weight:600}
    .navbtn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .navbtn.danger{background:#fff5f5;border-color:#ffd7d7;color:#a10000}

    main{max-width:1100px;margin:22px auto;padding:0 12px}
    h1{font-size:28px;margin:8px 0 16px}
    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px;margin:14px 0}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 12px;font-weight:800}
    .pill.ok{border-color:#cde9ce;color:var(--ok);background:#ecf7ec}
    .pill.bad{border-color:#f6c4c4;color:#a10000;background:#fdeeee}
    .pill.warn{border-color:#ffe1a8;color:#9a6b00;background:#fff7df}
    .muted{color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.ghost{background:#fff}
    .btn.red{border-color:#ffd7d7;background:#fff5f5;color:#a10000}
    textarea,input[type="text"]{width:100%;padding:10px;border:1px solid var(--ring);border-radius:12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid var(--ring);border-radius:14px;padding:12px;background:#fff}
    .item h4{margin:0 0 4px}
    .sw{position:relative;width:46px;height:26px;border-radius:999px;background:#ddd;cursor:pointer;flex:0 0 auto;border:1px solid #ccc}
    .sw.on{background:#2e7d32;border-color:#2e7d32}
    .sw .knob{position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:left .18s}
    .sw.on .knob{left:24px}
    .err{color:#a10000;font-weight:700}
    .hint{font-size:13px;color:#666}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="">Admin</a>
      <div class="spacer"></div>
      <a class="navbtn" href="pedido_local.html">üóíÔ∏è Pedidos</a>
      <a class="navbtn" href="finanzas.html">üìä Finanzas</a>
      <a class="navbtn" href="mostrador.html" target="_blank">üñ•Ô∏è Mostrador</a>
      <button id="btnRefresh" class="navbtn">‚Üª Actualizar</button>
      <button id="btnLogout" class="navbtn danger">‚èª Cerrar sesi√≥n</button>
    </div>
  </header>

  <main>
    <h1>Panel de administraci√≥n</h1>

    <!-- Estado del local -->
    <section class="card">
      <h3>Estado del local</h3>
      <div class="row" style="margin-top:6px">
        <span id="stBadge" class="pill warn">Cargando‚Ä¶</span>
        <button class="btn" id="btnOpen">‚úÖ Abrir</button>
        <button class="btn red" id="btnClose">‚õî Cerrar</button>
        <span id="stError" class="err" style="display:none;margin-left:8px">No se pudo actualizar el estado.</span>
      </div>
      <div style="margin-top:10px">
        <label>Mensaje (opcional, visible en la web cuando est√© cerrado/abierto)</label>
        <div class="row" style="gap:8px">
          <textarea id="stMsg" placeholder="Ej: Abrimos por evento especial hasta las 00:30." rows="3"></textarea>
          <button class="btn primary" id="btnSaveMsg">Guardar mensaje</button>
          <button class="btn" id="btnClearMsg">Limpiar</button>
        </div>
        <div class="hint" style="margin-top:6px">Este estado lo usan <strong>index</strong> y <strong>mostrador</strong> para mostrar ‚ÄúAbierto/Cerrado‚Äù y habilitar el pago.</div>
      </div>
    </section>

    <!-- Disponibilidad -->
    <section class="card">
      <h3>Disponibilidad de √≠tems</h3>
      <div class="hint">Desact√≠valos cuando no haya stock. Impacta en <strong>index</strong> y <strong>mostrador</strong> (oculta/bloquea el bot√≥n).</div>

      <div id="itemsGrid" class="grid" style="margin-top:12px"></div>
      <div id="itemsError" class="err" style="display:none;margin-top:6px"></div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ==== Firebase ====
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}
    const db = firebase.firestore();

    // ==== Helpers ====
    const $ = s => document.querySelector(s);
    function ts(){ return firebase.firestore.FieldValue.serverTimestamp(); }

    // Cat√°logo (ids deben coincidir con index/mostrador)
    const ITEMS = [
      // Burgers
      { id:"bigjohn_simple",   name:"Big John Simple" },
      { id:"bigjohn_doble",    name:"Big John Doble" },
      { id:"burguesa_simple",  name:"Burguesa Simple" },
      { id:"burguesa_doble",   name:"Burguesa Doble" },
      { id:"cheesebacon_simple", name:"CheeseBacon Simple" },
      { id:"cheesebacon_doble",  name:"CheeseBacon Doble" },
      { id:"cheese_simple",    name:"Cheeseburger Simple" },
      { id:"cheese_doble",     name:"Cheeseburger Doble" },
      { id:"rhodes_simple",    name:"Rhodes Simple" },
      { id:"rhodes_doble",     name:"Rhodes Doble" },
      { id:"morgan_simple",    name:"Morgan Simple" },
      { id:"morgan_doble",     name:"Morgan Doble" },
      { id:"pollo_crispy",     name:"Pollo Crispy" },
      // Drinks (ejemplos)
      { id:"andes_rubia",      name:"Andes Rubia 473ml" },
      { id:"andes_roja",       name:"Andes Roja 473ml" },
      { id:"coca_org",         name:"Coca-Cola Original 500ml" },
      { id:"coca_zero",        name:"Coca-Cola Zero 500ml" },
      { id:"sprite",           name:"Sprite 500ml" },
      { id:"aq_pomelo",        name:"Aquarius Pomelo 500ml" },
      { id:"aq_pera",          name:"Aquarius Pera 500ml" },
      { id:"aq_manzana",       name:"Aquarius Manzana 500ml" },
      { id:"agua_sg",          name:"Agua sin gas 500ml" },
    ];

    // ==== Estado de apertura (settings/open_state) ====
    const openDocRef = db.collection('settings').doc('open_state');
    let unsubscribeOpen = null;

    function setBadge(isOpen){
      const b = $("#stBadge");
      if(isOpen===true){ b.className = "pill ok";  b.textContent = "ABIERTO"; }
      else if(isOpen===false){ b.className = "pill bad"; b.textContent = "CERRADO"; }
      else { b.className = "pill warn"; b.textContent = "Cargando‚Ä¶"; }
    }

    async function setOpenState(next){
      try{
        $("#stError").style.display='none';
        await openDocRef.set({
          isOpen: !!next,
          message: ($("#stMsg").value||"").trim(),
          updatedAt: ts()
        }, { merge:true });
      }catch(e){
        console.error(e);
        $("#stError").style.display='inline';
      }
    }

    function listenOpenState(){
      if (unsubscribeOpen) unsubscribeOpen();
      unsubscribeOpen = openDocRef.onSnapshot(snap=>{
        if(!snap.exists){ setBadge(false); return; }
        const d = snap.data()||{};
        setBadge(!!d.isOpen);
        $("#stMsg").value = d.message || "";
      }, err=>{
        console.error(err);
        $("#stError").style.display='inline';
      });
    }

    // ==== Flags de men√∫ (settings/menu_flags) ====
    const flagsRef = db.collection('settings').doc('menu_flags');
    let currentDisabled = {};  // mapa id -> bool
    let unsubscribeFlags = null;

    function itemCard(it, disabled){
      const on = !disabled;
      return `
        <div class="item" data-id="${it.id}">
          <div>
            <h4>${it.name}</h4>
            <div class="muted">ID: ${it.id}</div>
          </div>
          <div class="row" style="gap:12px">
            <span class="muted">${on? 'Activo' : 'Inactivo'}</span>
            <div class="sw ${on?'on':''}" role="switch" aria-checked="${on}">
              <div class="knob"></div>
            </div>
          </div>
        </div>`;
    }

    function renderItems(){
      const grid = $("#itemsGrid");
      const dis = currentDisabled || {};
      grid.innerHTML = ITEMS.map(it => itemCard(it, !!dis[it.id])).join("");

      // wire switches
      grid.querySelectorAll(".item .sw").forEach(sw=>{
        sw.addEventListener("click", async (ev)=>{
          const card = ev.currentTarget.closest(".item");
          const id = card.dataset.id;
          const newOn = !ev.currentTarget.classList.contains("on"); // queremos encender?
          // actualizar UI optimista
          ev.currentTarget.classList.toggle("on", newOn);
          card.querySelector(".muted").textContent = newOn? "Activo" : "Inactivo";
          // persistir mapa
          try{
            const map = Object.assign({}, currentDisabled);
            map[id] = !newOn;              // disabled = inverso de on
            // limpiar falsos (false -> eliminar key)
            if(map[id] === false) delete map[id];
            await flagsRef.set({ disabled: map, updatedAt: ts() }, { merge:true });
          }catch(e){
            console.error(e);
            $("#itemsError").textContent = "No se pudo guardar el cambio.";
            $("#itemsError").style.display='block';
          }
        });
      });
    }

    function listenFlags(){
      if (unsubscribeFlags) unsubscribeFlags();
      unsubscribeFlags = flagsRef.onSnapshot(snap=>{
        $("#itemsError").style.display='none';
        if(!snap.exists){ currentDisabled = {}; renderItems(); return; }
        const d = snap.data()||{};
        currentDisabled = (d.disabled && typeof d.disabled === 'object') ? d.disabled : {};
        renderItems();
      }, err=>{
        console.error(err);
        $("#itemsError").textContent = "Error al cargar los √≠tems.";
        $("#itemsError").style.display='block';
      });
    }

    // ==== UI events ====
    $("#btnOpen").onclick  = () => setOpenState(true);
    $("#btnClose").onclick = () => setOpenState(false);
    $("#btnSaveMsg").onclick = () => setOpenState($("#stBadge").textContent === "ABIERTO");
    $("#btnClearMsg").onclick = () => { $("#stMsg").value=""; };

    $("#btnRefresh").onclick = () => { // re-enganchar listeners
      listenOpenState();
      listenFlags();
    };

    $("#btnLogout").onclick = ()=>{
      // opcional: s√≥lo limpia flags de ‚Äúguard‚Äù si hubieran quedado
      try{
        localStorage.removeItem('rb_admin_ok');
        localStorage.removeItem('rb_admin_t');
        localStorage.removeItem('rb_auth_v2');
        sessionStorage.removeItem('rb_auth_v2');
      }catch(_){}
      location.href = "pedido_local.html";
    };

    // ==== Boot ====
    listenOpenState();
    listenFlags();
  </script>
</body>
</html>
