<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin • Rhodes Burgers</title>
    <link rel="icon" href="images/logo.png" />

    <style>
      :root{
        --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; 
        --card:#fff; --ring:#eaeaea; --shadow:0 10px 28px rgba(0,0,0,.08);
        --good:#2e7d32; --warn:#fb8c00; --bad:#d32f2f;
        --radius:18px;
      }
      *{box-sizing:border-box}
      html,body{
        margin:0;
        background:var(--bg);
        color:var(--text);
        font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif
      }
      header{
        position:sticky; top:0; z-index:20;
        background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)
      }
      .topbar{
        max-width:1200px;margin:0 auto;padding:10px 12px;
        display:flex;align-items:center;gap:12px
      }
      .brand{
        display:flex;align-items:center;
        font-weight:800;text-decoration:none;color:inherit
      }
      .brand img{
        width:36px;height:36px;border-radius:10px;
        background:#fff;object-fit:contain;margin-right:8px
      }
      .spacer{flex:1}
      .btn{
        display:inline-flex;align-items:center;gap:8px;
        border:1.5px solid var(--ring);background:#fff;
        padding:8px 12px;cursor:pointer;font-weight:700;
        border-radius:12px;text-decoration:none;color:inherit
      }
      .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
      .btn.good{background:#e9f6eb;border-color:#cfead3}
      .btn.bad{background:#fff1f1;border-color:#ffd7d7}
      .btn.warn{background:#fff6e8;border-color:#ffe1b8}

      main{
        max-width:1200px;margin:22px auto;padding:0 12px;
        display:grid;grid-template-columns:1fr;gap:22px;
      }

      .card{
        background:var(--card);box-shadow:var(--shadow);
        border-radius:var(--radius);padding:18px
      }
      h2{font-size:22px;margin:8px 0 16px}
      .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
      .muted{color:var(--muted)}

      .category-list{
        display:flex;flex-direction:column;gap:10px;margin-top:10px
      }

      .cat-item{
        padding:12px;border:1.5px solid var(--ring);
        border-radius:14px;background:#fff;
        display:flex;align-items:center;justify-content:space-between;
        cursor:grab
      }
      .cat-left{display:flex;flex-direction:column}
      .cat-name{font-weight:800;font-size:17px}
      .cat-id{font-size:12px;color:var(--muted)}

      .product-grid{
        display:grid;
        grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
        gap:14px;margin-top:14px
      }

      .prod-card{
        background:#fff;border-radius:14px;
        border:1.5px solid var(--ring);padding:12px;
        display:flex;flex-direction:column;gap:8px;
        cursor:grab
      }

      .prod-img{
        width:100%;height:150px;border-radius:12px;
        object-fit:cover;background:#eee
      }

      .input, select{
        width:100%;padding:10px;border-radius:10px;
        border:1.5px solid var(--ring);background:#fff
      }

      .modal-bg{
        display:none;position:fixed;inset:0;
        background:rgba(0,0,0,.45);backdrop-filter:blur(2px);
        align-items:center;justify-content:center;z-index:2000;
      }
      .modal{
        background:#fff;padding:20px;border-radius:16px;
        width:95%;max-width:420px;box-shadow:var(--shadow)
      }

      .close-btn{
        background:transparent;border:none;font-size:20px;
        cursor:pointer;position:absolute;right:16px;top:12px
      }
    </style>
  </head>

  <body>

    <header>
      <div class="topbar">
        <a class="brand"><img src="images/logo.png">Admin • Rhodes Burgers</a>
        <div class="spacer"></div>

        <a href="index.html" class="btn">Ir al menú</a>
        <button id="logoutBtn" class="btn bad">Salir</button>
      </div>
    </header>

    <main>

     <main class="container">

  <!-- ======================== CATEGORÍAS ======================== -->
  <section class="card">
    <h2>Categorías</h2>

    <div class="row" style="margin-bottom:10px">
      <input id="newCategoryName" type="text" placeholder="Nombre de categoría" />
      <button id="addCategoryBtn" class="btn primary">Agregar</button>
    </div>

    <div id="catList">
      <!-- Las categorías se renderizan aquí -->
    </div>

    <p class="muted">Arrastrá para reordenar</p>
  </section>


  <!-- ======================== PRODUCTOS ======================== -->
  <section class="card" style="margin-top:20px">
    <h2>Productos</h2>

    <button id="addProductBtn" class="btn primary">Crear producto</button>
    <p class="muted">Arrastrá productos dentro de su categoría para reordenar.</p>

    <div id="prodList">
      <!-- Los productos se renderizan aquí -->
    </div>
  </section>
</main>

             <!-- ================== MODAL: EDITAR / CREAR CATEGORÍA ================== -->
      <div id="modalCategory" class="modal-bg">
        <div class="modal">
          <button class="close-btn" onclick="closeCategoryModal()">×</button>
          <h3 id="catModalTitle">Editar categoría</h3>

          <input id="catModalName" class="input" placeholder="Nombre">

          <div class="row" style="margin-top:14px">
            <button id="catModalSave" class="btn primary">Guardar</button>
            <button id="catModalDelete" class="btn bad">Eliminar</button>
          </div>
        </div>
      </div>

      <!-- ================== MODAL: CREAR / EDITAR PRODUCTO ================== -->
      <div id="modalProduct" class="modal-bg">
        <div class="modal">
          <button class="close-btn" onclick="closeProductModal()">×</button>
          <h3 id="prodModalTitle">Producto</h3>

          <label>Nombre</label>
          <input id="prodName" class="input" placeholder="Nombre">

          <label style="margin-top:8px">Precio</label>
          <input id="prodPrice" type="number" class="input" placeholder="Precio">

          <label style="margin-top:8px">Categoría</label>
          <select id="prodCategory" class="input"></select>

          <label style="margin-top:8px">Imagen</label>
          <input id="prodImgFile" type="file" accept="image/*" class="input">

          <img id="prodPreview" 
               src="" 
               style="width:100%; height:180px; border-radius:12px; object-fit:cover; margin-top:10px; display:none" />

          <div class="row" style="margin-top:16px">
            <button id="prodModalSave" class="btn primary">Guardar</button>
            <button id="prodModalDelete" class="btn bad">Eliminar</button>
          </div>
        </div>
      </div>

    </main>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
      /* ===================== FIREBASE ===================== */
      const firebaseConfig = {
        apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
        authDomain: "rhodes-burguers.firebaseapp.com",
        projectId: "rhodes-burguers",
        storageBucket: "rhodes-burguers.firebasestorage.app",
        messagingSenderId: "951646688091",
        appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
      };
      try{ firebase.initializeApp(firebaseConfig); }catch(e){}
      const db = firebase.firestore();
      const storage = firebase.storage();

      /* ===================== HELPERS ===================== */
      const $ = s => document.querySelector(s);
      const genId = () => Math.random().toString(36).substring(2,10);

      function openCategoryModal(cat){
        $("#modalCategory").style.display = "flex";
        if(cat){
          window.__editCategory = cat;
          $("#catModalTitle").textContent = "Editar categoría";
          $("#catModalName").value = cat.name;
          $("#catModalDelete").style.display = "inline-flex";
        } else {
          window.__editCategory = null;
          $("#catModalTitle").textContent = "Nueva categoría";
          $("#catModalName").value = "";
          $("#catModalDelete").style.display = "none";
        }
      }
      function closeCategoryModal(){
        $("#modalCategory").style.display = "none";
      }

      function openProductModal(prod){
        $("#modalProduct").style.display = "flex";

        if(prod){
          window.__editProduct = prod;
          $("#prodModalTitle").textContent = "Editar producto";
          $("#prodName").value = prod.name;
          $("#prodPrice").value = prod.price;
          $("#prodCategory").value = prod.category;
          $("#prodPreview").src = prod.img || "";
          $("#prodPreview").style.display = prod.img ? "block":"none";
          $("#prodModalDelete").style.display = "inline-flex";
        } else {
          window.__editProduct = null;
          $("#prodModalTitle").textContent = "Nuevo producto";
          $("#prodName").value = "";
          $("#prodPrice").value = "";
          $("#prodCategory").value = "";
          $("#prodPreview").style.display = "none";
          $("#prodModalDelete").style.display = "none";
        }

        loadCategoriesIntoSelect();
      }
      function closeProductModal(){
        $("#modalProduct").style.display = "none";
      }


      /* ======================================================
         ================== CATEGORÍAS CRUD ==================
         ====================================================== */

      async function addCategory(){
        const name = $("#newCatName").value.trim();
        if(!name) return alert("Ingresá un nombre");

        const order = window.__categories.length;

        await db.collection("categories").add({
          name,
          order,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        $("#newCatName").value = "";
      }

      async function saveCategory(){
        const name = $("#catModalName").value.trim();
        if(!name) return alert("Nombre inválido");

        const cat = window.__editCategory;
        if(!cat){
          await db.collection("categories").add({
            name,
            order: window.__categories.length,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          await db.collection("categories").doc(cat.id).set({
            name
          }, {merge:true});
        }

        closeCategoryModal();
      }

      async function deleteCategory(){
        const cat = window.__editCategory;
        if(!cat) return;

        if(!confirm("¿Eliminar categoría?")) return;

        await db.collection("categories").doc(cat.id).delete();
        closeCategoryModal();
      }


      /* ======================================================
         =========== ORDENAR CATEGORÍAS (DRAG & DROP) =========
         ====================================================== */

      let dragCat = null;

      function renderCategories(){
        const host = $("#catList");
        host.innerHTML = "";

        window.__categories
          .sort((a,b)=> a.order - b.order)
          .forEach(cat=>{
            const el = document.createElement("div");
            el.className = "cat-item";
            el.draggable = true;

            el.innerHTML = `
              <div class="cat-left">
                <span class="cat-name">${cat.name}</span>
                <span class="cat-id">${cat.id}</span>
              </div>
              <button class="btn" onclick='openCategoryModal(${JSON.stringify(cat)})'>Editar</button>
            `;

            el.addEventListener("dragstart", ()=> dragCat = cat);
            el.addEventListener("dragover", e=> e.preventDefault());
            el.addEventListener("drop", async ()=>{
              if(dragCat && dragCat.id !== cat.id){
                const tmp = dragCat.order;
                dragCat.order = cat.order;
                cat.order = tmp;

                // Persistir
                await db.collection("categories").doc(dragCat.id).set({order: dragCat.order},{merge:true});
                await db.collection("categories").doc(cat.id).set({order: cat.order},{merge:true});
              }
            });

            host.appendChild(el);
          });
      }
             /* ======================================================
         ================== PRODUCTOS CRUD ====================
         ====================================================== */

      async function loadCategoriesIntoSelect(){
        const sel = $("#prodCategory");
        sel.innerHTML = "";

        window.__categories
          .sort((a,b)=> a.order - b.order)
          .forEach(cat=>{
            const op = document.createElement("option");
            op.value = cat.id;
            op.textContent = cat.name;
            sel.appendChild(op);
          });

        if(!sel.value && window.__categories.length > 0){
          sel.value = window.__categories[0].id;
        }
      }

      async function uploadImage(file){
        if(!file) return null;

        const ref = storage.ref("products/" + Date.now() + "_" + file.name);
        await ref.put(file);
        return await ref.getDownloadURL();
      }

      async function saveProduct(){
        const name = $("#prodName").value.trim();
        const price = Number($("#prodPrice").value);
        const catId = $("#prodCategory").value;
        const file = $("#prodImgFile").files[0];

        if(!name || !price || !catId){
          return alert("Completá los campos obligatorios");
        }

        let img = null;

        if(file){
          img = await uploadImage(file);
        } else if(window.__editProduct){
          img = window.__editProduct.img || null;
        }

        const prod = window.__editProduct;

        if(!prod){
          // Crear
          await db.collection("products").add({
            name,
            price,
            category: catId,
            img,
            order: window.__products.length,
            available: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          // Editar
          await db.collection("products").doc(prod.id).set({
            name,
            price,
            category: catId,
            img
          }, {merge:true});
        }

        closeProductModal();
      }

      async function deleteProduct(){
        const prod = window.__editProduct;
        if(!prod) return;
        if(!confirm("¿Eliminar producto?")) return;

        await db.collection("products").doc(prod.id).delete();
        closeProductModal();
      }


      /* ======================================================
         =========== ORDENAR PRODUCTOS (DRAG & DROP) ==========
         ====================================================== */

      let dragProd = null;

      function renderProducts(){
        const host = $("#prodList");
        host.innerHTML = "";

        const cats = window.__categories.sort((a,b)=> a.order - b.order);

        cats.forEach(cat=>{
          // encabezado
          const h = document.createElement("div");
          h.innerHTML = `<h3>${cat.name}</h3>`;
          host.appendChild(h);

          // productos de esta categoría
          window.__products
            .filter(p=> p.category === cat.id)
            .sort((a,b)=> a.order - b.order)
            .forEach(prod=>{
              const el = document.createElement("div");
              el.className = "prod-item";
              el.draggable = true;

              el.innerHTML = `
                <img src="${prod.img || "images/placeholder.png"}" class="prod-thumb">
                <div class="prod-mid">
                  <div class="prod-name">${prod.name}</div>
                  <div class="prod-meta">$${prod.price}</div>
                </div>
                <button class="btn" onclick='openProductModal(${JSON.stringify(prod)})'>Editar</button>
              `;

              // Drag events
              el.addEventListener("dragstart", ()=> dragProd = prod);
              el.addEventListener("dragover", e=> e.preventDefault());
              el.addEventListener("drop", async ()=>{
                if(dragProd && dragProd.id !== prod.id){
                  const tmp = dragProd.order;
                  dragProd.order = prod.order;
                  prod.order = tmp;

                  await db.collection("products").doc(dragProd.id).set({order: dragProd.order},{merge:true});
                  await db.collection("products").doc(prod.id).set({order: prod.order},{merge:true});
                }
              });

              host.appendChild(el);
            });
        });
      }


      /* ======================================================
         ==================== SUSCRIPCIONES LIVE ==============
         ====================================================== */

      function subscribeCategories(){
        db.collection("categories")
          .orderBy("order","asc")
          .onSnapshot(snap=>{
            window.__categories = snap.docs.map(d=>({id:d.id,...d.data()}));
            renderCategories();
            renderProducts();
          });
      }

      function subscribeProducts(){
        db.collection("products")
          .orderBy("order","asc")
          .onSnapshot(snap=>{
            window.__products = snap.docs.map(d=>({id:d.id,...d.data()}));
            renderProducts();
          });
      }

      /* ===================== PREVIEW IMAGEN ===================== */
      $("#prodImgFile").addEventListener("change", e=>{
        const file = e.target.files[0];
        if(!file) return;
        $("#prodPreview").src = URL.createObjectURL(file);
        $("#prodPreview").style.display = "block";
      });


      /* ======================= INIT ======================= */
      document.addEventListener("DOMContentLoaded", ()=>{
        subscribeCategories();
        subscribeProducts();

        $("#addCategoryBtn").onclick = addCategory;
        $("#catModalSave").onclick = saveCategory;
        $("#catModalDelete").onclick = deleteCategory;

        $("#addProductBtn").onclick = ()=> openProductModal(null);
        $("#prodModalSave").onclick = saveProduct;
        $("#prodModalDelete").onclick = deleteProduct;
      });

    </script>
<!-- ===================== MODAL CATEGORÍAS ===================== -->
<div id="catModal" class="modal-backdrop" style="display:none">
  <div class="modal">
    <h3>Editar categoría</h3>

    <label>Nombre</label>
    <input id="catModalName" type="text" />

    <div class="modal-footer">
      <button id="catModalDelete" class="btn danger">Eliminar</button>
      <button id="catModalSave" class="btn primary">Guardar</button>
    </div>
  </div>
</div>


<!-- ===================== MODAL PRODUCTOS ===================== -->
<div id="prodModal" class="modal-backdrop" style="display:none">
  <div class="modal">
    <h3 id="prodModalTitle">Nuevo producto</h3>

    <label>Nombre</label>
    <input id="prodName" type="text">

    <label>Precio</label>
    <input id="prodPrice" type="number">

    <label>Categoría</label>
    <select id="prodCategory"></select>

    <label>Imagen</label>
    <input id="prodImgFile" type="file" accept="image/*">
    <img id="prodPreview" style="width:100%;border-radius:12px;display:none;margin-top:8px">

    <div class="modal-footer">
      <button id="prodModalDelete" class="btn danger">Eliminar</button>
      <button id="prodModalSave" class="btn primary">Guardar</button>
    </div>
  </div>
</div>

  </body>
</html>


