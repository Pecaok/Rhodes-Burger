<!doctype html>
<html lang="es">

<script>
const TTL_HOURS = 20;
const TTL_MS = TTL_HOURS * 60 * 60 * 1000;

function sessionValid(){
  const ok = localStorage.getItem('rb_admin_ok') === 'true';
  const ts = Number(localStorage.getItem('rb_admin_t') || 0);
  return ok && (Date.now() - ts) < TTL_MS;
}
function bumpSession(){
  if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
}
function logout(){
  localStorage.removeItem('rb_admin_ok');
  localStorage.removeItem('rb_admin_t');
  localStorage.removeItem('rb_auth_v2');
  sessionStorage.removeItem('rb_auth_v2');
  location.replace('login.html');
}
(function requireSession(){
  if (!sessionValid()){
    const next = encodeURIComponent(
      (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
      (location.search || '') + (location.hash || '')
    );
    location.replace('login.html?next=' + next);
  } else bumpSession();
})();
['click','keydown','focus','mousemove','touchstart','scroll']
  .forEach(e => window.addEventListener(e, bumpSession, {passive:true}));
</script>

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin ‚Ä¢ Rhodes Burgers</title>
<link rel="icon" href="images/logo.png" />

<style>
:root{
  --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; 
  --card:#fff; --ring:#eaeaea; --shadow:0 10px 28px rgba(0,0,0,.08);
  --good:#2e7d32; --warn:#fb8c00; --bad:#d32f2f; --radius:18px;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:20;
  background:#fff;
  box-shadow:0 2px 12px rgba(0,0,0,.06);
}
.topbar{
  max-width:1200px;
  margin:0 auto;
  padding:10px 12px;
  display:flex;
  align-items:center;
  gap:12px;
}
.brand{
  display:flex;
  align-items:center;
  font-weight:800;
  color:inherit;
  text-decoration:none;
}
.brand img{
  width:36px;height:36px;
  border-radius:10px;
  margin-right:8px;
  object-fit:contain;
  background:#fff;
}
.spacer{flex:1}

/* Store Controls */
.store-controls{
  display:flex;
  align-items:center;
  gap:10px;
  background:#fff;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--ring);
}
.pill{
  padding:6px 10px;
  border-radius:12px;
  font-weight:800;
}
.pill.ok{background:#eaf6ea;color:var(--good);border:1px solid #d7ecd7}
.pill.off{background:#fafafa;color:#777;border:1px solid #eee}

.small{font-size:13px;color:var(--muted)}

/* MAIN */
main{
  max-width:1200px;
  margin:22px auto;
  padding:0 12px;
  display:grid;
  grid-template-columns:1fr;
  gap:18px;
}

.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
}
.card.featured{
  border:2px solid var(--primary);
  background:#fff8f0;
  padding:22px;
}

h1{font-size:26px;margin:8px 0 10px}
h2{font-size:20px;margin:8px 0 14px}
h3{font-size:17px;margin:8px 0}
.muted{color:var(--muted)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

.btn{
  display:inline-flex;
  gap:8px;
  padding:8px 12px;
  border-radius:12px;
  border:1.5px solid var(--ring);
  background:#fff;
  cursor:pointer;
  font-weight:700;
}
.btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.btn.good{background:#e9f6eb;border-color:#cfead3}
.btn.warn{background:#fff6e8;border-color:#ffe1b8}
.btn.bad{background:#fff1f1;border-color:#ffd7d7}

input,textarea,select{
  width:100%;
  padding:10px;
  font-size:15px;
  border-radius:12px;
  border:1.5px solid var(--ring);
  background:#fff;
}

/* Imagen previa */
.img-preview{
  width:80px;height:80px;
  object-fit:cover;
  border-radius:12px;
  border:1px solid #ddd;
  background:#fafafa;
}

/* Tabla */
table{width:100%;border-collapse:separate;border-spacing:0 8px}
td,th{padding:10px 12px;background:#fff;text-align:left}
th{
  color:#555;
  font-size:13px;
  background:#fafafa;
  border-bottom:1px solid #eee;
}
tr{box-shadow:0 1px 0 rgba(0,0,0,.04)}
</style>
</head>

<body>

<header>
  <div class="topbar">
    <a class="brand" href="#"><img src="images/logo.png">Rhodes Burgers ‚Ä¢ Admin</a>
    <div class="spacer"></div>

    <div class="store-controls" id="storeControls">
      <div style="display:flex;flex-direction:column">
        <div id="storePill" class="pill off">Estado: ‚Äî</div>
        <div class="small" id="storeSub" style="margin-top:4px">‚Äî</div>
      </div>

      <div style="min-width:220px;display:flex;gap:8px;align-items:center">
        <button class="btn good" id="btnForceOpen">Forzar abierto</button>
        <button class="btn bad" id="btnForceClose">Desactivar</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <input id="forceUntil" type="datetime-local" style="width:220px"/>
        <button class="btn primary" id="btnSaveUntil">Guardar</button>
      </div>
    </div>

    <div style="margin-left:12px">
        <nav style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <a href="pedido_local.html" class="btn">üì¶ Pedidos</a>
            <a href="finanzas.html" class="btn">üìà Finanzas</a>
            <a href="mostrador.html" class="btn">üßæ Mostrador</a>
            <a href="admin.html" class="btn primary">‚öôÔ∏è Admin</a>
        </nav>
    </div>
  </div>
</header>

<main>

<section class="card featured">
  <h2 style="margin-bottom:6px">Gesti√≥n del Men√∫ (CRUD + Orden Visual)</h2>
  <p class="muted" style="margin-bottom:14px">
    Agreg√°, edit√°, elimin√° y orden√° visualmente el men√∫.
  </p>

  <div class="form-grid" style="
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
    gap:14px;
  ">
    <div>
      <label><strong>ID (√∫nico)</strong></label>
      <input id="prdId" type="text" placeholder="Ej: bigjohn_simple">
    </div>

    <div>
      <label><strong>Nombre</strong></label>
      <input id="prdName" type="text" placeholder="Nombre del producto">
    </div>

    <div>
      <label><strong>Categor√≠a</strong></label>
      <select id="prdCategory">
        <option value="hamburguesas">Hamburguesas</option>
        <option value="bebidas">Bebidas</option>
        <option value="guarniciones">Guarniciones</option>
      </select>
    </div>

    <div>
      <label><strong>Precio</strong></label>
      <input id="prdPrice" type="number" min="0" step="1" placeholder="Ej: 4800">
    </div>

    <div>
      <label><strong>Imagen (URL o archivo)</strong></label>
      <input id="prdImg" type="text" placeholder="https://...">
      <input id="prdImgFile" type="file" accept="image/*" style="margin-top:8px">
    </div>

    <div style="grid-column:1/-1">
      <label><strong>Descripci√≥n</strong></label>
      <textarea id="prdDesc" rows="3" placeholder="Descripci√≥n corta‚Ä¶"></textarea>
    </div>
  </div>

  <div class="row" style="margin-top:14px">
    <button class="btn primary" id="btnSaveProduct">Guardar / Actualizar</button>
    <button class="btn bad" id="btnClearProduct">Limpiar Formulario</button>
  </div>

  <div style="height:1px;background:#ddd;margin:18px 0"></div>

  <h3>Lista de productos</h3>

  <div style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>IMG</th>
          <th>Nombre</th>
          <th>Categor√≠a</th>
          <th>Precio</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="prdTable"></tbody>
    </table>
  </div>
</section>

<section class="card">
  <h2>Orden Visual del Men√∫</h2>
  <p class="muted" style="margin-bottom:14px">
    Arrastr√° para ordenar la posici√≥n de los productos.
  </p>

  <div class="row" id="orderCatButtons" style="margin-bottom:15px">
    <button class="btn primary" data-cat="hamburguesas">Hamburguesas</button>
    <button class="btn" data-cat="bebidas">Bebidas</button>
    <button class="btn" data-cat="guarniciones">Guarniciones</button>
  </div>

  <div id="orderGrid" style="
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(150px,1fr));
    gap:16px;
  "></div>

  <div style="margin-top:16px">
    <button class="btn primary" id="btnSaveOrder">Guardar orden</button>
  </div>
</section>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
  authDomain: "rhodes-burguers.firebaseapp.com",
  projectId: "rhodes-burguers",
  storageBucket: "rhodes-burguers.firebasestorage.app",
  messagingSenderId: "951646688091",
  appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
};
try{ firebase.initializeApp(firebaseConfig); } catch(e){}
const db = firebase.firestore();
const productsCol = db.collection('products');
const $ = s => document.querySelector(s);

/* ============================================================
   (1) FUNCI√ìN PARA DETECTAR kind AUTOM√ÅTICAMENTE
=============================================================== */
function autoDetectKind(id, name = "", desc = "") {
  id   = id.toLowerCase();
  name = (name || "").toLowerCase();
  desc = (desc || "").toLowerCase();
  if (id.includes("_doble"))  return "doble";
  if (id.includes("_simple")) return "simple";
  if (id.includes("_pollo"))  return "pollo";
  if (name.includes("doble")) return "doble";
  if (name.includes("pollo")) return "pollo";
  if (desc.includes("doble")) return "doble";
  if (desc.includes("pollo")) return "pollo";
  return "simple"; 
}

/* ============================================================
   (2) Conversi√≥n archivo ‚Üí Base64
=============================================================== */
async function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* ============================================================
   (3) GUARDAR / ACTUALIZAR PRODUCTO
=============================================================== */
async function saveProduct(){
  const id = $('#prdId').value.trim();
  const name = $('#prdName').value.trim();
  const category = $('#prdCategory').value.trim();
  const price = Number($('#prdPrice').value || 0);
  const urlImg = $('#prdImg').value.trim();
  const desc = $('#prdDesc').value.trim();
  const file = $('#prdImgFile').files[0];

  if(!id){ alert("Ingres√° un ID"); return; }
  if(!name){ alert("Ingres√° un nombre"); return; }
  if(!(price>0)){ alert("Precio inv√°lido"); return; }

  let finalImg = urlImg || null;
  if(file){
    finalImg = await fileToBase64(file);
  }

  const payload = {
    name,
    category,
    price,
    img: finalImg,
    description: desc || null,
    available: true,
    kind: autoDetectKind(id, name, desc),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try{
    await productsCol.doc(id).set(payload, {merge:true});
    alert("Producto guardado correctamente.");
    clearProductForm();
  }catch(e){
    console.error(e);
    alert("Error al guardar.");
  }
}

/* ============================================================
   (4) LIMPIAR FORMULARIO
=============================================================== */
function clearProductForm(){
  $('#prdId').value = '';
  $('#prdName').value = '';
  $('#prdCategory').value = 'hamburguesas';
  $('#prdPrice').value = '';
  $('#prdImg').value = '';
  $('#prdImgFile').value = '';
  $('#prdDesc').value = '';
}

/* ============================================================
   (5) Cargar producto al formulario para editar
=============================================================== */
function loadProductIntoForm(data, id){
  $('#prdId').value = id;
  $('#prdName').value = data.name || '';
  $('#prdCategory').value = data.category || 'hamburguesas';
  $('#prdPrice').value = data.price || '';
  $('#prdImg').value = (data.img && !data.img.startsWith("data:")) ? data.img : '';
  $('#prdImgFile').value = '';
  $('#prdDesc').value = data.description || '';
}

/* ============================================================
   (6) Eliminar producto
=============================================================== */
async function deleteProduct(id){
  if(!confirm("¬øEliminar "+id+"?")) return;
  try{
    await productsCol.doc(id).delete();
  }catch(e){
    alert("No se pudo eliminar.");
  }
}

/* ============================================================
   (7) Toggle disponibilidad
=============================================================== */
async function toggleProductAvailability(id, current){
  try{
    await productsCol.doc(id).set({
      available: !current,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }catch(e){
    alert("Error cambiando disponibilidad.");
  }
}

/* ============================================================
   (8) Render tabla CRUD
=============================================================== */
function renderProductsTable(snapshot){
  const tbody = $('#prdTable');
  tbody.innerHTML = '';

  snapshot.forEach(doc=>{
    const p = doc.data();
    const tr = document.createElement('tr');
    const imgTag = p.img ? `<img src="${p.img}" class="img-preview">` : `<div class="img-preview"></div>`;
    const availableTag = p.available ? `<span class="pill ok">Activo</span>` : `<span class="pill off">Pausado</span>`;

    tr.innerHTML = `
      <td>${doc.id}</td>
      <td>${imgTag}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>$${p.price}</td>
      <td>${availableTag}</td>
      <td class="row">
        <button class="btn good" data-act="edit" data-id="${doc.id}">Editar</button>
        <button class="btn warn" data-act="toggle" data-id="${doc.id}" data-av="${p.available}">
          ${p.available ? "Desactivar" : "Activar"}
        </button>
        <button class="btn bad" data-act="delete" data-id="${doc.id}">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll("button").forEach(btn=>{
    btn.onclick = async()=>{
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if(act === "edit"){
        const d = await productsCol.doc(id).get();
        loadProductIntoForm(d.data(), id);
      } else if(act === "toggle"){
        toggleProductAvailability(id, btn.dataset.av === "true");
      } else if(act === "delete"){
        deleteProduct(id);
      }
    };
  });
}
productsCol.onSnapshot(renderProductsTable);
</script>

<script>
let ORDER_PRODUCTS = [];
let CURRENT_CAT = "hamburguesas";
const menuOrderRef = db.collection("config").doc("menuOrder");
const orderGrid = document.querySelector("#orderGrid");
const orderCatButtons = document.querySelector("#orderCatButtons");

window.addEventListener("DOMContentLoaded", ()=>{
  if(orderCatButtons){
    orderCatButtons.querySelectorAll("button").forEach(btn=>{
      btn.onclick = ()=>{
        orderCatButtons.querySelectorAll("button").forEach(b=> b.classList.remove("primary"));
        btn.classList.add("primary");
        CURRENT_CAT = btn.dataset.cat;
        renderOrderGrid();
      };
    });
  }
});

let MENU_ORDER = {};
menuOrderRef.onSnapshot(snap=>{
  MENU_ORDER = snap.exists ? snap.data() : {};
  renderOrderGrid();
});

function renderOrderGrid(){
  if(!orderGrid) return;
  orderGrid.innerHTML = "";
  const list = ORDER_PRODUCTS.filter(p => p.category === CURRENT_CAT);
  const orderedIds = MENU_ORDER[CURRENT_CAT] || [];

  list.sort((a,b)=>{
    const ia = orderedIds.indexOf(a.id);
    const ib = orderedIds.indexOf(b.id);
    if(ia === -1 && ib === -1) return a.name.localeCompare(b.name);
    if(ia === -1) return 1;
    if(ib === -1) return -1;
    return ia - ib;
  });

  list.forEach(p=>{
    const card = document.createElement("div");
    card.className = "orderCard";
    card.draggable = true;
    card.dataset.id = p.id;
    card.innerHTML = `
      <div style="border:1px solid #ddd;border-radius:12px;overflow:hidden;background:#fff; cursor:grab">
        <img src="${p.img || ""}" style="width:100%;height:110px;object-fit:cover">
        <div style="padding:10px;font-weight:700;font-size:14px">${p.name}</div>
      </div>
    `;
    card.addEventListener("dragstart", e=>{
      e.dataTransfer.setData("id", p.id);
      card.classList.add("dragging");
    });
    card.addEventListener("dragend", ()=>{
      card.classList.remove("dragging");
    });
    card.addEventListener("dragover", e=>{
      e.preventDefault();
      const dragging = orderGrid.querySelector(".dragging");
      if(!dragging || dragging === card) return;
      orderGrid.insertBefore(dragging, card);
    });
    orderGrid.appendChild(card);
  });
}

productsCol.onSnapshot(snap=>{
  ORDER_PRODUCTS = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderOrderGrid();
});

window.addEventListener("DOMContentLoaded", ()=>{
  const btnSaveOrder = document.querySelector("#btnSaveOrder");
  if(btnSaveOrder){
    btnSaveOrder.onclick = async ()=>{
      const ids = [...orderGrid.querySelectorAll(".orderCard")].map(c => c.dataset.id);
      await menuOrderRef.set({ ...MENU_ORDER, [CURRENT_CAT]: ids }, {merge:true});
      alert("Orden guardada.");
    };
  }
});
</script>

<script>
const storeRef = () => db.collection("config").doc("store");
const storePill = document.querySelector("#storePill");
const storeSub = document.querySelector("#storeSub");
const btnOpen = document.querySelector("#btnForceOpen");
const btnClose = document.querySelector("#btnForceClose");
const forceUntilInput = document.querySelector("#forceUntil");
const btnSaveUntil = document.querySelector("#btnSaveUntil");

function applyStoreDocToUI(d){
  const on = !!d.forceOpen;
  let until = null;
  if(d.forceOpenUntil){
    try{
      if(typeof d.forceOpenUntil.toDate === "function"){ until = d.forceOpenUntil.toDate(); } 
      else if(d.forceOpenUntil.seconds){ until = new Date(d.forceOpenUntil.seconds * 1000); } 
      else { until = new Date(d.forceOpenUntil); }
    }catch(e){}
  }
  const active = on || (until && until.getTime() > Date.now());
  storePill.className = "pill " + (active ? "ok" : "off");
  storePill.textContent = "Estado: " + (active ? "Forzado ABIERTO" : "Normal");

  if(until && until.getTime() > Date.now()){
    storeSub.textContent = "Hasta: " + String(until.getHours()).padStart(2,"0") + ":" + String(until.getMinutes()).padStart(2,"0");
    const local = new Date(until.getTime() - until.getTimezoneOffset()*60000);
    forceUntilInput.value = local.toISOString().slice(0,16);
  } else {
    storeSub.textContent = "Normal";
    forceUntilInput.value = "";
  }
}

storeRef().onSnapshot(snap=>{ applyStoreDocToUI(snap.exists ? snap.data() : {}); });

btnOpen.onclick = async()=>{ await storeRef().set({ forceOpen:true, updatedAt:firebase.firestore.FieldValue.serverTimestamp() },{merge:true}); };
btnClose.onclick = async()=>{ 
    await storeRef().set({ 
        forceOpen:false, 
        forceOpenUntil: firebase.firestore.FieldValue.delete(), 
        updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
    },{merge:true}); 
};

btnSaveUntil.onclick = async()=>{
  const v = forceUntilInput.value;
  if(!v){ alert("Eleg√≠ fecha y hora"); return; }
  const local = new Date(v);
  if(isNaN(local.getTime())){ alert("Fecha inv√°lida"); return; }
  await storeRef().set({
    forceOpen:true,
    forceOpenUntil: firebase.firestore.Timestamp.fromDate(local),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
  alert("Guardado correctamente.");
};
</script>

<script>
window.addEventListener("DOMContentLoaded", ()=>{
  const btnSaveProduct = document.querySelector("#btnSaveProduct");
  if(btnSaveProduct){ btnSaveProduct.onclick = saveProduct; }
  const btnClearProduct = document.querySelector("#btnClearProduct");
  if(btnClearProduct){ btnClearProduct.onclick = clearProductForm; }
});
</script>

</body>
</html>
