<!doctype html>
<html lang="es">
<script>
/* ======== SESI√ìN COMPARTIDA (mismo esquema que login.html) ======== */
const TTL_HOURS = 20;
const TTL_MS    = TTL_HOURS * 60 * 60 * 1000;

function sessionValid(){
  const ok = localStorage.getItem('rb_admin_ok') === 'true';
  const ts = Number(localStorage.getItem('rb_admin_t') || 0);
  return ok && (Date.now() - ts) < TTL_MS;
}
function bumpSession(){  // renueva TTL con actividad
  if (sessionValid()) localStorage.setItem('rb_admin_t', String(Date.now()));
}
function logout(){
  localStorage.removeItem('rb_admin_ok');
  localStorage.removeItem('rb_admin_t');
  localStorage.removeItem('rb_auth_v2');
  sessionStorage.removeItem('rb_auth_v2');
  location.replace('login.html'); // <-- p√°gina de login
}

// Requerir sesi√≥n en p√°ginas internas
(function requireSession(){
  if (!sessionValid()){
    const next = encodeURIComponent(
      (location.pathname.replace(/^\//,'') || 'pedido_local.html') +
      (location.search || '') + (location.hash || '')
    );
    location.replace('login.html?next=' + next);
  } else {
    bumpSession();
  }
})();

['click','keydown','focus','mousemove','touchstart','scroll'].forEach(evt=>{
  window.addEventListener(evt, bumpSession, {passive:true});
});
</script>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625E4A; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 10px 28px rgba(0,0,0,.08); --good:#2e7d32; --warn:#fb8c00; --bad:#d32f2f;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:800}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .navlinks{display:flex;gap:8px;align-items:center}

    main{max-width:1200px;margin:22px auto;padding:0 12px;display:grid;grid-template-columns:1fr;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h1{font-size:26px;margin:8px 0 10px}
    h2{font-size:20px;margin:8px 0 14px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
    .tile{border:1.5px solid var(--ring);border-radius:14px;padding:12px;display:flex;justify-content:space-between;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1.5px solid var(--ring);border-radius:999px;padding:6px 10px;font-weight:700}
    .ok{color:var(--good);border-color:#cde8cf;background:#eef8ef}
    .off{color:#777;border-color:#e6e6e6;background:#fafafa}
    .bad{color:var(--bad);border-color:#ffd9d9;background:#fff3f3}

    .btn{display:inline-flex;align-items:center;gap:8px;border:1.5px solid var(--ring);background:#fff;padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.warn{background:#fff6e8;border-color:#ffe1b8}
    .btn.good{background:#e9f6eb;border-color:#cfead3}
    .btn.bad{background:#fff1f1;border-color:#ffd7d7}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    input[type="text"],input[type="datetime-local"],textarea,select{
      padding:10px;border:1.5px solid var(--ring);border-radius:12px;background:#fff;width:100%;
    }
    textarea{min-height:90px}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .sep{height:1px;background:#eee;margin:12px 0}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    td,th{padding:10px 12px;text-align:left;background:#fff}
    th{font-size:13px;color:#555;border-bottom:1px solid #eee;background:#fafafa}
    tr{box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-weight:800}
    .tag{display:inline-block;border-radius:999px;padding:4px 8px;font-size:12px;font-weight:800}
    .tag.green{background:#e8f5e9;color:#2e7d32}
    .tag.gray{background:#f3f3f3;color:#333}

    @media (max-width:720px){
      .topbar{padding:8px}
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="">Rhodes Burgers ‚Ä¢ Admin</a>
      <div class="spacer"></div>

      <nav class="navlinks">
        <a class="btn" href="pedido_local.html">üì¶ Pedidos</a>
        <a class="btn" href="finanzas.html">üìà Finanzas</a>
        <a class="btn" href="mostrador.html">üßæ Mostrador</a>
        <a class="btn" href="index.html">Ver Men√∫</a>
      </nav>

      <div style="width:10px"></div>
      <button class="btn bad" onclick="logout()">Cerrar sesi√≥n</button>
    </div>
  </header>

  <main>
    <!-- INVENTARIO -->
    <section class="card">
      <h2>Inventario (activar / desactivar productos)</h2>
      <p class="muted">Toc√° el switch para sacar un producto sin stock. La web lee <code>products/{id}.available</code>.</p>
      <div id="invList" class="grid"></div>
    </section>

    <!-- ESTADO DE LA TIENDA -->
    <section class="card">
      <h2>Apertura fuera de horario</h2>
      <div class="row" style="margin:6px 0 12px;align-items:center">
        <label class="pill" id="storeStatePill">Estado: ‚Äî</label>
        <div style="margin-left:8px" id="forceInfo" class="muted"></div>
      </div>

      <div class="form-grid">
        <div>
          <label><strong>Forzar ‚ÄúAbierto‚Äù (manualmente)</strong></label>
          <div class="row" style="margin-top:8px">
            <button class="btn good" id="btnOpen">Activar</button>
            <button class="btn bad" id="btnClose">Desactivar</button>
          </div>
          <div class="muted" style="margin-top:6px;font-size:13px">Si est√° activado, la tienda acepta pedidos aunque los horarios digan ‚Äúcerrado‚Äù.</div>
        </div>

        <div>
          <label><strong>Abrir hasta (fecha y hora)</strong></label>
          <div class="row" style="gap:8px">
            <input id="openUntil" type="datetime-local" />
            <button class="btn primary" id="btnSetUntil">Abrir hasta</button>
            <button class="btn" id="btnClearUntil">Limpiar</button>
          </div>
          <div class="muted" style="margin-top:6px;font-size:13px">La tienda quedar√° abierta hasta la fecha/hora indicada (hora local).</div>
        </div>

        <div style="grid-column:1/-1">
          <label><strong>Mensaje (opcional)</strong></label>
          <textarea id="forceMsg" placeholder="Ej: Abrimos por evento especial hasta las 00:30."></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="btnSaveMsg">Guardar mensaje</button>
            <button class="btn" id="btnClearMsg">Limpiar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CUPONES -->
    <section class="card">
      <h2>Cupones de descuento</h2>

      <div class="form-grid">
        <div>
          <label><strong>C√≥digo</strong></label>
          <input id="cpCode" type="text" placeholder="Ej: BURGERS10">
        </div>
        <div>
          <label><strong>Tipo</strong></label>
          <select id="cpType">
            <option value="percent">Porcentaje (%)</option>
            <option value="fixed">Monto fijo ($)</option>
          </select>
        </div>
        <div>
          <label><strong>Valor</strong></label>
          <input id="cpValue" type="number" min="0" step="1" placeholder="Ej: 10 o 1500">
        </div>
        <div>
          <label><strong>M√°x. usos (opcional)</strong></label>
          <input id="cpMaxUses" type="number" min="0" step="1" placeholder="0 = ilimitado">
        </div>
        <div>
          <label><strong>V√°lido desde (opcional)</strong></label>
          <input id="cpFrom" type="datetime-local">
        </div>
        <div>
          <label><strong>V√°lido hasta (opcional)</strong></label>
          <input id="cpTo" type="datetime-local">
        </div>
        <div style="grid-column:1/-1">
          <label><strong>Nota (opcional)</strong></label>
          <input id="cpNote" type="text" placeholder="Texto interno de referencia">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnCreateCp">Crear / Actualizar cup√≥n</button>
        <span class="muted">Los c√≥digos se guardan en may√∫sculas.</span>
      </div>

      <div class="sep"></div>

      <h3 style="margin:0 0 6px">Cupones activos</h3>
      <div class="muted" style="margin-bottom:6px">Pod√©s habilitar/deshabilitar o eliminar un cup√≥n.</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th><th>Tipo</th><th>Valor</th><th>Usos</th><th>Vigencia</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="cpTable"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try{ firebase.initializeApp(firebaseConfig); }catch(e){}

    // üîß FIX transporte: long-polling antes de crear `db`
    firebase.firestore().settings({
      experimentalForceLongPolling: true,
      useFetchStreams: false
    });
    const db = firebase.firestore();

    // ===== Cat√°logo (ids deben coincidir con index/mostrador) =====
    const CATALOG = [
      { id:"bigjohn_simple", name:"Big John Simple", category:"hamburguesas" },
      { id:"bigjohn_doble",  name:"Big John Doble",  category:"hamburguesas" },
      { id:"burguesa_simple",name:"Burguesa Simple", category:"hamburguesas" },
      { id:"burguesa_doble", name:"Burguesa Doble",  category:"hamburguesas" },
      { id:"cheesebacon_simple", name:"CheeseBacon Simple", category:"hamburguesas" },
      { id:"cheesebacon_doble",  name:"CheeseBacon Doble",  category:"hamburguesas" },
      { id:"cheese_simple", name:"Cheeseburger Simple", category:"hamburguesas" },
      { id:"cheese_doble",  name:"Cheeseburger Doble",  category:"hamburguesas" },
      { id:"rhodes_simple", name:"Rhodes Simple", category:"hamburguesas" },
      { id:"rhodes_doble",  name:"Rhodes Doble",  category:"hamburguesas" },
      { id:"morgan_simple", name:"Morgan Simple", category:"hamburguesas" },
      { id:"morgan_doble",  name:"Morgan Doble",  category:"hamburguesas" },
      { id:"pollo_crispy",  name:"Pollo Crispy",  category:"hamburguesas" },
      // Bebidas
      { id:"andes_rubia", name:"Andes Origen Rubia 473ml", category:"bebidas" },
      { id:"andes_roja",  name:"Andes Origen Roja 473ml",  category:"bebidas" },
      { id:"coca_org",    name:"Coca-Cola Original 500ml", category:"bebidas" },
      { id:"coca_zero",   name:"Coca-Cola Zero 500ml",     category:"bebidas" },
      { id:"sprite",      name:"Sprite 500ml",             category:"bebidas" },
      { id:"aq_pomelo",   name:"Aquarius Pomelo 500ml",    category:"bebidas" },
      { id:"aq_pera",     name:"Aquarius Pera 500ml",      category:"bebidas" },
      { id:"aq_manzana",  name:"Aquarius Manzana 500ml",   category:"bebidas" },
      { id:"agua_sg",     name:"Agua sin gas 500ml",       category:"bebidas" }
    ];

    const $ = s => document.querySelector(s);
    const fmtDate = ts => ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);

    /* ================= INVENTARIO ================= */
    const invList = document.getElementById('invList');

    async function ensureProductDoc(p){
      const ref = db.collection('products').doc(p.id);
      const snap = await ref.get();
      if(!snap.exists){
        await ref.set({ name:p.name, category:p.category, available:true, createdAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
      }else{
        const d = snap.data();
        if(typeof d.available !== 'boolean' || !d.name || !d.category){
          await ref.set({ name:p.name, category:p.category, available: d.available ?? true }, {merge:true});
        }
      }
      return ref;
    }

    async function toggleProduct(id, val){
      try{
        await db.collection('products').doc(id).set({ available: !!val, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
      }catch(e){ alert('No se pudo cambiar el estado del producto.'); console.error(e); }
    }

    function renderInventory(productsState){
      invList.innerHTML = '';
      CATALOG.forEach(p=>{
        const st = productsState.get(p.id) ?? true;
        const el = document.createElement('div');
        el.className = 'tile';
        el.innerHTML = `
          <div>
            <div style="font-weight:800">${p.name}</div>
            <div class="muted" style="font-size:13px">${p.category}</div>
          </div>
          <div class="row">
            <span class="pill ${st?'ok':'off'}">${st?'Disponible':'Sin stock'}</span>
            <button class="btn ${st?'warn':'good'}" data-id="${p.id}" data-next="${st?0:1}">
              ${st?'Desactivar':'Activar'}
            </button>
          </div>
        `;
        invList.appendChild(el);
      });

      invList.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.dataset.id;
          const next = btn.dataset.next === '1';
          btn.disabled = true;
          await toggleProduct(id, next);
          await loadInventory();
        });
      });
    }

    async function loadInventory(){
      await Promise.all(CATALOG.map(ensureProductDoc));
      const snaps = await Promise.all(CATALOG.map(p => db.collection('products').doc(p.id).get()));
      const map = new Map();
      snaps.forEach((s,i)=> map.set(CATALOG[i].id, !!(s.data()?.available ?? true)) );
      renderInventory(map);
    }

    /* ============== STORE OVERRIDE (FORCE OPEN) ============== */
    const storeDoc = () => db.collection('config').doc('store');

    // lee y actualiza la UI (considera forceOpenUntil)
    async function refreshStoreState(){
      try{
        const s = await storeDoc().get();
        const d = s.exists ? s.data() : {};
        const now = new Date();
        const untilDate = d.forceOpenUntil ? (d.forceOpenUntil.toDate ? d.forceOpenUntil.toDate() : new Date(d.forceOpenUntil)) : null;
        const isUntilActive = untilDate && untilDate > now;
        const manualOn = !!d.forceOpen;
        const on = manualOn || isUntilActive;
        $('#storeStatePill').className = 'pill ' + (on ? 'ok' : 'off');
        $('#storeStatePill').textContent = 'Estado: ' + (on ? 'Forzado ABIERTO' : 'Normal');
        // info detallada
        const info = [];
        if(manualOn) info.push('Forzado manualmente');
        if(isUntilActive) info.push('Abierto hasta '+ untilDate.toLocaleString('es-AR'));
        if(d.forceOpenMessage) info.push('Mensaje: "'+d.forceOpenMessage+'"');
        $('#forceInfo').textContent = info.join(' ‚Ä¢ ') || '';
        // rellenar inputs
        $('#forceMsg').value = d.forceOpenMessage || '';
        if(untilDate){
          // convertimos a local iso para datetime-local
          const localIso = new Date(untilDate.getTime() - untilDate.getTimezoneOffset()*60000).toISOString().slice(0,16);
          $('#openUntil').value = localIso;
        } else {
          $('#openUntil').value = '';
        }
        // fijar min del input
        setMinOpenUntil();
      }catch(e){ console.error(e); }
    }

    // fija min del datetime-local al ahora (evita elegir el pasado)
    function setMinOpenUntil(){
      const input = document.getElementById('openUntil');
      if(!input) return;
      const now = new Date();
      const localIso = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
      input.min = localIso;
    }
    setInterval(setMinOpenUntil, 30*1000); // actualizar el min cada 30s

    $('#btnOpen').onclick  = async ()=>{ await storeDoc().set({forceOpen:true,  updatedAt:new Date()}, {merge:true}); refreshStoreState(); };
    $('#btnClose').onclick = async ()=>{ await storeDoc().set({forceOpen:false, updatedAt:new Date()}, {merge:true}); refreshStoreState(); };
    $('#btnSaveMsg').onclick = async ()=>{ await storeDoc().set({forceOpenMessage: $('#forceMsg').value.trim(), updatedAt:new Date()}, {merge:true}); refreshStoreState(); };
    $('#btnClearMsg').onclick = async ()=>{ $('#forceMsg').value = ''; await storeDoc().set({forceOpenMessage: firebase.firestore.FieldValue.delete(), updatedAt:new Date()}, {merge:true}); refreshStoreState(); };

    // Setear "abrir hasta" con datetime-local -> firestore Timestamp
    $('#btnSetUntil').onclick = async ()=>{
      const v = $('#openUntil').value;
      if(!v){ alert('Eleg√≠ fecha y hora.'); return; }
      const dt = new Date(v);
      if(isNaN(dt.getTime())){ alert('Fecha inv√°lida.'); return; }
      // validaci√≥n: no permitir fecha pasada
      if(dt.getTime() <= Date.now()){ alert('No pod√©s elegir una fecha/hora pasada.'); return; }
      try{
        await storeDoc().set({ forceOpenUntil: firebase.firestore.Timestamp.fromDate(dt), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
        refreshStoreState();
        alert('La tienda quedar√° abierta hasta '+ dt.toLocaleString('es-AR'));
      }catch(e){ console.error(e); alert('No se pudo guardar la fecha.'); }
    };

    // Limpiar fuerza por fecha/hora
    $('#btnClearUntil').onclick = async ()=>{
      if(!confirm('Eliminar la apertura programada (Abrir hasta)?')) return;
      try{
        await storeDoc().set({ forceOpenUntil: firebase.firestore.FieldValue.delete(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, {merge:true});
        refreshStoreState();
      }catch(e){ console.error(e); alert('No se pudo limpiar la apertura programada.'); }
    };

    /* ==================== CUPONES ==================== */
    const cpTbody = document.getElementById('cpTable');

    function upsertCouponFromForm(){
      const code = ($('#cpCode').value||'').trim().toUpperCase();
      if(!code){ alert('Ingres√° un c√≥digo'); return; }
      const type = $('#cpType').value;
      const value = Number($('#cpValue').value||0);
      if(!(value>0)){ alert('Ingres√° un valor mayor a 0'); return; }

      const maxUses = Number($('#cpMaxUses').value||0);
      const note = ($('#cpNote').value||'').trim();

      const from = $('#cpFrom').value ? new Date($('#cpFrom').value) : null;
      const to   = $('#cpTo').value   ? new Date($('#cpTo').value)   : null;

      const payload = {
        code, type, value,
        enabled: true,
        note: note || null,
        validFrom: from ? firebase.firestore.Timestamp.fromDate(from) : null,
        validTo: to ? firebase.firestore.Timestamp.fromDate(to) : null,
        maxUses: maxUses>0 ? maxUses : null,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection('coupons').doc(code).set({
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        uses: 0,
        ...payload
      }, {merge:true})
      .then(()=>{ alert('Cup√≥n guardado'); loadCoupons(); })
      .catch(e=>{ console.error(e); alert('No se pudo guardar el cup√≥n'); });
    }
    $('#btnCreateCp').onclick = upsertCouponFromForm;

    function renderCoupons(list){
      cpTbody.innerHTML = '';
      list.forEach(doc=>{
        const c = doc.data();
        const uses = `${c.uses||0}${c.maxUses?` / ${c.maxUses}`:''}`;
        const vf = c.validFrom ? fmtDate(c.validFrom) : null;
        const vt = c.validTo ? fmtDate(c.validTo) : null;
        const vig = (vf?vf.toLocaleDateString('es-AR')+' ':'') + (vt?('‚Üí '+vt.toLocaleDateString('es-AR')):'');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="code">${c.code}</td>
          <td>${c.type==='percent'?'%':'$'}</td>
          <td>${c.value}</td>
          <td>${uses}</td>
          <td>${vig||'-'}</td>
          <td>${c.enabled ? '<span class="tag green">HABILITADO</span>' : '<span class="tag gray">PAUSADO</span>'}</td>
          <td class="row">
            <button class="btn ${c.enabled?'warn':'good'}" data-act="toggle" data-id="${doc.id}">
              ${c.enabled?'Deshabilitar':'Habilitar'}
            </button>
            <button class="btn bad" data-act="delete" data-id="${doc.id}">Eliminar</button>
          </td>
        `;
        cpTbody.appendChild(tr);
      });

      cpTbody.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.dataset.id;
          const act = btn.dataset.act;
          if(act==='toggle'){
            const snap = await db.collection('coupons').doc(id).get();
            const enabled = !!(snap.data()?.enabled);
            await db.collection('coupons').doc(id).set({ enabled: !enabled, updatedAt:new Date() }, {merge:true});
            loadCoupons();
          }else if(act==='delete'){
            if(confirm('¬øEliminar cup√≥n '+id+'?')){
              await db.collection('coupons').doc(id).delete();
              loadCoupons();
            }
          }
        });
      });
    }

    async function loadCoupons(){
      const q = await db.collection('coupons').orderBy('code').get();
      renderCoupons(q.docs);
    }

    /* ================== INIT ================== */
    (async function boot(){
      await loadInventory();
      await refreshStoreState();
      await loadCoupons();
    })();
  </script>
</body>
</html>
