<!doctype html>
<html lang="es">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
Â  <title>Â¡Gracias! â€¢ Rhodes Burgers</title>
Â  <link rel="icon" href="images/logo.png" />
Â  <style>
Â  Â  :root{
Â  Â  Â  --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
Â  Â  Â  --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
Â  Â  Â  --st-accepted:#FBC02D; --st-preparing:#FB8C00; --st-ready:#00ACC1; --st-completed:#2E7D32; --st-cancelled:#D32F2F;
Â  Â  Â  --pay-pending:#FFA000; --pay-paid:#625A45;
Â  Â  Â  --star-off:#DDD; --star-on:#F5A524;
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
Â  Â  header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
Â  Â  .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
Â  Â  .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
Â  Â  .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
Â  Â  .spacer{flex:1}
Â  Â  .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
Â  Â  .btn.primary{background:var(--primary);color:#fff}
Â  Â  .btn.ghost{border-color:#e7e7e7;color:#333}
Â  Â  .btn[disabled]{opacity:.6;cursor:not-allowed}

Â  Â  main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
Â  Â  @media (max-width:900px){ main{grid-template-columns:1fr} }

Â  Â  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;overflow:visible}
Â  Â  h1{font-size:28px;margin:10px 0 8px}
Â  Â  h2{font-size:18px;margin:10px 0}
Â  Â  .muted{color:var(--muted)}

Â  Â  .row{display:flex;align-items:center;justify-content:space-between;margin:8px 0;gap:12px;flex-wrap:wrap}
Â  Â  .total{font-weight:800;font-size:18px}

Â  Â  .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1.5px solid var(--ring);font-weight:800;background:#fff}
Â  Â  .badge.accepted{border-color:var(--st-accepted);color:var(--st-accepted)}
Â  Â  .badge.preparing{border-color:var(--st-preparing);color:var(--st-preparing)}
Â  Â  .badge.ready_for_pickup{border-color:var(--st-ready);color:var(--st-ready)}
Â  Â  .badge.completed{border-color:var(--st-completed);color:var(--st-completed)}
Â  Â  .badge.cancelled{border-color:var(--st-cancelled);color:var(--st-cancelled)}

Â  Â  .steps{ display:grid; grid-template-columns:repeat(auto-fit,minmax(132px,1fr)); gap:10px; margin-top:12px; }
Â  Â  .step{ padding:12px; border:1.5px solid var(--ring); border-radius:14px; text-align:center; font-size:14px; background:#fff; color:#333; font-weight:700; min-height:46px; overflow-wrap:anywhere; transition:background .15s,color .15s,border-color .15s; }
Â  Â  .step.fill-accepted{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
Â  Â  .step.fill-preparing{background:var(--st-preparing);border-color:var(--st-preparing);color:#fff}
Â  Â  .step.fill-ready_for_pickup{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
Â  Â  .step.fill-completed{background:var(--st-completed);border-color:var(--st-completed);color:#fff}
Â  Â  .step.fill-cancelled{background:var(--st-cancelled);border-color:var(--st-cancelled);color:#fff}

Â  Â  .small{font-size:13px}
Â  Â  .error{color:#b00020}
Â  Â  .success{color:#2E7D32;font-weight:700}
Â  Â  .items .line{display:flex;align-items:flex-start;justify-content:space-between;margin:10px 0;gap:12px}
Â  Â  .items .muted{font-size:13px}

Â  Â  .pay-pill{display:inline-block;border-radius:999px;padding:8px 12px;font-weight:800;font-size:13px;color:#fff}
Â  Â  .pay-paid{background:var(--pay-paid)}
Â  Â  .pay-pending{background:var(--pay-pending)}

Â  Â  .meta{display:flex;gap:8px;flex-wrap:wrap}

Â  Â  /* Comentarios */
Â  Â  .textarea {
Â  Â  Â  width:100%; min-height:96px; max-height:220px; padding:12px 14px;
Â  Â  Â  border:1px solid var(--ring); border-radius:14px; background:#faf9f7;
Â  Â  Â  resize:vertical; font-size:15px; line-height:1.35;
Â  Â  Â  transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
Â  Â  Â  margin-top:12px;
Â  Â  Â  position:relative; z-index:0;
Â  Â  }
Â  Â  .textarea::placeholder{color:#9a9a9a}
Â  Â  .textarea:focus{outline:0; background:#fff; border-color:var(--primary); box-shadow:0 0 0 3px rgba(98,90,69,.18)}
Â  Â  .field-foot{display:flex; justify-content:space-between; align-items:center; margin-top:6px; font-size:12px; color:#8a8a8a}
Â  Â  .right-actions{display:flex;gap:8px;align-items:center}
Â  Â  .bordered{border:1.5px solid var(--ring);padding:12px;border-radius:12px;background:#fff}

Â  Â  /* Estrellas accesibles y persistentes */
Â  Â  .rating-wrap{display:flex;align-items:flex-start;gap:14px;flex-wrap:wrap}
Â  Â  .stars{display:inline-flex;gap:10px;margin-bottom:8px;position:relative;z-index:1;user-select:none}
Â  Â  .star{
Â  Â  Â  -webkit-appearance:none;appearance:none;border:0;background:none;margin:0;
Â  Â  Â  cursor:pointer;font-size:40px;line-height:1.1;color:var(--star-off);
Â  Â  Â  transition:color .12s ease, transform .06s ease;
Â  Â  Â  width:42px;height:42px;display:flex;align-items:center;justify-content:center;
Â  Â  Â  border-radius:8px;-webkit-tap-highlight-color:transparent;
Â  Â  }
Â  Â  .star.on{ color:var(--star-on) !important; }
Â  Â  .star:hover,.star.preview{ color:var(--star-on) !important; }
Â  Â  .star:active{ transform:scale(.92) }
Â  Â  .star:focus{ outline:3px solid rgba(98,90,69,.35) }

Â  Â  html,body{min-height:100%}
Â  Â  body{position:relative}
Â  Â  body::before{
Â  Â  Â  content:""; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
Â  Â  Â  width:clamp(240px,48vmin,560px); background:url("images/logo.png") center/contain no-repeat;
Â  Â  Â  opacity:.08; pointer-events:none; z-index:5;
Â  Â  }

Â  Â  /* Transferencia */
Â  Â  .tf-box{border:1.5px solid var(--ring); border-radius:14px; padding:12px; background:#fff; margin-top:10px}
Â  Â  .tf-row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed #eee}
Â  Â  .tf-row:last-child{border-bottom:0}
Â  Â  .tf-label{font-weight:800; color:#333}
Â  Â  .tf-value{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
Â  Â  .copy-btn{border:1px solid var(--ring); background:#f9f9f9; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700}

Â  Â  /* WhatsApp */
Â  Â  .wa-btn{
Â  Â  Â  display:inline-flex;align-items:center;gap:8px;margin-top:10px;
Â  Â  Â  border:0;background:#25D366;color:#fff;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <div class="topbar">
Â  Â  Â  <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
Â  Â  Â  <div class="spacer"></div>
Â  Â  Â  <a class="btn ghost" href="index.html">Volver al menÃº</a>
Â  Â  </div>
Â  </header>

Â  <main>
Â  Â  <section class="card">
Â  Â  Â  <h1>Â¡Gracias por tu pedido! <span id="greet" class="muted"></span></h1>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div id="badge" class="badge">Estado: â€”</div>
Â  Â  Â  Â  <div id="num" class="muted">#â€”</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="steps">
Â  Â  Â  Â  <div class="step" id="st-pending_payment">Pago pendiente</div>
Â  Â  Â  Â  <div class="step" id="st-accepted">Recibido</div>
Â  Â  Â  Â  <div class="step" id="st-preparing">Preparando</div>
Â  Â  Â  Â  <div class="step" id="st-ready_for_pickup">Listo para retirar</div>
Â  Â  Â  Â  <div class="step" id="st-completed">Entregado</div>
Â  Â  Â  </div>

Â  Â  Â  <div style="margin-top:12px" class="small muted meta">
Â  Â  Â  Â  <span>Ãšltima actualizaciÃ³n: <span id="time">â€”</span></span>
Â  Â  Â  Â  <span>â€¢</span>
Â  Â  Â  Â  <span>Forma de pago: <span id="pay">â€”</span></span>
Â  Â  Â  Â  <span>â€¢</span>
Â  Â  Â  Â  <span>Entrega: <span id="deliv">â€”</span></span>
Â  Â  Â  </div>

Â  Â  Â  <div id="info" class="small muted" style="margin-top:8px">Cargando estadoâ€¦</div>
Â  Â  </section>

Â  Â  <aside class="card">
Â  Â  Â  <h2>Tu pedido</h2>
Â  Â  Â  <div id="items" class="items"></div>
Â  Â  Â  <div class="row total"><div>Total</div><div id="resTotal">$ 0</div></div>
Â  Â  Â  <div style="margin-top:6px"><span id="payPill" class="pay-pill pay-pending">PENDIENTE DE PAGO</span></div>

Â  Â  Â  <!-- BLOQUE TRANSFERENCIA -->
Â  Â  Â  <div id="transferInfo" class="tf-box" style="display:none">
Â  Â  Â  Â  <div class="small" style="font-weight:800;margin-bottom:6px">
Â  Â  Â  Â  Â  Si elegÃ­s abonar mediante <span style="font-weight:900">transferencia</span> o <span style="font-weight:900">en local / efectivo</span>, nuestros datos son:
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="tf-row">
Â  Â  Â  Â  Â  <div class="tf-label">Alias</div>
Â  Â  Â  Â  Â  <div class="tf-value" id="tfAlias">RhodesBurgers</div>
Â  Â  Â  Â  Â  <button class="copy-btn" data-copy="#tfAlias">Copiar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="tf-row">
Â  Â  Â  Â  Â  <div class="tf-label">CVU</div>
Â  Â  Â  Â  Â  <div class="tf-value" id="tfCVU">0000003100138491469854</div>
Â  Â  Â  Â  Â  <button class="copy-btn" data-copy="#tfCVU">Copiar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="tf-row">
Â  Â  Â  Â  Â  <div class="tf-label">Nombre</div>
Â  Â  Â  Â  Â  <div class="tf-value" id="tfNombre">Marco Leonardi</div>
Â  Â  Â  Â  Â  <button class="copy-btn" data-copy="#tfNombre">Copiar</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button id="btnWA" class="wa-btn">ðŸ’¬ Enviar por WhatsApp</button>
Â  Â  Â  Â  <div class="small muted" style="margin-top:6px">CompartÃ­ o enviÃ¡ el comprobante con tu nÃºmero de pedido.</div>
Â  Â  Â  </div>
Â  Â  Â  <!-- /BLOQUE TRANSFERENCIA -->

Â  Â  Â  <div class="small muted" style="margin-top:10px">Si necesitÃ¡s modificar algo, escribinos por WhatsApp con tu nÃºmero de pedido.</div>
Â  Â  </aside>

Â  Â  <!-- Comentarios + rating -->
Â  Â  <section class="card">
Â  Â  Â  <h2>Dejanos tu comentario</h2>
Â  Â  Â  <div class="bordered">
Â  Â  Â  Â  <div class="rating-wrap">
Â  Â  Â  Â  Â  <div class="stars" id="ratingStars" role="radiogroup" aria-label="CalificaciÃ³n de 1 a 5">
Â  Â  Â  Â  Â  Â  <button type="button" class="star" data-val="1" aria-label="1 estrella">â˜…</button>
Â  Â  Â  Â  Â  Â  <button type="button" class="star" data-val="2" aria-label="2 estrellas">â˜…</button>
Â  Â  Â  Â  Â  Â  <button type="button" class="star" data-val="3" aria-label="3 estrellas">â˜…</button>
Â  Â  Â  Â  Â  Â  <button type="button" class="star" data-val="4" aria-label="4 estrellas">â˜…</button>
Â  Â  Â  Â  Â  Â  <button type="button" class="star" data-val="5" aria-label="5 estrellas">â˜…</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <textarea id="fbText" class="textarea" maxlength="300" placeholder="Â¿CÃ³mo estuvo tu experiencia? (mÃ¡x. 300 caracteres)"></textarea>
Â  Â  Â  Â  <div class="field-foot">
Â  Â  Â  Â  Â  <span id="fbCount">0/300</span>
Â  Â  Â  Â  Â  <div class="right-actions"><button id="btnSendFb" class="btn primary">Enviar</button></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="fbMsg" class="small muted" style="margin-top:6px"></div>
Â  Â  Â  </div>
Â  Â  </section>
Â  </main>

Â  <!-- Firebase compat -->
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
Â  <script>
Â  Â  /* ===== Firebase ===== */
Â  Â  var firebaseConfig={apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
Â  Â  if(!firebase.apps.length){firebase.initializeApp(firebaseConfig)}
Â  Â  var db=firebase.firestore();

Â  Â  /* ===== Helpers ===== */
Â  Â  const $=s=>document.querySelector(s);
Â  Â  const qs=n=>new URLSearchParams(location.search).get(n)||"";
Â  Â  const money=n=>(Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
Â  Â  const fmt=ts=>{if(!ts)return"â€”";const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleString("es-AR",{dateStyle:"medium",timeStyle:"short"})};
Â  Â  const friesName=v=>v==="con_sazon"?"Con sazÃ³n":"Sin sazonar";
Â  Â  function unitWithExtras(it){
Â  Â  Â  const base=(it.item&&it.item.price)?it.item.price:(it.price||0);
Â  Â  Â  const pz=((it.extras&&it.extras.patty)?it.extras.patty:0)*((it.extras&&it.extras.EXTRA_PRICE_PATTY)?it.extras.EXTRA_PRICE_PATTY:0);
Â  Â  Â  const ch=((it.extras&&it.extras.cheddar)?it.extras.cheddar:0)*((it.extras&&it.extras.EXTRA_PRICE_CHEDDAR)?it.extras.EXTRA_PRICE_CHEDDAR:0);
Â  Â  Â  return base+pz+ch;
Â  Â  }
Â  Â  function statusLabel(s){return{pending_payment:"Pago pendiente",accepted:"Recibido",preparing:"Preparando",ready_for_pickup:"Listo para retirar",completed:"Entregado",cancelled:"Cancelado"}[s]||"â€”"}
Â  Â  function colorClass(s){return{accepted:'accepted',preparing:'preparing',ready_for_pickup:'ready_for_pickup',completed:'completed',cancelled:'cancelled',pending_payment:'pending_payment'}[s]||'accepted'}
Â  Â  const PIPELINE=['pending_payment','accepted','preparing','ready_for_pickup','completed'];
Â  Â  function fillSteps(cur){
Â  Â  Â  document.querySelectorAll('.steps .step').forEach(el=>el.className='step');
Â  Â  Â  if(cur==='cancelled')return;
Â  Â  Â  const i=PIPELINE.indexOf(cur); if(i<0)return;
Â  Â  Â  for(let k=0;k<=i;k++){
Â  Â  Â  Â  const key=PIPELINE[k]; const el=document.getElementById('st-'+key);
Â  Â  Â  Â  if(el) el.classList.add('fill-'+colorClass(key));
Â  Â  Â  }
Â  Â  }
Â  Â  function toPublic(s){return({accepted:'accepted',pending_payment:'pending_payment',in_prep:'preparing',preparing:'preparing',ready:'ready_for_pickup',ready_for_pickup:'ready_for_pickup',delivered:'completed',completed:'completed',cancelled:'cancelled'})[s]||s||'accepted'}

Â  Â  /* ===== Transferencia: datos + utilidades ===== */
Â  Â  const WHATSAPP_NUMBER = "54911XXXXXXXX"; // <-- CAMBIAR
Â  Â  const TRANSFER_DATA = {
Â  Â  Â  alias: "RhodesBurgers",
Â  Â  Â  cvu: "0000003100138491469854",
Â  Â  Â  nombre: "Marco Leonardi"
Â  Â  };
Â  Â  function readPayFrom(d){
Â  Â  Â  const candidates = [
Â  Â  Â  Â  d?.pago, d?.payment_method, d?.paymentMethod, d?.payment, d?.pay,
Â  Â  Â  Â  d?.medioPago, d?.metodoPago, d?.metodo_de_pago, d?.method
Â  Â  Â  ].filter(v => v!=null);
Â  Â  Â  for (const v of candidates){
Â  Â  Â  Â  const s = String(v).trim();
Â  Â  Â  Â  if (s) return s;
Â  Â  Â  }
Â  Â  Â  return null;
Â  Â  }
Â  Â  function shouldShowTransfer(v){
Â  Â  Â  const force = new URLSearchParams(location.search).get('forceTransfer');
Â  Â  Â  if (force === '1') return true;
Â  Â  Â  if(!v) return false;
Â  Â  Â  const s = String(v).toLowerCase();
Â  Â  Â  // âœ… Mostrar tanto para transferencia como para pago en local/efectivo
Â  Â  Â  if(s.includes('transfer')) return true;
Â  Â  Â  if(s.includes('efectivo') || s.includes('en local') || s.includes('local')) return true;
Â  Â  Â  return false;
Â  Â  }
Â  Â  function updateTransferVisibility(){
Â  Â  Â  const box = $("#transferInfo");
Â  Â  Â  if(!box) return;
Â  Â  Â  const show = shouldShowTransfer(UI.pago || qs('pay'));
Â  Â  Â  if(show){
Â  Â  Â  Â  $("#tfAlias").textContentÂ  = TRANSFER_DATA.alias;
Â  Â  Â  Â  $("#tfCVU").textContentÂ  Â  = TRANSFER_DATA.cvu;
Â  Â  Â  Â  $("#tfNombre").textContent = TRANSFER_DATA.nombre;
Â  Â  Â  Â  box.style.display = "block";
Â  Â  Â  }else{
Â  Â  Â  Â  box.style.display = "none";
Â  Â  Â  }
Â  Â  }
Â  Â  function copyFrom(sel){
Â  Â  Â  try{
Â  Â  Â  Â  const el = document.querySelector(sel);
Â  Â  Â  Â  const txt = el ? el.textContent.trim() : '';
Â  Â  Â  Â  if(!txt) return;
Â  Â  Â  Â  navigator.clipboard.writeText(txt);
Â  Â  Â  }catch(_){}
Â  Â  }
Â  Â  document.addEventListener('click', (e)=>{
Â  Â  Â  const b = e.target.closest('[data-copy]');
Â  Â  Â  if(!b) return;
Â  Â  Â  copyFrom(b.getAttribute('data-copy'));
Â  Â  Â  const old=b.textContent;
Â  Â  Â  b.textContent = 'Copiado';
Â  Â  Â  setTimeout(()=>{ b.textContent = old || 'Copiar'; }, 1200);
Â  Â  });

Â  Â  // WhatsApp
Â  Â  function buildWALink(orderNumber, payValue){
Â  Â  Â  const aliasÂ  = $('#tfAlias').textContent.trim();
Â  Â  Â  const cvuÂ  Â  = $('#tfCVU').textContent.trim();
Â  Â  Â  const nombre = $('#tfNombre').textContent.trim();
Â  Â  Â  const payTxt = payValue ? String(payValue) : 'transferencia';
Â  Â  Â  const nroÂ  Â  = orderNumber ? `#${orderNumber}` : '(sin nÃºmero)';
Â  Â  Â  const msg =
`Hola, Rhodes Burgers ðŸ‘‹
Soy el pedido ${nro}.
MÃ©todo: ${payTxt}

Datos para transferencia:
â€¢ Alias: ${alias}
â€¢ CVU: ${cvu}
â€¢ Nombre: ${nombre}

Te envÃ­o el comprobante por acÃ¡. Â¡Gracias!`;
Â  Â  Â  return `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
Â  Â  }
Â  Â  document.addEventListener('click', (e)=>{
Â  Â  Â  const btn = e.target.closest('#btnWA');
Â  Â  Â  if(!btn) return;
Â  Â  Â  const pay = $('#pay').textContent.trim() || qs('pay') || 'transferencia';
Â  Â  Â  const orderNum = ($('#num').textContent.replace('#','').trim()) || qs('order') || '';
Â  Â  Â  const link = buildWALink(orderNum, pay);
Â  Â  Â  window.open(link, '_blank');
Â  Â  });

Â  Â  /* ===== Estado fusionado/UI ===== */
Â  Â  const UI={orderNumber:null,pago:null,entrega:null,nombre:null};
Â  Â  function setNum(n){if(!n)return;UI.orderNumber=n;$("#num").textContent="#"+n}
Â  Â  function setPago(v){
Â  Â  Â  if(!v)return;
Â  Â  Â  UI.pago=v;
Â  Â  Â  $("#pay").textContent=(String(v).toLowerCase()==='efectivo'?'Efectivo':v);
Â  Â  Â  updateTransferVisibility();
Â  Â  }
Â  Â  function setEntrega(v){if(!v)return;UI.entrega=v;$("#deliv").textContent=(v==='take_away'?'Take Away':v)}
Â  Â  function updateStatusUI(pub,updatedAt,paid){
Â  Â  Â  const info=$("#info"); if(info) info.textContent="";
Â  Â  Â  const badge=$("#badge"); badge.textContent="Estado: "+statusLabel(pub); badge.className="badge "+colorClass(pub);
Â  Â  Â  fillSteps(pub); if(updatedAt) $("#time").textContent=fmt(updatedAt);
Â  Â  Â  const pill=$("#payPill"); if(pill){pill.textContent=paid?"PAGADO":"PENDIENTE DE PAGO"; pill.className="pay-pill "+(paid?"pay-paid":"pay-pending");}
Â  Â  }

Â  Â  function renderItems(order){
Â  Â  Â  const cont=$("#items"); cont.innerHTML=""; let total=0;
Â  Â  Â  if(!order||!Array.isArray(order.items)){ $("#resTotal").textContent=money(0); return; }
Â  Â  Â  order.items.forEach(it=>{
Â  Â  Â  Â  let line=0;
Â  Â  Â  Â  if(it.type==='burger'){
Â  Â  Â  Â  Â  const unit=unitWithExtras(it); line=unit*(it.qty||0);
Â  Â  Â  Â  Â  const extras=[]; if(it.extras&&it.extras.patty){extras.push("+"+it.extras.patty+" medallÃ³n(es)");}
Â  Â  Â  Â  Â  if(it.extras&&it.extras.cheddar){extras.push("+"+it.extras.cheddar+" cheddar");}
Â  Â  Â  Â  Â  cont.insertAdjacentHTML('beforeend',`<div class="line"><div><div><strong>${it.qty||0}Ã— ${it.name||''}</strong></div><div class="muted">Papas: ${friesName(it.fries||'sin_sazon')}${extras.length?(' Â· '+extras.join(' Â· ')):''}</div>${it.notes?('<div class="muted">Notas: '+it.notes+'</div>'):''}</div><div>${money(line)}</div></div>`);
Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  line=((it.price||0)*(it.qty||0));
Â  Â  Â  Â  Â  cont.insertAdjacentHTML('beforeend',`<div class="line"><div><strong>${it.qty||0}Ã— ${it.name||''}</strong></div><div>${money(line)}</div></div>`);
Â  Â  Â  Â  }
Â  Â  Â  Â  total+=line;
Â  Â  Â  });
Â  Â  Â  $("#resTotal").textContent=money(total||order.total||0);
Â  Â  }

Â  Â  function extractOrderNumberFromPrivate(d){
Â  Â  Â  const fields=[d.orderNumber,d.number,d.numero,d.num,d.nro,d.seq,d.orderNo,d.pedidoNumber,d.pedido];
Â  Â  Â  for(const v of fields){ if(v==null)continue; const n=typeof v==="string"?parseInt(v,10):v; if(Number.isFinite(n)) return n; }
Â  Â  Â  return null;
Â  Â  }

Â  Â  /* ===== ParÃ¡metros y listeners ===== */
Â  Â  let orderId=qs("id"), token=qs("t");

Â  Â  function attachPublicListener(){
Â  Â  Â  if(!token) return;
Â  Â  Â  db.collection("order_public").doc(token).onSnapshot(snap=>{
Â  Â  Â  Â  if(!snap.exists){$("#info").innerHTML='<span class="error">No encontramos este pedido pÃºblico. VerificÃ¡ el link.</span>'; return;}
Â  Â  Â  Â  const d=snap.data();
Â  Â  Â  Â  $("#greet").textContent=d&&d.nombre?`, ${d.nombre}`:""; if(d&&d.nombre) UI.nombre=d.nombre;
Â  Â  Â  Â  if(d.orderNumber) setNum(d.orderNumber);
Â  Â  Â  Â  const pv = readPayFrom(d); if (pv) setPago(pv);
Â  Â  Â  Â  if(d.entrega) setEntrega(d.entrega);
Â  Â  Â  Â  updateStatusUI(d.status, d.updatedAt||d.createdAt, (d.payment_status==='paid')||!!d.paid);
Â  Â  Â  }, err=>{$("#info").innerHTML='<span class="error">Error de conexiÃ³n al estado pÃºblico: '+(err&&err.message?err.message:err)+'</span>';});
Â  Â  }

Â  Â  let privateUnsub=null;
Â  Â  function attachPrivateListener(){
Â  Â  Â  if(!orderId) return;
Â  Â  Â  if(privateUnsub){privateUnsub(); privateUnsub=null;}
Â  Â  Â  privateUnsub=db.collection("orders").doc(orderId).onSnapshot(doc=>{
Â  Â  Â  Â  if(!doc.exists) return;
Â  Â  Â  Â  const d=doc.data();
Â  Â  Â  Â  if(d.trackToken && token && d.trackToken!==token){
Â  Â  Â  Â  Â  $("#items").innerHTML='<div class="small error">Por seguridad no mostramos el detalle porque el token no coincide.</div>';
Â  Â  Â  Â  Â  $("#resTotal").textContent=money(0); return;
Â  Â  Â  Â  }
Â  Â  Â  Â  renderItems(d);
Â  Â  Â  Â  const maybe=extractOrderNumberFromPrivate(d); if(maybe && !UI.orderNumber) setNum(maybe);
Â  Â  Â  Â  const pv = readPayFrom(d); if (pv && !UI.pago) setPago(pv);
Â  Â  Â  Â  if(d.entrega && !UI.entrega) setEntrega(d.entrega);
Â  Â  Â  Â  if(!UI.nombre && d.nombre) UI.nombre=d.nombre;
Â  Â  Â  Â  updateStatusUI(toPublic(d.status||'accepted'), d.updatedAt||d.createdAt, (d.payment_status==='paid')||!!d.paid);
Â  Â  Â  }, err=>{$("#items").innerHTML='<div class="small error">Error de conexiÃ³n al detalle: '+(err&&err.message?err.message:err)+'</div>';});
Â  Â  }

Â  Â  /* ===== Feedback (comentario + rating) ===== */
Â  Â  const fbText = ()=>$("#fbText");
Â  Â  const fbCount= ()=>$("#fbCount");
Â  Â  const fbMsgÂ  = ()=>$("#fbMsg");
Â  Â  const fbBtnÂ  = ()=>$("#btnSendFb");
Â  Â  const FB_MAX=300;

Â  Â  function alreadySentKey(){return token?`rb_fb_sent_${token}`:(orderId?`rb_fb_sent_${orderId}`:`rb_fb_sent_unknown`);}

Â  Â  let currentRating = 0;
Â  Â  const stars = Array.from(document.querySelectorAll("#ratingStars .star"));
Â  Â  function paintStars(n, preview=false){
Â  Â  Â  stars.forEach(btn=>{
Â  Â  Â  Â  const v=Number(btn.dataset.val||0);
Â  Â  Â  Â  btn.classList.toggle('on', v<=n);
Â  Â  Â  Â  btn.classList.toggle('preview', preview && v<=n);
Â  Â  Â  });
Â  Â  }
Â  Â  function setRating(n){ currentRating=n; paintStars(n,false); }
Â  Â  function updateCounter(){ fbCount().textContent = `${(fbText().value||'').length}/${FB_MAX}`; }
Â  Â  function setFbState(disabled,message,ok){
Â  Â  Â  fbBtn().disabled=!!disabled;
Â  Â  Â  if(message!=null){ fbMsg().textContent=message; fbMsg().className="small "+(ok?"success":"error"); }
Â  Â  Â  else{ fbMsg().textContent=""; fbMsg().className="small muted"; }
Â  Â  }
Â  Â  function tryDisableIfAlreadySent(){
Â  Â  Â  try{
Â  Â  Â  Â  if(localStorage.getItem(alreadySentKey())==='1'){
Â  Â  Â  Â  Â  fbText().disabled=true;
Â  Â  Â  Â  Â  stars.forEach(b=>{ b.disabled=true; b.style.cursor='default'; });
Â  Â  Â  Â  Â  setFbState(true,"Â¡Gracias! Ya recibimos tu comentario.",true);
Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  }
Â  Â  Â  }catch(_){}
Â  Â  Â  return false;
Â  Â  }
Â  Â  async function sendFeedback(){
Â  Â  Â  const txt=(fbText().value||'').trim();
Â  Â  Â  const rating=currentRating||0;
Â  Â  Â  if(!txt && !rating){ setFbState(false,"Dejanos un comentario o elegÃ­ una calificaciÃ³n para enviar.",false); return; }
Â  Â  Â  if(txt.length>FB_MAX){ setFbState(false,"Tu comentario es muy largo.",false); return; }
Â  Â  Â  setFbState(true,"Enviandoâ€¦",true);
Â  Â  Â  const payload={comment:txt||null,rating:rating||null,orderId:orderId||null,token:token||null,orderNumber:UI.orderNumber||null,nombre:UI.nombre||null,pago:UI.pago||null,entrega:UI.entrega||null,userAgent:navigator.userAgent||"",createdAt:firebase.firestore.FieldValue.serverTimestamp()};
Â  Â  Â  try{
Â  Â  Â  Â  await db.collection("feedback").add(payload);
Â  Â  Â  Â  localStorage.setItem(alreadySentKey(),'1');
Â  Â  Â  Â  fbText().disabled=true; stars.forEach(b=>{b.disabled=true; b.style.cursor='default';});
Â  Â  Â  Â  setFbState(true,"Â¡Gracias! Tu comentario fue enviado.",true);
Â  Â  Â  }catch(e){
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  setFbState(false,"No se pudo enviar. IntentÃ¡ nuevamente.",false);
Â  Â  Â  }
Â  Â  }

Â  Â  (async function boot(){
Â  Â  Â  if(!orderId && !token){
Â  Â  Â  Â  $("#info").innerHTML='<span class="error">Link invÃ¡lido: faltan parÃ¡metros.</span>';
Â  Â  Â  }

Â  Â  Â  // Completar token desde la privada si llegÃ³ sÃ³lo ?id
Â  Â  Â  if(!token && orderId){
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const snap=await db.collection("orders").doc(orderId).get();
Â  Â  Â  Â  Â  if(snap.exists && snap.data().trackToken){
Â  Â  Â  Â  Â  Â  token=snap.data().trackToken;
Â  Â  Â  Â  Â  Â  history.replaceState(null,"",location.pathname+"?id="+encodeURIComponent(orderId)+"&t="+encodeURIComponent(token));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }catch(e){}
Â  Â  Â  }

Â  Â  Â  // Listeners
Â  Â  Â  if(token) attachPublicListener();
Â  Â  Â  attachPrivateListener();

Â  Â  Â  // Si vino ?order o ?pay por URL, mostrarlos tempranamente
Â  Â  Â  const orderParam = qs('order');
Â  Â  Â  if(orderParam && !UI.orderNumber) setNum(orderParam);
Â  Â  Â  const payParam = qs('pay');
Â  Â  Â  if(payParam && !UI.pago) setPago(payParam);

Â  Â  Â  // Feedback UI
Â  Â  Â  if($("#fbText")){ $("#fbText").addEventListener('input',updateCounter); updateCounter(); }
Â  Â  Â  if($("#btnSendFb")){ $("#btnSendFb").addEventListener('click',sendFeedback); }

Â  Â  Â  // Estrellas accesibles
Â  Â  Â  stars.forEach(btn=>{
Â  Â  Â  Â  const v=Number(btn.dataset.val||0);
Â  Â  Â  Â  btn.addEventListener('mouseenter', ()=>paintStars(v,true));
Â  Â  Â  Â  btn.addEventListener('mouseleave', ()=>paintStars(currentRating,false));
Â  Â  Â  Â  btn.addEventListener('click', ()=>setRating(v));
Â  Â  Â  Â  btn.addEventListener('keydown', e=>{
Â  Â  Â  Â  Â  if(['ArrowRight','ArrowUp'].includes(e.key)){ setRating(Math.min(5,(currentRating||0)+1||1)); e.preventDefault(); }
Â  Â  Â  Â  Â  if(['ArrowLeft','ArrowDown'].includes(e.key)){ setRating(Math.max(1,(currentRating||0)-1||1)); e.preventDefault(); }
Â  Â  Â  Â  Â  if(e.key==='Home'){ setRating(1); e.preventDefault(); }
Â  Â  Â  Â  Â  if(e.key==='End'){ setRating(5); e.preventDefault(); }
Â  Â  Â  Â  });
Â  Â  Â  Â  btn.setAttribute('tabindex','0');
Â  Â  Â  Â  btn.setAttribute('role','radio');
Â  Â  Â  Â  btn.setAttribute('aria-checked','false');
Â  Â  Â  });

Â  Â  Â  paintStars(0,false);
Â  Â  Â  tryDisableIfAlreadySent();

Â  Â  Â  // Mostrar/ocultar transferencia por si aÃºn no llegÃ³ dato
Â  Â  Â  updateTransferVisibility();
Â  Â  })();
Â  </script>
</body>
</html>
