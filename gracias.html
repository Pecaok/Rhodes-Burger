<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>¡Gracias! • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;

      /* Estado */
      --st-accepted:#FBC02D;
      --st-preparing:#FB8C00;
      --st-ready:#00ACC1;
      --st-completed:#2E7D32;
      --st-cancelled:#D32F2F;

      /* Pago */
      --pay-pending:#FFA000;
      --pay-paid:#625A45;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.ghost{border-color:#e7e7e7;color:#333}

    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    h1{font-size:28px;margin:10px 0 8px}
    h2{font-size:18px;margin:10px 0}
    .muted{color:var(--muted)}

    .row{display:flex;align-items:center;justify-content:space-between;margin:8px 0;gap:12px;flex-wrap:wrap}
    .total{font-weight:800;font-size:18px}

    /* Badge */
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1.5px solid var(--ring);font-weight:800;background:#fff}
    .accepted{border-color:var(--st-accepted);color:var(--st-accepted)}
    .preparing{border-color:var(--st-preparing);color:var(--st-preparing)}
    .ready{border-color:var(--st-ready);color:var(--st-ready)}
    .completed{border-color:var(--st-completed);color:var(--st-completed)}
    .cancelled{border-color:var(--st-cancelled);color:var(--st-cancelled)}

    /* Pasos */
    .steps{display:grid;grid-template-columns:repeat(auto-fit,minmax(132px,1fr));gap:10px;margin-top:12px}
    .step{padding:12px;border:1.5px solid var(--ring);border-radius:14px;text-align:center;font-size:14px;background:#fff;color:#333;font-weight:700;min-height:46px;word-break:break-word;overflow-wrap:anywhere;transition:background .15s,color .15s,border-color .15s}
    .fill-accepted{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .fill-preparing{background:var(--st-preparing);border-color:var(--st-preparing);color:#fff}
    .fill-ready{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .fill-completed{background:var(--st-completed);border-color:var(--st-completed);color:#fff}
    .fill-cancelled{background:var(--st-cancelled);border-color:var(--st-cancelled);color:#fff}

    .small{font-size:13px}
    .error{color:#b00020}
    .items .line{display:flex;align-items:flex-start;justify-content:space-between;margin:10px 0;gap:12px}
    .items .muted{font-size:13px}

    .pay-pill{display:inline-block;border-radius:999px;padding:8px 12px;font-weight:800;font-size:13px;color:#fff}
    .pay-paid{background:var(--pay-paid)}
    .pay-pending{background:var(--pay-pending)}

    .meta{display:flex;gap:8px;flex-wrap:wrap}

    /* Marca de agua */
    html, body { min-height: 100%; }
    body { position: relative; }
    body::before{
      content: ""; position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width: clamp(240px, 48vmin, 560px);
      background: url("images/logo.png") center / contain no-repeat;
      opacity: .08; pointer-events:none; z-index:5;
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">Volver al menú</a>
    </div>
  </header>

  <main>
    <!-- Estado -->
    <section class="card">
      <div class="row">
        <h1>¡Gracias por tu pedido! <span id="greet" class="muted"></span></h1>
        <div id="num" class="muted">#—</div>
      </div>

      <div class="row" style="margin-top:0">
        <div id="badge" class="badge">Estado: —</div>
      </div>

      <div class="steps">
        <div class="step" id="st-accepted">Recibido</div>
        <div class="step" id="st-preparing">Preparando</div>
        <div class="step" id="st-ready">Listo para retirar</div>
        <div class="step" id="st-completed">Entregado</div>
      </div>

      <div style="margin-top:12px" class="small muted meta">
        <span>Última actualización: <span id="time">—</span></span>
        <span>•</span>
        <span>Pago: <span id="pay">—</span></span>
        <span>•</span>
        <span>Entrega: <span id="deliv">—</span></span>
      </div>

      <div id="info" class="small muted" style="margin-top:8px">Cargando estado…</div>
    </section>

    <!-- Resumen -->
    <aside class="card">
      <h2>Tu pedido</h2>
      <div id="items" class="items"></div>
      <div class="row total">
        <div>Total</div>
        <div id="resTotal">$ 0</div>
      </div>
      <div style="margin-top:6px">
        <span id="payPill" class="pay-pill pay-pending">PENDIENTE DE PAGO</span>
      </div>
      <div class="small muted" style="margin-top:10px">Si necesitás modificar algo, escribinos por WhatsApp con tu número de pedido.</div>
    </aside>
  </main>

  <!-- Firebase SDK MODULAR -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // -------- Helpers
    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const orderId = params.get('id') || localStorage.getItem('lastOrderId') || '';
    const codeUrl = params.get('code') || params.get('t') || localStorage.getItem('lastOrderCode') || '';

    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const fmt = (ts)=> {
      if(!ts) return '—';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString('es-AR',{dateStyle:'medium', timeStyle:'short'});
    };
    const friesName = v => v==="con_sazon" ? "Con sazón" : "Sin sazonar";

    const statusLabel = s => ({
      received: "Recibido",
      accepted: "Recibido",
      preparing: "Preparando",
      ready_for_pickup: "Listo para retirar",
      ready: "Listo para retirar",
      delivered: "Entregado",
      completed: "Entregado",
      cancelled: "Cancelado",
      pending_payment: "Pago pendiente"
    }[s] || "—");

    const badgeClass = s => ({
      accepted:'accepted',
      received:'accepted',
      preparing:'preparing',
      ready:'ready',
      ready_for_pickup:'ready',
      completed:'completed',
      delivered:'completed',
      cancelled:'cancelled',
      pending_payment:'accepted'
    }[s] || 'accepted');

    const PIPE = ['accepted','preparing','ready','completed'];

    function fillSteps(cur){
      document.querySelectorAll('.steps .step').forEach(el=> el.className='step');
      const key = (cur==='received') ? 'accepted' : cur;
      const idx = PIPE.indexOf(key);
      for(let i=0;i<=idx;i++){
        const el = document.getElementById('st-'+PIPE[i]);
        if(el) el.classList.add('fill-'+PIPE[i]);
      }
      if(cur==='cancelled'){
        document.querySelectorAll('.steps .step').forEach(el=> el.className='step fill-cancelled');
      }
    }

    function renderItems(order){
      const cont = $('#items'); cont.innerHTML='';
      let total = 0;
      (order.items||[]).forEach(it=>{
        let line=0, html='';
        if(it.type==='burger'){
          const base = (it.price||0)
            + (it.extras?.patty||0)*2400
            + (it.extras?.cheddar||0)*300;
          line = base*(it.qty||0);
          const extras=[];
          if(it.extras?.patty) extras.push(`+${it.extras.patty} medallón(es)`);
          if(it.extras?.cheddar) extras.push(`+${it.extras.cheddar} cheddar`);
          html = `
            <div class="line">
              <div>
                <div><strong>${it.qty||0}× ${it.name||''}</strong></div>
                <div class="muted">Papas: ${friesName(it.fries||'sin_sazon')}${extras.length?` · ${extras.join(' · ')}`:''}</div>
                ${it.notes?`<div class="muted">Notas: ${it.notes}</div>`:''}
              </div>
              <div>${money(line)}</div>
            </div>`;
        }else{
          line = (it.price||0)*(it.qty||0);
          html = `
            <div class="line">
              <div><strong>${it.qty||0}× ${it.name||''}</strong></div>
              <div>${money(line)}</div>
            </div>`;
        }
        total += line;
        cont.insertAdjacentHTML('beforeend', html);
      });
      $('#resTotal').textContent = money(total || order.total || 0);
    }

    function updateMeta(order){
      // nombre
      const nombre = order.nombre || order.customer?.name || '';
      $('#greet').textContent = nombre ? `, ${nombre}` : '';

      // NUMERO DE PEDIDO: prioridad al secuencial
      const num = order.orderNumber || order.number || null;
      const fallbackCode = order.orderCode || '';
      $('#num').textContent = num ? `#${num}` : (fallbackCode || '#—');

      // meta
      $('#time').textContent = fmt(order.updatedAt || order.createdAt);
      $('#pay').textContent = order.payment?.method==='efectivo' ? 'Efectivo' :
                              (order.payment?.method==='mercado_pago'? 'Mercado Pago' : (order.payment?.method||'—'));
      $('#deliv').textContent = order.delivery?.type==='take_away' ? 'Take Away' : (order.delivery?.type||'—');

      const paid = order.payment?.status==='paid' || order.payment_status==='paid' || order.paid===true;
      const pill = $('#payPill');
      pill.textContent = paid? 'PAGADO':'PENDIENTE DE PAGO';
      pill.className = 'pay-pill ' + (paid? 'pay-paid':'pay-pending');
    }

    function updateStatus(order){
      const s = (order.status || 'accepted');
      const badge = $('#badge');
      badge.textContent = 'Estado: ' + statusLabel(s);
      badge.className = 'badge ' + badgeClass(s);
      fillSteps(s);
    }

    async function boot(){
      if(!orderId){
        $('#info').innerHTML = '<span class="error">Falta el parámetro "id".</span>';
        return;
      }
      const ref = doc(db,'orders',orderId);

      // (Opcional) si hay code, validamos para mostrar/ocultar ítems
      let allowItems = true;
      if(codeUrl){
        try{
          const snap = await getDoc(ref);
          if(snap.exists() && snap.data().orderCode && snap.data().orderCode !== codeUrl){
            allowItems = false;
          }
        }catch{}
      }

      onSnapshot(ref, (snap)=>{
        if(!snap.exists()){
          $('#info').innerHTML = '<span class="error">No encontramos este pedido.</span>';
          return;
        }
        const order = snap.data();
        $('#info').textContent = '';

        updateMeta(order);
        updateStatus(order);

        if(allowItems || !order.orderCode) renderItems(order);
        else {
          $('#items').innerHTML = '<div class="small error">Por seguridad, el detalle no se muestra porque el código no coincide.</div>';
        }
      }, (err)=>{
        $('#info').innerHTML = '<span class="error">Error de conexión: '+(err?.message||err)+'</span>';
      });
    }

    boot();
  </script>
</body>
</html>
