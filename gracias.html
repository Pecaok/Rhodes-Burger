<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gracias • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --ring:#eaeaea; --shadow:0 10px 30px rgba(0,0,0,.08);
      --ok:#2ecc71; --warn:#f39c12; --ready:#3498db; --done:#7f8c8d; --cancel:#e74c3c;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:900px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:10px;border:1px solid var(--ring);padding:9px 14px;border-radius:999px;color:#333;background:#fff;text-decoration:none;cursor:pointer;font-weight:600}
    .container{max-width:900px;margin:22px auto;padding:0 12px}

    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px 18px;margin:14px 0}
    .muted{color:var(--muted)}
    h1{font-size:28px;margin:8px 0 12px}
    h2{font-size:20px;margin:12px 0 8px}

    /* badge estado */
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);border-radius:999px;padding:6px 10px;font-size:14px}
    .badge.ok{background:#e9f8ef;border-color:#bfe9cf}
    .badge.warn{background:#fff6e5;border-color:#ffd99b}
    .badge.ready{background:#e8f1ff;border-color:#c8dcff}
    .badge.done{background:#f4f6f7;border-color:#e3e6e8}
    .badge.cancel{background:#fff0f0;border-color:#ffc7c7;color:#b93129}

    /* timeline */
    .steps{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:10px 0 4px}
    .step{flex:1;display:flex;align-items:center;gap:10px}
    .dot{width:14px;height:14px;border-radius:999px;border:3px solid #dcdcdc;background:#fff}
    .dot.active{border-color:var(--primary);background:var(--primary)}
    .dot.ready{border-color:var(--ready);background:var(--ready)}
    .dot.done{border-color:var(--done);background:var(--done)}
    .line{height:3px;background:#e7e7e7;flex:1;border-radius:999px}
    .line.active{background:linear-gradient(90deg,var(--primary),var(--ready))}
    .line.done{background:var(--done)}

    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .list{margin-top:8px}
    .item{display:flex;justify-content:space-between;gap:10px;margin:6px 0}
    .money{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="Rhodes Burgers"></a>
      <div class="spacer"></div>
      <a class="btn" href="index.html">← Seguir comprando</a>
    </div>
  </header>

  <main class="container">
    <h1>¡Gracias por tu pedido!</h1>

    <!-- tarjeta principal -->
    <section class="card" id="trackCard">
      <div class="row">
        <div>
          <div id="title">Pedido</div>
          <div class="muted" id="when">—</div>
        </div>
        <div id="total" class="money">—</div>
      </div>

      <div style="margin-top:10px">
        <span id="stateBadge" class="badge">Estado: —</span>
      </div>

      <!-- timeline -->
      <div class="steps" style="margin-top:10px">
        <div class="step"><div id="dotPrep" class="dot"></div><div>En preparación</div></div>
        <div id="line1" class="line"></div>
        <div class="step"><div id="dotListo" class="dot"></div><div>Listo para retirar</div></div>
        <div id="line2" class="line"></div>
        <div class="step"><div id="dotDone" class="dot"></div><div>Entregado</div></div>
      </div>

      <div class="divider" style="height:1px;background:#efefef;margin:12px 0"></div>

      <h2>Detalle</h2>
      <div id="items" class="list">—</div>

      <div class="muted" id="foot">Si necesitás, indicá este código: <span id="code">—</span></div>
    </section>

    <!-- ayuda -->
    <section class="card">
      <div class="muted">
        Si no ves tu estado actualizado, esta página se refresca sola cuando el local cambia el estado.
      </div>
    </section>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    /* ====== FIREBASE ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ====== UI helpers ====== */
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});

    const STATUS = {
      NUEVO:"nuevo",
      PREP:"en_preparacion",
      LISTO:"listo",
      ENTREGADO:"entregado",
      CANCELADO:"cancelado"
    };
    const STATUS_LABEL = {
      [STATUS.NUEVO]:"Nuevo",
      [STATUS.PREP]:"En preparación",
      [STATUS.LISTO]:"Listo para retirar",
      [STATUS.ENTREGADO]:"Entregado",
      [STATUS.CANCELADO]:"Cancelado"
    };

    function friesName(f){ return f==="con_sazon"?"Con sazón":(f==="sin_sazon"?"Sin sazonar":"—"); }
    function unitWithExtras(it){
      const base = it.price||0;
      const pz = (it.extras?.patty||0)*(it.extras?.EXTRA_PRICE_PATTY||0);
      const ch = (it.extras?.cheddar||0)*(it.extras?.EXTRA_PRICE_CHEDDAR||0);
      return base+pz+ch;
    }
    function computeOrderTotal(o){
      if(typeof o.total==="number") return o.total;
      const items = Array.isArray(o.items)?o.items:[];
      let t=0;
      for(const it of items){
        t += (it.type==="burger"?unitWithExtras(it):it.price||0)*(it.qty||0);
      }
      return t;
    }

    /* ====== read order by id/nro ====== */
    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name);
    }
    function getOrderNumber(o){
      if(typeof o?.nro==="number" && o.nro>0) return o.nro;
      if(typeof o?.orderNumber==="number" && o.orderNumber>0) return o.orderNumber;
      return null;
    }

    const titleEl = $("#title");
    const whenEl  = $("#when");
    const totalEl = $("#total");
    const itemsEl = $("#items");
    const codeEl  = $("#code");
    const badgeEl = $("#stateBadge");
    const dotPrep = $("#dotPrep"), dotListo=$("#dotListo"), dotDone=$("#dotDone");
    const line1=$("#line1"), line2=$("#line2");

    function setBadge(state){
      const label = STATUS_LABEL[state] || state || "—";
      badgeEl.textContent = "Estado: " + label;
      badgeEl.className = "badge";
      if(state===STATUS.PREP || state===STATUS.NUEVO) badgeEl.classList.add("warn");
      if(state===STATUS.LISTO) badgeEl.classList.add("ready");
      if(state===STATUS.ENTREGADO) badgeEl.classList.add("done");
      if(state===STATUS.CANCELADO) badgeEl.classList.add("cancel");
    }
    function setTimeline(state){
      // reset
      [dotPrep,dotListo,dotDone].forEach(d=>d.className="dot");
      [line1,line2].forEach(l=>l.className="line");
      if(state===STATUS.NUEVO || state===STATUS.PREP){
        dotPrep.classList.add("active");
      }else if(state===STATUS.LISTO){
        dotPrep.classList.add("active");
        line1.classList.add("active");
        dotListo.classList.add("ready");
      }else if(state===STATUS.ENTREGADO){
        dotPrep.classList.add("active");
        line1.classList.add("done");
        dotListo.classList.add("done");
        line2.classList.add("done");
        dotDone.classList.add("done");
      }else if(state===STATUS.CANCELADO){
        // marcar como finalizado (se muestra solo badge en rojo)
      }
    }

    async function attachOrder(){
      const id  = getParam("id");
      const nro = parseInt(getParam("nro")||"",10);

      if(id){
        listenDoc(db.collection("orders").doc(id));
        return;
      }
      if(Number.isFinite(nro)){
        // Intento por nro, si no por orderNumber
        const q1 = await db.collection("orders").where("nro","==",nro).limit(1).get();
        if(!q1.empty){ listenDoc(q1.docs[0].ref); return; }
        const q2 = await db.collection("orders").where("orderNumber","==",nro).limit(1).get();
        if(!q2.empty){ listenDoc(q2.docs[0].ref); return; }
      }
      // No se pudo identificar
      $("#trackCard").innerHTML = `
        <div class="muted">No pudimos encontrar el pedido.
          Asegurate de abrir este enlace desde la confirmación o de incluir <strong>?id=DOC_ID</strong> o <strong>?nro=123</strong> en la URL.</div>`;
    }

    function listenDoc(ref){
      ref.onSnapshot(snap=>{
        if(!snap.exists){
          $("#trackCard").innerHTML = '<div class="muted">El pedido no existe.</div>';
          return;
        }
        const o = snap.data();

        const nro = getOrderNumber(o);
        titleEl.textContent = `Pedido ${nro?('#'+nro):''} • ${o.nombre||'Cliente'}`;

        const when = o.createdAt?.toDate ? o.createdAt.toDate() : null;
        whenEl.textContent = when ? (when.toLocaleDateString('es-AR') + ' — ' + when.toLocaleTimeString('es-AR')) : '—';

        totalEl.textContent = money(computeOrderTotal(o));
        setBadge(o.status||STATUS.NUEVO);
        setTimeline(o.status||STATUS.NUEVO);

        codeEl.textContent = nro ? ('#'+nro) : (ref.id);

        const items = Array.isArray(o.items)?o.items:[];
        itemsEl.innerHTML = items.map(it=>{
          const nm = it.name||'Item';
          const qty = it.qty||0;
          if(it.type==="burger"){
            const extras=[];
            if(it.extras?.patty) extras.push(`+${it.extras.patty} med`);
            if(it.extras?.cheddar) extras.push(`+${it.extras.cheddar} cheddar`);
            const unit = unitWithExtras(it);
            const sub  = unit*(qty||0);
            return `
              <div class="item">
                <div>
                  <strong>${qty}× ${nm}</strong>
                  <div class="muted">Papas: ${friesName(it.fries)} ${extras.length?('• '+extras.join(' • ')):''}</div>
                </div>
                <div class="money">${money(sub)}</div>
              </div>`;
          }else{
            const sub = (it.price||0)*(qty||0);
            return `
              <div class="item">
                <div><strong>${qty}× ${nm}</strong></div>
                <div class="money">${money(sub)}</div>
              </div>`;
          }
        }).join("") || '<div class="muted">Sin ítems.</div>';
      });
    }

    attachOrder();
  </script>
</body>
</html>
