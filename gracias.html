<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>¡Gracias! • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#2ecc71; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;

      /* Colores por estado */
      --st-accepted:#FBC02D;
      --st-preparing:#FB8C00;
      --st-ready:#00ACC1;
      --st-completed:#2E7D32;
      --st-cancelled:#D32F2F;

      /* Pago */
      --pay-pending:#FFA000;
      --pay-paid:#2ECC71;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}

    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;overflow:visible}
    h1{font-size:28px;margin:10px 0 8px}
    h2{font-size:18px;margin:10px 0}
    .muted{color:var(--muted)}

    .row{display:flex;align-items:center;justify-content:space-between;margin:8px 0;gap:12px;flex-wrap:wrap}
    .total{font-weight:800;font-size:18px}

    /* Badge de estado */
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1.5px solid var(--ring);font-weight:800;background:#fff}
    .badge.accepted{border-color:var(--st-accepted);color:var(--st-accepted)}
    .badge.preparing{border-color:var(--st-preparing);color:var(--st-preparing)}
    .badge.ready_for_pickup{border-color:var(--st-ready);color:var(--st-ready)}
    .badge.completed{border-color:var(--st-completed);color:var(--st-completed)}
    .badge.cancelled{border-color:var(--st-cancelled);color:var(--st-cancelled)}

    /* Pasos responsivos: chips blancos con contorno que se rellenan hasta el estado actual */
    .steps{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(132px,1fr));
      gap:10px;
      margin-top:12px;
    }
    .step{
      padding:12px;
      border:1.5px solid var(--ring);
      border-radius:14px;
      text-align:center;
      font-size:14px;
      background:#fff;
      color:#333;
      font-weight:700;
      min-height:46px;
      word-break:break-word;
      overflow-wrap:anywhere;
      transition:background .15s,color .15s,border-color .15s;
    }
    /* Rellenos por estado */
    .step.fill-accepted{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .step.fill-preparing{background:var(--st-preparing);border-color:var(--st-preparing);color:#fff}
    .step.fill-ready_for_pickup{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .step.fill-completed{background:var(--st-completed);border-color:var(--st-completed);color:#fff}
    .step.fill-cancelled{background:var(--st-cancelled);border-color:var(--st-cancelled);color:#fff}

    .small{font-size:13px}
    .error{color:#b00020}
    .items .line{display:flex;align-items:flex-start;justify-content:space-between;margin:10px 0;gap:12px}
    .items .muted{font-size:13px}

    /* Píldora de pago debajo del total */
    .pay-pill{display:inline-block;border-radius:999px;padding:8px 12px;font-weight:800;font-size:13px;color:#fff}
    .pay-paid{background:var(--pay-paid)}
    .pay-pending{background:var(--pay-pending)}

    /* Fila de metadatos con wrap */
    .meta{display:flex;gap:8px;flex-wrap:wrap}

    /* Watermark de logo */
    html, body { min-height: 100%; }
    body { position: relative; }
    body::before{
      content: "";
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: clamp(240px, 48vmin, 560px);
      background: url("images/logo.png") center / contain no-repeat;
      opacity: 0.08;
      pointer-events: none;
      z-index: 5;
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">Volver al menú</a>
    </div>
  </header>

  <main>
    <!-- Izquierda: estado en tiempo real -->
    <section class="card">
      <h1>¡Gracias por tu pedido! <span id="greet" class="muted"></span></h1>
      <div class="row">
        <div id="badge" class="badge">Estado: —</div>
        <div id="num" class="muted">#—</div>
      </div>

      <div class="steps">
        <div class="step" id="st-pending_payment">Pago pendiente</div>
        <div class="step" id="st-accepted">Recibido</div>
        <div class="step" id="st-preparing">Preparando</div>
        <div class="step" id="st-ready_for_pickup">Listo para retirar</div>
        <div class="step" id="st-completed">Entregado</div>
      </div>

      <div style="margin-top:12px" class="small muted meta">
        <span>Última actualización: <span id="time">—</span></span>
        <span>•</span>
        <span>Forma de pago: <span id="pay">—</span></span>
        <span>•</span>
        <span>Entrega: <span id="deliv">—</span></span>
      </div>

      <div id="info" class="small muted" style="margin-top:8px">Cargando estado…</div>
    </section>

    <!-- Derecha: resumen del pedido -->
    <aside class="card">
      <h2>Tu pedido</h2>
      <div id="items" class="items"></div>
      <div class="row total">
        <div>Total</div>
        <div id="resTotal">$ 0</div>
      </div>
      <div style="margin-top:6px">
        <span id="payPill" class="pay-pill pay-pending">PENDIENTE DE PAGO</span>
      </div>
      <div class="small muted" style="margin-top:10px">Si necesitás modificar algo, escribinos por WhatsApp con tu número de pedido.</div>
    </aside>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // ================== FIREBASE ==================
    var firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    var db = firebase.firestore();

    // ================== HELPERS ==================
    function $(s){ return document.querySelector(s); }
    function qs(name){ const p = new URLSearchParams(location.search); return p.get(name)||""; }
    function money(n){ return (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0}); }
    function fmt(ts){ if(!ts) return "—"; var d = ts.toDate ? ts.toDate() : new Date(ts); return d.toLocaleString("es-AR", { dateStyle:"medium", timeStyle:"short" }); }
    function friesName(v){ return v==="con_sazon" ? "Con sazón" : "Sin sazonar"; }
    function unitWithExtras(it){
      var base = (it.item && it.item.price) ? it.item.price : (it.price||0);
      var pz = ((it.extras && it.extras.patty) ? it.extras.patty : 0) * ((it.extras && it.extras.EXTRA_PRICE_PATTY) ? it.extras.EXTRA_PRICE_PATTY : 0);
      var ch = ((it.extras && it.extras.cheddar) ? it.extras.cheddar : 0) * ((it.extras && it.extras.EXTRA_PRICE_CHEDDAR) ? it.extras.EXTRA_PRICE_CHEDDAR : 0);
      return base + pz + ch;
    }
    function statusLabel(s){
      return {
        pending_payment: "Pago pendiente",
        accepted: "Recibido",
        preparing: "Preparando",
        ready_for_pickup: "Listo para retirar",
        completed: "Entregado",
        cancelled: "Cancelado"
      }[s] || "—";
    }
    function colorClass(s){
      return {
        accepted:'accepted',
        preparing:'preparing',
        ready_for_pickup:'ready_for_pickup',
        completed:'completed',
        cancelled:'cancelled',
        pending_payment:'pending_payment'
      }[s] || 'accepted';
    }

    // Orden lógico de pipeline
    var PIPELINE = ['pending_payment','accepted','preparing','ready_for_pickup','completed'];

    function fillSteps(current){
      // Limpiar
      document.querySelectorAll('.steps .step').forEach(function(el){
        el.className = 'step';
      });
      if(current === 'cancelled') return; // cancelado: no rellenamos pipeline

      var idx = PIPELINE.indexOf(current);
      if(idx < 0) return;
      for(var i=0;i<=idx;i++){
        var key = PIPELINE[i];
        var el = document.getElementById('st-'+key);
        if(el){ el.classList.add('fill-'+colorClass(key)); }
      }
    }

    // Mapear estado interno → público (por compatibilidad)
    function toPublic(s){
      return ({
        accepted:'accepted',
        pending_payment:'pending_payment',
        in_prep:'preparing',
        preparing:'preparing',
        ready:'ready_for_pickup',
        ready_for_pickup:'ready_for_pickup',
        delivered:'completed',
        completed:'completed',
        cancelled:'cancelled'
      })[s] || s || 'accepted';
    }

    // ================== UI helpers para estado ==================
    function updateStatusUI(pubStatus, updatedAt, pago, entrega, paidFlag){
      var infoEl = document.getElementById("info");
      if(infoEl) infoEl.textContent = "";

      var badge = $("#badge");
      badge.textContent = "Estado: " + statusLabel(pubStatus);
      badge.className = "badge " + colorClass(pubStatus);

      fillSteps(pubStatus);

      if(updatedAt) $("#time").textContent = fmt(updatedAt);
      if(pago) $("#pay").textContent = pago === 'efectivo' ? 'Efectivo' : (pago || '—');
      if(entrega) $("#deliv").textContent = entrega === 'take_away' ? 'Take Away' : (entrega || '—');

      // Píldora de pago bajo el total
      var paid = !!paidFlag;
      var el = $("#payPill");
      if(el){
        el.textContent = paid ? "PAGADO" : "PENDIENTE DE PAGO";
        el.className = "pay-pill " + (paid ? "pay-paid" : "pay-pending");
      }
    }

    // ================== ITEMS ==================
    function renderItems(order){
      var cont = $("#items");
      cont.innerHTML = "";
      var total = 0;
      if(!order || !Array.isArray(order.items)){ $("#resTotal").textContent = money(0); return; }
      order.items.forEach(function(it){
        var line = 0;
        if(it.type === 'burger'){
          var unit = unitWithExtras(it);
          line = unit * (it.qty||0);
          var extras = [];
          if(it.extras && it.extras.patty){ extras.push("+"+it.extras.patty+" medallón(es)"); }
          if(it.extras && it.extras.cheddar){ extras.push("+"+it.extras.cheddar+" cheddar"); }
          var html = ''
            + '<div class="line">'
            +   '<div>'
            +     '<div><strong>'+(it.qty||0)+'× '+(it.name||'')+'</strong></div>'
            +     '<div class="muted">Papas: '+friesName(it.fries||'sin_sazon')+(extras.length?(' · '+extras.join(' · ')):'' )+'</div>'
            +     (it.notes?('<div class="muted">Notas: '+it.notes+'</div>'):'')
            +   '</div>'
            +   '<div>'+money(line)+'</div>'
            + '</div>';
          cont.insertAdjacentHTML('beforeend', html);
        } else {
          line = ((it.price||0) * (it.qty||0));
          var html2 = ''
            + '<div class="line">'
            +   '<div><strong>'+(it.qty||0)+'× '+(it.name||'')+'</strong></div>'
            +   '<div>'+money(line)+'</div>'
            + '</div>';
          cont.insertAdjacentHTML('beforeend', html2);
        }
        total += line;
      });
      $("#resTotal").textContent = money(total || order.total || 0);
    }

    // ================== BOOT & LISTENERS ==================
    var orderId = qs("id");
    var token   = qs("t");

    function attachPublicListener(){
      if(!token) return;
      db.collection("order_public").doc(token).onSnapshot(function(snap){
        if(!snap.exists){
          $("#info").innerHTML = '<span class="error">No encontramos este pedido público. Verificá el link.</span>';
          return;
        }
        var d = snap.data();
        $("#greet").textContent = d && d.nombre ? `, ${d.nombre}` : "";
        $("#num").textContent = "#" + (d.orderNumber || "—");

        // paidFlag: si trae payment_status o paid
        var paidFlag = (d.payment_status === 'paid') || !!d.paid;

        updateStatusUI(
          d.status,                       // público ya
          d.updatedAt || d.createdAt,
          d.pago,
          d.entrega,
          paidFlag
        );
      }, function(err){
        $("#info").innerHTML = '<span class="error">Error de conexión al estado público: '+(err && err.message ? err.message : err)+'</span>';
      });
    }

    var privateUnsub = null;
    function attachPrivateListener(){
      if(!orderId) return;
      if(privateUnsub) { privateUnsub(); privateUnsub = null; }
      privateUnsub = db.collection("orders").doc(orderId).onSnapshot(function(doc){
        if(!doc.exists){ return; }
        var d = doc.data();
        if(d.trackToken && token && d.trackToken !== token){
          $("#items").innerHTML = '<div class="small error">Por seguridad no mostramos el detalle porque el token no coincide.</div>';
          $("#resTotal").textContent = money(0);
          return;
        }
        renderItems(d);

        var pub = toPublic(d.status || 'accepted');
        var paidFlag = (d.payment_status === 'paid') || !!d.paid;

        updateStatusUI(
          pub,
          d.updatedAt || d.createdAt,
          d.pago,
          d.entrega,
          paidFlag
        );
      }, function(err){
        $("#items").innerHTML = '<div class="small error">Error de conexión al detalle: '+(err && err.message ? err.message : err)+'</div>';
      });
    }

    (async function boot(){
      if(!orderId && !token){
        $("#info").innerHTML = '<span class="error">Link inválido: faltan parámetros.</span>';
        return;
      }
      if(!token && orderId){
        try{
          var snap = await db.collection("orders").doc(orderId).get();
          if(snap.exists && snap.data().trackToken){
            token = snap.data().trackToken;
            history.replaceState(null, "", location.pathname + "?id="+encodeURIComponent(orderId)+"&t="+encodeURIComponent(token));
          }
        }catch(e){}
      }
      if(token){ attachPublicListener(); }
      attachPrivateListener();
    })();
  </script>
</body>
</html>
