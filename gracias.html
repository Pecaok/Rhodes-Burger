<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>¡Gracias! • Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
      --st-accepted:#FBC02D; --st-preparing:#FB8C00; --st-ready:#00ACC1; --st-completed:#2E7D32; --st-cancelled:#D32F2F;
      --pay-pending:#FFA000; --pay-paid:#625A45;
      --star-off:#DDD; --star-on:#F5A524;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ main{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;overflow:visible}
    h1{font-size:28px;margin:10px 0 8px}
    h2{font-size:18px;margin:10px 0}
    .muted{color:var(--muted)}

    .row{display:flex;align-items:center;justify-content:space-between;margin:8px 0;gap:12px;flex-wrap:wrap}
    .total{font-weight:800;font-size:18px}

    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1.5px solid var(--ring);font-weight:800;background:#fff}
    .badge.accepted{border-color:var(--st-accepted);color:var(--st-accepted)}
    .badge.preparing{border-color:var(--st-preparing);color:var(--st-preparing)}
    .badge.ready_for_pickup{border-color:var(--st-ready);color:var(--st-ready)}
    .badge.completed{border-color:var(--st-completed);color:var(--st-completed)}
    .badge.cancelled{border-color:var(--st-cancelled);color:var(--st-cancelled)}

    .steps{ display:grid; grid-template-columns:repeat(auto-fit,minmax(132px,1fr)); gap:10px; margin-top:12px; }
    .step{ padding:12px; border:1.5px solid var(--ring); border-radius:14px; text-align:center; font-size:14px; background:#fff; color:#333; font-weight:700; min-height:46px; overflow-wrap:anywhere; transition:background .15s,color .15s,border-color .15s; }
    .step.fill-accepted{background:var(--st-accepted);border-color:var(--st-accepted);color:#000}
    .step.fill-preparing{background:var(--st-preparing);border-color:var(--st-preparing);color:#fff}
    .step.fill-ready_for_pickup{background:var(--st-ready);border-color:var(--st-ready);color:#fff}
    .step.fill-completed{background:var(--st-completed);border-color:var(--st-completed);color:#fff}
    .step.fill-cancelled{background:var(--st-cancelled);border-color:var(--st-cancelled);color:#fff}

    .small{font-size:13px}
    .error{color:#b00020}
    .success{color:#2E7D32;font-weight:700}
    .items .line{display:flex;align-items:flex-start;justify-content:space-between;margin:10px 0;gap:12px}
    .items .muted{font-size:13px}

    .pay-pill{display:inline-block;border-radius:999px;padding:8px 12px;font-weight:800;font-size:13px;color:#fff}
    .pay-paid{background:var(--pay-paid)}
    .pay-pending{background:var(--pay-pending)}

    .meta{display:flex;gap:8px;flex-wrap:wrap}

    /* Comentarios */
    .textarea {
      width:100%; min-height:96px; max-height:220px; padding:12px 14px;
      border:1px solid var(--ring); border-radius:14px; background:#faf9f7;
      resize:vertical; font-size:15px; line-height:1.35;
      transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
      margin-top:12px;
      position:relative; z-index:0;
    }
    .textarea::placeholder{color:#9a9a9a}
    .textarea:focus{outline:0; background:#fff; border-color:var(--primary); box-shadow:0 0 0 3px rgba(98,90,69,.18)}
    .field-foot{display:flex; justify-content:space-between; align-items:center; margin-top:6px; font-size:12px; color:#8a8a8a}
    .right-actions{display:flex;gap:8px;align-items:center}
    .bordered{border:1.5px solid var(--ring);padding:12px;border-radius:12px;background:#fff}

    /* Estrellas accesibles y persistentes */
    .rating-wrap{display:flex;align-items:flex-start;gap:14px;flex-wrap:wrap}
    .stars{display:inline-flex;gap:10px;margin-bottom:8px;position:relative;z-index:1;user-select:none}
    .star{
      -webkit-appearance:none;appearance:none;border:0;background:none;margin:0;
      cursor:pointer;font-size:40px;line-height:1.1;color:var(--star-off);
      transition:color .12s ease, transform .06s ease;
      width:42px;height:42px;display:flex;align-items:center;justify-content:center;
      border-radius:8px;-webkit-tap-highlight-color:transparent;
    }
    .star.on{ color:var(--star-on) !important; }
    .star:hover,.star.preview{ color:var(--star-on) !important; }
    .star:active{ transform:scale(.92) }
    .star:focus{ outline:3px solid rgba(98,90,69,.35) }

    html,body{min-height:100%}
    body{position:relative}
    body::before{
      content:""; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:clamp(240px,48vmin,560px); background:url("images/logo.png") center/contain no-repeat;
      opacity:.08; pointer-events:none; z-index:5;
    }

    /* Transferencia */
    .tf-box{border:1.5px solid var(--ring); border-radius:14px; padding:12px; background:#fff; margin-top:10px}
    .tf-row{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed #eee}
    .tf-row:last-child{border-bottom:0}
    .tf-label{font-weight:800; color:#333}
    .tf-value{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .copy-btn{border:1px solid var(--ring); background:#f9f9f9; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">Volver al menú</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>¡Gracias por tu pedido! <span id="greet" class="muted"></span></h1>
      <div class="row">
        <div id="badge" class="badge">Estado: —</div>
        <div id="num" class="muted">#—</div>
      </div>

      <div class="steps">
        <div class="step" id="st-pending_payment">Pago pendiente</div>
        <div class="step" id="st-accepted">Recibido</div>
        <div class="step" id="st-preparing">Preparando</div>
        <div class="step" id="st-ready_for_pickup">Listo para retirar</div>
        <div class="step" id="st-completed">Entregado</div>
      </div>

      <div style="margin-top:12px" class="small muted meta">
        <span>Última actualización: <span id="time">—</span></span>
        <span>•</span>
        <span>Forma de pago: <span id="pay">—</span></span>
        <span>•</span>
        <span>Entrega: <span id="deliv">—</span></span>
      </div>

      <div id="info" class="small muted" style="margin-top:8px">Cargando estado…</div>
    </section>

    <aside class="card">
      <h2>Tu pedido</h2>
      <div id="items" class="items"></div>
      <div class="row total"><div>Total</div><div id="resTotal">$ 0</div></div>
      <div style="margin-top:6px"><span id="payPill" class="pay-pill pay-pending">PENDIENTE DE PAGO</span></div>

      <!-- BLOQUE TRANSFERENCIA -->
      <div id="transferInfo" class="tf-box" style="display:none">
        <div class="small" style="font-weight:800;margin-bottom:6px">Si elegís abonar mediante <span style="font-weight:900">transferencia</span>, nuestros datos son:</div>
        <div class="tf-row">
          <div class="tf-label">Alias</div>
          <div class="tf-value" id="tfAlias">—</div>
          <button class="copy-btn" data-copy="#tfAlias">Copiar</button>
        </div>
        <div class="tf-row">
          <div class="tf-label">CVU</div>
          <div class="tf-value" id="tfCVU">—</div>
          <button class="copy-btn" data-copy="#tfCVU">Copiar</button>
        </div>
        <div class="tf-row">
          <div class="tf-label">Nombre</div>
          <div class="tf-value" id="tfNombre">—</div>
          <button class="copy-btn" data-copy="#tfNombre">Copiar</button>
        </div>
      </div>
      <!-- /BLOQUE TRANSFERENCIA -->

      <div class="small muted" style="margin-top:10px">Si necesitás modificar algo, escribinos por WhatsApp con tu número de pedido.</div>
    </aside>

    <!-- Comentarios + rating -->
    <section class="card">
      <h2>Dejanos tu comentario</h2>
      <div class="bordered">
        <div class="rating-wrap">
          <div class="stars" id="ratingStars" role="radiogroup" aria-label="Calificación de 1 a 5">
            <button type="button" class="star" data-val="1" aria-label="1 estrella">★</button>
            <button type="button" class="star" data-val="2" aria-label="2 estrellas">★</button>
            <button type="button" class="star" data-val="3" aria-label="3 estrellas">★</button>
            <button type="button" class="star" data-val="4" aria-label="4 estrellas">★</button>
            <button type="button" class="star" data-val="5" aria-label="5 estrellas">★</button>
          </div>
        </div>

        <textarea id="fbText" class="textarea" maxlength="300" placeholder="¿Cómo estuvo tu experiencia? (máx. 300 caracteres)"></textarea>
        <div class="field-foot">
          <span id="fbCount">0/300</span>
          <div class="right-actions"><button id="btnSendFb" class="btn primary">Enviar</button></div>
        </div>
        <div id="fbMsg" class="small muted" style="margin-top:6px"></div>
      </div>
    </section>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    /* ===== Firebase ===== */
    var firebaseConfig={apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig)}
    var db=firebase.firestore();

    /* ===== Helpers ===== */
    const $=s=>document.querySelector(s);
    const qs=n=>new URLSearchParams(location.search).get(n)||"";
    const money=n=>(Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const fmt=ts=>{if(!ts)return"—";const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleString("es-AR",{dateStyle:"medium",timeStyle:"short"})};
    const friesName=v=>v==="con_sazon"?"Con sazón":"Sin sazonar";
    function unitWithExtras(it){
      const base=(it.item&&it.item.price)?it.item.price:(it.price||0);
      const pz=((it.extras&&it.extras.patty)?it.extras.patty:0)*((it.extras&&it.extras.EXTRA_PRICE_PATTY)?it.extras.EXTRA_PRICE_PATTY:0);
      const ch=((it.extras&&it.extras.cheddar)?it.extras.cheddar:0)*((it.extras&&it.extras.EXTRA_PRICE_CHEDDAR)?it.extras.EXTRA_PRICE_CHEDDAR:0);
      return base+pz+ch;
    }
    function statusLabel(s){return{pending_payment:"Pago pendiente",accepted:"Recibido",preparing:"Preparando",ready_for_pickup:"Listo para retirar",completed:"Entregado",cancelled:"Cancelado"}[s]||"—"}
    function colorClass(s){return{accepted:'accepted',preparing:'preparing',ready_for_pickup:'ready_for_pickup',completed:'completed',cancelled:'cancelled',pending_payment:'pending_payment'}[s]||'accepted'}
    const PIPELINE=['pending_payment','accepted','preparing','ready_for_pickup','completed'];
    function fillSteps(cur){
      document.querySelectorAll('.steps .step').forEach(el=>el.className='step');
      if(cur==='cancelled')return;
      const i=PIPELINE.indexOf(cur); if(i<0)return;
      for(let k=0;k<=i;k++){
        const key=PIPELINE[k]; const el=document.getElementById('st-'+key);
        if(el) el.classList.add('fill-'+colorClass(key));
      }
    }
    function toPublic(s){return({accepted:'accepted',pending_payment:'pending_payment',in_prep:'preparing',preparing:'preparing',ready:'ready_for_pickup',ready_for_pickup:'ready_for_pickup',delivered:'completed',completed:'completed',cancelled:'cancelled'})[s]||s||'accepted'}

    /* ===== Transferencia: datos + utilidades ===== */
    const TRANSFER_DATA = {
      alias: "RhodesBurgers",
      cvu: "0000003100138491469854",
      nombre: "Marco Leonardi"
    };
    function readPayFrom(d){
      const candidates = [
        d?.pago, d?.payment_method, d?.paymentMethod, d?.payment, d?.pay,
        d?.medioPago, d?.metodoPago, d?.metodo_de_pago, d?.method
      ].filter(v => v!=null);
      for (const v of candidates){
        const s = String(v).trim();
        if (s) return s;
      }
      return null;
    }
    function shouldShowTransfer(v){
      const force = new URLSearchParams(location.search).get('forceTransfer');
      if (force === '1') return true;
      if(!v) return false;
      const s = String(v).toLowerCase();
      return s.includes('transfer') || s.includes('cvu') || s.includes('banc');
    }
    function updateTransferVisibility(){
      const box = $("#transferInfo");
      if(!box) return;
      const show = shouldShowTransfer(UI.pago);
      if(show){
        $("#tfAlias").textContent  = TRANSFER_DATA.alias;
        $("#tfCVU").textContent    = TRANSFER_DATA.cvu;
        $("#tfNombre").textContent = TRANSFER_DATA.nombre;
        box.style.display = "block";
      }else{
        box.style.display = "none";
      }
    }
    function copyFrom(sel){
      try{
        const el = document.querySelector(sel);
        const txt = el ? el.textContent.trim() : '';
        if(!txt) return;
        navigator.clipboard.writeText(txt);
      }catch(_){}
    }
    document.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-copy]');
      if(!b) return;
      copyFrom(b.getAttribute('data-copy'));
      b.textContent = 'Copiado';
      setTimeout(()=>{ b.textContent = 'Copiar'; }, 1200);
    });

    /* ===== Estado fusionado/UI ===== */
    const UI={orderNumber:null,pago:null,entrega:null,nombre:null};
    function setNum(n){if(!n)return;UI.orderNumber=n;$("#num").textContent="#"+n}
    function setPago(v){
      if(!v)return;
      UI.pago=v;
      $("#pay").textContent=(String(v).toLowerCase()==='efectivo'?'Efectivo':v);
      updateTransferVisibility();
    }
    function setEntrega(v){if(!v)return;UI.entrega=v;$("#deliv").textContent=(v==='take_away'?'Take Away':v)}
    function updateStatusUI(pub,updatedAt,paid){
      const info=$("#info"); if(info) info.textContent="";
      const badge=$("#badge"); badge.textContent="Estado: "+statusLabel(pub); badge.className="badge "+colorClass(pub);
      fillSteps(pub); if(updatedAt) $("#time").textContent=fmt(updatedAt);
      const pill=$("#payPill"); if(pill){pill.textContent=paid?"PAGADO":"PENDIENTE DE PAGO"; pill.className="pay-pill "+(paid?"pay-paid":"pay-pending");}
    }

    function renderItems(order){
      const cont=$("#items"); cont.innerHTML=""; let total=0;
      if(!order||!Array.isArray(order.items)){ $("#resTotal").textContent=money(0); return; }
      order.items.forEach(it=>{
        let line=0;
        if(it.type==='burger'){
          const unit=unitWithExtras(it); line=unit*(it.qty||0);
          const extras=[]; if(it.extras&&it.extras.patty){extras.push("+"+it.extras.patty+" medallón(es)");}
          if(it.extras&&it.extras.cheddar){extras.push("+"+it.extras.cheddar+" cheddar");}
          cont.insertAdjacentHTML('beforeend',`<div class="line"><div><div><strong>${it.qty||0}× ${it.name||''}</strong></div><div class="muted">Papas: ${friesName(it.fries||'sin_sazon')}${extras.length?(' · '+extras.join(' · ')):''}</div>${it.notes?('<div class="muted">Notas: '+it.notes+'</div>'):''}</div><div>${money(line)}</div></div>`);
        }else{
          line=((it.price||0)*(it.qty||0));
          cont.insertAdjacentHTML('beforeend',`<div class="line"><div><strong>${it.qty||0}× ${it.name||''}</strong></div><div>${money(line)}</div></div>`);
        }
        total+=line;
      });
      $("#resTotal").textContent=money(total||order.total||0);
    }

    function extractOrderNumberFromPrivate(d){
      const fields=[d.orderNumber,d.number,d.numero,d.num,d.nro,d.seq,d.orderNo,d.pedidoNumber,d.pedido];
      for(const v of fields){ if(v==null)continue; const n=typeof v==="string"?parseInt(v,10):v; if(Number.isFinite(n)) return n; }
      return null;
    }

    /* ===== Parámetros y listeners ===== */
    let orderId=qs("id"), token=qs("t");

    function attachPublicListener(){
      if(!token) return;
      db.collection("order_public").doc(token).onSnapshot(snap=>{
        if(!snap.exists){$("#info").innerHTML='<span class="error">No encontramos este pedido público. Verificá el link.</span>'; return;}
        const d=snap.data();
        $("#greet").textContent=d&&d.nombre?`, ${d.nombre}`:""; if(d&&d.nombre) UI.nombre=d.nombre;
        if(d.orderNumber) setNum(d.orderNumber);
        const pv = readPayFrom(d); if (pv) setPago(pv);
        if(d.entrega) setEntrega(d.entrega);
        updateStatusUI(d.status, d.updatedAt||d.createdAt, (d.payment_status==='paid')||!!d.paid);
      }, err=>{$("#info").innerHTML='<span class="error">Error de conexión al estado público: '+(err&&err.message?err.message:err)+'</span>';});
    }

    let privateUnsub=null;
    function attachPrivateListener(){
      if(!orderId) return;
      if(privateUnsub){privateUnsub(); privateUnsub=null;}
      privateUnsub=db.collection("orders").doc(orderId).onSnapshot(doc=>{
        if(!doc.exists) return;
        const d=doc.data();
        if(d.trackToken && token && d.trackToken!==token){
          $("#items").innerHTML='<div class="small error">Por seguridad no mostramos el detalle porque el token no coincide.</div>';
          $("#resTotal").textContent=money(0); return;
        }
        renderItems(d);
        const maybe=extractOrderNumberFromPrivate(d); if(maybe && !UI.orderNumber) setNum(maybe);
        const pv = readPayFrom(d); if (pv && !UI.pago) setPago(pv);
        if(d.entrega && !UI.entrega) setEntrega(d.entrega);
        if(!UI.nombre && d.nombre) UI.nombre=d.nombre;
        updateStatusUI(toPublic(d.status||'accepted'), d.updatedAt||d.createdAt, (d.payment_status==='paid')||!!d.paid);
      }, err=>{$("#items").innerHTML='<div class="small error">Error de conexión al detalle: '+(err&&err.message?err.message:err)+'</div>';});
    }

    /* ===== Feedback (comentario + rating) ===== */
    const fbText = ()=>$("#fbText");
    const fbCount= ()=>$("#fbCount");
    const fbMsg  = ()=>$("#fbMsg");
    const fbBtn  = ()=>$("#btnSendFb");
    const FB_MAX=300;

    function alreadySentKey(){return token?`rb_fb_sent_${token}`:(orderId?`rb_fb_sent_${orderId}`:`rb_fb_sent_unknown`);}

    let currentRating = 0;
    const stars = Array.from(document.querySelectorAll("#ratingStars .star"));
    function paintStars(n, preview=false){
      stars.forEach(btn=>{
        const v=Number(btn.dataset.val||0);
        btn.classList.toggle('on', v<=n);
        btn.classList.toggle('preview', preview && v<=n);
      });
    }
    function setRating(n){ currentRating=n; paintStars(n,false); }
    function updateCounter(){ fbCount().textContent = `${(fbText().value||'').length}/${FB_MAX}`; }
    function setFbState(disabled,message,ok){
      fbBtn().disabled=!!disabled;
      if(message!=null){ fbMsg().textContent=message; fbMsg().className="small "+(ok?"success":"error"); }
      else{ fbMsg().textContent=""; fbMsg().className="small muted"; }
    }
    function tryDisableIfAlreadySent(){
      try{
        if(localStorage.getItem(alreadySentKey())==='1'){
          fbText().disabled=true;
          stars.forEach(b=>{ b.disabled=true; b.style.cursor='default'; });
          setFbState(true,"¡Gracias! Ya recibimos tu comentario.",true);
          return true;
        }
      }catch(_){}
      return false;
    }
    async function sendFeedback(){
      const txt=(fbText().value||'').trim();
      const rating=currentRating||0;
      if(!txt && !rating){ setFbState(false,"Dejanos un comentario o elegí una calificación para enviar.",false); return; }
      if(txt.length>FB_MAX){ setFbState(false,"Tu comentario es muy largo.",false); return; }
      setFbState(true,"Enviando…",true);
      const payload={comment:txt||null,rating:rating||null,orderId:orderId||null,token:token||null,orderNumber:UI.orderNumber||null,nombre:UI.nombre||null,pago:UI.pago||null,entrega:UI.entrega||null,userAgent:navigator.userAgent||"",createdAt:firebase.firestore.FieldValue.serverTimestamp()};
      try{
        await db.collection("feedback").add(payload);
        localStorage.setItem(alreadySentKey(),'1');
        fbText().disabled=true; stars.forEach(b=>{b.disabled=true; b.style.cursor='default';});
        setFbState(true,"¡Gracias! Tu comentario fue enviado.",true);
      }catch(e){
        console.error(e);
        setFbState(false,"No se pudo enviar. Intentá nuevamente.",false);
      }
    }

    (async function boot(){
      if(!orderId && !token){ $("#info").innerHTML='<span class="error">Link inválido: faltan parámetros.</span>'; return; }

      if(!token && orderId){
        try{
          const snap=await db.collection("orders").doc(orderId).get();
          if(snap.exists && snap.data().trackToken){
            token=snap.data().trackToken;
            history.replaceState(null,"",location.pathname+"?id="+encodeURIComponent(orderId)+"&t="+encodeURIComponent(token));
          }
        }catch(e){}
      }
      if(token) attachPublicListener();
      attachPrivateListener();

      if($("#fbText")){ $("#fbText").addEventListener('input',updateCounter); updateCounter(); }
      if($("#btnSendFb")){ $("#btnSendFb").addEventListener('click',sendFeedback); }

      stars.forEach(btn=>{
        const v=Number(btn.dataset.val||0);
        btn.addEventListener('mouseenter', ()=>paintStars(v,true));
        btn.addEventListener('mouseleave', ()=>paintStars(currentRating,false));
        btn.addEventListener('click', ()=>setRating(v));
        btn.addEventListener('keydown', e=>{
          if(['ArrowRight','ArrowUp'].includes(e.key)){ setRating(Math.min(5,(currentRating||0)+1||1)); e.preventDefault(); }
          if(['ArrowLeft','ArrowDown'].includes(e.key)){ setRating(Math.max(1,(currentRating||0)-1||1)); e.preventDefault(); }
          if(e.key==='Home'){ setRating(1); e.preventDefault(); }
          if(e.key==='End'){ setRating(5); e.preventDefault(); }
        });
        btn.setAttribute('tabindex','0');
        btn.setAttribute('role','radio');
        btn.setAttribute('aria-checked','false');
      });

      paintStars(0,false);
      tryDisableIfAlreadySent();
      // Si se forzó por URL antes de que llegue el dato de pago, mostrar cuando llegue:
      updateTransferVisibility();
    })();
  </script>
</body>
</html>
