<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ingresos â€¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
      --danger:#d32f2f; --warn:#ff9800; --success:#2e7d32;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    
    /* HEADER */
    header{position:sticky; top:0; z-index:100; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{width: 100%; padding:10px 20px; display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit; transition:all .2s}
    .btn:hover{background:#f4f4f4}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b30000}

    /* DROPDOWN */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 180px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); border-radius: 12px; border: 1px solid var(--ring); z-index: 200; top: 110%; left: 0; overflow: hidden; padding: 4px 0; }
    .dropdown-content a { color: var(--text); padding: 10px 16px; text-decoration: none; display: block; font-size: 14px; font-weight: 500; }
    .dropdown-content a:hover { background-color: #f4f4f4; color: var(--primary); }
    .dropdown:hover .dropdown-content { display: block; }

    /* LAYOUT */
    .container { max-width: 900px; margin: 24px auto; padding: 0 12px; }
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:24px; position:relative}
    .row{display:flex;align-items:center;gap:15px;flex-wrap:wrap; margin-bottom:15px}
    
    input, select { padding:10px; border:1px solid var(--ring); border-radius:10px; width:100%; outline:none; font-family:inherit; background:#fff }
    input:focus, select:focus { border-color:var(--primary) }
    label { font-size:12px; font-weight:700; color:var(--muted); margin-bottom:4px; display:block }

    /* TABLA DE CARGA */
    .entry-table { width:100%; border-collapse:collapse; margin-top:15px }
    .entry-table th { text-align:left; font-size:12px; color:#999; text-transform:uppercase; padding:10px; border-bottom:1px solid #eee }
    .entry-table td { padding:8px; border-bottom:1px solid #f9f9f9 }
    .entry-table input, .entry-table select { border:1px solid #eee; padding:8px }
    .trash-btn { cursor:pointer; background:none; border:none; font-size:18px; opacity:0.5 }
    .trash-btn:hover { opacity:1; color:var(--danger) }

    .total-row { text-align:right; padding:20px; font-size:18px; font-weight:800; border-top:2px solid #eee }

    /* TABLA HISTORIAL (NUEVA) */
    .history-table { width:100%; border-collapse:collapse; font-size:14px; }
    .history-table th { text-align:left; background:#fafafa; padding:12px; font-weight:700; color:#555; border-bottom:2px solid #eee; }
    .history-table td { padding:12px; border-bottom:1px solid #eee; vertical-align:top; }
    .hist-items { font-size:12px; color:#666; display:block; margin-top:4px; }
  </style>
</head>
<body>
  <script>
    (function(){
      const ok = localStorage.getItem('rb_admin_ok')==='true';
      if(!ok) location.replace('login.html');
    })();
  </script>

  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png" alt="RB">Ingresos</a>
      <div class="spacer"></div>
      <nav style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <a href="pedido_local.html" class="btn">ðŸ“¦ Pedidos</a>
        <a href="finanzas.html" class="btn">ðŸ“ˆ Finanzas</a>
        <div class="dropdown">
            <button class="btn primary">ðŸ“‹ Stock â–¾</button>
            <div class="dropdown-content">
                <a href="stock.html">ðŸ“¦ Ver Stock Actual</a>
                <a href="ingresos.html">ðŸ“¥ Ingreso MercaderÃ­a</a>
                <a href="proveedores.html">ðŸšš Proveedores</a>
            </div>
        </div>
        <a href="mostrador.html" class="btn">ðŸ§¾ Mostrador</a>
      </nav>
      <button onclick="localStorage.removeItem('rb_admin_ok');location.reload()" class="btn danger" style="margin-left:8px">Salir</button>
    </div>
  </header>

  <main class="container">
    <h1>Ingreso de MercaderÃ­a</h1>
    
    <div class="card">
        <div class="row">
            <div style="flex:1">
                <label>Fecha</label>
                <input type="date" id="entryDate">
            </div>
            <div style="flex:2">
                <label>Proveedor (Opcional)</label>
                <input type="text" id="provider" placeholder="Ej: CarnicerÃ­a Don Pepe">
            </div>
            <div style="flex:1">
                <label>NÂ° Factura / Remito</label>
                <input type="text" id="invoice" placeholder="000-000">
            </div>
        </div>

        <hr style="border:0; border-top:1px dashed #eee; margin:20px 0">

        <div style="min-height:200px">
            <table class="entry-table">
                <thead>
                    <tr>
                        <th style="width:40%">Producto</th>
                        <th style="width:15%">Cantidad</th>
                        <th style="width:20%">Costo Unit.</th>
                        <th style="width:20%">Subtotal</th>
                        <th style="width:5%"></th>
                    </tr>
                </thead>
                <tbody id="linesBody">
                    </tbody>
            </table>
            
            <button id="btnAddLine" class="btn" style="margin-top:15px; border-style:dashed; width:100%; justify-content:center">ï¼‹ Agregar Producto</button>
        </div>

        <div class="total-row">
            Total Gastado: <span id="totalAmount">$0</span>
        </div>

        <div style="display:flex; justify-content:flex-end; margin-top:20px">
            <button id="btnSave" class="btn primary" style="padding:12px 24px; font-size:16px">âœ… Confirmar Ingreso</button>
        </div>
    </div>

    <div class="card" style="margin-top:20px">
        <h3>Historial de Ingresos</h3>
        <div style="overflow-x:auto">
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Proveedor / Factura</th>
                        <th>Detalle Compra</th>
                        <th style="text-align:right">Total</th>
                        <th style="text-align:center">AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <tr><td colspan="5" style="padding:20px; text-align:center; color:#999">Cargando historial...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // 1. CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
      authDomain: "rhodes-burguers.firebaseapp.com",
      projectId: "rhodes-burguers",
      storageBucket: "rhodes-burguers.firebasestorage.app",
      messagingSenderId: "951646688091",
      appId: "1:951646688091:web:05db5fadb4150d1fa9c07e"
    };
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    
    let PRODUCTS = []; // Cache de productos

    // 2. INIT
    document.addEventListener('DOMContentLoaded', async () => {
        $('#entryDate').valueAsDate = new Date();

        // Cargar productos para el select
        const snap = await db.collection('inventory').orderBy('name').get();
        PRODUCTS = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        addLine(); // Primera linea
        
        // Escuchar Historial en tiempo real
        loadHistory();

        // Eventos
        $('#btnAddLine').onclick = addLine;
        $('#btnSave').onclick = saveEntry;
    });

    // 3. LOGICA FILAS
    function addLine(){
        const tbody = $('#linesBody');
        const tr = document.createElement('tr');
        
        let options = `<option value="">Seleccionar...</option>`;
        PRODUCTS.forEach(p => {
            options += `<option value="${p.id}" data-unit="${p.unit}">${p.name} (${p.unit})</option>`;
        });

        tr.innerHTML = `
            <td><select class="p-select">${options}</select></td>
            <td><input type="number" class="p-qty" step="0.1" min="0" placeholder="0"></td>
            <td><input type="number" class="p-cost" step="0.1" min="0" placeholder="$"></td>
            <td style="font-weight:bold; color:#666" class="p-subtotal">$0</td>
            <td><button class="trash-btn" onclick="removeLine(this)">ðŸ—‘</button></td>
        `;
        
        tr.querySelector('.p-qty').addEventListener('input', calcTotal);
        tr.querySelector('.p-cost').addEventListener('input', calcTotal);
        tbody.appendChild(tr);
    }

    function removeLine(btn){ btn.closest('tr').remove(); calcTotal(); }

    function calcTotal(){
        let total = 0;
        document.querySelectorAll('#linesBody tr').forEach(tr => {
            const qty = Number(tr.querySelector('.p-qty').value) || 0;
            const cost = Number(tr.querySelector('.p-cost').value) || 0;
            const sub = qty * cost;
            tr.querySelector('.p-subtotal').textContent = money(sub);
            total += sub;
        });
        $('#totalAmount').textContent = money(total);
        return total;
    }

    // 4. GUARDAR ENTRADA
    async function saveEntry(){
        const rows = document.querySelectorAll('#linesBody tr');
        const items = [];
        let totalCost = 0;

        rows.forEach(tr => {
            const pid = tr.querySelector('.p-select').value;
            const qty = Number(tr.querySelector('.p-qty').value);
            const cost = Number(tr.querySelector('.p-cost').value);
            const pname = tr.querySelector('.p-select').selectedOptions[0]?.text.split('(')[0].trim() || ''; // Nombre limpio

            if(pid && qty > 0){
                items.push({ pid, pname, qty, cost });
                totalCost += (qty*cost);
            }
        });

        if(items.length === 0) return alert("Lista vacÃ­a o cantidades en 0.");
        if(!confirm(`Â¿Confirmar ingreso por ${money(totalCost)}?`)) return;

        $('#btnSave').disabled = true; 
        $('#btnSave').textContent = "Guardando...";

        try {
            const batch = db.batch();
            
            // A. Guardar registro en historial
            const entryRef = db.collection('stock_entries').doc();
            batch.set(entryRef, {
                date: $('#entryDate').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                provider: $('#provider').value || 'Mostrador',
                invoice: $('#invoice').value || '-',
                totalCost: totalCost,
                items: items
            });

            // B. Actualizar stock
            items.forEach(it => {
                const prodRef = db.collection('inventory').doc(it.pid);
                batch.update(prodRef, { qty: firebase.firestore.FieldValue.increment(it.qty) });
            });

            await batch.commit();

            alert("Â¡Ingreso guardado correctamente!");
            window.location.reload(); // Recargar para limpiar y ver tabla actualizada

        } catch(e) {
            console.error(e);
            alert("Error al guardar.");
            $('#btnSave').disabled = false;
        }
    }

    // 5. CARGAR HISTORIAL (Tiempo real)
    function loadHistory(){
        db.collection('stock_entries')
          .orderBy('createdAt', 'desc')
          .limit(20)
          .onSnapshot(snap => {
              const tbody = $('#historyBody');
              tbody.innerHTML = '';

              if(snap.empty){
                  tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#999">No hay ingresos registrados aÃºn.</td></tr>`;
                  return;
              }

              snap.forEach(doc => {
                  const d = doc.data();
                  
                  // Formato de fecha (fix UTC con split)
                  const [yyyy, mm, dd] = (d.date || '').split('-');
                  const niceDate = d.date ? `${dd}/${mm}/${yyyy}` : '-';

                  // Resumen de items
                  const summary = (d.items || []).map(i => `${i.pname} (x${i.qty})`).join(', ');

                  const tr = document.createElement('tr');
                  tr.innerHTML = `
                    <td><strong>${niceDate}</strong></td>
                    <td>
                        <div>${d.provider}</div>
                        <div style="font-size:11px; color:#999">Fact: ${d.invoice}</div>
                    </td>
                    <td><span class="hist-items">${summary}</span></td>
                    <td style="text-align:right; font-weight:bold">${money(d.totalCost)}</td>
                    <td style="text-align:center">
                        <button class="trash-btn" style="color:#d32f2f" onclick="deleteEntry('${doc.id}')" title="Borrar del historial">Ã—</button>
                    </td>
                  `;
                  tbody.appendChild(tr);
              });
          });
    }

    // Borrar historial (Solo visual, no revierte stock para evitar bugs complejos)
    window.deleteEntry = async (id) => {
        if(confirm("Â¿Eliminar este registro del historial?\n\nNOTA: Esto NO descuenta el stock cargado, solo borra el registro contable.")){
            await db.collection('stock_entries').doc(id).delete();
        }
    };

    window.removeLine = removeLine;
  </script>
</body>
</html>
