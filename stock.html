<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stock & Recetas ‚Ä¢ Rhodes</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{ --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea; --danger:#d32f2f; --warn:#ff9800; --success:#2e7d32; }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif}
    header{position:sticky; top:0; z-index:100; background:#fff; box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{width: 100%; padding:10px 20px; display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700} .brand img{width:36px;margin-right:8px} .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#fff;padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600;text-decoration:none;color:inherit;transition:all .2s} .btn:hover{background:#f4f4f4}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)} .btn.danger{border-color:#ffdddd;background:#fff5f5;color:#b30000} .btn-sm{padding:4px 10px; font-size:14px; border-radius:8px}
    .dropdown { position: relative; display: inline-block; } .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 180px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); border-radius: 12px; border: 1px solid var(--ring); z-index: 200; top: 110%; left: 0; padding: 4px 0; } .dropdown-content a { color: var(--text); padding: 10px 16px; display: block; text-decoration: none; } .dropdown:hover .dropdown-content { display: block; }
    .container { max-width: 1000px; margin: 24px auto; padding: 0 12px; } .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px; position:relative}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap; margin-bottom:15px}
    input, select { padding:10px; border:1px solid var(--ring); border-radius:10px; width:100%; outline:none; }
    table{width:100%;border-collapse:collapse; margin-top:10px} th,td{padding:12px;border-bottom:1px solid #eee;text-align:left} th{font-size:12px;text-transform:uppercase;color:#888}
    .status-dot { height:10px; width:10px; border-radius:50%; display:inline-block; margin-right:6px } .st-ok { background:var(--success) } .st-warn { background:var(--warn) } .st-danger { background:var(--danger) }
    .qty-control { display:flex; align-items:center; gap:8px } .qty-btn { width:28px; height:28px; border-radius:6px; border:1px solid var(--ring); background:#fff; cursor:pointer; font-weight:bold }
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; z-index:900; backdrop-filter:blur(2px) } .modal { background:#fff; width:90%; max-width:500px; padding:25px; border-radius:20px; box-shadow:0 20px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
    .ing-list { border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-top: 10px; background: #fafafa; }
    .ing-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dashed #ddd; font-size: 14px; }
  </style>
</head>
<body>
  <script>if(localStorage.getItem('rb_admin_ok')!=='true') location.replace('login.html');</script>
  <header>
    <div class="topbar">
      <a class="brand" href="#"><img src="images/logo.png">Inventario</a> <div class="spacer"></div>
      <nav style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <a href="pedido_local.html" class="btn">üì¶ Pedidos</a> <a href="finanzas.html" class="btn">üìà Finanzas</a>
        <div class="dropdown"><button class="btn primary">üìã Stock ‚ñæ</button><div class="dropdown-content"><a href="stock.html">üì¶ Ver Stock</a><a href="ingresos.html">üì• Ingresos</a><a href="proveedores.html">üöö Proveedores</a></div></div>
        <a href="mostrador.html" class="btn">üßæ Mostrador</a>
      </nav>
      <button onclick="localStorage.removeItem('rb_admin_ok');location.reload()" class="btn danger" style="margin-left:8px">Salir</button>
    </div>
  </header>

  <main class="container">
    <div class="row">
        <h1>Control de Stock</h1>
        <div style="display:flex; gap:10px">
            <button id="btnRecetas" class="btn" style="background:#e3f2fd; color:#1565c0; border-color:#90caf9">üìñ Recetas</button>
            <button id="btnNew" class="btn primary">Ôºã Nuevo Producto</button>
        </div>
    </div>

    <div class="card">
        <div class="row" style="margin-bottom:20px">
            <div style="flex:1; min-width:200px"><input type="text" id="searchBox" placeholder="üîç Buscar ingrediente..." /></div>
            <div><select id="filterCat" style="width:auto"><option value="all">Todas</option><option value="carniceria">Carne</option><option value="panaderia">Pan</option><option value="almacen">Almac√©n</option><option value="verdularia">Verdura</option><option value="bebidas">Bebidas</option><option value="packaging">Pack</option></select></div>
        </div>
        <div style="overflow-x:auto">
            <table>
                <thead><tr><th>Producto</th><th>Cat</th><th>Actual</th><th>Min</th><th>Estado</th><th></th></tr></thead>
                <tbody id="stockTable"></tbody>
            </table>
        </div>
    </div>
  </main>

  <div class="modal-overlay" id="modalProd">
    <div class="modal">
        <h2 id="mpTitle">Nuevo Producto</h2> <input type="hidden" id="mpId">
        <div style="margin-bottom:15px"><label>Nombre</label><input type="text" id="mpName" placeholder="Ej: Cebolla Crispy"></div>
        <div style="margin-bottom:15px"><label>Categor√≠a</label><select id="mpCat"><option value="carniceria">Carne</option><option value="panaderia">Pan</option><option value="almacen">Almac√©n</option><option value="verdularia">Verdura</option><option value="bebidas">Bebidas</option><option value="packaging">Packaging</option></select></div>
        
        <div class="row">
            <div style="flex:1">
                <label>Stock</label>
                <input type="number" id="mpQty" step="0.001">
            </div>
            <div style="flex:1">
                <label>Unidad</label>
                <select id="mpUnit">
                    <option value="kg">Kilos (kg)</option>
                    <option value="gr">Gramos (gr)</option>
                    <option value="lt">Litros (l)</option>
                    <option value="ml">Mililitros (ml)</option>
                    <option value="u">Unidades (u)</option>
                    <option value="pq">Paquetes</option>
                </select>
            </div>
        </div>
        
        <div style="margin-bottom:15px"><label>M√≠nimo (Alerta)</label><input type="number" id="mpMin" value="5" step="0.001"></div>
        <div class="row"><button onclick="saveProduct()" class="btn primary" style="flex:1">Guardar</button><button onclick="$('#modalProd').style.display='none'" class="btn" style="flex:1">Cerrar</button></div>
        <button id="btnDelProd" class="btn danger" style="width:100%; margin-top:10px" onclick="delProduct()">Eliminar</button>
    </div>
  </div>

  <div class="modal-overlay" id="modalRecipe">
    <div class="modal" style="max-width:600px">
        <h2>Gestor de Recetas</h2>
        <p style="font-size:12px; color:#666; margin-bottom:15px">Conecta el nombre del pedido con los ingredientes del stock.</p>
        
        <div style="background:#f0f7ff; padding:15px; border-radius:10px; border:1px solid #d0e4ff; margin-bottom:20px">
            <label style="font-weight:bold; font-size:12px">NOMBRE EN EL PEDIDO (Exacto)</label>
            <input type="text" id="recName" placeholder="Ej: Hamburguesa Doble" style="background:#fff">
            
            <div style="margin-top:10px; display:flex; gap:10px; align-items:flex-end">
                <div style="flex:2">
                    <label style="font-size:11px">Agregar Ingrediente</label>
                    <select id="recIngSelect" style="background:#fff"></select>
                </div>
                <div style="flex:1">
                    <label style="font-size:11px">Cantidad (Seg√∫n stock)</label>
                    <input type="number" id="recIngQty" placeholder="Ej: 0.05" step="0.001" style="background:#fff">
                </div>
                <button class="btn primary" onclick="addIngToRecipe()">+</button>
            </div>

            <div id="recipeList" class="ing-list"><div style="text-align:center; color:#999; font-size:12px">Agrega ingredientes...</div></div>
            <button class="btn primary" style="width:100%; margin-top:10px" onclick="saveRecipe()">üíæ Guardar Receta</button>
        </div>

        <h3>Recetas Guardadas</h3>
        <div id="savedRecipes" style="max-height:200px; overflow-y:auto; font-size:13px"></div>
        <button onclick="$('#modalRecipe').style.display='none'" class="btn" style="width:100%; margin-top:15px">Cerrar</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try{firebase.initializeApp(firebaseConfig);}catch(e){}
    const db=firebase.firestore(); const $=s=>document.querySelector(s);
    let INVENTORY=[], RECIPES=[]; let currentIngs=[];

    function init(){
        db.collection('inventory').orderBy('name').onSnapshot(s=>{ INVENTORY=s.docs.map(d=>({id:d.id,...d.data()})); renderTable(); loadIngOptions(); });
        db.collection('recipes').onSnapshot(s=>{ RECIPES=s.docs.map(d=>({id:d.id,...d.data()})); renderSavedRecipes(); });
        
        $('#searchBox').oninput=renderTable; $('#filterCat').onchange=renderTable;
        $('#btnNew').onclick=()=>openProd(); 
        $('#btnRecetas').onclick=()=>{$('#modalRecipe').style.display='flex'; currentIngs=[]; renderCurrentIngs(); $('#recName').value='';};
    }

    // --- STOCK LOGIC ---
    function renderTable(){
        const t=$('#searchBox').value.toLowerCase(), c=$('#filterCat').value, b=$('#stockTable'); b.innerHTML='';
        INVENTORY.filter(p=>p.name.toLowerCase().includes(t) && (c==='all'||p.category===c)).forEach(p=>{
            let stHtml = `<span class="status-dot st-ok"></span>OK`;
            if(p.qty<=p.min) stHtml=`<span class="status-dot st-danger"></span>CRIT`; else if(p.qty<=p.min*1.5) stHtml=`<span class="status-dot st-warn"></span>BAJO`;
            
            // Mostrar hasta 3 decimales si no es entero
            const displayQty = Number(p.qty) % 1 !== 0 ? Number(p.qty).toFixed(3) : p.qty;

            b.insertAdjacentHTML('beforeend', `<tr><td><b>${p.name}</b></td><td><small>${p.category}</small></td>
            <td><div class="qty-control"><button class="qty-btn" onclick="upd('${p.id}',-1)">-</button><b>${displayQty}</b><button class="qty-btn" onclick="upd('${p.id}',1)">+</button> <small>${p.unit}</small></div></td>
            <td>${p.min}</td><td>${stHtml}</td><td><button class="btn btn-sm" onclick="openProd('${p.id}')">‚úèÔ∏è</button></td></tr>`);
        });
    }
    const upd=(id,v)=>{ const p=INVENTORY.find(i=>i.id===id); if(p) db.collection('inventory').doc(id).update({qty: Number(p.qty)+v}); };
    
    // --- RECIPE LOGIC ---
    function loadIngOptions(){
        const s=$('#recIngSelect'); s.innerHTML='<option value="">Seleccionar...</option>';
        INVENTORY.forEach(i=> s.insertAdjacentHTML('beforeend', `<option value="${i.name}">${i.name} (${i.unit})</option>`));
    }
    window.addIngToRecipe = () => {
        const name=$('#recIngSelect').value, qty=$('#recIngQty').value;
        if(!name || !qty) return alert("Selecciona ingrediente y cantidad");
        currentIngs.push({ingrediente: name, cantidad: Number(qty)});
        renderCurrentIngs(); $('#recIngQty').value='';
    };
    function renderCurrentIngs(){
        const l=$('#recipeList'); l.innerHTML='';
        if(!currentIngs.length) return l.innerHTML='<div style="text-align:center;color:#ccc">Lista vac√≠a</div>';
        currentIngs.forEach((i,x)=> l.insertAdjacentHTML('beforeend', `<div class="ing-item"><span>${i.cantidad} x ${i.ingrediente}</span> <button style="color:red;border:none;background:none;cursor:pointer" onclick="currentIngs.splice(${x},1);renderCurrentIngs()">√ó</button></div>`));
    }
    window.saveRecipe = async () => {
        const n=$('#recName').value.trim();
        if(!n || !currentIngs.length) return alert("Falta nombre o ingredientes");
        const exist = RECIPES.find(r=>r.id===n);
        if(exist && !confirm("Ya existe una receta con este nombre. ¬øSobreescribir?")) return;
        await db.collection('recipes').doc(n).set({ ingredients: currentIngs });
        alert("Receta guardada!"); $('#recName').value=''; currentIngs=[]; renderCurrentIngs();
    };
    function renderSavedRecipes(){
        const c=$('#savedRecipes'); c.innerHTML='';
        RECIPES.forEach(r=>{
            const txt = r.ingredients.map(i=>`${i.cantidad} ${i.ingrediente}`).join(', ');
            c.insertAdjacentHTML('beforeend', `<div style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between">
                <div><b>${r.id}</b><div style="color:#666;font-size:11px">${txt}</div></div>
                <button style="color:red;border:none;background:none;cursor:pointer" onclick="delRecipe('${r.id}')">üóë</button>
            </div>`);
        });
    }
    window.delRecipe = (id) => confirm("¬øBorrar receta?") ? db.collection('recipes').doc(id).delete() : null;

    // --- PRODUCT CRUD ---
    window.openProd=(id)=>{
        $('#modalProd').style.display='flex';
        if(id){ const p=INVENTORY.find(i=>i.id===id); $('#mpTitle').innerText='Editar'; $('#mpId').value=id; $('#mpName').value=p.name; $('#mpCat').value=p.category; $('#mpQty').value=p.qty; $('#mpUnit').value=p.unit; $('#mpMin').value=p.min; $('#btnDelProd').style.display='block'; }
        else{ $('#mpTitle').innerText='Nuevo'; $('#mpId').value=''; $('#mpName').value=''; $('#mpQty').value=0; $('#btnDelProd').style.display='none'; }
    }
    window.saveProduct=async()=>{
        const d={name:$('#mpName').value, category:$('#mpCat').value, qty:Number($('#mpQty').value), unit:$('#mpUnit').value, min:Number($('#mpMin').value)};
        const id=$('#mpId').value;
        if(!d.name) return alert("Falta nombre");
        id ? await db.collection('inventory').doc(id).update(d) : await db.collection('inventory').add(d);
        $('#modalProd').style.display='none';
    }
    window.delProduct=async()=>{ const id=$('#mpId').value; if(id && confirm("Borrar?")) await db.collection('inventory').doc(id).delete(); $('#modalProd').style.display='none'; }

    init();
  </script>
</body>
</html>
