<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Comentarios â€¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  <style>
    :root{
      --primary:#625A45; --text:#111; --muted:#666; --bg:#f6f6f6; --card:#fff;
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08); --ring:#eaeaea;
      --ok:#2E7D32; --warn:#FB8C00;
      --star-off:#DDD; --star-on:#F5A524;
      --pill:#f4f1eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    .topbar{max-width:1100px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;text-decoration:none;color:inherit;font-weight:700}
    .brand img{width:36px;height:36px;border-radius:10px;background:#fff;object-fit:contain;margin-right:8px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:2px solid var(--primary);background:#fff;color:var(--primary);padding:10px 16px;border-radius:999px;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{border-color:#e7e7e7;color:#333}
    main{max-width:1100px;margin:24px auto;padding:0 12px;display:grid;grid-template-columns:1fr;gap:18px}

    .card{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px}
    h1{font-size:28px;margin:6px 0 10px}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .input, .select{
      border:1.5px solid var(--ring); background:#fff; padding:10px 12px; border-radius:12px;
      font-size:14px; outline:none;
    }
    .input:focus, .select:focus{border-color:var(--primary); box-shadow:0 0 0 3px rgba(98,90,69,.15)}
    .stats{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1.5px solid var(--ring);background:#fff;font-weight:700}

    /* Listado */
    .list{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .item{border:1.5px solid var(--ring);border-radius:14px;padding:12px;background:#fff}
    .head{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .who{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .name{font-weight:800}
    .pill{background:var(--pill);padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid var(--ring)}
    .stars{display:inline-flex;gap:4px}
    .star{font-size:18px;color:var(--star-off);line-height:1}
    .star.on{color:var(--star-on)}
    .comment{margin-top:8px;white-space:pre-wrap}
    .foot{margin-top:8px;font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap}
    .empty{border:2px dashed var(--ring);border-radius:16px;padding:24px;text-align:center;color:var(--muted);background:#fff}

    /* Grid en 2 columnas grandes en desktop si querÃ©s mÃ¡s densidad */
    @media (min-width:1000px){
      .list{grid-template-columns:1fr 1fr}
    }

    body::before{
      content:""; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      width:clamp(240px,48vmin,560px); background:url("images/logo.png") center/contain no-repeat;
      opacity:.06; pointer-events:none; z-index:0;
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <a class="brand" href="index.html"><img src="images/logo.png" alt="">Rhodes Burgers</a>
      <div class="spacer"></div>
      <a class="btn ghost" href="index.html">Volver al menÃº</a>
    </div>
  </header>

  <main>
    <section class="card">
      <h1>Comentarios de clientes</h1>

      <div class="controls">
        <input id="q" class="input" type="search" placeholder="Buscar por texto / nombre / #pedidoâ€¦">
        <select id="fRating" class="select" title="Filtrar por calificaciÃ³n">
          <option value="all">Todos los ratings</option>
          <option value="5">Solo 5 â˜…</option>
          <option value="4">Solo 4 â˜…</option>
          <option value="3">Solo 3 â˜…</option>
          <option value="2">Solo 2 â˜…</option>
          <option value="1">Solo 1 â˜…</option>
          <option value="0">Sin calificaciÃ³n</option>
        </select>
        <select id="orderBy" class="select" title="Orden">
          <option value="desc">MÃ¡s nuevos primero</option>
          <option value="asc">MÃ¡s antiguos primero</option>
        </select>
      </div>

      <div class="stats">
        <div id="countChip" class="chip">0 comentarios</div>
        <div id="avgChip" class="chip">Promedio â€”</div>
      </div>

      <div id="list" class="list" aria-live="polite"></div>
      <div id="empty" class="empty" style="display:none">No hay comentarios que coincidan con los filtros.</div>
      <div id="loading" class="empty">Cargando comentariosâ€¦</div>
    </section>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    /* ===== Firebase ===== */
    var firebaseConfig={apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    if(!firebase.apps.length){firebase.initializeApp(firebaseConfig)}
    var db=firebase.firestore();

    /* ===== Helpers ===== */
    const $=s=>document.querySelector(s);
    const money=n=>(Number(n)||0).toLocaleString("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0});
    const fmt=ts=>{if(!ts)return"â€”";const d=ts.toDate?ts.toDate():new Date(ts);return d.toLocaleString("es-AR",{dateStyle:"medium",timeStyle:"short"})};
    const labelEntrega=v=>v==='take_away'?'Take Away':(v||'â€”');

    function starsHTML(n){
      n = Number(n)||0;
      let h = '<span class="stars" aria-label="'+(n?`${n} estrellas`:'Sin calificaciÃ³n')+'">';
      for(let i=1;i<=5;i++){ h += `<span class="star ${i<=n?'on':''}">â˜…</span>`; }
      return h + '</span>';
    }

    function escapeHTML(s){
      return (s||'').replace(/[&<>"']/g, m=>({ '&':'&quot;&amp;'.split('&')[1], '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' }[m]));
    }

    /* ===== Estado local de filtros ===== */
    let allDocs = [];  // snapshot completo en memoria
    let orderDir = 'desc';

    function applyFilters(){
      const q = ($('#q').value||'').toLowerCase().trim();
      const f = $('#fRating').value;
      const list = $('#list');
      list.innerHTML='';

      let rows = allDocs.slice();

      // filtro por rating
      if(f!=='all'){
        const want = Number(f);
        rows = rows.filter(r => {
          const rt = Number(r.rating||0);
          return (f==='0') ? (rt===0) : (rt===want);
        });
      }

      // bÃºsqueda
      if(q){
        rows = rows.filter(r=>{
          const hay = [
            r.comment||'',
            r.nombre||'',
            String(r.orderNumber||''),
            r.orderId||'',
            r.pago||'',
            r.entrega||''
          ].join(' ').toLowerCase();
          return hay.includes(q);
        });
      }

      // orden
      rows.sort((a,b)=>{
        const ta=(a.createdAt && a.createdAt.toMillis)?a.createdAt.toMillis():0;
        const tb=(b.createdAt && b.createdAt.toMillis)?b.createdAt.toMillis():0;
        return orderDir==='desc' ? (tb-ta) : (ta-tb);
      });

      // render
      if(rows.length===0){
        $('#empty').style.display='';
      }else{
        $('#empty').style.display='none';
        const frag = document.createDocumentFragment();
        rows.forEach(d=>{
          const item = document.createElement('div');
          item.className='item';
          const name = d.nombre || 'Cliente';
          const num  = d.orderNumber?('#'+d.orderNumber):'';
          const pago = d.pago?`<span class="pill">Pago: <strong>${escapeHTML(d.pago)}</strong></span>`:'';
          const del  = d.entrega?`<span class="pill">Entrega: <strong>${escapeHTML(labelEntrega(d.entrega))}</strong></span>`:'';
          const rating = Number(d.rating||0);
          const when = fmt(d.createdAt||d.created_at||d.ts);

          item.innerHTML = `
            <div class="head">
              <div class="who">
                <span class="name">${escapeHTML(name)}</span>
                ${num?`<span class="pill">${num}</span>`:''}
                ${pago}${del}
              </div>
              <div>${starsHTML(rating)}</div>
            </div>
            ${d.comment?`<div class="comment">${escapeHTML(d.comment)}</div>`:''}
            <div class="foot">
              <span>ðŸ“… ${when}</span>
              ${d.orderId?`<span>ID interno: ${escapeHTML(d.orderId)}</span>`:''}
              ${d.token?`<span>Token: ${escapeHTML(d.token)}</span>`:''}
            </div>
          `;
          frag.appendChild(item);
        });
        list.appendChild(frag);
      }

      // stats
      const withRt = rows.filter(r=>Number(r.rating||0)>0);
      const avg = withRt.length ? (withRt.reduce((s,r)=>s+Number(r.rating||0),0)/withRt.length) : 0;
      $('#countChip').textContent = `${rows.length} comentario${rows.length===1?'':'s'}`;
      $('#avgChip').textContent   = withRt.length ? `Promedio ${avg.toFixed(2)} â˜… (${withRt.length})` : 'Promedio â€”';
    }

    /* ===== SuscripciÃ³n en tiempo real ===== */
    function startListener(){
      $('#loading').style.display='';
      db.collection('feedback')
        .orderBy('createdAt','desc')
        .onSnapshot(snap=>{
          const out=[];
          snap.forEach(doc=>{
            const d=doc.data()||{};
            out.push({
              id:doc.id,
              comment:d.comment||'',
              rating:d.rating||0,
              orderId:d.orderId||'',
              orderNumber:d.orderNumber||d.numero||d.num||null,
              nombre:d.nombre||'',
              pago:d.pago||'',
              entrega:d.entrega||'',
              token:d.token||'',
              createdAt:d.createdAt||d.created_at||d.ts||null
            });
          });
          allDocs = out;
          $('#loading').style.display='none';
          applyFilters();
        }, err=>{
          $('#loading').innerHTML = `<span class="muted">Error cargando comentarios: ${escapeHTML(err&&err.message?err.message:String(err))}</span>`;
        });
    }

    /* ===== UI bindings ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#q').addEventListener('input', applyFilters);
      $('#fRating').addEventListener('change', applyFilters);
      $('#orderBy').addEventListener('change', (e)=>{
        orderDir = e.target.value==='asc' ? 'asc' : 'desc';
        applyFilters();
      });
      startListener();
    });
  </script>
</body>
</html>
