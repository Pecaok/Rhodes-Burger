<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ingresar • Rhodes Burgers</title>
<link rel="icon" href="images/logo.png" />
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2ecc71">
<link rel="apple-touch-icon" href="images/icon-192.png">
<style>
  :root{--primary:#2ecc71;--ring:#eaeaea;--text:#111;--muted:#666;--card:#fff;--bg:#f6f6f6;--shadow:0 10px 30px rgba(0,0,0,.08)}
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{min-height:100vh;display:grid;place-items:center;padding:20px}
  .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:24px;max-width:420px;width:100%}
  h1{margin:0 0 10px}
  label{display:block;font-weight:700;margin:10px 0 6px}
  input{width:100%;padding:12px;border:1px solid var(--ring);border-radius:12px}
  .btn{width:100%;margin-top:14px;padding:12px;border-radius:999px;border:2px solid var(--primary);background:var(--primary);color:#fff;font-weight:800;cursor:pointer}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}
  /* Toasts */
  .toast{position:fixed;right:14px;bottom:14px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);opacity:0;transform:translateY(20px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.success{background:#2ecc71}.toast.error{background:#d32f2f}.toast.info{background:#444}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" role="form" aria-labelledby="t">
    <h1 id="t">Ingresar</h1>

    <label>Usuario</label>
    <input id="user" type="text" autocomplete="username" placeholder="Ej: local">
    <div class="muted">Ingresá solo el nombre de usuario (sin @). Ej: <strong>local</strong></div>

    <label style="margin-top:12px">Clave</label>
    <input id="pass" type="password" autocomplete="current-password" placeholder="••••••••">

    <button id="btnLogin" class="btn">Ingresar</button>
    <div class="muted">Acceso sólo para el local.</div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // Registrar Service Worker (PWA)
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js'); }

  /* =================== TOASTS =================== */
  const toastEl = document.getElementById('toast');
  function showToast(msg,type='success',ms=2500){
    toastEl.textContent = msg; toastEl.className = 'toast '+type;
    requestAnimationFrame(()=>{ toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'), ms); });
  }

  /* =================== FIREBASE =================== */
  const firebaseConfig = {
    apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",
    authDomain:"rhodes-burguers.firebaseapp.com",
    projectId:"rhodes-burguers",
    storageBucket:"rhodes-burguers.firebasestorage.app",
    messagingSenderId:"951646688091",
    appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"
  };
  try{ firebase.initializeApp(firebaseConfig);}catch(_){}
  const auth = firebase.auth();
  const db   = firebase.firestore();

  /* =================== CONFIG =================== */
  // Dominio "falso" para armar el email interno desde el usuario.
  // Cambiá esto si querés otro dominio virtual.
  const USERNAME_DOMAIN = 'rb.local'; // local -> local@rb.local

  // Guardá la sesión por 20 hs
  function setLocalExpiry(hours=20){
    const exp = Date.now() + hours*60*60*1000;
    localStorage.setItem('rb_auth_expires', String(exp));
  }

  // Si ya está logueado, mandalo directo
  auth.onAuthStateChanged(async (user)=>{
    if (user){
      // Verificamos admin antes de pasar
      const doc = await db.collection('admins').doc(user.uid).get();
      if (doc.exists && doc.data().enabled === true) {
        const next = new URLSearchParams(location.search).get('next') || 'pedido_local.html';
        location.replace(next);
      } else {
        await auth.signOut();
      }
    }
  });

  /* =================== LOGIN =================== */
  async function login(){
    const usuario = (document.getElementById('user').value || '').trim();
    const pass    = document.getElementById('pass').value;

    if(!usuario || !pass){
      showToast('Completá usuario y clave','info'); return;
    }

    // Mapeamos "usuario" -> email interno
    const email = `${usuario}@${USERNAME_DOMAIN}`;

    try{
      const cred = await auth.signInWithEmailAndPassword(email, pass);

      // Chequeo de admin
      const uid = cred.user.uid;
      const doc = await db.collection('admins').doc(uid).get();
      if (!doc.exists || doc.data().enabled !== true){
        await auth.signOut();
        showToast('No tenés permisos de admin','error');
        return;
      }

      setLocalExpiry(20);
      showToast('Ingreso correcto','success');

      const next = new URLSearchParams(location.search).get('next') || 'pedido_local.html';
      location.replace(next);

    }catch(e){
      console.error(e);
      // Mensajes más claros
      const code = e?.code || '';
      if (code.includes('user-not-found') || code.includes('wrong-password')) {
        showToast('Usuario o clave inválidos','error');
      } else if (code.includes('too-many-requests')) {
        showToast('Demasiados intentos. Probá en unos minutos.','error');
      } else {
        showToast('No se pudo iniciar sesión','error');
      }
    }
  }

  document.getElementById('btnLogin').addEventListener('click', login);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Enter') login(); });
</script>
</body>
</html>
