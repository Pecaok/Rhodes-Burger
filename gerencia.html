<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia & Stock ‚Ä¢ Rhodes</title>
  <link rel="icon" href="images/logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ESTILOS BASE */
    :root { --primary: #625A45; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0; --green: #10b981; --red: #ef4444; --blue: #3b82f6; --purple: #8b5cf6; --orange: #f97316; }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

    header { background: #fff; border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; z-index: 10; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 13px; transition:0.2s }
    .nav-btn:hover { background: #f1f5f9; color: #0f172a; }
    .nav-btn.active { background: var(--primary); color: #fff; }

    .layout { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; overflow-y: auto; }
    .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center; }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); }
    .section-title { font-size:11px; font-weight:700; color:#999; text-transform:uppercase; margin:15px 20px 5px 20px; }
    .content { flex: 1; padding: 30px; overflow-y: auto; }

    .card { background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    h2 { margin: 0 0 15px; font-size: 15px; font-weight: 700; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
    h5 { margin: 0 0 10px; font-size: 13px; font-weight: 700; color: #64748b; text-transform: uppercase; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f8fafc; text-align: left; padding: 10px; border-bottom: 1px solid var(--border); font-weight: 600; color: #64748b; }
    td { border-bottom: 1px solid var(--border); padding: 10px; vertical-align: middle; }
    input, select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; outline: none; width: 100%; }
    
    .btn { padding: 8px 14px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-blue { background: var(--blue); color: white; }
    .btn-purple { background: var(--purple); color: white; }
    .btn-danger { background: #fee2e2; color: var(--red); }
    .btn-icon { background:transparent; border:none; font-size:16px; cursor:pointer; color:#94a3b8; }
    .btn-icon:hover { color: var(--red); }
    .btn-sm { padding: 4px 8px; font-size: 11px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .kpi { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .kpi-lbl { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-val { font-size: 26px; font-weight: 800; color: #0f172a; margin-top: 5px; }
    
    .order-row { cursor: pointer; transition: background 0.2s; }
    .order-row:hover { background: #f8fafc; }
    .order-details { display: none; background: #fcfcfc; border-bottom: 1px solid var(--border); }
    .order-details.open { display: table-row; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 15px; }
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; display:inline-block; letter-spacing:0.5px; }
    .bdg-web { background: #e0f2fe; color: #0284c7; }    
    .bdg-local { background: #f1f5f9; color: #475569; } 
    .bdg-py { background: #fee2e2; color: #ef4444; }     
    .bdg-cash { background: #dcfce7; color: #166534; }   
    .bdg-digital { background: #f3e8ff; color: #7e22ce; } 

    .conf-input-group { display:flex; flex-direction:column; align-items:center; }
    .conf-lbl { font-size:9px; color:#c2410c; margin-bottom:2px; font-weight:700; text-transform:uppercase; }
    .conf-inp { width:45px; border:1px solid #fdba74; background:#fff; font-weight:700; text-align:center; padding:2px; border-radius:4px; font-size:12px; }

    .alias-builder { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .alias-list-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #e2e8f0; font-size: 12px; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
    .modal { background: #fff; width: 500px; padding: 25px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height:90vh; overflow-y:auto; }
    
    .text-red { color: var(--red); } .text-green { color: var(--green); }
    .charts-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    @media (max-width: 1000px) { .charts-row { grid-template-columns: 1fr; } }
    
    .ing-list { border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-top: 10px; background: #fafafa; }
    .ing-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dashed #ddd; font-size: 14px; }
    
    /* Sticky header */
    .sticky-col { position: sticky; left: 0; z-index: 2; border-right: 2px solid #cbd5e1; background: #fff; }
    /* Headers de categor√≠a */
    .cat-header { background: #e2e8f0; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: #475569; padding: 8px 10px; font-size: 11px; }
    
    /* Styles para los porcentajes peque√±os */
    .pct-tag { font-size: 10px; font-weight: 400; margin-left: 4px; opacity: 0.8; }

    /* --- MEJORAS STOCK --- */
    /* Ocultar flechas del input number para que se vea limpio */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    
    .qty-control { display: flex; align-items: center; gap: 5px; justify-content: center; }
    
    .qty-input { 
        width: 70px; 
        text-align: center; 
        border: 1px solid #cbd5e1; 
        border-radius: 6px; 
        padding: 6px; 
        font-weight: 700; 
        color: #334155; 
        outline: none; 
        transition: 0.2s; 
        background: #fff;
    }
    .qty-input:focus { 
        border-color: var(--primary); 
        background: #fffbeb; 
        box-shadow: 0 0 0 3px rgba(98, 90, 69, 0.1);
    }
    
    .qty-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        color: #64748b;
        font-weight: 800;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }
    .qty-btn:hover { background: #e2e8f0; color: var(--primary); }
    .qty-btn:active { transform: scale(0.95); }
  </style>
</head>
<body>

<header>
  <a href="#" class="brand"><img src="images/logo.png" width="30"> Gerencia Rhodes</a>
  <div>
    <a href="pedido_local.html" class="nav-btn">Pedidos</a>
    <a href="#" class="nav-btn active">Gerencia</a>
    <button onclick="location.href='login.html'" class="nav-btn" style="color:var(--red)">Salir</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="tab-btn active" onclick="showTab('dashboard')">üìä Rendimiento</div>
    
    <div class="section-title">An√°lisis</div>
    <div class="tab-btn" onclick="showTab('proportions')">üìà Proporci√≥n Ventas</div>

    <div class="section-title">Gesti√≥n</div>
    <div class="tab-btn" onclick="showTab('stock')">üì¶ Control de Stock</div>
    <div class="tab-btn" onclick="showTab('subrecipes')">üß© Armado de Items</div>
    <div class="tab-btn" onclick="showTab('recipes')">üçî Recetas Finales</div>
    
    <div class="section-title">Costos & Precios</div>
    <div class="tab-btn" onclick="showTab('cost_materia')">ü•© Costos Mat. Prima</div>
    <div class="tab-btn" onclick="showTab('cost_pack')">ü•° Costos Packaging</div>
    <div class="tab-btn" onclick="showTab('fixed')">üí° Gastos Fijos</div>
    <div class="tab-btn" onclick="showTab('production')">üë®‚Äçüç≥ Sueldos</div>

    <div class="section-title">Historial</div>
    <div class="tab-btn" onclick="showTab('orders')">üßæ Lista de Pedidos</div>
  </aside>

  <main class="content">

    <div id="tab-dashboard">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <div><h2 style="margin:0; border:0">Tablero de Comando</h2></div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div style="background:#fff7ed; padding:6px 12px; border-radius:8px; border:1px solid #fed7aa; display:flex; align-items:center; gap:8px">
                <div class="conf-input-group"><div class="conf-lbl">D√©bito</div><input type="number" id="confDebit" value="0" class="conf-inp"></div>
                <div class="conf-input-group"><div class="conf-lbl">Transf</div><input type="number" id="confTransf" value="0" class="conf-inp"></div>
                <div class="conf-input-group"><div class="conf-lbl">QR/MP</div><input type="number" id="confQR" value="0" class="conf-inp"></div>
                <button class="btn-sm btn-primary" onclick="saveConfig()" style="height:32px; margin-left:5px">üíæ</button>
            </div>
            <input type="month" id="monthPicker" title="Selecciona mes anterior para ver historial" style="font-weight:700; border:2px solid var(--primary); color:var(--primary); padding:5px; border-radius:6px; cursor:pointer;">
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-lbl">Ventas Brutas</div><div class="kpi-val" id="kpiSales">$ 0</div></div>
        <div class="kpi"><div class="kpi-lbl">Costo Te√≥rico</div><div class="kpi-val text-red" id="kpiTheoCMV">$ 0</div></div>
        <div class="kpi"><div class="kpi-lbl">Gastos (Incl. Var)</div><div class="kpi-val text-red" id="kpiTotalExpenses">$ 0</div></div>
        <div class="kpi" id="kpiNetContainer"><div class="kpi-lbl">Ganancia Neta</div><div class="kpi-val" id="kpiNet">$ 0</div></div>
      </div>

      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:20px;">
        <div class="card">
            <h2>Desglose de Gastos y Ganancia</h2>
            <div style="position: relative; height: 250px; width: 100%;"><canvas id="mainChart"></canvas></div>
        </div>
        <div class="card">
            <h2>√öltimas Compras Stock</h2>
            <div id="lastPurchasesList" style="font-size:13px; color:#555"></div>
        </div>
      </div>

      <div class="charts-row">
          <div class="card"><h5>üìÖ Evoluci√≥n Ventas</h5><div style="height:200px"><canvas id="dailyChart"></canvas></div></div>
          <div class="card"><h5>üçî Top Productos</h5><div style="height:200px"><canvas id="topProductsChart"></canvas></div></div>
          <div class="card"><h5>üí≥ Medios de Pago</h5><div style="height:200px"><canvas id="paymentChart"></canvas></div></div>
      </div>
    </div>

    <div id="tab-proportions" style="display:none">
        <div class="card">
            <div class="row-flex">
                <h2 style="margin:0; border:0">üìä Proporci√≥n de Ventas (Detallado)</h2>
                <div id="totalItemsBadge" style="background:var(--primary); color:white; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:700">Total: 0</div>
            </div>
            <div style="overflow-x:auto; margin-top:15px">
                <table style="border-collapse: separate; border-spacing: 0;">
                    <thead>
                        <tr>
                            <th class="sticky-col" style="z-index:10; min-width:150px">Producto</th>
                            
                            <th style="text-align: center; background: #fff7ed; color: #9a3412;">Simple</th>
                            <th style="text-align: center; background: #fff7ed; color: #9a3412;">Doble</th>
                            <th style="text-align: center; background: #fffbeb; color: #92400e; font-weight:800; border-right:2px solid #e2e8f0">TOTAL</th>
                            
                            <th style="text-align: center; background: #eff6ff; color: #1e40af;">üåê Web <small>(%)</small></th>
                            <th style="text-align: center; background: #f8fafc; color: #475569;">üè™ Local <small>(%)</small></th>
                            <th style="text-align: center; background: #fef2f2; color: #b91c1c;">üõµ PedidosYa <small>(%)</small></th>
                        </tr>
                    </thead>
                    <tbody id="proportionsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-orders" style="display:none">
        <div class="card">
            <h2><span id="ordersTitle">üßæ Historial de Pedidos</span> <small style="font-size:12px; color:#777; font-weight:400">Clic en pedido para ver detalle</small></h2>
            <div style="overflow-x:auto">
                <table style="width:100%">
                    <thead><tr><th width="120">Fecha</th><th>Cliente</th><th width="100">Origen</th><th width="120">Pago</th><th width="100">Total</th><th width="100">Ganancia</th><th width="30"></th></tr></thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-stock" style="display:none">
        <div class="card">
            <div class="row-flex">
                <div style="flex:1"><h2 style="margin:0; border:0">üì¶ Control de Stock</h2></div>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-blue" onclick="openPurchaseModal()">üõí Registrar Compra</button>
                    <button class="btn btn-primary" onclick="openProductModal()">+ Nuevo Producto</button>
                </div>
            </div>
            <div class="row-flex" style="background:#f8fafc; padding:15px; border-radius:10px; border:1px solid #e2e8f0;">
                <div style="flex:2">
                    <input type="text" id="searchStock" placeholder="üîç Buscar ingrediente..." onkeyup="renderStockTable()" style="background:#fff">
                </div>
                <div style="flex:1">
                    <select id="filterCat" onchange="renderStockTable()" style="background:#fff">
                        <option value="all">Todas las Categor√≠as</option>
                        <option value="carniceria">Carne</option>
                        <option value="panaderia">Pan</option>
                        <option value="papas">Papas / Congelados</option>
                        <option value="salsas">Salsas</option>
                        <option value="almacen">Almac√©n</option>
                        <option value="verdularia">Verdura</option>
                        <option value="bebidas">Bebidas</option>
                        <option value="packaging">Packaging</option>
                        <option value="üß© Armado">üß© Items Armados</option>
                    </select>
                </div>
            </div>
            <div style="overflow-x:auto; margin-top:10px;">
                <table><thead><tr><th>Producto</th><th>Cat</th><th>Actual</th><th>Min</th><th>Estado</th><th></th></tr></thead>
                <tbody id="stockTableBody"></tbody></table>
            </div>
        </div>
    </div>

    <div id="tab-cost_materia" style="display:none">
        <div class="card"><h2><span>ü•© Costos Materia Prima</span><button class="btn btn-primary" onclick="openProductModal(null, 'carniceria')">+ Nuevo Insumo</button></h2><div style="overflow-x:auto"><table><thead><tr><th>Insumo</th><th>Costo Compra</th><th>Formato</th><th>Rendimiento</th><th style="background:#f0fdf4; color:#166534">Costo Base</th><th></th></tr></thead><tbody id="costMateriaBody"></tbody></table></div></div>
    </div>
    <div id="tab-cost_pack" style="display:none">
        <div class="card"><h2><span>ü•° Costos Packaging</span><button class="btn btn-primary" onclick="openProductModal(null, 'packaging')">+ Nuevo Item</button></h2><table><thead><tr><th>Item</th><th>Costo Compra</th><th>Formato</th><th>Rendimiento</th><th style="background:#f0fdf4; color:#166534">Costo Unit.</th><th></th></tr></thead><tbody id="costPackBody"></tbody></table></div>
    </div>

    <div id="tab-subrecipes" style="display:none">
        <div class="card" style="height: calc(100vh - 140px); display:flex; flex-direction:column; padding:0; overflow:hidden;">
            <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:#f8fafc;">
                <div><h2 style="margin:0; border:0; padding:0">üß© Armado de Items (Sub-recetas)</h2><small style="color:#64748b">Cre√° medallones, salsas caseras, etc.</small></div>
                <button class="btn btn-purple" onclick="addNewSubRecipe()">+ Nuevo Item</button>
            </div>
            <div style="display:flex; flex:1; overflow:hidden;">
                <div style="width:300px; border-right:1px solid var(--border); display:flex; flex-direction:column; background:#fff;">
                    <div style="padding:10px; border-bottom:1px solid var(--border);"><input type="text" placeholder="üîç Buscar item..." onkeyup="renderSubRecipesList(this.value)" style="background:#f1f5f9; border:none;"></div>
                    <div style="flex:1; overflow-y:auto;" id="subRecipesListBody"></div>
                </div>
                <div id="subRecipeEditor" style="flex:1; background:#fff; display:none; flex-direction:column;">
                    <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:#fff;">
                        <div><span style="font-size:10px; font-weight:700; color:var(--purple);">FICHA T√âCNICA</span><h1 style="margin:5px 0 0 0; font-size:24px; color:#1e293b;" id="subEditorTitle">Nombre</h1></div>
                        <div style="text-align:right"><div style="font-size:11px; font-weight:600;">COSTO TOTAL</div><div style="font-size:28px; font-weight:800; color:var(--purple);" id="subEditorTotalCost">$ 0</div></div>
                    </div>
                    <div style="flex:1; overflow-y:auto; padding:20px;">
                        <table style="width:100%; border-collapse:collapse;"><thead style="position:sticky; top:0; background:#fff; z-index:1;"><tr><th>Ingrediente</th><th>Cant.</th><th>Costo U.</th><th>Subtotal</th><th></th></tr></thead><tbody id="subRecipeIngBody"></tbody></table>
                        <div style="margin-top:20px; background:#f8fafc; padding:15px; border-radius:8px; border:1px dashed #cbd5e1; display:flex; gap:10px; align-items:center;">
                            <div style="flex:2;"><label style="font-size:10px; font-weight:700; color:#64748b; display:block;">INSUMO</label><select id="newSubIng" onchange="updateUnitSelect('sub')" style="background:#fff;"></select></div>
                            <div style="flex:1;"><label style="font-size:10px; font-weight:700; color:#64748b; display:block;">CANTIDAD</label><input type="number" id="newSubQty" placeholder="0" step="0.001" style="background:#fff;"></div>
                            <div style="flex:1;"><label style="font-size:10px; font-weight:700; color:#64748b; display:block;">UNIDAD</label><select id="newSubUnit" style="background:#e0f2fe; color:#0369a1; font-weight:700; border:none;"></select></div>
                            <div style="padding-top:14px;"><button class="btn btn-purple" onclick="addIngToSubRecipe()">+</button></div>
                        </div>
                    </div>
                    <div style="padding:15px; background:#fff; border-top:1px solid var(--border); text-align:right;"><button class="btn btn-sm btn-danger" onclick="deleteItem('subrecipes', currentSubRecipeId)" style="background:transparent; border:1px solid #fee2e2; color:#ef4444;">üóëÔ∏è Eliminar</button></div>
                </div>
                <div id="subRecipeEmpty" style="flex:1; display:flex; justify-content:center; align-items:center; color:#cbd5e1; flex-direction:column;"><div style="font-size:40px;">üß©</div><div style="margin-top:10px; font-weight:600;">Seleccion√° un item</div></div>
            </div>
        </div>
    </div>

    <div id="tab-recipes" style="display:none">
        <div class="card">
            <div class="row-flex">
                <div style="flex:1"><h2 style="margin:0; border:0">üçî Recetas Finales</h2><small style="color:#64748b">Define los ingredientes de tus productos de venta.</small></div>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-blue" onclick="openAliasModal()">üîó Promos/Combos</button>
                    <button class="btn btn-primary" onclick="openRecipeModal()">+ Nueva Receta</button>
                </div>
            </div>
            <div style="overflow-x:auto">
                <table>
                    <thead><tr><th>Producto</th><th style="text-align:right">Costo Total</th><th></th></tr></thead>
                    <tbody id="recipesListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-fixed" style="display:none">
      <div class="card"><h2><span>üí° Gastos Fijos</span> <button class="btn btn-primary" onclick="addFixedRow()">+ Agregar</button></h2><table id="tableFixed"><thead><tr><th>Concepto</th><th width="150">Monto Mensual ($)</th><th width="50"></th></tr></thead><tbody></tbody></table><div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div></div>
    </div>

    <div id="tab-production" style="display:none">
      <div class="card"><h2><span>üë®‚Äçüç≥ Sueldos</span> <button class="btn btn-primary" onclick="addProdRow()">+ Agregar</button></h2><table id="tableProd"><thead><tr><th>Empleado / Concepto</th><th width="150">Total ($)</th><th width="50"></th></tr></thead><tbody></tbody></table><div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div></div>
    </div>

  </main>
</div>

<div class="modal-overlay" id="modalRecipe">
    <div class="modal" style="max-width:600px">
        <h2>Gestor de Receta Final</h2>
        <p style="font-size:12px; color:#666; margin-bottom:15px"><b>Nota:</b> Usa el nombre EXACTO de venta (ej: "Morgan Doble"). Las papas, bolsas y cartones se descuentan autom√°ticamente.</p>
        
        <div style="background:#f0f7ff; padding:15px; border-radius:10px; border:1px solid #d0e4ff; margin-bottom:20px">
            <label style="font-weight:bold; font-size:12px">NOMBRE DEL PRODUCTO</label>
            <input type="text" id="recName" placeholder="Ej: Hamburguesa Doble" style="background:#fff; margin-bottom:10px;">
            
            <div style="display:flex; gap:10px; align-items:flex-end">
                <div style="flex:2">
                    <label style="font-size:11px">Agregar (Insumo o Item Armado)</label>
                    <select id="recIngSelect" style="background:#fff"></select>
                </div>
                <div style="flex:1">
                    <label style="font-size:11px">Cantidad</label>
                    <input type="number" id="recIngQty" placeholder="Ej: 1" step="0.001" style="background:#fff">
                </div>
                <button class="btn btn-primary" onclick="addItemToCurrentRecipe()">+</button>
            </div>

            <div id="currentRecipeList" class="ing-list"><div style="text-align:center; color:#999; font-size:12px">Agrega ingredientes...</div></div>
            <button class="btn btn-primary" style="width:100%; margin-top:10px" onclick="saveRecipe()">üíæ Guardar Receta</button>
        </div>
        <button onclick="$('#modalRecipe').style.display='none'" class="btn" style="width:100%">Cerrar</button>
    </div>
</div>

<div class="modal-overlay" id="modalAlias"><div class="modal"><h3>üîó Armador de Combos/Promos</h3><div class="alias-builder"><div style="margin-bottom:10px"><label style="font-size:11px; font-weight:700; color:var(--primary)">Nombre Exacto en PedidosYa:</label><input type="text" id="aliasExt" placeholder="Ej: Super Promo Mundial 2x1" style="width:100%; border:1px solid #ccc; padding:8px; border-radius:4px;"></div><div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:6px; margin-bottom:10px"><label style="font-size:11px; font-weight:700; color:#333">Contenido del Combo:</label><div id="tempAliasItems" style="margin-bottom:10px; min-height:20px;"><div style="font-size:11px; color:#999; font-style:italic">Agrega √≠tems abajo...</div></div><div style="display:flex; gap:5px;"><select id="aliasInt" style="flex:2"></select><input type="number" id="aliasQty" value="1" style="width:60px"><button class="btn btn-primary" onclick="addItemToAlias()">+</button></div></div><div style="text-align:right"><button class="btn btn-primary" onclick="saveAlias()">Guardar Combo</button></div></div><hr style="border:0; border-top:1px solid #eee; margin:20px 0"><h4 style="font-size:12px; text-transform:uppercase; color:#999">Combos Registrados</h4><table style="width:100%; font-size:12px"><thead><tr><th>Nombre Externo</th><th>Contenido</th><th></th></tr></thead><tbody id="aliasListBody"></tbody></table><div style="margin-top:15px; text-align:right"><button class="btn" onclick="$('#modalAlias').style.display='none'">Cerrar</button></div></div></div>

<div class="modal-overlay" id="modalProduct"><div class="modal"><h3 id="mpTitle">Nuevo Insumo</h3><input type="hidden" id="mpId"><div style="margin-bottom:10px"><label style="font-size:11px; color:#666">Nombre</label><input type="text" id="mpName"></div><div style="margin-bottom:10px"><label style="font-size:11px; color:#666">Categor√≠a</label><select id="mpCat"><option value="carniceria">Carne</option><option value="panaderia">Pan</option><option value="almacen">Almac√©n</option><option value="verdularia">Verdura</option><option value="salsas">Salsas</option><option value="packaging">Packaging</option></select></div><div style="background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #eee; margin-bottom:10px"><h4>üì¶ Configuraci√≥n de Costo</h4><div style="display:flex; gap:10px; margin-bottom:10px"><div style="flex:1"><label style="font-size:11px; color:#666">Costo Compra</label><input type="number" id="mpPurchCost" step="0.01"></div><div style="flex:1"><label style="font-size:11px; color:#666">Formato</label><input type="text" id="mpFormat"></div></div><div style="display:flex; gap:10px"><div style="flex:1"><label style="font-size:11px; color:#666">Unidades que trae</label><input type="number" id="mpYield" step="0.001"></div><div style="flex:1"><label style="font-size:11px; color:#666">Unidad de Uso</label><select id="mpUnit"><option value="kg">Kg</option><option value="gr">Gr</option><option value="lt">Lt</option><option value="ml">Ml</option><option value="u">Unidad</option><option value="pq">Paquete</option></select></div></div><div style="margin-top:10px; text-align:right; font-size:12px">Costo Unitario Base: <strong id="calcUnitCost" style="color:var(--green)">$ 0</strong></div></div><div style="display:flex; gap:10px; margin-bottom:15px"><div style="flex:1"><label style="font-size:11px; color:#666">Stock</label><input type="number" id="mpQty" value="0" step="0.001"></div><div style="flex:1"><label style="font-size:11px; color:#666">M√≠nimo</label><input type="number" id="mpMin" value="5" step="0.001"></div></div><div style="display:flex; gap:10px"><button class="btn btn-primary" style="flex:1" onclick="saveProduct()">Guardar</button><button class="btn" style="flex:1" onclick="$('#modalProduct').style.display='none'">Cancelar</button></div></div></div>
<div class="modal-overlay" id="modalPurchase"><div class="modal"><h3>üõí Registrar Compra</h3><div style="margin-bottom:10px"><label>Insumo</label><select id="purProd"></select></div><div style="display:flex; gap:10px; margin-bottom:10px"><div><label>Cantidad</label><input type="number" id="purQty" step="0.001"></div><div><label>Total ($)</label><input type="number" id="purTotal"></div></div><div style="margin-bottom:15px"><label>Fecha</label><input type="date" id="purDate"></div><div style="display:flex; gap:10px"><button class="btn btn-primary" style="flex:1" onclick="confirmPurchase()">Confirmar</button><button class="btn" style="flex:1" onclick="$('#modalPurchase').style.display='none'">Cancelar</button></div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:2});
    const formatQty = (n) => { let num = Number(n); if(isNaN(num)) return '0'; return parseFloat(num.toFixed(3)); };
    
    const parseDate = (val) => { 
        if(!val) return null; 
        if(val.toDate) return val.toDate(); 
        if(val instanceof Date) return val; 
        const d = new Date(val);
        return isNaN(d.getTime()) ? null : d;
    };

    let INVENTORY=[], RAW_STOCK=[], PREMADE_STOCK=[], SUB_RECIPES=[], RECIPES=[], PURCHASES=[], ORDERS=[];
    let FIXED_DATA = { fixed:[], prod:[], config:{taxDebit:0, taxTransf:0, taxQR:0}, aliases:[] };
    let PRODUCTS_DB = {}; // Cache de productos para la categorizaci√≥n
    let currentRecipeId = null, currentSubRecipeId = null;
    let chartMain=null, chartDaily=null, chartProds=null, chartPayment=null;
    let tempAliasList = [];
    let currentRecipeIngs = [];

    function logStatus(msg, isError=false) {
        const el = $('#lastPurchasesList');
        if(el) el.innerHTML = `<div style="padding:10px; color:${isError?'red':'#666'}; font-weight:600">${msg}</div>`;
    }

    // ==========================================
    // 1. CARGA DE BASE DE DATOS (Nombres Reales)
    // ==========================================
    function loadProductsDB() {
        // Obtenemos los productos REALES de la DB para pintar la tabla con 0 ventas al inicio
        db.collection('products').get().then(snap => {
            PRODUCTS_DB = {}; 
            snap.forEach(doc => {
                const d = doc.data();
                // Normalizamos el nombre para b√∫squeda (min√∫sculas, sin espacios extra)
                const normName = d.name.toLowerCase().trim();
                PRODUCTS_DB[normName] = { 
                    realName: d.name, 
                    category: d.category || 'otros' 
                };
            });
            // Si ya se cargaron √≥rdenes, actualizamos la tabla
            if(ORDERS.length) window.renderProportions();
        });
    }

    // ==========================================
    // üî• 2. L√ìGICA DIN√ÅMICA: DB + EXTRAS + CANALES
    // ==========================================
    window.renderProportions = function() {
        const body = $('#proportionsBody');
        if (!body) return;
        body.innerHTML = '';

        const stats = {};

        // PASO 1: Llenar la tabla con TODO lo que hay en la base de datos (ventas = 0)
        Object.keys(PRODUCTS_DB).forEach(key => {
            const p = PRODUCTS_DB[key];
            // Usamos el nombre real para mostrar, pero la key normalizada para buscar
            // Normalizamos la key limpiando "simple"/"doble" para agrupar burgers
            let statsKey = key.replace('simple', '').replace('doble', '').trim();
            
            if (!stats[statsKey]) {
                stats[statsKey] = {
                    name: p.realName.replace(/simple|doble/gi, '').trim(), // Nombre bonito sin variantes
                    category: p.category,
                    countSimple: 0,
                    countDouble: 0,
                    total: 0, 
                    web: 0, local: 0, py: 0
                };
            }
        });

        // Helper para categorizar si viene algo nuevo (extra, o producto borrado)
        function getCategory(name) {
            const n = name.toLowerCase();
            const burgerNames = ["cheese", "bacon", "egg", "core", "morgan", "big", "john", "buena", "mala", "fea", "rhodes", "burguesa", "pollo", "crispy"];
            if (burgerNames.some(b => n.includes(b))) return 'hamburguesas';
            if(n.includes('coca')||n.includes('agua')||n.includes('andes')||n.includes('aquarius')||n.includes('sprite')) return 'bebidas';
            if(n.includes('papas')||n.includes('nuggets')) return 'guarniciones';
            if(n.includes('adicional')) return 'extras';
            return 'otros';
        }

        // Helper para normalizar nombres de pedidos
        function cleanName(raw) {
            let n = raw.toLowerCase().trim();
            n = n.replace('doble', '').replace('simple', '').trim(); 
            n = n.replace(/\s{2,}/g, ' ');
            if(n === 'papas fritas') return 'porci√≥n papas fritas';
            // Match manual para bebidas comunes si el nombre var√≠a
            if(n.includes('coca') && n.includes('original')) return 'coca-cola original 500ml'; // Ajustar seg√∫n DB
            return n;
        }

        // Helper para sumar extras
        let totalGeneral = 0;
        let grandTotalWeb = 0, grandTotalLocal = 0, grandTotalPY = 0;

        function addToStats(key, niceName, qty, source, isDouble, cat) {
            // Si no existe (producto nuevo o extra que no est√° en DB), lo creamos
            if (!stats[key]) {
                stats[key] = { 
                    name: niceName, 
                    category: cat || getCategory(niceName),
                    countSimple: 0, countDouble: 0, total: 0, web: 0, local: 0, py: 0 
                };
            }

            stats[key].total += qty;
            stats[key][source] += qty;
            
            // Si es hamburguesa y es doble
            if (stats[key].category === 'hamburguesas' || stats[key].category === 'Hamburguesas') {
                if (isDouble) stats[key].countDouble += qty;
                else stats[key].countSimple += qty;
            } else {
                stats[key].countSimple += qty;
            }

            totalGeneral += qty;
            if(source==='web') grandTotalWeb += qty;
            if(source==='local') grandTotalLocal += qty;
            if(source==='py') grandTotalPY += qty;
        }

        // PASO 2: Procesar Pedidos
        ORDERS.forEach(o => {
            let source = 'local';
            const srcRaw = String(o.source || '').toLowerCase();
            if (srcRaw.includes('pedidosya')) source = 'py';
            else if (srcRaw === 'web' || srcRaw === 'app') source = 'web';

            (o.items || []).forEach(it => {
                const qty = Number(it.qty || 1);
                const rawName = it.name || "";
                
                // 1. √çtem Principal
                const isDouble = rawName.toLowerCase().includes('doble');
                let baseName = cleanName(rawName);
                
                // Intentar matchear con la DB existente
                let key = Object.keys(stats).find(k => k === baseName) || baseName;
                let prettyName = stats[key] ? stats[key].name : (baseName.charAt(0).toUpperCase() + baseName.slice(1));

                addToStats(key, prettyName, qty, source, isDouble, stats[key]?.category);

                // 2. Extras (Dentro del √≠tem)
                if (it.extras) {
                    // Carne Extra
                    let extraMeat = Number(it.extras.patty || it.extras.carne || it.extras.medallon || 0);
                    if (extraMeat > 0) {
                        addToStats("medallon adicional", "Medall√≥n adicional", extraMeat * qty, source, false, 'extras');
                    }
                    // Cheddar Extra
                    let extraCheddar = Number(it.extras.cheddar || 0);
                    if (extraCheddar > 0) {
                        addToStats("cheddar adicional", "Cheddar adicional", extraCheddar * qty, source, false, 'extras');
                    }
                }
            });
        });

        $('#totalItemsBadge').innerText = `Total √çtems: ${totalGeneral}`;

        // PASO 3: Ordenar y Renderizar
        // Definir orden de categor√≠as
        const catOrder = ['hamburguesas', 'bebidas', 'guarniciones', 'extras', 'otros'];
        
        const sortedKeys = Object.values(stats).sort((a, b) => {
            let catA = (a.category||'otros').toLowerCase();
            let catB = (b.category||'otros').toLowerCase();
            
            // Normalizar categor√≠as para el sort
            if(catA.includes('hamburguesa')) catA = 'hamburguesas';
            if(catB.includes('hamburguesa')) catB = 'hamburguesas';

            const rankA = catOrder.indexOf(catA) === -1 ? 99 : catOrder.indexOf(catA);
            const rankB = catOrder.indexOf(catB) === -1 ? 99 : catOrder.indexOf(catB);
            
            if (rankA !== rankB) return rankA - rankB;
            return a.name.localeCompare(b.name);
        });

        let currentCat = null;

        sortedKeys.forEach(s => {
            let displayCat = (s.category || 'OTROS').toUpperCase();
            if (displayCat !== currentCat) {
                currentCat = displayCat;
                body.insertAdjacentHTML('beforeend', `<tr><td colspan="7" class="cat-header">${currentCat}</td></tr>`);
            }

            const isZero = s.total === 0;
            const rowStyle = isZero ? 'color:#cbd5e1;' : '';
            const zeroStyle = 'color:#e2e8f0; font-size:11px;';
            const pctClass = isZero ? '' : 'pct-tag';

            const pctWeb = grandTotalWeb > 0 ? ((s.web / grandTotalWeb) * 100).toFixed(1) + '%' : '-';
            const pctLocal = grandTotalLocal > 0 ? ((s.local / grandTotalLocal) * 100).toFixed(1) + '%' : '-';
            const pctPY = grandTotalPY > 0 ? ((s.py / grandTotalPY) * 100).toFixed(1) + '%' : '-';

            // Visualizaci√≥n Simple/Doble
            let simpleCell = `<td style="text-align:center;">${s.countSimple}</td>`;
            let doubleCell = `<td style="text-align:center; color:#b91c1c; font-weight:600; background:#fffafb">${s.countDouble}</td>`;

            // Si no es hamburguesa, anulamos la columna doble visualmente
            if (!displayCat.includes('HAMBURGUESA')) {
                doubleCell = `<td style="text-align:center; color:#e2e8f0">-</td>`; 
                simpleCell = `<td style="text-align:center; color:${isZero?'#ccc':'#555'}">${s.total}</td>`; 
            } else if (isZero) {
                simpleCell = `<td style="text-align:center;">-</td>`;
                doubleCell = `<td style="text-align:center;">-</td>`;
            }

            body.insertAdjacentHTML('beforeend', `
                <tr style="${rowStyle}">
                    <td style="font-weight:700; border-right:1px solid #e2e8f0; position:sticky; left:0; background:white; z-index:5">${s.name}</td>
                    
                    ${simpleCell}
                    ${doubleCell}
                    
                    <td style="text-align:center; font-weight:800; background:#fffbeb; border-right:2px solid #e2e8f0; color:#78350f">${s.total}</td>

                    <td style="text-align:center; background:#eff6ff; ${s.web===0?zeroStyle:''}">
                        ${s.web > 0 ? `<span style="color:#1e40af; font-weight:700">${s.web}</span> <span class="${pctClass}">(${pctWeb})</span>` : '-'}
                    </td>
                    <td style="text-align:center; background:#f8fafc; ${s.local===0?zeroStyle:''}">
                        ${s.local > 0 ? `<span style="color:#334155; font-weight:700">${s.local}</span> <span class="${pctClass}">(${pctLocal})</span>` : '-'}
                    </td>
                    <td style="text-align:center; background:#fef2f2; ${s.py===0?zeroStyle:''}">
                        ${s.py > 0 ? `<span style="color:#dc2626; font-weight:700">${s.py}</span> <span class="${pctClass}">(${pctPY})</span>` : '-'}
                    </td>
                </tr>
            `);
        });
    };

    // --- CARGADORES UNIFICADOS ---
    window.loadInventory = function() {
        db.collection('inventory').orderBy('name').onSnapshot(snap => {
            RAW_STOCK = snap.docs.map(d => ({id:d.id, ...d.data(), isSub: false}));
            window.combineAndRender();
        });
        db.collection('subrecipes').onSnapshot(snap => {
            SUB_RECIPES = snap.docs.map(d => ({id:d.id, ...d.data()})); 
            PREMADE_STOCK = snap.docs.map(d => ({
                id: d.id, ...d.data(), category: 'üß© Armado', isSub: true,
                unit: 'u', qty: d.data().qty || 0, min: d.data().min || 0
            }));
            window.combineAndRender();
        });
    };

    window.combineAndRender = function() {
        INVENTORY = [...RAW_STOCK, ...PREMADE_STOCK];
        window.renderStockTable(); window.renderCostTables();
        window.renderRecipesList(); window.renderSubRecipesList();
    };

    window.loadRecipes = function() { db.collection('recipes').onSnapshot(snap => { RECIPES=snap.docs.map(d=>({id:d.id,...d.data()})); window.renderRecipesList(); }); };
    window.loadFixedData = function() { 
        db.collection('config').doc('gerencia').onSnapshot(doc => {
            if(doc.exists) FIXED_DATA = doc.data();
            if(!FIXED_DATA.fixed) FIXED_DATA.fixed=[]; if(!FIXED_DATA.prod) FIXED_DATA.prod=[];
            if(!FIXED_DATA.aliases) FIXED_DATA.aliases = [];
            $('#confDebit').value = FIXED_DATA.config?.taxDebit||0;
            $('#confTransf').value = FIXED_DATA.config?.taxTransf||0; $('#confQR').value = FIXED_DATA.config?.taxQR||0;
            window.renderFixedTables();
        });
    };

    // ==========================================
    // üì¶ STOCK MEJORADO (Input manual + Botones)
    // ==========================================
    
    window.renderStockTable = function() {
        const t = $('#searchStock').value.toLowerCase(); 
        const c = $('#filterCat').value;
        const b = $('#stockTableBody'); 
        b.innerHTML='';

        INVENTORY.filter(p => (p.name||"").toLowerCase().includes(t) && (c==='all'||p.category===c)).forEach(p => {
            let stHtml = `<span class="status-dot st-ok"></span>OK`;
            if(p.qty <= p.min) stHtml=`<span class="status-dot st-danger"></span>CRIT`; 
            else if(p.qty <= p.min*1.5) stHtml=`<span class="status-dot st-warn"></span>BAJO`;
            
            let actions = `<button class="btn-icon" onclick="openProductModal('${p.id}')">‚úèÔ∏è</button><button class="btn-icon" onclick="deleteItem('inventory','${p.id}')">üóëÔ∏è</button>`;
            if(p.isSub) actions = `<button class="btn-icon" onclick="openSubRecipeEditor('${p.id}')">üß©</button><button class="btn-icon" onclick="deleteItem('subrecipes','${p.id}')">üóëÔ∏è</button>`;
            
            // INPUT MEJORADO: Permite escribir o usar botones
            b.insertAdjacentHTML('beforeend', `
                <tr>
                    <td><b>${p.name}</b></td>
                    <td><small style="background:#f1f5f9; padding:2px 6px; border-radius:4px; border:1px solid #e2e8f0">${p.category}</small></td>
                    <td>
                        <div class="qty-control">
                            <button class="qty-btn" onclick="updStock('${p.id}', -1)">-</button>
                            <input type="number" class="qty-input" value="${formatQty(p.qty)}" 
                                   onchange="setStockDirect('${p.id}', this.value)" 
                                   step="0.001">
                            <button class="qty-btn" onclick="updStock('${p.id}', 1)">+</button>
                            <small style="margin-left:5px; color:#94a3b8; font-size:10px">${p.unit}</small>
                        </div>
                    </td>
                    <td>${p.min}</td>
                    <td>${stHtml}</td>
                    <td>${actions}</td>
                </tr>
            `);
        });
    };

    // Funci√≥n para escribir directamente el n√∫mero
    window.setStockDirect = async (id, val) => {
        const item = INVENTORY.find(i => i.id === id); if(!item) return;
        const newQty = Number(val); // Convertir lo escrito a n√∫mero
        
        const col = item.isSub ? 'subrecipes' : 'inventory';
        
        // Guardamos en Firebase
        await db.collection(col).doc(id).update({ qty: newQty });
        // No necesitamos alert, el input ya muestra el valor nuevo
    };

    // Funci√≥n modificada para los botones + y -
    window.updStock = (id, v) => {
        const item = INVENTORY.find(i => i.id === id); if(!item) return;
        const newQty = Number(item.qty || 0) + v;
        window.setStockDirect(id, newQty);
    };

    // RECETAS Y SUBRECETAS
    window.openRecipeModal = function(id) {
        $('#modalRecipe').style.display = 'flex'; $('#recName').value = ''; $('#recIngQty').value = ''; currentRecipeIngs = [];
        const s = $('#recIngSelect'); s.innerHTML = '<option value="">Seleccionar...</option>';
        if(SUB_RECIPES.length) { s.insertAdjacentHTML('beforeend', '<optgroup label="üß© Armado">'); SUB_RECIPES.forEach(sub => s.insertAdjacentHTML('beforeend', `<option value="${sub.id}">üß© ${sub.name}</option>`)); s.insertAdjacentHTML('beforeend', '</optgroup>'); }
        s.insertAdjacentHTML('beforeend', '<optgroup label="üì¶ Insumos">'); RAW_STOCK.sort((a,b)=>a.name.localeCompare(b.name)).forEach(i => s.insertAdjacentHTML('beforeend', `<option value="${i.id}">${i.name} (${i.unit})</option>`)); s.insertAdjacentHTML('beforeend', '</optgroup>');
        if(id) { const r = RECIPES.find(x => x.id === id); if(r) { $('#recName').value = r.id; currentRecipeIngs = [...r.ingredients]; } }
        window.renderCurrentRecipeList();
    };

    window.addItemToCurrentRecipe = function() {
        const id = $('#recIngSelect').value; const qty = Number($('#recIngQty').value); if(!id || qty <= 0) return alert("Error");
        const item = INVENTORY.find(i => i.id === id);
        currentRecipeIngs.push({ id: id, qty: qty, _name: item ? (item.isSub ? `üß© ${item.name}` : item.name) : "???" });
        window.renderCurrentRecipeList(); $('#recIngQty').value = '';
    };

    window.renderCurrentRecipeList = function() {
        const c = $('#currentRecipeList'); c.innerHTML = '';
        currentRecipeIngs.forEach((item, idx) => {
            if(!item._name) { const i = INVENTORY.find(x => x.id === item.id); item._name = i ? (i.isSub ? `üß© ${i.name}` : i.name) : "???"; }
            c.insertAdjacentHTML('beforeend', `<div class="ing-item"><span><b>${item.qty}</b> x ${item._name}</span> <button style="color:red;border:none;cursor:pointer" onclick="currentRecipeIngs.splice(${idx},1);window.renderCurrentRecipeList()">√ó</button></div>`);
        });
    };

    window.saveRecipe = async function() {
        const name = $('#recName').value.trim(); if(!name || !currentRecipeIngs.length) return alert("Falta info");
        await db.collection('recipes').doc(name).set({ ingredients: currentRecipeIngs.map(i => ({ id: i.id, qty: i.qty })) });
        alert("Guardado"); $('#modalRecipe').style.display = 'none';
    };

    window.renderRecipesList = function() { $('#recipesListBody').innerHTML = RECIPES.map(r => `<tr><td>${r.id}</td><td style="text-align:right"><b>${money(window.calculateRecipeTotal(r))}</b></td><td style="text-align:right"><button class="btn-icon" onclick="openRecipeModal('${r.id}')">‚úèÔ∏è</button><button class="btn-icon" onclick="deleteItem('recipes','${r.id}')">üóëÔ∏è</button></td></tr>`).join(''); };

    // DASHBOARD & DATA
    window.loadDashboardData = function() {
        const ym = $('#monthPicker').value; if(!ym) return; 
        $('#ordersTitle').innerText = 'üßæ Pedidos de ' + ym; logStatus("üîÑ Cargando...");
        const [y, m] = ym.split('-').map(Number); const start = new Date(y, m - 1, 1); const end = new Date(y, m, 0, 23, 59, 59);
        db.collection('orders').limit(500).get().then(snap => { 
              const rawOrders = snap.docs.map(d => ({id:d.id, ...d.data()}));
              ORDERS = rawOrders.filter(o => {
                  if(o.status === 'cancelled') return false;
                  const d = parseDate(o.createdAt); return d && d >= start && d <= end;
              }).sort((a,b) => parseDate(b.createdAt) - parseDate(a.createdAt));
              logStatus(`‚úÖ Cargado: ${ORDERS.length} pedidos.`);
              window.calculateAll(); window.renderOrdersTab(); 
          }).catch(err => { console.error(err); logStatus("‚ùå Error cargando: " + err.message, true); });
        db.collection('purchases').limit(500).get().then(snap=>{ PURCHASES=snap.docs.map(d=>d.data()); });
    };

    window.calculateAll = function() {
        if(typeof Chart === 'undefined') return;
        let gross=0, comms=0, taxes=0, theoCMV=0;
        const { taxDebit:pctDebit, taxTransf:pctTransf, taxQR:pctQR, pyPercent:pctPy } = FIXED_DATA.config || {};
        let dailySales = {}, productSales = {}, paymentStats = { 'Efectivo':0, 'Transferencia':0, 'MercadoPago/QR':0, 'PedidosYa':0, 'Otros':0 };

        ORDERS.forEach(o => {
            const sale = Number(o.total || 0); gross += sale;
            let pay = String(o.pago||o.paymentMethod||'').toLowerCase(); let finalPayMethod = 'Otros';
            if(String(o.source||'').toLowerCase().includes('pedidosya')) {
                 finalPayMethod = 'PedidosYa';
                 comms += (o.neto_excel > 0) ? (sale - o.neto_excel) : (sale * ((pctPy||30)/100));
            } else {
                if(pay.includes('mercado')||pay.includes('mp')||pay.includes('qr')) { taxes += (sale*(pctQR/100)); finalPayMethod='MercadoPago/QR'; }
                else if(pay.includes('transfer')) { taxes += (sale*(pctTransf/100)); finalPayMethod='Transferencia'; }
                else if(pay.includes('debito')||pay.includes('tarjeta')) { taxes += (sale*(pctDebit/100)); finalPayMethod='Otros'; } 
                else finalPayMethod='Efectivo';
            }
            (o.items||[]).forEach(item => { theoCMV += (window.getUnitCost(item.name) * Number(item.qty||1)); productSales[item.name] = (productSales[item.name] || 0) + Number(item.qty||1); });
            theoCMV += window.calculateOrderConsumables(o.items||[]);
            const dObj = parseDate(o.createdAt); if(dObj) dailySales[dObj.getDate()] = (dailySales[dObj.getDate()] || 0) + sale;
            paymentStats[finalPayMethod] += sale;
        });

        const totalFixed = (FIXED_DATA.fixed||[]).reduce((s,i)=>s+Number(i.cost),0); 
        const totalSalaries = (FIXED_DATA.prod||[]).reduce((s,i)=>s+Number(i.cost),0);
        const variableCosts = comms + taxes;
        const realPurchases = PURCHASES.reduce((s,p)=>s+Number(p.total),0);
        const profitReal = gross - (realPurchases + totalFixed + totalSalaries + variableCosts);

        $('#kpiSales').innerText = money(gross); $('#kpiTheoCMV').innerText = '-' + money(theoCMV); $('#kpiTotalExpenses').innerText = '-' + money(realPurchases + totalFixed + totalSalaries + variableCosts);
        const kn = $('#kpiNet'); kn.innerText = money(profitReal);
        kn.className = profitReal >= 0 ? 'kpi-val text-green' : 'kpi-val text-red'; $('#kpiNetContainer').style.backgroundColor = profitReal >= 0 ? '#f0fdf4' : '#fef2f2';

        if(chartMain) chartMain.destroy();
        chartMain = new Chart($('#mainChart').getContext('2d'), { type:'bar', data:{ labels:['Ventas','Mercader√≠a','Fijos','Sueldos','Var','Balance'], datasets:[{data:[gross,realPurchases,totalFixed,totalSalaries,variableCosts,profitReal], backgroundColor:['#64748b','#f97316','#a855f7','#3b82f6','#eab308',profitReal>=0?'#10b981':'#ef4444'], borderRadius:6}] }, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}} });
        window.renderExtraCharts(dailySales, productSales, paymentStats);
        
        // --- LLAMADA A LA NUEVA FUNCION DE PROPORCIONES ---
        window.renderProportions();
    };

    window.renderExtraCharts = function(dailyData, prodData, payData) {
        if(chartDaily) chartDaily.destroy();
        const days = Object.keys(dailyData).sort((a,b)=>Number(a)-Number(b));
        chartDaily = new Chart($('#dailyChart').getContext('2d'), { type: 'line', data: { labels: days, datasets: [{ label:'Venta', data: days.map(d=>dailyData[d]), borderColor:'var(--primary)', tension:0.3, fill:true, backgroundColor:'rgba(98,90,69,0.1)' }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} } });
        if(chartProds) chartProds.destroy();
        const sortedProds = Object.entries(prodData).sort((a,b)=>b[1]-a[1]).slice(0,5);
        chartProds = new Chart($('#topProductsChart').getContext('2d'), { type: 'doughnut', data: { labels: sortedProds.map(x=>x[0]), datasets: [{ data: sortedProds.map(x=>x[1]), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{boxWidth:10, font:{size:10}}}} } });
        if(chartPayment) chartPayment.destroy();
        chartPayment = new Chart($('#paymentChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(payData), datasets: [{ data: Object.values(payData), backgroundColor: ['#10b981','#3b82f6','#06b6d4','#ef4444','#64748b'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{boxWidth:10, font:{size:10}}}} } });
    }

    // TABLA PEDIDOS
    window.renderOrdersTab = function() {
        const tbody = $('#ordersTableBody'); tbody.innerHTML = '';
        if(ORDERS.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#999;">No hay pedidos</td></tr>'; return; }
        const { taxDebit:pctDebit, taxTransf:pctTransf, taxQR:pctQR, pyPercent:pctPy } = FIXED_DATA.config || {};
        ORDERS.forEach((o, index) => {
            const total = Number(o.total || 0); let deduction = 0;
            if(String(o.source).includes('pedidosya')) deduction = (o.neto_excel > 0) ? (total - o.neto_excel) : (total * ((pctPy||30)/100));
            else if(String(o.pago).includes('mercado') || String(o.pago).includes('qr')) deduction = total * (pctQR/100);
            else if(String(o.pago).includes('transfer')) deduction = total * (pctTransf/100);
            else if(String(o.pago).includes('debito')) deduction = total * (pctDebit/100);
            let orderCost = window.calculateOrderConsumables(o.items||[]); (o.items||[]).forEach(item => orderCost += (window.getUnitCost(item.name) * Number(item.qty||1)));
            let profit = total - deduction - orderCost;
            let dStr = '-'; const dt = parseDate(o.createdAt); if(dt) dStr = dt.toLocaleString('es-AR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
            tbody.innerHTML += `<tr class="order-row" onclick="document.getElementById('detail-${index}').classList.toggle('open')"><td>${dStr}</td><td>${o.nombre||'Cliente'}</td><td><span class="badge ${String(o.source).includes('pedidosya')?'bdg-py':'bdg-web'}">${o.source||'web'}</span></td><td><span class="badge bdg-cash">${o.pago||'efectivo'}</span></td><td style="font-weight:700">${money(total)}</td><td style="font-weight:700; color:${profit>=0?'var(--green)':'var(--red)'}">${money(profit)}</td><td>‚ñº</td></tr><tr class="order-details" id="detail-${index}"><td colspan="7" style="padding:10px; background:#f9fafb"><div style="font-size:12px"><b>Items:</b> ${(o.items||[]).map(i=>i.qty+'x '+i.name).join(', ')}<br><b>Ganancia Real:</b> ${money(profit)}</div></td></tr>`;
        });
    };
    
    // CALCULADORA DE COSTOS
    window.calculateOrderConsumables = function(items) {
        let totalCost = 0, burgerCount = 0, countSazon = 0;
        items.forEach(i => {
            const n = String(i.name||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const qty = Math.ceil(Number(i.qty||1));
            if(n.includes('hamb')||n.includes('burger')||n.includes('doble')||n.includes('simple')||n.includes('royal')||n.includes('cheese')||n.includes('cuarto')||n.includes('big')) {
                burgerCount += qty; if(n.includes('dorito')) countSazon += qty;
                const unitCost = window.getUnitCost(i.name);
                if (unitCost === 0) {
                    let patties = 1; if(n.includes('doble')) patties = 2; if(n.includes('triple')) patties = 3;
                    const pattyItem = INVENTORY.find(x => x.name.toLowerCase().includes('medallon') || x.name.toLowerCase().includes('patty'));
                    if(pattyItem) totalCost += (pattyItem.cost * patties * qty);
                }
            }
        });
        if(burgerCount === 0) return 0;
        const getCost = (keys) => { const item = INVENTORY.find(p => keys.some(k => String(p.name).toLowerCase().includes(k))); return item ? Number(item.cost || 0) : 0; };
        totalCost += (burgerCount * 0.200) * getCost(['papas fritas', 'papa frita', 'papas']);
        totalCost += burgerCount * getCost(['carton', 'caja papa']); totalCost += burgerCount * getCost(['parafinado', 'papel']);
        const bolsas = Math.ceil(burgerCount / 2); totalCost += bolsas * getCost(['bolsa', 'packaging']); totalCost += (bolsas * 3) * getCost(['ganchito']);
        totalCost += (burgerCount + bolsas) * 0.25 * getCost(['tinta', 'sello']);
        if(countSazon > 0) totalCost += (countSazon * 0.005) * getCost(['dorito', 'polvo']);
        return totalCost;
    };

    window.getUnitCost = function(n) { if(!n) return 0; const cn=n.toLowerCase().trim(), a=(FIXED_DATA.aliases||[]).find(x=>x.external.toLowerCase()===cn); if(a) return a.items?a.items.reduce((s,i)=>{const r=RECIPES.find(x=>x.id===i.id);return s+(r?window.calculateRecipeTotal(r)*i.qty:0)},0):(RECIPES.find(x=>x.id===a.internal)?window.calculateRecipeTotal(RECIPES.find(x=>x.id===a.internal)):0); let r=RECIPES.find(x=>x.id.toLowerCase()===cn)||RECIPES.find(x=>cn.includes(x.id.toLowerCase())); return r?window.calculateRecipeTotal(r):0; };
    window.calculateRecipeTotal = (r) => (r.ingredients||[]).reduce((s,i)=>{ const item = INVENTORY.find(x => x.id === i.id); return s + (item ? (i.qty * (item.isSub ? window.calculateSubRecipeCost(SUB_RECIPES.find(x=>x.id===i.id)||{ingredients:[]}) : item.cost)) : 0); },0);
    window.calculateSubRecipeCost = (sb) => (sb.ingredients||[]).reduce((s,i)=>{ const it = INVENTORY.find(x => x.id === i.id); return s + (i.qty * (it ? it.cost : 0)); },0);
    
    // UI HELPERS
    window.renderCostTables = function() { const rr=(a,t)=>{ $(t).innerHTML=a.map(p=>`<tr><td><b>${p.name}</b></td><td>$${p.purchCost||p.cost}</td><td><small>${p.format||'u'}</small></td><td>${p.yield||1} ${p.unit}</td><td style="font-weight:700;color:#166534">${money(p.cost)}</td><td><button class="btn-icon" onclick="openProductModal('${p.id}')">‚úé</button> <button class="btn-icon" onclick="deleteItem('inventory','${p.id}')">üóëÔ∏è</button></td></tr>`).join(''); }; rr(INVENTORY.filter(p=>p.category!=='packaging' && !p.isSub),'#costMateriaBody'); rr(INVENTORY.filter(p=>p.category==='packaging'),'#costPackBody'); };
    window.renderSubRecipesList = function(f="") { const c=$('#subRecipesListBody'), cf=f.toLowerCase(); c.innerHTML=SUB_RECIPES.filter(s=>s.name.toLowerCase().includes(cf)).map(s=>`<div onclick="openSubRecipeEditor('${s.id}')" style="padding:15px;cursor:pointer;border-bottom:1px solid #f1f5f9;${s.id===currentSubRecipeId?'background:#f8fafc;border-left:3px solid var(--purple)':''}"><div style="font-weight:600;font-size:13px">${s.name}</div><div style="font-size:12px;color:var(--purple);font-weight:700">${money(window.calculateSubRecipeCost(s))}</div></div>`).join('')||'<div style="padding:20px;text-align:center;color:#ccc;font-size:12px">No hay items</div>'; };
    window.updateUnitSelect = function(m) { const s=m==='sub'?$('#newSubUnit'):$('#newRecUnit'), p=INVENTORY.find(i=>i.id===(m==='sub'?$('#newSubIng').value:$('#newRecIng').value)); if(!s)return; let h='<option value="1">Unidad</option>'; if(p){const u=(p.unit||'').toLowerCase(); if(u.includes('k')) h='<option value="1">Kg</option><option value="0.001">Gr</option>'; else if(u.includes('l')) h='<option value="1">Lt</option><option value="0.001">Ml</option>'; else if(u.includes('m')) h='<option value="1">Mts</option><option value="0.01">Cm</option>'; else if(u.includes('g')) h='<option value="1">Gr</option><option value="1000">Kg</option>';} s.innerHTML=h; };
    
    // MODALES Y ABM
    window.openProductModal = function(id, cat) { $('#modalProduct').style.display='flex'; if(id && typeof id==='string'){ const p=INVENTORY.find(i=>i.id===id); $('#mpTitle').innerText='Editar'; $('#mpId').value=id; $('#mpName').value=p.name; $('#mpCat').value=p.category; $('#mpQty').value=p.qty; $('#mpUnit').value=p.unit; $('#mpPurchCost').value=p.purchCost||p.cost; $('#mpFormat').value=p.format||''; $('#mpYield').value=p.yield||1; $('#mpMin').value=p.min||5; } else { $('#mpTitle').innerText='Nuevo'; $('#mpId').value=''; $('#mpName').value=''; $('#mpQty').value=0; $('#mpPurchCost').value=0; $('#mpYield').value=1; if(cat)$('#mpCat').value=cat; } };
    window.saveProduct = async function() { const id=$('#mpId').value, pc=Number($('#mpPurchCost').value), y=Number($('#mpYield').value); const d={name:$('#mpName').value, category:$('#mpCat').value, qty:Number($('#mpQty').value), unit:$('#mpUnit').value, purchCost:pc, format:$('#mpFormat').value, yield:y, min:Number($('#mpMin').value), cost:y>0?pc/y:0}; if(!d.name)return; id?await db.collection('inventory').doc(id).update(d):await db.collection('inventory').add(d); $('#modalProduct').style.display='none'; };
    window.openPurchaseModal = function() { $('#modalPurchase').style.display='flex'; $('#purProd').innerHTML=INVENTORY.map(p=>`<option value="${p.id}">${p.name} (${formatQty(p.qty)})</option>`).join(''); $('#purQty').value=''; $('#purTotal').value=''; };
    window.confirmPurchase = async function() { const pid=$('#purProd').value, q=Number($('#purQty').value), t=Number($('#purTotal').value), d=$('#purDate').value; if(!pid||q<=0)return; await db.collection('purchases').add({prodId:pid, qty:q, total:t, date:d, prodName:INVENTORY.find(i=>i.id===pid)?.name}); const p=INVENTORY.find(i=>i.id===pid); if(p) { const col=p.isSub?'subrecipes':'inventory'; await db.collection(col).doc(pid).update({qty:Number(p.qty)+q}); } alert("Registrado"); $('#modalPurchase').style.display='none'; window.loadDashboardData(); };
    window.addNewSubRecipe = async function() { const n=prompt("Nombre:"); if(n) await db.collection('subrecipes').add({name:n, ingredients:[], qty:0}); };
    window.addNewRecipe = async function() { const n=prompt("Nombre:"); if(n) await db.collection('recipes').doc(n).set({ingredients:[]}); };
    window.openSubRecipeEditor = function(id) { currentSubRecipeId=id; $('#subRecipeEditor').style.display='flex'; $('#subRecipeEmpty').style.display='none'; window.renderSubRecipesList(); const s=SUB_RECIPES.find(x=>x.id===id); $('#subEditorTitle').innerText=s.name; $('#newSubIng').innerHTML=INVENTORY.filter(i=>!i.isSub).map(i=>`<option value="${i.id}">${i.name} ($${parseFloat(i.cost).toFixed(2)})</option>`).join(''); window.updateUnitSelect('sub'); let tc=0; $('#subRecipeIngBody').innerHTML=(s.ingredients||[]).map((ing,i)=>{ const it=INVENTORY.find(x=>x.id===ing.id), c=(it?Number(it.cost):0)*Number(ing.qty); tc+=c; return `<tr><td>${it?it.name:'?'}</td><td>${formatQty(ing.qty)}</td><td>${money(it?it.cost:0)}</td><td>${money(c)}</td><td><button class="btn-icon" onclick="removeSubIng('${id}',${i})">üóëÔ∏è</button></td></tr>`; }).join(''); $('#subEditorTotalCost').innerText=money(tc); };
    window.addIngToSubRecipe = async function() { const id=$('#newSubIng').value, q=Number($('#newSubQty').value), m=Number($('#newSubUnit').value); if(!id||q<=0)return; const s=SUB_RECIPES.find(x=>x.id===currentSubRecipeId), n=[...(s.ingredients||[]),{id,qty:q*m}]; await db.collection('subrecipes').doc(currentSubRecipeId).update({ingredients:n}); };
    window.removeSubIng = async function(sid,i) { const s=SUB_RECIPES.find(x=>x.id===sid), n=[...s.ingredients]; n.splice(i,1); await db.collection('subrecipes').doc(sid).update({ingredients:n}); };
    window.deleteItem = async function(c,id) { if(confirm('¬øBorrar?')){ await db.collection(c).doc(id).delete(); if(c==='recipes') $('#recipeEditor').style.display='none'; if(c==='subrecipes') $('#subRecipeEditor').style.display='none'; } };
    window.openAliasModal = function() { $('#modalAlias').style.display='flex'; $('#aliasListBody').innerHTML=(FIXED_DATA.aliases||[]).map((a,i)=>`<tr><td>${a.external}</td><td>${a.items?a.items.length:0} items</td><td><button class="btn-icon" onclick="deleteAlias(${i})">üóëÔ∏è</button></td></tr>`).join(''); $('#aliasInt').innerHTML=RECIPES.map(r=>`<option value="${r.id}">${r.id}</option>`).join(''); tempAliasList=[]; $('#tempAliasItems').innerHTML=''; };
    window.addItemToAlias = function() { const id=$('#aliasInt').value, q=$('#aliasQty').value; if(id){ tempAliasList.push({id,qty:Number(q)}); $('#tempAliasItems').innerHTML=tempAliasList.map(x=>`<div>${x.qty}x ${x.id}</div>`).join(''); } };
    window.saveAlias = function() { const e=$('#aliasExt').value; if(e&&tempAliasList.length){ if(!FIXED_DATA.aliases)FIXED_DATA.aliases=[]; FIXED_DATA.aliases.push({external:e,items:tempAliasList}); window.saveFixedData(); $('#modalAlias').style.display='none'; } };
    window.deleteAlias = function(i) { FIXED_DATA.aliases.splice(i,1); window.saveFixedData(); };
    window.addFixedRow = function() { FIXED_DATA.fixed.push({name:'',cost:0}); window.renderFixedTables(); };
    window.addProdRow = function() { FIXED_DATA.prod.push({name:'',cost:0}); window.renderFixedTables(); };
    window.updFix = function(a,i,k,v) { FIXED_DATA[a][i][k]=k==='cost'?Number(v):v; };
    window.delFix = function(a,i) { FIXED_DATA[a].splice(i,1); window.renderFixedTables(); };
    window.renderFixedTables = function() { $('#tableFixed tbody').innerHTML=FIXED_DATA.fixed.map((r,i)=>`<tr><td><input value="${r.name}" onchange="updFix('fixed',${i},'name',this.value)"></td><td><input type="number" value="${r.cost}" onchange="updFix('fixed',${i},'cost',this.value)"></td><td><button class="btn-icon" onclick="delFix('fixed',${i})">üóëÔ∏è</button></td></tr>`).join(''); $('#tableProd tbody').innerHTML=FIXED_DATA.prod.map((r,i)=>`<tr><td><input value="${r.name}" onchange="updFix('prod',${i},'name',this.value)"></td><td><input type="number" value="${r.cost}" onchange="updFix('prod',${i},'cost',this.value)"></td><td><button class="btn-icon" onclick="delFix('prod',${i})">üóëÔ∏è</button></td></tr>`).join(''); };
    window.saveFixedData = function() { if(!FIXED_DATA.aliases)FIXED_DATA.aliases=[]; FIXED_DATA.config={pyPercent:Number($('#confPy').value), taxDebit:Number($('#confDebit').value), taxTransf:Number($('#confTransf').value), taxQR:Number($('#confQR').value)}; db.collection('config').doc('gerencia').set(FIXED_DATA).then(()=>alert("Guardado")); window.calculateAll(); window.renderOrdersTab(); };
    window.saveConfig = window.saveFixedData;
    window.showTab = function(id) { document.querySelectorAll('div[id^="tab-"]').forEach(d=>d.style.display='none'); $('#tab-'+id).style.display='block'; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); if(id==='proportions') window.renderProportions(); };

    window.addEventListener('load', () => {
        const now = new Date();
        $('#monthPicker').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
        $('#monthPicker').addEventListener('change', window.loadDashboardData);
        loadProductsDB(); // üî• Carga los productos al iniciar
        window.loadInventory(); window.loadRecipes(); window.loadFixedData(); window.loadDashboardData();
    });
</script>
</body>
</html>
