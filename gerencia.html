<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; 
      --bg: #f1f5f9; 
      --card: #ffffff;
      --text: #0f172a;
      --border: #e2e8f0;
      --green: #10b981; --red: #ef4444; --blue: #3b82f6;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; gap:10px; align-items: center; text-decoration: none; }
    .nav-btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 13px; }
    .nav-btn:hover { background: #f8fafc; color: var(--text); }
    .nav-btn.active { background: var(--primary); color: #fff; }

    /* LAYOUT PRINCIPAL */
    .layout { display: flex; flex: 1; overflow: hidden; }
    
    /* SIDEBAR (PESTA√ëAS TIPO EXCEL) */
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; }
    .tab-btn { 
        padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; 
        border-left: 3px solid transparent; display: flex; justify-content: space-between;
    }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: #f0fdf4; color: var(--primary); border-left-color: var(--primary); }

    /* CONTENT AREA */
    .content { flex: 1; padding: 30px; overflow-y: auto; }
    
    /* CARDS & TABLES */
    .card { background: #fff; border-radius: 8px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    h2 { margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

    /* ESTILO PLANILLA EXCEL */
    .sheet-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .sheet-table th { background: #f8fafc; text-align: left; padding: 8px 12px; border: 1px solid #e2e8f0; font-weight: 700; color: #475569; }
    .sheet-table td { border: 1px solid #e2e8f0; padding: 0; }
    .sheet-table input { width: 100%; border: none; padding: 8px 12px; font-family: inherit; font-size: 13px; outline: none; background: transparent; }
    .sheet-table input:focus { background: #f0f9ff; box-shadow: inset 0 0 0 2px var(--blue); }
    .sheet-table tr:hover td { background: #fafafa; }
    .readonly { background: #f1f5f9; color: #64748b; font-weight: 600; text-align: right; }

    /* DASHBOARD */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .kpi { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
    .kpi-lbl { font-size: 12px; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .kpi-val { font-size: 24px; font-weight: 900; color: #0f172a; margin-top: 5px; }
    .text-red { color: var(--red); }
    .text-green { color: var(--green); }

    /* CONTROLS */
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    input[type=month] { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-weight: 600; }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; font-size: 13px; }
    .btn-save { background: var(--primary); color: white; }
    .btn-calc { background: var(--blue); color: white; }

  </style>
</head>
<body>

<header>
  <a href="#" class="brand"><img src="images/logo.png" width="30"> Gerencia Rhodes</a>
  <div>
    <a href="pedido_local.html" class="nav-btn">Pedidos</a>
    <a href="#" class="nav-btn active">Gerencia</a>
    <button onclick="location.href='login.html'" class="nav-btn" style="color:var(--red)">Salir</button>
  </div>
</header>

<div class="layout">
  
  <aside class="sidebar">
    <div class="tab-btn active" onclick="showTab('dashboard')">üìä Rendimiento</div>
    <div class="tab-btn" onclick="showTab('materia')">ü•© Materia Prima</div>
    <div class="tab-btn" onclick="showTab('packaging')">ü•° Costos Packaging</div>
    <div class="tab-btn" onclick="showTab('fixed')">üí° Costos Fijos</div>
    <div class="tab-btn" onclick="showTab('production')">üë®‚Äçüç≥ Sueldos/Prod</div>
  </aside>

  <main class="content">

    <div id="tab-dashboard">
      <div class="controls">
        <h2>Tablero de Comando</h2>
        <div style="display:flex; gap:10px; align-items:center">
            <label style="font-size:13px; font-weight:600">Periodo:</label>
            <input type="month" id="monthPicker">
            <button class="btn btn-calc" onclick="calculateAll()">üîÑ Recalcular</button>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi">
            <div class="kpi-lbl">Ventas Brutas</div>
            <div class="kpi-val" id="kpiSales">$ 0</div>
        </div>
        <div class="kpi">
            <div class="kpi-lbl">Costo Producci√≥n (CMV)</div>
            <div class="kpi-val text-red" id="kpiCmv">$ 0</div>
        </div>
        <div class="kpi">
            <div class="kpi-lbl">Gastos Fijos + Pack</div>
            <div class="kpi-val text-red" id="kpiFixed">$ 0</div>
        </div>
        <div class="kpi" style="background: #f0fdf4; border-color: #bbf7d0;">
            <div class="kpi-lbl text-green">Ganancia Neta</div>
            <div class="kpi-val text-green" id="kpiProfit">$ 0</div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
        <div class="card">
            <h2>Evoluci√≥n Financiera</h2>
            <canvas id="mainChart" height="200"></canvas>
        </div>
        <div class="card">
            <h2>Desglose por Burger</h2>
            <div id="burgerStats" style="font-size:13px; color:#555">
                </div>
        </div>
      </div>
    </div>

    <div id="tab-materia" style="display:none">
      <div class="controls">
        <h2>Costos de Insumos (Base de C√°lculo)</h2>
        <button class="btn btn-save" onclick="saveData()">üíæ Guardar Precios</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableMateria">
            <thead>
                <tr>
                    <th>Insumo</th>
                    <th width="100">Unidad</th>
                    <th width="150">Costo ($)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn" style="margin-top:10px; background:#e2e8f0" onclick="addRow('tableMateria')">+ Agregar Insumo</button>
      </div>
    </div>

    <div id="tab-packaging" style="display:none">
      <div class="controls">
        <h2>Costos de Packaging</h2>
        <button class="btn btn-save" onclick="saveData()">üíæ Guardar Precios</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tablePack">
            <thead>
                <tr>
                    <th>Item</th>
                    <th width="150">Costo Unitario ($)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn" style="margin-top:10px; background:#e2e8f0" onclick="addRow('tablePack')">+ Agregar Item</button>
      </div>
    </div>

    <div id="tab-fixed" style="display:none">
      <div class="controls">
        <h2>Gastos Fijos Mensuales (Luz, Alquiler, etc.)</h2>
        <button class="btn btn-save" onclick="saveData()">üíæ Guardar Gastos</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableFixed">
            <thead>
                <tr>
                    <th>Concepto</th>
                    <th width="150">Monto Mensual ($)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn" style="margin-top:10px; background:#e2e8f0" onclick="addRow('tableFixed')">+ Agregar Gasto</button>
      </div>
    </div>

    <div id="tab-production" style="display:none">
      <div class="controls">
        <h2>Sueldos y Producci√≥n</h2>
        <button class="btn btn-save" onclick="saveData()">üíæ Guardar</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableProd">
            <thead>
                <tr>
                    <th>Empleado / Concepto</th>
                    <th width="150">Total a Pagar ($)</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <button class="btn" style="margin-top:10px; background:#e2e8f0" onclick="addRow('tableProd')">+ Agregar</button>
      </div>
    </div>

  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // --- 1. CONFIGURACI√ìN ---
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});

    // --- 2. DATOS INICIALES (SIMULANDO TU EXCEL) ---
    // Estos datos se guardar√°n en LocalStorage para persistir cambios
    const DEFAULT_DATA = {
        materia: [
            {name: 'Carne (kg)', unit: 'kg', cost: 16200},
            {name: 'Pan Brioche (u)', unit: 'u', cost: 650},
            {name: 'Cheddar (feta)', unit: 'u', cost: 187},
            {name: 'Papas (kg)', unit: 'kg', cost: 1200},
            {name: 'Bacon (kg)', unit: 'kg', cost: 13920}
        ],
        pack: [
            {name: 'Caja Hamburguesa', cost: 150},
            {name: 'Bolsa Papel', cost: 60},
            {name: 'Papel Parafinado', cost: 40}
        ],
        fixed: [
            {name: 'Alquiler', cost: 0}, // Vi 0 en tu excel
            {name: 'Electricidad', cost: 140000},
            {name: 'Gas', cost: 40000},
            {name: 'Monotributo', cost: 42216},
            {name: 'Publicidad', cost: 40000}
        ],
        prod: [
            {name: 'Sueldos Totales', cost: 2631557},
            {name: 'Aguinaldos', cost: 219296}
        ]
    };

    let DATA = JSON.parse(localStorage.getItem('rhodes_excel_data')) || DEFAULT_DATA;
    let ORDERS = [];
    let chartInstance = null;

    // --- 3. INICIO ---
    window.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        $('#monthPicker').value = now.toISOString().slice(0,7);
        $('#monthPicker').addEventListener('change', fetchOrders);

        renderTables();
        fetchOrders(); // Trae las ventas reales
    });

    // --- 4. RENDERIZADO DE TABLAS ---
    function renderTables() {
        renderTable('tableMateria', DATA.materia, ['name', 'unit', 'cost']);
        renderTable('tablePack', DATA.pack, ['name', 'cost']);
        renderTable('tableFixed', DATA.fixed, ['name', 'cost']);
        renderTable('tableProd', DATA.prod, ['name', 'cost']);
    }

    function renderTable(id, dataArr, fields) {
        const tbody = document.getElementById(id).querySelector('tbody');
        tbody.innerHTML = '';
        dataArr.forEach((row, idx) => {
            let tr = document.createElement('tr');
            fields.forEach(key => {
                let td = document.createElement('td');
                let input = document.createElement('input');
                input.value = row[key];
                // Si es costo, alinear derecha
                if(key === 'cost') { 
                    input.type = 'number'; 
                    input.style.textAlign = 'right'; 
                    input.style.fontWeight = 'bold';
                }
                input.onchange = (e) => {
                    row[key] = key === 'cost' ? Number(e.target.value) : e.target.value;
                };
                td.appendChild(input);
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    window.addRow = (tableId) => {
        let arrName = '';
        if(tableId === 'tableMateria') arrName = 'materia';
        if(tableId === 'tablePack') arrName = 'pack';
        if(tableId === 'tableFixed') arrName = 'fixed';
        if(tableId === 'tableProd') arrName = 'prod';
        
        DATA[arrName].push({name: '', cost: 0, unit: ''});
        renderTables();
    };

    window.saveData = () => {
        localStorage.setItem('rhodes_excel_data', JSON.stringify(DATA));
        alert("‚úÖ Datos actualizados. Recalculando...");
        calculateAll();
    };

    // --- 5. L√ìGICA DE NEGOCIO (EL MOTOR) ---
    function fetchOrders() {
        const ym = $('#monthPicker').value;
        if(!ym) return;
        const [y, m] = ym.split('-').map(Number);
        const start = new Date(y, m-1, 1).toISOString();
        const end = new Date(y, m, 1).toISOString();

        db.collection('orders')
          .where('createdAt', '>=', start)
          .where('createdAt', '<', end)
          .get().then(snap => {
              ORDERS = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled');
              calculateAll();
          });
    }

    function calculateAll() {
        // A. Sumar Gastos Fijos Totales (Fijos + Sueldos)
        const totalFixed = DATA.fixed.reduce((s, i) => s + i.cost, 0) + 
                           DATA.prod.reduce((s, i) => s + i.cost, 0);

        // B. Costos Unitarios Base (Desde tabla Materia Prima)
        // Buscamos precios clave para armar la receta
        const meatPrice = DATA.materia.find(i => i.name.includes('Carne'))?.cost || 16200; // $/kg
        const panPrice = DATA.materia.find(i => i.name.includes('Pan'))?.cost || 650;
        const cheddarPrice = DATA.materia.find(i => i.name.includes('Cheddar'))?.cost || 187; // por feta
        const baconPrice = DATA.materia.find(i => i.name.includes('Bacon'))?.cost || 13920; // $/kg
        const friesPrice = DATA.materia.find(i => i.name.includes('Papas'))?.cost || 1200; // $/kg

        // Costo Packaging Promedio
        const packAvg = DATA.pack.reduce((s, i) => s + i.cost, 0); // Suma simple, idealmente por item

        // C. Procesar Pedidos
        let grossSales = 0;
        let totalCMV = 0; // Costo Mercader√≠a Vendida
        let totalPack = 0;
        let totalCommissions = 0;

        let burgerStats = {};

        ORDERS.forEach(o => {
            const sale = Number(o.total || 0);
            grossSales += sale;

            // Comisi√≥n (si es App, asumimos 30% aprox)
            if(o.source === 'pedidosya') totalCommissions += (sale * 0.30);

            // Packaging por pedido
            totalPack += packAvg;

            // Receta Din√°mica
            (o.items || []).forEach(item => {
                const name = (item.name || '').toLowerCase();
                const qty = Number(item.qty || 1);
                
                // COSTO RECETA (Aproximaci√≥n basada en tus CSV)
                let itemCost = 0;
                
                // Burger Base
                if(name.includes('burger') || name.includes('hamburguesa') || name.includes('doble') || name.includes('triple')) {
                    const patties = name.includes('doble') ? 2 : (name.includes('triple') ? 3 : 1);
                    const meatCost = (0.12 * patties) * meatPrice; // 120g por medall√≥n
                    const cheeseCost = (2 * patties) * cheddarPrice; // 2 fetas por carne
                    const bunCost = panPrice;
                    
                    itemCost = meatCost + cheeseCost + bunCost;
                    
                    if(name.includes('bacon')) itemCost += (0.03 * baconPrice); // 30g bacon
                }
                
                // Papas
                if(name.includes('papas') || o.items.some(i => i.type === 'side')) {
                    itemCost += (0.2 * friesPrice); // 200g papas
                }

                totalCMV += (itemCost * qty);

                // Stats
                if(!burgerStats[name]) burgerStats[name] = 0;
                burgerStats[name] += qty;
            });
        });

        // D. Resultado Final
        const totalExpenses = totalFixed + totalCMV + totalPack + totalCommissions;
        const profit = grossSales - totalExpenses;

        // E. Render UI
        $('#kpiSales').innerText = money(grossSales);
        $('#kpiCmv').innerText = '-' + money(totalCMV);
        $('#kpiFixed').innerText = '-' + money(totalFixed + totalPack + totalCommissions); // Agrupado
        $('#kpiProfit').innerText = money(profit);

        renderChart(grossSales, totalFixed, totalCMV, totalCommissions, profit);
        
        // Render Burger Stats
        const sorted = Object.entries(burgerStats).sort((a,b)=>b[1]-a[1]).slice(0,5);
        $('#burgerStats').innerHTML = sorted.map(([k,v]) => `<div style="display:flex; justify-content:space-between; margin-bottom:5px"><span>${k}</span><b>${v}</b></div>`).join('');
    }

    // --- 6. GR√ÅFICOS ---
    function renderChart(sales, fixed, cmv, comm, profit) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ventas', 'Gastos Fijos', 'Insumos (CMV)', 'Comisiones', 'Ganancia'],
                datasets: [{
                    label: 'Flujo de Caja',
                    data: [sales, fixed, cmv, comm, profit],
                    backgroundColor: [
                        '#94a3b8', // Ventas
                        '#ef4444', // Fijos
                        '#f97316', // Insumos
                        '#eab308', // Comisiones
                        '#10b981'  // Ganancia
                    ],
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- 7. UI TABS ---
    window.showTab = (tabName) => {
        document.querySelectorAll('div[id^="tab-"]').forEach(d => d.style.display = 'none');
        document.querySelector('#tab-' + tabName).style.display = 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    };

</script>
</body>
</html>
