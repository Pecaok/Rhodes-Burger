<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; 
      --bg: #f3f4f6; 
      --card: #ffffff;
      --text: #1f2937;
      --ring: #e5e7eb;
      --green: #10b981;
      --red: #ef4444;
      --blue: #3b82f6;
      --orange: #f97316;
      --purple: #8b5cf6;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 60px; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--ring); position: sticky; top: 0; z-index: 100; }
    .topbar { max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; }
    .nav-btn { padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #555; font-weight: 600; font-size: 14px; }
    .nav-btn:hover { background: #f9fafb; }
    .nav-btn.active { background: var(--primary); color: #fff; }
    .btn-danger { background: #fee2e2; color: #b91c1c; padding: 8px 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; }

    /* LAYOUT */
    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
    @media(max-width: 900px) { .container { grid-template-columns: 1fr; } }

    /* CARDS */
    .card { background: #fff; border-radius: 16px; padding: 20px; border: 1px solid var(--ring); box-shadow: 0 2px 5px rgba(0,0,0,0.02); margin-bottom: 20px; }
    h2 { font-size: 15px; font-weight: 800; color: #4b5563; margin: 0 0 15px; border-bottom: 1px solid var(--ring); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; text-transform: uppercase; letter-spacing: 0.5px; }

    /* INPUTS */
    .row { display: flex; gap: 10px; margin-bottom: 10px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-weight: 600; font-size: 13px; }
    button { padding: 10px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .btn-add { background: var(--primary); color: #fff; width: 100%; margin-top: 5px; }
    
    /* SECCIONES DE COSTOS */
    .cost-section { margin-bottom: 20px; border: 1px solid var(--ring); border-radius: 12px; overflow: hidden; }
    .cost-header { padding: 10px 15px; background: #f9fafb; font-weight: 700; font-size: 14px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--ring); }
    
    .list-container { max-height: 150px; overflow-y: auto; background: #fff; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; border-bottom: 1px dashed #eee; font-size: 13px; }
    .list-item:last-child { border-bottom: none; }
    .item-val { font-weight: 700; color: #555; }
    .btn-del { background: transparent; color: #ccc; font-size: 16px; padding: 0 0 0 10px; }
    .btn-del:hover { color: var(--red); }

    /* RESULTADOS */
    .res-card { position: sticky; top: 80px; }
    .big-res { text-align: center; margin: 20px 0; }
    .big-val { font-size: 36px; font-weight: 900; line-height: 1; }
    .big-label { font-size: 12px; color: #666; text-transform: uppercase; font-weight: 700; }

    /* COLORES TAGS */
    .tag { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
    .c-fixed { background: var(--purple); }
    .c-raw { background: var(--orange); }
    .c-pack { background: var(--blue); }
    .c-prod { background: #0ea5e9; } /* Cyan */

    /* AUTO CONFIG */
    .auto-config { background: #fffbeb; border: 1px solid #fcd34d; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
    .ac-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; }
    .ac-row:last-child { margin-bottom: 0; }
    .ac-inp { width: 70px; padding: 5px; text-align: right; border: 1px solid #fcd34d; }

  </style>
</head>
<body>

<header>
  <div class="topbar">
    <a href="#" class="brand">Rhodes Gerencia</a>
    <div style="display:flex; gap:10px">
        <a href="pedido_local.html" class="nav-btn">üì¶ Pedidos</a>
        <a href="#" class="nav-btn active">üìä Rentabilidad</a>
        <button onclick="location.href='login.html'" class="btn-danger">Salir</button>
    </div>
  </div>
</header>

<div class="container">

  <div>
    
    <div class="card">
        <h2>üìÖ Periodo de An√°lisis</h2>
        <input type="month" id="monthPicker">
        
        <div style="margin-top:15px; display:flex; justify-content:space-between; font-size:13px; color:#555">
            <span>Ventas del Mes:</span>
            <strong id="totalSales">$ 0</strong>
        </div>
        <div style="display:flex; justify-content:space-between; font-size:13px; color:#555">
            <span>Pedidos:</span>
            <strong id="totalOrders">0</strong>
        </div>
    </div>

    <div class="auto-config">
        <h3 style="margin:0 0 10px 0; font-size:14px; color:#92400e;">‚ö° Variables Autom√°ticas</h3>
        
        <div class="ac-row">
            <span>üõµ Comisi√≥n PedidosYa (%)</span>
            <input type="number" id="confPy" value="30" class="ac-inp" onchange="updateCalc()">
        </div>
        <div class="ac-row">
            <span>ü•° Packaging ($ Unitario)</span>
            <input type="number" id="confPack" value="400" class="ac-inp" onchange="updateCalc()">
        </div>
        <p style="font-size:11px; color:#b45309; margin:8px 0 0 0; line-height:1.2">
            Estos costos se calculan solos seg√∫n la venta y cantidad de pedidos.
        </p>
    </div>

    <div class="card">
        <h2>üìù Agregar Gasto Manual</h2>
        
        <label style="font-size:12px; font-weight:700; color:#555">Categor√≠a</label>
        <select id="costType" style="margin-bottom:10px">
            <option value="raw">ü•© Materia Prima (Carne, Pan)</option>
            <option value="pack">ü•° Packaging (Cajas, Bolsas)</option>
            <option value="fixed">üí° Costos Fijos (Luz, Alquiler)</option>
            <option value="prod">üë®‚Äçüç≥ Producci√≥n (Sueldos, Extras)</option>
        </select>

        <div class="row">
            <input type="text" id="costName" placeholder="Descripci√≥n (Ej: Carne Coto)">
            <input type="number" id="costVal" placeholder="$ Monto" style="width:120px">
        </div>
        <button class="btn-add" onclick="addCost()">+ AGREGAR GASTO</button>
    </div>

  </div>

  <div>
    
    <div class="cost-section" style="border-color: #fdba74;">
        <div class="cost-header" style="background:#fff7ed; color:#9a3412;">
            <span>ü•© Costos Materia Prima</span>
            <span id="sumRaw">$ 0</span>
        </div>
        <div class="list-container" id="listRaw"></div>
    </div>

    <div class="cost-section" style="border-color: #93c5fd;">
        <div class="cost-header" style="background:#eff6ff; color:#1e40af;">
            <span>ü•° Costos Packaging</span>
            <span id="sumPack">$ 0</span>
        </div>
        <div class="list-container">
            <div class="list-item" style="background:#f0f9ff">
                <span>‚ö° Auto (seg√∫n pedidos)</span>
                <span class="item-val" id="valAutoPack">$ 0</span>
            </div>
            <div id="listPack"></div>
        </div>
    </div>

    <div class="cost-section" style="border-color: #7dd3fc;">
        <div class="cost-header" style="background:#f0f9ff; color:#0369a1;">
            <span>üë®‚Äçüç≥ Costos Producci√≥n</span>
            <span id="sumProd">$ 0</span>
        </div>
        <div class="list-container" id="listProd"></div>
    </div>

    <div class="cost-section" style="border-color: #c4b5fd;">
        <div class="cost-header" style="background:#f5f3ff; color:#5b21b6;">
            <span>üí° Costos Fijos</span>
            <span id="sumFixed">$ 0</span>
        </div>
        <div class="list-container" id="listFixed"></div>
    </div>

    <div class="cost-section" style="border-color: #fca5a5;">
        <div class="cost-header" style="background:#fef2f2; color:#991b1b;">
            <span>üõµ Comisiones PedidosYa (Auto)</span>
            <span id="valAutoPy">$ 0</span>
        </div>
    </div>

    <div class="card res-card">
        <div class="big-res">
            <div class="big-label">GANANCIA NETA REAL</div>
            <div class="big-val" id="finalProfit">$ 0</div>
            <div style="font-size:13px; color:#666; margin-top:5px">Margen: <span id="finalMargin">0%</span></div>
        </div>
        
        <div style="height:200px; position:relative">
            <canvas id="chart"></canvas>
        </div>
    </div>

  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // 1. FIREBASE
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.getElementById(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});

    // 2. ESTADO
    let ORDERS = [];
    // Estructura: { id, type: 'raw'|'pack'|'fixed'|'prod', name, val }
    let COSTS = JSON.parse(localStorage.getItem('rhodes_costs_v2') || '[]');
    let chartInstance = null;

    // 3. INICIO
    window.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        $('monthPicker').value = now.toISOString().slice(0,7);
        
        $('monthPicker').addEventListener('change', loadOrders);
        
        // Cargar config guardada
        if(localStorage.getItem('rhodes_conf_py')) $('confPy').value = localStorage.getItem('rhodes_conf_py');
        if(localStorage.getItem('rhodes_conf_pack')) $('confPack').value = localStorage.getItem('rhodes_conf_pack');

        renderCosts();
        loadOrders();
    });

    // 4. CARGAR VENTAS
    function loadOrders() {
        const ym = $('monthPicker').value;
        if(!ym) return;
        const [y, m] = ym.split('-').map(Number);
        
        const start = new Date(y, m-1, 1).toISOString();
        const end = new Date(y, m, 1).toISOString();

        db.collection('orders')
          .where('createdAt', '>=', start)
          .where('createdAt', '<', end)
          .get().then(snap => {
              ORDERS = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled');
              updateCalc();
          });
    }

    // 5. GESTI√ìN DE COSTOS
    window.addCost = () => {
        const type = $('costType').value;
        const name = $('costName').value.trim();
        const val = Number($('costVal').value);
        if(!name || val <= 0) return alert("Ingres√° descripci√≥n y monto");

        COSTS.push({ id: Date.now(), type, name, val });
        saveCosts();
        $('costName').value = ''; 
        $('costVal').value = '';
    };

    window.delCost = (id) => {
        COSTS = COSTS.filter(c => c.id !== id);
        saveCosts();
    };

    function saveCosts() {
        localStorage.setItem('rhodes_costs_v2', JSON.stringify(COSTS));
        renderCosts();
        updateCalc();
    }

    function renderCosts() {
        // Limpiar listas
        ['listRaw', 'listPack', 'listFixed', 'listProd'].forEach(id => $(id).innerHTML = '');

        COSTS.forEach(c => {
            const html = `
                <div class="list-item">
                    <span>${c.name}</span>
                    <div style="display:flex; align-items:center">
                        <span class="item-val">-${money(c.val)}</span>
                        <button class="btn-del" onclick="delCost(${c.id})">√ó</button>
                    </div>
                </div>`;
            
            if(c.type === 'raw') $('listRaw').innerHTML += html;
            if(c.type === 'pack') $('listPack').innerHTML += html;
            if(c.type === 'fixed') $('listFixed').innerHTML += html;
            if(c.type === 'prod') $('listProd').innerHTML += html;
        });
    }

    // 6. C√ÅLCULO FINAL
    function updateCalc() {
        // Guardar config
        const pyPerc = Number($('confPy').value) || 0;
        const packUnit = Number($('confPack').value) || 0;
        localStorage.setItem('rhodes_conf_py', pyPerc);
        localStorage.setItem('rhodes_conf_pack', packUnit);

        // A. Ventas
        let totalSales = 0;
        let pySales = 0;
        ORDERS.forEach(o => {
            const t = Number(o.total || 0);
            totalSales += t;
            if(o.source === 'pedidosya') pySales += t;
        });

        // B. Costos Autom√°ticos
        const costAutoPy = pySales * (pyPerc / 100);
        const costAutoPack = ORDERS.length * packUnit;

        // C. Sumar Listas Manuales
        let manualRaw = 0, manualPack = 0, manualFixed = 0, manualProd = 0;
        COSTS.forEach(c => {
            if(c.type === 'raw') manualRaw += c.val;
            if(c.type === 'pack') manualPack += c.val;
            if(c.type === 'fixed') manualFixed += c.val;
            if(c.type === 'prod') manualProd += c.val;
        });

        // D. Totales por Categor√≠a
        const totalRaw = manualRaw;
        const totalPack = costAutoPack + manualPack;
        const totalFixed = manualFixed;
        const totalProd = manualProd;
        const totalPy = costAutoPy;

        // E. Resultado Final
        const totalCosts = totalRaw + totalPack + totalFixed + totalProd + totalPy;
        const profit = totalSales - totalCosts;
        const margin = totalSales > 0 ? (profit / totalSales * 100) : 0;

        // F. Render Textos
        $('totalSales').innerText = money(totalSales);
        $('totalOrders').innerText = ORDERS.length;

        $('valAutoPy').innerText = '-' + money(totalPy);
        $('valAutoPack').innerText = '-' + money(costAutoPack); // Solo la parte auto

        $('sumRaw').innerText = '-' + money(totalRaw);
        $('sumPack').innerText = '-' + money(totalPack);
        $('sumFixed').innerText = '-' + money(totalFixed);
        $('sumProd').innerText = '-' + money(totalProd);

        $('finalProfit').innerText = money(profit);
        $('finalProfit').style.color = profit >= 0 ? 'var(--green)' : 'var(--red)';
        $('finalMargin').innerText = margin.toFixed(1) + '%';

        updateChart(profit, totalPy, totalPack, totalRaw, totalProd, totalFixed);
    }

    // 7. GR√ÅFICO
    function updateChart(profit, py, pack, raw, prod, fixed) {
        const ctx = $('chart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Ganancia', 'Comisi√≥n Py', 'Packaging', 'Materia Prima', 'Producci√≥n', 'Fijos'],
                datasets: [{
                    data: [Math.max(0, profit), py, pack, raw, prod, fixed],
                    backgroundColor: ['#10b981', '#f87171', '#60a5fa', '#fb923c', '#38bdf8', '#a78bfa'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: {size: 11} } }
                }
            }
        });
    }

</script>
</body>
</html>
