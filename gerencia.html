<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; 
      --text: #1f2937; 
      --bg: #f3f4f6; 
      --card: #ffffff;
      --ring: #e5e7eb;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 40px; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--ring); position: sticky; top: 0; z-index: 100; }
    .topbar { max-width: 1200px; margin: 0 auto; height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-btn { padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #4b5563; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .nav-btn:hover { background: #f9fafb; }
    .nav-btn.active { background: var(--primary); color: #fff; }
    .btn-danger { color: #d32f2f; background: #ffebee; border: 1px solid #ffcdd2; padding: 8px 12px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }

    /* LAYOUT */
    .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px; }
    @media(max-width: 900px) { .container { grid-template-columns: 1fr; } }

    /* CARDS */
    .card { background: #fff; border-radius: 16px; padding: 25px; border: 1px solid var(--ring); box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; }
    h2 { font-size: 18px; font-weight: 800; margin: 0 0 20px; color: var(--primary); border-bottom: 1px solid var(--ring); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

    /* FORMS */
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; font-size: 13px; font-weight: 600; color: #4b5563; margin-bottom: 6px; }
    .input-wrapper { display: flex; align-items: center; position: relative; }
    .input-wrapper input { width: 100%; padding: 10px 10px 10px 30px; border: 1px solid var(--ring); border-radius: 8px; font-weight: 600; color: #334155; }
    .input-wrapper span { position: absolute; left: 10px; color: #94a3b8; font-weight: 700; font-size: 14px; }
    .input-wrapper input:focus { outline: 2px solid var(--primary); border-color: transparent; }

    /* COSTS LIST */
    .cost-list { max-height: 300px; overflow-y: auto; }
    .cost-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed #e2e8f0; }
    .cost-item:last-child { border-bottom: none; }
    .cost-name { font-size: 14px; font-weight: 600; color: #334155; }
    .cost-val { font-weight: 700; color: var(--danger); font-size: 14px; margin-right: 10px; }
    .del-btn { color: #cbd5e1; cursor: pointer; transition: 0.2s; font-size: 18px; }
    .del-btn:hover { color: var(--danger); }

    /* ADD COST FORM */
    .add-cost-form { display: flex; gap: 10px; margin-bottom: 15px; background: #f8fafc; padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; }
    .add-cost-form input { border: 1px solid #cbd5e1; padding: 8px; border-radius: 6px; font-size: 13px; }
    .btn-add { background: var(--primary); color: #fff; border: none; border-radius: 6px; padding: 0 15px; cursor: pointer; font-weight: 700; }

    /* RESULTS */
    .result-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 15px; }
    .result-row.main { margin-top: 20px; padding-top: 15px; border-top: 2px solid #e2e8f0; font-size: 18px; font-weight: 800; color: #0f172a; }
    .result-label { color: #64748b; font-weight: 500; }
    .result-val { font-weight: 700; }
    .text-red { color: var(--danger); }
    .text-green { color: var(--success); }

    /* DATE PICKER */
    .date-filter { display: flex; align-items: center; gap: 10px; background: #f1f5f9; padding: 5px 10px; border-radius: 8px; }
    .date-filter input { border: none; background: transparent; font-weight: 700; color: var(--primary); cursor: pointer; outline: none; }

  </style>
</head>
<body>

  <header>
    <div class="topbar">
      <a class="brand" href="index.html">
        <img src="images/logo.png" style="width:32px; border-radius:6px;">
        Gerencia
      </a>
      <div style="display:flex; gap:10px">
        <a href="pedido_local.html" class="nav-btn">üì¶ Pedidos</a>
        <a href="finanzas.html" class="nav-btn">üìà Finanzas</a>
        <a href="#" class="nav-btn active">üìä Gerencia</a>
        <button onclick="location.href='login.html'" class="btn-danger">Salir</button>
      </div>
    </div>
  </header>

  <div class="container">
    
    <aside>
        
        <div class="card">
            <h2>
                1. Costos Variables
                <div class="date-filter">
                    <input type="month" id="monthPicker">
                </div>
            </h2>
            <p style="font-size:13px; color:#64748b; margin-bottom:20px">Defin√≠ los porcentajes sobre la venta.</p>

            <div class="input-group">
                <label>ü•© Materia Prima & Producci√≥n (%)</label>
                <div class="input-wrapper">
                    <input type="number" id="inpMatPrima" value="40" oninput="calculate()">
                    <span>%</span>
                </div>
            </div>

            <div class="input-group">
                <label>üõµ Comisi√≥n PedidosYa (%)</label>
                <div class="input-wrapper">
                    <input type="number" id="inpPy" value="30" oninput="calculate()">
                    <span>%</span>
                </div>
            </div>

            <div class="input-group">
                <label>ü•° Packaging (Costo por pedido $)</label>
                <div class="input-wrapper">
                    <input type="number" id="inpPack" value="400" oninput="calculate()">
                    <span>$</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>2. Costos Fijos (Mensual)</h2>
            
            <div class="add-cost-form">
                <input type="text" id="newFixedName" placeholder="Ej: Alquiler" style="flex:2">
                <input type="number" id="newFixedVal" placeholder="$ Monto" style="flex:1">
                <button class="btn-add" onclick="addFixed()">+</button>
            </div>

            <div id="fixedList" class="cost-list">
                </div>
            
            <div style="margin-top:15px; text-align:right; font-weight:700; color:#475569">
                Total Fijos: <span id="totalFixedDisplay">$ 0</span>
            </div>
        </div>

    </aside>

    <main>
        
        <div class="card">
            <h2>Resultados del Mes</h2>
            
            <div style="background:#f8fafc; border-radius:12px; padding:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:12px; text-transform:uppercase; color:#64748b; font-weight:700">Ventas Totales (Brutas)</div>
                    <div style="font-size:24px; font-weight:800; color:#334155" id="valSales">$ 0</div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:12px; text-transform:uppercase; color:#64748b; font-weight:700">Pedidos Totales</div>
                    <div style="font-size:24px; font-weight:800; color:#334155" id="valOrders">0</div>
                </div>
            </div>

            <div class="result-row">
                <span class="result-label">(-) Costo Mercader√≠a</span>
                <span class="result-val text-red" id="resMP">$ 0</span>
            </div>
            <div class="result-row">
                <span class="result-label">(-) Comisi√≥n PedidosYa (Sobre ventas PY)</span>
                <span class="result-val text-red" id="resPy">$ 0</span>
            </div>
            <div class="result-row">
                <span class="result-label">(-) Packaging</span>
                <span class="result-val text-red" id="resPack">$ 0</span>
            </div>
            <div class="result-row">
                <span class="result-label">(-) Gastos Fijos (Alquiler, Luz...)</span>
                <span class="result-val text-red" id="resFixed">$ 0</span>
            </div>

            <div class="result-row main">
                <span>GANANCIA NETA (Bolsillo)</span>
                <span class="text-green" id="resProfit" style="font-size:28px">$ 0</span>
            </div>
            <div style="text-align:right; font-size:13px; font-weight:600; color:#64748b; margin-top:5px;">
                Margen Real: <span id="resMargin">0%</span>
            </div>
        </div>

        <div class="card">
            <h2>Distribuci√≥n de Dinero</h2>
            <div style="height:300px; position:relative">
                <canvas id="profitChart"></canvas>
            </div>
        </div>

    </main>

  </div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // 1. CONFIG
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.getElementById(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});

    // 2. STATE
    let ORDERS = [];
    let FIXED_COSTS = JSON.parse(localStorage.getItem('rb_fixed_costs') || '[]');
    let chartInstance = null;

    // 3. INIT
    window.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        const ym = now.toISOString().slice(0,7);
        $('monthPicker').value = ym;
        
        $('monthPicker').addEventListener('change', loadOrders);
        
        renderFixedList();
        loadOrders();
    });

    // 4. CARGAR PEDIDOS
    function loadOrders() {
        const ym = $('monthPicker').value;
        if(!ym) return;
        const [y, m] = ym.split('-').map(Number);
        const start = new Date(y, m-1, 1).toISOString();
        const end = new Date(y, m, 1).toISOString(); // Primer d√≠a mes siguiente

        db.collection('orders')
          .where('createdAt', '>=', start)
          .where('createdAt', '<', end)
          .get().then(snap => {
              ORDERS = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled');
              calculate();
          });
    }

    // 5. C√ÅLCULO CENTRAL
    function calculate() {
        // A. Ventas
        let totalSales = 0;
        let pySales = 0;
        let totalOrders = ORDERS.length;

        ORDERS.forEach(o => {
            const val = Number(o.total || 0);
            totalSales += val;
            if(o.source === 'pedidosya') pySales += val;
        });

        // B. Costos Variables (Inputs)
        const percMP = Number($('inpMatPrima').value) || 0;
        const percPY = Number($('inpPy').value) || 0;
        const costPackUnit = Number($('inpPack').value) || 0;

        const costMP = totalSales * (percMP / 100);
        const costPY = pySales * (percPY / 100);
        const costPack = totalOrders * costPackUnit;

        // C. Costos Fijos (Lista Manual)
        const costFixed = FIXED_COSTS.reduce((sum, item) => sum + item.amount, 0);

        // D. Resultado
        const totalCosts = costMP + costPY + costPack + costFixed;
        const profit = totalSales - totalCosts;
        const margin = totalSales > 0 ? (profit / totalSales * 100) : 0;

        // E. Render
        $('valSales').innerText = money(totalSales);
        $('valOrders').innerText = totalOrders;

        $('resMP').innerText = '-' + money(costMP);
        $('resPy').innerText = '-' + money(costPY);
        $('resPack').innerText = '-' + money(costPack);
        $('resFixed').innerText = '-' + money(costFixed);

        $('resProfit').innerText = money(profit);
        $('resProfit').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
        $('resMargin').innerText = margin.toFixed(1) + '%';

        updateChart(profit, costMP, costPY, costPack, costFixed);
    }

    // 6. GESTI√ìN COSTOS FIJOS
    window.addFixed = () => {
        const name = $('newFixedName').value.trim();
        const val = Number($('newFixedVal').value);
        if(!name || val <= 0) return alert("Ingres√° nombre y monto");

        FIXED_COSTS.push({ id: Date.now(), name, amount: val });
        saveFixed();
        $('newFixedName').value = '';
        $('newFixedVal').value = '';
    };

    window.removeFixed = (id) => {
        FIXED_COSTS = FIXED_COSTS.filter(x => x.id !== id);
        saveFixed();
    };

    function saveFixed() {
        localStorage.setItem('rb_fixed_costs', JSON.stringify(FIXED_COSTS));
        renderFixedList();
        calculate();
    }

    function renderFixedList() {
        const list = $('fixedList');
        list.innerHTML = '';
        let total = 0;
        FIXED_COSTS.forEach(item => {
            total += item.amount;
            list.innerHTML += `
                <div class="cost-item">
                    <span class="cost-name">${item.name}</span>
                    <div style="display:flex; align-items:center">
                        <span class="cost-val">-${money(item.amount)}</span>
                        <span class="del-btn" onclick="removeFixed(${item.id})">√ó</span>
                    </div>
                </div>
            `;
        });
        $('totalFixedDisplay').innerText = money(total);
    }

    // 7. GR√ÅFICO
    function updateChart(profit, mp, py, pack, fixed) {
        const ctx = $('profitChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Tu Ganancia', 'Materia Prima', 'Comisi√≥n Py', 'Packaging', 'Fijos'],
                datasets: [{
                    data: [Math.max(0, profit), mp, py, pack, fixed],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#6366f1'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });
    }

  </script>
</body>
</html>
