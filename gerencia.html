<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; 
      --text: #1f2937; 
      --bg: #f3f4f6; 
      --card: #ffffff;
      --ring: #e5e7eb;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 40px; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--ring); position: sticky; top: 0; z-index: 100; }
    .topbar { max-width: 1400px; margin: 0 auto; height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-btn { padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #4b5563; font-weight: 600; font-size: 14px; transition: 0.2s; }
    .nav-btn:hover { background: #f9fafb; }
    .nav-btn.active { background: var(--primary); color: #fff; }
    .btn-danger { color: #d32f2f; background: #ffebee; border: 1px solid #ffcdd2; padding: 8px 12px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; }

    /* LAYOUT */
    .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

    /* UPLOAD ZONE */
    .upload-box {
      background: #fff; border: 2px dashed #cbd5e1; border-radius: 16px; padding: 30px; text-align: center;
      cursor: pointer; transition: all 0.2s; margin-bottom: 30px;
    }
    .upload-box:hover { border-color: var(--primary); background: #fdfdfc; }
    .upload-title { font-size: 18px; font-weight: 700; color: var(--primary); margin-bottom: 5px; }
    
    /* DASHBOARD GRID */
    .dashboard { display: none; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
    .kpi-card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--ring); box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
    .kpi-title { font-size: 12px; text-transform: uppercase; color: #64748b; font-weight: 700; margin-bottom: 5px; }
    .kpi-val { font-size: 24px; font-weight: 800; color: #0f172a; }
    .kpi-sub { font-size: 12px; margin-top: 5px; font-weight: 500; }
    
    .col-span-2 { grid-column: span 2; }
    @media(max-width: 1000px) { .dashboard { grid-template-columns: 1fr 1fr; } .col-span-2 { grid-column: span 2; } }
    @media(max-width: 600px) { .dashboard { grid-template-columns: 1fr; } .col-span-2 { grid-column: span 1; } }

    /* CHARTS & TABLES */
    .section-grid { display: none; grid-template-columns: 1fr 1fr; gap: 20px; }
    .panel { background: #fff; border-radius: 16px; padding: 20px; border: 1px solid var(--ring); margin-bottom: 20px; }
    .panel h3 { margin: 0 0 15px; font-size: 16px; color: #334155; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px; background: #f8fafc; color: #475569; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
    td { padding: 10px; border-bottom: 1px solid #f1f5f9; color: #334155; }
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    
    /* BADGES */
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    .bg-green { background: #dcfce7; color: #166534; }
    .bg-red { background: #fee2e2; color: #991b1b; }
    
    /* FINANCIAL BREAKDOWN */
    .breakdown-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e2e8f0; font-size: 14px; }
    .breakdown-row.total { border-top: 2px solid #cbd5e1; border-bottom: none; font-weight: 800; font-size: 16px; margin-top: 10px; padding-top: 10px; }
    .text-red { color: var(--danger); }
    .text-green { color: var(--success); }

  </style>
</head>
<body>

  <header>
    <div class="topbar">
      <a class="brand" href="index.html">
        <img src="images/logo.png" style="width:32px; border-radius:6px;">
        Gerencia
      </a>
      <div style="display:flex; gap:10px">
        <a href="pedido_local.html" class="nav-btn">üì¶ Pedidos</a>
        <a href="finanzas.html" class="nav-btn">üìà Finanzas</a>
        <a href="#" class="nav-btn active">üìä Reportes</a>
        <button onclick="location.href='login.html'" class="btn-danger">Salir</button>
      </div>
    </div>
  </header>

  <div class="container">
    
    <div class="upload-box" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <div class="upload-title">üìÇ Subir Reporte de PedidosYa</div>
        <p style="margin:0; color:#64748b; font-size:14px;">Hac√© click o arrastr√° el archivo Excel / CSV aqu√≠.</p>
        <input type="file" id="fileInput" style="display:none" accept=".xlsx, .xls, .csv">
    </div>

    <div id="mainContent">
        <div class="dashboard">
            <div class="kpi-card">
                <div class="kpi-title">Venta Bruta Total</div>
                <div class="kpi-val" id="kpiGross">$ 0</div>
                <div class="kpi-sub text-muted" id="kpiOrders">0 pedidos</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Comisiones + Impuestos</div>
                <div class="kpi-val text-red" id="kpiFees">$ 0</div>
                <div class="kpi-sub text-red" id="kpiFeesPerc">0% de la venta</div>
            </div>
            <div class="kpi-card bg-green">
                <div class="kpi-title">Ingreso Neto Real</div>
                <div class="kpi-val text-green" id="kpiNet">$ 0</div>
                <div class="kpi-sub text-green">Lo que te queda</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-title">Ticket Promedio</div>
                <div class="kpi-val" id="kpiAvg">$ 0</div>
                <div class="kpi-sub text-muted">Por pedido</div>
            </div>
        </div>

        <div class="section-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            
            <div class="panel">
                <h3>üí∞ Cascada de Rentabilidad</h3>
                <div style="height: 200px; position:relative; margin-bottom:20px;">
                    <canvas id="moneyChart"></canvas>
                </div>
                
                <div id="financialDetails">
                    </div>
            </div>

            <div class="panel">
                <h3>‚öñÔ∏è Conciliaci√≥n de Cobros</h3>
                <p style="font-size:13px; color:#666; margin-bottom:15px">
                    Esto separa el dinero que <b>ya ten√©s</b> (efectivo) del que la App <b>te debe depositar</b>.
                </p>
                
                <div class="breakdown-row">
                    <span>üíµ Cobrado en Efectivo (Local)</span>
                    <strong class="text-green" id="cashCollected">$ 0</strong>
                </div>
                <div class="breakdown-row">
                    <span>üí≥ Cobrado Online (App)</span>
                    <strong id="onlineCollected">$ 0</strong>
                </div>
                <div class="breakdown-row">
                    <span>üìâ Descuentos/Comisiones App</span>
                    <strong class="text-red" id="appDeductions">$ 0</strong>
                </div>
                <div class="breakdown-row total" style="color:#0f172a">
                    <span>üè¶ A Depositar por PedidosYa</span>
                    <strong id="toDeposit">$ 0</strong>
                </div>
            </div>

        </div>

        <div class="panel" style="margin-top:20px;">
            <h3>üçî Ranking de Productos Vendidos</h3>
            <div class="table-responsive">
                <table id="productsTable">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th class="num">Cantidad</th>
                            <th class="num">% del Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div> </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});
    let moneyChartInstance = null;

    // Drag & Drop
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--primary)'; dropZone.style.background = '#f0fdf4'; });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#cbd5e1'; dropZone.style.background = '#fff'; });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#cbd5e1'; dropZone.style.background = '#fff';
        if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', (e) => {
        if(e.target.files.length) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, {defval:""});
            
            if(rows.length > 0) {
                processReport(rows);
            } else {
                alert("El archivo parece estar vac√≠o.");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function processReport(rows) {
        // --- 1. VARIABLES DE ACUMULACI√ìN ---
        let totalGross = 0;
        let totalCommission = 0;
        let totalTaxes = 0; // Cargo impositivo
        let totalFees = 0;  // Tarifa de pago + Cargos
        let totalDiscounts = 0; // Descuentos tienda
        let totalNet = 0; // Ingreso estimado
        
        let cashSales = 0; // Efectivo
        let onlineSales = 0; // Online

        let countOrders = 0;
        let productCounts = {};

        // --- 2. ITERAR FILAS ---
        rows.forEach(row => {
            const r = {};
            Object.keys(row).forEach(k => r[k.toLowerCase().trim()] = row[k]);

            // Normalizar Valores Num√©ricos (Excel a veces trae strings "1.500,00")
            const getVal = (key) => {
                let v = r[key] || 0;
                if(typeof v === 'number') return v;
                return Number(String(v).replace(/\./g,'').replace(',','.'));
            };

            // Columnas clave del CSV de PedidosYa
            const gross = getVal('total del pedido') || getVal('total');
            const comm = getVal('comisi√≥n') || getVal('comision');
            const tax = getVal('cargo impositivo') || getVal('impuestos');
            const payFee = getVal('tarifa de pago') || 0;
            const otherCharges = getVal('cargos') || 0;
            const shopDisc = getVal('descuentos subsidiados por la tienda') || 0;
            const voucherShop = getVal('voucher subsidiado por la tienda') || 0;
            
            // Ingreso Neto (lo que paga Py)
            const net = getVal('ingreso estimado') || getVal('monto de pago');

            // M√©todo Pago
            const payment = (r['forma de pago'] || '').toLowerCase();
            
            if(gross > 0) {
                countOrders++;
                totalGross += gross;
                totalCommission += comm;
                totalTaxes += tax;
                totalFees += (payFee + otherCharges);
                totalDiscounts += (shopDisc + voucherShop);
                totalNet += net;

                // Conciliaci√≥n
                if(payment.includes('efectivo')) {
                    cashSales += gross;
                } else {
                    onlineSales += gross;
                }

                // Parsear Productos
                const itemsStr = r['art√≠culos'] || r['articulos'] || '';
                if(itemsStr) {
                    // Split inteligente (por coma, ignorando corchetes de notas)
                    const parts = itemsStr.split(/,(?![^\[]*\])/); 
                    parts.forEach(p => {
                        p = p.trim();
                        // "2x Burger" o "Burger"
                        const match = p.match(/^(\d+)\s*[xX]?\s+(.*)$/);
                        let qty = 1;
                        let name = p;
                        if(match) {
                            qty = Number(match[1]);
                            name = match[2];
                        }
                        // Limpiar notas [sin cebolla]
                        name = name.replace(/\[.*?\]/g, "").trim();
                        
                        if(productCounts[name]) productCounts[name] += qty;
                        else productCounts[name] = qty;
                    });
                }
            }
        });

        const totalDeductions = totalCommission + totalTaxes + totalFees + totalDiscounts;
        const depositExpected = onlineSales - totalDeductions; // Aprox lo que Py deposita

        // --- 3. RENDERIZAR DASHBOARD ---
        
        // Mostrar Grid
        document.querySelector('.dashboard').style.display = 'grid';
        document.querySelector('.section-grid').style.display = 'grid';
        document.getElementById('dropZone').style.display = 'none'; // Ocultar carga

        // KPIs
        document.getElementById('kpiGross').innerText = money(totalGross);
        document.getElementById('kpiOrders').innerText = `${countOrders} pedidos`;
        
        document.getElementById('kpiFees').innerText = '-' + money(totalDeductions);
        const feePerc = totalGross > 0 ? ((totalDeductions / totalGross)*100).toFixed(1) : 0;
        document.getElementById('kpiFeesPerc').innerText = `${feePerc}% de la venta`;

        // El Ingreso Neto calculado por f√≥rmula (o columna Ingreso Estimado)
        // Usamos la columna "Ingreso Estimado" si existe confiable, sino c√°lculo
        const finalNet = totalGross - totalDeductions;
        document.getElementById('kpiNet').innerText = money(finalNet);

        const avgTicket = countOrders > 0 ? totalGross / countOrders : 0;
        document.getElementById('kpiAvg').innerText = money(avgTicket);

        // --- 4. RENDER TABLA FINANCIERA ---
        const finHTML = `
            <div class="breakdown-row"><span>Ingresos Brutos</span><strong>${money(totalGross)}</strong></div>
            <div class="breakdown-row"><span class="text-red">(-) Comisi√≥n PedidosYa</span><span class="text-red">-${money(totalCommission)}</span></div>
            <div class="breakdown-row"><span class="text-red">(-) Impuestos (IIBB/IVA)</span><span class="text-red">-${money(totalTaxes)}</span></div>
            <div class="breakdown-row"><span class="text-red">(-) Tarifas de Pago/Cargos</span><span class="text-red">-${money(totalFees)}</span></div>
            ${totalDiscounts > 0 ? `<div class="breakdown-row"><span class="text-red">(-) Descuentos Tienda</span><span class="text-red">-${money(totalDiscounts)}</span></div>` : ''}
            <div class="breakdown-row total"><span>= Ingreso Neto</span><span class="text-green">${money(finalNet)}</span></div>
        `;
        document.getElementById('financialDetails').innerHTML = finHTML;

        // --- 5. RENDER CONCILIACI√ìN ---
        document.getElementById('cashCollected').innerText = money(cashSales);
        document.getElementById('onlineCollected').innerText = money(onlineSales);
        document.getElementById('appDeductions').innerText = '-' + money(totalDeductions);
        
        // Lo que deposita Py es (Ventas Online - Todas las Deducciones)
        // NOTA: Py a veces descuenta comisiones de pedidos en efectivo del saldo online.
        // Por ende, la f√≥rmula suele ser: (Neto Total) - (Efectivo que ya ten√©s).
        const depositReal = finalNet - cashSales;
        document.getElementById('toDeposit').innerText = money(depositReal);

        // --- 6. RENDER GR√ÅFICO TORTA ---
        const ctx = document.getElementById('moneyChart').getContext('2d');
        if(moneyChartInstance) moneyChartInstance.destroy();
        moneyChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Tu Ganancia', 'Comisiones', 'Impuestos/Cargos'],
                datasets: [{
                    data: [finalNet, totalCommission, (totalTaxes + totalFees + totalDiscounts)],
                    backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right' } }
            }
        });

        // --- 7. RENDER RANKING PRODUCTOS ---
        const sortedProducts = Object.entries(productCounts)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 10); // Top 10

        const prodTable = document.getElementById('productsTable').querySelector('tbody');
        prodTable.innerHTML = sortedProducts.map(([name, qty]) => {
            // Calcular % relativo al total de items (no pedidos)
            const totalItems = Object.values(productCounts).reduce((a,b)=>a+b,0);
            const perc = ((qty/totalItems)*100).toFixed(1);
            return `<tr>
                <td style="font-weight:600">${name}</td>
                <td class="num">${qty}</td>
                <td class="num">${perc}%</td>
            </tr>`;
        }).join('');
    }
  </script>
</body>
</html>
