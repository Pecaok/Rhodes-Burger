<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; 
      --bg: #f1f5f9; 
      --card: #ffffff;
      --text: #0f172a;
      --border: #e2e8f0;
      --green: #10b981; --red: #ef4444; --blue: #3b82f6;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; z-index: 10; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; gap:10px; align-items: center; text-decoration: none; }
    .nav-btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 13px; }
    .nav-btn:hover { background: #f8fafc; color: var(--text); }
    .nav-btn.active { background: var(--primary); color: #fff; }

    /* LAYOUT PRINCIPAL */
    .layout { display: flex; flex: 1; overflow: hidden; }
    
    /* SIDEBAR */
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; }
    .tab-btn { 
        padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; 
        border-left: 3px solid transparent; display: flex; justify-content: space-between;
    }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: #f0fdf4; color: var(--primary); border-left-color: var(--primary); }

    /* CONTENT AREA */
    .content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
    
    /* CARDS */
    .card { background: #fff; border-radius: 8px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    h2 { margin: 0 0 15px; font-size: 15px; font-weight: 700; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

    /* TABLES */
    .sheet-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .sheet-table th { background: #f8fafc; text-align: left; padding: 8px 12px; border: 1px solid #e2e8f0; font-weight: 700; color: #475569; }
    .sheet-table td { border: 1px solid #e2e8f0; padding: 0; }
    .sheet-table input { width: 100%; border: none; padding: 8px 12px; font-family: inherit; font-size: 13px; outline: none; background: transparent; }
    .sheet-table input:focus { background: #f0f9ff; box-shadow: inset 0 0 0 2px var(--blue); }
    
    /* DASHBOARD LAYOUT (FIXED CHART) */
    .dashboard-grid { 
        display: grid; 
        grid-template-columns: 2fr 1fr; 
        grid-template-rows: auto 1fr; 
        gap: 20px; 
        height: 100%; 
    }
    
    .kpi-row { grid-column: span 2; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
    
    .chart-container { 
        background: #fff; border-radius: 8px; border: 1px solid var(--border); padding: 20px; 
        height: 350px; /* ALTURA FIJA PARA QUE NO SE VAYA */
        position: relative;
    }
    
    .stats-container {
        background: #fff; border-radius: 8px; border: 1px solid var(--border); padding: 20px;
        height: 350px; overflow-y: auto; /* SCROLL SOLO AQUI */
    }

    .kpi { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
    .kpi-lbl { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .kpi-val { font-size: 22px; font-weight: 900; color: #0f172a; margin-top: 5px; }
    
    /* UTILS */
    .text-red { color: var(--red); }
    .text-green { color: var(--green); }
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    input[type=month] { padding: 6px; border: 1px solid var(--border); border-radius: 6px; font-weight: 600; }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; font-size: 13px; }
    .btn-save { background: var(--primary); color: white; }
    .btn-calc { background: var(--blue); color: white; }

    @media(max-width: 1000px) {
        .dashboard-grid { grid-template-columns: 1fr; grid-template-rows: auto auto auto; }
        .kpi-row { grid-column: span 1; grid-template-columns: 1fr 1fr; }
        .chart-container, .stats-container { height: auto; min-height: 300px; }
    }
  </style>
</head>
<body>

<header>
  <a href="#" class="brand"><img src="images/logo.png" width="30"> Gerencia Rhodes</a>
  <div>
    <a href="pedido_local.html" class="nav-btn">Pedidos</a>
    <a href="#" class="nav-btn active">Gerencia</a>
    <button onclick="location.href='login.html'" class="nav-btn" style="color:var(--red)">Salir</button>
  </div>
</header>

<div class="layout">
  
  <aside class="sidebar">
    <div class="tab-btn active" onclick="showTab('dashboard')">üìä Rendimiento</div>
    <div class="tab-btn" onclick="showTab('materia')">ü•© Materia Prima</div>
    <div class="tab-btn" onclick="showTab('packaging')">ü•° Packaging</div>
    <div class="tab-btn" onclick="showTab('fixed')">üí° Costos Fijos</div>
    <div class="tab-btn" onclick="showTab('production')">üë®‚Äçüç≥ Sueldos</div>
  </aside>

  <main class="content">

    <div id="tab-dashboard" style="height: 100%;">
      
      <div class="controls">
        <h2 style="border:none; margin:0">Tablero de Comando</h2>
        <div style="display:flex; gap:10px; align-items:center">
            <input type="month" id="monthPicker">
            <button class="btn btn-calc" onclick="calculateAll()">üîÑ Recalcular</button>
        </div>
      </div>

      <div class="dashboard-grid">
        
        <div class="kpi-row">
            <div class="kpi">
                <div class="kpi-lbl">Ventas Brutas</div>
                <div class="kpi-val" id="kpiSales">$ 0</div>
            </div>
            <div class="kpi">
                <div class="kpi-lbl">Costos (CMV + Pack)</div>
                <div class="kpi-val text-red" id="kpiCmv">$ 0</div>
            </div>
            <div class="kpi">
                <div class="kpi-lbl">Gastos Fijos + Sueldos</div>
                <div class="kpi-val text-red" id="kpiFixed">$ 0</div>
            </div>
            <div class="kpi" style="background: #f0fdf4; border-color: #bbf7d0;">
                <div class="kpi-lbl text-green">Ganancia Neta</div>
                <div class="kpi-val text-green" id="kpiProfit">$ 0</div>
            </div>
        </div>

        <div class="chart-container">
            <h2 style="margin-top:0">Flujo de Caja</h2>
            <div style="position: relative; height: 260px; width: 100%;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="stats-container">
            <h2 style="margin-top:0">Rentabilidad por Item</h2>
            <div id="burgerStats" style="font-size:13px; color:#555">
                </div>
        </div>

      </div>
    </div>

    <div id="tab-materia" style="display:none">
      <div class="controls">
        <h2>Costos de Insumos</h2>
        <button class="btn btn-save" onclick="saveData()">üíæ Guardar</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableMateria">
            <thead><tr><th>Insumo</th><th width="100">Unidad</th><th width="150">Costo ($)</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn" style="margin-top:10px; background:#e2e8f0" onclick="addRow('tableMateria')">+ Insumo</button>
      </div>
    </div>

    <div id="tab-packaging" style="display:none">
      <div class="controls">
        <h2>Costos de Packaging</h2>
        <button class="btn btn-save" onclick="saveData()">üíæ Guardar</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tablePack">
            <thead><tr><th>Item</th><th width="150">Costo Unitario ($)</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn" style="margin-top:10px; background:#e2e8f0" onclick="addRow('tablePack')">+ Item</button>
      </div>
    </div>

    <div id="tab-fixed" style="display:none">
      <div class="controls">
        <h2>Gastos Fijos Mensuales</h2>
        <button class="btn btn-save" onclick="saveData()">üíæ Guardar</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableFixed">
            <thead><tr><th>Concepto</th><th width="150">Monto Mensual ($)</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn" style="margin-top:10px; background:#e2e8f0" onclick="addRow('tableFixed')">+ Gasto</button>
      </div>
    </div>

    <div id="tab-production" style="display:none">
      <div class="controls">
        <h2>Sueldos y Producci√≥n</h2>
        <button class="btn btn-save" onclick="saveData()">üíæ Guardar</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableProd">
            <thead><tr><th>Empleado / Concepto</th><th width="150">Total ($)</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn" style="margin-top:10px; background:#e2e8f0" onclick="addRow('tableProd')">+ Agregar</button>
      </div>
    </div>

  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // --- FIREBASE ---
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});

    // --- DATA INICIAL (Persistente) ---
    const DEFAULT_DATA = {
        materia: [
            {name: 'Carne (kg)', unit: 'kg', cost: 16200},
            {name: 'Pan Brioche (u)', unit: 'u', cost: 650},
            {name: 'Cheddar (feta)', unit: 'u', cost: 187},
            {name: 'Papas (kg)', unit: 'kg', cost: 1200},
            {name: 'Bacon (kg)', unit: 'kg', cost: 13920}
        ],
        pack: [
            {name: 'Caja Hamburguesa', cost: 150},
            {name: 'Bolsa Papel', cost: 60},
            {name: 'Papel Parafinado', cost: 40}
        ],
        fixed: [
            {name: 'Electricidad', cost: 140000},
            {name: 'Gas', cost: 40000},
            {name: 'Monotributo', cost: 42216},
            {name: 'Publicidad', cost: 40000}
        ],
        prod: [
            {name: 'Sueldos Totales', cost: 2631557},
            {name: 'Aguinaldos', cost: 219296}
        ]
    };

    let DATA = JSON.parse(localStorage.getItem('rhodes_excel_data')) || DEFAULT_DATA;
    let ORDERS = [];
    let chartInstance = null;

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        $('#monthPicker').value = now.toISOString().slice(0,7);
        $('#monthPicker').addEventListener('change', fetchOrders);

        renderTables();
        fetchOrders();
    });

    // --- TABLAS ---
    function renderTables() {
        renderTable('tableMateria', DATA.materia, ['name', 'unit', 'cost']);
        renderTable('tablePack', DATA.pack, ['name', 'cost']);
        renderTable('tableFixed', DATA.fixed, ['name', 'cost']);
        renderTable('tableProd', DATA.prod, ['name', 'cost']);
    }

    function renderTable(id, dataArr, fields) {
        const tbody = document.getElementById(id).querySelector('tbody');
        tbody.innerHTML = '';
        dataArr.forEach((row, idx) => {
            let tr = document.createElement('tr');
            fields.forEach(key => {
                let td = document.createElement('td');
                let input = document.createElement('input');
                input.value = row[key];
                if(key === 'cost') { 
                    input.type = 'number'; 
                    input.style.textAlign = 'right'; 
                    input.style.fontWeight = 'bold';
                }
                input.onchange = (e) => {
                    row[key] = key === 'cost' ? Number(e.target.value) : e.target.value;
                };
                td.appendChild(input);
                tr.appendChild(td);
            });
            // Delete btn
            let tdX = document.createElement('td');
            tdX.innerHTML = `<button style="background:none; border:none; color:#cbd5e1; cursor:pointer;" onclick="deleteRow('${id}', ${idx})">√ó</button>`;
            tr.appendChild(tdX);
            tbody.appendChild(tr);
        });
    }

    window.addRow = (tableId) => {
        let arrName = '';
        if(tableId === 'tableMateria') arrName = 'materia';
        if(tableId === 'tablePack') arrName = 'pack';
        if(tableId === 'tableFixed') arrName = 'fixed';
        if(tableId === 'tableProd') arrName = 'prod';
        
        DATA[arrName].push({name: '', cost: 0, unit: ''});
        renderTables();
    };

    window.deleteRow = (tableId, idx) => {
        let arrName = '';
        if(tableId === 'tableMateria') arrName = 'materia';
        if(tableId === 'tablePack') arrName = 'pack';
        if(tableId === 'tableFixed') arrName = 'fixed';
        if(tableId === 'tableProd') arrName = 'prod';
        
        DATA[arrName].splice(idx, 1);
        renderTables();
    };

    window.saveData = () => {
        localStorage.setItem('rhodes_excel_data', JSON.stringify(DATA));
        calculateAll();
    };

    // --- C√ÅLCULO CENTRAL ---
    function fetchOrders() {
        const ym = $('#monthPicker').value;
        if(!ym) return;
        const [y, m] = ym.split('-').map(Number);
        const start = new Date(y, m-1, 1).toISOString();
        const end = new Date(y, m, 1).toISOString();

        db.collection('orders')
          .where('createdAt', '>=', start)
          .where('createdAt', '<', end)
          .get().then(snap => {
              ORDERS = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled');
              calculateAll();
          });
    }

    function calculateAll() {
        // 1. Costos Fijos Totales
        const totalFixed = DATA.fixed.reduce((s, i) => s + i.cost, 0) + 
                           DATA.prod.reduce((s, i) => s + i.cost, 0);

        // 2. Precios Unitarios (Lookup)
        const findCost = (k) => (DATA.materia.find(i => i.name.toLowerCase().includes(k))?.cost || 0);
        const meatP = findCost('carne');
        const panP = findCost('pan');
        const chedP = findCost('cheddar');
        const baconP = findCost('bacon');
        const papasP = findCost('papas');
        
        const packAvg = DATA.pack.reduce((s, i) => s + i.cost, 0);

        // 3. Iterar Ventas
        let grossSales = 0;
        let totalCMV = 0; 
        let totalPack = 0;
        let totalCommissions = 0;
        let stats = {};

        ORDERS.forEach(o => {
            const sale = Number(o.total || 0);
            grossSales += sale;
            if(o.source === 'pedidosya') totalCommissions += (sale * 0.30);
            totalPack += packAvg;

            (o.items || []).forEach(item => {
                const name = (item.name || '').toLowerCase();
                const qty = Number(item.qty || 1);
                let itemCost = 0;
                
                // Receta Aproximada
                if(name.includes('burger') || name.includes('hamburguesa') || name.includes('doble') || name.includes('simple')) {
                    const patties = name.includes('doble') ? 2 : (name.includes('triple') ? 3 : 1);
                    itemCost = (0.12 * patties * meatP) + (2 * patties * chedP) + panP;
                    if(name.includes('bacon')) itemCost += (0.03 * baconP);
                }
                // Papas
                if(name.includes('papas') || (item.type === 'side')) itemCost += (0.2 * papasP);

                const margin = sale > 0 ? (sale - itemCost) : 0; // Margen bruto x item (aprox)
                totalCMV += (itemCost * qty);

                if(!stats[item.name]) stats[item.name] = {qty:0, profit:0};
                stats[item.name].qty += qty;
                stats[item.name].profit += margin; 
            });
        });

        // 4. Totales
        const totalExpenses = totalFixed + totalCMV + totalPack + totalCommissions;
        const profit = grossSales - totalExpenses;

        // 5. Render
        $('#kpiSales').innerText = money(grossSales);
        $('#kpiCmv').innerText = '-' + money(totalCMV);
        $('#kpiFixed').innerText = '-' + money(totalFixed + totalPack + totalCommissions);
        $('#kpiProfit').innerText = money(profit);

        renderChart(grossSales, totalFixed, totalCMV, totalCommissions, profit);
        
        // Ranking Rentabilidad
        const sorted = Object.entries(stats).sort((a,b) => b[1].qty - a[1].qty).slice(0, 6);
        $('#burgerStats').innerHTML = sorted.map(([k,v]) => `
            <div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px dashed #eee;">
                <span>${k}</span>
                <strong>${v.qty}u</strong>
            </div>`).join('');
    }

    // --- GR√ÅFICOS ---
    function renderChart(sales, fixed, cmv, comm, profit) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ingresos', 'Costos Fijos', 'Materia Prima', 'Comisiones', 'Ganancia'],
                datasets: [{
                    label: 'Flujo ($)',
                    data: [sales, fixed, cmv, comm, profit],
                    backgroundColor: ['#94a3b8', '#ef4444', '#f97316', '#eab308', '#10b981'],
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- NAVEGACI√ìN ---
    window.showTab = (tabName) => {
        document.querySelectorAll('div[id^="tab-"]').forEach(d => d.style.display = 'none');
        document.querySelector('#tab-' + tabName).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    };

</script>
</body>
</html>
