<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; 
      --bg: #f1f5f9; 
      --card: #ffffff;
      --text: #0f172a;
      --border: #e2e8f0;
      --green: #10b981; --red: #ef4444; --blue: #3b82f6; --orange: #f97316;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; gap:10px; align-items: center; text-decoration: none; }
    .nav-btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 13px; }
    .nav-btn:hover { background: #f8fafc; color: var(--text); }
    .nav-btn.active { background: var(--primary); color: #fff; }

    /* LAYOUT PRINCIPAL */
    .layout { display: flex; flex: 1; overflow: hidden; }
    
    /* SIDEBAR */
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; overflow-y: auto; }
    .tab-btn { 
        padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; 
        border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center;
    }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: #f0fdf4; color: var(--primary); border-left-color: var(--primary); }

    /* CONTENT */
    .content { flex: 1; padding: 30px; overflow-y: auto; }
    
    /* CARDS */
    .card { background: #fff; border-radius: 8px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    h2 { margin: 0 0 15px; font-size: 16px; font-weight: 700; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 10px; }

    /* TABLES */
    .sheet-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .sheet-table th { background: #f8fafc; text-align: left; padding: 8px 12px; border: 1px solid #e2e8f0; font-weight: 700; color: #475569; }
    .sheet-table td { border: 1px solid #e2e8f0; padding: 0; }
    .sheet-table input, .sheet-table select { width: 100%; border: none; padding: 8px 12px; font-family: inherit; font-size: 13px; outline: none; background: transparent; }
    .sheet-table input:focus { background: #f0f9ff; box-shadow: inset 0 0 0 2px var(--blue); }
    .sheet-table tr:hover td { background: #fafafa; }
    
    .recipe-row { cursor: pointer; }
    .recipe-row.selected { background: #eff6ff !important; }

    /* DASHBOARD */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .kpi { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
    .kpi-lbl { font-size: 12px; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .kpi-val { font-size: 24px; font-weight: 900; color: #0f172a; margin-top: 5px; }
    .text-red { color: var(--red); }
    .text-green { color: var(--green); }

    /* CONTROLS */
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .ctrl-group { display: flex; gap: 10px; align-items: center; }
    input[type=month], input[type=number].config-input { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-weight: 600; }
    input[type=number].config-input { width: 70px; text-align: right; border-color: var(--orange); background: #fff7ed; }
    .btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; font-size: 13px; transition: 0.2s; }
    .btn-save { background: var(--primary); color: white; }
    .btn-calc { background: var(--blue); color: white; }
    .btn-add { background: #e2e8f0; color: #334155; margin-top: 10px; }
    
    /* STATUS SAVE */
    #saveStatus { font-size: 12px; font-weight: 700; margin-right: 10px; display: none; }
    #saveStatus.saving { display: inline; color: #f59e0b; }
    #saveStatus.saved { display: inline; color: #10b981; }

  </style>
</head>
<body>

<header>
  <a href="#" class="brand"><img src="images/logo.png" width="30"> Gerencia Rhodes</a>
  <div>
    <span id="saveStatus">‚òÅÔ∏è Guardado</span>
    <a href="pedido_local.html" class="nav-btn">Pedidos</a>
    <a href="#" class="nav-btn active">Gerencia</a>
    <button onclick="location.href='login.html'" class="nav-btn" style="color:var(--red)">Salir</button>
  </div>
</header>

<div class="layout">
  
  <aside class="sidebar">
    <div class="tab-btn active" onclick="showTab('dashboard')">üìä Rendimiento</div>
    <div class="tab-btn" onclick="showTab('materia')">ü•© Materia Prima</div>
    <div class="tab-btn" onclick="showTab('packaging')">ü•° Costos Packaging</div>
    <div class="tab-btn" onclick="showTab('fixed')">üí° Costos Fijos</div>
    <div class="tab-btn" onclick="showTab('production')">üë®‚Äçüç≥ Sueldos</div>
    <div class="tab-btn" onclick="showTab('recipes')">üçî Costo Recetas</div>
  </aside>

  <main class="content">

    <div id="tab-dashboard">
      <div class="controls">
        <h2>Tablero de Comando</h2>
        <div class="ctrl-group">
            <div style="background: #fff7ed; padding: 5px 10px; border-radius: 6px; border: 1px solid var(--orange); display:flex; align-items:center; gap:5px;">
                <label style="font-size:12px; font-weight:700; color:#c2410c">Comisi√≥n Py:</label>
                <input type="number" id="confPy" value="30" class="config-input" onchange="saveConfigAndRecalc()">
                <span style="font-size:12px; font-weight:700; color:#c2410c">%</span>
            </div>
            <div style="width:1px; height:30px; background:#e2e8f0; margin:0 5px;"></div>
            <label style="font-size:13px; font-weight:600">Periodo:</label>
            <input type="month" id="monthPicker">
            <button class="btn btn-calc" onclick="calculateAll()">üîÑ Recalcular</button>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi">
            <div class="kpi-lbl">Ventas Brutas</div>
            <div class="kpi-val" id="kpiSales">$ 0</div>
        </div>
        <div class="kpi">
            <div class="kpi-lbl">Costos Variables (CMV)</div>
            <div class="kpi-val text-red" id="kpiCmv">$ 0</div>
        </div>
        <div class="kpi">
            <div class="kpi-lbl">Comisiones + Fijos</div>
            <div class="kpi-val text-red" id="kpiFixed">$ 0</div>
        </div>
        <div class="kpi" style="background: #f0fdf4; border-color: #bbf7d0;">
            <div class="kpi-lbl text-green">Ganancia Neta</div>
            <div class="kpi-val text-green" id="kpiProfit">$ 0</div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
        <div class="card">
            <h2>Evoluci√≥n Financiera</h2>
            <canvas id="mainChart" height="200"></canvas>
        </div>
        <div class="card">
            <h2>Rentabilidad por Item</h2>
            <div id="burgerStats" style="font-size:13px; color:#555"></div>
        </div>
      </div>
    </div>

    <div id="tab-materia" style="display:none">
      <div class="controls">
        <h2>Precios de Insumos</h2>
        <button class="btn btn-save" onclick="saveData(true)">üíæ Guardar Cambios</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableMateria">
            <thead><tr><th>Insumo</th><th width="100">Unidad</th><th width="150">Costo Unitario ($)</th><th width="50"></th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-add" onclick="addRow('tableMateria')">+ Agregar Insumo</button>
      </div>
    </div>

    <div id="tab-packaging" style="display:none">
      <div class="controls">
        <h2>Precios de Packaging</h2>
        <button class="btn btn-save" onclick="saveData(true)">üíæ Guardar Cambios</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tablePack">
            <thead><tr><th>Item</th><th width="150">Costo Unitario ($)</th><th width="50"></th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-add" onclick="addRow('tablePack')">+ Agregar Item</button>
      </div>
    </div>

    <div id="tab-fixed" style="display:none">
      <div class="controls">
        <h2>Gastos Fijos Mensuales</h2>
        <button class="btn btn-save" onclick="saveData(true)">üíæ Guardar Cambios</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableFixed">
            <thead><tr><th>Concepto</th><th width="150">Monto Mensual ($)</th><th width="50"></th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-add" onclick="addRow('tableFixed')">+ Agregar Gasto</button>
      </div>
    </div>

    <div id="tab-production" style="display:none">
      <div class="controls">
        <h2>Sueldos y Producci√≥n</h2>
        <button class="btn btn-save" onclick="saveData(true)">üíæ Guardar Cambios</button>
      </div>
      <div class="card">
        <table class="sheet-table" id="tableProd">
            <thead><tr><th>Empleado / Concepto</th><th width="150">Total a Pagar ($)</th><th width="50"></th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-add" onclick="addRow('tableProd')">+ Agregar</button>
      </div>
    </div>

    <div id="tab-recipes" style="display:none">
        <div class="controls">
            <h2>Calculadora de Costo por Hamburguesa</h2>
            <button class="btn btn-save" onclick="saveData(true)">üíæ Guardar Cambios</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
            <div class="card">
                <h3 style="margin-top:0; font-size:14px; color:#64748b">Productos Definidos</h3>
                <table class="sheet-table" id="tableRecipesList">
                    <thead><tr><th>Producto</th><th width="100" style="text-align:right">Costo</th><th width="40"></th></tr></thead>
                    <tbody></tbody>
                </table>
                <button class="btn btn-add" onclick="addNewRecipe()">+ Nuevo Producto</button>
            </div>
            <div class="card" id="recipeEditor" style="display:none; border-color: var(--primary);">
                <h3 style="margin-top:0; color:var(--primary)">Ingredientes: <span id="editorTitle" style="font-weight:800"></span></h3>
                <table class="sheet-table" id="tableIngredients">
                    <thead><tr><th>Ingrediente</th><th width="80">Cant.</th><th width="80" style="text-align:right">Costo</th><th width="30"></th></tr></thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top:15px; padding-top:10px; border-top:1px dashed #e2e8f0; display:flex; gap:5px;">
                    <select id="newIngSelect" style="background:#f8fafc; border:1px solid #cbd5e1; border-radius:4px; padding:6px;"></select>
                    <input type="number" id="newIngQty" placeholder="Cant" style="width:70px; border:1px solid #cbd5e1; border-radius:4px; padding:6px;">
                    <button class="btn btn-save" style="padding:6px 12px;" onclick="addIngredientToCurrent()">+</button>
                </div>
                <div style="margin-top:15px; text-align:right; font-size:14px;">Costo calculado: <strong style="color:var(--red)" id="editorTotalCost">$ 0</strong></div>
            </div>
        </div>
    </div>

  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});

    // --- DATA DEFAULT (Fallback) ---
    const DEFAULT_DATA = {
        materia: [
            {name: 'Carne (kg)', unit: 'kg', cost: 16200},
            {name: 'Pan Brioche (u)', unit: 'u', cost: 650},
            {name: 'Cheddar (feta)', unit: 'u', cost: 187},
            {name: 'Papas (kg)', unit: 'kg', cost: 1200},
            {name: 'Bacon (kg)', unit: 'kg', cost: 13920}
        ],
        pack: [{name: 'Caja Hamburguesa', cost: 150}, {name: 'Bolsa Papel', cost: 60}],
        fixed: [{name: 'Electricidad', cost: 140000}, {name: 'Gas', cost: 40000}, {name: 'Monotributo', cost: 42216}],
        prod: [{name: 'Sueldos Totales', cost: 2631557}],
        recipes: [{ id: 1, name: 'CheeseBurger Simple', ingredients: [{name: 'Carne (kg)', qty: 0.12}, {name: 'Pan Brioche (u)', qty: 1}, {name: 'Cheddar (feta)', qty: 2}] }],
        config: { pyPercent: 30 }
    };

    let DATA = DEFAULT_DATA; // Se sobreescribir√° con Firebase
    let ORDERS = [];
    let chartInstance = null;
    let currentRecipeId = null;

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        $('#monthPicker').value = now.toISOString().slice(0,7);
        $('#monthPicker').addEventListener('change', fetchOrders);
        
        loadDataFromFirebase();
    });

    // --- CARGAR DATOS DESDE FIREBASE ---
    function loadDataFromFirebase() {
        const status = $('#saveStatus');
        status.innerText = "‚òÅÔ∏è Cargando...";
        status.style.display = "inline";

        // Usamos onSnapshot para tener datos en tiempo real entre dispositivos
        db.collection('config').doc('gerencia').onSnapshot(doc => {
            if (doc.exists) {
                DATA = doc.data();
                // Asegurar retrocompatibilidad si faltan campos
                if(!DATA.config) DATA.config = { pyPercent: 30 };
            } else {
                // Si no existe, guardar el default la primera vez
                saveData(); 
            }
            
            // Actualizar UI
            $('#confPy').value = DATA.config.pyPercent || 30;
            renderAllTables();
            fetchOrders(); // Recalcular con los nuevos datos
            
            status.innerText = "‚úÖ Sincronizado";
            status.className = "saved";
            setTimeout(() => { status.style.display = 'none'; }, 2000);
        });
    }

    // --- GUARDAR DATOS EN FIREBASE ---
    function saveData(showAlert = false) {
        const status = $('#saveStatus');
        status.innerText = "‚òÅÔ∏è Guardando...";
        status.className = "saving";
        status.style.display = "inline";

        db.collection('config').doc('gerencia').set(DATA)
            .then(() => {
                status.innerText = "‚úÖ Guardado";
                status.className = "saved";
                if(showAlert) alert("Datos guardados en la nube correctamente.");
                calculateAll();
                setTimeout(() => { status.style.display = 'none'; }, 2000);
            })
            .catch((error) => {
                console.error("Error writing document: ", error);
                status.innerText = "‚ùå Error";
                status.className = "text-red";
                alert("Error al guardar: " + error.message);
            });
    }

    function saveConfigAndRecalc() {
        DATA.config.pyPercent = Number($('#confPy').value);
        saveData();
    }

    // --- RENDER TABLES ---
    function renderAllTables() {
        renderTable('tableMateria', DATA.materia, ['name', 'unit', 'cost']);
        renderTable('tablePack', DATA.pack, ['name', 'cost']);
        renderTable('tableFixed', DATA.fixed, ['name', 'cost']);
        renderTable('tableProd', DATA.prod, ['name', 'cost']);
        renderRecipesList();
    }

    function renderTable(id, dataArr, fields) {
        const tbody = document.getElementById(id).querySelector('tbody');
        tbody.innerHTML = '';
        dataArr.forEach((row, idx) => {
            let tr = document.createElement('tr');
            fields.forEach(key => {
                let td = document.createElement('td');
                let input = document.createElement('input');
                input.value = row[key];
                if(key === 'cost') { input.type = 'number'; input.style.textAlign = 'right'; input.style.fontWeight = 'bold'; }
                input.onchange = (e) => {
                    row[key] = key === 'cost' ? Number(e.target.value) : e.target.value;
                    if(id==='tableMateria') renderRecipesList();
                };
                td.appendChild(input);
                tr.appendChild(td);
            });
            let tdX = document.createElement('td');
            tdX.innerHTML = `<button style="background:none;border:none;color:#cbd5e1;cursor:pointer;" onclick="deleteRow('${id}', ${idx})">√ó</button>`;
            tr.appendChild(tdX);
            tbody.appendChild(tr);
        });
    }

    window.addRow = (tableId) => {
        let arrName = '';
        if(tableId === 'tableMateria') arrName = 'materia';
        if(tableId === 'tablePack') arrName = 'pack';
        if(tableId === 'tableFixed') arrName = 'fixed';
        if(tableId === 'tableProd') arrName = 'prod';
        DATA[arrName].push({name: '', cost: 0, unit: ''});
        renderAllTables();
    };

    window.deleteRow = (tableId, idx) => {
        let arrName = '';
        if(tableId === 'tableMateria') arrName = 'materia';
        if(tableId === 'tablePack') arrName = 'pack';
        if(tableId === 'tableFixed') arrName = 'fixed';
        if(tableId === 'tableProd') arrName = 'prod';
        DATA[arrName].splice(idx, 1);
        renderAllTables();
    };

    // --- RECETAS ---
    function getIngredientPrice(name) {
        const item = DATA.materia.find(m => m.name === name);
        return item ? item.cost : 0;
    }

    function calculateRecipeTotal(recipe) {
        return recipe.ingredients.reduce((sum, ing) => sum + (ing.qty * getIngredientPrice(ing.name)), 0);
    }

    function renderRecipesList() {
        const tbody = $('#tableRecipesList tbody');
        tbody.innerHTML = '';
        DATA.recipes.forEach(r => {
            const cost = calculateRecipeTotal(r);
            const tr = document.createElement('tr');
            tr.className = 'recipe-row';
            tr.onclick = () => openRecipeEditor(r.id);
            tr.innerHTML = `<td>${r.name}</td><td style="text-align:right; font-weight:bold">${money(cost)}</td><td style="text-align:center"><button style="background:none;border:none;color:#cbd5e1" onclick="deleteRecipe(event, ${r.id})">√ó</button></td>`;
            tbody.appendChild(tr);
        });
        if(currentRecipeId) openRecipeEditor(currentRecipeId);
    }

    window.addNewRecipe = () => {
        const name = prompt("Nombre del nuevo producto:");
        if(!name) return;
        const newId = Date.now();
        DATA.recipes.push({ id: newId, name: name, ingredients: [] });
        saveData();
        renderRecipesList();
        openRecipeEditor(newId);
    };

    window.deleteRecipe = (e, id) => {
        e.stopPropagation();
        if(!confirm("¬øBorrar receta?")) return;
        DATA.recipes = DATA.recipes.filter(r => r.id !== id);
        $('#recipeEditor').style.display = 'none';
        saveData();
        renderRecipesList();
    };

    window.openRecipeEditor = (id) => {
        currentRecipeId = id;
        const recipe = DATA.recipes.find(r => r.id === id);
        if(!recipe) return;
        $('#recipeEditor').style.display = 'block';
        $('#editorTitle').innerText = recipe.name;
        const select = $('#newIngSelect');
        select.innerHTML = '<option value="">Seleccionar Insumo...</option>';
        DATA.materia.forEach(m => select.innerHTML += `<option value="${m.name}">${m.name} ($${m.cost}/${m.unit})</option>`);
        const tbody = $('#tableIngredients tbody');
        tbody.innerHTML = '';
        recipe.ingredients.forEach((ing, idx) => {
            const unitCost = getIngredientPrice(ing.name);
            tbody.innerHTML += `<tr><td>${ing.name}</td><td><input type="number" value="${ing.qty}" step="0.01" style="width:60px" onchange="updateIngQty(${id}, ${idx}, this.value)"></td><td style="text-align:right">$ ${(unitCost * ing.qty).toFixed(0)}</td><td><button style="background:none;border:none;color:red;cursor:pointer" onclick="removeIng(${id}, ${idx})">√ó</button></td></tr>`;
        });
        $('#editorTotalCost').innerText = money(calculateRecipeTotal(recipe));
        document.querySelectorAll('.recipe-row').forEach(r => r.classList.remove('selected'));
    };

    window.addIngredientToCurrent = () => {
        const name = $('#newIngSelect').value;
        const qty = Number($('#newIngQty').value);
        if(!name || qty <= 0) return;
        const recipe = DATA.recipes.find(r => r.id === currentRecipeId);
        recipe.ingredients.push({name, qty});
        saveData();
        openRecipeEditor(currentRecipeId);
        renderRecipesList();
        $('#newIngSelect').value = ""; $('#newIngQty').value = "";
    };

    window.updateIngQty = (rId, ingIdx, val) => {
        const recipe = DATA.recipes.find(r => r.id === rId);
        recipe.ingredients[ingIdx].qty = Number(val);
        // saveData(); // Para optimizar, mejor guardar al salir o con el bot√≥n general
        renderRecipesList();
        $('#editorTotalCost').innerText = money(calculateRecipeTotal(recipe));
    };

    window.removeIng = (rId, ingIdx) => {
        const recipe = DATA.recipes.find(r => r.id === rId);
        recipe.ingredients.splice(ingIdx, 1);
        saveData(); openRecipeEditor(rId); renderRecipesList();
    };

    // --- C√ÅLCULO FINAL ---
    function fetchOrders() {
        const ym = $('#monthPicker').value;
        if(!ym) return;
        const [y, m] = ym.split('-').map(Number);
        const start = new Date(y, m-1, 1).toISOString();
        const end = new Date(y, m, 1).toISOString();
        db.collection('orders').where('createdAt', '>=', start).where('createdAt', '<', end).get().then(snap => {
            ORDERS = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled');
            calculateAll();
        });
    }

    function calculateAll() {
        if(!DATA.materia) return; // Wait for data load

        const totalFixed = DATA.fixed.reduce((s, i) => s + i.cost, 0) + DATA.prod.reduce((s, i) => s + i.cost, 0);
        const packAvg = DATA.pack.reduce((s, i) => s + i.cost, 0);
        const pyCommissionRate = (DATA.config.pyPercent || 30) / 100;

        let grossSales = 0;
        let totalCMV = 0; 
        let totalPack = 0;
        let totalCommissions = 0;
        let profitByBurger = {};

        ORDERS.forEach(o => {
            const sale = Number(o.total || 0);
            grossSales += sale;
            
            if(o.source === 'pedidosya') totalCommissions += (sale * pyCommissionRate);
            totalPack += packAvg;

            (o.items || []).forEach(item => {
                const name = (item.name || '').toLowerCase().trim();
                const qty = Number(item.qty || 1);
                
                let matchedRecipe = DATA.recipes.find(r => name.includes(r.name.toLowerCase()));
                if(!matchedRecipe) {
                    if(name.includes('doble')) matchedRecipe = DATA.recipes.find(r => r.name.toLowerCase().includes('doble'));
                    else if(name.includes('papas')) matchedRecipe = DATA.recipes.find(r => r.name.toLowerCase().includes('papas'));
                    else matchedRecipe = DATA.recipes.find(r => r.name.toLowerCase().includes('simple'));
                }

                const unitCost = matchedRecipe ? calculateRecipeTotal(matchedRecipe) : 0;
                totalCMV += (unitCost * qty);

                const rName = matchedRecipe ? matchedRecipe.name : 'Otros';
                if(!profitByBurger[rName]) profitByBurger[rName] = 0;
                profitByBurger[rName] += (sale - unitCost);
            });
        });

        const totalExpenses = totalFixed + totalCMV + totalPack + totalCommissions;
        const profit = grossSales - totalExpenses;

        $('#kpiSales').innerText = money(grossSales);
        $('#kpiCmv').innerText = '-' + money(totalCMV);
        $('#kpiFixed').innerText = '-' + money(totalFixed + totalPack + totalCommissions);
        $('#kpiProfit').innerText = money(profit);

        renderChart(grossSales, totalFixed, totalCMV, totalCommissions, profit);
        
        const sortedStats = Object.entries(profitByBurger).sort((a,b)=>b[1]-a[1]).slice(0,5);
        $('#burgerStats').innerHTML = sortedStats.map(([n, v]) => `<div style="display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:5px 0"><span>${n}</span><strong>${money(v)}</strong></div>`).join('');
    }

    function renderChart(sales, fixed, cmv, comm, profit) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ventas', 'Fijos+Sueldos', 'Recetas (CMV)', 'Comisiones', 'Ganancia'],
                datasets: [{
                    data: [sales, fixed, cmv, comm, profit],
                    backgroundColor: ['#94a3b8', '#ef4444', '#f97316', '#eab308', '#10b981'],
                    borderRadius: 4
                }]
            },
            options: { plugins: { legend: {display: false} } }
        });
    }

    window.showTab = (tabName) => {
        document.querySelectorAll('div[id^="tab-"]').forEach(d => d.style.display = 'none');
        document.querySelector('#tab-' + tabName).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    };

</script>
</body>
</html>
