<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia & Stock ‚Ä¢ Rhodes</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0;
      --green: #10b981; --red: #ef4444; --blue: #3b82f6; --orange: #f97316;
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; z-index: 10; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); display: flex; gap:10px; align-items: center; text-decoration: none; }
    .nav-btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 13px; transition:0.2s }
    .nav-btn:hover { background: #f1f5f9; color: var(--text); }
    .nav-btn.active { background: var(--primary); color: #fff; }

    /* LAYOUT */
    .layout { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; overflow-y: auto; }
    .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center; }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); }
    .content { flex: 1; padding: 30px; overflow-y: auto; }

    /* CARDS & TABLES */
    .card { background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    h2 { margin: 0 0 15px; font-size: 15px; font-weight: 700; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f8fafc; text-align: left; padding: 10px; border-bottom: 1px solid var(--border); font-weight: 600; color: #64748b; }
    td { border-bottom: 1px solid var(--border); padding: 10px; vertical-align: middle; }
    input, select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; outline: none; width: 100%; }
    
    .btn { padding: 8px 14px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-blue { background: var(--blue); color: white; }
    .btn-danger { background: #fee2e2; color: var(--red); }
    .btn-sm { padding: 4px 8px; font-size: 11px; }

    /* DASHBOARD */
    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .kpi { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .kpi-lbl { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-val { font-size: 26px; font-weight: 800; color: #0f172a; margin-top: 5px; }
    
    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
    .modal { background: #fff; width: 450px; padding: 25px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    
    /* STATUS DOTS */
    .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .st-ok { background: var(--green); } .st-warn { background: var(--orange); } .st-crit { background: var(--red); }

    /* UTIL */
    .text-red { color: var(--red); } .text-green { color: var(--green); }
    .money-in { color: var(--green); font-weight: 700; } .money-out { color: var(--red); font-weight: 700; }

  </style>
</head>
<body>

<header>
  <a href="#" class="brand"><img src="images/logo.png" width="30"> Gerencia Rhodes</a>
  <div>
    <a href="pedido_local.html" class="nav-btn">Pedidos</a>
    <a href="#" class="nav-btn active">Gerencia</a>
    <button onclick="location.href='login.html'" class="nav-btn" style="color:var(--red)">Salir</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="tab-btn active" onclick="showTab('dashboard')">üìä Rendimiento</div>
    <div class="tab-btn" onclick="showTab('recipes')">üçî Recetas</div>
    <div class="tab-btn" onclick="showTab('stock')">üì¶ Stock & Compras</div>
    <div class="tab-btn" onclick="showTab('fixed')">üí° Costos Fijos</div>
    <div class="tab-btn" onclick="showTab('production')">üë®‚Äçüç≥ Sueldos</div>
    <div class="tab-btn" onclick="showTab('packaging')">ü•° Packaging</div>
  </aside>

  <main class="content">

    <div id="tab-dashboard">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div><h2 style="margin:0; border:0">Tablero de Comando</h2></div>
        <div style="display:flex; gap:10px; align-items:center">
            <span style="font-size:12px; font-weight:700; color:#c2410c; background:#fff7ed; padding:5px 10px; border-radius:6px; border:1px solid #fed7aa">Comisi√≥n Py: <input type="number" id="confPy" value="30" style="width:40px; border:none; background:transparent; font-weight:800; text-align:right" onchange="saveConfig()">%</span>
            <input type="month" id="monthPicker">
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi">
            <div class="kpi-lbl">Ventas Brutas</div>
            <div class="kpi-val" id="kpiSales">$ 0</div>
        </div>
        <div class="kpi">
            <div class="kpi-lbl">Compras & Gastos Reales</div>
            <div class="kpi-val text-red" id="kpiExpenses">$ 0</div>
            <div style="font-size:11px; color:#64748b; margin-top:5px">Incluye Fijos, Comisiones y Stock</div>
        </div>
        <div class="kpi" style="background: #f0fdf4; border-color: #bbf7d0;">
            <div class="kpi-lbl text-green">Ganancia (Caja Real)</div>
            <div class="kpi-val text-green" id="kpiCashProfit">$ 0</div>
        </div>
        <div class="kpi" style="background: #f8fafc;">
            <div class="kpi-lbl">Ganancia (Te√≥rica Receta)</div>
            <div class="kpi-val" id="kpiTheoProfit" style="color:#64748b">$ 0</div>
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
        <div class="card">
            <h2>Flujo de Dinero (Real)</h2>
            <canvas id="mainChart" height="220"></canvas>
        </div>
        <div class="card">
            <h2>√öltimas Compras</h2>
            <div id="lastPurchasesList" style="font-size:13px; color:#555"></div>
        </div>
      </div>
    </div>

    <div id="tab-stock" style="display:none">
        <div class="card">
            <h2>
                <span>üì¶ Inventario de Insumos</span>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-blue" onclick="openPurchaseModal()">üõí Registrar Compra</button>
                    <button class="btn btn-primary" onclick="openProductModal()">+ Nuevo Producto</button>
                </div>
            </h2>
            <div style="margin-bottom:15px; display:flex; gap:10px">
                <input type="text" id="searchStock" placeholder="üîç Buscar ingrediente..." onkeyup="renderStockTable()">
                <select id="filterCat" onchange="renderStockTable()" style="width:150px">
                    <option value="all">Todo</option>
                    <option value="carniceria">Carne</option>
                    <option value="panaderia">Pan</option>
                    <option value="almacen">Almac√©n</option>
                    <option value="verdularia">Verdura</option>
                    <option value="salsas">Salsas</option>
                </select>
            </div>
            <div style="overflow-x:auto">
                <table>
                    <thead><tr><th>Producto</th><th>Categor√≠a</th><th>Stock Actual</th><th>Costo Unit.</th><th>Estado</th><th></th></tr></thead>
                    <tbody id="stockTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-recipes" style="display:none">
        <div class="card">
            <h2>
                <span>üçî Costo de Recetas</span>
                <button class="btn btn-primary" onclick="addNewRecipe()">+ Nueva Receta</button>
            </h2>
            <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px">
                <div>
                    <table>
                        <thead><tr><th>Producto</th><th style="text-align:right">Costo</th><th></th></tr></thead>
                        <tbody id="recipesListBody"></tbody>
                    </table>
                </div>
                <div id="recipeEditor" style="background:#f8fafc; padding:20px; border-radius:10px; border:1px solid #e2e8f0; display:none">
                    <h3 style="margin-top:0; color:var(--primary)">Editando: <span id="editorTitle"></span></h3>
                    <table style="background:#fff">
                        <thead><tr><th>Ingrediente (Stock)</th><th>Cant.</th><th>Costo</th><th></th></tr></thead>
                        <tbody id="recipeIngBody"></tbody>
                    </table>
                    <div style="margin-top:10px; display:flex; gap:5px; border-top:1px dashed #cbd5e1; padding-top:10px">
                        <select id="newRecIng"></select>
                        <input type="number" id="newRecQty" placeholder="Cant" style="width:80px">
                        <button class="btn btn-primary" onclick="addIngToRecipe()">+</button>
                    </div>
                    <div style="text-align:right; margin-top:10px">Costo Total: <strong id="editorTotalCost" class="text-red">$ 0</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-fixed" style="display:none">
      <div class="card">
        <h2><span>üí° Gastos Fijos Mensuales</span> <button class="btn btn-primary" onclick="addFixedRow()">+ Agregar</button></h2>
        <table id="tableFixed"><thead><tr><th>Concepto</th><th width="150">Monto Mensual ($)</th><th width="50"></th></tr></thead><tbody></tbody></table>
        <div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div>
      </div>
    </div>

    <div id="tab-production" style="display:none">
      <div class="card">
        <h2><span>üë®‚Äçüç≥ Sueldos y Producci√≥n</span> <button class="btn btn-primary" onclick="addProdRow()">+ Agregar</button></h2>
        <table id="tableProd"><thead><tr><th>Empleado / Concepto</th><th width="150">Total ($)</th><th width="50"></th></tr></thead><tbody></tbody></table>
        <div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div>
      </div>
    </div>

    <div id="tab-packaging" style="display:none">
        <div class="card">
            <h2><span>ü•° Costos Packaging</span> <button class="btn btn-primary" onclick="addPackRow()">+ Agregar</button></h2>
            <table id="tablePack"><thead><tr><th>Item</th><th width="150">Costo Unitario ($)</th><th width="50"></th></tr></thead><tbody></tbody></table>
            <div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div>
        </div>
    </div>

  </main>
</div>

<div class="modal-overlay" id="modalProduct">
    <div class="modal">
        <h3 id="mpTitle">Nuevo Producto</h3>
        <input type="hidden" id="mpId">
        <div style="margin-bottom:10px"><label>Nombre</label><input type="text" id="mpName"></div>
        <div style="margin-bottom:10px"><label>Categor√≠a</label>
            <select id="mpCat">
                <option value="carniceria">Carne</option><option value="panaderia">Pan</option>
                <option value="almacen">Almac√©n</option><option value="verdularia">Verdura</option>
                <option value="salsas">Salsas</option><option value="bebidas">Bebidas</option>
                <option value="packaging">Packaging</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; margin-bottom:10px">
            <div><label>Stock Inicial</label><input type="number" id="mpQty" step="0.01"></div>
            <div><label>Unidad</label><select id="mpUnit"><option value="kg">Kg</option><option value="u">Unid</option><option value="lt">Lt</option></select></div>
        </div>
        <div style="margin-bottom:10px"><label>Costo Actual ($)</label><input type="number" id="mpCost" step="0.01"></div>
        <div style="margin-bottom:15px"><label>Stock M√≠nimo</label><input type="number" id="mpMin" value="5"></div>
        <div style="display:flex; gap:10px">
            <button class="btn btn-primary" style="flex:1" onclick="saveProduct()">Guardar</button>
            <button class="btn" style="flex:1" onclick="$('#modalProduct').style.display='none'">Cancelar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalPurchase">
    <div class="modal">
        <h3>üõí Registrar Compra</h3>
        <div style="margin-bottom:10px"><label>Producto</label><select id="purProd"></select></div>
        <div style="display:flex; gap:10px; margin-bottom:10px">
            <div><label>Cantidad Comprada</label><input type="number" id="purQty" placeholder="Ej: 10"></div>
            <div><label>Costo Total ($)</label><input type="number" id="purTotal" placeholder="Ej: 50000"></div>
        </div>
        <div style="margin-bottom:15px"><label>Fecha</label><input type="date" id="purDate"></div>
        <div style="display:flex; gap:10px">
            <button class="btn btn-primary" style="flex:1" onclick="confirmPurchase()">Registrar Gasto</button>
            <button class="btn" style="flex:1" onclick="$('#modalPurchase').style.display='none'">Cancelar</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // 1. CONFIG
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});

    // 2. STATE
    let INVENTORY = [];
    let RECIPES = [];
    let PURCHASES = [];
    let ORDERS = [];
    let FIXED_DATA = { fixed:[], prod:[], pack:[], config:{pyPercent:30} };
    let currentRecipeId = null;
    let chartInstance = null;

    // 3. INIT
    window.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        $('#monthPicker').value = now.toISOString().slice(0,7);
        $('#purDate').valueAsDate = now;

        // Listeners
        $('#monthPicker').addEventListener('change', loadDashboardData);
        
        // Load Realtime Data
        loadInventory();
        loadRecipes();
        loadFixedData();
        loadDashboardData();
    });

    // --- DATA LOADING ---
    function loadInventory() {
        db.collection('inventory').orderBy('name').onSnapshot(snap => {
            INVENTORY = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderStockTable();
        });
    }
    function loadRecipes() {
        db.collection('recipes').onSnapshot(snap => {
            RECIPES = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderRecipesList();
        });
    }
    function loadFixedData() {
        db.collection('config').doc('gerencia').onSnapshot(doc => {
            if(doc.exists) FIXED_DATA = doc.data();
            if(!FIXED_DATA.fixed) FIXED_DATA.fixed = [];
            if(!FIXED_DATA.prod) FIXED_DATA.prod = [];
            if(!FIXED_DATA.pack) FIXED_DATA.pack = [];
            
            $('#confPy').value = FIXED_DATA.config?.pyPercent || 30;
            renderFixedTables();
        });
    }
    function loadDashboardData() {
        const ym = $('#monthPicker').value;
        if(!ym) return;
        const [y, m] = ym.split('-').map(Number);
        const start = new Date(y, m-1, 1).toISOString();
        const end = new Date(y, m, 1).toISOString();

        // 1. Orders
        db.collection('orders').where('createdAt', '>=', start).where('createdAt', '<', end).get().then(snap => {
            ORDERS = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled');
            calculateAll();
        });

        // 2. Purchases (Gastos Reales)
        db.collection('purchases').where('date', '>=', start).where('date', '<', end).get().then(snap => {
            PURCHASES = snap.docs.map(d => d.data());
            calculateAll();
        });
    }

    // --- STOCK & PURCHASES ---
    function renderStockTable() {
        const t = $('#searchStock').value.toLowerCase();
        const cat = $('#filterCat').value;
        const tbody = $('#stockTableBody');
        tbody.innerHTML = '';

        INVENTORY.filter(p => p.name.toLowerCase().includes(t) && (cat === 'all' || p.category === cat)).forEach(p => {
            let stHtml = `<span class="status-dot st-ok"></span>OK`;
            if(p.qty <= p.min) stHtml = `<span class="status-dot st-crit"></span>CRIT`;
            else if(p.qty <= p.min*1.5) stHtml = `<span class="status-dot st-warn"></span>BAJO`;

            tbody.innerHTML += `<tr>
                <td><b>${p.name}</b></td>
                <td><small>${p.category}</small></td>
                <td>${Number(p.qty).toFixed(2)} ${p.unit}</td>
                <td>${money(p.cost)}</td>
                <td>${stHtml}</td>
                <td><button class="btn btn-sm" onclick="openProductModal('${p.id}')">‚úèÔ∏è</button></td>
            </tr>`;
        });
    }

    window.openProductModal = (id) => {
        $('#modalProduct').style.display = 'flex';
        if(id) {
            const p = INVENTORY.find(i => i.id === id);
            $('#mpTitle').innerText = 'Editar Producto';
            $('#mpId').value = id;
            $('#mpName').value = p.name;
            $('#mpCat').value = p.category;
            $('#mpQty').value = p.qty;
            $('#mpUnit').value = p.unit;
            $('#mpCost').value = p.cost || 0;
            $('#mpMin').value = p.min;
        } else {
            $('#mpTitle').innerText = 'Nuevo Producto';
            $('#mpId').value = '';
            $('#mpName').value = '';
            $('#mpQty').value = 0;
            $('#mpCost').value = 0;
        }
    };

    window.saveProduct = async () => {
        const id = $('#mpId').value;
        const data = {
            name: $('#mpName').value,
            category: $('#mpCat').value,
            qty: Number($('#mpQty').value),
            unit: $('#mpUnit').value,
            cost: Number($('#mpCost').value),
            min: Number($('#mpMin').value)
        };
        if(!data.name) return alert("Falta nombre");
        
        if(id) await db.collection('inventory').doc(id).update(data);
        else await db.collection('inventory').add(data);
        $('#modalProduct').style.display = 'none';
    };

    window.openPurchaseModal = () => {
        $('#modalPurchase').style.display = 'flex';
        const sel = $('#purProd');
        sel.innerHTML = '';
        INVENTORY.forEach(p => {
            sel.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${p.qty})</option>`;
        });
        $('#purQty').value = '';
        $('#purTotal').value = '';
    };

    window.confirmPurchase = async () => {
        const prodId = $('#purProd').value;
        const qty = Number($('#purQty').value);
        const total = Number($('#purTotal').value);
        const date = $('#purDate').value;

        if(!prodId || qty <= 0 || total <= 0) return alert("Datos inv√°lidos");

        // 1. Guardar Compra
        await db.collection('purchases').add({
            prodId, qty, total, date,
            prodName: INVENTORY.find(i=>i.id===prodId)?.name
        });

        // 2. Actualizar Stock y Costo Promedio
        const prod = INVENTORY.find(i => i.id === prodId);
        if(prod) {
            const newQty = Number(prod.qty) + qty;
            // Nuevo costo unitario basado en la √∫ltima compra (o promedio ponderado si prefieres)
            const newUnitCost = total / qty; 
            await db.collection('inventory').doc(prodId).update({
                qty: newQty,
                cost: newUnitCost
            });
        }

        alert("Compra registrada y stock actualizado!");
        $('#modalPurchase').style.display = 'none';
        loadDashboardData(); // Refrescar finanzas
    };

    // --- RECIPES ---
    function renderRecipesList() {
        const tbody = $('#recipesListBody');
        tbody.innerHTML = '';
        RECIPES.forEach(r => {
            // Calcular costo usando precios actuales del inventario
            const cost = (r.ingredients || []).reduce((sum, ing) => {
                const item = INVENTORY.find(i => i.name === ing.name); // Match por nombre
                return sum + (ing.qty * (item ? item.cost : 0));
            }, 0);
            
            const tr = document.createElement('tr');
            tr.onclick = () => openRecipeEditor(r);
            tr.className = 'recipe-row';
            tr.innerHTML = `<td>${r.id}</td><td style="text-align:right"><b>${money(cost)}</b></td><td><button class="btn-sm btn-danger" onclick="delRecipe(event,'${r.id}')">√ó</button></td>`;
            tbody.appendChild(tr);
        });
    }

    window.openRecipeEditor = (r) => {
        currentRecipeId = r.id;
        $('#recipeEditor').style.display = 'block';
        $('#editorTitle').innerText = r.id;
        
        // Select Ingredientes
        const sel = $('#newRecIng');
        sel.innerHTML = '<option value="">Agregar...</option>';
        INVENTORY.forEach(i => sel.innerHTML += `<option value="${i.name}">${i.name} ($${Math.round(i.cost)})</option>`);

        // Render Ingredientes Actuales
        const tbody = $('#recipeIngBody');
        tbody.innerHTML = '';
        let total = 0;
        (r.ingredients || []).forEach((ing, idx) => {
            const item = INVENTORY.find(i => i.name === ing.name);
            const cost = item ? item.cost : 0;
            const lineTotal = cost * ing.qty;
            total += lineTotal;
            tbody.innerHTML += `<tr><td>${ing.name}</td><td>${ing.qty}</td><td>${money(lineTotal)}</td><td><button style="color:red;border:none;background:none;cursor:pointer" onclick="removeRecIng('${r.id}', ${idx})">√ó</button></td></tr>`;
        });
        $('#editorTotalCost').innerText = money(total);
    };

    window.addNewRecipe = async () => {
        const name = prompt("Nombre del producto (tal cual figura en Pedidos):");
        if(name) {
            await db.collection('recipes').doc(name).set({ingredients: []});
        }
    };

    window.addIngToRecipe = async () => {
        const name = $('#newRecIng').value;
        const qty = Number($('#newRecQty').value);
        if(!name || !qty) return;
        const r = RECIPES.find(x => x.id === currentRecipeId);
        const newIngs = [...(r.ingredients || []), {name, qty}];
        await db.collection('recipes').doc(currentRecipeId).update({ingredients: newIngs});
        $('#newRecQty').value = '';
    };

    window.removeRecIng = async (rId, idx) => {
        const r = RECIPES.find(x => x.id === rId);
        const newIngs = [...r.ingredients];
        newIngs.splice(idx, 1);
        await db.collection('recipes').doc(rId).update({ingredients: newIngs});
        // La suscripci√≥n onSnapshot actualizar√° la UI
    };
    
    window.delRecipe = async (e, id) => {
        e.stopPropagation();
        if(confirm("Borrar receta?")) {
            await db.collection('recipes').doc(id).delete();
            $('#recipeEditor').style.display = 'none';
        }
    };

    // --- FIXED, PROD, PACK TABLES ---
    function renderFixedTables() {
        renderSimpleTable('tableFixed', FIXED_DATA.fixed);
        renderSimpleTable('tableProd', FIXED_DATA.prod);
        renderSimpleTable('tablePack', FIXED_DATA.pack);
    }

    function renderSimpleTable(id, arr) {
        const tbody = document.querySelector('#'+id+' tbody');
        tbody.innerHTML = '';
        arr.forEach((row, idx) => {
            tbody.innerHTML += `<tr>
                <td><input value="${row.name}" onchange="updateFixedRow('${id}',${idx},'name',this.value)"></td>
                <td><input type="number" value="${row.cost}" onchange="updateFixedRow('${id}',${idx},'cost',this.value)"></td>
                <td><button style="color:#ccc;border:none;background:none" onclick="delFixedRow('${id}',${idx})">√ó</button></td>
            </tr>`;
        });
    }

    window.addFixedRow = (id) => {
        let arr = id === 'tableFixed' ? FIXED_DATA.fixed : (id === 'tableProd' ? FIXED_DATA.prod : FIXED_DATA.pack);
        arr.push({name:'', cost:0});
        renderFixedTables();
    };
    window.updateFixedRow = (tableId, idx, field, val) => {
        let arr = tableId === 'tableFixed' ? FIXED_DATA.fixed : (tableId === 'tableProd' ? FIXED_DATA.prod : FIXED_DATA.pack);
        arr[idx][field] = field === 'cost' ? Number(val) : val;
    };
    window.delFixedRow = (tableId, idx) => {
        let arr = tableId === 'tableFixed' ? FIXED_DATA.fixed : (tableId === 'tableProd' ? FIXED_DATA.prod : FIXED_DATA.pack);
        arr.splice(idx, 1);
        renderFixedTables();
    };
    window.saveFixedData = () => {
        FIXED_DATA.config = { pyPercent: Number($('#confPy').value) };
        db.collection('config').doc('gerencia').set(FIXED_DATA).then(()=>alert("Guardado!"));
    };
    window.saveConfig = saveFixedData;

    // --- C√ÅLCULOS FINALES ---
    function calculateAll() {
        let grossSales = 0;
        let commissions = 0;
        let totalFixed = FIXED_DATA.fixed.reduce((s,i)=>s+i.cost,0) + FIXED_DATA.prod.reduce((s,i)=>s+i.cost,0);
        
        // Costo Te√≥rico
        let theoreticalCMV = 0;
        const packAvg = FIXED_DATA.pack.reduce((s,i)=>s+i.cost,0); // Suma simple, aprox
        let totalPackTheo = 0;

        ORDERS.forEach(o => {
            const sale = Number(o.total || 0);
            grossSales += sale;
            if(o.source === 'pedidosya') commissions += (sale * (FIXED_DATA.config.pyPercent/100));
            totalPackTheo += packAvg;

            (o.items || []).forEach(item => {
                const r = RECIPES.find(x => x.id === item.name); // Match exacto o aproximado
                if(r) {
                    const unitCost = (r.ingredients || []).reduce((sum, ing) => {
                        const stockItem = INVENTORY.find(inv => inv.name === ing.name);
                        return sum + (ing.qty * (stockItem ? stockItem.cost : 0));
                    }, 0);
                    theoreticalCMV += (unitCost * Number(item.qty || 1));
                }
            });
        });

        // Costo Real (Compras del Mes)
        const realPurchases = PURCHASES.reduce((s, p) => s + Number(p.total), 0);

        // Resultados
        const profitCash = grossSales - (totalFixed + commissions + realPurchases);
        const profitTheo = grossSales - (totalFixed + commissions + theoreticalCMV + totalPackTheo);

        $('#kpiSales').innerText = money(grossSales);
        $('#kpiExpenses').innerText = '-' + money(totalFixed + commissions + realPurchases);
        $('#kpiCashProfit').innerText = money(profitCash);
        $('#kpiTheoProfit').innerText = money(profitTheo);

        // Gr√°fico
        const ctx = $('#mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ingresos', 'Gastos Reales (Compras+Fijos)', 'Comisiones', 'Ganancia (Caja)'],
                datasets: [{
                    label: 'Flujo de Caja',
                    data: [grossSales, (realPurchases + totalFixed), commissions, profitCash],
                    backgroundColor: ['#94a3b8', '#ef4444', '#f59e0b', '#10b981'],
                    borderRadius: 5
                }]
            },
            options: { plugins: { legend: { display: false } } }
        });

        // √öltimas compras
        $('#lastPurchasesList').innerHTML = PURCHASES.slice(0, 5).map(p => 
            `<div style="display:flex; justify-content:space-between; border-bottom:1px dashed #eee; padding:5px 0">
                <span>${p.prodName || 'Compra'}</span>
                <strong class="text-red">-${money(p.total)}</strong>
            </div>`
        ).join('');
    }

    // TABS
    window.showTab = (id) => {
        document.querySelectorAll('div[id^="tab-"]').forEach(d => d.style.display = 'none');
        document.querySelector('#tab-'+id).style.display = 'block';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    };

</script>
</body>
</html>
