<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia & Stock â€¢ Rhodes</title>
  <link rel="icon" href="images/logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ESTILOS BASE */
    :root { --primary: #625A45; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0; --green: #10b981; --red: #ef4444; --blue: #3b82f6; --purple: #8b5cf6; --orange: #f97316; }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

    header { background: #fff; border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; z-index: 10; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-group { display: flex; gap: 5px; align-items: center; }
    .nav-btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 13px; transition:0.2s; white-space: nowrap; }
    .nav-btn:hover { background: #f1f5f9; color: #0f172a; }
    .nav-btn.active { background: var(--primary); color: #fff; }

    .layout { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; overflow-y: auto; }
    .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center; }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); }
    .section-title { font-size:11px; font-weight:700; color:#999; text-transform:uppercase; margin:15px 20px 5px 20px; }
    .content { flex: 1; padding: 30px; overflow-y: auto; }

    .card { background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    h2 { margin: 0 0 15px; font-size: 15px; font-weight: 700; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
    h5 { margin: 0 0 10px; font-size: 13px; font-weight: 700; color: #64748b; text-transform: uppercase; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f8fafc; text-align: left; padding: 10px; border-bottom: 1px solid var(--border); font-weight: 600; color: #64748b; }
    td { border-bottom: 1px solid var(--border); padding: 10px; vertical-align: middle; }
    input, select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; outline: none; width: 100%; }
    
    .btn { padding: 8px 14px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-blue { background: var(--blue); color: white; }
    .btn-purple { background: var(--purple); color: white; }
    .btn-danger { background: #fee2e2; color: var(--red); }
    .btn-icon { background:transparent; border:none; font-size:16px; cursor:pointer; color:#94a3b8; }
    .btn-icon:hover { color: var(--red); }
    .btn-sm { padding: 4px 8px; font-size: 11px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .kpi { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .kpi-lbl { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-val { font-size: 26px; font-weight: 800; color: #0f172a; margin-top: 5px; }
    
    .order-row { cursor: pointer; transition: background 0.2s; }
    .order-row:hover { background: #f8fafc; }
    .order-details { display: none; background: #fcfcfc; border-bottom: 1px solid var(--border); }
    .order-details.open { display: table-row; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 15px; }
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; display:inline-block; letter-spacing:0.5px; }
    .bdg-web { background: #e0f2fe; color: #0284c7; }    
    .bdg-local { background: #f1f5f9; color: #475569; } 
    .bdg-py { background: #fee2e2; color: #ef4444; }     
    .bdg-cash { background: #dcfce7; color: #166534; }   
    .bdg-digital { background: #f3e8ff; color: #7e22ce; } 

    .conf-input-group { display:flex; flex-direction:column; align-items:center; }
    .conf-lbl { font-size:9px; color:#c2410c; margin-bottom:2px; font-weight:700; text-transform:uppercase; }
    .conf-inp { width:45px; border:1px solid #fdba74; background:#fff; font-weight:700; text-align:center; padding:2px; border-radius:4px; font-size:12px; }

    .alias-builder { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .alias-list-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #e2e8f0; font-size: 12px; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
    .modal { background: #fff; width: 500px; padding: 25px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height:90vh; overflow-y:auto; }
    
    .text-red { color: var(--red); } .text-green { color: var(--green); }
    .charts-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    @media (max-width: 1000px) { .charts-row { grid-template-columns: 1fr; } }
    
    .ing-list { border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-top: 10px; background: #fafafa; }
    .ing-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dashed #ddd; font-size: 14px; }
    
    /* Sticky header */
    .sticky-col { position: sticky; left: 0; z-index: 2; border-right: 2px solid #cbd5e1; background: #fff; }
    /* Headers de categorÃ­a */
    .cat-header { background: #e2e8f0; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: #475569; padding: 8px 10px; font-size: 11px; }
    
    .pct-tag { font-size: 10px; font-weight: 400; margin-left: 4px; opacity: 0.8; }

    /* STOCK INPUTS */
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    .qty-control { display: flex; align-items: center; gap: 5px; justify-content: center; }
    .qty-input { width: 70px; text-align: center; border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px; font-weight: 700; color: #334155; outline: none; transition: 0.2s; background: #fff; }
    .qty-input:focus { border-color: var(--primary); background: #fffbeb; box-shadow: 0 0 0 3px rgba(98, 90, 69, 0.1); }
    .qty-btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f8fafc; color: #64748b; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .qty-btn:hover { background: #e2e8f0; color: var(--primary); }
    .qty-btn:active { transform: scale(0.95); }
  </style>
</head>
<body>

<header>
  <a href="#" class="brand"><img src="images/logo.png" width="30"> Gerencia Rhodes</a>
  <div class="nav-group">
    <a href="pedido_local.html" class="nav-btn">ğŸ“¦ Pedidos</a>
    <a href="finanzas.html" class="nav-btn">ğŸ“ˆ Finanzas</a>
    <a href="stock.html" class="nav-btn">ğŸ“‹ Stock</a>
    <a href="ingresos.html" class="nav-btn">ğŸ“¥ Ingresos</a>
    <a href="mostrador.html" class="nav-btn">ğŸ§¾ Mostrador</a>
    <a href="admin.html" class="nav-btn">âš™ï¸ Admin</a>
    <a href="#" class="nav-btn active">ğŸ“Š Gerencia</a>
    <button onclick="location.href='login.html'" class="nav-btn" style="color:var(--red)">Salir</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="tab-btn active" onclick="showTab('dashboard')">ğŸ“Š Rendimiento</div>
    
    <div class="section-title">AnÃ¡lisis</div>
    <div class="tab-btn" onclick="showTab('proportions')">ğŸ“ˆ ProporciÃ³n Ventas</div>

    <div class="section-title">GestiÃ³n</div>
    <div class="tab-btn" onclick="showTab('stock')">ğŸ“¦ Control de Stock</div>
    <div class="tab-btn" onclick="showTab('subrecipes')">ğŸ§© Armado de Items</div>
    <div class="tab-btn" onclick="showTab('recipes')">ğŸ” Recetas Finales</div>
    
    <div class="section-title">Costos & Precios</div>
    <div class="tab-btn" onclick="showTab('cost_materia')">ğŸ¥© Costos Mat. Prima</div>
    <div class="tab-btn" onclick="showTab('cost_pack')">ğŸ¥¡ Costos Packaging</div>
    <div class="tab-btn" onclick="showTab('fixed')">ğŸ’¡ Gastos Fijos</div>
    <div class="tab-btn" onclick="showTab('production')">ğŸ‘¨â€ğŸ³ Sueldos</div>

    <div class="section-title">Historial</div>
    <div class="tab-btn" onclick="showTab('orders')">ğŸ§¾ Lista de Pedidos</div>
  </aside>

  <main class="content">

    <div id="tab-dashboard">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <div><h2 style="margin:0; border:0">Tablero de Comando</h2></div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <div style="background:#fff7ed; padding:6px 12px; border-radius:8px; border:1px solid #fed7aa; display:flex; align-items:center; gap:8px">
                <div class="conf-input-group"><div class="conf-lbl">DÃ©bito</div><input type="number" id="confDebit" value="0" class="conf-inp"></div>
                <div class="conf-input-group"><div class="conf-lbl">Transf</div><input type="number" id="confTransf" value="0" class="conf-inp"></div>
                <div class="conf-input-group"><div class="conf-lbl">QR/MP</div><input type="number" id="confQR" value="0" class="conf-inp"></div>
                <button class="btn-sm btn-primary" onclick="saveConfig()" style="height:32px; margin-left:5px">ğŸ’¾</button>
            </div>
            <input type="month" id="monthPicker" title="Selecciona mes" onchange="changeDate(this.value)" style="font-weight:700; border:2px solid var(--primary); color:var(--primary); padding:5px; border-radius:6px; cursor:pointer;">
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-lbl">Ventas Brutas</div><div class="kpi-val" id="kpiSales">$ 0</div></div>
        <div class="kpi"><div class="kpi-lbl">Costo TeÃ³rico</div><div class="kpi-val text-red" id="kpiTheoCMV">$ 0</div></div>
        <div class="kpi"><div class="kpi-lbl">Gastos (Incl. Var)</div><div class="kpi-val text-red" id="kpiTotalExpenses">$ 0</div></div>
        <div class="kpi" id="kpiNetContainer"><div class="kpi-lbl">Ganancia Neta</div><div class="kpi-val" id="kpiNet">$ 0</div></div>
      </div>

      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:20px;">
        <div class="card">
            <h2>Desglose de Gastos y Ganancia</h2>
            <div style="position: relative; height: 250px; width: 100%;"><canvas id="mainChart"></canvas></div>
        </div>
        <div class="card">
            <h2>Ãšltimas Compras Stock</h2>
            <div id="lastPurchasesList" style="font-size:13px; color:#555"></div>
        </div>
      </div>

      <div class="charts-row">
          <div class="card"><h5>ğŸ“… EvoluciÃ³n Ventas</h5><div style="height:200px"><canvas id="dailyChart"></canvas></div></div>
          <div class="card"><h5>ğŸ” Top Productos</h5><div style="height:200px"><canvas id="topProductsChart"></canvas></div></div>
          <div class="card"><h5>ğŸ’³ Medios de Pago</h5><div style="height:200px"><canvas id="paymentChart"></canvas></div></div>
      </div>
    </div>

    <div id="tab-proportions" style="display:none">
        <div class="card">
            <div class="row-flex">
                <h2 style="margin:0; border:0">ğŸ“Š ProporciÃ³n de Ventas (Detallado)</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="month" id="monthPickerProp" title="Selecciona mes" onchange="changeDate(this.value)" style="font-weight:700; border:1px solid #cbd5e1; color:#64748b; padding:5px; border-radius:6px; cursor:pointer; font-size:13px;">
                    <div id="totalItemsBadge" style="background:var(--primary); color:white; padding:4px 12px; border-radius:20px; font-size:12px; font-weight:700">Total: 0</div>
                </div>
            </div>
            <div style="overflow-x:auto; margin-top:15px">
                <table style="border-collapse: separate; border-spacing: 0;">
                    <thead>
                        <tr>
                            <th class="sticky-col" style="z-index:10; min-width:150px">Producto</th>
                            <th style="text-align: center; background: #fff7ed; color: #9a3412;">Simple</th>
                            <th style="text-align: center; background: #fff7ed; color: #9a3412;">Doble</th>
                            <th style="text-align: center; background: #fffbeb; color: #92400e; font-weight:800; border-right:2px solid #e2e8f0">TOTAL</th>
                            <th style="text-align: center; background: #eff6ff; color: #1e40af;">ğŸŒ Web <small>(%)</small></th>
                            <th style="text-align: center; background: #f8fafc; color: #475569;">ğŸª Local <small>(%)</small></th>
                            <th style="text-align: center; background: #fef2f2; color: #b91c1c;">ğŸ›µ PedidosYa <small>(%)</small></th>
                        </tr>
                    </thead>
                    <tbody id="proportionsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-orders" style="display:none">
        <div class="card">
            <h2><span id="ordersTitle">ğŸ§¾ Historial de Pedidos</span> <small style="font-size:12px; color:#777; font-weight:400">Clic en pedido para ver detalle</small></h2>
            <div style="overflow-x:auto">
                <table style="width:100%">
                    <thead><tr><th width="120">Fecha</th><th>Cliente</th><th width="100">Origen</th><th width="120">Pago</th><th width="100">Total</th><th width="100">Ganancia</th><th width="30"></th></tr></thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-stock" style="display:none">
        <div class="card">
            <div class="row-flex">
                <div style="flex:1"><h2 style="margin:0; border:0">ğŸ“¦ Control de Stock</h2></div>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-blue" onclick="openPurchaseModal()">ğŸ›’ Registrar Compra</button>
                    <button class="btn btn-primary" onclick="openProductModal()">+ Nuevo Producto</button>
                </div>
            </div>
            <div class="row-flex" style="background:#f8fafc; padding:15px; border-radius:10px; border:1px solid #e2e8f0;">
                <div style="flex:2">
                    <input type="text" id="searchStock" placeholder="ğŸ” Buscar ingrediente..." onkeyup="renderStockTable()" style="background:#fff">
                </div>
                <div style="flex:1">
                    <select id="filterCat" onchange="renderStockTable()" style="background:#fff">
                        <option value="all">Todas las CategorÃ­as</option>
                        <option value="carniceria">Carne</option>
                        <option value="panaderia">Pan</option>
                        <option value="papas">Papas / Congelados</option>
                        <option value="salsas">Salsas</option>
                        <option value="almacen">AlmacÃ©n</option>
                        <option value="verdularia">Verdura</option>
                        <option value="bebidas">Bebidas</option>
                        <option value="packaging">Packaging</option>
                        <option value="ğŸ§© Armado">ğŸ§© Items Armados</option>
                    </select>
                </div>
            </div>
            <div style="overflow-x:auto; margin-top:10px;">
                <table><thead><tr><th>Producto</th><th>Cat</th><th>Actual</th><th>Min</th><th>Estado</th><th></th></tr></thead>
                <tbody id="stockTableBody"></tbody></table>
            </div>
        </div>
    </div>

    <div id="tab-cost_materia" style="display:none">
        <div class="card"><h2><span>ğŸ¥© Costos Materia Prima</span><button class="btn btn-primary" onclick="openProductModal(null, 'carniceria')">+ Nuevo Insumo</button></h2><div style="overflow-x:auto"><table><thead><tr><th>Insumo</th><th>Costo Compra</th><th>Formato</th><th>Rendimiento</th><th style="background:#f0fdf4; color:#166534">Costo Base</th><th></th></tr></thead><tbody id="costMateriaBody"></tbody></table></div></div>
    </div>
    <div id="tab-cost_pack" style="display:none">
        <div class="card"><h2><span>ğŸ¥¡ Costos Packaging</span><button class="btn btn-primary" onclick="openProductModal(null, 'packaging')">+ Nuevo Item</button></h2><table><thead><tr><th>Item</th><th>Costo Compra</th><th>Formato</th><th>Rendimiento</th><th style="background:#f0fdf4; color:#166534">Costo Unit.</th><th></th></tr></thead><tbody id="costPackBody"></tbody></table></div>
    </div>

    <div id="tab-subrecipes" style="display:none">
        <div class="card" style="height: calc(100vh - 140px); display:flex; flex-direction:column; padding:0; overflow:hidden;">
            <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:#f8fafc;">
                <div><h2 style="margin:0; border:0; padding:0">ğŸ§© Armado de Items (Sub-recetas)</h2><small style="color:#64748b">CreÃ¡ medallones, salsas caseras, etc.</small></div>
                <button class="btn btn-purple" onclick="addNewSubRecipe()">+ Nuevo Item</button>
            </div>
            <div style="display:flex; flex:1; overflow:hidden;">
                <div style="width:300px; border-right:1px solid var(--border); display:flex; flex-direction:column; background:#fff;">
                    <div style="padding:10px; border-bottom:1px solid var(--border);"><input type="text" placeholder="ğŸ” Buscar item..." onkeyup="renderSubRecipesList(this.value)" style="background:#f1f5f9; border:none;"></div>
                    <div style="flex:1; overflow-y:auto;" id="subRecipesListBody"></div>
                </div>
                <div id="subRecipeEditor" style="flex:1; background:#fff; display:none; flex-direction:column;">
                    <div style="padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:#fff;">
                        <div><span style="font-size:10px; font-weight:700; color:var(--purple);">FICHA TÃ‰CNICA</span><h1 style="margin:5px 0 0 0; font-size:24px; color:#1e293b;" id="subEditorTitle">Nombre</h1></div>
                        <div style="text-align:right"><div style="font-size:11px; font-weight:600;">COSTO TOTAL</div><div style="font-size:28px; font-weight:800; color:var(--purple);" id="subEditorTotalCost">$ 0</div></div>
                    </div>
                    <div style="flex:1; overflow-y:auto; padding:20px;">
                        <table style="width:100%; border-collapse:collapse;"><thead style="position:sticky; top:0; background:#fff; z-index:1;"><tr><th>Ingrediente</th><th>Cant.</th><th>Costo U.</th><th>Subtotal</th><th></th></tr></thead><tbody id="subRecipeIngBody"></tbody></table>
                        <div style="margin-top:20px; background:#f8fafc; padding:15px; border-radius:8px; border:1px dashed #cbd5e1; display:flex; gap:10px; align-items:center;">
                            <div style="flex:2;"><label style="font-size:10px; font-weight:700; color:#64748b; display:block;">INSUMO</label><select id="newSubIng" onchange="updateUnitSelect('sub')" style="background:#fff;"></select></div>
                            <div style="flex:1;"><label style="font-size:10px; font-weight:700; color:#64748b; display:block;">CANTIDAD</label><input type="number" id="newSubQty" placeholder="0" step="0.001" style="background:#fff;"></div>
                            <div style="flex:1;"><label style="font-size:10px; font-weight:700; color:#64748b; display:block;">UNIDAD</label><select id="newSubUnit" style="background:#e0f2fe; color:#0369a1; font-weight:700; border:none;"></select></div>
                            <div style="padding-top:14px;"><button class="btn btn-purple" onclick="addIngToSubRecipe()">+</button></div>
                        </div>
                    </div>
                    <div style="padding:15px; background:#fff; border-top:1px solid var(--border); text-align:right;"><button class="btn btn-sm btn-danger" onclick="deleteItem('subrecipes', currentSubRecipeId)" style="background:transparent; border:1px solid #fee2e2; color:#ef4444;">ğŸ—‘ï¸ Eliminar</button></div>
                </div>
                <div id="subRecipeEmpty" style="flex:1; display:flex; justify-content:center; align-items:center; color:#cbd5e1; flex-direction:column;"><div style="font-size:40px;">ğŸ§©</div><div style="margin-top:10px; font-weight:600;">SeleccionÃ¡ un item</div></div>
            </div>
        </div>
    </div>

    <div id="tab-recipes" style="display:none">
        <div class="card">
            <div class="row-flex">
                <div style="flex:1"><h2 style="margin:0; border:0">ğŸ” Recetas Finales</h2><small style="color:#64748b">Define los ingredientes de tus productos de venta.</small></div>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-blue" onclick="openAliasModal()">ğŸ”— Promos/Combos</button>
                    <button class="btn btn-primary" onclick="openRecipeModal()">+ Nueva Receta</button>
                </div>
            </div>
            <div style="overflow-x:auto">
                <table>
                    <thead><tr><th>Producto</th><th style="text-align:right">Costo Total</th><th></th></tr></thead>
                    <tbody id="recipesListBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-fixed" style="display:none">
      <div class="card"><h2><span>ğŸ’¡ Gastos Fijos</span> <button class="btn btn-primary" onclick="addFixedRow()">+ Agregar</button></h2><table id="tableFixed"><thead><tr><th>Concepto</th><th width="150">Monto Mensual ($)</th><th width="50"></th></tr></thead><tbody></tbody></table><div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">ğŸ’¾ Guardar Cambios</button></div></div>
    </div>

    <div id="tab-production" style="display:none">
      <div class="card"><h2><span>ğŸ‘¨â€ğŸ³ Sueldos</span> <button class="btn btn-primary" onclick="addProdRow()">+ Agregar</button></h2><table id="tableProd"><thead><tr><th>Empleado / Concepto</th><th width="150">Total ($)</th><th width="50"></th></tr></thead><tbody></tbody></table><div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">ğŸ’¾ Guardar Cambios</button></div></div>
    </div>

  </main>
</div>

<div class="modal-overlay" id="modalRecipe">
    <div class="modal" style="max-width:600px">
        <h2>Gestor de Receta Final</h2>
        <p style="font-size:12px; color:#666; margin-bottom:15px"><b>Nota:</b> Usa el nombre EXACTO de venta (ej: "Morgan Doble"). Las papas, bolsas y cartones se descuentan automÃ¡ticamente.</p>
        
        <div style="background:#f0f7ff; padding:15px; border-radius:10px; border:1px solid #d0e4ff; margin-bottom:20px">
            <label style="font-weight:bold; font-size:12px">NOMBRE DEL PRODUCTO</label>
            <input type="text" id="recName" placeholder="Ej: Hamburguesa Doble" style="background:#fff; margin-bottom:10px;">
            
            <div style="display:flex; gap:10px; align-items:flex-end">
                <div style="flex:2">
                    <label style="font-size:11px">Agregar (Insumo o Item Armado)</label>
                    <select id="recIngSelect" style="background:#fff"></select>
                </div>
                <div style="flex:1">
                    <label style="font-size:11px">Cantidad</label>
                    <input type="number" id="recIngQty" placeholder="Ej: 1" step="0.001" style="background:#fff">
                </div>
                <button class="btn btn-primary" onclick="addItemToCurrentRecipe()">+</button>
            </div>

            <div id="currentRecipeList" class="ing-list"><div style="text-align:center; color:#999; font-size:12px">Agrega ingredientes...</div></div>
            <button class="btn btn-primary" style="width:100%; margin-top:10px" onclick="saveRecipe()">ğŸ’¾ Guardar Receta</button>
        </div>
        <button onclick="$('#modalRecipe').style.display='none'" class="btn" style="width:100%">Cerrar</button>
    </div>
</div>

<div class="modal-overlay" id="modalAlias"><div class="modal"><h3>ğŸ”— Armador de Combos/Promos</h3><div class="alias-builder"><div style="margin-bottom:10px"><label style="font-size:11px; font-weight:700; color:var(--primary)">Nombre Exacto en PedidosYa:</label><input type="text" id="aliasExt" placeholder="Ej: Super Promo Mundial 2x1" style="width:100%; border:1px solid #ccc; padding:8px; border-radius:4px;"></div><div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:6px; margin-bottom:10px"><label style="font-size:11px; font-weight:700; color:#333">Contenido del Combo:</label><div id="tempAliasItems" style="margin-bottom:10px; min-height:20px;"><div style="font-size:11px; color:#999; font-style:italic">Agrega Ã­tems abajo...</div></div><div style="display:flex; gap:5px;"><select id="aliasInt" style="flex:2"></select><input type="number" id="aliasQty" value="1" style="width:60px"><button class="btn btn-primary" onclick="addItemToAlias()">+</button></div></div><div style="text-align:right"><button class="btn btn-primary" onclick="saveAlias()">Guardar Combo</button></div></div><hr style="border:0; border-top:1px solid #eee; margin:20px 0"><h4 style="font-size:12px; text-transform:uppercase; color:#999">Combos Registrados</h4><table style="width:100%; font-size:12px"><thead><tr><th>Nombre Externo</th><th>Contenido</th><th></th></tr></thead><tbody id="aliasListBody"></tbody></table><div style="margin-top:15px; text-align:right"><button class="btn" onclick="$('#modalAlias').style.display='none'">Cerrar</button></div></div></div>

<div class="modal-overlay" id="modalProduct"><div class="modal"><h3 id="mpTitle">Nuevo Insumo</h3><input type="hidden" id="mpId"><div style="margin-bottom:10px"><label style="font-size:11px; color:#666">Nombre</label><input type="text" id="mpName"></div><div style="margin-bottom:10px"><label style="font-size:11px; color:#666">CategorÃ­a</label><select id="mpCat"><option value="carniceria">Carne</option><option value="panaderia">Pan</option><option value="almacen">AlmacÃ©n</option><option value="verdularia">Verdura</option><option value="salsas">Salsas</option><option value="packaging">Packaging</option></select></div><div style="background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #eee; margin-bottom:10px"><h4>ğŸ“¦ ConfiguraciÃ³n de Costo</h4><div style="display:flex; gap:10px; margin-bottom:10px"><div style="flex:1"><label style="font-size:11px; color:#666">Costo Compra</label><input type="number" id="mpPurchCost" step="0.01"></div><div style="flex:1"><label style="font-size:11px; color:#666">Formato</label><input type="text" id="mpFormat"></div></div><div style="display:flex; gap:10px"><div style="flex:1"><label style="font-size:11px; color:#666">Unidades que trae</label><input type="number" id="mpYield" step="0.001"></div><div style="flex:1"><label style="font-size:11px; color:#666">Unidad de Uso</label><select id="mpUnit"><option value="kg">Kg</option><option value="gr">Gr</option><option value="lt">Lt</option><option value="ml">Ml</option><option value="u">Unidad</option><option value="pq">Paquete</option></select></div></div><div style="margin-top:10px; text-align:right; font-size:12px">Costo Unitario Base: <strong id="calcUnitCost" style="color:var(--green)">$ 0</strong></div></div><div style="display:flex; gap:10px; margin-bottom:15px"><div style="flex:1"><label style="font-size:11px; color:#666">Stock</label><input type="number" id="mpQty" value="0" step="0.001"></div><div style="flex:1"><label style="font-size:11px; color:#666">MÃ­nimo</label><input type="number" id="mpMin" value="5" step="0.001"></div></div><div style="display:flex; gap:10px"><button class="btn btn-primary" style="flex:1" onclick="saveProduct()">Guardar</button><button class="btn" style="flex:1" onclick="$('#modalProduct').style.display='none'">Cancelar</button></div></div></div>
<div class="modal-overlay" id="modalPurchase"><div class="modal"><h3>ğŸ›’ Registrar Compra</h3><div style="margin-bottom:10px"><label>Insumo</label><select id="purProd"></select></div><div style="display:flex; gap:10px; margin-bottom:10px"><div><label>Cantidad</label><input type="number" id="purQty" step="0.001"></div><div><label>Total ($)</label><input type="number" id="purTotal"></div></div><div style="margin-bottom:15px"><label>Fecha</label><input type="date" id="purDate"></div><div style="display:flex; gap:10px"><button class="btn btn-primary" style="flex:1" onclick="confirmPurchase()">Confirmar</button><button class="btn" style="flex:1" onclick="$('#modalPurchase').style.display='none'">Cancelar</button></div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
Â  Â  const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
Â  Â  try { firebase.initializeApp(firebaseConfig); } catch(e) {}
Â  Â  const db = firebase.firestore();
Â  Â  const $ = s => document.querySelector(s);
Â  Â  const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:2});
Â  Â  const formatQty = (n) => { let num = Number(n); if(isNaN(num)) return '0'; return parseFloat(num.toFixed(3)); };
Â  Â Â 
Â  Â  const parseDate = (val) => {Â 
Â  Â  Â  Â  if(!val) return null;Â 
Â  Â  Â  Â  if(val.toDate) return val.toDate();Â 
Â  Â  Â  Â  if(val instanceof Date) return val;Â 
Â  Â  Â  Â  const d = new Date(val);
Â  Â  Â  Â  return isNaN(d.getTime()) ? null : d;
Â  Â  };

Â  Â  let INVENTORY=[], RAW_STOCK=[], PREMADE_STOCK=[], SUB_RECIPES=[], RECIPES=[], PURCHASES=[], ORDERS=[];
Â  Â  let FIXED_DATA = { fixed:[], prod:[], config:{taxDebit:0, taxTransf:0, taxQR:0}, aliases:[] };
Â  Â  let PRODUCTS_DB = {};Â 
Â  Â  let SIDES_CONFIG = {}; // Nueva variable para configuraciÃ³n de papas
Â  Â  let currentRecipeId = null, currentSubRecipeId = null;
Â  Â  let chartMain=null, chartDaily=null, chartProds=null, chartPayment=null;
Â  Â  let tempAliasList = [];
Â  Â  let currentRecipeIngs = [];

Â  Â  function logStatus(msg, isError=false) {
Â  Â  Â  Â  const el = $('#lastPurchasesList');
Â  Â  Â  Â  if(el) el.innerHTML = `<div style="padding:10px; color:${isError?'red':'#666'}; font-weight:600">${msg}</div>`;
Â  Â  }

Â  Â  // ==========================================
Â  Â  // 1. CARGA DE BASE DE DATOS Y CONFIG
Â  Â  // ==========================================
Â  Â  function loadProductsDB() {
Â  Â  Â  Â  // Cargar productos normales
Â  Â  Â  Â  db.collection('products').get().then(snap => {
Â  Â  Â  Â  Â  Â  PRODUCTS_DB = {};Â 
Â  Â  Â  Â  Â  Â  snap.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  const d = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const normName = d.name.toLowerCase().trim();
Â  Â  Â  Â  Â  Â  Â  Â  PRODUCTS_DB[normName] = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  realName: d.name,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category: d.category || 'otros'Â 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  checkLoadComplete();
Â  Â  Â  Â  });

Â  Â  Â  Â  // Cargar configuraciÃ³n de PAPAS (SIDES)
Â  Â  Â  Â  db.collection('config').doc('sides').get().then(doc => {
Â  Â  Â  Â  Â  Â  if(doc.exists) SIDES_CONFIG = doc.data();
Â  Â  Â  Â  Â  Â  checkLoadComplete();
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function checkLoadComplete() {
Â  Â  Â  Â  if(ORDERS.length) window.renderProportions();
Â  Â  }

Â  Â  // ==========================================
Â  Â  // ğŸ”¥ 2. LÃ“GICA DINÃMICA: DB + EXTRAS + PAPAS + CANALES
Â  Â  // ==========================================
Â  Â  window.renderProportions = function() {
Â  Â  Â  Â  const body = $('#proportionsBody');
Â  Â  Â  Â  if (!body) return;
Â  Â  Â  Â  body.innerHTML = '';

Â  Â  Â  Â  const stats = {};

Â  Â  Â  Â  // Helper para inicializar un item
Â  Â  Â  Â  function initStat(key, name, cat) {
Â  Â  Â  Â  Â  Â  if (!stats[key]) {
Â  Â  Â  Â  Â  Â  Â  Â  stats[key] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  category: cat || getCategory(name),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countSimple: 0, countDouble: 0, total: 0,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  web: 0, local: 0, py: 0
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // PASO 1: Llenar la tabla con TODO lo que hay en la base de datos (ventas = 0)
Â  Â  Â  Â  Object.keys(PRODUCTS_DB).forEach(key => {
Â  Â  Â  Â  Â  Â  const p = PRODUCTS_DB[key];
Â  Â  Â  Â  Â  Â  let statsKey = key.replace('simple', '').replace('doble', '').trim();
Â  Â  Â  Â  Â  Â  initStat(statsKey, p.realName.replace(/simple|doble/gi, '').trim(), p.category);
Â  Â  Â  Â  });

Â  Â  Â  Â  // PASO 1.5: Agregar PAPAS FRITAS segÃºn configuraciÃ³n (image_106fdd.png)
Â  Â  Â  Â  // Esto asegura que aparezcan aunque nadie las haya comprado
Â  Â  Â  Â  if (SIDES_CONFIG.con_sal) initStat("papas fritas con sal", "PorciÃ³n Papas Fritas (Con Sal)", "guarniciones");
Â  Â  Â  Â  if (SIDES_CONFIG.con_sazon) initStat("papas fritas sazonadas", "PorciÃ³n Papas Fritas (Sazonadas)", "guarniciones");
Â  Â  Â  Â  if (SIDES_CONFIG.sin_sal) initStat("papas fritas sin sal", "PorciÃ³n Papas Fritas (Sin Sal)", "guarniciones");
        initStat("medallon adicional", "MedallÃ³n adicional", "extras");
        initStat("cheddar adicional", "Cheddar adicional", "extras");
        initStat("bacon adicional", "Bacon adicional", "extras");


Â  Â  Â  Â  // Helper para categorizar
Â  Â  Â  Â  function getCategory(name) {
Â  Â  Â  Â  Â  Â  const n = name.toLowerCase();
Â  Â  Â  Â  Â  Â  const burgerNames = ["cheese", "bacon", "egg", "core", "morgan", "big", "john", "buena", "mala", "fea", "rhodes", "burguesa", "pollo", "crispy"];
Â  Â  Â  Â  Â  Â  if (burgerNames.some(b => n.includes(b))) return 'hamburguesas';
Â  Â  Â  Â  Â  Â  if(n.includes('coca')||n.includes('agua')||n.includes('andes')||n.includes('aquarius')||n.includes('sprite')) return 'bebidas';
Â  Â  Â  Â  Â  Â  if(n.includes('papas')||n.includes('nuggets')) return 'guarniciones';
Â  Â  Â  Â  Â  Â  if(n.includes('adicional')) return 'extras';
Â  Â  Â  Â  Â  Â  return 'otros';
Â  Â  Â  Â  }

Â  Â  Â  Â  // ğŸ”¥ Helper Actualizado: Limpia [corchetes] y normaliza
Â  Â  Â  Â  function cleanName(raw) {
Â  Â  Â  Â  Â  Â  let n = raw.toLowerCase().trim();
            // Eliminar contenido de corchetes y parÃ©ntesis
            n = n.replace(/\[.*?\]/g, "").replace(/\(.*?\)/g, "").trim();
            
Â  Â  Â  Â  Â  Â  n = n.replace('doble', '').replace('simple', '').trim();Â 
Â  Â  Â  Â  Â  Â  n = n.replace(/\s{2,}/g, ' ');
Â  Â  Â  Â  Â  Â  if(n === 'papas fritas') return 'porciÃ³n papas fritas';
Â  Â  Â  Â  Â  Â  if(n.includes('coca') && n.includes('original')) return 'coca-cola original 500ml';Â 
Â  Â  Â  Â  Â  Â  return n;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Helper para sumar
Â  Â  Â  Â  let totalGeneral = 0;
Â  Â  Â  Â  let grandTotalWeb = 0, grandTotalLocal = 0, grandTotalPY = 0;

Â  Â  Â  Â  function addToStats(key, niceName, qty, source, isDouble, cat) {
Â  Â  Â  Â  Â  Â  initStat(key, niceName, cat); // Se asegura que exista

Â  Â  Â  Â  Â  Â  stats[key].total += qty;
Â  Â  Â  Â  Â  Â  stats[key][source] += qty;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (stats[key].category === 'hamburguesas' || stats[key].category === 'Hamburguesas') {
Â  Â  Â  Â  Â  Â  Â  Â  if (isDouble) stats[key].countDouble += qty;
Â  Â  Â  Â  Â  Â  Â  Â  else stats[key].countSimple += qty;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  stats[key].countSimple += qty;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  totalGeneral += qty;
Â  Â  Â  Â  Â  Â  if(source==='web') grandTotalWeb += qty;
Â  Â  Â  Â  Â  Â  if(source==='local') grandTotalLocal += qty;
Â  Â  Â  Â  Â  Â  if(source==='py') grandTotalPY += qty;
Â  Â  Â  Â  }

Â  Â  Â  Â  // PASO 2: Procesar Pedidos
Â  Â  Â  Â  ORDERS.forEach(o => {
Â  Â  Â  Â  Â  Â  let source = 'local';
Â  Â  Â  Â  Â  Â  const srcRaw = String(o.source || '').toLowerCase();
Â  Â  Â  Â  Â  Â  if (srcRaw.includes('pedidosya')) source = 'py';
Â  Â  Â  Â  Â  Â  else if (srcRaw === 'web' || srcRaw === 'app') source = 'web';

Â  Â  Â  Â  Â  Â  (o.items || []).forEach(it => {
Â  Â  Â  Â  Â  Â  Â  Â  const qty = Number(it.qty || 1);
Â  Â  Â  Â  Â  Â  Â  Â  let rawName = it.name || "";
Â  Â  Â  Â  Â  Â  Â  Â  let n = rawName.toLowerCase().trim();
Â  Â  Â  Â  Â  Â  Â  Â Â 
                // ğŸ”¹ 1. DETECCIÃ“N DE EXTRAS DENTRO DE LOS CORCHETES (PedidosYa Style)
                // Ej: "Cheesebacon [1 feta de cheddar]"
                if (rawName.includes('[')) {
                    // Intentamos leer quÃ© hay adentro
                    try {
                        let match = rawName.match(/\[(.*?)\]/);
                        if (match && match[1]) {
                            let content = match[1].toLowerCase();
                            // Si encontramos palabras clave, sumamos al contador de extras
                            if (content.includes('cheddar')) addToStats("cheddar adicional", "Cheddar adicional", qty, source, false, 'extras');
                            if (content.includes('carne') || content.includes('medallon')) addToStats("medallon adicional", "MedallÃ³n adicional", qty, source, false, 'extras');
                            if (content.includes('bacon') || content.includes('panceta')) addToStats("bacon adicional", "Bacon adicional", qty, source, false, 'extras');
                        }
                    } catch(e) { console.log("Error leyendo extras", e); }
                }

Â  Â  Â  Â  Â  Â  Â  Â  // ğŸ”¹ 2. DETECCIÃ“N ESPECIAL DE PAPAS
Â  Â  Â  Â  Â  Â  Â  Â  let isSide = false;
Â  Â  Â  Â  Â  Â  Â  Â  let sideKey = "";
Â  Â  Â  Â  Â  Â  Â  Â  let sideName = "";

Â  Â  Â  Â  Â  Â  Â  Â  if (n.includes("sazonadas")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSide = true; sideKey = "papas fritas sazonadas"; sideName = "PorciÃ³n Papas Fritas (Sazonadas)";
Â  Â  Â  Â  Â  Â  Â  Â  } else if (n.includes("sin sal")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSide = true; sideKey = "papas fritas sin sal"; sideName = "PorciÃ³n Papas Fritas (Sin Sal)";
Â  Â  Â  Â  Â  Â  Â  Â  } else if (n === "papas" || n === "papas fritas" || n.includes("con sal") || n.includes("bastones")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // A veces se guardan solo como "Papas" -> Asumimos con sal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSide = true; sideKey = "papas fritas con sal"; sideName = "PorciÃ³n Papas Fritas (Con Sal)";
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (isSide) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  addToStats(sideKey, sideName, qty, source, false, "guarniciones");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Terminamos con este item si era papa
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // 3. CHEQUEO SI LA HAMBURGUESA TRAE PAPAS (Propiedad .fries)
Â  Â  Â  Â  Â  Â  Â  Â  if (it.fries) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let fProp = String(it.fries).toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let fKey = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let fName = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (fProp.includes("sazon")) { fKey="papas fritas sazonadas"; fName="PorciÃ³n Papas Fritas (Sazonadas)"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (fProp.includes("sin sal")) { fKey="papas fritas sin sal"; fName="PorciÃ³n Papas Fritas (Sin Sal)"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else { fKey="papas fritas con sal"; fName="PorciÃ³n Papas Fritas (Con Sal)"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(fKey) addToStats(fKey, fName, qty, source, false, "guarniciones");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // 4. Ãtem Normal (Burger, Bebida)
                // Usamos cleanName para borrar los corchetes [..] y que se agrupe bien
Â  Â  Â  Â  Â  Â  Â  Â  const isDouble = rawName.toLowerCase().includes('doble');
Â  Â  Â  Â  Â  Â  Â  Â  let baseName = cleanName(rawName);
Â  Â  Â  Â  Â  Â  Â  Â  let key = Object.keys(stats).find(k => k === baseName) || baseName;
Â  Â  Â  Â  Â  Â  Â  Â  let prettyName = stats[key] ? stats[key].name : (baseName.charAt(0).toUpperCase() + baseName.slice(1));

Â  Â  Â  Â  Â  Â  Â  Â  addToStats(key, prettyName, qty, source, isDouble, stats[key]?.category);

Â  Â  Â  Â  Â  Â  Â  Â  // 5. Extras (Propiedad del objeto - Web/Local)
Â  Â  Â  Â  Â  Â  Â  Â  if (it.extras) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let extraMeat = Number(it.extras.patty || it.extras.carne || it.extras.medallon || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (extraMeat > 0) addToStats("medallon adicional", "MedallÃ³n adicional", extraMeat * qty, source, false, 'extras');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let extraCheddar = Number(it.extras.cheddar || 0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (extraCheddar > 0) addToStats("cheddar adicional", "Cheddar adicional", extraCheddar * qty, source, false, 'extras');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  $('#totalItemsBadge').innerText = `Total Ãtems: ${totalGeneral}`;

Â  Â  Â  Â  // PASO 3: Ordenar y Renderizar
Â  Â  Â  Â  const catOrder = ['hamburguesas', 'bebidas', 'guarniciones', 'extras', 'otros'];
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sortedKeys = Object.values(stats).sort((a, b) => {
Â  Â  Â  Â  Â  Â  let catA = (a.category||'otros').toLowerCase();
Â  Â  Â  Â  Â  Â  let catB = (b.category||'otros').toLowerCase();
Â  Â  Â  Â  Â  Â  if(catA.includes('hamburguesa')) catA = 'hamburguesas';
Â  Â  Â  Â  Â  Â  if(catB.includes('hamburguesa')) catB = 'hamburguesas';
Â  Â  Â  Â  Â  Â  const rankA = catOrder.indexOf(catA) === -1 ? 99 : catOrder.indexOf(catA);
Â  Â  Â  Â  Â  Â  const rankB = catOrder.indexOf(catB) === -1 ? 99 : catOrder.indexOf(catB);
Â  Â  Â  Â  Â  Â  if (rankA !== rankB) return rankA - rankB;
Â  Â  Â  Â  Â  Â  return a.name.localeCompare(b.name);
Â  Â  Â  Â  });

Â  Â  Â  Â  let currentCat = null;

Â  Â  Â  Â  sortedKeys.forEach(s => {
Â  Â  Â  Â  Â  Â  let displayCat = (s.category || 'OTROS').toUpperCase();
Â  Â  Â  Â  Â  Â  if (displayCat !== currentCat) {
Â  Â  Â  Â  Â  Â  Â  Â  currentCat = displayCat;
Â  Â  Â  Â  Â  Â  Â  Â  body.insertAdjacentHTML('beforeend', `<tr><td colspan="7" class="cat-header">${currentCat}</td></tr>`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const isZero = s.total === 0;
Â  Â  Â  Â  Â  Â  const rowStyle = isZero ? 'color:#cbd5e1;' : '';
Â  Â  Â  Â  Â  Â  const zeroStyle = 'color:#e2e8f0; font-size:11px;';
Â  Â  Â  Â  Â  Â  const pctClass = isZero ? '' : 'pct-tag';

Â  Â  Â  Â  Â  Â  const pctWeb = grandTotalWeb > 0 ? ((s.web / grandTotalWeb) * 100).toFixed(1) + '%' : '-';
Â  Â  Â  Â  Â  Â  const pctLocal = grandTotalLocal > 0 ? ((s.local / grandTotalLocal) * 100).toFixed(1) + '%' : '-';
Â  Â  Â  Â  Â  Â  const pctPY = grandTotalPY > 0 ? ((s.py / grandTotalPY) * 100).toFixed(1) + '%' : '-';

Â  Â  Â  Â  Â  Â  let simpleCell = `<td style="text-align:center;">${s.countSimple}</td>`;
Â  Â  Â  Â  Â  Â  let doubleCell = `<td style="text-align:center; color:#b91c1c; font-weight:600; background:#fffafb">${s.countDouble}</td>`;

Â  Â  Â  Â  Â  Â  if (!displayCat.includes('HAMBURGUESA')) {
Â  Â  Â  Â  Â  Â  Â  Â  doubleCell = `<td style="text-align:center; color:#e2e8f0">-</td>`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  simpleCell = `<td style="text-align:center; color:${isZero?'#ccc':'#555'}">${s.total}</td>`;Â 
Â  Â  Â  Â  Â  Â  } else if (isZero) {
Â  Â  Â  Â  Â  Â  Â  Â  simpleCell = `<td style="text-align:center;">-</td>`;
Â  Â  Â  Â  Â  Â  Â  Â  doubleCell = `<td style="text-align:center;">-</td>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  body.insertAdjacentHTML('beforeend', `
Â  Â  Â  Â  Â  Â  Â  Â  <tr style="${rowStyle}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:700; border-right:1px solid #e2e8f0; position:sticky; left:0; background:white; z-index:5">${s.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${simpleCell}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${doubleCell}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; font-weight:800; background:#fffbeb; border-right:2px solid #e2e8f0; color:#78350f">${s.total}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; background:#eff6ff; ${s.web===0?zeroStyle:''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.web > 0 ? `<span style="color:#1e40af; font-weight:700">${s.web}</span> <span class="${pctClass}">(${pctWeb})</span>` : '-'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; background:#f8fafc; ${s.local===0?zeroStyle:''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.local > 0 ? `<span style="color:#334155; font-weight:700">${s.local}</span> <span class="${pctClass}">(${pctLocal})</span>` : '-'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="text-align:center; background:#fef2f2; ${s.py===0?zeroStyle:''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${s.py > 0 ? `<span style="color:#dc2626; font-weight:700">${s.py}</span> <span class="${pctClass}">(${pctPY})</span>` : '-'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `);
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // --- CARGADORES UNIFICADOS ---
Â  Â  window.loadInventory = function() {
Â  Â  Â  Â  db.collection('inventory').orderBy('name').onSnapshot(snap => {
Â  Â  Â  Â  Â  Â  RAW_STOCK = snap.docs.map(d => ({id:d.id, ...d.data(), isSub: false}));
Â  Â  Â  Â  Â  Â  window.combineAndRender();
Â  Â  Â  Â  });
Â  Â  Â  Â  db.collection('subrecipes').onSnapshot(snap => {
Â  Â  Â  Â  Â  Â  SUB_RECIPES = snap.docs.map(d => ({id:d.id, ...d.data()}));Â 
Â  Â  Â  Â  Â  Â  PREMADE_STOCK = snap.docs.map(d => ({
Â  Â  Â  Â  Â  Â  Â  Â  id: d.id, ...d.data(), category: 'ğŸ§© Armado', isSub: true,
Â  Â  Â  Â  Â  Â  Â  Â  unit: 'u', qty: d.data().qty || 0, min: d.data().min || 0
Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  window.combineAndRender();
Â  Â  Â  Â  });
Â  Â  };

Â  Â  window.combineAndRender = function() {
Â  Â  Â  Â  INVENTORY = [...RAW_STOCK, ...PREMADE_STOCK];
Â  Â  Â  Â  window.renderStockTable(); window.renderCostTables();
Â  Â  Â  Â  window.renderRecipesList(); window.renderSubRecipesList();
Â  Â  };

Â  Â  window.loadRecipes = function() { db.collection('recipes').onSnapshot(snap => { RECIPES=snap.docs.map(d=>({id:d.id,...d.data()})); window.renderRecipesList(); }); };
Â  Â  window.loadFixedData = function() {Â 
Â  Â  Â  Â  db.collection('config').doc('gerencia').onSnapshot(doc => {
Â  Â  Â  Â  Â  Â  if(doc.exists) FIXED_DATA = doc.data();
Â  Â  Â  Â  Â  Â  if(!FIXED_DATA.fixed) FIXED_DATA.fixed=[]; if(!FIXED_DATA.prod) FIXED_DATA.prod=[];
Â  Â  Â  Â  Â  Â  if(!FIXED_DATA.aliases) FIXED_DATA.aliases = [];
Â  Â  Â  Â  Â  Â  $('#confDebit').value = FIXED_DATA.config?.taxDebit||0;
Â  Â  Â  Â  Â  Â  $('#confTransf').value = FIXED_DATA.config?.taxTransf||0; $('#confQR').value = FIXED_DATA.config?.taxQR||0;
Â  Â  Â  Â  Â  Â  window.renderFixedTables();
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // STOCK MEJORADO
Â  Â  window.renderStockTable = function() {
Â  Â  Â  Â  const t = $('#searchStock').value.toLowerCase();Â 
Â  Â  Â  Â  const c = $('#filterCat').value;
Â  Â  Â  Â  const b = $('#stockTableBody');Â 
Â  Â  Â  Â  b.innerHTML='';

Â  Â  Â  Â  INVENTORY.filter(p => (p.name||"").toLowerCase().includes(t) && (c==='all'||p.category===c)).forEach(p => {
Â  Â  Â  Â  Â  Â  let stHtml = `<span class="status-dot st-ok"></span>OK`;
Â  Â  Â  Â  Â  Â  if(p.qty <= p.min) stHtml=`<span class="status-dot st-danger"></span>CRIT`;Â 
Â  Â  Â  Â  Â  Â  else if(p.qty <= p.min*1.5) stHtml=`<span class="status-dot st-warn"></span>BAJO`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let actions = `<button class="btn-icon" onclick="openProductModal('${p.id}')">âœï¸</button><button class="btn-icon" onclick="deleteItem('inventory','${p.id}')">ğŸ—‘ï¸</button>`;
Â  Â  Â  Â  Â  Â  if(p.isSub) actions = `<button class="btn-icon" onclick="openSubRecipeEditor('${p.id}')">ğŸ§©</button><button class="btn-icon" onclick="deleteItem('subrecipes','${p.id}')">ğŸ—‘ï¸</button>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  b.insertAdjacentHTML('beforeend', `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><b>${p.name}</b></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><small style="background:#f1f5f9; padding:2px 6px; border-radius:4px; border:1px solid #e2e8f0">${p.category}</small></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="qty-control">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="qty-btn" onclick="updStock('${p.id}', -1)">-</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="qty-input" value="${formatQty(p.qty)}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onchange="setStockDirect('${p.id}', this.value)"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â step="0.001">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="qty-btn" onclick="updStock('${p.id}', 1)">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="margin-left:5px; color:#94a3b8; font-size:10px">${p.unit}</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${p.min}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${stHtml}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${actions}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `);
Â  Â  Â  Â  });
Â  Â  };

Â  Â  window.setStockDirect = async (id, val) => {
Â  Â  Â  Â  const item = INVENTORY.find(i => i.id === id); if(!item) return;
Â  Â  Â  Â  const newQty = Number(val);Â 
Â  Â  Â  Â  const col = item.isSub ? 'subrecipes' : 'inventory';
Â  Â  Â  Â  await db.collection(col).doc(id).update({ qty: newQty });
Â  Â  };

Â  Â  window.updStock = (id, v) => {
Â  Â  Â  Â  const item = INVENTORY.find(i => i.id === id); if(!item) return;
Â  Â  Â  Â  const newQty = Number(item.qty || 0) + v;
Â  Â  Â  Â  window.setStockDirect(id, newQty);
Â  Â  };

Â  Â  // RECETAS Y SUBRECETAS
Â  Â  window.openRecipeModal = function(id) {
Â  Â  Â  Â  $('#modalRecipe').style.display = 'flex'; $('#recName').value = ''; $('#recIngQty').value = ''; currentRecipeIngs = [];
Â  Â  Â  Â  const s = $('#recIngSelect'); s.innerHTML = '<option value="">Seleccionar...</option>';
Â  Â  Â  Â  if(SUB_RECIPES.length) { s.insertAdjacentHTML('beforeend', '<optgroup label="ğŸ§© Armado">'); SUB_RECIPES.forEach(sub => s.insertAdjacentHTML('beforeend', `<option value="${sub.id}">ğŸ§© ${sub.name}</option>`)); s.insertAdjacentHTML('beforeend', '</optgroup>'); }
Â  Â  Â  Â  s.insertAdjacentHTML('beforeend', '<optgroup label="ğŸ“¦ Insumos">'); RAW_STOCK.sort((a,b)=>a.name.localeCompare(b.name)).forEach(i => s.insertAdjacentHTML('beforeend', `<option value="${i.id}">${i.name} (${i.unit})</option>`)); s.insertAdjacentHTML('beforeend', '</optgroup>');
Â  Â  Â  Â  if(id) { const r = RECIPES.find(x => x.id === id); if(r) { $('#recName').value = r.id; currentRecipeIngs = [...r.ingredients]; } }
Â  Â  Â  Â  window.renderCurrentRecipeList();
Â  Â  };

Â  Â  window.addItemToCurrentRecipe = function() {
Â  Â  Â  Â  const id = $('#recIngSelect').value; const qty = Number($('#recIngQty').value); if(!id || qty <= 0) return alert("Error");
Â  Â  Â  Â  const item = INVENTORY.find(i => i.id === id);
Â  Â  Â  Â  currentRecipeIngs.push({ id: id, qty: qty, _name: item ? (item.isSub ? `ğŸ§© ${item.name}` : item.name) : "???" });
Â  Â  Â  Â  window.renderCurrentRecipeList(); $('#recIngQty').value = '';
Â  Â  };

Â  Â  window.renderCurrentRecipeList = function() {
Â  Â  Â  Â  const c = $('#currentRecipeList'); c.innerHTML = '';
Â  Â  Â  Â  currentRecipeIngs.forEach((item, idx) => {
Â  Â  Â  Â  Â  Â  if(!item._name) { const i = INVENTORY.find(x => x.id === item.id); item._name = i ? (i.isSub ? `ğŸ§© ${i.name}` : i.name) : "???"; }
Â  Â  Â  Â  Â  Â  c.insertAdjacentHTML('beforeend', `<div class="ing-item"><span><b>${item.qty}</b> x ${item._name}</span> <button style="color:red;border:none;cursor:pointer" onclick="currentRecipeIngs.splice(${idx},1);window.renderCurrentRecipeList()">Ã—</button></div>`);
Â  Â  Â  Â  });
Â  Â  };

Â  Â  window.saveRecipe = async function() {
Â  Â  Â  Â  const name = $('#recName').value.trim(); if(!name || !currentRecipeIngs.length) return alert("Falta info");
Â  Â  Â  Â  await db.collection('recipes').doc(name).set({ ingredients: currentRecipeIngs.map(i => ({ id: i.id, qty: i.qty })) });
Â  Â  Â  Â  alert("Guardado"); $('#modalRecipe').style.display = 'none';
Â  Â  };

Â  Â  window.renderRecipesList = function() { $('#recipesListBody').innerHTML = RECIPES.map(r => `<tr><td>${r.id}</td><td style="text-align:right"><b>${money(window.calculateRecipeTotal(r))}</b></td><td style="text-align:right"><button class="btn-icon" onclick="openRecipeModal('${r.id}')">âœï¸</button><button class="btn-icon" onclick="deleteItem('recipes','${r.id}')">ğŸ—‘ï¸</button></td></tr>`).join(''); };

Â  Â  // DASHBOARD & DATA
Â  Â  window.loadDashboardData = function() {
Â  Â  Â  Â  // Obtenemos la fecha de CUALQUIERA de los dos pickers (siempre estÃ¡n sincronizados)
Â  Â  Â  Â  const dateVal = $('#monthPicker').value;Â 
Â  Â  Â  Â  if(!dateVal) return;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  $('#ordersTitle').innerText = 'ğŸ§¾ Pedidos de ' + dateVal; logStatus("ğŸ”„ Cargando...");
Â  Â  Â  Â  const [y, m] = dateVal.split('-').map(Number); const start = new Date(y, m - 1, 1); const end = new Date(y, m, 0, 23, 59, 59);
Â  Â  Â  Â  db.collection('orders').limit(500).get().then(snap => {Â 
Â  Â  Â  Â  Â  Â  Â  const rawOrders = snap.docs.map(d => ({id:d.id, ...d.data()}));
Â  Â  Â  Â  Â  Â  Â  ORDERS = rawOrders.filter(o => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  if(o.status === 'cancelled') return false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  const d = parseDate(o.createdAt); return d && d >= start && d <= end;
Â  Â  Â  Â  Â  Â  Â  }).sort((a,b) => parseDate(b.createdAt) - parseDate(a.createdAt));
Â  Â  Â  Â  Â  Â  Â  logStatus(`âœ… Cargado: ${ORDERS.length} pedidos.`);
Â  Â  Â  Â  Â  Â  Â  window.calculateAll(); window.renderOrdersTab();Â 
Â  Â  Â  Â  Â  }).catch(err => { console.error(err); logStatus("âŒ Error cargando: " + err.message, true); });
Â  Â  Â  Â  db.collection('purchases').limit(500).get().then(snap=>{ PURCHASES=snap.docs.map(d=>d.data()); });
Â  Â  };

Â  Â  // FunciÃ³n para sincronizar fechas
Â  Â  window.changeDate = function(val) {
Â  Â  Â  Â  if(!val) return;
Â  Â  Â  Â  $('#monthPicker').value = val;
Â  Â  Â  Â  $('#monthPickerProp').value = val;
Â  Â  Â  Â  window.loadDashboardData();
Â  Â  };

Â  Â  window.calculateAll = function() {
Â  Â  Â  Â  if(typeof Chart === 'undefined') return;
Â  Â  Â  Â  let gross=0, comms=0, taxes=0, theoCMV=0;
Â  Â  Â  Â  const { taxDebit:pctDebit, taxTransf:pctTransf, taxQR:pctQR, pyPercent:pctPy } = FIXED_DATA.config || {};
Â  Â  Â  Â  let dailySales = {}, productSales = {}, paymentStats = { 'Efectivo':0, 'Transferencia':0, 'MercadoPago/QR':0, 'PedidosYa':0, 'Otros':0 };

Â  Â  Â  Â  ORDERS.forEach(o => {
Â  Â  Â  Â  Â  Â  const sale = Number(o.total || 0); gross += sale;
Â  Â  Â  Â  Â  Â  let pay = String(o.pago||o.paymentMethod||'').toLowerCase(); let finalPayMethod = 'Otros';
Â  Â  Â  Â  Â  Â  if(String(o.source||'').toLowerCase().includes('pedidosya')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â finalPayMethod = 'PedidosYa';
Â  Â  Â  Â  Â  Â  Â  Â  Â comms += (o.neto_excel > 0) ? (sale - o.neto_excel) : (sale * ((pctPy||30)/100));
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if(pay.includes('mercado')||pay.includes('mp')||pay.includes('qr')) { taxes += (sale*(pctQR/100)); finalPayMethod='MercadoPago/QR'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if(pay.includes('transfer')) { taxes += (sale*(pctTransf/100)); finalPayMethod='Transferencia'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if(pay.includes('debito')||pay.includes('tarjeta')) { taxes += (sale*(pctDebit/100)); finalPayMethod='Otros'; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else finalPayMethod='Efectivo';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  (o.items||[]).forEach(item => { theoCMV += (window.getUnitCost(item.name) * Number(item.qty||1)); productSales[item.name] = (productSales[item.name] || 0) + Number(item.qty||1); });
Â  Â  Â  Â  Â  Â  theoCMV += window.calculateOrderConsumables(o.items||[]);
Â  Â  Â  Â  Â  Â  const dObj = parseDate(o.createdAt); if(dObj) dailySales[dObj.getDate()] = (dailySales[dObj.getDate()] || 0) + sale;
Â  Â  Â  Â  Â  Â  paymentStats[finalPayMethod] += sale;
Â  Â  Â  Â  });

Â  Â  Â  Â  const totalFixed = (FIXED_DATA.fixed||[]).reduce((s,i)=>s+Number(i.cost),0);Â 
Â  Â  Â  Â  const totalSalaries = (FIXED_DATA.prod||[]).reduce((s,i)=>s+Number(i.cost),0);
Â  Â  Â  Â  const variableCosts = comms + taxes;
Â  Â  Â  Â  const realPurchases = PURCHASES.reduce((s,p)=>s+Number(p.total),0);
Â  Â  Â  Â  const profitReal = gross - (realPurchases + totalFixed + totalSalaries + variableCosts);

Â  Â  Â  Â  $('#kpiSales').innerText = money(gross); $('#kpiTheoCMV').innerText = '-' + money(theoCMV); $('#kpiTotalExpenses').innerText = '-' + money(realPurchases + totalFixed + totalSalaries + variableCosts);
Â  Â  Â  Â  const kn = $('#kpiNet'); kn.innerText = money(profitReal);
Â  Â  Â  Â  kn.className = profitReal >= 0 ? 'kpi-val text-green' : 'kpi-val text-red'; $('#kpiNetContainer').style.backgroundColor = profitReal >= 0 ? '#f0fdf4' : '#fef2f2';

Â  Â  Â  Â  if(chartMain) chartMain.destroy();
Â  Â  Â  Â  chartMain = new Chart($('#mainChart').getContext('2d'), { type:'bar', data:{ labels:['Ventas','MercaderÃ­a','Fijos','Sueldos','Var','Balance'], datasets:[{data:[gross,realPurchases,totalFixed,totalSalaries,variableCosts,profitReal], backgroundColor:['#64748b','#f97316','#a855f7','#3b82f6','#eab308',profitReal>=0?'#10b981':'#ef4444'], borderRadius:6}] }, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}} });
Â  Â  Â  Â  window.renderExtraCharts(dailySales, productSales, paymentStats);
Â  Â  Â  Â Â 
Â  Â  Â  Â  window.renderProportions();
Â  Â  };

Â  Â  window.renderExtraCharts = function(dailyData, prodData, payData) {
Â  Â  Â  Â  if(chartDaily) chartDaily.destroy();
Â  Â  Â  Â  const days = Object.keys(dailyData).sort((a,b)=>Number(a)-Number(b));
Â  Â  Â  Â  chartDaily = new Chart($('#dailyChart').getContext('2d'), { type: 'line', data: { labels: days, datasets: [{ label:'Venta', data: days.map(d=>dailyData[d]), borderColor:'var(--primary)', tension:0.3, fill:true, backgroundColor:'rgba(98,90,69,0.1)' }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} } });
Â  Â  Â  Â  if(chartProds) chartProds.destroy();
Â  Â  Â  Â  const sortedProds = Object.entries(prodData).sort((a,b)=>b[1]-a[1]).slice(0,5);
Â  Â  Â  Â  chartProds = new Chart($('#topProductsChart').getContext('2d'), { type: 'doughnut', data: { labels: sortedProds.map(x=>x[0]), datasets: [{ data: sortedProds.map(x=>x[1]), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{boxWidth:10, font:{size:10}}}} } });
Â  Â  Â  Â  if(chartPayment) chartPayment.destroy();
Â  Â  Â  Â  chartPayment = new Chart($('#paymentChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(payData), datasets: [{ data: Object.values(payData), backgroundColor: ['#10b981','#3b82f6','#06b6d4','#ef4444','#64748b'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'right', labels:{boxWidth:10, font:{size:10}}}} } });
Â  Â  }

Â  Â  // TABLA PEDIDOS
Â  Â  window.renderOrdersTab = function() {
Â  Â  Â  Â  const tbody = $('#ordersTableBody'); tbody.innerHTML = '';
Â  Â  Â  Â  if(ORDERS.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#999;">No hay pedidos</td></tr>'; return; }
Â  Â  Â  Â  const { taxDebit:pctDebit, taxTransf:pctTransf, taxQR:pctQR, pyPercent:pctPy } = FIXED_DATA.config || {};
Â  Â  Â  Â  ORDERS.forEach((o, index) => {
Â  Â  Â  Â  Â  Â  const total = Number(o.total || 0); let deduction = 0;
Â  Â  Â  Â  Â  Â  if(String(o.source).includes('pedidosya')) deduction = (o.neto_excel > 0) ? (total - o.neto_excel) : (total * ((pctPy||30)/100));
Â  Â  Â  Â  Â  Â  else if(String(o.pago).includes('mercado') || String(o.pago).includes('qr')) deduction = total * (pctQR/100);
Â  Â  Â  Â  Â  Â  else if(String(o.pago).includes('transfer')) deduction = total * (pctTransf/100);
Â  Â  Â  Â  Â  Â  else if(String(o.pago).includes('debito')) deduction = total * (pctDebit/100);
Â  Â  Â  Â  Â  Â  let orderCost = window.calculateOrderConsumables(o.items||[]); (o.items||[]).forEach(item => orderCost += (window.getUnitCost(item.name) * Number(item.qty||1)));
Â  Â  Â  Â  Â  Â  let profit = total - deduction - orderCost;
Â  Â  Â  Â  Â  Â  let dStr = '-'; const dt = parseDate(o.createdAt); if(dt) dStr = dt.toLocaleString('es-AR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
Â  Â  Â  Â  Â  Â  tbody.innerHTML += `<tr class="order-row" onclick="document.getElementById('detail-${index}').classList.toggle('open')"><td>${dStr}</td><td>${o.nombre||'Cliente'}</td><td><span class="badge ${String(o.source).includes('pedidosya')?'bdg-py':'bdg-web'}">${o.source||'web'}</span></td><td><span class="badge bdg-cash">${o.pago||'efectivo'}</span></td><td style="font-weight:700">${money(total)}</td><td style="font-weight:700; color:${profit>=0?'var(--green)':'var(--red)'}">${money(profit)}</td><td>â–¼</td></tr><tr class="order-details" id="detail-${index}"><td colspan="7" style="padding:10px; background:#f9fafb"><div style="font-size:12px"><b>Items:</b> ${(o.items||[]).map(i=>i.qty+'x '+i.name).join(', ')}<br><b>Ganancia Real:</b> ${money(profit)}</div></td></tr>`;
Â  Â  Â  Â  });
Â  Â  };
Â  Â Â 
Â  Â  // CALCULADORA DE COSTOS
Â  Â  window.calculateOrderConsumables = function(items) {
Â  Â  Â  Â  let totalCost = 0, burgerCount = 0, countSazon = 0;
Â  Â  Â  Â  items.forEach(i => {
Â  Â  Â  Â  Â  Â  const n = String(i.name||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); const qty = Math.ceil(Number(i.qty||1));
Â  Â  Â  Â  Â  Â  if(n.includes('hamb')||n.includes('burger')||n.includes('doble')||n.includes('simple')||n.includes('royal')||n.includes('cheese')||n.includes('cuarto')||n.includes('big')) {
Â  Â  Â  Â  Â  Â  Â  Â  burgerCount += qty; if(n.includes('dorito')) countSazon += qty;
Â  Â  Â  Â  Â  Â  Â  Â  const unitCost = window.getUnitCost(i.name);
Â  Â  Â  Â  Â  Â  Â  Â  if (unitCost === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let patties = 1; if(n.includes('doble')) patties = 2; if(n.includes('triple')) patties = 3;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pattyItem = INVENTORY.find(x => x.name.toLowerCase().includes('medallon') || x.name.toLowerCase().includes('patty'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(pattyItem) totalCost += (pattyItem.cost * patties * qty);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  if(burgerCount === 0) return 0;
Â  Â  Â  Â  const getCost = (keys) => { const item = INVENTORY.find(p => keys.some(k => String(p.name).toLowerCase().includes(k))); return item ? Number(item.cost || 0) : 0; };
Â  Â  Â  Â  totalCost += (burgerCount * 0.200) * getCost(['papas fritas', 'papa frita', 'papas']);
Â  Â  Â  Â  totalCost += burgerCount * getCost(['carton', 'caja papa']); totalCost += burgerCount * getCost(['parafinado', 'papel']);
Â  Â  Â  Â  const bolsas = Math.ceil(burgerCount / 2); totalCost += bolsas * getCost(['bolsa', 'packaging']); totalCost += (bolsas * 3) * getCost(['ganchito']);
Â  Â  Â  Â  totalCost += (burgerCount + bolsas) * 0.25 * getCost(['tinta', 'sello']);
Â  Â  Â  Â  if(countSazon > 0) totalCost += (countSazon * 0.005) * getCost(['dorito', 'polvo']);
Â  Â  Â  Â  return totalCost;
Â  Â  };

Â  Â  window.getUnitCost = function(n) { if(!n) return 0; const cn=n.toLowerCase().trim(), a=(FIXED_DATA.aliases||[]).find(x=>x.external.toLowerCase()===cn); if(a) return a.items?a.items.reduce((s,i)=>{const r=RECIPES.find(x=>x.id===i.id);return s+(r?window.calculateRecipeTotal(r)*i.qty:0)},0):(RECIPES.find(x=>x.id===a.internal)?window.calculateRecipeTotal(RECIPES.find(x=>x.id===a.internal)):0); let r=RECIPES.find(x=>x.id.toLowerCase()===cn)||RECIPES.find(x=>cn.includes(x.id.toLowerCase())); return r?window.calculateRecipeTotal(r):0; };
Â  Â  window.calculateRecipeTotal = (r) => (r.ingredients||[]).reduce((s,i)=>{ const item = INVENTORY.find(x => x.id === i.id); return s + (item ? (i.qty * (item.isSub ? window.calculateSubRecipeCost(SUB_RECIPES.find(x=>x.id===i.id)||{ingredients:[]}) : item.cost)) : 0); },0);
Â  Â  window.calculateSubRecipeCost = (sb) => (sb.ingredients||[]).reduce((s,i)=>{ const it = INVENTORY.find(x => x.id === i.id); return s + (i.qty * (it ? it.cost : 0)); },0);
Â  Â Â 
Â  Â  // UI HELPERS
Â  Â  window.renderCostTables = function() { const rr=(a,t)=>{ $(t).innerHTML=a.map(p=>`<tr><td><b>${p.name}</b></td><td>$${p.purchCost||p.cost}</td><td><small>${p.format||'u'}</small></td><td>${p.yield||1} ${p.unit}</td><td style="font-weight:700;color:#166534">${money(p.cost)}</td><td><button class="btn-icon" onclick="openProductModal('${p.id}')">âœ</button> <button class="btn-icon" onclick="deleteItem('inventory','${p.id}')">ğŸ—‘ï¸</button></td></tr>`).join(''); }; rr(INVENTORY.filter(p=>p.category!=='packaging' && !p.isSub),'#costMateriaBody'); rr(INVENTORY.filter(p=>p.category==='packaging'),'#costPackBody'); };
Â  Â  window.renderSubRecipesList = function(f="") { const c=$('#subRecipesListBody'), cf=f.toLowerCase(); c.innerHTML=SUB_RECIPES.filter(s=>s.name.toLowerCase().includes(cf)).map(s=>`<div onclick="openSubRecipeEditor('${s.id}')" style="padding:15px;cursor:pointer;border-bottom:1px solid #f1f5f9;${s.id===currentSubRecipeId?'background:#f8fafc;border-left:3px solid var(--purple)':''}"><div style="font-weight:600;font-size:13px">${s.name}</div><div style="font-size:12px;color:var(--purple);font-weight:700">${money(window.calculateSubRecipeCost(s))}</div></div>`).join('')||'<div style="padding:20px;text-align:center;color:#ccc;font-size:12px">No hay items</div>'; };
Â  Â  window.updateUnitSelect = function(m) { const s=m==='sub'?$('#newSubUnit'):$('#newRecUnit'), p=INVENTORY.find(i=>i.id===(m==='sub'?$('#newSubIng').value:$('#newRecIng').value)); if(!s)return; let h='<option value="1">Unidad</option>'; if(p){const u=(p.unit||'').toLowerCase(); if(u.includes('k')) h='<option value="1">Kg</option><option value="0.001">Gr</option>'; else if(u.includes('l')) h='<option value="1">Lt</option><option value="0.001">Ml</option>'; else if(u.includes('m')) h='<option value="1">Mts</option><option value="0.01">Cm</option>'; else if(u.includes('g')) h='<option value="1">Gr</option><option value="1000">Kg</option>';} s.innerHTML=h; };
Â  Â Â 
Â  Â  // MODALES Y ABM
Â  Â  window.openProductModal = function(id, cat) { $('#modalProduct').style.display='flex'; if(id && typeof id==='string'){ const p=INVENTORY.find(i=>i.id===id); $('#mpTitle').innerText='Editar'; $('#mpId').value=id; $('#mpName').value=p.name; $('#mpCat').value=p.category; $('#mpQty').value=p.qty; $('#mpUnit').value=p.unit; $('#mpPurchCost').value=p.purchCost||p.cost; $('#mpFormat').value=p.format||''; $('#mpYield').value=p.yield||1; $('#mpMin').value=p.min||5; } else { $('#mpTitle').innerText='Nuevo'; $('#mpId').value=''; $('#mpName').value=''; $('#mpQty').value=0; $('#mpPurchCost').value=0; $('#mpYield').value=1; if(cat)$('#mpCat').value=cat; } };
Â  Â  window.saveProduct = async function() { const id=$('#mpId').value, pc=Number($('#mpPurchCost').value), y=Number($('#mpYield').value); const d={name:$('#mpName').value, category:$('#mpCat').value, qty:Number($('#mpQty').value), unit:$('#mpUnit').value, purchCost:pc, format:$('#mpFormat').value, yield:y, min:Number($('#mpMin').value), cost:y>0?pc/y:0}; if(!d.name)return; id?await db.collection('inventory').doc(id).update(d):await db.collection('inventory').add(d); $('#modalProduct').style.display='none'; };
Â  Â  window.openPurchaseModal = function() { $('#modalPurchase').style.display='flex'; $('#purProd').innerHTML=INVENTORY.map(p=>`<option value="${p.id}">${p.name} (${formatQty(p.qty)})</option>`).join(''); $('#purQty').value=''; $('#purTotal').value=''; };
Â  Â  window.confirmPurchase = async function() { const pid=$('#purProd').value, q=Number($('#purQty').value), t=Number($('#purTotal').value), d=$('#purDate').value; if(!pid||q<=0)return; await db.collection('purchases').add({prodId:pid, qty:q, total:t, date:d, prodName:INVENTORY.find(i=>i.id===pid)?.name}); const p=INVENTORY.find(i=>i.id===pid); if(p) { const col=p.isSub?'subrecipes':'inventory'; await db.collection(col).doc(pid).update({qty:Number(p.qty)+q}); } alert("Registrado"); $('#modalPurchase').style.display='none'; window.loadDashboardData(); };
Â  Â  window.addNewSubRecipe = async function() { const n=prompt("Nombre:"); if(n) await db.collection('subrecipes').add({name:n, ingredients:[], qty:0}); };
Â  Â  window.addNewRecipe = async function() { const n=prompt("Nombre:"); if(n) await db.collection('recipes').doc(n).set({ingredients:[]}); };
Â  Â  window.openSubRecipeEditor = function(id) { currentSubRecipeId=id; $('#subRecipeEditor').style.display='flex'; $('#subRecipeEmpty').style.display='none'; window.renderSubRecipesList(); const s=SUB_RECIPES.find(x=>x.id===id); $('#subEditorTitle').innerText=s.name; $('#newSubIng').innerHTML=INVENTORY.filter(i=>!i.isSub).map(i=>`<option value="${i.id}">${i.name} ($${parseFloat(i.cost).toFixed(2)})</option>`).join(''); window.updateUnitSelect('sub'); let tc=0; $('#subRecipeIngBody').innerHTML=(s.ingredients||[]).map((ing,i)=>{ const it=INVENTORY.find(x=>x.id===ing.id), c=(it?Number(it.cost):0)*Number(ing.qty); tc+=c; return `<tr><td>${it?it.name:'?'}</td><td>${formatQty(ing.qty)}</td><td>${money(it?it.cost:0)}</td><td>${money(c)}</td><td><button class="btn-icon" onclick="removeSubIng('${id}',${i})">ğŸ—‘ï¸</button></td></tr>`; }).join(''); $('#subEditorTotalCost').innerText=money(tc); };
Â  Â  window.addIngToSubRecipe = async function() { const id=$('#newSubIng').value, q=Number($('#newSubQty').value), m=Number($('#newSubUnit').value); if(!id||q<=0)return; const s=SUB_RECIPES.find(x=>x.id===currentSubRecipeId), n=[...(s.ingredients||[]),{id,qty:q*m}]; await db.collection('subrecipes').doc(currentSubRecipeId).update({ingredients:n}); };
Â  Â  window.removeSubIng = async function(sid,i) { const s=SUB_RECIPES.find(x=>x.id===sid), n=[...s.ingredients]; n.splice(i,1); await db.collection('subrecipes').doc(sid).update({ingredients:n}); };
Â  Â  window.deleteItem = async function(c,id) { if(confirm('Â¿Borrar?')){ await db.collection(c).doc(id).delete(); if(c==='recipes') $('#recipeEditor').style.display='none'; if(c==='subrecipes') $('#subRecipeEditor').style.display='none'; } };
Â  Â  window.openAliasModal = function() { $('#modalAlias').style.display='flex'; $('#aliasListBody').innerHTML=(FIXED_DATA.aliases||[]).map((a,i)=>`<tr><td>${a.external}</td><td>${a.items?a.items.length:0} items</td><td><button class="btn-icon" onclick="deleteAlias(${i})">ğŸ—‘ï¸</button></td></tr>`).join(''); $('#aliasInt').innerHTML=RECIPES.map(r=>`<option value="${r.id}">${r.id}</option>`).join(''); tempAliasList=[]; $('#tempAliasItems').innerHTML=''; };
Â  Â  window.addItemToAlias = function() { const id=$('#aliasInt').value, q=$('#aliasQty').value; if(id){ tempAliasList.push({id,qty:Number(q)}); $('#tempAliasItems').innerHTML=tempAliasList.map(x=>`<div>${x.qty}x ${x.id}</div>`).join(''); } };
Â  Â  window.saveAlias = function() { const e=$('#aliasExt').value; if(e&&tempAliasList.length){ if(!FIXED_DATA.aliases)FIXED_DATA.aliases=[]; FIXED_DATA.aliases.push({external:e,items:tempAliasList}); window.saveFixedData(); $('#modalAlias').style.display='none'; } };
Â  Â  window.deleteAlias = function(i) { FIXED_DATA.aliases.splice(i,1); window.saveFixedData(); };
Â  Â  window.addFixedRow = function() { FIXED_DATA.fixed.push({name:'',cost:0}); window.renderFixedTables(); };
Â  Â  window.addProdRow = function() { FIXED_DATA.prod.push({name:'',cost:0}); window.renderFixedTables(); };
Â  Â  window.updFix = function(a,i,k,v) { FIXED_DATA[a][i][k]=k==='cost'?Number(v):v; };
Â  Â  window.delFix = function(a,i) { FIXED_DATA[a].splice(i,1); window.renderFixedTables(); };
Â  Â  window.renderFixedTables = function() { $('#tableFixed tbody').innerHTML=FIXED_DATA.fixed.map((r,i)=>`<tr><td><input value="${r.name}" onchange="updFix('fixed',${i},'name',this.value)"></td><td><input type="number" value="${r.cost}" onchange="updFix('fixed',${i},'cost',this.value)"></td><td><button class="btn-icon" onclick="delFix('fixed',${i})">ğŸ—‘ï¸</button></td></tr>`).join(''); $('#tableProd tbody').innerHTML=FIXED_DATA.prod.map((r,i)=>`<tr><td><input value="${r.name}" onchange="updFix('prod',${i},'name',this.value)"></td><td><input type="number" value="${r.cost}" onchange="updFix('prod',${i},'cost',this.value)"></td><td><button class="btn-icon" onclick="delFix('prod',${i})">ğŸ—‘ï¸</button></td></tr>`).join(''); };
Â  Â  window.saveFixedData = function() { if(!FIXED_DATA.aliases)FIXED_DATA.aliases=[]; FIXED_DATA.config={pyPercent:Number($('#confPy').value), taxDebit:Number($('#confDebit').value), taxTransf:Number($('#confTransf').value), taxQR:Number($('#confQR').value)}; db.collection('config').doc('gerencia').set(FIXED_DATA).then(()=>alert("Guardado")); window.calculateAll(); window.renderOrdersTab(); };
Â  Â  window.saveConfig = window.saveFixedData;
Â  Â  window.showTab = function(id) { document.querySelectorAll('div[id^="tab-"]').forEach(d=>d.style.display='none'); $('#tab-'+id).style.display='block'; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); if(id==='proportions') window.renderProportions(); };

Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  $('#monthPicker').value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
Â  Â  Â  Â  // Inicializar el segundo picker
Â  Â  Â  Â  $('#monthPickerProp').value = $('#monthPicker').value;
Â  Â  Â  Â  $('#monthPicker').addEventListener('change', window.loadDashboardData);
Â  Â  Â  Â  loadProductsDB(); // ğŸ”¥ Carga los productos al iniciar
Â  Â  Â  Â  window.loadInventory(); window.loadRecipes(); window.loadFixedData(); window.loadDashboardData();
Â  Â  });
</script>
</body>
</html>
