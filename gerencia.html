<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia ‚Ä¢ Rhodes Burgers</title>
  <link rel="icon" href="images/logo.png" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --primary: #625A45; 
      --bg: #f8fafc; 
      --card: #ffffff;
      --text: #0f172a;
      --ring: #e2e8f0;
      --green: #10b981;
      --red: #ef4444;
      --blue: #3b82f6;
      --orange: #f97316;
      --purple: #8b5cf6;
    }

    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); padding-bottom: 60px; }

    /* HEADER */
    header { background: #fff; border-bottom: 1px solid var(--ring); position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .topbar { max-width: 1400px; margin: 0 auto; height: 60px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; display: flex; gap:10px; align-items:center; }
    .nav-btn { padding: 8px 12px; border-radius: 8px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 14px; transition:0.2s }
    .nav-btn:hover { background: #f1f5f9; color: #0f172a; }
    .nav-btn.active { background: var(--primary); color: #fff; }
    .btn-danger { background: #fee2e2; color: #991b1b; padding: 8px 12px; border-radius: 8px; font-weight: 700; border: none; cursor: pointer; }

    /* LAYOUT */
    .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
    @media(max-width: 900px) { .container { grid-template-columns: 1fr; } }

    /* CARDS */
    .card { background: #fff; border-radius: 12px; padding: 20px; border: 1px solid var(--ring); box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
    h2 { font-size: 14px; font-weight: 700; color: #475569; margin: 0 0 15px; border-bottom: 1px solid var(--ring); padding-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; display:flex; justify-content:space-between; }

    /* INPUTS & TABLE STYLE */
    .spreadsheet-row { display: grid; grid-template-columns: 2fr 1fr 40px; gap: 5px; margin-bottom: 5px; }
    input, select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; outline:none; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(98, 90, 69, 0.1); }
    
    button { border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; transition:0.2s; }
    .btn-primary { background: var(--primary); color: #fff; padding: 10px; width: 100%; }
    .btn-primary:hover { background: #4a4434; }
    
    .btn-excel { background: #16a34a; color: #fff; padding: 10px; width: 100%; display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:15px; }
    .btn-excel:hover { background: #15803d; }

    /* LISTAS TIPO EXCEL */
    .sheet-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .sheet-table th { text-align: left; padding: 8px; background: #f1f5f9; color: #64748b; font-weight: 600; border-bottom: 2px solid #e2e8f0; }
    .sheet-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    .sheet-table tr:last-child td { border-bottom: none; }
    
    .cell-input { border:none; background:transparent; width:100%; font-family:inherit; font-size:13px; color:#334155; }
    .cell-input:focus { background:#f8fafc; outline:none; }
    .cell-money { text-align: right; font-weight: 600; color: #475569; }
    
    .action-cell { text-align: center; }
    .btn-icon { background:transparent; color:#94a3b8; font-size:16px; padding:2px; }
    .btn-icon:hover.edit { color: var(--blue); }
    .btn-icon:hover.del { color: var(--red); }

    /* TAGS */
    .tag { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; }

    /* RESULTADOS */
    .res-sticky { position: sticky; top: 80px; }
    .big-number { font-size: 42px; font-weight: 900; color: #0f172a; line-height: 1; letter-spacing: -1px; }
    .stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 14px; }
    .stat-label { color: #64748b; font-weight: 500; }
    .stat-val { font-weight: 700; color: #334155; }

    /* TOTALES SECCION */
    .section-total { background: #f8fafc; padding: 8px 12px; border-radius: 6px; font-weight: 700; font-size: 13px; display: flex; justify-content: space-between; margin-top: 10px; color: #475569; border: 1px solid #e2e8f0; }

  </style>
</head>
<body>

<header>
  <div class="topbar">
    <a href="#" class="brand">
        <img src="images/logo.png" width="32" style="border-radius:6px"> 
        Gerencia
    </a>
    <div style="display:flex; gap:10px">
        <a href="pedido_local.html" class="nav-btn">üì¶ Pedidos</a>
        <a href="#" class="nav-btn active">üìä Rentabilidad</a>
        <button onclick="location.href='login.html'" class="btn-danger">Salir</button>
    </div>
  </div>
</header>

<div class="container">

  <aside>
    
    <div class="card">
        <h2>üìÖ Periodo & Ventas</h2>
        <input type="month" id="monthPicker" style="font-weight:700; color:#334155; margin-bottom:15px;">
        
        <div class="stat-row">
            <span class="stat-label">Ventas Totales</span>
            <span class="stat-val" id="totalSales" style="font-size:16px;">$ 0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Pedidos Entregados</span>
            <span class="stat-val" id="totalOrders">0</span>
        </div>
    </div>

    <div class="card" style="border-color: #fcd34d; background:#fffbeb;">
        <h2 style="border-color:#fcd34d; color:#92400e;">‚ö° Config. Autom√°tica</h2>
        
        <div style="margin-bottom:10px">
            <label style="font-size:12px; color:#92400e; font-weight:700;">Comisi√≥n PedidosYa (%)</label>
            <input type="number" id="confPy" value="30" onchange="updateCalc()" style="border-color:#fcd34d; text-align:right;">
        </div>
        <div>
            <label style="font-size:12px; color:#92400e; font-weight:700;">Packaging Unitario ($)</label>
            <input type="number" id="confPack" value="400" onchange="updateCalc()" style="border-color:#fcd34d; text-align:right;">
        </div>
    </div>

    <div class="card">
        <h2>üì• Importar Datos</h2>
        <input type="file" id="excelInput" style="display:none" accept=".xlsx, .xls">
        <button class="btn-excel" onclick="document.getElementById('excelInput').click()">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"></path></svg>
            Subir Excel Gerencia
        </button>
        <p style="font-size:11px; color:#64748b; margin:0; line-height:1.4">
            Soporta tu archivo <b>"Gerencia Rhodes.xlsx"</b>.<br>
            Lee pesta√±as: <i>Costos fijos, Producci√≥n, Packaging</i>.
        </p>
    </div>

    <div class="card">
        <h2>üìù Carga Manual</h2>
        <select id="costType" style="margin-bottom:8px">
            <option value="raw">ü•© Materia Prima</option>
            <option value="pack">ü•° Packaging Extra</option>
            <option value="fixed">üí° Costos Fijos</option>
            <option value="prod">üë®‚Äçüç≥ Producci√≥n</option>
        </select>
        <div class="spreadsheet-row">
            <input type="text" id="costName" placeholder="Descripci√≥n">
            <input type="number" id="costVal" placeholder="$">
            <button class="btn-primary" style="padding:0" onclick="addCost()">+</button>
        </div>
    </div>

  </aside>

  <main>
    
    <div class="card res-sticky">
        <div style="display:flex; justify-content:space-between; align-items:end; margin-bottom:10px;">
            <div style="text-align:left">
                <div style="font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase;">Ganancia Neta Real</div>
                <div class="big-number" id="finalProfit">$ 0</div>
            </div>
            <div style="text-align:right">
                <div style="font-size:12px; font-weight:700; color:#64748b;">Margen</div>
                <div id="finalMargin" style="font-size:24px; font-weight:800; color:#64748b;">0%</div>
            </div>
        </div>
        <div style="height:100px; width:100%; position:relative;">
             <canvas id="miniChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h2 style="color:var(--orange)">ü•© Materia Prima</h2>
        <table class="sheet-table">
            <tbody id="listRaw"></tbody>
        </table>
        <div class="section-total">
            <span>Total Materia Prima</span>
            <span id="sumRaw">$ 0</span>
        </div>
    </div>

    <div class="card">
        <h2 style="color:var(--blue)">ü•° Packaging</h2>
        <table class="sheet-table">
            <tbody id="listPack"></tbody>
            <tr style="background:#f8fafc; font-style:italic;">
                <td colspan="2">‚ö° C√°lculo Auto (Pedidos x Costo Unitario)</td>
                <td class="cell-money" id="valAutoPack">$ 0</td>
                <td></td>
            </tr>
        </table>
        <div class="section-total">
            <span>Total Packaging</span>
            <span id="sumPack">$ 0</span>
        </div>
    </div>

    <div class="card">
        <h2 style="color:#0ea5e9">üë®‚Äçüç≥ Producci√≥n / Sueldos</h2>
        <table class="sheet-table">
            <tbody id="listProd"></tbody>
        </table>
        <div class="section-total">
            <span>Total Producci√≥n</span>
            <span id="sumProd">$ 0</span>
        </div>
    </div>

    <div class="card">
        <h2 style="color:var(--purple)">üí° Costos Fijos</h2>
        <table class="sheet-table">
            <tbody id="listFixed"></tbody>
        </table>
        <div class="section-total">
            <span>Total Fijos</span>
            <span id="sumFixed">$ 0</span>
        </div>
    </div>

    <div class="card" style="border-left: 4px solid var(--red);">
        <h2 style="color:var(--red)">üõµ Comisiones App (Auto)</h2>
        <div style="display:flex; justify-content:space-between; font-weight:700; font-size:14px; color:#991b1b;">
            <span>Descuento PedidosYa Estimado</span>
            <span id="valAutoPy">$ 0</span>
        </div>
    </div>

  </main>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // 1. CONFIG
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();

    const $ = s => document.getElementById(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:0});

    // 2. STATE
    let ORDERS = [];
    let COSTS = JSON.parse(localStorage.getItem('rhodes_costs_v3') || '[]');
    let chartInstance = null;

    // 3. INIT
    window.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        $('monthPicker').value = now.toISOString().slice(0,7);
        
        $('monthPicker').addEventListener('change', loadOrders);
        $('excelInput').addEventListener('change', handleExcelUpload);

        if(localStorage.getItem('rhodes_conf_py')) $('confPy').value = localStorage.getItem('rhodes_conf_py');
        if(localStorage.getItem('rhodes_conf_pack')) $('confPack').value = localStorage.getItem('rhodes_conf_pack');

        renderCosts();
        loadOrders();
    });

    // 4. CARGAR VENTAS
    function loadOrders() {
        const ym = $('monthPicker').value;
        if(!ym) return;
        const [y, m] = ym.split('-').map(Number);
        
        const start = new Date(y, m-1, 1).toISOString();
        const end = new Date(y, m, 1).toISOString();

        db.collection('orders')
          .where('createdAt', '>=', start)
          .where('createdAt', '<', end)
          .get().then(snap => {
              ORDERS = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled');
              updateCalc();
          });
    }

    // 5. IMPORTAR EXCEL (L√ìGICA INTELIGENTE)
    function handleExcelUpload(e) {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // Limpiar costos actuales si se quiere reemplazar (opcional, aqui agregamos)
            const newCosts = [];
            const ym = $('monthPicker').value; // Asignar al mes actual

            // A. LEER COSTOS FIJOS
            if(workbook.Sheets['Costos fijos']) {
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets['Costos fijos']);
                rows.forEach(r => {
                    // Buscar columnas probables
                    const name = r['Costo'] || r['Item'] || r['Descripcion'];
                    const val = r['Monto'] || r['Valor'] || r['Total'];
                    if(name && val && typeof val === 'number') {
                        newCosts.push({ id: Date.now() + Math.random(), type: 'fixed', name, val, month: ym });
                    }
                });
            }

            // B. LEER PACKAGING
            if(workbook.Sheets['Costos packaging']) {
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets['Costos packaging']);
                rows.forEach(r => {
                    const name = r['Tipo'] || r['Materia Prima'];
                    const val = r['Costo total'] || r['Costo']; // Buscar total
                    if(name && val && typeof val === 'number') {
                        newCosts.push({ id: Date.now() + Math.random(), type: 'pack', name, val, month: ym });
                    }
                });
            }

            // C. LEER PRODUCCION
            if(workbook.Sheets['Costos producci√≥n']) {
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets['Costos producci√≥n']);
                rows.forEach(r => {
                    // A veces producci√≥n tiene estructura compleja, buscamos totales
                    const name = r['Hamburguesa'] || r['Producto']; // Ojo aqui
                    const val = r['Total'] || r['Costo Simple']; 
                    // Esto es mas complejo porque es unitario. 
                    // Si el excel tiene totales mensuales, los leemos. Si no, mejor manual.
                    // Asumiremos que si encuentra "Sueldos" los agrega.
                });
            }
            
            // Si leemos la hoja "Sueldos" del excel (que vi en tu lista)
            if(workbook.Sheets['Sueldos']) {
                 const rows = XLSX.utils.sheet_to_json(workbook.Sheets['Sueldos']);
                 // Buscar totales de sueldos si existen en filas resumen
            }

            if(newCosts.length > 0) {
                COSTS = [...COSTS, ...newCosts];
                saveCosts();
                alert(`‚úÖ Se importaron ${newCosts.length} costos desde el Excel.`);
            } else {
                alert("‚ö†Ô∏è No se encontraron columnas compatibles en las pesta√±as (Costos fijos, Costos packaging).");
            }
            $('excelInput').value = '';
        };
        reader.readAsArrayBuffer(file);
    }

    // 6. GESTI√ìN MANUAL
    window.addCost = () => {
        const type = $('costType').value;
        const name = $('costName').value.trim();
        const val = Number($('costVal').value);
        const ym = $('monthPicker').value;

        if(!name || val <= 0) return alert("Ingres√° descripci√≥n y monto");

        COSTS.push({ id: Date.now(), type, name, val, month: ym });
        saveCosts();
        $('costName').value = ''; $('costVal').value = ''; $('costName').focus();
    };

    window.editCost = (id) => {
        const item = COSTS.find(c => c.id === id);
        if(item) {
            $('costType').value = item.type;
            $('costName').value = item.name;
            $('costVal').value = item.val;
            delCost(id);
            $('costName').focus();
        }
    };

    window.delCost = (id) => {
        COSTS = COSTS.filter(c => c.id !== id);
        saveCosts();
    };

    function saveCosts() {
        localStorage.setItem('rhodes_costs_v3', JSON.stringify(COSTS));
        renderCosts();
    }

    function renderCosts() {
        // Filtrar por mes actual
        const currentMonth = $('monthPicker').value;
        const filtered = COSTS.filter(c => c.month === currentMonth || !c.month);

        ['listRaw', 'listPack', 'listFixed', 'listProd'].forEach(id => $(id).innerHTML = '');

        filtered.forEach(c => {
            const html = `
                <tr>
                    <td>
                        <input type="text" class="cell-input" value="${c.name}" readonly>
                    </td>
                    <td class="cell-money">
                        -$ ${c.val.toLocaleString('es-AR')}
                    </td>
                    <td class="action-cell">
                        <button class="btn-icon edit" onclick="editCost(${c.id})">‚úé</button>
                        <button class="btn-icon del" onclick="delCost(${c.id})">√ó</button>
                    </td>
                </tr>`;
            
            if(c.type === 'raw') $('listRaw').innerHTML += html;
            if(c.type === 'pack') $('listPack').innerHTML += html;
            if(c.type === 'fixed') $('listFixed').innerHTML += html;
            if(c.type === 'prod') $('listProd').innerHTML += html;
        });
        
        updateCalc(filtered);
    }

    // 7. C√ÅLCULO
    function updateCalc(filtered) {
        if(!filtered) {
             const currentMonth = $('monthPicker').value;
             filtered = COSTS.filter(c => c.month === currentMonth || !c.month);
        }

        const pyPerc = Number($('confPy').value) || 0;
        const packUnit = Number($('confPack').value) || 0;
        localStorage.setItem('rhodes_conf_py', pyPerc);
        localStorage.setItem('rhodes_conf_pack', packUnit);

        // Ventas
        let totalSales = 0;
        let pySales = 0;
        ORDERS.forEach(o => {
            const t = Number(o.total || 0);
            totalSales += t;
            if(o.source === 'pedidosya') pySales += t;
        });

        // Costos Auto
        const costAutoPy = pySales * (pyPerc / 100);
        const costAutoPack = ORDERS.length * packUnit;

        // Costos Manuales
        let mRaw=0, mPack=0, mFixed=0, mProd=0;
        filtered.forEach(c => {
            if(c.type === 'raw') mRaw += c.val;
            if(c.type === 'pack') mPack += c.val;
            if(c.type === 'fixed') mFixed += c.val;
            if(c.type === 'prod') mProd += c.val;
        });

        const totalRaw = mRaw;
        const totalPack = costAutoPack + mPack;
        const totalFixed = mFixed;
        const totalProd = mProd;
        const totalPy = costAutoPy;

        const totalCosts = totalRaw + totalPack + totalFixed + totalProd + totalPy;
        const profit = totalSales - totalCosts;
        const margin = totalSales > 0 ? (profit / totalSales * 100) : 0;

        // Render UI
        $('totalSales').innerText = money(totalSales);
        $('totalOrders').innerText = ORDERS.length;

        $('valAutoPy').innerText = '-' + money(totalPy);
        $('valAutoPack').innerText = '-' + money(costAutoPack);

        $('sumRaw').innerText = '-' + money(totalRaw);
        $('sumPack').innerText = '-' + money(totalPack);
        $('sumFixed').innerText = '-' + money(totalFixed);
        $('sumProd').innerText = '-' + money(totalProd);

        $('finalProfit').innerText = money(profit);
        $('finalProfit').style.color = profit >= 0 ? 'var(--green)' : 'var(--red)';
        $('finalMargin').innerText = margin.toFixed(1) + '%';

        renderChart(profit, totalPy, totalPack, totalRaw, totalProd, totalFixed);
    }

    function renderChart(profit, py, pack, raw, prod, fixed) {
        const ctx = $('miniChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Ganancia', 'Comisi√≥n', 'Pack', 'Mat. Prima', 'Prod', 'Fijos'],
                datasets: [{
                    data: [Math.max(0, profit), py, pack, raw, prod, fixed],
                    backgroundColor: ['#10b981', '#ef4444', '#3b82f6', '#f97316', '#0ea5e9', '#8b5cf6'],
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { display: false }, 
                    x: { grid: { display:false }, ticks: { font: {size:10} } } 
                }
            }
        });
    }

</script>
</body>
</html>
