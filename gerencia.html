<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia & Stock ‚Ä¢ Rhodes</title>
  <link rel="icon" href="images/logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --primary: #625A45; --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --green: #10b981; --red: #ef4444; --purple: #8b5cf6; }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; color: #0f172a; }

    header { background: #fff; border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; z-index: 10; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 13px; }
    .nav-btn:hover { background: #f1f5f9; color: #0f172a; }
    .nav-btn.active { background: var(--primary); color: #fff; }

    .layout { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; overflow-y: auto; }
    .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; border-left: 3px solid transparent; }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); }
    .section-title { font-size: 11px; font-weight: 700; color: #999; text-transform: uppercase; margin: 15px 20px 5px 20px; }
    .content { flex: 1; padding: 30px; overflow-y: auto; }

    .card { background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    h2 { margin: 0 0 15px; font-size: 15px; font-weight: 700; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f8fafc; text-align: left; padding: 10px; border-bottom: 1px solid var(--border); font-weight: 600; color: #64748b; }
    td { border-bottom: 1px solid var(--border); padding: 10px; vertical-align: middle; }
    input, select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; width: 100%; outline: none; }
    
    .btn { padding: 8px 14px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-blue { background: #3b82f6; color: white; }
    .btn-purple { background: var(--purple); color: white; }
    .btn-icon { background: transparent; border: none; font-size: 16px; cursor: pointer; color: #94a3b8; }
    .btn-icon:hover { color: var(--red); }
    .btn-sm { padding: 4px 8px; font-size: 11px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .kpi { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .kpi-lbl { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; }
    .kpi-val { font-size: 26px; font-weight: 800; color: #0f172a; margin-top: 5px; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal { background: #fff; width: 500px; padding: 25px; border-radius: 16px; box-shadow: 0 20px 25px rgba(0,0,0,0.1); max-height:90vh; overflow-y:auto; }
    .text-red { color: var(--red); } .text-green { color: var(--green); }
  </style>
</head>
<body>

<header>
  <a href="#" class="brand"><img src="images/logo.png" width="30"> Gerencia Rhodes</a>
  <div>
    <a href="pedido_local.html" class="nav-btn">Pedidos</a>
    <a href="#" class="nav-btn active">Gerencia</a>
    <button onclick="location.href='login.html'" class="nav-btn" style="color:var(--red)">Salir</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="tab-btn active" onclick="showTab('dashboard')">üìä Rendimiento</div>
    <div class="section-title">Gesti√≥n</div>
    <div class="tab-btn" onclick="showTab('stock')">üì¶ Control de Stock</div>
    <div class="tab-btn" onclick="showTab('subrecipes')">üß© Armado de Items</div>
    <div class="tab-btn" onclick="showTab('recipes')">üçî Recetas Finales</div>
    <div class="section-title">Costos & Precios</div>
    <div class="tab-btn" onclick="showTab('cost_materia')">ü•© Costos Mat. Prima</div>
    <div class="tab-btn" onclick="showTab('cost_pack')">ü•° Costos Packaging</div>
    <div class="tab-btn" onclick="showTab('fixed')">üí° Gastos Fijos</div>
    <div class="tab-btn" onclick="showTab('production')">üë®‚Äçüç≥ Sueldos</div>
  </aside>

  <main class="content">

    <div id="tab-dashboard">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div><h2 style="margin:0; border:0">Tablero de Comando</h2></div>
        <div style="display:flex; gap:10px; align-items:center">
            <div style="background:#fff7ed; padding:5px 10px; border-radius:6px; border:1px solid #fed7aa; display:flex; align-items:center; gap:5px">
                <span style="font-size:12px; font-weight:700; color:#c2410c;">Comisi√≥n Py:</span>
                <input type="number" id="confPy" value="30" style="width:50px; border:1px solid #fdba74; background:#fff; font-weight:700; text-align:center; padding:4px; border-radius:4px;">
                <span style="font-size:12px; font-weight:700; color:#c2410c;">%</span>
                <button class="btn-sm btn-primary" onclick="saveConfig()" style="margin-left:5px">Guardar</button>
            </div>
            <input type="month" id="monthPicker">
        </div>
      </div>
      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-lbl">Ventas Brutas</div><div class="kpi-val" id="kpiSales">$ 0</div></div>
        <div class="kpi"><div class="kpi-lbl">Costo Te√≥rico (Recetas)</div><div class="kpi-val text-red" id="kpiTheoCMV">$ 0</div></div>
        <div class="kpi"><div class="kpi-lbl">Fijos + Comisiones</div><div class="kpi-val text-red" id="kpiFixedTotal">$ 0</div></div>
        <div class="kpi" style="background:#f0fdf4"><div class="kpi-lbl text-green">Ganancia Neta</div><div class="kpi-val text-green" id="kpiNet">$ 0</div></div>
      </div>
      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
        <div class="card"><h2>Rentabilidad Real</h2><canvas id="mainChart" height="220"></canvas></div>
        <div class="card"><h2>√öltimas Compras</h2><div id="lastPurchasesList" style="font-size:13px; color:#555"></div></div>
      </div>
    </div>

    <div id="tab-stock" style="display:none">
        <div class="card">
            <h2><span>üì¶ Inventario General</span>
                <div style="display:flex; gap:10px">
                    <button class="btn btn-blue" onclick="openPurchaseModal()">üõí Registrar Compra</button>
                    <button class="btn btn-primary" onclick="openProductModal()">+ Nuevo Insumo</button>
                </div>
            </h2>
            <div style="margin-bottom:15px; display:flex; gap:10px">
                <input type="text" id="searchStock" placeholder="üîç Buscar..." onkeyup="renderStockTable()">
                <select id="filterCat" onchange="renderStockTable()" style="width:150px">
                    <option value="all">Todo</option><option value="carniceria">Carne</option><option value="panaderia">Pan</option><option value="almacen">Almac√©n</option><option value="packaging">Packaging</option>
                </select>
            </div>
            <div style="overflow-x:auto">
                <table><thead><tr><th>Producto</th><th>Cat</th><th>Stock</th><th>Unidad</th><th></th></tr></thead><tbody id="stockTableBody"></tbody></table>
            </div>
        </div>
    </div>

    <div id="tab-cost_materia" style="display:none">
        <div class="card">
            <h2><span>ü•© Costos Materia Prima</span> <button class="btn btn-primary" onclick="openProductModal(null, 'carniceria')">+ Nuevo Insumo</button></h2>
            <table><thead><tr><th>Insumo</th><th>Costo Compra</th><th>Rendimiento</th><th style="background:#f0fdf4">Costo Unitario (Base)</th><th></th></tr></thead><tbody id="costMateriaBody"></tbody></table>
        </div>
    </div>

    <div id="tab-cost_pack" style="display:none">
        <div class="card">
            <h2><span>ü•° Costos Packaging</span> <button class="btn btn-primary" onclick="openProductModal(null, 'packaging')">+ Nuevo Item</button></h2>
            <table><thead><tr><th>Item</th><th>Costo Compra</th><th>Rendimiento</th><th style="background:#f0fdf4">Costo Unit.</th><th></th></tr></thead><tbody id="costPackBody"></tbody></table>
        </div>
    </div>

    <div id="tab-subrecipes" style="display:none">
        <div class="card">
            <h2><span>üß© Armado de Items (Medallones, Kits)</span> <button class="btn btn-purple" onclick="addNewSubRecipe()">+ Nuevo Item Compuesto</button></h2>
            <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px">
                <div><table><thead><tr><th>Item Compuesto</th><th style="text-align:right">Costo</th><th></th></tr></thead><tbody id="subRecipesListBody"></tbody></table></div>
                <div id="subRecipeEditor" style="background:#fcfaff; padding:20px; border-radius:10px; border:1px solid #e9d5ff; display:none">
                    <h3 style="margin-top:0; color:var(--purple)">Componentes de: <span id="subEditorTitle" style="font-weight:800"></span></h3>
                    <table style="background:#fff"><thead><tr><th>Insumo</th><th>Cant.</th><th>Costo</th><th></th></tr></thead><tbody id="subRecipeIngBody"></tbody></table>
                    <div style="margin-top:10px; border-top:1px dashed #cbd5e1; padding-top:10px">
                        <div style="display:flex; gap:5px; margin-top:5px">
                            <select id="newSubIng" style="flex:2" onchange="updateUnitSelect('sub')"></select>
                            <input type="number" id="newSubQty" placeholder="Cant." style="flex:1" step="0.001">
                            <select id="newSubUnit" style="flex:1; background:#f0f9ff; font-weight:700; font-size:12px"></select>
                            <button class="btn btn-purple" onclick="addIngToSubRecipe()">+</button>
                        </div>
                    </div>
                    <div style="text-align:right; margin-top:10px">Costo Total: <strong id="subEditorTotalCost" class="text-red">$ 0</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-recipes" style="display:none">
        <div class="card">
            <h2><span>üçî Recetas Finales</span> <button class="btn btn-primary" onclick="addNewRecipe()">+ Nueva Receta</button></h2>
            <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px">
                <div><table><thead><tr><th>Producto</th><th style="text-align:right">Costo Total</th><th></th></tr></thead><tbody id="recipesListBody"></tbody></table></div>
                <div id="recipeEditor" style="background:#f0fdf4; padding:20px; border-radius:10px; border:1px solid #bbf7d0; display:none">
                    <h3 style="margin-top:0; color:var(--green)">Receta: <span id="editorTitle"></span></h3>
                    <table style="background:#fff"><thead><tr><th>Componente</th><th>Cant.</th><th>Costo</th><th></th></tr></thead><tbody id="recipeIngBody"></tbody></table>
                    <div style="margin-top:10px; border-top:1px dashed #cbd5e1; padding-top:10px">
                        <div style="display:flex; gap:5px; margin-top:5px">
                            <select id="newRecIng" style="flex:2" onchange="updateUnitSelect('rec')"></select>
                            <input type="number" id="newRecQty" placeholder="Cant" style="width:80px" step="0.01">
                            <select id="newRecUnit" style="flex:1; background:#f0f9ff; font-weight:700; font-size:12px"></select>
                            <button class="btn btn-primary" onclick="addIngToRecipe()">Agregar</button>
                        </div>
                    </div>
                    <div style="text-align:right; margin-top:10px">Costo Total: <strong id="editorTotalCost" class="text-red">$ 0</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-fixed" style="display:none">
      <div class="card"><h2><span>üí° Gastos Fijos</span> <button class="btn btn-primary" onclick="addFixedRow()">+ Agregar</button></h2>
      <table id="tableFixed"><thead><tr><th>Concepto</th><th width="150">Monto</th><th width="50"></th></tr></thead><tbody></tbody></table>
      <div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div></div>
    </div>
    <div id="tab-production" style="display:none">
      <div class="card"><h2><span>üë®‚Äçüç≥ Sueldos</span> <button class="btn btn-primary" onclick="addProdRow()">+ Agregar</button></h2>
      <table id="tableProd"><thead><tr><th>Empleado / Concepto</th><th width="150">Total</th><th width="50"></th></tr></thead><tbody></tbody></table>
      <div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div></div>
    </div>

  </main>
</div>

<div class="modal-overlay" id="modalProduct">
    <div class="modal">
        <h3 id="mpTitle">Nuevo Insumo</h3> <input type="hidden" id="mpId">
        <div style="margin-bottom:10px"><label>Nombre</label><input type="text" id="mpName"></div>
        <div style="margin-bottom:10px"><label>Categor√≠a</label>
            <select id="mpCat"><option value="carniceria">Carne</option><option value="panaderia">Pan</option><option value="almacen">Almac√©n</option><option value="packaging">Packaging</option><option value="salsas">Salsas</option></select>
        </div>
        <div style="background:#f9fafb; padding:10px; border-radius:8px; margin-bottom:10px">
            <h4 style="margin:0 0 10px 0; font-size:12px; color:var(--primary)">üì¶ Configuraci√≥n Costo</h4>
            <div style="display:flex; gap:10px; margin-bottom:10px">
                <div style="flex:1"><label style="font-size:11px">Costo Paquete ($)</label><input type="number" id="mpPurchCost" step="0.01"></div>
                <div style="flex:1"><label style="font-size:11px">Rendimiento (Trae)</label><input type="number" id="mpYield" step="0.001"></div>
            </div>
            <div style="display:flex; gap:10px; align-items:center">
                <div style="flex:1"><label style="font-size:11px">Unidad de Uso</label>
                    <select id="mpUnit">
                        <option value="kg">Kilogramo (kg)</option><option value="gr">Gramos (gr)</option><option value="lt">Litro (lt)</option><option value="ml">Mililitro (ml)</option><option value="u">Unidad (u)</option><option value="pq">Paquete</option>
                    </select>
                </div>
                <div style="flex:1; text-align:right; font-size:12px">Costo Unitario: <strong id="calcUnitCost" style="color:var(--green)">$ 0</strong></div>
            </div>
        </div>
        <div style="margin-bottom:15px"><label>Stock Actual</label><input type="number" id="mpQty" value="0" step="0.001"></div>
        <div style="display:flex; gap:10px"><button class="btn btn-primary" style="flex:1" onclick="saveProduct()">Guardar</button><button class="btn" style="flex:1" onclick="$('#modalProduct').style.display='none'">Cancelar</button></div>
    </div>
</div>

<div class="modal-overlay" id="modalPurchase">
    <div class="modal">
        <h3>üõí Registrar Compra</h3>
        <div style="margin-bottom:10px"><label>Insumo</label><select id="purProd"></select></div>
        <div style="display:flex; gap:10px; margin-bottom:10px">
            <div><label>Cantidad Comprada</label><input type="number" id="purQty" step="0.001"></div>
            <div><label>Total Pagado ($)</label><input type="number" id="purTotal"></div>
        </div>
        <div style="margin-bottom:15px"><label>Fecha</label><input type="date" id="purDate"></div>
        <div style="display:flex; gap:10px">
            <button class="btn btn-primary" style="flex:1" onclick="confirmPurchase()">Confirmar Compra</button>
            <button class="btn" style="flex:1" onclick="$('#modalPurchase').style.display='none'">Cancelar</button>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:2});

    let INVENTORY=[], SUB_RECIPES=[], RECIPES=[], PURCHASES=[], ORDERS=[], FIXED_DATA={fixed:[],prod:[],config:{pyPercent:30}}, currentRecipeId=null, currentSubRecipeId=null, chartInstance=null;

    window.addEventListener('DOMContentLoaded', () => {
        const now = new Date();
        $('#monthPicker').value = now.toISOString().slice(0,7);
        $('#purDate').valueAsDate = now;
        $('#monthPicker').addEventListener('change', loadDashboardData);
        
        ['mpPurchCost', 'mpYield'].forEach(id => document.getElementById(id).addEventListener('input', () => {
            const cost = Number($('#mpPurchCost').value), yld = Number($('#mpYield').value);
            $('#calcUnitCost').innerText = money(yld > 0 ? cost/yld : 0);
        }));

        loadInventory(); loadSubRecipes(); loadRecipes(); loadFixedData(); loadDashboardData();
    });

    // LOADERS
    function loadInventory() { db.collection('inventory').orderBy('name').onSnapshot(snap => { INVENTORY = snap.docs.map(d => ({id: d.id, ...d.data()})); renderStockTable(); renderCostTables(); renderRecipesList(); renderSubRecipesList(); }); }
    function loadSubRecipes() { db.collection('subrecipes').onSnapshot(snap => { SUB_RECIPES = snap.docs.map(d => ({id: d.id, ...d.data()})); renderSubRecipesList(); renderRecipesList(); }); }
    function loadRecipes() { db.collection('recipes').onSnapshot(snap => { RECIPES = snap.docs.map(d => ({id: d.id, ...d.data()})); renderRecipesList(); }); }
    function loadFixedData() { db.collection('config').doc('gerencia').onSnapshot(doc => { if(doc.exists) FIXED_DATA = doc.data(); if(!FIXED_DATA.fixed) FIXED_DATA.fixed = []; if(!FIXED_DATA.prod) FIXED_DATA.prod = []; $('#confPy').value = FIXED_DATA.config?.pyPercent || 30; renderFixedTables(); }); }
    
    function loadDashboardData() {
        const ym = $('#monthPicker').value; if(!ym) return;
        const [y, m] = ym.split('-').map(Number);
        const start = new Date(y, m-1, 1).toISOString(); const end = new Date(y, m, 1).toISOString();
        db.collection('orders').where('createdAt', '>=', start).where('createdAt', '<', end).get().then(snap => { ORDERS = snap.docs.map(d => d.data()).filter(o => o.status !== 'cancelled'); calculateAll(); });
        db.collection('purchases').where('date', '>=', start).where('date', '<', end).get().then(snap => { PURCHASES = snap.docs.map(d => d.data()); calculateAll(); });
    }

    window.deleteItem = async (collection, id) => { if(confirm('¬øEliminar?')) { await db.collection(collection).doc(id).delete(); if(collection === 'recipes') $('#recipeEditor').style.display='none'; if(collection === 'subrecipes') $('#subRecipeEditor').style.display='none'; } };

    // TABLES
    function renderStockTable() {
        const t=$('#searchStock').value.toLowerCase(), c=$('#filterCat').value, b=$('#stockTableBody'); b.innerHTML='';
        INVENTORY.filter(p=>p.name.toLowerCase().includes(t) && (c==='all'||p.category===c)).forEach(p=>{
            b.innerHTML += `<tr><td><b>${p.name}</b></td><td><small>${p.category}</small></td><td>${Number(p.qty).toFixed(3)}</td><td>${p.unit}</td>
            <td><button class="btn-icon" onclick="openProductModal('${p.id}')">‚úé</button> <button class="btn-icon" onclick="deleteItem('inventory','${p.id}')">üóëÔ∏è</button></td></tr>`;
        });
    }
    function renderCostTables() {
        const render = (arr, id) => {
            const b=$(id); b.innerHTML='';
            arr.forEach(p=>{
                b.innerHTML += `<tr><td><b>${p.name}</b></td><td>$${p.purchCost||p.cost}</td><td>${p.yield||1} ${p.unit}</td><td style="color:#166534;font-weight:700">${money(p.cost)}</td>
                <td><button class="btn-icon" onclick="openProductModal('${p.id}')">‚úé</button> <button class="btn-icon" onclick="deleteItem('inventory','${p.id}')">üóëÔ∏è</button></td></tr>`;
            });
        };
        render(INVENTORY.filter(p=>p.category!=='packaging'), '#costMateriaBody');
        render(INVENTORY.filter(p=>p.category==='packaging'), '#costPackBody');
    }

    // MODAL
    window.openProductModal = (id, cat) => {
        $('#modalProduct').style.display='flex';
        if(id) {
            const p = INVENTORY.find(i=>i.id===id);
            $('#mpTitle').innerText='Editar'; $('#mpId').value=id; $('#mpName').value=p.name; $('#mpCat').value=p.category; $('#mpQty').value=p.qty; $('#mpUnit').value=p.unit;
            $('#mpPurchCost').value=p.purchCost||p.cost; $('#mpYield').value=p.yield||1; $('#calcUnitCost').innerText=money(p.cost);
        } else {
            $('#mpTitle').innerText='Nuevo'; $('#mpId').value=''; $('#mpName').value=''; $('#mpQty').value=0; $('#mpPurchCost').value=0; $('#mpYield').value=1; if(cat)$('#mpCat').value=cat;
        }
    };
    window.saveProduct = async () => {
        const id=$('#mpId').value, purchCost=Number($('#mpPurchCost').value), yld=Number($('#mpYield').value);
        const data = { name:$('#mpName').value, category:$('#mpCat').value, qty:Number($('#mpQty').value), unit:$('#mpUnit').value, purchCost, yield:yld, cost:yld>0?purchCost/yld:0 };
        if(!data.name) return alert("Nombre requerido");
        id ? await db.collection('inventory').doc(id).update(data) : await db.collection('inventory').add(data);
        $('#modalProduct').style.display='none';
    };

    // SUB-RECIPES
    function renderSubRecipesList() {
        const b=$('#subRecipesListBody'); b.innerHTML='';
        SUB_RECIPES.forEach(s=>{
            const cost = (s.ingredients||[]).reduce((sum,ing)=>{ const i=INVENTORY.find(x=>x.id===ing.id); return sum+(ing.qty*(i?i.cost:0)); },0);
            b.innerHTML += `<tr onclick="openSubEditor('${s.id}')" style="cursor:pointer"><td>${s.name}</td><td style="text-align:right"><b>${money(cost)}</b></td><td style="text-align:right"><button class="btn-icon" onclick="deleteItem('subrecipes','${s.id}')">üóëÔ∏è</button></td></tr>`;
        });
    }
    window.addNewSubRecipe = async () => { const n=prompt("Nombre"); if(n) await db.collection('subrecipes').add({name:n, ingredients:[]}); };
    window.openSubEditor = (id) => {
        currentSubRecipeId=id; const sub=SUB_RECIPES.find(s=>s.id===id);
        $('#subRecipeEditor').style.display='block'; $('#subEditorTitle').innerText=sub.name;
        const sel=$('#newSubIng'); sel.innerHTML='<option value="">Insumo...</option>';
        INVENTORY.forEach(i => sel.innerHTML+=`<option value="${i.id}" data-unit="${i.unit}">${i.name} ($${money(i.cost)}/${i.unit})</option>`);
        updateSubIngList();
    };
    window.updateUnitSelect = (mode) => {
        const sel = mode==='sub'?$('#newSubIng'):$('#newRecIng');
        const unitSel = mode==='sub'?$('#newSubUnit'):$('#newRecUnit');
        const opt = sel.options[sel.selectedIndex];
        const unit = opt.getAttribute('data-unit');
        unitSel.innerHTML = '';
        if(unit==='kg'||unit==='lt') { unitSel.innerHTML=`<option value="1">${unit} (Directo)</option><option value="0.001">gr/ml (Convierte)</option>`; }
        else { unitSel.innerHTML=`<option value="1">${unit}</option>`; }
    };
    function updateSubIngList() {
        const sub=SUB_RECIPES.find(s=>s.id===currentSubRecipeId);
        const b=$('#subRecipeIngBody'); b.innerHTML=''; let total=0;
        (sub.ingredients||[]).forEach((ing,idx)=>{
            const i=INVENTORY.find(x=>x.id===ing.id); const cost=i?i.cost:0; const subTotal=cost*ing.qty; total+=subTotal;
            b.innerHTML+=`<tr><td>${i?i.name:'?'}</td><td>${Number(ing.qty).toFixed(3)} ${i?i.unit:''}</td><td>${money(subTotal)}</td><td><button class="btn-icon" onclick="remSubIng(${idx})">üóëÔ∏è</button></td></tr>`;
        });
        $('#subEditorTotalCost').innerText=money(total);
    }
    window.addIngToSubRecipe = async () => {
        const id=$('#newSubIng').value, qty=Number($('#newSubQty').value), mult=Number($('#newSubUnit').value);
        if(!id || qty<=0) return;
        const sub=SUB_RECIPES.find(s=>s.id===currentSubRecipeId);
        const newIngs=[...(sub.ingredients||[]), {id, qty: qty*mult}];
        await db.collection('subrecipes').doc(currentSubRecipeId).update({ingredients:newIngs});
        $('#newSubQty').value='';
    };
    window.remSubIng = async (idx) => {
        const sub=SUB_RECIPES.find(s=>s.id===currentSubRecipeId);
        const newIngs=[...sub.ingredients]; newIngs.splice(idx,1);
        await db.collection('subrecipes').doc(currentSubRecipeId).update({ingredients:newIngs});
    };

    // RECIPES
    function renderRecipesList() {
        const b=$('#recipesListBody'); b.innerHTML='';
        RECIPES.forEach(r=>{
            const cost = (r.ingredients||[]).reduce((sum,ing)=>{ 
                const s=SUB_RECIPES.find(x=>x.id===ing.id); 
                if(s) {
                    const subCost = (s.ingredients||[]).reduce((a,b)=>{const i=INVENTORY.find(z=>z.id===b.id); return a+(b.qty*(i?i.cost:0))},0);
                    return sum+(ing.qty*subCost);
                }
                const i=INVENTORY.find(x=>x.id===ing.id); return sum+(ing.qty*(i?i.cost:0));
            },0);
            b.innerHTML += `<tr onclick="openRecEditor('${r.id}')" style="cursor:pointer"><td>${r.id}</td><td style="text-align:right"><b>${money(cost)}</b></td><td style="text-align:right"><button class="btn-icon" onclick="deleteItem('recipes','${r.id}')">üóëÔ∏è</button></td></tr>`;
        });
    }
    window.addNewRecipe = async () => { const n=prompt("Nombre"); if(n) await db.collection('recipes').doc(n).set({ingredients:[]}); };
    window.openRecEditor = (id) => {
        currentRecipeId=id; const r=RECIPES.find(x=>x.id===id);
        $('#recipeEditor').style.display='block'; $('#editorTitle').innerText=id;
        const sel=$('#newRecIng'); sel.innerHTML='<option value="">Agregar...</option>';
        sel.innerHTML+='<optgroup label="üß© Items">'; SUB_RECIPES.forEach(s=>sel.innerHTML+=`<option value="${s.id}" data-unit="u">üß© ${s.name}</option>`); sel.innerHTML+='</optgroup>';
        sel.innerHTML+='<optgroup label="üì¶ Insumos">'; INVENTORY.forEach(i=>sel.innerHTML+=`<option value="${i.id}" data-unit="${i.unit}">${i.name}</option>`); sel.innerHTML+='</optgroup>';
        updateRecIngList();
    };
    function updateRecIngList() {
        const r=RECIPES.find(x=>x.id===currentRecipeId);
        const b=$('#recipeIngBody'); b.innerHTML=''; let total=0;
        (r.ingredients||[]).forEach((ing,idx)=>{
            let name='?', cost=0;
            const sub=SUB_RECIPES.find(s=>s.id===ing.id); const item=INVENTORY.find(i=>i.id===ing.id);
            if(sub) { name='üß© '+sub.name; cost=(sub.ingredients||[]).reduce((a,x)=>{const i=INVENTORY.find(z=>z.id===x.id); return a+(x.qty*(i?i.cost:0))},0); }
            else if(item) { name=item.name; cost=item.cost; }
            const subTotal=cost*ing.qty; total+=subTotal;
            b.innerHTML+=`<tr><td>${name}</td><td>${ing.qty}</td><td>${money(subTotal)}</td><td><button class="btn-icon" onclick="remRecIng(${idx})">üóëÔ∏è</button></td></tr>`;
        });
        $('#editorTotalCost').innerText=money(total);
    }
    window.addIngToRecipe = async () => {
        const id=$('#newRecIng').value, qty=Number($('#newRecQty').value), mult=Number($('#newRecUnit').value); 
        if(!id||qty<=0) return;
        const r=RECIPES.find(x=>x.id===currentRecipeId);
        const newIngs=[...(r.ingredients||[]), {id, qty: qty*mult}];
        await db.collection('recipes').doc(currentRecipeId).update({ingredients:newIngs});
        $('#newRecQty').value='';
    };
    window.remRecIng = async (idx) => {
        const r=RECIPES.find(x=>x.id===currentRecipeId);
        const newIngs=[...r.ingredients]; newIngs.splice(idx,1);
        await db.collection('recipes').doc(currentRecipeId).update({ingredients:newIngs});
    };

    // FIXED TABLES
    function renderFixedTables() {
        const t1=$('#tableFixed tbody'), t2=$('#tableProd tbody'); t1.innerHTML=''; t2.innerHTML='';
        FIXED_DATA.fixed.forEach((r,i) => t1.innerHTML += `<tr><td><input value="${r.name}" onchange="updFix('fixed',${i},'name',this.value)"></td><td><input type="number" value="${r.cost}" onchange="updFix('fixed',${i},'cost',this.value)"></td><td><button class="btn-icon" onclick="delFix('fixed',${i})">üóëÔ∏è</button></td></tr>`);
        FIXED_DATA.prod.forEach((r,i) => t2.innerHTML += `<tr><td><input value="${r.name}" onchange="updFix('prod',${i},'name',this.value)"></td><td><input type="number" value="${r.cost}" onchange="updFix('prod',${i},'cost',this.value)"></td><td><button class="btn-icon" onclick="delFix('prod',${i})">üóëÔ∏è</button></td></tr>`);
    }
    window.addFixedRow=()=>{FIXED_DATA.fixed.push({name:'',cost:0});renderFixedTables()}; window.addProdRow=()=>{FIXED_DATA.prod.push({name:'',cost:0});renderFixedTables()};
    window.updFix=(arr,i,k,v)=>{FIXED_DATA[arr][i][k]=k==='cost'?Number(v):v}; window.delFix=(arr,i)=>{FIXED_DATA[arr].splice(i,1);renderFixedTables()};
    window.saveFixedData=()=>{FIXED_DATA.config={pyPercent:Number($('#confPy').value)}; db.collection('config').doc('gerencia').set(FIXED_DATA).then(()=>alert("Guardado"));}; window.saveConfig=saveFixedData;

    // PURCHASE
    window.openPurchaseModal=()=>{ $('#modalPurchase').style.display='flex'; const sel=$('#purProd'); sel.innerHTML=''; INVENTORY.forEach(p=>sel.innerHTML+=`<option value="${p.id}">${p.name} (Stock: ${Number(p.qty).toFixed(2)})</option>`); $('#purQty').value=''; $('#purTotal').value=''; };
    window.confirmPurchase=async()=>{
        const pid=$('#purProd').value, qty=Number($('#purQty').value), tot=Number($('#purTotal').value), d=$('#purDate').value; if(!pid||qty<=0)return alert("Datos mal");
        await db.collection('purchases').add({prodId:pid,qty,total:tot,date:d});
        const p=INVENTORY.find(i=>i.id===pid); if(p) await db.collection('inventory').doc(pid).update({qty:Number(p.qty)+qty});
        alert("OK"); $('#modalPurchase').style.display='none'; loadDashboardData();
    };

    // CALC
    function calculateAll() {
        let gross=0, theo=0, comms=0;
        ORDERS.forEach(o => {
            const s=Number(o.total||0); gross+=s;
            if(o.source==='pedidosya') comms+=(s*(FIXED_DATA.config.pyPercent/100));
            (o.items||[]).forEach(i => {
                let r=RECIPES.find(x=>i.name.toLowerCase().includes(x.id.toLowerCase()));
                if(!r) { if(i.name.includes('Doble')) r=RECIPES.find(x=>x.id.includes('Doble')); else r=RECIPES.find(x=>x.id.includes('Simple')); }
                if(r) {
                    const cost = (r.ingredients||[]).reduce((sum,ing)=>{ 
                        const sub=SUB_RECIPES.find(x=>x.id===ing.id); 
                        if(sub) {
                            const sc = (sub.ingredients||[]).reduce((a,b)=>{const it=INVENTORY.find(z=>z.id===b.id); return a+(b.qty*(it?it.cost:0))},0);
                            return sum+(ing.qty*sc);
                        }
                        const it=INVENTORY.find(x=>x.id===ing.id); return sum+(ing.qty*(it?it.cost:0));
                    },0);
                    theo += (cost * (i.qty||1));
                }
            });
        });
        const fixed = FIXED_DATA.fixed.reduce((a,b)=>a+b.cost,0) + FIXED_DATA.prod.reduce((a,b)=>a+b.cost,0);
        const purch = PURCHASES.reduce((a,b)=>a+Number(b.total),0);
        $('#kpiSales').innerText=money(gross); $('#kpiTheoCMV').innerText='-'+money(theo); $('#kpiFixedTotal').innerText='-'+money(fixed+comms); $('#kpiNet').innerText=money(gross-(fixed+comms+purch));
        
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart($('#mainChart').getContext('2d'), { type:'bar', data:{labels:['Ingresos','Gastos Reales','Ganancia'], datasets:[{data:[gross, fixed+comms+purch, gross-(fixed+comms+purch)], backgroundColor:['#94a3b8','#ef4444','#10b981'], borderRadius:5}]}, options:{plugins:{legend:{display:false}}}});
        $('#lastPurchasesList').innerHTML = PURCHASES.slice(0,5).map(p=>`<div style="display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:5px 0"><span>Compra</span><b class="text-red">-${money(p.total)}</b></div>`).join('');
    }

    window.showTab=(id)=>{ document.querySelectorAll('div[id^="tab-"]').forEach(d=>d.style.display='none'); document.querySelector('#tab-'+id).style.display='block'; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); };
</script>
</body>
</html>
