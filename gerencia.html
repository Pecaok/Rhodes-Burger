<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerencia & Stock ‚Ä¢ Rhodes</title>
  <link rel="icon" href="images/logo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- ESTILOS VISUALES --- */
    :root { 
        --primary: #625A45; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; 
        --border: #e2e8f0; --green: #10b981; --red: #ef4444; 
        --blue: #3b82f6; --purple: #8b5cf6; --orange: #f97316; 
    }
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

    header { background: #fff; border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; padding: 0 20px; justify-content: space-between; flex-shrink: 0; z-index: 10; }
    .brand { font-weight: 800; font-size: 18px; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 10px; }
    .nav-btn { padding: 8px 12px; border-radius: 6px; text-decoration: none; color: #64748b; font-weight: 600; font-size: 13px; transition:0.2s }
    .nav-btn:hover { background: #f1f5f9; color: #0f172a; }
    .nav-btn.active { background: var(--primary); color: #fff; }

    .layout { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 220px; background: #fff; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; overflow-y: auto; }
    .tab-btn { padding: 12px 20px; cursor: pointer; font-size: 13px; font-weight: 600; color: #64748b; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: center; }
    .tab-btn:hover { background: #f8fafc; color: var(--primary); }
    .tab-btn.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); }
    .section-title { font-size:11px; font-weight:700; color:#999; text-transform:uppercase; margin:15px 20px 5px 20px; }
    .content { flex: 1; padding: 30px; overflow-y: auto; }

    .card { background: #fff; border-radius: 12px; border: 1px solid var(--border); padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    h2 { margin: 0 0 15px; font-size: 15px; font-weight: 700; color: #334155; border-bottom: 1px solid var(--border); padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background: #f8fafc; text-align: left; padding: 10px; border-bottom: 1px solid var(--border); font-weight: 600; color: #64748b; }
    td { border-bottom: 1px solid var(--border); padding: 10px; vertical-align: middle; }
    input, select { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; outline: none; width: 100%; }
    
    .btn { padding: 8px 14px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-blue { background: var(--blue); color: white; }
    .btn-purple { background: var(--purple); color: white; }
    .btn-danger { background: #fee2e2; color: var(--red); }
    .btn-icon { background:transparent; border:none; font-size:16px; cursor:pointer; color:#94a3b8; }
    .btn-icon:hover { color: var(--red); }
    .btn-sm { padding: 4px 8px; font-size: 11px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px; }
    .kpi { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
    .kpi-lbl { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-val { font-size: 26px; font-weight: 800; color: #0f172a; margin-top: 5px; }
    
    .order-row { cursor: pointer; transition: background 0.2s; }
    .order-row:hover { background: #f8fafc; }
    .order-details { display: none; background: #fcfcfc; border-bottom: 1px solid var(--border); }
    .order-details.open { display: table-row; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 15px; }
    
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; display:inline-block; letter-spacing:0.5px; }
    .bdg-web { background: #e0f2fe; color: #0284c7; }   
    .bdg-local { background: #f1f5f9; color: #475569; } 
    .bdg-py { background: #fee2e2; color: #ef4444; }    
    .bdg-cash { background: #dcfce7; color: #166534; }  
    .bdg-digital { background: #f3e8ff; color: #7e22ce; } 

    .conf-input-group { display:flex; flex-direction:column; align-items:center; }
    .conf-lbl { font-size:9px; color:#c2410c; margin-bottom:2px; font-weight:700; text-transform:uppercase; }
    .conf-inp { width:45px; border:1px solid #fdba74; background:#fff; font-weight:700; text-align:center; padding:2px; border-radius:4px; font-size:12px; }

    .alias-builder { background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    .alias-list-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #e2e8f0; font-size: 12px; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
    .modal { background: #fff; width: 500px; padding: 25px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height:90vh; overflow-y:auto; }
    
    .text-red { color: var(--red); } .text-green { color: var(--green); }
    .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .st-ok { background: var(--green); } .st-crit { background: var(--red); } .st-warn { background: var(--orange); }
  </style>
</head>
<body>

<header>
  <a href="#" class="brand"><img src="images/logo.png" width="30"> Gerencia Rhodes</a>
  <div>
    <a href="pedido_local.html" class="nav-btn">Pedidos</a>
    <a href="#" class="nav-btn active">Gerencia</a>
    <button onclick="location.href='login.html'" class="nav-btn" style="color:var(--red)">Salir</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="tab-btn active" onclick="showTab('dashboard')">üìä Rendimiento</div>
    
    <div class="section-title">Gesti√≥n</div>
    <div class="tab-btn" onclick="showTab('stock')">üì¶ Control de Stock</div>
    <div class="tab-btn" onclick="showTab('subrecipes')">üß© Armado de Items</div>
    <div class="tab-btn" onclick="showTab('recipes')">üçî Recetas Finales</div>
    
    <div class="section-title">Costos & Precios</div>
    <div class="tab-btn" onclick="showTab('cost_materia')">ü•© Costos Mat. Prima</div>
    <div class="tab-btn" onclick="showTab('cost_pack')">ü•° Costos Packaging</div>
    <div class="tab-btn" onclick="showTab('fixed')">üí° Gastos Fijos</div>
    <div class="tab-btn" onclick="showTab('production')">üë®‚Äçüç≥ Sueldos</div>

    <div class="section-title">Historial</div>
    <div class="tab-btn" onclick="showTab('orders')">üßæ Lista de Pedidos</div>
  </aside>

  <main class="content">

    <div id="tab-dashboard">
      <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <div><h2 style="margin:0; border:0">Tablero de Comando</h2></div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            
            <div style="background:#fff7ed; padding:6px 12px; border-radius:8px; border:1px solid #fed7aa; display:flex; align-items:center; gap:8px">
                <div class="conf-input-group"><div class="conf-lbl">Py (%)</div><input type="number" id="confPy" value="30" class="conf-inp"></div>
                <div style="width:1px; height:20px; background:#fed7aa"></div>
                <div class="conf-input-group"><div class="conf-lbl">D√©bito</div><input type="number" id="confDebit" value="0" class="conf-inp"></div>
                <div class="conf-input-group"><div class="conf-lbl">Transf</div><input type="number" id="confTransf" value="0" class="conf-inp"></div>
                <div class="conf-input-group"><div class="conf-lbl">QR/MP</div><input type="number" id="confQR" value="0" class="conf-inp"></div>
                <button class="btn-sm btn-primary" onclick="saveConfig()" style="height:32px; margin-left:5px">üíæ</button>
            </div>

            <input type="month" id="monthPicker" style="font-weight:700; border:2px solid var(--primary); color:var(--primary); padding:5px; border-radius:6px;">
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi"><div class="kpi-lbl">Ventas Brutas</div><div class="kpi-val" id="kpiSales">$ 0</div></div>
        <div class="kpi"><div class="kpi-lbl">Costo Te√≥rico</div><div class="kpi-val text-red" id="kpiTheoCMV">$ 0</div></div>
        <div class="kpi"><div class="kpi-lbl">Gastos (Incl. Var)</div><div class="kpi-val text-red" id="kpiTotalExpenses">$ 0</div></div>
        <div class="kpi" id="kpiNetContainer"><div class="kpi-lbl">Ganancia Neta</div><div class="kpi-val" id="kpiNet">$ 0</div></div>
      </div>

      <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px">
        <div class="card">
            <h2>Desglose de Gastos y Ganancia</h2>
            <div style="position: relative; height: 250px; width: 100%;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>√öltimas Compras Stock</h2>
            <div id="lastPurchasesList" style="font-size:13px; color:#555"></div>
        </div>
      </div>
    </div>

    <div id="tab-orders" style="display:none">
        <div class="card">
            <h2><span id="ordersTitle">üßæ Historial de Pedidos</span> <small style="font-size:12px; color:#777; font-weight:400">Clic en pedido para ver detalle</small></h2>
            <div style="overflow-x:auto">
                <table style="width:100%">
                    <thead><tr><th width="120">Fecha</th><th>Cliente</th><th width="100">Origen</th><th width="120">Pago</th><th width="100">Total</th><th width="100">Ganancia</th><th width="30"></th></tr></thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-stock" style="display:none">
        <div class="card">
            <h2><span>üì¶ Inventario General</span><div style="display:flex; gap:10px"><button class="btn btn-blue" onclick="openPurchaseModal()">üõí Registrar Compra</button><button class="btn btn-primary" onclick="openProductModal()">+ Nuevo Insumo</button></div></h2>
            <div style="margin-bottom:15px; display:flex; gap:10px">
                <input type="text" id="searchStock" placeholder="üîç Buscar..." onkeyup="renderStockTable()">
                <select id="filterCat" onchange="renderStockTable()" style="width:150px"><option value="all">Todo</option><option value="carniceria">Carne</option><option value="panaderia">Pan</option><option value="almacen">Almac√©n</option><option value="packaging">Packaging</option></select>
            </div>
            <div style="overflow-x:auto"><table><thead><tr><th>Producto</th><th>Categor√≠a</th><th>Stock</th><th>M√≠nimo</th><th>Estado</th><th></th></tr></thead><tbody id="stockTableBody"></tbody></table></div>
        </div>
    </div>

    <div id="tab-cost_materia" style="display:none">
        <div class="card"><h2><span>ü•© Costos Materia Prima</span><button class="btn btn-primary" onclick="openProductModal(null, 'carniceria')">+ Nuevo Insumo</button></h2><div style="overflow-x:auto"><table><thead><tr><th>Insumo</th><th>Costo Compra</th><th>Formato</th><th>Rendimiento</th><th style="background:#f0fdf4; color:#166534">Costo Base</th><th></th></tr></thead><tbody id="costMateriaBody"></tbody></table></div></div>
    </div>
    <div id="tab-cost_pack" style="display:none">
        <div class="card"><h2><span>ü•° Costos Packaging</span><button class="btn btn-primary" onclick="openProductModal(null, 'packaging')">+ Nuevo Item</button></h2><table><thead><tr><th>Item</th><th>Costo Compra</th><th>Formato</th><th>Rendimiento</th><th style="background:#f0fdf4; color:#166534">Costo Unit.</th><th></th></tr></thead><tbody id="costPackBody"></tbody></table></div>
    </div>

    <div id="tab-subrecipes" style="display:none">
        <div class="card"><h2><span>üß© Armado de Items (Medallones, Kits)</span><button class="btn btn-purple" onclick="addNewSubRecipe()">+ Nuevo Item Compuesto</button></h2><div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px"><div><table><thead><tr><th>Item Compuesto</th><th style="text-align:right">Costo</th><th></th></tr></thead><tbody id="subRecipesListBody"></tbody></table></div><div id="subRecipeEditor" style="background:#fcfaff; padding:20px; border-radius:10px; border:1px solid #e9d5ff; display:none"><h3 style="margin-top:0; color:var(--purple)">Componentes: <span id="subEditorTitle"></span></h3><table style="background:#fff"><thead><tr><th>Insumo</th><th>Cant.</th><th>Costo</th><th></th></tr></thead><tbody id="subRecipeIngBody"></tbody></table><div style="margin-top:10px; border-top:1px dashed #cbd5e1; padding-top:10px"><div style="display:flex; gap:5px;"><select id="newSubIng" style="flex:2" onchange="updateUnitSelect('sub')"></select><input type="number" id="newSubQty" placeholder="Cant." style="flex:1" step="0.001"><select id="newSubUnit" style="flex:1; background:#f0f9ff; font-weight:700; font-size:12px"></select><button class="btn btn-purple" onclick="addIngToSubRecipe()">+</button></div></div><div style="text-align:right; margin-top:10px">Costo Total: <strong id="subEditorTotalCost" class="text-red">$ 0</strong></div></div></div></div>
    </div>

    <div id="tab-recipes" style="display:none">
        <div class="card">
            <h2><span>üçî Recetas Finales</span><div><button class="btn btn-blue" onclick="openAliasModal()">üîó Armador de Promos/Combos</button> <button class="btn btn-primary" onclick="addNewRecipe()">+ Nueva Receta</button></div></h2>
            <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px">
                <div><table><thead><tr><th>Producto</th><th style="text-align:right">Costo Total</th><th></th></tr></thead><tbody id="recipesListBody"></tbody></table></div>
                <div id="recipeEditor" style="background:#f0fdf4; padding:20px; border-radius:10px; border:1px solid #bbf7d0; display:none">
                    <h3 style="margin-top:0; color:var(--green)">Receta: <span id="editorTitle"></span></h3>
                    <table style="background:#fff"><thead><tr><th>Componente</th><th>Cant.</th><th>Costo</th><th></th></tr></thead><tbody id="recipeIngBody"></tbody></table>
                    <div style="margin-top:10px; display:flex; gap:5px; border-top:1px dashed #cbd5e1; padding-top:10px">
                        <select id="newRecIng" style="flex:2" onchange="updateUnitSelect('rec')"></select>
                        <input type="number" id="newRecQty" placeholder="Cant" style="flex:1" step="0.01">
                        <select id="newRecUnit" style="flex:1; background:#f0fdf4; font-weight:700; font-size:12px"></select>
                        <button class="btn btn-primary" onclick="addIngToRecipe()">Agregar</button>
                    </div>
                    <div style="text-align:right; margin-top:10px">Costo Total: <strong id="editorTotalCost" class="text-red">$ 0</strong></div>
                </div>
            </div>
        </div>
    </div>

    <div id="tab-fixed" style="display:none">
      <div class="card">
        <h2><span>üí° Gastos Fijos</span> <button class="btn btn-primary" onclick="addFixedRow()">+ Agregar</button></h2>
        <table id="tableFixed"><thead><tr><th>Concepto</th><th width="150">Monto Mensual ($)</th><th width="50"></th></tr></thead><tbody></tbody></table>
        <div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div>
      </div>
    </div>

    <div id="tab-production" style="display:none">
      <div class="card">
        <h2><span>üë®‚Äçüç≥ Sueldos</span> <button class="btn btn-primary" onclick="addProdRow()">+ Agregar</button></h2>
        <table id="tableProd"><thead><tr><th>Empleado / Concepto</th><th width="150">Total ($)</th><th width="50"></th></tr></thead><tbody></tbody></table>
        <div style="margin-top:10px; text-align:right"><button class="btn btn-blue" onclick="saveFixedData()">üíæ Guardar Cambios</button></div>
      </div>
    </div>

  </main>
</div>

<div class="modal-overlay" id="modalAlias">
    <div class="modal">
        <h3>üîó Armador de Combos/Promos</h3>
        <div class="alias-builder">
            <div style="margin-bottom:10px"><label style="font-size:11px; font-weight:700; color:var(--primary)">Nombre Exacto en PedidosYa:</label><input type="text" id="aliasExt" placeholder="Ej: Super Promo Mundial 2x1" style="width:100%; border:1px solid #ccc; padding:8px; border-radius:4px;"></div>
            <div style="background:#fff; border:1px solid #eee; padding:10px; border-radius:6px; margin-bottom:10px">
                <label style="font-size:11px; font-weight:700; color:#333">Contenido del Combo:</label>
                <div id="tempAliasItems" style="margin-bottom:10px; min-height:20px;"><div style="font-size:11px; color:#999; font-style:italic">Agrega √≠tems abajo...</div></div>
                <div style="display:flex; gap:5px;"><select id="aliasInt" style="flex:2"></select><input type="number" id="aliasQty" value="1" style="width:60px"><button class="btn btn-primary" onclick="addItemToAlias()">+</button></div>
            </div>
            <div style="text-align:right"><button class="btn btn-primary" onclick="saveAlias()">Guardar Combo</button></div>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin:20px 0">
        <h4 style="font-size:12px; text-transform:uppercase; color:#999">Combos Registrados</h4>
        <table style="width:100%; font-size:12px"><thead><tr><th>Nombre Externo</th><th>Contenido</th><th></th></tr></thead><tbody id="aliasListBody"></tbody></table>
        <div style="margin-top:15px; text-align:right"><button class="btn" onclick="$('#modalAlias').style.display='none'">Cerrar</button></div>
    </div>
</div>

<div class="modal-overlay" id="modalProduct"><div class="modal"><h3 id="mpTitle">Nuevo Insumo</h3><input type="hidden" id="mpId"><div style="margin-bottom:10px"><label style="font-size:11px; color:#666">Nombre</label><input type="text" id="mpName"></div><div style="margin-bottom:10px"><label style="font-size:11px; color:#666">Categor√≠a</label><select id="mpCat"><option value="carniceria">Carne</option><option value="panaderia">Pan</option><option value="almacen">Almac√©n</option><option value="verdularia">Verdura</option><option value="salsas">Salsas</option><option value="packaging">Packaging</option></select></div><div style="background:#f9fafb; padding:10px; border-radius:8px; border:1px solid #eee; margin-bottom:10px"><h4>üì¶ Configuraci√≥n de Costo</h4><div style="display:flex; gap:10px; margin-bottom:10px"><div style="flex:1"><label style="font-size:11px; color:#666">Costo Compra</label><input type="number" id="mpPurchCost" step="0.01"></div><div style="flex:1"><label style="font-size:11px; color:#666">Formato</label><input type="text" id="mpFormat"></div></div><div style="display:flex; gap:10px"><div style="flex:1"><label style="font-size:11px; color:#666">Unidades que trae</label><input type="number" id="mpYield" step="0.001"></div><div style="flex:1"><label style="font-size:11px; color:#666">Unidad de Uso</label><select id="mpUnit"><option value="kg">Kg</option><option value="gr">Gr</option><option value="lt">Lt</option><option value="ml">Ml</option><option value="u">Unidad</option><option value="pq">Paquete</option></select></div></div><div style="margin-top:10px; text-align:right; font-size:12px">Costo Unitario Base: <strong id="calcUnitCost" style="color:var(--green)">$ 0</strong></div></div><div style="display:flex; gap:10px; margin-bottom:15px"><div style="flex:1"><label style="font-size:11px; color:#666">Stock</label><input type="number" id="mpQty" value="0" step="0.001"></div><div style="flex:1"><label style="font-size:11px; color:#666">M√≠nimo</label><input type="number" id="mpMin" value="5" step="0.001"></div></div><div style="display:flex; gap:10px"><button class="btn btn-primary" style="flex:1" onclick="saveProduct()">Guardar</button><button class="btn" style="flex:1" onclick="$('#modalProduct').style.display='none'">Cancelar</button></div></div></div>
<div class="modal-overlay" id="modalPurchase"><div class="modal"><h3>üõí Registrar Compra</h3><div style="margin-bottom:10px"><label>Insumo</label><select id="purProd"></select></div><div style="display:flex; gap:10px; margin-bottom:10px"><div><label>Cantidad</label><input type="number" id="purQty" step="0.001"></div><div><label>Total ($)</label><input type="number" id="purTotal"></div></div><div style="margin-bottom:15px"><label>Fecha</label><input type="date" id="purDate"></div><div style="display:flex; gap:10px"><button class="btn btn-primary" style="flex:1" onclick="confirmPurchase()">Confirmar</button><button class="btn" style="flex:1" onclick="$('#modalPurchase').style.display='none'">Cancelar</button></div></div></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
    // 1. CONFIGURACI√ìN E INICIALIZACI√ìN
    const firebaseConfig = {apiKey:"AIzaSyBbt5YOWDE0ouLn-Ib_iD1yUesok5SEhB8",authDomain:"rhodes-burguers.firebaseapp.com",projectId:"rhodes-burguers",storageBucket:"rhodes-burguers.firebasestorage.app",messagingSenderId:"951646688091",appId:"1:951646688091:web:05db5fadb4150d1fa9c07e"};
    try { firebase.initializeApp(firebaseConfig); } catch(e) {}
    const db = firebase.firestore();
    const $ = s => document.querySelector(s);
    const money = n => (Number(n)||0).toLocaleString("es-AR", {style:"currency", currency:"ARS", maximumFractionDigits:2});
    const formatQty = (n) => { let num = Number(n); if(isNaN(num)) return '0'; return parseFloat(num.toFixed(3)); };
    const parseDate = (val) => { if(!val) return null; return (val.toDate ? val.toDate() : new Date(val)); };

    // 2. VARIABLES GLOBALES
    let INVENTORY=[], SUB_RECIPES=[], RECIPES=[], PURCHASES=[], ORDERS=[];
    let FIXED_DATA = { fixed:[], prod:[], config:{pyPercent:30, taxDebit:0, taxTransf:0, taxQR:0}, aliases:[] };
    let currentRecipeId = null, currentSubRecipeId = null, chartInstance = null, tempAliasList = [];

    // 3. FUNCIONES L√ìGICAS (DEFINIDAS EN WINDOW PARA EVITAR ERRORES)
    window.calculateOrderBagCost = function(items) {
        const bagItem = INVENTORY.find(i => { const n=i.name.toLowerCase(); return n.includes('bolsa')||n.includes('kit')||n.includes('empaque')||n.includes('packaging'); });
        if (!bagItem) return 0;
        let burgerCount = 0;
        items.forEach(i => { const name = i.name.toLowerCase(); if(name.includes('hamb')||name.includes('doble')||name.includes('simple')||name.includes('cuarto')||name.includes('royal')||name.includes('cheese')||name.includes('burger')) { burgerCount += Number(i.qty || 1); } });
        return Math.ceil(burgerCount / 2) * bagItem.cost;
    };

    window.getUnitCost = function(name) {
        if(!name) return 0;
        const cleanName = name.toLowerCase().trim();
        const alias = (FIXED_DATA.aliases||[]).find(a => a.external.toLowerCase().trim() === cleanName);
        if(alias) {
            if(alias.items) { return alias.items.reduce((sum, item) => { const r = RECIPES.find(x => x.id === item.id); return sum + (r ? (window.calculateRecipeTotal(r) * item.qty) : 0); }, 0); } 
            else if (alias.internal) { const r = RECIPES.find(x => x.id === alias.internal); return r ? window.calculateRecipeTotal(r) : 0; }
        }
        let r = RECIPES.find(x => x.id.toLowerCase() === cleanName);
        if(!r) r = RECIPES.find(x => cleanName.includes(x.id.toLowerCase())); 
        if(r) return window.calculateRecipeTotal(r);
        return 0;
    };

    window.calculateRecipeTotal = function(recipe) {
        return (recipe.ingredients || []).reduce((sum, ing) => {
            const sub = SUB_RECIPES.find(s => s.id === ing.id);
            if(sub) return sum + (ing.qty * window.calculateSubRecipeCost(sub));
            const item = INVENTORY.find(i => i.id === ing.id);
            if(item) return sum + (ing.qty * item.cost);
            return sum;
        }, 0);
    };

    window.calculateSubRecipeCost = function(sub) {
        return (sub.ingredients || []).reduce((sum, ing) => {
            const item = INVENTORY.find(i => i.id === ing.id);
            return sum + (ing.qty * (item ? item.cost : 0));
        }, 0);
    };

    // --- RENDERIZADO Y CALCULOS PRINCIPALES ---
    window.calculateAll = function() {
        if(typeof Chart === 'undefined') return; // Seguridad si Chart.js no cargo

        let gross=0, comms=0, taxes=0, theoCMV=0;
        const { pyPercent:pctPy, taxDebit:pctDebit, taxTransf:pctTransf, taxQR:pctQR } = FIXED_DATA.config;

        ORDERS.forEach(o => {
            const sale = Number(o.total || 0); gross += sale;
            const src = (o.source||'').toLowerCase(), pay = (o.pago||o.paymentMethod||'').toLowerCase();
            if(src==='pedidosya') comms += (sale*(pctPy/100));
            else if(pay.includes('mercado')||pay.includes('mp')||pay.includes('qr')) taxes += (sale*(pctQR/100));
            else if(pay.includes('transfer')) taxes += (sale*(pctTransf/100));
            else if(pay.includes('debito')||pay.includes('tarjeta')) taxes += (sale*(pctDebit/100));

            (o.items||[]).forEach(item => { theoCMV += (window.getUnitCost(item.name) * Number(item.qty||1)); });
            theoCMV += window.calculateOrderBagCost(o.items||[]);
        });

        const totalFixed = (FIXED_DATA.fixed||[]).reduce((s,i)=>s+Number(i.cost),0); 
        const totalSalaries = (FIXED_DATA.prod||[]).reduce((s,i)=>s+Number(i.cost),0);
        const variableCosts = comms + taxes;
        const realPurchases = PURCHASES.reduce((s,p)=>s+Number(p.total),0);
        const totalExp = realPurchases + totalFixed + totalSalaries + variableCosts;
        const profitReal = gross - totalExp;

        $('#kpiSales').innerText = money(gross); $('#kpiTheoCMV').innerText = '-' + money(theoCMV);
        $('#kpiTotalExpenses').innerText = '-' + money(totalExp);
        const kn = $('#kpiNet'); kn.innerText = money(profitReal);
        if(profitReal>=0) { kn.className='kpi-val text-green'; $('#kpiNetContainer').style.backgroundColor='#f0fdf4'; }
        else { kn.className='kpi-val text-red'; $('#kpiNetContainer').style.backgroundColor='#fef2f2'; }

        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart($('#mainChart').getContext('2d'), {
            type:'bar', data:{ labels:['+ Ventas','- Mercader√≠a','- Fijos','- Sueldos','- Var (Py/Imp)','= Balance'], datasets:[{data:[gross,realPurchases,totalFixed,totalSalaries,variableCosts,profitReal], backgroundColor:['#64748b','#f97316','#a855f7','#3b82f6','#eab308',profitReal>=0?'#10b981':'#ef4444'], borderRadius:6}] },
            options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}} }
        });
        $('#lastPurchasesList').innerHTML = PURCHASES.slice(0,5).map(p=>`<div style="display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:5px 0"><span>${p.prodName||'Compra'}</span><b class="text-red">-${money(p.total)}</b></div>`).join('');
    };

    window.renderOrdersTab = function() {
        const tbody = $('#ordersTableBody'); tbody.innerHTML = '';
        const { pyPercent:pctPy, taxDebit:pctDebit, taxTransf:pctTransf, taxQR:pctQR } = FIXED_DATA.config;

        ORDERS.forEach((o, index) => {
            const total = Number(o.total || 0);
            let originText=(o.source||'web').toUpperCase(), originBadge=originText.includes('PEDIDOSYA')?'bdg-py':'bdg-web';
            let rawPay=(o.pago||o.paymentMethod||'efectivo').toLowerCase(), payText='EFECTIVO', payBadge='bdg-cash', deduction=0;

            if(originText.includes('PEDIDOS YA')) deduction=total*(pctPy/100);
            else if(rawPay.includes('mercado')||rawPay.includes('mp')||rawPay.includes('qr')) { deduction=total*(pctQR/100); payText='MERCADOPAGO'; payBadge='bdg-digital'; }
            else if(rawPay.includes('transfer')) { deduction=total*(pctTransf/100); payText='TRANSF.'; payBadge='bdg-digital'; }
            else if(rawPay.includes('debito')||rawPay.includes('tarjeta')) { deduction=total*(pctDebit/100); payText='TARJETA'; payBadge='bdg-digital'; }

            let orderCost = window.calculateOrderBagCost(o.items||[]);
            let itemsHtml = (o.items||[]).map(item => {
                orderCost += (window.getUnitCost(item.name) * Number(item.qty||1));
                return `<div style="margin-bottom:6px"><div><strong>${item.qty}x</strong> ${item.name}</div></div>`;
            }).join('');

            let profit = total - deduction - orderCost;
            let dStr = '-';
            if(o.createdAt) {
                const dt = parseDate(o.createdAt);
                dStr = dt.toLocaleString('es-AR', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
            }
            
            tbody.innerHTML += `<tr class="order-row" onclick="document.getElementById('detail-${index}').classList.toggle('open')">
                <td>${dStr}</td><td>${o.nombre||'Cliente'}</td><td><span class="badge ${originBadge}">${originText}</span></td>
                <td><span class="badge ${payBadge}">${payText}</span></td><td style="font-weight:700">${money(total)}</td>
                <td style="font-weight:700; color:${profit>=0?'var(--green)':'var(--red)'}">${money(profit)}</td><td>‚ñº</td></tr>
                <tr class="order-details" id="detail-${index}"><td colspan="7" style="padding:0"><div class="detail-grid">
                <div><strong style="color:#666;font-size:11px">Detalle:</strong><div style="margin-top:5px;font-size:13px">${itemsHtml}</div></div>
                <div style="background:#fff;border:1px solid #eee;padding:10px;border-radius:8px">
                    <div style="display:flex;justify-content:space-between;font-size:13px;color:#ef4444"><span>- Imp/Comis:</span><b>${money(deduction)}</b></div>
                    <div style="display:flex;justify-content:space-between;font-size:13px;color:#ef4444"><span>- Costo (CMV):</span><b>${money(orderCost)}</b></div>
                    <div style="display:flex;justify-content:space-between;margin-top:10px;border-top:1px dashed #ccc;font-size:14px"><span style="font-weight:700">Ganancia:</span><b style="color:${profit>=0?'var(--green)':'var(--red)'}">${money(profit)}</b></div>
                </div></div></td></tr>`;
        });
    };

    // --- INTERACCION Y BOTONES (GLOBALES) ---
    window.openProductModal = function(id, catPreset) {
        $('#modalProduct').style.display = 'flex';
        if(id && typeof id === 'string') { 
            const p = INVENTORY.find(i => i.id === id);
            if(p) {
                $('#mpTitle').innerText = 'Editar Insumo'; $('#mpId').value = id; $('#mpName').value = p.name; $('#mpCat').value = p.category; $('#mpQty').value = p.qty; $('#mpUnit').value = p.unit; 
                $('#mpPurchCost').value = p.purchCost || p.cost; $('#mpFormat').value = p.format || ''; $('#mpYield').value = p.yield || 1; $('#mpMin').value = p.min || 5; $('#calcUnitCost').innerText = money(p.cost);
            }
        } else { 
            $('#mpTitle').innerText = 'Nuevo Insumo'; $('#mpId').value = ''; $('#mpName').value = ''; $('#mpQty').value = 0; 
            $('#mpPurchCost').value = 0; $('#mpFormat').value = ''; $('#mpYield').value = 1; $('#mpMin').value = 5;
            if(catPreset && typeof catPreset === 'string') $('#mpCat').value = catPreset;
        }
    };

    window.saveProduct = async function() {
        const id = $('#mpId').value;
        const purchCost = Number($('#mpPurchCost').value);
        const yieldVal = Number($('#mpYield').value);
        const unitCost = (yieldVal > 0) ? (purchCost / yieldVal) : 0;
        const data = { name: $('#mpName').value, category: $('#mpCat').value, qty: Number($('#mpQty').value), unit: $('#mpUnit').value, purchCost: purchCost, format: $('#mpFormat').value, yield: yieldVal, min: Number($('#mpMin').value), cost: unitCost };
        if(!data.name) return alert("Falta nombre");
        id ? await db.collection('inventory').doc(id).update(data) : await db.collection('inventory').add(data);
        $('#modalProduct').style.display = 'none';
    };

    window.openPurchaseModal = function() { $('#modalPurchase').style.display = 'flex'; const sel = $('#purProd'); sel.innerHTML = ''; INVENTORY.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name} (Stock: ${formatQty(p.qty)})</option>`); $('#purQty').value = ''; $('#purTotal').value = ''; };
    window.confirmPurchase = async function() { const prodId = $('#purProd').value, qty = Number($('#purQty').value), total = Number($('#purTotal').value), date = $('#purDate').value; if(!prodId || qty <= 0) return; await db.collection('purchases').add({ prodId, qty, total, date, prodName: INVENTORY.find(i=>i.id===prodId)?.name }); const prod = INVENTORY.find(i => i.id === prodId); if(prod) await db.collection('inventory').doc(prodId).update({ qty: Number(prod.qty) + qty }); alert("Compra registrada!"); $('#modalPurchase').style.display = 'none'; window.loadDashboardData(); };

    window.addNewSubRecipe = async function() { const name = prompt("Nombre:"); if(name) await db.collection('subrecipes').add({ name, ingredients: [] }); };
    window.openSubRecipeEditor = function(id) { 
        currentSubRecipeId = id; $('#subRecipeEditor').style.display = 'block'; const s=SUB_RECIPES.find(x=>x.id===id); $('#subEditorTitle').innerText=s.name; const sel=$('#newSubIng'); sel.innerHTML=''; INVENTORY.forEach(i => sel.innerHTML += `<option value="${i.id}">${i.name}</option>`); $('#subRecipeIngBody').innerHTML=(s.ingredients||[]).map((ing,i)=>{ const it=INVENTORY.find(x=>x.id===ing.id); return `<tr><td>${it?it.name:'?'}</td><td>${ing.qty}</td><td>${money((it?it.cost:0)*ing.qty)}</td><td><button class="btn-icon" onclick="removeSubIng('${id}',${i})">üóëÔ∏è</button></td></tr>`; }).join(''); $('#subEditorTotalCost').innerText = money(window.calculateSubRecipeCost(s)); 
    };
    window.addIngToSubRecipe = async function() { const id=$('#newSubIng').value, q=Number($('#newSubQty').value), m=Number($('#newSubUnit').value); if(!id)return; const s=SUB_RECIPES.find(x=>x.id===currentSubRecipeId); await db.collection('subrecipes').doc(currentSubRecipeId).update({ingredients:[...(s.ingredients||[]),{id,qty:q*m}]}); };
    window.removeSubIng = async function(sId, i) { const s=SUB_RECIPES.find(x=>x.id===sId), n=[...s.ingredients]; n.splice(i,1); await db.collection('subrecipes').doc(sId).update({ingredients:n}); };
    window.addNewRecipe = async function() { const name = prompt("Nombre:"); if(name) await db.collection('recipes').doc(name).set({ingredients: []}); };
    
    window.openRecipeEditor = function(el) { 
        if(el.tagName==='TR') currentRecipeId = el.getAttribute('data-id'); else currentRecipeId=el.id; 
        const r = RECIPES.find(x=>x.id===currentRecipeId); if(!r) return;
        $('#recipeEditor').style.display='block'; $('#editorTitle').innerText=r.id;
        const sel=$('#newRecIng'); sel.innerHTML='<option value="">Agregar...</option>';
        sel.innerHTML+=`<optgroup label="Items">${SUB_RECIPES.map(s=>`<option value="${s.id}">üß© ${s.name}</option>`).join('')}</optgroup>`;
        sel.innerHTML+=`<optgroup label="Insumos">${INVENTORY.map(i=>`<option value="${i.id}">${i.name}</option>`).join('')}</optgroup>`;
        $('#recipeIngBody').innerHTML=(r.ingredients||[]).map((ing,i)=>{ const s=SUB_RECIPES.find(x=>x.id===ing.id), it=INVENTORY.find(x=>x.id===ing.id); return `<tr><td>${s?'üß© '+s.name:(it?it.name:'???')}</td><td>${formatQty(ing.qty)}</td><td>${money((s?window.calculateSubRecipeCost(s):it?it.cost:0)*ing.qty)}</td><td><button class="btn-icon" onclick="removeRecIng('${r.id}',${i})">üóëÔ∏è</button></td></tr>`; }).join('');
        $('#editorTotalCost').innerText=money(window.calculateRecipeTotal(r));
    };

    window.addIngToRecipe = async function() { const id=$('#newRecIng').value, q=Number($('#newRecQty').value), m=Number($('#newRecUnit').value); if(!id)return; const r=RECIPES.find(x=>x.id===currentRecipeId); await db.collection('recipes').doc(currentRecipeId).update({ingredients:[...(r.ingredients||[]),{id,qty:q*m}]}); };
    window.removeRecIng = async function(rId, i) { const r=RECIPES.find(x=>x.id===rId), n=[...r.ingredients]; n.splice(i,1); await db.collection('recipes').doc(rId).update({ingredients:n}); };
    window.deleteItem = async function(c,id) { if(confirm('¬øBorrar?')){ await db.collection(c).doc(id).delete(); if(c==='recipes') $('#recipeEditor').style.display='none'; if(c==='subrecipes') $('#subRecipeEditor').style.display='none'; } };

    // ALIAS SYSTEM
    window.openAliasModal = function() { $('#modalAlias').style.display='flex'; window.renderAliasList(); const sel=$('#aliasInt'); sel.innerHTML=''; RECIPES.forEach(r => sel.innerHTML += `<option value="${r.id}">${r.id}</option>`); tempAliasList=[]; window.renderTempAlias(); };
    window.addItemToAlias = function() { const id=$('#aliasInt').value, qty=Number($('#aliasQty').value); if(id){ tempAliasList.push({id,qty}); window.renderTempAlias(); } };
    window.renderTempAlias = function() { $('#tempAliasItems').innerHTML = tempAliasList.map((x,i)=>`<div><b>${x.qty}x</b> ${x.id} <span style="color:red;cursor:pointer" onclick="tempAliasList.splice(${i},1);window.renderTempAlias()">[x]</span></div>`).join(''); };
    window.saveAlias = function() { const ext=$('#aliasExt').value; if(ext && tempAliasList.length){ if(!FIXED_DATA.aliases) FIXED_DATA.aliases=[]; const idx=FIXED_DATA.aliases.findIndex(a=>a.external===ext); if(idx>=0) FIXED_DATA.aliases.splice(idx,1); FIXED_DATA.aliases.push({external:ext, items:tempAliasList}); window.saveFixedData(); $('#modalAlias').style.display='none'; } };
    window.renderAliasList = function() { $('#aliasListBody').innerHTML=(FIXED_DATA.aliases||[]).map((a,i)=>`<tr><td>${a.external}</td><td>${a.items?a.items.length+' items':'Legacy'}</td><td><button class="btn-icon" onclick="deleteAlias(${i})">üóëÔ∏è</button></td></tr>`).join(''); };
    window.deleteAlias = function(i) { FIXED_DATA.aliases.splice(i,1); window.saveFixedData(); };

    // COSTOS FIJOS Y SUELDOS
    window.addFixedRow = function() { FIXED_DATA.fixed.push({name:'',cost:0}); window.renderFixedTables(); };
    window.addProdRow = function() { FIXED_DATA.prod.push({name:'',cost:0}); window.renderFixedTables(); };
    window.updFix = function(arr, i, k, v) { FIXED_DATA[arr][i][k] = k==='cost'?Number(v):v; };
    window.delFix = function(arr, i) { FIXED_DATA[arr].splice(i,1); window.renderFixedTables(); };
    window.renderFixedTables = function() { 
        $('#tableFixed').querySelector('tbody').innerHTML = FIXED_DATA.fixed.map((r,i)=>`<tr><td><input value="${r.name}" onchange="updFix('fixed',${i},'name',this.value)"></td><td><input type="number" value="${r.cost}" onchange="updFix('fixed',${i},'cost',this.value)"></td><td><button class="btn-icon" onclick="delFix('fixed',${i})">üóëÔ∏è</button></td></tr>`).join('');
        $('#tableProd').querySelector('tbody').innerHTML = FIXED_DATA.prod.map((r,i)=>`<tr><td><input value="${r.name}" onchange="updFix('prod',${i},'name',this.value)"></td><td><input type="number" value="${r.cost}" onchange="updFix('prod',${i},'cost',this.value)"></td><td><button class="btn-icon" onclick="delFix('prod',${i})">üóëÔ∏è</button></td></tr>`).join('');
    };

    window.saveFixedData = function() { 
        if(!FIXED_DATA.aliases) FIXED_DATA.aliases=[]; 
        FIXED_DATA.config={pyPercent:Number($('#confPy').value), taxDebit:Number($('#confDebit').value), taxTransf:Number($('#confTransf').value), taxQR:Number($('#confQR').value)}; 
        db.collection('config').doc('gerencia').set(FIXED_DATA).then(()=>alert("Guardado")); 
        window.calculateAll(); window.renderOrdersTab(); 
    };
    window.saveConfig = window.saveFixedData;

    // RENDERIZADO TABLAS (CORREGIDO EVENTO ONCLICK)
    window.renderStockTable = function() { $('#stockTableBody').innerHTML = INVENTORY.map(p=>`<tr><td><b>${p.name}</b></td><td><small>${p.category}</small></td><td>${formatQty(p.qty)} ${p.unit}</td><td>${p.min}</td><td>${p.qty<=p.min?'üî¥':'üü¢'}</td><td><button class="btn-icon" onclick="openProductModal('${p.id}')">‚úé</button> <button class="btn-icon" onclick="deleteItem('inventory','${p.id}')">üóëÔ∏è</button></td></tr>`).join(''); };
    window.renderCostTables = function() { 
        const rr=(a,t)=>{ $(t).innerHTML=a.map(p=>`<tr><td><b>${p.name}</b></td><td>$${p.purchCost||p.cost}</td><td><small>${p.format||'u'}</small></td><td>${p.yield||1} ${p.unit}</td><td style="font-weight:700;color:#166534">${money(p.cost)}</td><td><button class="btn-icon" onclick="openProductModal('${p.id}')">‚úé</button> <button class="btn-icon" onclick="deleteItem('inventory','${p.id}')">üóëÔ∏è</button></td></tr>`).join(''); }; 
        rr(INVENTORY.filter(p=>p.category!=='packaging'),'#costMateriaBody'); rr(INVENTORY.filter(p=>p.category==='packaging'),'#costPackBody'); 
    };
    window.renderRecipesList = function() { $('#recipesListBody').innerHTML=RECIPES.map(r=>`<tr onclick="openRecipeEditor(this)" data-id="${r.id}"><td>${r.id}</td><td style="text-align:right"><b>${money(window.calculateRecipeTotal(r))}</b></td><td style="text-align:right"><button class="btn-icon" onclick="deleteItem('recipes','${r.id}')">üóëÔ∏è</button></td></tr>`).join(''); };
    window.renderSubRecipesList = function() { $('#subRecipesListBody').innerHTML = SUB_RECIPES.map(sub => `<tr onclick="openSubRecipeEditor('${sub.id}')"><td>${sub.name}</td><td style="text-align:right"><b>${money(window.calculateSubRecipeCost(sub))}</b></td><td style="text-align:right"><button class="btn-icon" onclick="deleteItem('subrecipes', '${sub.id}')">üóëÔ∏è</button></td></tr>`).join(''); };
    window.showTab = function(id) { document.querySelectorAll('div[id^="tab-"]').forEach(d=>d.style.display='none'); $('#tab-'+id).style.display='block'; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); };

    // --- CARGA DE DATOS ---
    window.loadDashboardData = function() {
        const ym=$('#monthPicker').value; if(!ym)return; 
        $('#ordersTitle').innerText = 'üßæ Pedidos de ' + ym;
        const [y,m]=ym.split('-').map(Number);
        
        // RANGO MENSUAL EXACTO
        const start = new Date(y, m-1, 1);
        const end = new Date(y, m, 0, 23, 59, 59);

        db.collection('orders').where('createdAt','>=',start.toISOString()).where('createdAt','<=',end.toISOString()).orderBy('createdAt','desc').get().then(snap=>{ ORDERS=snap.docs.map(d=>d.data()).filter(o=>o.status!=='cancelled'); window.calculateAll(); window.renderOrdersTab(); });
        db.collection('purchases').where('date','>=',start.toISOString()).where('date','<=',end.toISOString()).get().then(snap=>{ PURCHASES=snap.docs.map(d=>d.data()); window.calculateAll(); });
    };

</script>
</body>
</html>
